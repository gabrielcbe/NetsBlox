"use strict";var utils={requestPromise:function(i,t){return new Promise(function(e,o){t&&i.setRequestHeader("Content-Type","application/json; charset=utf-8"),i.send(JSON.stringify(t)),i.onreadystatechange=function(){if(4===i.readyState)if(200<=i.status&&i.status<300)e(i);else{var t=new Error(i.statusText||"Unsuccessful Xhr response");t.request=i,o(t)}}})},memoize:function(o){var i={};return function(){var t=JSON.stringify(arguments);if(i[t])return i[t];var e=o.apply(null,arguments);return i[t]=e}},getUrlSync:function(t){t=ensureFullUrl(t);var e=new XMLHttpRequest;if(e.open("GET",t,!1),e.send(),200===e.status)return e.responseText;throw new Error("unable to retrieve "+t)}};if(utils.getUrlSyncCached=utils.memoize(utils.getUrlSync),void 0===Map){var Map=function(){this._content={},this.size=0};Map.prototype.set=function(t,e){this._content.hasOwnProperty(t)||this.size++,this._content[t]=e},Map.prototype.get=function(t){return this._content[t]},Map.prototype.delete=function(t){this._content.hasOwnProperty(t)&&this.size--,delete this._content[t]}}Date.now||(Date.now=function(){return(new Date).getTime()}),function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e():"function"==typeof define&&define.amd?define(e):e()}(0,function(){function i(){}function n(t){if(!(this instanceof n))throw new TypeError("Promises must be constructed via new");if("function"!=typeof t)throw new TypeError("not a function");this._state=0,this._handled=!1,this._value=void 0,this._deferreds=[],l(t,this)}function r(o,i){for(;3===o._state;)o=o._value;0!==o._state?(o._handled=!0,n._immediateFn(function(){var t=1===o._state?i.onFulfilled:i.onRejected;if(null!==t){var e;try{e=t(o._value)}catch(t){return void a(i.promise,t)}s(i.promise,e)}else(1===o._state?s:a)(i.promise,o._value)})):o._deferreds.push(i)}function s(e,t){try{if(t===e)throw new TypeError("A promise cannot be resolved with itself.");if(t&&("object"==typeof t||"function"==typeof t)){var o=t.then;if(t instanceof n)return e._state=3,e._value=t,void h(e);if("function"==typeof o)return void l((i=o,r=t,function(){i.apply(r,arguments)}),e)}e._state=1,e._value=t,h(e)}catch(t){a(e,t)}var i,r}function a(t,e){t._state=2,t._value=e,h(t)}function h(t){2===t._state&&0===t._deferreds.length&&n._immediateFn(function(){t._handled||n._unhandledRejectionFn(t._value)});for(var e=0,o=t._deferreds.length;e<o;e++)r(t,t._deferreds[e]);t._deferreds=null}function l(t,e){var o=!1;try{t(function(t){o||(o=!0,s(e,t))},function(t){o||(o=!0,a(e,t))})}catch(t){if(o)return;o=!0,a(e,t)}}var t=function(e){var o=this.constructor;return this.then(function(t){return o.resolve(e()).then(function(){return t})},function(t){return o.resolve(e()).then(function(){return o.reject(t)})})},e=setTimeout;n.prototype.catch=function(t){return this.then(null,t)},n.prototype.then=function(t,e){var o=new this.constructor(i);return r(this,new function(t,e,o){this.onFulfilled="function"==typeof t?t:null,this.onRejected="function"==typeof e?e:null,this.promise=o}(t,e,o)),o},n.prototype.finally=t,n.all=function(e){return new n(function(i,r){function n(e,t){try{if(t&&("object"==typeof t||"function"==typeof t)){var o=t.then;if("function"==typeof o)return void o.call(t,function(t){n(e,t)},r)}s[e]=t,0==--a&&i(s)}catch(t){r(t)}}if(!e||void 0===e.length)throw new TypeError("Promise.all accepts an array");var s=Array.prototype.slice.call(e);if(0===s.length)return i([]);for(var a=s.length,t=0;s.length>t;t++)n(t,s[t])})},n.resolve=function(e){return e&&"object"==typeof e&&e.constructor===n?e:new n(function(t){t(e)})},n.reject=function(o){return new n(function(t,e){e(o)})},n.race=function(r){return new n(function(t,e){for(var o=0,i=r.length;o<i;o++)r[o].then(t,e)})},n._immediateFn="function"==typeof setImmediate&&function(t){setImmediate(t)}||function(t){e(t,0)},n._unhandledRejectionFn=function(t){void 0!==console&&console&&console.warn("Possible Unhandled Promise Rejection:",t)};var o=function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw Error("unable to locate global object")}();o.Promise?o.Promise.prototype.finally||(o.Promise.prototype.finally=t):o.Promise=n});var morphicVersion="2017-April-23",modules={},useBlurredShadows=getBlurredShadowSupport(),standardSettings={minimumFontHeight:getMinimumFontHeight(),globalFontFamily:"",menuFontName:"sans-serif",menuFontSize:12,bubbleHelpFontSize:10,prompterFontName:"sans-serif",prompterFontSize:12,prompterSliderSize:10,handleSize:15,scrollBarSize:12,mouseScrollAmount:40,useSliderForInput:!1,useVirtualKeyboard:!0,isTouchDevice:!1,rasterizeSVGs:!1,isFlat:!1,grabThreshold:5},touchScreenSettings={minimumFontHeight:standardSettings.minimumFontHeight,globalFontFamily:"",menuFontName:"sans-serif",menuFontSize:24,bubbleHelpFontSize:18,prompterFontName:"sans-serif",prompterFontSize:24,prompterSliderSize:20,handleSize:26,scrollBarSize:24,mouseScrollAmount:40,useSliderForInput:!0,useVirtualKeyboard:!0,isTouchDevice:!1,rasterizeSVGs:!1,isFlat:!1,grabThreshold:5},MorphicPreferences=standardSettings,Morph,WorldMorph,HandMorph,ShadowMorph,FrameMorph,MenuMorph,HandleMorph,StringFieldMorph,ColorPickerMorph,SliderMorph,ScrollFrameMorph,InspectorMorph,StringMorph,TextMorph,PenMorph,ColorPaletteMorph,GrayPaletteMorph,BlinkerMorph,CursorMorph,BoxMorph,SpeechBubbleMorph,CircleBoxMorph,SliderButtonMorph,MouseSensorMorph,ListMorph,TriggerMorph,MenuItemMorph,MenuItemMorph,BouncerMorph,Localizer;function nop(){return null}function localize(t){return t}function isNil(t){return null==t}function contains(t,e){return t.some(function(t){return t===e})}function detect(t,e){var o,i=t.length;for(o=0;o<i;o+=1)if(e.call(null,t[o]))return t[o];return null}function sizeOf(t){var e,o=0;for(e in t)Object.prototype.hasOwnProperty.call(t,e)&&(o+=1);return o}function isString(t){return"string"==typeof t||t instanceof String}function isObject(t){return null!==t&&("object"==typeof t||t instanceof Object)}function radians(t){return t*Math.PI/180}function degrees(t){return 180*t/Math.PI}function fontHeight(t){return 1.2*Math.max(t,MorphicPreferences.minimumFontHeight)}function isWordChar(t){return t.match(/[A-zÀ-ÿ0-9]/)}function isURLChar(t){return t.match(/[A-z0-9./:?&_+%-]/)}function isURL(t){return/^https?:\/\//.test(t)}function newCanvas(t,e){var o,i;return i=t||{x:0,y:0},(o=document.createElement("canvas")).width=i.x,o.height=i.y,e&&o.isRetinaEnabled&&(o.isRetinaEnabled=!1),o}function getMinimumFontHeight(){var t,e,o,i,r=document.createElement("canvas");for(r.width=50,r.height=50,(t=r.getContext("2d")).font="1px serif",e=t.measureText("I").width,t.fillStyle="black",t.textBaseline="bottom",t.fillText("I",0,50),i=0;i<50;i+=1)for(o=0;o<e;o+=1)if(0!==t.getImageData(o,i,1,1).data[3])return 50-i+1;return 0}function getBlurredShadowSupport(){var t,e,o;return(t=document.createElement("canvas")).width=10,t.height=10,(o=t.getContext("2d")).fillStyle="rgb(255, 0, 0)",o.beginPath(),o.arc(5,5,5,0,2*Math.PI,!0),o.closePath(),o.fill(),(e=document.createElement("canvas")).width=10,e.height=10,(o=e.getContext("2d")).shadowBlur=10,o.shadowColor="rgba(0, 0, 255, 1)",o.drawImage(t,0,0),!!o.getImageData(0,0,1,1).data[3]}function getDocumentPositionOf(t){var e,o;if(null===t)return{x:0,y:0};for(e={x:t.offsetLeft,y:t.offsetTop},o=t.offsetParent;null!==o;)e.x+=o.offsetLeft,e.y+=o.offsetTop,o!==document.body&&o!==document.documentElement&&(e.x-=o.scrollLeft,e.y-=o.scrollTop),o=o.offsetParent;return e}function copy(t){var e,o,i,r,n,s;if("object"!=typeof t)return t;if(e=t.valueOf(),t!==e)return new t.constructor(e);if(t instanceof t.constructor&&t.constructor!==Object)for(o=Object.create(t.constructor.prototype),n=(r=Object.keys(t)).length,s=0;s<n;s+=1)o[i=r[s]]=t[i];else for(i in o={},t)o[i]=t[i];return o}function enableRetinaSupport(){var t=document.createElement("canvas").getContext("2d"),e=t.webkitBackingStorePixelRatio||t.mozBackingStorePixelRatio||t.msBackingStorePixelRatio||t.oBackingStorePixelRatio||t.backingStorePixelRatio||1,o=Math.ceil(window.devicePixelRatio),i=HTMLCanvasElement.prototype,r=CanvasRenderingContext2D.prototype,p={drawImage:r.drawImage,getImageData:r.getImageData,width:Object.getOwnPropertyDescriptor(i,"width"),height:Object.getOwnPropertyDescriptor(i,"height"),shadowOffsetX:Object.getOwnPropertyDescriptor(r,"shadowOffsetX"),shadowOffsetY:Object.getOwnPropertyDescriptor(r,"shadowOffsetY"),shadowBlur:Object.getOwnPropertyDescriptor(r,"shadowBlur")};function c(t){return t.isRetinaEnabled?(o||1)/e:1}e!==o&&(Object.keys(p).some(function(t){var e=p[t];return e.hasOwnProperty("configurable")&&!e.configurable})||(i._isRetinaEnabled=!0,i._bak=p,Object.defineProperty(i,"isRetinaEnabled",{get:function(){return this._isRetinaEnabled},set:function(t){var e=c(this),o=this.width,i=this.height;this._isRetinaEnabled=t,c(this)!=e&&(this.width=o,this.height=i)},configurable:!0}),Object.defineProperty(i,"width",{get:function(){return p.width.get.call(this)/c(this)},set:function(e){try{var t,o=c(this);p.width.set.call(this,e*o),(t=this.getContext("2d")).restore(),t.save(),t.scale(o,o)}catch(t){console.log("Retina Display Support Problem",t),p.width.set.call(this,e)}}}),Object.defineProperty(i,"height",{get:function(){return p.height.get.call(this)/c(this)},set:function(t){var e,o=c(this);p.height.set.call(this,t*o),(e=this.getContext("2d")).restore(),e.save(),e.scale(o,o)}}),r.drawImage=function(t){var e,o,i,r,n,s,a,h,l=c(t);switch(arguments.length){case 9:e=arguments[1],o=arguments[2],i=arguments[3],r=arguments[4],n=arguments[5],s=arguments[6],a=arguments[7],h=arguments[8];break;case 5:o=e=0,i=t.width,r=t.height,n=arguments[1],s=arguments[2],a=arguments[3],h=arguments[4];break;case 3:o=e=0,i=t.width,r=t.height,n=arguments[1],s=arguments[2],a=t.width,h=t.height;break;default:throw Error("Called drawImage() with "+arguments.length+" arguments")}p.drawImage.call(this,t,e*l,o*l,i*l,r*l,n,s,a,h)},r.getImageData=function(t,e,o,i){var r=c(this.canvas);return p.getImageData.call(this,t*r,e*r,o*r,i*r)},Object.defineProperty(r,"shadowOffsetX",{get:function(){return p.shadowOffsetX.get.call(this)/c(this.canvas)},set:function(t){var e=c(this.canvas);p.shadowOffsetX.set.call(this,t*e)}}),Object.defineProperty(r,"shadowOffsetY",{get:function(){return p.shadowOffsetY.get.call(this)/c(this.canvas)},set:function(t){var e=c(this.canvas);p.shadowOffsetY.set.call(this,t*e)}}),Object.defineProperty(r,"shadowBlur",{get:function(){return p.shadowBlur.get.call(this)/c(this.canvas)},set:function(t){var e=c(this.canvas);p.shadowBlur.set.call(this,t*e)}})))}function isRetinaSupported(){var t=document.createElement("canvas").getContext("2d"),e=t.webkitBackingStorePixelRatio||t.mozBackingStorePixelRatio||t.msBackingStorePixelRatio||t.oBackingStorePixelRatio||t.backingStorePixelRatio||1,o=HTMLCanvasElement.prototype,i=CanvasRenderingContext2D.prototype,r={drawImage:i.drawImage,getImageData:i.getImageData,width:Object.getOwnPropertyDescriptor(o,"width"),height:Object.getOwnPropertyDescriptor(o,"height"),shadowOffsetX:Object.getOwnPropertyDescriptor(i,"shadowOffsetX"),shadowOffsetY:Object.getOwnPropertyDescriptor(i,"shadowOffsetY"),shadowBlur:Object.getOwnPropertyDescriptor(i,"shadowBlur")};return e!==window.devicePixelRatio&&!Object.keys(r).some(function(t){var e=r[t];return e.hasOwnProperty("configurable")&&!e.configurable})}function isRetinaEnabled(){return HTMLCanvasElement.prototype.hasOwnProperty("_isRetinaEnabled")}function disableRetinaSupport(){var t,e,o;isRetinaEnabled()&&(t=HTMLCanvasElement.prototype,e=CanvasRenderingContext2D.prototype,o=t._bak,Object.defineProperty(t,"width",o.width),Object.defineProperty(t,"height",o.height),e.drawImage=o.drawImage,e.getImageData=o.getImageData,Object.defineProperty(e,"shadowOffsetX",o.shadowOffsetX),Object.defineProperty(e,"shadowOffsetY",o.shadowOffsetY),Object.defineProperty(e,"shadowBlur",o.shadowBlur),delete t._isRetinaEnabled,delete t.isRetinaEnabled,delete t._bak)}function normalizeCanvas(t,e){var o;return t.isRetinaEnabled?((o=newCanvas(new Point(t.width,t.height),!0)).getContext("2d").drawImage(t,0,0),e?o:(t.isRetinaEnabled=!1,t.width=o.width,t.height=o.height,t.getContext("2d").drawImage(o,0,0),t)):t}function Animation(t,e,o,i,r,n){this.setter=t,this.getter=e,this.delta=o||0,this.duration=i||0,this.easing=isString(r)?this.easings[r]||this.easings.sinusoidal:r||this.easings.sinusoidal,this.onComplete=n||null,this.endTime=null,this.destination=null,this.isActive=!1,this.start()}function Color(t,e,o,i){this.r=t||0,this.g=e||0,this.b=o||0,this.a=i||(0===i?0:1)}function Point(t,e){this.x=t||0,this.y=e||0}function Rectangle(t,e,o,i){this.init(new Point(t||0,e||0),new Point(o||0,i||0))}function Node(t,e){this.init(t||null,e||[])}function Morph(){this.init()}function ShadowMorph(){this.init()}function HandleMorph(t,e,o,i,r,n){this.init(t,e,o,i,r,n)}function PenMorph(){this.init()}function ColorPaletteMorph(t,e){this.init(t||null,e||new Point(80,50))}function GrayPaletteMorph(t,e){this.init(t||null,e||new Point(80,10))}function ColorPickerMorph(t){this.init(t||new Color(255,255,255))}function BlinkerMorph(t){this.init(t)}function CursorMorph(t){this.init(t)}function BoxMorph(t,e,o){this.init(t,e,o)}function SpeechBubbleMorph(t,e,o,i,r,n,s){this.init(t,e,o,i,r,n,s)}function CircleBoxMorph(t){this.init(t||"vertical")}function SliderButtonMorph(t){this.init(t)}function SliderMorph(t,e,o,i,r,n){this.init(t||1,e||100,o||50,i||10,r||"vertical",n)}function MouseSensorMorph(t,e,o){this.init(t,e,o)}function InspectorMorph(t){this.init(t)}function MenuMorph(t,e,o,i){this.init(t,e,o,i)}function StringMorph(t,e,o,i,r,n,s,a,h,l){this.init(t,e,o,i,r,n,s,a,h,l)}function TextMorph(t,e,o,i,r,n,s,a,h,l){this.init(t,e,o,i,r,n,s,a,h,l)}function TriggerMorph(t,e,o,i,r,n,s,a,h,l,p){this.init(t,e,o,i,r,n,s,a,h,l,p)}function MenuItemMorph(t,e,o,i,r,n,s,a,h,l,p,c){this.shortcutString=c||null,this.shortcut=null,this.init(t,e,o,i,r,n,s,a,h,l,p)}function FrameMorph(t){this.init(t)}function ScrollFrameMorph(t,e,o){this.init(t,e,o)}function ListMorph(t,e,o,i){this.init(t||[],e||function(t){return isString(t)?t:t.toSource?t.toSource():t.toString()},o||[],i)}function StringFieldMorph(t,e,o,i,r,n,s){this.init(t||"",e||100,o||12,i||"sans-serif",r||!1,n||!1,s)}function BouncerMorph(){this.init()}function HandMorph(t){this.init(t)}function WorldMorph(t,e){this.init(t,e)}enableRetinaSupport(),Animation.prototype.easings={linear:function(t){return t},sinusoidal:function(t){return 1-Math.cos(radians(90*t))},quadratic:function(t){return t<.5?2*t*t:(4-2*t)*t-1},cubic:function(t){return t<.5?4*t*t*t:(t-1)*(2*t-2)*(2*t-2)+1},elastic:function(t){return(t-=.5)<0?(.01+.01/t)*Math.sin(50*t):(.02-.01/t)*Math.sin(50*t)+1},sine_in:function(t){return 1-Math.sin(radians(90+90*t))},quad_in:function(t){return t*t},cubic_in:function(t){return t*t*t},elastic_in:function(t){return(.04-.04/t)*Math.sin(25*t)+1},sine_out:function(t){return Math.sin(radians(90*t))},quad_out:function(t){return t*(2-t)},elastic_out:function(t){return.04*t/--t*Math.sin(25*t)}},Animation.prototype.start=function(){this.endTime=Date.now()+this.duration,this.destination=this.getter.call(this)+this.delta,this.isActive=!0},Animation.prototype.step=function(){if(this.isActive){var t=Date.now();t>this.endTime?(this.setter(this.destination),this.isActive=!1,this.onComplete&&this.onComplete()):this.setter(this.destination-this.delta*this.easing((this.endTime-t)/this.duration))}},Color.prototype.toString=function(){return"rgba("+Math.round(this.r)+","+Math.round(this.g)+","+Math.round(this.b)+","+this.a+")"},Color.prototype.copy=function(){return new Color(this.r,this.g,this.b,this.a)},Color.prototype.eq=function(t){return t&&this.r===t.r&&this.g===t.g&&this.b===t.b},Color.prototype.hsv=function(){var t,e,o,i,r,n,s=this.r/255,a=this.g/255,h=this.b/255;if(n=(r=o=t=Math.max(s,a,h))-(e=Math.min(s,a,h)),i=0===t?0:n/t,t===e)o=0;else{switch(t){case s:o=(a-h)/n+(a<h?6:0);break;case a:o=(h-s)/n+2;break;case h:o=(s-a)/n+4}o/=6}return[o,i,r]},Color.prototype.set_hsv=function(t,e,o){var i,r,n,s,a;switch(n=o*(1-e),s=o*(1-(r=6*t-(i=Math.floor(6*t)))*e),a=o*(1-(1-r)*e),i%6){case 0:this.r=o,this.g=a,this.b=n;break;case 1:this.r=s,this.g=o,this.b=n;break;case 2:this.r=n,this.g=o,this.b=a;break;case 3:this.r=n,this.g=s,this.b=o;break;case 4:this.r=a,this.g=n,this.b=o;break;case 5:this.r=o,this.g=n,this.b=s}this.r*=255,this.g*=255,this.b*=255},Color.prototype.mixed=function(t,e){var o=Math.min(Math.max(t,0),1),i=1-o;return new Color(this.r*o+e.r*i,this.g*o+e.g*i,this.b*o+e.b*i)},Color.prototype.darker=function(t){var e=.8333;return t&&(e=(100-t)/100),this.mixed(e,new Color(0,0,0))},Color.prototype.lighter=function(t){var e=.8333;return t&&(e=(100-t)/100),this.mixed(e,new Color(255,255,255))},Color.prototype.dansDarker=function(){var t=this.hsv(),e=new Color,o=Math.max(t[2]-.16,0);return e.set_hsv(t[0],t[1],o),e},Color.prototype.inverted=function(){return new Color(255-this.r,255-this.g,255-this.b)},Point.prototype.toString=function(){return Math.round(this.x.toString())+"@"+Math.round(this.y.toString())},Point.prototype.copy=function(){return new Point(this.x,this.y)},Point.prototype.eq=function(t){return this.x===t.x&&this.y===t.y},Point.prototype.lt=function(t){return this.x<t.x&&this.y<t.y},Point.prototype.gt=function(t){return this.x>t.x&&this.y>t.y},Point.prototype.ge=function(t){return this.x>=t.x&&this.y>=t.y},Point.prototype.le=function(t){return this.x<=t.x&&this.y<=t.y},Point.prototype.max=function(t){return new Point(Math.max(this.x,t.x),Math.max(this.y,t.y))},Point.prototype.min=function(t){return new Point(Math.min(this.x,t.x),Math.min(this.y,t.y))},Point.prototype.round=function(){return new Point(Math.round(this.x),Math.round(this.y))},Point.prototype.abs=function(){return new Point(Math.abs(this.x),Math.abs(this.y))},Point.prototype.neg=function(){return new Point(-this.x,-this.y)},Point.prototype.mirror=function(){return new Point(this.y,this.x)},Point.prototype.floor=function(){return new Point(Math.max(Math.floor(this.x),0),Math.max(Math.floor(this.y),0))},Point.prototype.ceil=function(){return new Point(Math.ceil(this.x),Math.ceil(this.y))},Point.prototype.add=function(t){return t instanceof Point?new Point(this.x+t.x,this.y+t.y):new Point(this.x+t,this.y+t)},Point.prototype.subtract=function(t){return t instanceof Point?new Point(this.x-t.x,this.y-t.y):new Point(this.x-t,this.y-t)},Point.prototype.multiplyBy=function(t){return t instanceof Point?new Point(this.x*t.x,this.y*t.y):new Point(this.x*t,this.y*t)},Point.prototype.divideBy=function(t){return t instanceof Point?new Point(this.x/t.x,this.y/t.y):new Point(this.x/t,this.y/t)},Point.prototype.floorDivideBy=function(t){return t instanceof Point?new Point(Math.floor(this.x/t.x),Math.floor(this.y/t.y)):new Point(Math.floor(this.x/t),Math.floor(this.y/t))},Point.prototype.r=function(){var t=this.multiplyBy(this);return Math.sqrt(t.x+t.y)},Point.prototype.degrees=function(){var t,e;return 0===this.x?0<=this.y?90:270:(t=this.y/this.x,e=Math.atan(t),0<=this.x?0<=this.y?degrees(e):360+degrees(e):180+degrees(e))},Point.prototype.theta=function(){var t,e;return 0===this.x?0<=this.y?radians(90):radians(270):(t=this.y/this.x,e=Math.atan(t),0<=this.x?0<=this.y?e:radians(360)+e:radians(180)+e)},Point.prototype.crossProduct=function(t){return this.multiplyBy(t.mirror())},Point.prototype.distanceTo=function(t){return t.subtract(this).r()},Point.prototype.rotate=function(t,e){var o=this.subtract(e);return"right"===t?new Point(-o.y,o.y).add(e):"left"===t?new Point(o.y,-o.y).add(e):e.subtract(o)},Point.prototype.flip=function(t,e){return"vertical"===t?new Point(this.x,2*e.y-this.y):new Point(2*e.x-this.x,this.y)},Point.prototype.distanceAngle=function(t,e){var o,i,r=e;return 270<r?r-=360:r<-270&&(r+=360),-90<=r&&r<=90?(o=Math.sin(radians(r))*t,i=Math.sqrt(t*t-o*o),new Point(o+this.x,this.y-i)):(o=Math.sin(radians(180-r))*t,i=Math.sqrt(t*t-o*o),new Point(o+this.x,this.y+i))},Point.prototype.scaleBy=function(t){return this.multiplyBy(t)},Point.prototype.translateBy=function(t){return this.add(t)},Point.prototype.rotateBy=function(t,e){var o=e||new Point(0,0),i=this.subtract(o),r=i.r(),n=t-i.theta();return new Point(o.x+r*Math.cos(n),o.y-r*Math.sin(n))},Point.prototype.asArray=function(){return[this.x,this.y]},Rectangle.prototype.init=function(t,e){this.origin=t,this.corner=e},Rectangle.prototype.toString=function(){return"["+this.origin.toString()+" | "+this.extent().toString()+"]"},Rectangle.prototype.copy=function(){return new Rectangle(this.left(),this.top(),this.right(),this.bottom())},Point.prototype.corner=function(t){return new Rectangle(this.x,this.y,t.x,t.y)},Point.prototype.rectangle=function(t){var e,o;return e=this.min(t),o=this.max(t),new Rectangle(e.x,e.y,o.x,o.y)},Point.prototype.extent=function(t){var e=this.add(t);return new Rectangle(this.x,this.y,e.x,e.y)},Rectangle.prototype.setTo=function(t,e,o,i){this.origin=new Point(t||(0===t?0:this.left()),e||(0===e?0:this.top())),this.corner=new Point(o||(0===o?0:this.right()),i||(0===i?0:this.bottom()))},Rectangle.prototype.area=function(){var t=this.width();return t<0?0:Math.max(t*this.height(),0)},Rectangle.prototype.bottom=function(){return this.corner.y},Rectangle.prototype.bottomCenter=function(){return new Point(this.center().x,this.bottom())},Rectangle.prototype.bottomLeft=function(){return new Point(this.origin.x,this.corner.y)},Rectangle.prototype.bottomRight=function(){return this.corner.copy()},Rectangle.prototype.boundingBox=function(){return this},Rectangle.prototype.center=function(){return this.origin.add(this.corner.subtract(this.origin).floorDivideBy(2))},Rectangle.prototype.corners=function(){return[this.origin,this.bottomLeft(),this.corner,this.topRight()]},Rectangle.prototype.extent=function(){return this.corner.subtract(this.origin)},Rectangle.prototype.height=function(){return this.corner.y-this.origin.y},Rectangle.prototype.left=function(){return this.origin.x},Rectangle.prototype.leftCenter=function(){return new Point(this.left(),this.center().y)},Rectangle.prototype.right=function(){return this.corner.x},Rectangle.prototype.rightCenter=function(){return new Point(this.right(),this.center().y)},Rectangle.prototype.top=function(){return this.origin.y},Rectangle.prototype.topCenter=function(){return new Point(this.center().x,this.top())},Rectangle.prototype.topLeft=function(){return this.origin},Rectangle.prototype.topRight=function(){return new Point(this.corner.x,this.origin.y)},Rectangle.prototype.width=function(){return this.corner.x-this.origin.x},Rectangle.prototype.position=function(){return this.origin},Rectangle.prototype.eq=function(t){return this.origin.eq(t.origin)&&this.corner.eq(t.corner)},Rectangle.prototype.abs=function(){var t,e;return t=this.origin.abs(),e=this.corner.max(t),t.corner(e)},Rectangle.prototype.insetBy=function(t){var e=new Rectangle;return e.origin=this.origin.add(t),e.corner=this.corner.subtract(t),e},Rectangle.prototype.expandBy=function(t){var e=new Rectangle;return e.origin=this.origin.subtract(t),e.corner=this.corner.add(t),e},Rectangle.prototype.growBy=function(t){var e=new Rectangle;return e.origin=this.origin.copy(),e.corner=this.corner.add(t),e},Rectangle.prototype.intersect=function(t){var e=new Rectangle;return e.origin=this.origin.max(t.origin),e.corner=this.corner.min(t.corner),e},Rectangle.prototype.merge=function(t){var e=new Rectangle;return e.origin=this.origin.min(t.origin),e.corner=this.corner.max(t.corner),e},Rectangle.prototype.mergeWith=function(t){this.origin=this.origin.min(t.origin),this.corner=this.corner.max(t.corner)},Rectangle.prototype.round=function(){return this.origin.round().corner(this.corner.round())},Rectangle.prototype.spread=function(){return this.origin.floor().corner(this.corner.ceil()).expandBy(1)},Rectangle.prototype.amountToTranslateWithin=function(t){var e=0,o=0;return this.right()>t.right()&&(e=t.right()-this.right()),this.bottom()>t.bottom()&&(o=t.bottom()-this.bottom()),this.left()+e<t.left()&&(e=t.left()-this.left()),this.top()+o<t.top()&&(o=t.top()-this.top()),new Point(e,o)},Rectangle.prototype.containsPoint=function(t){return this.origin.le(t)&&t.lt(this.corner)},Rectangle.prototype.containsRectangle=function(t){return t.origin.gt(this.origin)&&t.corner.lt(this.corner)},Rectangle.prototype.intersects=function(t){var e=t.origin,o=t.corner;return o.x>=this.origin.x&&o.y>=this.origin.y&&e.x<=this.corner.x&&e.y<=this.corner.y},Rectangle.prototype.isNearTo=function(t,e){var o=t.origin,i=t.corner,r=e||0;return i.x+r>=this.origin.x&&i.y+r>=this.origin.y&&o.x-r<=this.corner.x&&o.y-r<=this.corner.y},Rectangle.prototype.scaleBy=function(t){var e=this.origin.multiplyBy(t),o=this.corner.multiplyBy(t);return new Rectangle(e.x,e.y,o.x,o.y)},Rectangle.prototype.translateBy=function(t){var e=this.origin.add(t),o=this.corner.add(t);return new Rectangle(e.x,e.y,o.x,o.y)},Rectangle.prototype.asArray=function(){return[this.left(),this.top(),this.right(),this.bottom()]},Rectangle.prototype.asArray_xywh=function(){return[this.left(),this.top(),this.width(),this.height()]},Node.prototype.init=function(t,e){this.parent=t||null,this.children=e||[]},Node.prototype.toString=function(){return"a Node["+this.children.length.toString()+"]"},Node.prototype.addChild=function(t){this.children.push(t),t.parent=this},Node.prototype.addChildFirst=function(t){this.children.splice(0,null,t),t.parent=this},Node.prototype.removeChild=function(t){var e=this.children.indexOf(t);-1!==e&&this.children.splice(e,1)},Node.prototype.root=function(){return null===this.parent?this:this.parent.root()},Node.prototype.depth=function(){return null===this.parent?0:this.parent.depth()+1},Node.prototype.allChildren=function(){var e=[this];return this.children.forEach(function(t){e=e.concat(t.allChildren())}),e},Node.prototype.forAllChildren=function(e){0<this.children.length&&this.children.forEach(function(t){t.forAllChildren(e)}),e.call(null,this)},Node.prototype.anyChild=function(t){var e;if(t.call(null,this))return!0;for(e=0;e<this.children.length;e+=1)if(this.children[e].anyChild(t))return!0;return!1},Node.prototype.allLeafs=function(){var e=[];return this.allChildren().forEach(function(t){0===t.children.length&&e.push(t)}),e},Node.prototype.allParents=function(){var t=[this];return null!==this.parent&&(t=t.concat(this.parent.allParents())),t},Node.prototype.siblings=function(){var e=this;return null===this.parent?[]:this.parent.children.filter(function(t){return t!==e})},Node.prototype.parentThatIsA=function(t){return this instanceof t?this:this.parent?this.parent.parentThatIsA(t):null},Node.prototype.parentThatIsAnyOf=function(t){var e=!1,o=this;return t.forEach(function(t){o.constructor!==t||(e=!0)}),e?this:this.parent?this.parent.parentThatIsAnyOf(t):null},Morph.prototype=new Node,Morph.prototype.constructor=Morph,Morph.uber=Node.prototype,Morph.prototype.trackChanges=!0,Morph.prototype.shadowBlur=4,Morph.prototype.init=function(t){Morph.uber.init.call(this),this.isMorph=!0,this.image=null,this.bounds=new Rectangle(0,0,50,40),this.cachedFullImage=null,this.cachedFullBounds=null,this.color=new Color(80,80,80),this.texture=null,this.cachedTexture=null,this.alpha=1,this.isVisible=!0,this.isDraggable=!1,this.isTemplate=!1,this.acceptsDrops=!1,this.noticesTransparentClick=!1,t||this.drawNew(),this.fps=0,this.customContextMenu=null,this.lastTime=Date.now(),this.onNextStep=null},Morph.prototype.toString=function(){return"a "+(this.constructor.name||this.constructor.toString().split(" ")[1].split("(")[0])+" "+this.children.length.toString()+" "+this.bounds},Morph.prototype.destroy=function(){null!==this.parent&&(this.fullChanged(),this.parent.removeChild(this))},Morph.prototype.stepFrame=function(){if(!this.step)return null;var t,e,o;e=(t=Date.now())-this.lastTime,(0<this.fps?1e3/this.fps-e:0)<1&&(this.lastTime=t,this.onNextStep&&(o=this.onNextStep,this.onNextStep=null,o.call(this)),this.step(),this.children.forEach(function(t){t.stepFrame()}))},Morph.prototype.nextSteps=function(t){var e=t||[],o=e.shift(),i=this;o&&(this.onNextStep=function(){o.call(i),i.nextSteps(e)})},Morph.prototype.step=nop,Morph.prototype.left=function(){return this.bounds.left()},Morph.prototype.right=function(){return this.bounds.right()},Morph.prototype.top=function(){return this.bounds.top()},Morph.prototype.bottom=function(){return this.bounds.bottom()},Morph.prototype.center=function(){return this.bounds.center()},Morph.prototype.bottomCenter=function(){return this.bounds.bottomCenter()},Morph.prototype.bottomLeft=function(){return this.bounds.bottomLeft()},Morph.prototype.bottomRight=function(){return this.bounds.bottomRight()},Morph.prototype.boundingBox=function(){return this.bounds},Morph.prototype.corners=function(){return this.bounds.corners()},Morph.prototype.leftCenter=function(){return this.bounds.leftCenter()},Morph.prototype.rightCenter=function(){return this.bounds.rightCenter()},Morph.prototype.topCenter=function(){return this.bounds.topCenter()},Morph.prototype.topLeft=function(){return this.bounds.topLeft()},Morph.prototype.topRight=function(){return this.bounds.topRight()},Morph.prototype.position=function(){return this.bounds.origin},Morph.prototype.extent=function(){return this.bounds.extent()},Morph.prototype.width=function(){return this.bounds.width()},Morph.prototype.height=function(){return this.bounds.height()},Morph.prototype.fullBounds=function(){var e;return e=this.bounds,this.children.forEach(function(t){t.isVisible&&(e=e.merge(t.fullBounds()))}),e},Morph.prototype.fullBoundsNoShadow=function(){var e;return e=this.bounds,this.children.forEach(function(t){t instanceof ShadowMorph||!t.isVisible||(e=e.merge(t.fullBounds()))}),e},Morph.prototype.visibleBounds=function(){var e=this.bounds;return this.allParents().filter(function(t){return t instanceof FrameMorph}).forEach(function(t){e=e.intersect(t.bounds)}),e},Morph.prototype.moveBy=function(t){this.fullChanged(),this.silentMoveBy(t),this.fullChanged()},Morph.prototype.silentMoveBy=function(t){var e=this.children,o=e.length;for(this.bounds=this.bounds.translateBy(t),this.cachedFullBounds&&(this.cachedFullBounds=this.cachedFullBounds.translateBy(t));0<o;o-=1)e[o-1].silentMoveBy(t)},Morph.prototype.setPosition=function(t){var e=t.subtract(this.topLeft());0===e.x&&0===e.y||this.moveBy(e)},Morph.prototype.silentSetPosition=function(t){var e=t.subtract(this.topLeft());0===e.x&&0===e.y||this.silentMoveBy(e)},Morph.prototype.setLeft=function(t){this.setPosition(new Point(t,this.top()))},Morph.prototype.setRight=function(t){this.setPosition(new Point(t-this.width(),this.top()))},Morph.prototype.setTop=function(t){this.setPosition(new Point(this.left(),t))},Morph.prototype.setBottom=function(t){this.setPosition(new Point(this.left(),t-this.height()))},Morph.prototype.setCenter=function(t){this.setPosition(t.subtract(this.extent().floorDivideBy(2)))},Morph.prototype.setFullCenter=function(t){this.setPosition(t.subtract(this.fullBounds().extent().floorDivideBy(2)))},Morph.prototype.keepWithin=function(t){var e,o,i,r;0<(o=this.fullBounds().right()-t.right())&&this.moveBy(new Point(-o,0)),(e=this.fullBounds().left()-t.left())<0&&this.moveBy(new Point(-e,0)),0<(r=this.fullBounds().bottom()-t.bottom())&&this.moveBy(new Point(0,-r)),(i=this.fullBounds().top()-t.top())<0&&this.moveBy(new Point(0,-i))},Morph.prototype.scrollIntoView=function(){var t,e,o,i,r=this.parentThatIsA(ScrollFrameMorph);r&&(0<(e=Math.min(this.fullBounds().right()-r.right(),r.contents.right()-r.right()))&&r.contents.moveBy(new Point(-e,0)),(t=this.fullBounds().left()-r.left())<0&&r.contents.moveBy(new Point(-t,0)),(o=this.fullBounds().top()-r.top())<0&&r.contents.moveBy(new Point(0,-o)),0<(i=this.fullBounds().bottom()-r.bottom())&&r.contents.moveBy(new Point(0,-i)),r.adjustScrollBars())},Morph.prototype.setExtent=function(t,e){e?this.silentSetExtent(t):t.eq(this.extent())||(this.changed(),this.silentSetExtent(t),this.changed(),this.drawNew())},Morph.prototype.silentSetExtent=function(t){var e,o,i;e=t.round(),o=Math.max(e.x,0),i=Math.max(e.y,0),this.bounds.corner=new Point(this.bounds.origin.x+o,this.bounds.origin.y+i)},Morph.prototype.setWidth=function(t){this.setExtent(new Point(t||0,this.height()))},Morph.prototype.silentSetWidth=function(t){var e=Math.max(Math.round(t||0),0);this.bounds.corner=new Point(this.bounds.origin.x+e,this.bounds.corner.y)},Morph.prototype.setHeight=function(t){this.setExtent(new Point(this.width(),t||0))},Morph.prototype.silentSetHeight=function(t){var e=Math.max(Math.round(t||0),0);this.bounds.corner=new Point(this.bounds.corner.x,this.bounds.origin.y+e)},Morph.prototype.setColor=function(t){t&&(this.color.eq(t)||(this.color=t,this.changed(),this.drawNew()))},Morph.prototype.drawNew=function(){this.image=newCanvas(this.extent());var t=this.image.getContext("2d");t.fillStyle=this.color.toString(),t.beginPath(),t.moveTo(0,0),t.lineTo(this.image.width,0),t.lineTo(this.image.width,this.image.height),t.lineTo(0,this.image.height+1e-4),t.closePath(),t.fill(),this.cachedTexture?this.drawCachedTexture():this.texture&&this.drawTexture(this.texture)},Morph.prototype.drawTexture=function(t){var e=this;this.cachedTexture=new Image,this.cachedTexture.onload=function(){e.drawCachedTexture()},this.cachedTexture.src=this.texture=t},Morph.prototype.drawCachedTexture=function(){var t,e,o=this.cachedTexture,i=Math.floor(this.image.width/o.width),r=Math.floor(this.image.height/o.height),n=this.image.getContext("2d");for(e=0;e<=r;e+=1)for(t=0;t<=i;t+=1)n.drawImage(o,t*o.width,e*o.height);this.changed()},Morph.prototype.drawOn=function(t,e){var o,i,r,n,s,a,h,l,p=this.cachedFullImage||this.image,c=this.cachedFullBounds||this.bounds;if(!this.isVisible)return null;if((o=(e||c).intersect(c)).extent().gt(new Point(0,0))){if(i=c.position().neg(),r=o.copy().translateBy(i),(n=t.getContext("2d")).globalAlpha=this.alpha,h=r.left(),l=r.top(),s=Math.min(r.width(),p.width-h),a=Math.min(r.height(),p.height-l),s<1||a<1)return null;n.drawImage(p,h,l,s,a,o.left(),o.top(),s,a)}},Morph.prototype.fullDrawOn=function(e,t){var o;if(!this.isVisible)return null;o=t||this.cachedFullBounds||this.fullBounds(),this.drawOn(e,o),this.cachedFullImage||this.children.forEach(function(t){t.fullDrawOn(e,o)})},Morph.prototype.hide=function(){this.isVisible=!1,this.changed(),this.children.forEach(function(t){t.hide()})},Morph.prototype.show=function(){this.isVisible=!0,this.changed(),this.children.forEach(function(t){t.show()})},Morph.prototype.toggleVisibility=function(){this.isVisible=!this.isVisible,this.changed(),this.children.forEach(function(t){t.toggleVisibility()})},Morph.prototype.fullImageClassic=function(){var t=this.cachedFullBounds||this.fullBounds(),e=newCanvas(t.extent());return e.getContext("2d").translate(-t.origin.x,-t.origin.y),this.fullDrawOn(e,t),e.globalAlpha=this.alpha,e},Morph.prototype.fullImage=function(){var t,e,o;return t=newCanvas(this.fullBounds().extent()),e=t.getContext("2d"),o=this.fullBounds(),this.allChildren().forEach(function(t){t.isVisible&&(e.globalAlpha=t.alpha,t.image.width&&t.image.height&&e.drawImage(t.image,t.bounds.origin.x-o.origin.x,t.bounds.origin.y-o.origin.y))}),t},Morph.prototype.shadowImage=function(t,e){var o,i,r,n,s,a=t||new Point(7,7),h=e||new Color(0,0,0);return o=this.fullBounds().extent(),i=this.fullImage(),(s=(r=newCanvas(o)).getContext("2d")).drawImage(i,0,0),s.globalCompositeOperation="destination-out",s.drawImage(i,-a.x,-a.y),(s=(n=newCanvas(o)).getContext("2d")).drawImage(r,0,0),s.globalCompositeOperation="source-atop",s.fillStyle=h.toString(),s.fillRect(0,0,o.x,o.y),n},Morph.prototype.shadowImageBlurred=function(t,e){var o,i,r,n,s=t||new Point(7,7),a=this.shadowBlur,h=e||new Color(0,0,0);return o=this.fullBounds().extent().add(2*a),i=this.fullImage(),(n=(r=newCanvas(o)).getContext("2d")).shadowOffsetX=s.x,n.shadowOffsetY=s.y,n.shadowBlur=a,n.shadowColor=h.toString(),n.drawImage(i,a-s.x,a-s.y),n.shadowOffsetX=0,n.shadowOffsetY=0,n.shadowBlur=0,n.globalCompositeOperation="destination-out",n.drawImage(i,a-s.x,a-s.y),r},Morph.prototype.shadow=function(t,e,o){var i=new ShadowMorph,r=t||new Point(7,7),n=e||(0===e?0:.2),s=this.fullBounds();return i.setExtent(s.extent().add(2*this.shadowBlur)),useBlurredShadows&&!MorphicPreferences.isFlat?(i.image=this.shadowImageBlurred(r,o),i.alpha=n,i.setPosition(s.origin.add(r).subtract(this.shadowBlur))):(i.image=this.shadowImage(r,o),i.alpha=n,i.setPosition(s.origin.add(r))),i},Morph.prototype.addShadow=function(t,e,o){var i,r=t||new Point(7,7),n=e||(0===e?0:.2);return i=this.shadow(r,n,o),this.addBack(i),this.fullChanged(),i},Morph.prototype.getShadow=function(){var t;return 0!==(t=this.children.slice(0).reverse().filter(function(t){return t instanceof ShadowMorph})).length?t[0]:null},Morph.prototype.removeShadow=function(){var t=this.getShadow();null!==t&&(this.fullChanged(),this.removeChild(t))},Morph.prototype.penTrails=function(){return this.image},Morph.prototype.changed=function(){if(this.trackChanges){var t=this.root();t instanceof WorldMorph&&t.broken.push(this.visibleBounds().spread())}this.parent&&this.parent.childChanged(this)},Morph.prototype.fullChanged=function(){if(this.trackChanges){var t=this.root();t instanceof WorldMorph&&t.broken.push((this.cachedFullBounds||this.fullBounds()).spread())}},Morph.prototype.childChanged=function(){this.parent&&this.parent.childChanged(this)},Morph.prototype.world=function(){var t=this.root();return t instanceof WorldMorph?t:t instanceof HandMorph?t.world:null},Morph.prototype.add=function(t){var e=t.parent;null!==e&&e.removeChild(t),this.addChild(t)},Morph.prototype.addBack=function(t){var e=t.parent;null!==e&&e.removeChild(t),this.addChildFirst(t)},Morph.prototype.topMorphAt=function(t){var e,o;if(!this.isVisible)return null;for(e=this.children.length-1;0<=e;e-=1)if(o=this.children[e].topMorphAt(t))return o;return!this.bounds.containsPoint(t)||!this.noticesTransparentClick&&this.isTransparentAt(t)?null:this},Morph.prototype.topMorphSuchThat=function(t){var e;return t.call(null,this)?(e=detect(this.children.slice(0).reverse(),t))?e.topMorphSuchThat(t):this:null},Morph.prototype.overlappedMorphs=function(){var e=this.world(),o=this.fullBounds(),i=this,r=this.allParents(),n=this.allChildren();return e.allChildren().filter(function(t){return t.isVisible&&t!==i&&t!==e&&!contains(r,t)&&!contains(n,t)&&t.fullBounds().intersects(o)})},Morph.prototype.getPixelColor=function(t){var e,o;return e=t.subtract(this.bounds.origin),new Color((o=this.image.getContext("2d").getImageData(e.x,e.y,1,1)).data[0],o.data[1],o.data[2],o.data[3])},Morph.prototype.isTransparentAt=function(t){var e;return!!this.bounds.containsPoint(t)&&(!this.texture&&(e=t.subtract(this.bounds.origin),0===this.image.getContext("2d").getImageData(Math.floor(e.x),Math.floor(e.y),1,1).data[3]))},Morph.prototype.copy=function(){var t=copy(this);return t.parent=null,t.children=[],t.bounds=this.bounds.copy(),t},Morph.prototype.fullCopy=function(){var t,e=new Map;return(t=this.copyRecordingReferences(e)).forAllChildren(function(t){t.updateReferences(e)}),t},Morph.prototype.copyRecordingReferences=function(e){var o=this.copy();return e.set(this,o),this.children.forEach(function(t){o.add(t.copyRecordingReferences(e))}),o},Morph.prototype.updateReferences=function(t){var e,o,i,r,n=Object.keys(this),s=n.length;for(r=0;r<s;r+=1)(o=this[e=n[r]])&&o.isMorph&&(i=t.get(o))&&(this[e]=i)},Morph.prototype.rootForGrab=function(){return this instanceof ShadowMorph?this.parent.rootForGrab():this.parent instanceof ScrollFrameMorph?this.parent:null===this.parent||this.parent instanceof WorldMorph||this.parent instanceof FrameMorph||!0===this.isDraggable?this:this.parent.rootForGrab()},Morph.prototype.isCorrectingOutsideDrag=function(){return!0},Morph.prototype.wantsDropOf=function(t){return!(t instanceof HandleMorph||t instanceof MenuMorph||t instanceof InspectorMorph)&&this.acceptsDrops},Morph.prototype.pickUp=function(t){var e=t||this.world();this.setPosition(e.hand.position().subtract(this.extent().floorDivideBy(2))),e.hand.grab(this)},Morph.prototype.isPickedUp=function(){return null!==this.parentThatIsA(HandMorph)},Morph.prototype.situation=function(){return this.parent?{origin:this.parent,position:this.position().subtract(this.parent.position())}:null},Morph.prototype.slideBackTo=function(t,e,o,i){var r=t.origin.position().add(t.position),n=this;this.glideTo(r,e,null,function(){t.origin.add(n),o&&o(),n.justDropped&&n.justDropped(),t.origin.reactToDropOf&&t.origin.reactToDropOf(n),i&&i()})},Morph.prototype.glideTo=function(t,e,o,i){var r=this.world(),n=this;r.animations.push(new Animation(function(t){n.setLeft(t)},function(){return n.left()},-(this.left()-t.x),e||100,o,i)),r.animations.push(new Animation(function(t){n.setTop(t)},function(){return n.top()},-(this.top()-t.y),e||100,o))},Morph.prototype.fadeTo=function(e,o,i,t){var r=this.world(),n=this,s=this.alpha;this.children.forEach(function(t){t.fadeTo(e,o,i)}),r.animations.push(new Animation(function(t){n.alpha=t,n.changed()},function(){return n.alpha},e-this.alpha,o||200,i,function(){n.alpha=s,t&&t()}))},Morph.prototype.perish=function(t,e){var o=this;this.fadeTo(0,t||100,null,function(){o.destroy(),e&&e()})},Morph.prototype.nop=nop,Morph.prototype.resize=function(){this.world().activeHandle=new HandleMorph(this)},Morph.prototype.move=function(){this.world().activeHandle=new HandleMorph(this,null,null,null,null,"move")},Morph.prototype.moveCenter=function(){this.world().activeHandle=new HandleMorph(this,null,null,null,null,"moveCenter")},Morph.prototype.hint=function(t){var e,o;(o=t)?t.toString&&(o=t.toString()):o="NULL",(e=new MenuMorph(this,o)).isDraggable=!0,e.popUpCenteredAtHand(this.world())},Morph.prototype.inform=function(t){var e,o;(o=t)?t.toString&&(o=t.toString()):o="NULL",(e=new MenuMorph(this,o)).addItem("Ok"),e.isDraggable=!0,e.popUpCenteredAtHand(this.world())},Morph.prototype.prompt=function(t,e,o,i,r,n,s,a){var h,l,p,c;s&&(c=!0),h=new MenuMorph(e||null,t||"",o||null),l=new StringFieldMorph(i||"",r||100,MorphicPreferences.prompterFontSize,MorphicPreferences.prompterFontName,!1,!1,c),h.items.push(l),(s||MorphicPreferences.useSliderForInput)&&((p=new SliderMorph(n||0,s,parseFloat(i),Math.floor((s-n)/4),"horizontal")).alpha=1,p.color=new Color(225,225,225),p.button.color=h.borderColor,p.button.highlightColor=p.button.color.copy(),p.button.highlightColor.b+=100,p.button.pressColor=p.button.color.copy(),p.button.pressColor.b+=150,p.setHeight(MorphicPreferences.prompterSliderSize),p.action=a?function(t){l.changed(),l.text.text=Math.round(t).toString(),l.text.drawNew(),l.text.changed(),l.text.edit()}:function(t){l.changed(),l.text.text=t.toString(),l.text.drawNew(),l.text.changed()},h.items.push(p)),h.addLine(2),h.addItem("Ok",function(){return l.string()}),h.addItem("Cancel",function(){return null}),h.isDraggable=!0,h.popUpAtHand(this.world()),l.text.edit()},Morph.prototype.pickColor=function(t,e,o,i){var r,n;r=new MenuMorph(e||null,t||"",o||null),n=new ColorPickerMorph(i),r.items.push(n),r.addLine(2),r.addItem("Ok",function(){return n.getChoice()}),r.addItem("Cancel",function(){return null}),r.isDraggable=!0,r.popUpAtHand(this.world())},Morph.prototype.inspect=function(t){var e,o=this.world instanceof Function?this.world():this.root()||this.world,i=this;t&&(i=t),(e=new InspectorMorph(i)).setPosition(o.hand.position()),e.keepWithin(o),o.add(e),e.changed()},Morph.prototype.contextMenu=function(){var t;return this.customContextMenu?this.customContextMenu:(t=this.world instanceof Function?this.world():this.world)&&t.isDevMode?this.parent===t?this.developersMenu():this.hierarchyMenu():this.userMenu()||this.parent&&this.parent.userMenu()},Morph.prototype.hierarchyMenu=function(){var t=this.allParents(),e=this.world instanceof Function?this.world():this.world,o=new MenuMorph(this,null);return t.forEach(function(t){t.developersMenu&&t!==e&&o.addMenu(t.toString().slice(0,50),t.developersMenu())}),o},Morph.prototype.developersMenu=function(){var t=this.world instanceof Function?this.world():this.world,e=this.userMenu()||this.parent&&this.parent.userMenu(),o=new MenuMorph(this,this.constructor.name||this.constructor.toString().split(" ")[1].split("(")[0]);return e&&(o.addMenu("user features",e),o.addLine()),o.addItem("color...",function(){this.pickColor(o.title+localize("\ncolor:"),this.setColor,this,this.color)},"choose another color \nfor this morph"),o.addItem("transparency...",function(){this.prompt(o.title+localize("\nalpha\nvalue:"),this.setAlphaScaled,this,(100*this.alpha).toString(),null,1,100,!0)},"set this morph's\nalpha value"),o.addItem("resize...","resize","show a handle\nwhich can be dragged\nto change this morph's extent"),o.addLine(),o.addItem("duplicate",function(){this.fullCopy().pickUp(this.world())},"make a copy\nand pick it up"),o.addItem("pick up","pickUp","detach and put \ninto the hand"),o.addItem("attach...","attach","stick this morph\nto another one"),o.addItem("move...","move","show a handle\nwhich can be dragged\nto move this morph"),o.addItem("inspect...","inspect","open a window\non all properties"),o.addItem("pic...",function(){window.open(this.fullImageClassic().toDataURL())},"open a new window\nwith a picture of this morph"),o.addLine(),this.isDraggable?o.addItem("lock","toggleIsDraggable","make this morph\nunmovable"):o.addItem("unlock","toggleIsDraggable","make this morph\nmovable"),o.addItem("hide","hide"),o.addItem("delete","destroy"),this instanceof WorldMorph||(o.addLine(),o.addItem("World...",function(){t.contextMenu().popUpAtHand(t)},"show the\nWorld's menu")),o},Morph.prototype.userMenu=function(){return null},Morph.prototype.setAlphaScaled=function(t){var e,o;"number"==typeof t?(o=t/100,this.alpha=Math.min(Math.max(o,.1),1)):(e=parseFloat(t),isNaN(e)||(o=e/100,this.alpha=Math.min(Math.max(o,.1),1))),this.changed()},Morph.prototype.attach=function(){var t=this.overlappedMorphs(),e=new MenuMorph(this,"choose new parent:"),o=this;t.forEach(function(t){e.addItem(t.toString().slice(0,50),function(){t.add(o),o.isDraggable=!1})}),0<t.length&&e.popUpAtHand(this.world())},Morph.prototype.toggleIsDraggable=function(){this.isDraggable=!this.isDraggable},Morph.prototype.colorSetters=function(){return["color"]},Morph.prototype.numericalSetters=function(){return["setLeft","setTop","setWidth","setHeight","setAlphaScaled"]},Morph.prototype.allEntryFields=function(){return this.allChildren().filter(function(t){return t.isEditable&&(t instanceof StringMorph||t instanceof TextMorph)})},Morph.prototype.nextEntryField=function(t){var e=this.allEntryFields(),o=e.indexOf(t);return-1!==o&&e.length>o+1?e[o+1]:e[0]},Morph.prototype.previousEntryField=function(t){var e=this.allEntryFields(),o=e.indexOf(t);return-1!==o?0<o?e[o-1]:e[e.length-1]:e[0]},Morph.prototype.tab=function(t){this.nextTab?this.nextTab(t):this.parent&&this.parent.tab(t)},Morph.prototype.backTab=function(t){this.previousTab?this.previousTab(t):this.parent&&this.parent.backTab(t)},Morph.prototype.escalateEvent=function(t,e){for(var o=this.parent;!o[t]&&null!==o.parent;)o=o.parent;o[t]&&o[t](e)},Morph.prototype.evaluateString=function(code){var result;try{result=eval(code),this.drawNew(),this.changed()}catch(t){this.inform(t)}return result},Morph.prototype.isTouching=function(t){var e=this.overlappingImage(t);return!(!e.width||!e.height)&&null!==detect(e.getContext("2d").getImageData(1,1,e.width,e.height).data,function(t){return 0!==t})},Morph.prototype.overlappingImage=function(t){var e=this.fullBounds(),o=t.fullBounds(),i=e.intersect(o),r=newCanvas(i.extent()),n=r.getContext("2d");return i.width()<1||i.height()<1?newCanvas(new Point(1,1)):(n.drawImage(this.fullImage(),i.origin.x-e.origin.x,i.origin.y-e.origin.y),n.globalCompositeOperation="source-in",n.drawImage(t.fullImage(),o.origin.x-i.origin.x,o.origin.y-i.origin.y),r)},ShadowMorph.prototype=new Morph,ShadowMorph.prototype.constructor=ShadowMorph,ShadowMorph.uber=Morph.prototype,ShadowMorph.prototype.topMorphAt=function(){return null},HandleMorph.prototype=new Morph,HandleMorph.prototype.constructor=HandleMorph,HandleMorph.uber=Morph.prototype,HandleMorph.prototype.init=function(t,e,o,i,r,n){var s=MorphicPreferences.handleSize;this.target=t||null,this.minExtent=new Point(e||0,o||0),this.inset=new Point(i||0,r||i||0),this.type=n||"resize",HandleMorph.uber.init.call(this),this.color=new Color(255,255,255),this.isDraggable=!1,this.noticesTransparentClick=!0,this.setExtent(new Point(s,s))},HandleMorph.prototype.drawNew=function(){this.normalImage=newCanvas(this.extent()),this.highlightImage=newCanvas(this.extent()),this.drawOnCanvas(this.normalImage,this.color,new Color(100,100,100)),this.drawOnCanvas(this.highlightImage,new Color(100,100,255),new Color(255,255,255)),this.image=this.normalImage,this.target&&("moveCenter"===this.type?this.setCenter(this.target.center()):this.setPosition(this.target.bottomRight().subtract(this.extent().add(this.inset))),this.target.add(this),this.target.changed())},HandleMorph.prototype.drawOnCanvas=function(t,e,o){var i,r,n,s,a,h=t.getContext("2d"),l=0===this.type.indexOf("move");if(h.lineWidth=1,h.lineCap="round",h.strokeStyle=e.toString(),l)for(r=(i=this.bottomLeft().subtract(this.position())).copy(),s=(n=this.topRight().subtract(this.position())).copy(),a=0;a<=this.height();a+=6)r.y=i.y-a,s.y=n.y-a,h.beginPath(),h.moveTo(r.x,r.y),h.lineTo(s.x,s.y),h.closePath(),h.stroke();for(r=(i=this.bottomLeft().subtract(this.position())).copy(),s=(n=this.topRight().subtract(this.position())).copy(),a=0;a<=this.width();a+=6)r.x=i.x+a,s.x=n.x+a,h.beginPath(),h.moveTo(r.x,r.y),h.lineTo(s.x,s.y),h.closePath(),h.stroke();if(h.strokeStyle=o.toString(),l)for(r=(i=this.bottomLeft().subtract(this.position())).copy(),s=(n=this.topRight().subtract(this.position())).copy(),a=-2;a<=this.height();a+=6)r.y=i.y-a,s.y=n.y-a,h.beginPath(),h.moveTo(r.x,r.y),h.lineTo(s.x,s.y),h.closePath(),h.stroke();for(r=(i=this.bottomLeft().subtract(this.position())).copy(),s=(n=this.topRight().subtract(this.position())).copy(),a=2;a<=this.width();a+=6)r.x=i.x+a,s.x=n.x+a,h.beginPath(),h.moveTo(r.x,r.y),h.lineTo(s.x,s.y),h.closePath(),h.stroke()},HandleMorph.prototype.step=null,HandleMorph.prototype.mouseDownLeft=function(t){var o,i=this.root(),r=this;if(!this.target)return null;o="moveCenter"===this.type?t.subtract(this.center()):t.subtract(this.bounds.origin),this.step=function(){var t,e;i.hand.mouseButton?(t=i.hand.bounds.origin.copy().subtract(o),"resize"===this.type?(e=(e=t.add(r.extent().add(r.inset)).subtract(r.target.bounds.origin)).max(r.minExtent),r.target.setExtent(e),r.setPosition(r.target.bottomRight().subtract(r.extent().add(r.inset)))):"moveCenter"===this.type?r.target.setCenter(t):r.target.setPosition(t.subtract(this.target.extent()).add(this.extent()))):this.step=null},this.target.step||(this.target.step=function(){nop()})},HandleMorph.prototype.rootForGrab=function(){return this},HandleMorph.prototype.mouseEnter=function(){this.image=this.highlightImage,this.changed()},HandleMorph.prototype.mouseLeave=function(){this.image=this.normalImage,this.changed()},HandleMorph.prototype.attach=function(){var t=this.overlappedMorphs(),e=new MenuMorph(this,"choose target:"),o=this;t.forEach(function(t){e.addItem(t.toString().slice(0,50),function(){o.isDraggable=!1,o.target=t,o.drawNew(),o.noticesTransparentClick=!0})}),0<t.length&&e.popUpAtHand(this.world())},PenMorph.prototype=new Morph,PenMorph.prototype.constructor=PenMorph,PenMorph.uber=Morph.prototype,PenMorph.prototype.init=function(){var t=4*MorphicPreferences.handleSize;this.isWarped=!1,this.heading=0,this.isDown=!0,this.size=1,this.wantsRedraw=!1,this.penPoint="tip",this.penBounds=null,HandleMorph.uber.init.call(this),this.setExtent(new Point(t,t))},PenMorph.prototype.changed=function(){if(!1===this.isWarped){var t=this.root();t instanceof WorldMorph&&t.broken.push(this.visibleBounds().spread()),this.parent&&this.parent.childChanged(this)}},PenMorph.prototype.drawNew=function(t){var e,o,i,r,n,s,a=t||this.heading;this.isWarped?this.wantsRedraw=!0:(this.image=newCanvas(this.extent()),e=this.image.getContext("2d"),s=this.width()/2,o=this.center().subtract(this.bounds.origin),n="tip"===this.penPoint?(i=o.distanceAngle(.75*s,a-180),r=o.distanceAngle(s,a+195),o.distanceAngle(s,a-195)):(i=o.distanceAngle(.75*s,a),r=o.distanceAngle(.33*s,a+230),o.distanceAngle(.33*s,a-230)),this.penBounds=new Rectangle(Math.min(o.x,i.x,r.x,n.x),Math.min(o.y,i.y,r.y,n.y),Math.max(o.x,i.x,r.x,n.x),Math.max(o.y,i.y,r.y,n.y)),e.fillStyle=this.color.toString(),e.beginPath(),e.moveTo(o.x,o.y),e.lineTo(r.x,r.y),e.lineTo(i.x,i.y),e.lineTo(n.x,n.y),e.closePath(),e.strokeStyle="white",e.lineWidth=3,e.stroke(),e.strokeStyle="black",e.lineWidth=1,e.stroke(),e.fill())},PenMorph.prototype.setHeading=function(t){this.heading=parseFloat(t)%360,this.drawNew(),this.changed()},PenMorph.prototype.drawLine=function(t,e){var o=this.parent.penTrails().getContext("2d"),i=t.subtract(this.parent.bounds.origin),r=e.subtract(this.parent.bounds.origin);this.isDown&&(o.lineWidth=this.size,o.strokeStyle=this.color.toString(),o.lineCap="round",o.lineJoin="round",o.beginPath(),o.moveTo(i.x,i.y),o.lineTo(r.x,r.y),o.stroke(),!1===this.isWarped&&this.world().broken.push(t.rectangle(e).expandBy(Math.max(this.size/2,1)).intersect(this.parent.visibleBounds()).spread()))},PenMorph.prototype.turn=function(t){this.setHeading(this.heading+parseFloat(t))},PenMorph.prototype.forward=function(t){var e,o=this.center(),i=parseFloat(t);e=0<=i?this.position().distanceAngle(i,this.heading):this.position().distanceAngle(Math.abs(i),this.heading-180),this.setPosition(e),this.drawLine(o,this.center())},PenMorph.prototype.down=function(){this.isDown=!0},PenMorph.prototype.up=function(){this.isDown=!1},PenMorph.prototype.clear=function(){this.parent.drawNew(),this.parent.changed()},PenMorph.prototype.startWarp=function(){this.wantsRedraw=!1,this.isWarped=!0},PenMorph.prototype.endWarp=function(){this.isWarped=!1,this.wantsRedraw&&(this.drawNew(),this.wantsRedraw=!1),this.parent.changed()},PenMorph.prototype.warp=function(t){this.startWarp(),t.call(this),this.endWarp()},PenMorph.prototype.warpOp=function(t,e){this.startWarp(),this[t].apply(this,e),this.endWarp()},PenMorph.prototype.warpSierpinski=function(t,e){this.warpOp("sierpinski",[t,e])},PenMorph.prototype.sierpinski=function(t,e){var o;if(e<t)for(o=0;o<3;o+=1)this.sierpinski(.5*t,e),this.turn(120),this.forward(t)},PenMorph.prototype.warpTree=function(t,e,o){this.warpOp("tree",[t,e,o])},PenMorph.prototype.tree=function(t,e,o){0<t&&(this.size=t,this.forward(e),this.turn(o),this.tree(t-1,.75*e,o),this.turn(-2*o),this.tree(t-1,.75*e,o),this.turn(o),this.forward(-e))},ColorPaletteMorph.prototype=new Morph,ColorPaletteMorph.prototype.constructor=ColorPaletteMorph,ColorPaletteMorph.uber=Morph.prototype,ColorPaletteMorph.prototype.init=function(t,e){ColorPaletteMorph.uber.init.call(this),this.target=t,this.targetSetter="color",this.silentSetExtent(e),this.choice=null,this.drawNew()},ColorPaletteMorph.prototype.drawNew=function(){var t,e,o,i,r,n;for(e=this.extent(),this.image=newCanvas(this.extent()),t=this.image.getContext("2d"),this.choice=new Color,o=0;o<=e.x;o+=1)for(r=360*o/e.x,i=0;i<=e.y;i+=1)n=100-i/e.y*100,t.fillStyle="hsl("+r+",100%,"+n+"%)",t.fillRect(o,i,1,1)},ColorPaletteMorph.prototype.mouseMove=function(t){this.choice=this.getPixelColor(t),this.updateTarget()},ColorPaletteMorph.prototype.mouseDownLeft=function(t){this.choice=this.getPixelColor(t),this.updateTarget()},ColorPaletteMorph.prototype.updateTarget=function(){this.target instanceof Morph&&null!==this.choice&&(this.target[this.targetSetter]instanceof Function?this.target[this.targetSetter](this.choice):(this.target[this.targetSetter]=this.choice,this.target.drawNew(),this.target.changed()))},ColorPaletteMorph.prototype.developersMenu=function(){var t=ColorPaletteMorph.uber.developersMenu.call(this);return t.addLine(),t.addItem("set target","setTarget","choose another morph\nwhose color property\n will be controlled by this one"),t},ColorPaletteMorph.prototype.setTarget=function(){var t=this.overlappedMorphs(),e=new MenuMorph(this,"choose target:"),o=this;t.push(this.world()),t.forEach(function(t){e.addItem(t.toString().slice(0,50),function(){o.target=t,o.setTargetSetter()})}),1===t.length?(this.target=t[0],this.setTargetSetter()):0<t.length&&e.popUpAtHand(this.world())},ColorPaletteMorph.prototype.setTargetSetter=function(){var t=this.target.colorSetters(),e=new MenuMorph(this,"choose target property:"),o=this;t.forEach(function(t){e.addItem(t,function(){o.targetSetter=t})}),1===t.length?this.targetSetter=t[0]:0<t.length&&e.popUpAtHand(this.world())},GrayPaletteMorph.prototype=new ColorPaletteMorph,GrayPaletteMorph.prototype.constructor=GrayPaletteMorph,GrayPaletteMorph.uber=ColorPaletteMorph.prototype,GrayPaletteMorph.prototype.drawNew=function(){var t,e,o;e=this.extent(),this.image=newCanvas(this.extent()),t=this.image.getContext("2d"),this.choice=new Color,(o=t.createLinearGradient(0,0,e.x,e.y)).addColorStop(0,"black"),o.addColorStop(1,"white"),t.fillStyle=o,t.fillRect(0,0,e.x,e.y)},ColorPickerMorph.prototype=new Morph,ColorPickerMorph.prototype.constructor=ColorPickerMorph,ColorPickerMorph.uber=Morph.prototype,ColorPickerMorph.prototype.init=function(t){this.choice=t,ColorPickerMorph.uber.init.call(this),this.color=new Color(255,255,255),this.silentSetExtent(new Point(80,80)),this.drawNew()},ColorPickerMorph.prototype.drawNew=function(){ColorPickerMorph.uber.drawNew.call(this),this.buildSubmorphs()},ColorPickerMorph.prototype.buildSubmorphs=function(){var t,e,o,i;this.children.forEach(function(t){t.destroy()}),this.children=[],this.feedback=new Morph,this.feedback.color=this.choice,this.feedback.setExtent(new Point(20,20)),t=new ColorPaletteMorph(this.feedback,new Point(this.width(),50)),e=new GrayPaletteMorph(this.feedback,new Point(this.width(),5)),t.setPosition(this.bounds.origin),this.add(t),e.setPosition(t.bottomLeft()),this.add(e),o=e.left()+Math.floor((e.width()-this.feedback.width())/2),i=e.bottom()+Math.floor((this.bottom()-e.bottom()-this.feedback.height())/2),this.feedback.setPosition(new Point(o,i)),this.add(this.feedback)},ColorPickerMorph.prototype.getChoice=function(){return this.feedback.color},ColorPickerMorph.prototype.rootForGrab=function(){return this},BlinkerMorph.prototype=new Morph,BlinkerMorph.prototype.constructor=BlinkerMorph,BlinkerMorph.uber=Morph.prototype,BlinkerMorph.prototype.init=function(t){BlinkerMorph.uber.init.call(this),this.color=new Color(0,0,0),this.fps=t||2,this.drawNew()},BlinkerMorph.prototype.step=function(){this.toggleVisibility()},CursorMorph.prototype=new BlinkerMorph,CursorMorph.prototype.constructor=CursorMorph,CursorMorph.uber=BlinkerMorph.prototype,CursorMorph.prototype.viewPadding=1,CursorMorph.prototype.init=function(t){var e;this.keyDownEventUsed=!1,this.target=t,this.originalContents=this.target.text,this.originalAlignment=this.target.alignment,this.slot=this.target.text.length,CursorMorph.uber.init.call(this),e=fontHeight(this.target.fontSize),this.setExtent(new Point(Math.max(Math.floor(e/20),1),e)),this.drawNew(),this.image.getContext("2d").font=this.target.font(),this.target instanceof TextMorph&&"left"!==this.target.alignment&&this.target.setAlignmentToLeft(),this.gotoSlot(this.slot),this.initializeClipboardHandler()},CursorMorph.prototype.initializeClipboardHandler=function(){var e=this,o=this.target.world();this.clipboardHandler=document.createElement("textarea"),this.clipboardHandler.style.position="absolute",this.clipboardHandler.style.right="101%",document.body.appendChild(this.clipboardHandler),this.clipboardHandler.value=this.target.selection(),this.clipboardHandler.focus(),this.clipboardHandler.select(),this.clipboardHandler.addEventListener("keypress",function(t){e.processKeyPress(t),this.value=e.target.selection(),this.select()},!1),this.clipboardHandler.addEventListener("keydown",function(t){e.processKeyDown(t),t.shiftKey&&(o.currentKey=16),this.value=e.target.selection(),this.select(),"U+0009"!==t.key&&"Tab"!==t.key||(e.processKeyPress(t),t.preventDefault())},!1),this.clipboardHandler.addEventListener("keyup",function(t){o.currentKey=null},!1),this.clipboardHandler.addEventListener("input",function(t){""===this.value&&(e.gotoSlot(e.target.selectionStartSlot()),e.target.deleteSelection())},!1)},CursorMorph.prototype.processKeyPress=function(t){return this.keyDownEventUsed?(this.keyDownEventUsed=!1,null):40===t.keyCode||40===t.charCode?(this.insert("("),null):37===t.keyCode||37===t.charCode?(this.insert("%"),null):(t.keyCode?t.ctrlKey&&!t.altKey?this.ctrl(t.keyCode,t.shiftKey):t.metaKey?this.cmd(t.keyCode,t.shiftKey):this.insert(String.fromCharCode(t.keyCode),t.shiftKey):t.charCode&&(t.ctrlKey&&!t.altKey?this.ctrl(t.charCode,t.shiftKey):t.metaKey?this.cmd(t.charCode,t.shiftKey):this.insert(String.fromCharCode(t.charCode),t.shiftKey)),void this.target.escalateEvent("reactToKeystroke",t))},CursorMorph.prototype.processKeyDown=function(t){var e=t.shiftKey,o=t.ctrlKey||t.altKey,i=0<this.target.selection().length;switch(this.keyDownEventUsed=!1,t.ctrlKey&&!t.altKey&&(this.ctrl(t.keyCode,t.shiftKey),this.target.escalateEvent("reactToKeystroke",t)),t.metaKey&&(this.cmd(t.keyCode,t.shiftKey),this.target.escalateEvent("reactToKeystroke",t)),t.keyCode){case 37:!i||e||o?this.goLeft(e,o?this.slot-this.target.previousWordFrom(this.slot):1):(this.gotoSlot(Math.min(this.target.startMark,this.target.endMark)),this.target.clearSelection()),this.keyDownEventUsed=!0;break;case 39:!i||e||o?this.goRight(e,o?this.target.nextWordFrom(this.slot)-this.slot:1):(this.gotoSlot(Math.max(this.target.startMark,this.target.endMark)),this.target.clearSelection()),this.keyDownEventUsed=!0;break;case 38:this.goUp(e),this.keyDownEventUsed=!0;break;case 40:this.goDown(e),this.keyDownEventUsed=!0;break;case 36:this.goHome(e),this.keyDownEventUsed=!0;break;case 35:this.goEnd(e),this.keyDownEventUsed=!0;break;case 46:this.deleteRight(),this.keyDownEventUsed=!0;break;case 8:this.deleteLeft(),this.keyDownEventUsed=!0;break;case 13:this.target instanceof StringMorph||e?this.accept():this.insert("\n"),this.keyDownEventUsed=!0;break;case 27:this.cancel(),this.keyDownEventUsed=!0;break;default:nop()}this.target.escalateEvent("reactToKeystroke",t)},CursorMorph.prototype.gotoSlot=function(t){var e,o,i=this.target.text.length,r=this.target.slotPosition(t);this.slot=t<0?0:i<t?i:t,this.parent&&this.target.isScrollable&&(e=this.parent.right()-this.viewPadding,o=this.parent.left()+this.viewPadding,r.x>e&&(this.target.setLeft(this.target.left()+e-r.x),r.x=e),r.x<o&&(o=Math.min(this.parent.left(),o),this.target.setLeft(this.target.left()+o-r.x),r.x=o),this.target.right()<e&&e-this.target.width()<o&&(r.x+=e-this.target.right(),this.target.setRight(e))),this.show(),this.setPosition(r),this.parent&&this.parent.parent instanceof ScrollFrameMorph&&this.target.isScrollable&&this.parent.parent.scrollCursorIntoView(this)},CursorMorph.prototype.goLeft=function(t,e){this.updateSelection(t),this.gotoSlot(this.slot-(e||1)),this.updateSelection(t)},CursorMorph.prototype.goRight=function(t,e){this.updateSelection(t),this.gotoSlot(this.slot+(e||1)),this.updateSelection(t)},CursorMorph.prototype.goUp=function(t){this.updateSelection(t),this.gotoSlot(this.target.upFrom(this.slot)),this.updateSelection(t)},CursorMorph.prototype.goDown=function(t){this.updateSelection(t),this.gotoSlot(this.target.downFrom(this.slot)),this.updateSelection(t)},CursorMorph.prototype.goHome=function(t){this.updateSelection(t),this.gotoSlot(this.target.startOfLine(this.slot)),this.updateSelection(t)},CursorMorph.prototype.goEnd=function(t){this.updateSelection(t),this.gotoSlot(this.target.endOfLine(this.slot)),this.updateSelection(t)},CursorMorph.prototype.gotoPos=function(t){this.gotoSlot(this.target.slotAt(t)),this.show()},CursorMorph.prototype.updateSelection=function(t){t?isNil(this.target.endMark)&&isNil(this.target.startMark)?(this.target.startMark=this.slot,this.target.endMark=this.slot):this.target.endMark!==this.slot&&(this.target.endMark=this.slot,this.target.drawNew(),this.target.changed()):this.target.clearSelection()},CursorMorph.prototype.accept=function(){var t=this.root();t&&t.stopEditing(),this.escalateEvent("accept",this)},CursorMorph.prototype.cancel=function(){var t=this.root();this.undo(),t&&t.stopEditing(),this.escalateEvent("cancel",this)},CursorMorph.prototype.undo=function(){this.target.text=this.originalContents,this.target.changed(),this.target.drawNew(),this.target.changed(),this.gotoSlot(0)},CursorMorph.prototype.insert=function(t,e){var o;if("\t"===t)return this.target.escalateEvent("reactToEdit",this.target),e?this.target.backTab(this.target):this.target.tab(this.target);this.target.isNumeric&&isNaN(parseFloat(t))&&!contains(["-","."],t)||(""!==this.target.selection()&&(this.gotoSlot(this.target.selectionStartSlot()),this.target.deleteSelection()),o=(o=this.target.text).slice(0,this.slot)+t+o.slice(this.slot),this.target.text=o,this.target.drawNew(),this.target.changed(),this.goRight(!1,t.length))},CursorMorph.prototype.ctrl=function(t,e){64===t||65===t&&e?this.insert("@"):65===t?this.target.selectAll():90===t?this.undo():123===t?this.insert("{"):125===t?this.insert("}"):91===t?this.insert("["):93===t?this.insert("]"):isNil(this.target.receiver)||(68===t?this.target.doIt():73===t?this.target.inspectIt():80===t&&this.target.showIt())},CursorMorph.prototype.cmd=function(t,e){64===t||65===t&&e?this.insert("@"):65===t?this.target.selectAll():90===t?this.undo():isNil(this.target.receiver)||(68===t?this.target.doIt():73===t?this.target.inspectIt():80===t&&this.target.showIt())},CursorMorph.prototype.deleteRight=function(){var t;""!==this.target.selection()?(this.gotoSlot(this.target.selectionStartSlot()),this.target.deleteSelection()):(t=this.target.text,this.target.changed(),t=t.slice(0,this.slot)+t.slice(this.slot+1),this.target.text=t,this.target.drawNew())},CursorMorph.prototype.deleteLeft=function(){var t;if(this.target.selection())return this.gotoSlot(this.target.selectionStartSlot()),this.target.deleteSelection();t=this.target.text,this.target.changed(),this.target.text=t.substring(0,this.slot-1)+t.substr(this.slot),this.target.drawNew(),this.goLeft()},CursorMorph.prototype.destroy=function(){this.target.alignment!==this.originalAlignment&&(this.target.alignment=this.originalAlignment,this.target.drawNew(),this.target.changed()),this.destroyClipboardHandler(),CursorMorph.uber.destroy.call(this)},CursorMorph.prototype.destroyClipboardHandler=function(){var t,e=document.body.children;if(this.clipboardHandler)for(t=0;t<e.length;t+=1)e[t]===this.clipboardHandler&&(document.body.removeChild(this.clipboardHandler),this.clipboardHandler=null)},CursorMorph.prototype.inspectKeyEvent=function(t){this.inform("Key pressed: "+String.fromCharCode(t.charCode)+"\n------------------------\ncharCode: "+t.charCode.toString()+"\nkeyCode: "+t.keyCode.toString()+"\nshiftKey: "+t.shiftKey.toString()+"\naltKey: "+t.altKey.toString()+"\nctrlKey: "+t.ctrlKey.toString()+"\ncmdKey: "+t.metaKey.toString())},BoxMorph.prototype=new Morph,BoxMorph.prototype.constructor=BoxMorph,BoxMorph.uber=Morph.prototype,BoxMorph.prototype.init=function(t,e,o){this.edge=t||4,this.border=e||(0===e?0:2),this.borderColor=o||new Color,BoxMorph.uber.init.call(this)},BoxMorph.prototype.drawNew=function(){var t;if(this.image=newCanvas(this.extent()),t=this.image.getContext("2d"),0===this.edge&&0===this.border)return BoxMorph.uber.drawNew.call(this),null;t.fillStyle=this.color.toString(),t.beginPath(),this.outlinePath(t,Math.max(this.edge-this.border,0),this.border),t.closePath(),t.fill(),0<this.border&&(t.lineWidth=this.border,t.strokeStyle=this.borderColor.toString(),t.beginPath(),this.outlinePath(t,this.edge,this.border/2),t.closePath(),t.stroke())},BoxMorph.prototype.outlinePath=function(t,e,o){var i=e+o,r=this.width(),n=this.height();t.arc(i,i,e,radians(-180),radians(-90),!1),t.arc(r-i,i,e,radians(-90),radians(-0),!1),t.arc(r-i,n-i,e,radians(0),radians(90),!1),t.arc(i,n-i,e,radians(90),radians(180),!1)},BoxMorph.prototype.developersMenu=function(){var t=BoxMorph.uber.developersMenu.call(this);return t.addLine(),t.addItem("border width...",function(){this.prompt(t.title+"\nborder\nwidth:",this.setBorderWidth,this,this.border.toString(),null,0,100,!0)},"set the border's\nline size"),t.addItem("border color...",function(){this.pickColor(t.title+"\nborder color:",this.setBorderColor,this,this.borderColor)},"set the border's\nline color"),t.addItem("corner size...",function(){this.prompt(t.title+"\ncorner\nsize:",this.setCornerSize,this,this.edge.toString(),null,0,100,!0)},"set the corner's\nradius"),t},BoxMorph.prototype.setBorderWidth=function(t){var e;"number"==typeof t?this.border=Math.max(t,0):(e=parseFloat(t),isNaN(e)||(this.border=Math.max(e,0))),this.drawNew(),this.changed()},BoxMorph.prototype.setBorderColor=function(t){t&&(this.borderColor=t,this.drawNew(),this.changed())},BoxMorph.prototype.setCornerSize=function(t){var e;"number"==typeof t?this.edge=Math.max(t,0):(e=parseFloat(t),isNaN(e)||(this.edge=Math.max(e,0))),this.drawNew(),this.changed()},BoxMorph.prototype.colorSetters=function(){return["color","borderColor"]},BoxMorph.prototype.numericalSetters=function(){var t=BoxMorph.uber.numericalSetters.call(this);return t.push("setBorderWidth","setCornerSize"),t},SpeechBubbleMorph.prototype=new BoxMorph,SpeechBubbleMorph.prototype.constructor=SpeechBubbleMorph,SpeechBubbleMorph.uber=BoxMorph.prototype,SpeechBubbleMorph.prototype.init=function(t,e,o,i,r,n,s){this.isPointingRight=!0,this.contents=t||"",this.padding=n||0,this.isThought=s||!1,this.isClickable=!1,SpeechBubbleMorph.uber.init.call(this,o||6,i||(0===i?0:1),r||new Color(140,140,140)),this.color=e||new Color(230,230,230),this.drawNew()},SpeechBubbleMorph.prototype.popUp=function(t,e,o){this.drawNew(),this.setPosition(e.subtract(new Point(0,this.height()))),this.addShadow(new Point(2,2),80),this.keepWithin(t),t.add(this),this.fullChanged(),t.hand.destroyTemporaries(),t.hand.temporaries.push(this),o?this.isClickable=!0:this.mouseEnter=function(){this.destroy()}},SpeechBubbleMorph.prototype.drawNew=function(){this.contentsMorph&&this.contentsMorph.destroy(),this.contents instanceof Morph?this.contentsMorph=this.contents:isString(this.contents)?this.contentsMorph=new TextMorph(this.contents,MorphicPreferences.bubbleHelpFontSize,null,!1,!0,"center"):this.contents instanceof HTMLCanvasElement?(this.contentsMorph=new Morph,this.contentsMorph.silentSetWidth(this.contents.width),this.contentsMorph.silentSetHeight(this.contents.height),this.contentsMorph.image=this.contents):this.contentsMorph=new TextMorph(this.contents.toString(),MorphicPreferences.bubbleHelpFontSize,null,!1,!0,"center"),this.add(this.contentsMorph),this.silentSetWidth(this.contentsMorph.width()+(this.padding?2*this.padding:2*this.edge)),this.silentSetHeight(this.contentsMorph.height()+this.edge+2*this.border+2*this.padding+2),SpeechBubbleMorph.uber.drawNew.call(this),this.contentsMorph.setPosition(this.position().add(new Point(this.padding||this.edge,this.border+this.padding+1)))},SpeechBubbleMorph.prototype.outlinePath=function(i,t,e){var o,r=t+e,n=this.width(),s=this.height();function a(t,e,o){i.moveTo(t+o,e),i.arc(t,e,o,radians(0),radians(360))}i.arc(r,r,t,radians(-180),radians(-90),!1),i.arc(n-r,r,t,radians(-90),radians(-0),!1),i.arc(n-r,s-r-t,t,radians(0),radians(90),!1),this.isThought||(this.isPointingRight?(i.lineTo(r+t,s-r),i.lineTo(t/2+e,s-e)):(i.lineTo(n-(t/2+e),s-e),i.lineTo(n-(r+t),s-r))),i.arc(r,s-r-t,t,radians(90),radians(180),!1),this.isThought&&(i.lineTo(e,r),this.isPointingRight?(a((o=t/4)+e,s-o-e,o),a(2*(o=t/3.2)+e,s-o-2*e,o),a(3*(o=t/2.8)+2*e,s-o-4*e,o)):(a(n-((o=t/4)+e),s-o-e,o),a(n-(2*(o=t/3.2)+e),s-o-2*e,o),a(n-(3*(o=t/2.8)+2*e),s-o-4*e,o)))},SpeechBubbleMorph.prototype.shadowImage=function(t,e){var o,i,r,n,s,a=t||new Point(7,7),h=e||new Color(0,0,0);return o=this.extent(),i=this.image,(s=(r=newCanvas(o)).getContext("2d")).drawImage(i,0,0),s.globalCompositeOperation="destination-out",s.drawImage(i,-a.x,-a.y),(s=(n=newCanvas(o)).getContext("2d")).drawImage(r,0,0),s.globalCompositeOperation="source-atop",s.fillStyle=h.toString(),s.fillRect(0,0,o.x,o.y),n},SpeechBubbleMorph.prototype.shadowImageBlurred=function(t,e){var o,i,r,n,s=t||new Point(7,7),a=this.shadowBlur,h=e||new Color(0,0,0);return o=this.extent().add(2*a),i=this.image,(n=(r=newCanvas(o)).getContext("2d")).shadowOffsetX=s.x,n.shadowOffsetY=s.y,n.shadowBlur=a,n.shadowColor=h.toString(),n.drawImage(i,a-s.x,a-s.y),n.shadowOffsetX=0,n.shadowOffsetY=0,n.shadowBlur=0,n.globalCompositeOperation="destination-out",n.drawImage(i,a-s.x,a-s.y),r},SpeechBubbleMorph.prototype.fixLayout=function(){this.removeShadow(),this.drawNew(),this.addShadow(new Point(2,2),80)},CircleBoxMorph.prototype=new Morph,CircleBoxMorph.prototype.constructor=CircleBoxMorph,CircleBoxMorph.uber=Morph.prototype,CircleBoxMorph.prototype.init=function(t){CircleBoxMorph.uber.init.call(this),this.orientation=t,this.autoOrient=!0,this.setExtent(new Point(20,100))},CircleBoxMorph.prototype.autoOrientation=function(){this.height()>this.width()?this.orientation="vertical":this.orientation="horizontal"},CircleBoxMorph.prototype.drawNew=function(){var e,t,o,i,r,n,s,a,h=this;this.autoOrient&&this.autoOrientation(),this.image=newCanvas(this.extent()),s=this.image.getContext("2d"),i="vertical"===this.orientation?(e=this.width()/2,t=new Point(r=this.center().x,this.top()+e),o=new Point(r,this.bottom()-e),this.bounds.origin.add(new Point(0,e)).corner(this.bounds.corner.subtract(new Point(0,e)))):(e=this.height()/2,n=this.center().y,t=new Point(this.left()+e,n),o=new Point(this.right()-e,n),this.bounds.origin.add(new Point(e,0)).corner(this.bounds.corner.subtract(new Point(e,0)))),[t.subtract(this.bounds.origin),o.subtract(this.bounds.origin)].forEach(function(t){s.fillStyle=h.color.toString(),s.beginPath(),s.arc(t.x,t.y,e,0,2*Math.PI,!1),s.closePath(),s.fill()}),0<(a=(i=i.translateBy(this.bounds.origin.neg())).extent()).x&&0<a.y&&s.fillRect(i.origin.x,i.origin.y,i.width(),i.height())},CircleBoxMorph.prototype.developersMenu=function(){var t=CircleBoxMorph.uber.developersMenu.call(this);return t.addLine(),"vertical"===this.orientation?t.addItem("horizontal...","toggleOrientation","toggle the\norientation"):t.addItem("vertical...","toggleOrientation","toggle the\norientation"),t},CircleBoxMorph.prototype.toggleOrientation=function(){var t=this.center();this.changed(),"vertical"===this.orientation?this.orientation="horizontal":this.orientation="vertical",this.silentSetExtent(new Point(this.height(),this.width())),this.setCenter(t),this.drawNew(),this.changed()},SliderButtonMorph.prototype=new CircleBoxMorph,SliderButtonMorph.prototype.constructor=SliderButtonMorph,SliderButtonMorph.uber=CircleBoxMorph.prototype,SliderButtonMorph.prototype.init=function(t){this.color=new Color(80,80,80),this.highlightColor=new Color(90,90,140),this.pressColor=new Color(80,80,160),this.is3D=!1,this.hasMiddleDip=!0,SliderButtonMorph.uber.init.call(this,t)},SliderButtonMorph.prototype.autoOrientation=nop,SliderButtonMorph.prototype.drawNew=function(){var t=this.color.copy();SliderButtonMorph.uber.drawNew.call(this),!this.is3D&&MorphicPreferences.isFlat||this.drawEdges(),this.normalImage=this.image,this.color=this.highlightColor.copy(),SliderButtonMorph.uber.drawNew.call(this),!this.is3D&&MorphicPreferences.isFlat||this.drawEdges(),this.highlightImage=this.image,this.color=this.pressColor.copy(),SliderButtonMorph.uber.drawNew.call(this),!this.is3D&&MorphicPreferences.isFlat||this.drawEdges(),this.pressImage=this.image,this.color=t,this.image=this.normalImage},SliderButtonMorph.prototype.drawEdges=function(){var t,e,o=this.image.getContext("2d"),i=this.width(),r=this.height();o.lineJoin="round",o.lineCap="round","vertical"===this.orientation?(o.lineWidth=i/3,(t=o.createLinearGradient(0,0,o.lineWidth,0)).addColorStop(0,"white"),t.addColorStop(1,this.color.toString()),o.strokeStyle=t,o.beginPath(),o.moveTo(.5*o.lineWidth,i/2),o.lineTo(.5*o.lineWidth,r-i/2),o.stroke(),(t=o.createLinearGradient(i-o.lineWidth,0,i,0)).addColorStop(0,this.color.toString()),t.addColorStop(1,"black"),o.strokeStyle=t,o.beginPath(),o.moveTo(i-.5*o.lineWidth,i/2),o.lineTo(i-.5*o.lineWidth,r-i/2),o.stroke(),this.hasMiddleDip&&(e=i/4,(t=o.createLinearGradient(o.lineWidth,0,i-o.lineWidth,0)).addColorStop(0,"black"),t.addColorStop(.35,this.color.toString()),t.addColorStop(.65,this.color.toString()),t.addColorStop(1,"white"),o.fillStyle=t,o.beginPath(),o.arc(i/2,r/2,e,radians(0),radians(360),!1),o.closePath(),o.fill())):"horizontal"===this.orientation&&(o.lineWidth=r/3,(t=o.createLinearGradient(0,0,0,o.lineWidth)).addColorStop(0,"white"),t.addColorStop(1,this.color.toString()),o.strokeStyle=t,o.beginPath(),o.moveTo(r/2,.5*o.lineWidth),o.lineTo(i-r/2,.5*o.lineWidth),o.stroke(),(t=o.createLinearGradient(0,r-o.lineWidth,0,r)).addColorStop(0,this.color.toString()),t.addColorStop(1,"black"),o.strokeStyle=t,o.beginPath(),o.moveTo(r/2,r-.5*o.lineWidth),o.lineTo(i-r/2,r-.5*o.lineWidth),o.stroke(),this.hasMiddleDip&&(e=r/4,(t=o.createLinearGradient(0,o.lineWidth,0,r-o.lineWidth)).addColorStop(0,"black"),t.addColorStop(.35,this.color.toString()),t.addColorStop(.65,this.color.toString()),t.addColorStop(1,"white"),o.fillStyle=t,o.beginPath(),o.arc(this.width()/2,this.height()/2,e,radians(0),radians(360),!1),o.closePath(),o.fill()))},SliderButtonMorph.prototype.mouseEnter=function(){this.image=this.highlightImage,this.changed()},SliderButtonMorph.prototype.mouseLeave=function(){this.image=this.normalImage,this.changed()},SliderButtonMorph.prototype.mouseDownLeft=function(t){this.image=this.pressImage,this.changed(),this.escalateEvent("mouseDownLeft",t)},SliderButtonMorph.prototype.mouseClickLeft=function(){this.image=this.highlightImage,this.changed()},SliderButtonMorph.prototype.mouseMove=function(){nop()},SliderMorph.prototype=new CircleBoxMorph,SliderMorph.prototype.constructor=SliderMorph,SliderMorph.uber=CircleBoxMorph.prototype,SliderMorph.prototype.init=function(t,e,o,i,r,n){this.target=null,this.action=null,this.start=t,this.stop=e,this.value=o,this.size=i,this.offset=null,this.button=new SliderButtonMorph,this.button.isDraggable=!1,this.button.color=new Color(200,200,200),this.button.highlightColor=new Color(210,210,255),this.button.pressColor=new Color(180,180,255),this.tickMarks=[],SliderMorph.uber.init.call(this,r),this.add(this.button),this.alpha=.3,this.color=n||new Color(0,0,0),this.setExtent(new Point(20,100))},SliderMorph.prototype.autoOrientation=nop,SliderMorph.prototype.rangeSize=function(){return this.stop-this.start},SliderMorph.prototype.ratio=function(){return this.size/(this.rangeSize()+1)},SliderMorph.prototype.unitSize=function(t){return"vertical"===this.orientation?(t=t||this.button.height(),(this.height()-t)/this.rangeSize()):(t=t||this.button.width(),(this.width()-t)/this.rangeSize())},SliderMorph.prototype.drawNew=function(){var t,e,o,i,r,n;SliderMorph.uber.drawNew.call(this),this.button.orientation=this.orientation,"vertical"===this.orientation?(t=this.width()-2,e=Math.max(t,Math.round(this.height()*this.ratio())),this.button.silentSetExtent(new Point(t,e)),o=1,i=Math.min(Math.round((this.value-this.start)*this.unitSize()),this.height()-this.button.height())):(e=this.height()-2,t=Math.max(e,Math.round(this.width()*this.ratio())),this.button.silentSetExtent(new Point(t,e)),i=1,o=Math.min(Math.round((this.value-this.start)*this.unitSize()),this.width()-this.button.width())),this.button.setPosition(new Point(o,i).add(this.bounds.origin)),this.button.drawNew(),this.button.changed();for(var s=this.tickMarks.length;s--;)r=this.tickMarks[s],"vertical"===this.orientation?(n=Math.min(Math.round((r.value-this.start)*this.unitSize(r.size)),this.height()-r.size-this.width()/2),n=Math.max(this.width()/2,n),r.setWidth(this.width()),r.setHeight(r.size),r.setPosition(new Point(this.left(),n+this.top()))):(n=Math.min(Math.round((r.value-this.start)*this.unitSize(r.size)),this.width()-r.size-this.height()/2),n=Math.max(this.height()/2,n),r.setWidth(r.size),r.setHeight(this.height()),r.setPosition(new Point(n+this.left(),this.top())))},SliderMorph.prototype.updateValue=function(){var t;t="vertical"===this.orientation?this.button.top()-this.top():this.button.left()-this.left(),this.value=Math.round(t/this.unitSize()+this.start),this.updateTarget()},SliderMorph.prototype.updateTarget=function(){this.action&&("function"==typeof this.action?this.action.call(this.target,this.value):this.target[this.action](this.value))},SliderMorph.prototype.addTick=function(t,e,o){var i=new Morph;return o=o||2,e=e||this.color.darker(),i.value=t,i.color=e,i.size=o,this.addBack(i),this.tickMarks.push(i),i},SliderMorph.prototype.clearTicks=function(){for(var t=this.tickMarks.length;t--;)this.tickMarks[t].destroy();this.tickMarks=[],this.changed()},SliderMorph.prototype.developersMenu=function(){var t=SliderMorph.uber.developersMenu.call(this);return t.addItem("show value...","showValue","display a dialog box\nshowing the selected number"),t.addItem("floor...",function(){this.prompt(t.title+"\nfloor:",this.setStart,this,this.start.toString(),null,0,this.stop-this.size,!0)},"set the minimum value\nwhich can be selected"),t.addItem("ceiling...",function(){this.prompt(t.title+"\nceiling:",this.setStop,this,this.stop.toString(),null,this.start+this.size,100*this.size,!0)},"set the maximum value\nwhich can be selected"),t.addItem("button size...",function(){this.prompt(t.title+"\nbutton size:",this.setSize,this,this.size.toString(),null,1,this.stop-this.start,!0)},"set the range\ncovered by\nthe slider button"),t.addLine(),t.addItem("set target","setTarget","select another morph\nwhose numerical property\nwill be controlled by this one"),t},SliderMorph.prototype.showValue=function(){this.inform(this.value)},SliderMorph.prototype.userSetStart=function(t){this.start=Math.max(t,this.stop)},SliderMorph.prototype.setStart=function(t,e){var o;"number"==typeof t?this.start=Math.min(t,this.stop-this.size):(o=parseFloat(t),isNaN(o)||(this.start=Math.min(o,this.stop-this.size))),this.value=Math.max(this.value,this.start),e||this.updateTarget(),this.drawNew(),this.changed()},SliderMorph.prototype.setStop=function(t,e){var o;"number"==typeof t?this.stop=Math.max(t,this.start+this.size):(o=parseFloat(t),isNaN(o)||(this.stop=Math.max(o,this.start+this.size))),this.value=Math.min(this.value,this.stop),e||this.updateTarget(),this.drawNew(),this.changed()},SliderMorph.prototype.setSize=function(t,e){var o;"number"==typeof t?this.size=Math.min(Math.max(t,1),this.stop-this.start):(o=parseFloat(t),isNaN(o)||(this.size=Math.min(Math.max(o,1),this.stop-this.start))),this.value=Math.min(this.value,this.stop-this.size),e||this.updateTarget(),this.drawNew(),this.changed()},SliderMorph.prototype.setTarget=function(){var t=this.overlappedMorphs(),e=new MenuMorph(this,"choose target:"),o=this;t.push(this.world()),t.forEach(function(t){e.addItem(t.toString().slice(0,50),function(){o.target=t,o.setTargetSetter()})}),1===t.length?(this.target=t[0],this.setTargetSetter()):0<t.length&&e.popUpAtHand(this.world())},SliderMorph.prototype.setTargetSetter=function(){var t=this.target.numericalSetters(),e=new MenuMorph(this,"choose target property:"),o=this;t.forEach(function(t){e.addItem(t,function(){o.action=t})}),1===t.length?this.action=t[0]:0<t.length&&e.popUpAtHand(this.world())},SliderMorph.prototype.numericalSetters=function(){var t=SliderMorph.uber.numericalSetters.call(this);return t.push("setStart","setStop","setSize"),t},SliderMorph.prototype.step=null,SliderMorph.prototype.mouseDownLeft=function(t){var i,r=this;this.button.bounds.containsPoint(t)?this.offset=t.subtract(this.button.bounds.origin):this.offset=new Point,i=this.root(),this.step=function(){var t,e,o;i.hand.mouseButton?(t=i.hand.bounds.origin,"vertical"===r.orientation?(e=r.button.bounds.origin.x,o=Math.max(Math.min(t.y-r.offset.y,r.bottom()-r.button.height()),r.top())):(o=r.button.bounds.origin.y,e=Math.max(Math.min(t.x-r.offset.x,r.right()-r.button.width()),r.left())),r.button.setPosition(new Point(e,o)),r.updateValue()):this.step=null}},MouseSensorMorph.prototype=new BoxMorph,MouseSensorMorph.prototype.constructor=MouseSensorMorph,MouseSensorMorph.uber=BoxMorph.prototype,MouseSensorMorph.prototype.init=function(t,e,o){MouseSensorMorph.uber.init.call(this),this.edge=t||4,this.border=e||2,this.color=new Color(255,255,255),this.borderColor=o||new Color,this.isTouched=!1,this.upStep=.05,this.downStep=.02,this.noticesTransparentClick=!1,this.drawNew()},MouseSensorMorph.prototype.touch=function(){var t=this;this.isTouched||(this.isTouched=!0,this.alpha=.6,this.step=function(){t.isTouched?t.alpha<1&&(t.alpha=t.alpha+t.upStep):t.alpha>t.downStep?t.alpha=t.alpha-t.downStep:(t.alpha=0,t.step=null),t.changed()})},MouseSensorMorph.prototype.unTouch=function(){this.isTouched=!1},MouseSensorMorph.prototype.mouseEnter=function(){this.touch()},MouseSensorMorph.prototype.mouseLeave=function(){this.unTouch()},MouseSensorMorph.prototype.mouseDownLeft=function(){this.touch()},MouseSensorMorph.prototype.mouseClickLeft=function(){this.unTouch()},InspectorMorph.prototype=new BoxMorph,InspectorMorph.prototype.constructor=InspectorMorph,InspectorMorph.uber=BoxMorph.prototype,InspectorMorph.prototype.init=function(t){this.target=t,this.currentProperty=null,this.showing="attributes",this.markOwnProperties=!1,this.hasUserEditedDetails=!1,InspectorMorph.uber.init.call(this),this.silentSetExtent(new Point(20*MorphicPreferences.handleSize,20*MorphicPreferences.handleSize*2/3)),this.isDraggable=!0,this.border=1,this.edge=MorphicPreferences.isFlat?1:5,this.color=new Color(60,60,60),this.borderColor=new Color(95,95,95),this.fps=25,this.drawNew(),this.label=null,this.list=null,this.detail=null,this.work=null,this.buttonInspect=null,this.buttonClose=null,this.buttonSubset=null,this.buttonEdit=null,this.resizer=null,this.target&&this.buildPanes()},InspectorMorph.prototype.setTarget=function(t){this.target=t,this.currentProperty=null,this.buildPanes()},InspectorMorph.prototype.updateCurrentSelection=function(){var t,e,o,i=this.list.selected,r=this.detail.contents.children[0],n=this.root();n&&n.keyboardReceiver instanceof CursorMorph&&n.keyboardReceiver.target===r?this.hasUserEditedDetails=!0:isNil(i)||this.hasUserEditedDetails||(t=this.target[i],e=isNil(this.currentProperty=t)?"NULL":isString(t)?t:t.toString(),r.text!==e&&((o=new TextMorph(e)).isEditable=!0,o.enableSelecting(),o.setReceiver(this.target),this.detail.setContents(o)))},InspectorMorph.prototype.buildPanes=function(){var t,e,o,i,r=[],n=this;for(t in this.children.forEach(function(t){t!==this.work&&t.destroy()}),this.children=[],this.label=new TextMorph(this.target.toString()),this.label.fontSize=MorphicPreferences.menuFontSize,this.label.isBold=!0,this.label.color=new Color(255,255,255),this.label.drawNew(),this.add(this.label),this.target)t&&r.push(t);"attributes"===this.showing?r=r.filter(function(t){return"function"!=typeof n.target[t]}):"methods"===this.showing&&(r=r.filter(function(t){return"function"==typeof n.target[t]})),i=function(){var t,e;isObject(n.currentProperty)&&(t=n.world(),(e=new InspectorMorph(n.currentProperty)).setPosition(t.hand.position()),e.keepWithin(t),t.add(e),e.changed())},this.list=new ListMorph(this.target instanceof Array?r:r.sort(),null,this.markOwnProperties?[[new Color(0,0,180),function(t){return Object.prototype.hasOwnProperty.call(n.target,t)}]]:null,i),this.list.action=function(){n.hasUserEditedDetails=!1,n.updateCurrentSelection()},this.list.hBar.alpha=.6,this.list.vBar.alpha=.6,this.list.contents.step=null,this.add(this.list),this.detail=new ScrollFrameMorph,this.detail.acceptsDrops=!1,this.detail.contents.acceptsDrops=!1,this.detail.isTextLineWrapping=!0,this.detail.color=new Color(255,255,255),this.detail.hBar.alpha=.6,this.detail.vBar.alpha=.6,(e=new TextMorph("")).isEditable=!0,e.enableSelecting(),e.setReceiver(this.target),this.detail.setContents(e),this.add(this.detail),null===this.work&&(this.work=new ScrollFrameMorph,this.work.acceptsDrops=!1,this.work.contents.acceptsDrops=!1,this.work.isTextLineWrapping=!0,this.work.color=new Color(255,255,255),this.work.hBar.alpha=.6,this.work.vBar.alpha=.6,(o=new TextMorph("")).isEditable=!0,o.enableSelecting(),o.setReceiver(this.target),this.work.setContents(o)),this.add(this.work),this.buttonSubset=new TriggerMorph,this.buttonSubset.labelString="show...",this.buttonSubset.action=function(){var t;(t=new MenuMorph).addItem("attributes",function(){n.showing="attributes",n.buildPanes()}),t.addItem("methods",function(){n.showing="methods",n.buildPanes()}),t.addItem("all",function(){n.showing="all",n.buildPanes()}),t.addLine(),t.addItem(n.markOwnProperties?"un-mark own":"mark own",function(){n.markOwnProperties=!n.markOwnProperties,n.buildPanes()},"highlight\n'own' properties"),t.popUpAtHand(n.world())},this.add(this.buttonSubset),this.buttonInspect=new TriggerMorph,this.buttonInspect.labelString="inspect...",this.buttonInspect.action=function(){var t,e,o;isObject(n.currentProperty)?((t=new MenuMorph).addItem("in new inspector...",function(){e=n.world(),(o=new InspectorMorph(n.currentProperty)).setPosition(e.hand.position()),o.keepWithin(e),e.add(o),o.changed()}),t.addItem("here...",function(){n.setTarget(n.currentProperty)}),t.popUpAtHand(n.world())):n.inform((null===n.currentProperty?"null":typeof n.currentProperty)+"\nis not inspectable")},this.add(this.buttonInspect),this.buttonEdit=new TriggerMorph,this.buttonEdit.labelString="edit...",this.buttonEdit.action=function(){var t;(t=new MenuMorph(n)).addItem("save","save","accept changes"),t.addLine(),t.addItem("add property...","addProperty"),t.addItem("rename...","renameProperty"),t.addItem("remove...","removeProperty"),t.popUpAtHand(n.world())},this.add(this.buttonEdit),this.buttonClose=new TriggerMorph,this.buttonClose.labelString="close",this.buttonClose.action=function(){n.destroy()},this.add(this.buttonClose),this.resizer=new HandleMorph(this,150,100,this.edge,this.edge),this.fixLayout()},InspectorMorph.prototype.fixLayout=function(){var t,e,o,i;Morph.prototype.trackChanges=!1,t=this.left()+this.edge,e=this.top()+this.edge,o=this.right()-this.edge-t,this.label.setPosition(new Point(t,e)),this.label.setWidth(o),this.label.height()>this.height()-50&&(this.silentSetHeight(this.label.height()+50),this.drawNew(),this.changed(),this.resizer.drawNew()),e=this.label.bottom()+2,o=Math.min(Math.floor(this.width()/3),this.list.listContents.width()),o-=this.edge,i=this.bottom()-2*this.edge-MorphicPreferences.handleSize-e,this.list.setPosition(new Point(t,e)),this.list.setExtent(new Point(o,i)),t=this.list.right()+this.edge,o=this.right()-this.edge-t,this.detail.setPosition(new Point(t,e)),this.detail.setExtent(new Point(o,2*i/3-this.edge)),e=this.detail.bottom()+this.edge,this.work.setPosition(new Point(t,e)),this.work.setExtent(new Point(o,i/3)),t=this.list.left(),e=this.list.bottom()+this.edge,o=this.list.width(),i=MorphicPreferences.handleSize,this.buttonSubset.setPosition(new Point(t,e)),this.buttonSubset.setExtent(new Point(o,i)),t=this.detail.left(),o=(o=this.detail.width()-this.edge-MorphicPreferences.handleSize)/3-this.edge/3,this.buttonInspect.setPosition(new Point(t,e)),this.buttonInspect.setExtent(new Point(o,i)),t=this.buttonInspect.right()+this.edge,this.buttonEdit.setPosition(new Point(t,e)),this.buttonEdit.setExtent(new Point(o,i)),t=this.buttonEdit.right()+this.edge,o=this.detail.right()-this.edge-MorphicPreferences.handleSize-t,this.buttonClose.setPosition(new Point(t,e)),this.buttonClose.setExtent(new Point(o,i)),Morph.prototype.trackChanges=!0,this.changed()},InspectorMorph.prototype.setExtent=function(t){InspectorMorph.uber.setExtent.call(this,t),this.fixLayout()},InspectorMorph.prototype.save=function(){var t=this.detail.contents.children[0].text.toString(),e=this.list.selected;try{this.target.evaluateString("this."+e+" = "+t),this.hasUserEditedDetails=!1,this.target.drawNew&&(this.target.changed(),this.target.drawNew(),this.target.changed())}catch(t){this.inform(t)}},InspectorMorph.prototype.addProperty=function(){var e=this;this.prompt("new property name:",function(t){t&&(e.target[t]=null,e.buildPanes(),e.target.drawNew&&(e.target.changed(),e.target.drawNew(),e.target.changed()))},this,"property")},InspectorMorph.prototype.renameProperty=function(){var e=this,o=this.list.selected;this.prompt("property name:",function(t){try{delete e.target[o],e.target[t]=e.currentProperty}catch(t){e.inform(t)}e.buildPanes(),e.target.drawNew&&(e.target.changed(),e.target.drawNew(),e.target.changed())},this,o)},InspectorMorph.prototype.removeProperty=function(){var t=this.list.selected;try{delete this.target[t],this.currentProperty=null,this.buildPanes(),this.target.drawNew&&(this.target.changed(),this.target.drawNew(),this.target.changed())}catch(t){this.inform(t)}},InspectorMorph.prototype.step=function(){this.updateCurrentSelection();var t=this.target.toString();this.label.text!==t&&(this.label.text=t,this.label.drawNew(),this.fixLayout())},InspectorMorph.prototype.updateReferences=function(t){var e=this.list.activeIndex();InspectorMorph.uber.updateReferences.call(this,t),this.buildPanes(),this.list.activateIndex(e)},MenuMorph.prototype=new BoxMorph,MenuMorph.prototype.constructor=MenuMorph,MenuMorph.uber=BoxMorph.prototype,MenuMorph.prototype.init=function(t,e,o,i){this.target=t,this.title=e||null,this.environment=o||null,this.fontSize=i||null,this.items=[],this.label=null,this.world=null,this.isListContents=!1,this.hasFocus=!1,this.selection=null,this.submenu=null,MenuMorph.uber.init.call(this),this.isDraggable=!1,this.border=null,this.edge=null},MenuMorph.prototype.addItem=function(t,e,o,i,r,n,s,a){this.items.push([localize(t||"close"),e||nop,o,i,r||!1,n||!1,s,a])},MenuMorph.prototype.addMenu=function(t,e,o){this.addPair(t,e,isNil(o)?"►":o)},MenuMorph.prototype.addPair=function(t,e,o,i){this.addItem(t,e,i,null,null,null,null,o)},MenuMorph.prototype.addLine=function(t){this.items.push([0,t||1])},MenuMorph.prototype.createLabel=function(){var t;null!==this.label&&this.label.destroy(),(t=new TextMorph(localize(this.title),this.fontSize||MorphicPreferences.menuFontSize,MorphicPreferences.menuFontName,!0,!1,"center")).alignment="center",t.color=new Color(255,255,255),t.backgroundColor=this.borderColor,t.drawNew(),this.label=new BoxMorph(3,0),MorphicPreferences.isFlat&&(this.label.edge=0),this.label.color=this.borderColor,this.label.borderColor=this.borderColor,this.label.setExtent(t.extent().add(4)),this.label.drawNew(),this.label.add(t),this.label.text=t},MenuMorph.prototype.drawNew=function(){var e,t,o,i,r=this,n=!1;this.children.forEach(function(t){t.destroy()}),this.children=[],this.isListContents||(this.edge=MorphicPreferences.isFlat?0:5,this.border=MorphicPreferences.isFlat?1:2),this.color=new Color(255,255,255),this.borderColor=new Color(60,60,60),this.silentSetExtent(new Point(0,0)),i=2,o=this.left()+4,this.isListContents||(i=this.title?(this.createLabel(),this.label.setPosition(this.bounds.origin.add(4)),this.add(this.label),this.label.bottom()):this.top()+4),i+=1,this.items.forEach(function(t){n=!1,t instanceof StringFieldMorph||t instanceof ColorPickerMorph||t instanceof SliderMorph?e=t:0===t[0]?(n=!0,(e=new Morph).color=r.borderColor,e.setHeight(t[1])):e=new MenuItemMorph(r.target,t[1],t[0],r.fontSize||MorphicPreferences.menuFontSize,MorphicPreferences.menuFontName,r.environment,t[2],t[3],t[4],t[5],t[6],t[7]),n&&(i+=1),e.setPosition(new Point(o,i)),r.add(e),i+=e.height(),n&&(i+=1)}),t=this.fullBounds(),this.silentSetExtent(t.extent().add(4)),this.adjustWidths(),MenuMorph.uber.drawNew.call(this)},MenuMorph.prototype.maxWidth=function(){var e=0;return this.parent instanceof FrameMorph&&this.parent.scrollFrame instanceof ScrollFrameMorph&&(e=this.parent.scrollFrame.width()),this.children.forEach(function(t){t instanceof MenuItemMorph?e=Math.max(e,t.label.width()+8+(t.shortcut?t.shortcut.width()+4:0)):(t instanceof StringFieldMorph||t instanceof ColorPickerMorph||t instanceof SliderMorph)&&(e=Math.max(e,t.width()))}),this.label&&(e=Math.max(e,this.label.width())),e},MenuMorph.prototype.adjustWidths=function(){var e,o=this.maxWidth(),i=this;this.children.forEach(function(t){t.silentSetWidth(o),t instanceof MenuItemMorph?(t.fixLayout(),e=t.image===t.pressImage,t.createBackgrounds(),e&&(t.image=t.pressImage)):(t.drawNew(),t===i.label&&t.text.setPosition(t.center().subtract(t.text.extent().floorDivideBy(2))))})},MenuMorph.prototype.unselectAllItems=function(){this.children.forEach(function(t){t instanceof MenuItemMorph?t.image=t.normalImage:t instanceof ScrollFrameMorph&&t.contents.children.forEach(function(t){t instanceof MenuItemMorph&&(t.image=t.normalImage)})}),this.changed()},MenuMorph.prototype.popup=function(t,e){var o;this.drawNew(),this.setPosition(e),this.addShadow(new Point(2,2),80),this.keepWithin(t),this.bottom()>t.bottom()&&(this.removeShadow(),o=this.scroll(),this.bounds.corner.y=t.bottom()-2,MenuMorph.uber.drawNew.call(this),this.addShadow(new Point(2,2),80),o.setHeight(t.bottom()-o.top()-6),o.adjustScrollBars()),t.activeMenu&&t.activeMenu.destroy(),this.items.length<1&&!this.title||(t.add(this),(t.activeMenu=this).world=t,this.fullChanged())},MenuMorph.prototype.scroll=function(){var e=new ScrollFrameMorph,t=this.label?1:0,o=this.children[t];return e.setPosition(o.position()),this.children.slice(t).forEach(function(t){e.addContents(t)}),this.add(e),e.setWidth(o.width()),e},MenuMorph.prototype.popUpAtHand=function(t){var e=t||this.world;this.popup(e,e.hand.position())},MenuMorph.prototype.popUpCenteredAtHand=function(t){var e=t||this.world;this.drawNew(),this.popup(e,e.hand.position().subtract(this.extent().floorDivideBy(2)))},MenuMorph.prototype.popUpCenteredInWorld=function(t){var e=t||this.world;this.drawNew(),this.popup(e,e.center().subtract(this.extent().floorDivideBy(2)))},MenuMorph.prototype.closeRootMenu=function(){this.parent instanceof MenuMorph?this.parent.closeRootMenu():this.destroy()},MenuMorph.prototype.closeSubmenu=function(){this.submenu&&(this.submenu.destroy(),this.submenu=null,this.unselectAllItems())},MenuMorph.prototype.getFocus=function(){(this.world.keyboardReceiver=this).selection=null,this.selectFirst(),this.hasFocus=!0},MenuMorph.prototype.processKeyDown=function(t){switch(t.keyCode){case 13:case 32:return void(this.selection&&(this.selection.mouseClickLeft(),this.submenu&&this.submenu.getFocus()));case 27:return this.destroy();case 37:return this.leaveSubmenu();case 38:return this.selectUp();case 39:return this.enterSubmenu();case 40:return this.selectDown();default:nop()}},MenuMorph.prototype.processKeyUp=function(t){nop(t)},MenuMorph.prototype.processKeyPress=function(t){nop(t)},MenuMorph.prototype.selectFirst=function(){var t;for(t=0;t<this.children.length;t+=1)if(this.children[t]instanceof MenuItemMorph)return void this.select(this.children[t])},MenuMorph.prototype.selectUp=function(){var t,e;t=this.children.filter(function(t){return t instanceof MenuItemMorph}),this.selection?((e=t.indexOf(this.selection)-1)<0&&(e=t.length-1),this.select(t[e])):t.length&&this.select(t[0])},MenuMorph.prototype.selectDown=function(){var t,e;t=this.children.filter(function(t){return t instanceof MenuItemMorph}),this.selection?((e=t.indexOf(this.selection)+1)>=t.length&&(e=0),this.select(t[e])):t.length&&this.select(t[0])},MenuMorph.prototype.enterSubmenu=function(){this.selection&&this.selection.action instanceof MenuMorph&&(this.selection.popUpSubmenu(),this.submenu&&this.submenu.getFocus())},MenuMorph.prototype.leaveSubmenu=function(){var t=this.parent;this.parent instanceof MenuMorph&&(t.submenu=null,t.hasFocus=!0,this.destroy(),t.world.keyboardReceiver=t)},MenuMorph.prototype.select=function(t){this.unselectAllItems(),t.image=t.highlightImage,t.changed(),this.selection=t},MenuMorph.prototype.destroy=function(){this.hasFocus&&(this.world.keyboardReceiver=null),MenuMorph.uber.destroy.call(this)},StringMorph.prototype=new Morph,StringMorph.prototype.constructor=StringMorph,StringMorph.uber=Morph.prototype,StringMorph.prototype.init=function(t,e,o,i,r,n,s,a,h,l){this.text=t||(""===t?"":"StringMorph"),this.fontSize=e||12,this.fontName=l||MorphicPreferences.globalFontFamily,this.fontStyle=o||"sans-serif",this.isBold=i||!1,this.isItalic=r||!1,this.isEditable=!1,this.isNumeric=n||!1,this.isPassword=!1,this.shadowOffset=s||new Point(0,0),this.shadowColor=a||null,this.isShowingBlanks=!1,this.blanksColor=new Color(180,140,140),this.isScrollable=!0,this.currentlySelecting=!1,this.startMark=0,this.endMark=0,this.markedTextColor=new Color(255,255,255),this.markedBackgoundColor=new Color(60,60,120),StringMorph.uber.init.call(this,!0),this.color=h||new Color(0,0,0),this.noticesTransparentClick=!0,this.drawNew()},StringMorph.prototype.toString=function(){return"a "+(this.constructor.name||this.constructor.toString().split(" ")[1].split("(")[0])+'("'+this.text.slice(0,30)+'...")'},StringMorph.prototype.password=function(t,e){var o,i="";for(o=0;o<e;o+=1)i+=t;return i},StringMorph.prototype.font=function(){var t="";return this.isBold&&(t+="bold "),this.isItalic&&(t+="italic "),t+this.fontSize+"px "+(this.fontName?this.fontName+", ":"")+this.fontStyle},StringMorph.prototype.drawNew=function(){var t,e,o,i,r,n,s,a,h,l=this.shadowOffset||new Point,p=this.isPassword?this.password("*",this.text.length):this.text;for(this.image=newCanvas(),(t=this.image.getContext("2d")).font=this.font(),e=Math.max(t.measureText(p).width+Math.abs(l.x),1),this.bounds.corner=this.bounds.origin.add(new Point(e,fontHeight(this.fontSize)+Math.abs(l.y))),this.image.width=e,this.image.height=this.height(),t.font=this.font(),t.textAlign="left",t.textBaseline="bottom",this.shadowColor&&(a=Math.max(l.x,0),h=Math.max(l.y,0),t.fillStyle=this.shadowColor.toString(),t.fillText(p,a,fontHeight(this.fontSize)+h)),a=Math.abs(Math.min(l.x,0)),h=Math.abs(Math.min(l.y,0)),t.fillStyle=this.color.toString(),this.isShowingBlanks?this.renderWithBlanks(t,a,fontHeight(this.fontSize)+h):t.fillText(p,a,fontHeight(this.fontSize)+h),o=Math.min(this.startMark,this.endMark),i=Math.max(this.startMark,this.endMark),r=o;r<i;r+=1)n=this.slotPosition(r).subtract(this.position()),s=p.charAt(r),t.fillStyle=this.markedBackgoundColor.toString(),t.fillRect(n.x,n.y,t.measureText(s).width+1+a,fontHeight(this.fontSize)+h),t.fillStyle=this.markedTextColor.toString(),t.fillText(s,n.x+a,fontHeight(this.fontSize)+h);this.parent&&this.parent.fixLayout&&this.parent.fixLayout()},StringMorph.prototype.renderWithBlanks=function(e,t,o){var i=e.measureText(" ").width,r=newCanvas(new Point(i,this.height())),n=r.getContext("2d"),s=this.text.split(" "),a=t||0,h=!0;n.fillStyle=this.blanksColor.toString(),n.arc(i/2,r.height/2,i/2,radians(0),radians(360)),n.fill(),s.forEach(function(t){h||(e.drawImage(r,a,0),a+=i),h=!1,""!==t&&(e.fillText(t,a,o),a+=e.measureText(t).width)})},StringMorph.prototype.slotPosition=function(t){var e,o,i=this.isPassword?this.password("*",this.text.length):this.text,r=Math.min(Math.max(t,0),i.length),n=this.image.getContext("2d");for(o=e=0;o<r;o+=1)e+=n.measureText(i[o]).width;return this.pos=r,new Point(this.left()+e,this.top())},StringMorph.prototype.slotAt=function(t){for(var e=this.isPassword?this.password("*",this.text.length):this.text,o=0,i=0,r=this.image.getContext("2d");t.x-this.left()>i;)if(i+=r.measureText(e[o]).width,(o+=1)===e.length&&r.measureText(e).width-r.measureText(e[o-1]).width/2<t.x-this.left())return o;return t.x-this.left()>i-r.measureText(e[o-1]).width/2?o:o-1},StringMorph.prototype.upFrom=function(t){return t},StringMorph.prototype.downFrom=function(t){return t},StringMorph.prototype.startOfLine=function(){return 0},StringMorph.prototype.endOfLine=function(){return this.text.length},StringMorph.prototype.previousWordFrom=function(t){for(var e=t-1;0<e&&!isWordChar(this.text[e]);)e-=1;for(;0<e&&isWordChar(this.text[e-1]);)e-=1;return e},StringMorph.prototype.nextWordFrom=function(t){for(var e=t;e<this.endOfLine()&&!isWordChar(this.text[e]);)e+=1;for(;e<this.endOfLine()&&isWordChar(this.text[e]);)e+=1;return e},StringMorph.prototype.rawHeight=function(){return this.height()/1.2},StringMorph.prototype.developersMenu=function(){var t=StringMorph.uber.developersMenu.call(this);return t.addLine(),t.addItem("edit","edit"),t.addItem("font size...",function(){this.prompt(t.title+"\nfont\nsize:",this.setFontSize,this,this.fontSize.toString(),null,6,500,!0)},"set this String's\nfont point size"),"serif"!==this.fontStyle&&t.addItem("serif","setSerif"),"sans-serif"!==this.fontStyle&&t.addItem("sans-serif","setSansSerif"),this.isBold?t.addItem("normal weight","toggleWeight"):t.addItem("bold","toggleWeight"),this.isItalic?t.addItem("normal style","toggleItalic"):t.addItem("italic","toggleItalic"),this.isShowingBlanks?t.addItem("hide blanks","toggleShowBlanks"):t.addItem("show blanks","toggleShowBlanks"),this.isPassword?t.addItem("show characters","toggleIsPassword"):t.addItem("hide characters","toggleIsPassword"),t},StringMorph.prototype.toggleIsDraggable=function(){this.isDraggable=!this.isDraggable,this.isDraggable?this.disableSelecting():this.enableSelecting()},StringMorph.prototype.toggleShowBlanks=function(){this.isShowingBlanks=!this.isShowingBlanks,this.changed(),this.drawNew(),this.changed()},StringMorph.prototype.toggleWeight=function(){this.isBold=!this.isBold,this.changed(),this.drawNew(),this.changed()},StringMorph.prototype.toggleItalic=function(){this.isItalic=!this.isItalic,this.changed(),this.drawNew(),this.changed()},StringMorph.prototype.toggleIsPassword=function(){this.isPassword=!this.isPassword,this.changed(),this.drawNew(),this.changed()},StringMorph.prototype.setSerif=function(){this.fontStyle="serif",this.changed(),this.drawNew(),this.changed()},StringMorph.prototype.setSansSerif=function(){this.fontStyle="sans-serif",this.changed(),this.drawNew(),this.changed()},StringMorph.prototype.setFontSize=function(t){var e;"number"==typeof t?this.fontSize=Math.round(Math.min(Math.max(t,4),500)):(e=parseFloat(t),isNaN(e)||(this.fontSize=Math.round(Math.min(Math.max(e,4),500)))),this.changed(),this.drawNew(),this.changed()},StringMorph.prototype.setText=function(t){this.text=Math.round(t).toString(),this.changed(),this.drawNew(),this.changed()},StringMorph.prototype.numericalSetters=function(){return["setLeft","setTop","setAlphaScaled","setFontSize","setText"]},StringMorph.prototype.edit=function(){this.root().edit(this)},StringMorph.prototype.selection=function(){var t,e;return t=Math.min(this.startMark,this.endMark),e=Math.max(this.startMark,this.endMark),this.text.slice(t,e)},StringMorph.prototype.selectionStartSlot=function(){return Math.min(this.startMark,this.endMark)},StringMorph.prototype.clearSelection=function(){!this.currentlySelecting&&isNil(this.startMark)&&isNil(this.endMark)||(this.currentlySelecting=!1,this.startMark=null,this.endMark=null,this.drawNew(),this.changed())},StringMorph.prototype.deleteSelection=function(){var t,e,o;o=this.text,t=Math.min(this.startMark,this.endMark),e=Math.max(this.startMark,this.endMark),this.text=o.slice(0,t)+o.slice(e),this.changed(),this.clearSelection()},StringMorph.prototype.selectAll=function(){var t;this.isEditable&&(this.startMark=0,(t=this.root().cursor)&&t.gotoSlot(this.text.length),this.endMark=this.text.length,this.drawNew(),this.changed())},StringMorph.prototype.mouseDownLeft=function(t){16===this.world().currentKey?this.shiftClick(t):this.isEditable?this.clearSelection():this.escalateEvent("mouseDownLeft",t)},StringMorph.prototype.shiftClick=function(t){var e=this.root().cursor;e&&(this.startMark||(this.startMark=e.slot),e.gotoPos(t),this.endMark=e.slot,this.drawNew(),this.changed()),this.currentlySelecting=!1,this.escalateEvent("mouseDownLeft",t)},StringMorph.prototype.mouseClickLeft=function(t){var e;if(this.isEditable)this.currentlySelecting||this.edit(),(e=this.root().cursor)&&e.gotoPos(t),this.currentlySelecting=!0;else{var o,i,r,n=this.slotAt(t);for(n===this.text.length&&(n-=1),i=n;1<i&&isURLChar(this.text[i-1]);)i-=1;for(r=n;r<this.text.length-1&&isURLChar(this.text[r+1]);)r+=1;isURL(o=this.text.substring(i,r+1))?window.open(o,"_blank"):this.escalateEvent("mouseClickLeft",t)}},StringMorph.prototype.mouseDoubleClick=function(t){var e=this.slotAt(t);this.isEditable?(this.edit(),e===this.text.length&&(e-=1),isWordChar(this.text[e])?this.selectWordAt(e):this.selectBetweenWordsAt(e)):this.escalateEvent("mouseDoubleClick",t)},StringMorph.prototype.selectWordAt=function(t){var e=this.root().cursor;0===t||isWordChar(this.text[t-1])?(e.gotoSlot(this.previousWordFrom(t)),this.startMark=e.slot,this.endMark=this.nextWordFrom(e.slot)):(e.gotoSlot(t),this.startMark=t,this.endMark=this.nextWordFrom(t)),this.drawNew(),this.changed()},StringMorph.prototype.selectBetweenWordsAt=function(t){var e=this.root().cursor;for(e.gotoSlot(this.nextWordFrom(this.previousWordFrom(t))),this.startMark=e.slot,this.endMark=e.slot;this.endMark<this.text.length&&!isWordChar(this.text[this.endMark]);)this.endMark+=1;this.drawNew(),this.changed()},StringMorph.prototype.enableSelecting=function(){this.mouseDownLeft=function(t){var e=this.root().cursor,o=!!e&&e.target===this;16===this.world().currentKey?this.shiftClick(t):(this.clearSelection(),this.isEditable&&!this.isDraggable&&(this.edit(),this.root().cursor.gotoPos(t),this.startMark=this.slotAt(t),this.endMark=this.startMark,this.currentlySelecting=!0,o||this.escalateEvent("mouseDownLeft",t)))},this.mouseMove=function(t){if(this.isEditable&&this.currentlySelecting&&!this.isDraggable){var e=this.slotAt(t);e!==this.endMark&&(this.endMark=e,this.drawNew(),this.changed())}}},StringMorph.prototype.disableSelecting=function(){this.mouseDownLeft=StringMorph.prototype.mouseDownLeft,delete this.mouseMove},TextMorph.prototype=new Morph,TextMorph.prototype.constructor=TextMorph,TextMorph.uber=Morph.prototype,TextMorph.prototype.init=function(t,e,o,i,r,n,s,a,h,l){this.text=t||(""===t?t:"TextMorph"),this.words=[],this.lines=[],this.lineSlots=[],this.fontSize=e||12,this.fontName=a||MorphicPreferences.globalFontFamily,this.fontStyle=o||"sans-serif",this.isBold=i||!1,this.isItalic=r||!1,this.alignment=n||"left",this.shadowOffset=h||new Point(0,0),this.shadowColor=l||null,this.maxWidth=s||0,this.maxLineWidth=0,this.backgroundColor=null,this.isEditable=!1,this.receiver=null,this.isScrollable=!0,this.currentlySelecting=!1,this.startMark=0,this.endMark=0,this.markedTextColor=new Color(255,255,255),this.markedBackgoundColor=new Color(60,60,120),TextMorph.uber.init.call(this),this.color=new Color(0,0,0),this.noticesTransparentClick=!0,this.drawNew()},TextMorph.prototype.toString=function(){return'a TextMorph("'+this.text.slice(0,30)+'...")'},TextMorph.prototype.font=StringMorph.prototype.font,TextMorph.prototype.parse=function(){var e,o=this,t=this.text.split("\n"),i=newCanvas().getContext("2d"),r="",n=0;i.font=this.font(),this.maxLineWidth=0,this.lines=[],this.lineSlots=[0],this.words=[],t.forEach(function(t){o.words=o.words.concat(t.split(" ")),o.words.push("\n")}),this.words.forEach(function(t){"\n"===t?(o.lines.push(r),o.lineSlots.push(n),o.maxLineWidth=Math.max(o.maxLineWidth,i.measureText(r).width),r=""):(r=0<o.maxWidth?(e=r+t+" ",i.measureText(e).width>o.maxWidth?(o.lines.push(r),o.lineSlots.push(n),o.maxLineWidth=Math.max(o.maxLineWidth,i.measureText(r).width),t+" "):e):r+t+" ",n+=t.length+1)})},TextMorph.prototype.drawNew=function(){var t,e,o,i,r,n,s,a,h,l,p,c,u,d,g;if(this.image=newCanvas(),(t=this.image.getContext("2d")).font=this.font(),this.parse(),s=Math.abs(this.shadowOffset.x),n=Math.abs(this.shadowOffset.y),e=this.lines.length*(fontHeight(this.fontSize)+n),0===this.maxWidth?this.bounds=this.bounds.origin.extent(new Point(this.maxLineWidth+s,e)):this.bounds=this.bounds.origin.extent(new Point(this.maxWidth+s,e)),this.image.width=this.width(),this.image.height=this.height(),(t=this.image.getContext("2d")).font=this.font(),t.textAlign="left",t.textBaseline="bottom",this.backgroundColor&&(t.fillStyle=this.backgroundColor.toString(),t.fillRect(0,0,this.width(),this.height())),this.shadowColor)for(a=Math.max(this.shadowOffset.x,0),h=Math.max(this.shadowOffset.y,0),t.fillStyle=this.shadowColor.toString(),o=0;o<this.lines.length;o+=1)i=this.lines[o],r=t.measureText(i).width+s,l="right"===this.alignment?this.width()-r:"center"===this.alignment?(this.width()-r)/2:0,p=(o+1)*(fontHeight(this.fontSize)+n)-n,t.fillText(i,l+a,p+h);for(a=Math.abs(Math.min(this.shadowOffset.x,0)),h=Math.abs(Math.min(this.shadowOffset.y,0)),t.fillStyle=this.color.toString(),o=0;o<this.lines.length;o+=1)i=this.lines[o],r=t.measureText(i).width+s,l="right"===this.alignment?this.width()-r:"center"===this.alignment?(this.width()-r)/2:0,p=(o+1)*(fontHeight(this.fontSize)+n)-n,t.fillText(i,l+a,p+h);for(c=Math.min(this.startMark,this.endMark),u=Math.max(this.startMark,this.endMark),o=c;o<u;o+=1)d=this.slotPosition(o).subtract(this.position()),g=this.text.charAt(o),t.fillStyle=this.markedBackgoundColor.toString(),t.fillRect(d.x,d.y,t.measureText(g).width+1,fontHeight(this.fontSize)),t.fillStyle=this.markedTextColor.toString(),t.fillText(g,d.x,d.y+fontHeight(this.fontSize));this.parent&&this.parent.layoutChanged&&this.parent.layoutChanged()},TextMorph.prototype.setExtent=function(t){this.maxWidth=Math.max(t.x,0),this.changed(),this.drawNew()},TextMorph.prototype.columnRow=function(t){var e,o,i=0;for(e=0;e<this.lines.length;e+=1)for(i=this.lineSlots[e],o=0;o<this.lines[e].length;o+=1){if(i===t)return new Point(o,e);i+=1}return new Point(this.lines[this.lines.length-1].length-1,this.lines.length-1)},TextMorph.prototype.slotPosition=function(t){var e,o,i=this.columnRow(t),r=this.image.getContext("2d"),n=Math.abs(this.shadowOffset.y),s=0;for(e=i.y*(fontHeight(this.fontSize)+n),o=0;o<i.x;o+=1)s+=r.measureText(this.lines[i.y][o]).width;return new Point(this.left()+s,this.top()+e)},TextMorph.prototype.slotAt=function(t){for(var e,o,i,r=0,n=0,s=Math.abs(this.shadowOffset.y),a=this.image.getContext("2d");t.y-this.top()>(fontHeight(this.fontSize)+s)*r;)r+=1;for(r=Math.max(r,1),i=a.measureText(this.lines[r-1]).width,e="right"===this.alignment?this.width()-i:"center"===this.alignment?(this.width()-i)/2:0,o=this.lines[r-1].length;n<o-2&&t.x-this.left()>e;)e+=a.measureText(this.lines[r-1][n]).width,n+=1;return t.x-this.left()>e-a.measureText(this.lines[r-1][n]).width/2?this.lineSlots[Math.max(r-1,0)]+n:this.lineSlots[Math.max(r-1,0)]+n-1},TextMorph.prototype.upFrom=function(t){var e,o=this.columnRow(t);return o.y<1?t:(e=this.lines[o.y-1]).length<o.x-1?this.lineSlots[o.y-1]+e.length:this.lineSlots[o.y-1]+o.x},TextMorph.prototype.downFrom=function(t){var e,o=this.columnRow(t);return o.y>this.lines.length-2?t:(e=this.lines[o.y+1]).length<o.x-1?this.lineSlots[o.y+1]+e.length:this.lineSlots[o.y+1]+o.x},TextMorph.prototype.startOfLine=function(t){return this.lineSlots[this.columnRow(t).y]},TextMorph.prototype.endOfLine=function(t){return this.startOfLine(t)+this.lines[this.columnRow(t).y].length-1},TextMorph.prototype.previousWordFrom=StringMorph.prototype.previousWordFrom,TextMorph.prototype.nextWordFrom=StringMorph.prototype.nextWordFrom,TextMorph.prototype.edit=StringMorph.prototype.edit,TextMorph.prototype.selection=StringMorph.prototype.selection,TextMorph.prototype.selectionStartSlot=StringMorph.prototype.selectionStartSlot,TextMorph.prototype.clearSelection=StringMorph.prototype.clearSelection,TextMorph.prototype.deleteSelection=StringMorph.prototype.deleteSelection,TextMorph.prototype.selectAll=StringMorph.prototype.selectAll,TextMorph.prototype.mouseDownLeft=StringMorph.prototype.mouseDownLeft,TextMorph.prototype.shiftClick=StringMorph.prototype.shiftClick,TextMorph.prototype.mouseClickLeft=StringMorph.prototype.mouseClickLeft,TextMorph.prototype.mouseDoubleClick=StringMorph.prototype.mouseDoubleClick,TextMorph.prototype.selectWordAt=StringMorph.prototype.selectWordAt,TextMorph.prototype.selectBetweenWordsAt=StringMorph.prototype.selectBetweenWordsAt,TextMorph.prototype.enableSelecting=StringMorph.prototype.enableSelecting,TextMorph.prototype.disableSelecting=StringMorph.prototype.disableSelecting,TextMorph.prototype.selectAllAndEdit=function(){this.edit(),this.selectAll()},TextMorph.prototype.developersMenu=function(){var t=TextMorph.uber.developersMenu.call(this);return t.addLine(),t.addItem("edit","edit"),t.addItem("font size...",function(){this.prompt(t.title+"\nfont\nsize:",this.setFontSize,this,this.fontSize.toString(),null,6,100,!0)},"set this Text's\nfont point size"),"left"!==this.alignment&&t.addItem("align left","setAlignmentToLeft"),"right"!==this.alignment&&t.addItem("align right","setAlignmentToRight"),"center"!==this.alignment&&t.addItem("align center","setAlignmentToCenter"),t.addLine(),"serif"!==this.fontStyle&&t.addItem("serif","setSerif"),"sans-serif"!==this.fontStyle&&t.addItem("sans-serif","setSansSerif"),this.isBold?t.addItem("normal weight","toggleWeight"):t.addItem("bold","toggleWeight"),this.isItalic?t.addItem("normal style","toggleItalic"):t.addItem("italic","toggleItalic"),t},TextMorph.prototype.setAlignmentToLeft=function(){this.alignment="left",this.drawNew(),this.changed()},TextMorph.prototype.setAlignmentToRight=function(){this.alignment="right",this.drawNew(),this.changed()},TextMorph.prototype.setAlignmentToCenter=function(){this.alignment="center",this.drawNew(),this.changed()},TextMorph.prototype.toggleIsDraggable=StringMorph.prototype.toggleIsDraggable,TextMorph.prototype.toggleWeight=StringMorph.prototype.toggleWeight,TextMorph.prototype.toggleItalic=StringMorph.prototype.toggleItalic,TextMorph.prototype.setSerif=StringMorph.prototype.setSerif,TextMorph.prototype.setSansSerif=StringMorph.prototype.setSansSerif,TextMorph.prototype.setText=StringMorph.prototype.setText,TextMorph.prototype.setFontSize=StringMorph.prototype.setFontSize,TextMorph.prototype.numericalSetters=StringMorph.prototype.numericalSetters,TextMorph.prototype.evaluationMenu=function(){var t=new MenuMorph(this,null);return t.addItem("do it","doIt","evaluate the\nselected expression"),t.addItem("show it","showIt","evaluate the\nselected expression\nand show the result"),t.addItem("inspect it","inspectIt","evaluate the\nselected expression\nand inspect the result"),t.addLine(),t.addItem("select all","selectAllAndEdit"),t},TextMorph.prototype.setReceiver=function(t){this.receiver=t,this.customContextMenu=this.evaluationMenu()},TextMorph.prototype.doIt=function(){this.receiver.evaluateString(this.selection()),this.edit()},TextMorph.prototype.showIt=function(){var t=this.receiver.evaluateString(this.selection());null!==t&&this.inform(t)},TextMorph.prototype.inspectIt=function(){var t,e=this.receiver.evaluateString(this.selection()),o=this.world();isObject(e)&&((t=new InspectorMorph(e)).setPosition(o.hand.position()),t.keepWithin(o),o.add(t),t.changed())},TriggerMorph.prototype=new Morph,TriggerMorph.prototype.constructor=TriggerMorph,TriggerMorph.uber=Morph.prototype,TriggerMorph.prototype.init=function(t,e,o,i,r,n,s,a,h,l,p){this.target=t||null,this.action=e||null,this.doubleClickAction=p||null,this.environment=n||null,this.labelString=o||null,this.label=null,this.hint=s||null,this.schedule=null,this.fontSize=i||MorphicPreferences.menuFontSize,this.fontStyle=r||"sans-serif",this.highlightColor=new Color(192,192,192),this.pressColor=new Color(128,128,128),this.labelColor=a||new Color(0,0,0),this.labelBold=h||!1,this.labelItalic=l||!1,TriggerMorph.uber.init.call(this),this.color=new Color(255,255,255),this.drawNew()},TriggerMorph.prototype.drawNew=function(){this.createBackgrounds(),null!==this.labelString&&this.createLabel()},TriggerMorph.prototype.createBackgrounds=function(){var t,e=this.extent();this.normalImage=newCanvas(e),(t=this.normalImage.getContext("2d")).fillStyle=this.color.toString(),t.fillRect(0,0,e.x,e.y),this.highlightImage=newCanvas(e),(t=this.highlightImage.getContext("2d")).fillStyle=this.highlightColor.toString(),t.fillRect(0,0,e.x,e.y),this.pressImage=newCanvas(e),(t=this.pressImage.getContext("2d")).fillStyle=this.pressColor.toString(),t.fillRect(0,0,e.x,e.y),this.image=this.normalImage},TriggerMorph.prototype.createLabel=function(){null!==this.label&&this.label.destroy(),this.label=new StringMorph(this.labelString,this.fontSize,this.fontStyle,this.labelBold,this.labelItalic,!1,null,null,this.labelColor),this.label.setPosition(this.center().subtract(this.label.extent().floorDivideBy(2))),this.add(this.label)},TriggerMorph.prototype.trigger=function(){this.schedule&&(this.schedule.isActive=!1),"function"==typeof this.target?"function"==typeof this.action?this.target.call(this.environment,this.action.call(),this):this.target.call(this.environment,this.action,this):"function"==typeof this.action?this.action.call(this.target):this.target[this.action]()},TriggerMorph.prototype.triggerDoubleClick=function(){this.doubleClickAction&&(this.schedule&&(this.schedule.isActive=!1),"function"==typeof this.target?"function"==typeof this.doubleClickAction?this.target.call(this.environment,this.doubleClickAction.call(),this):this.target.call(this.environment,this.doubleClickAction,this):"function"==typeof this.doubleClickAction?this.doubleClickAction.call(this.target):this.target[this.doubleClickAction]())},TriggerMorph.prototype.mouseEnter=function(){var t=this.hint instanceof Function?this.hint():this.hint;this.image=this.highlightImage,this.changed(),t&&this.bubbleHelp(t)},TriggerMorph.prototype.mouseLeave=function(){this.image=this.normalImage,this.changed(),this.schedule&&(this.schedule.isActive=!1),this.hint&&this.world().hand.destroyTemporaries()},TriggerMorph.prototype.mouseDownLeft=function(){this.image=this.pressImage,this.changed()},TriggerMorph.prototype.mouseClickLeft=function(){this.image=this.highlightImage,this.changed(),this.trigger()},TriggerMorph.prototype.mouseDoubleClick=function(){this.triggerDoubleClick()},TriggerMorph.prototype.rootForGrab=function(){return this.isDraggable?TriggerMorph.uber.rootForGrab.call(this):null},TriggerMorph.prototype.bubbleHelp=function(t){var e=this.world(),o=this;this.schedule=new Animation(nop,nop,0,500,nop,function(){o.popUpbubbleHelp(t)}),e.animations.push(this.schedule)},TriggerMorph.prototype.popUpbubbleHelp=function(t){new SpeechBubbleMorph(localize(t),null,null,1).popUp(this.world(),this.rightCenter().add(new Point(-8,0)))},MenuItemMorph.prototype=new TriggerMorph,MenuItemMorph.prototype.constructor=MenuItemMorph,MenuItemMorph.uber=TriggerMorph.prototype,MenuItemMorph.prototype.createLabel=function(){var t,e;this.label&&this.label.destroy(),this.label=this.createLabelPart(this.labelString),this.add(this.label),t=this.label.width(),e=this.label.height(),this.shortcut&&this.shortcut.destroy(),this.shortcutString&&(this.shortcut=this.createLabelPart(this.shortcutString),t+=this.shortcut.width()+4,e=Math.max(e,this.shortcut.height()),this.add(this.shortcut)),this.silentSetExtent(new Point(t+8,e)),this.fixLayout()},MenuItemMorph.prototype.fixLayout=function(){var t=this.center();this.label.setCenter(t),this.label.setLeft(this.left()+4),this.shortcut&&(this.shortcut.setCenter(t),this.shortcut.setRight(this.right()-4))},MenuItemMorph.prototype.createLabelPart=function(t){var e,o,i;return isString(t)?this.createLabelString(t):t instanceof Array?((e=new Morph).alpha=0,o=this.createIcon(t[0]),e.add(o),i=this.createLabelString(t[1]),e.add(i),i.setCenter(o.center()),i.setLeft(o.right()+4),e.bounds=o.bounds.merge(i.bounds),e.drawNew(),e):this.createIcon(t)},MenuItemMorph.prototype.createIcon=function(t){var e,o=new Morph;return o.image=t instanceof Morph?t.fullImage():t,t instanceof Morph&&t.getShadow()&&(e=o.image,o.image=newCanvas(t.fullBounds().extent().subtract(this.shadowBlur*(useBlurredShadows?1:2))),o.image.getContext("2d").drawImage(e,0,0)),o.silentSetWidth(o.image.width),o.silentSetHeight(o.image.height),o},MenuItemMorph.prototype.createLabelString=function(t){var e=new TextMorph(t,this.fontSize,this.fontStyle,this.labelBold,this.labelItalic);return e.setColor(this.labelColor),e},MenuItemMorph.prototype.mouseEnter=function(){var t=this.parentThatIsA(MenuMorph);this.isShowingSubmenu()||(t&&t.closeSubmenu(),this.isListItem()||(this.image=this.highlightImage,this.changed()),this.action instanceof MenuMorph?this.delaySubmenu():this.hint&&this.bubbleHelp(this.hint))},MenuItemMorph.prototype.mouseLeave=function(){this.isListItem()||(this.isShowingSubmenu()?this.image=this.highlightImage:this.image=this.normalImage,this.changed()),this.schedule&&(this.schedule.isActive=!1),this.hint&&this.world().hand.destroyTemporaries()},MenuItemMorph.prototype.mouseDownLeft=function(t){this.isListItem()&&(this.parentThatIsA(MenuMorph).unselectAllItems(),this.escalateEvent("mouseDownLeft",t)),this.image=this.pressImage,this.changed()},MenuItemMorph.prototype.mouseMove=function(){this.isListItem()&&this.escalateEvent("mouseMove")},MenuItemMorph.prototype.mouseClickLeft=function(){this.action instanceof MenuMorph?this.popUpSubmenu():(this.isListItem()||(this.parentThatIsA(MenuMorph).closeRootMenu(),this.world().activeMenu=null),this.trigger())},MenuItemMorph.prototype.isListItem=function(){var t=this.parentThatIsA(MenuMorph);return!!t&&t.isListContents},MenuItemMorph.prototype.isSelectedListItem=function(){return!!this.isListItem()&&this.image===this.pressImage},MenuItemMorph.prototype.isShowingSubmenu=function(){var t=this.parentThatIsA(MenuMorph);return!!(t&&this.action instanceof MenuMorph)&&t.submenu===this.action},MenuItemMorph.prototype.delaySubmenu=function(){var t=this.world(),e=this;this.schedule=new Animation(nop,nop,0,500,nop,function(){e.popUpSubmenu()}),t.animations.push(this.schedule)},MenuItemMorph.prototype.popUpSubmenu=function(){var t=this.parentThatIsA(MenuMorph);this.action instanceof MenuMorph&&(this.action.drawNew(),this.action.setPosition(this.topRight().subtract(new Point(0,5))),this.action.addShadow(new Point(2,2),80),this.action.keepWithin(this.world()),this.action.items.length<1&&!this.action.title||(t.add(this.action),t.submenu=this.action,t.submenu.world=t.world,this.action.fullChanged()))},FrameMorph.prototype=new Morph,FrameMorph.prototype.constructor=FrameMorph,FrameMorph.uber=Morph.prototype,FrameMorph.prototype.init=function(t){this.scrollFrame=t||null,FrameMorph.uber.init.call(this),this.color=new Color(255,250,245),this.drawNew(),this.acceptsDrops=!0,this.scrollFrame&&(this.isDraggable=!1,this.noticesTransparentClick=!1,this.alpha=0)},FrameMorph.prototype.fullBounds=function(){var t=this.getShadow();return null!==t?this.bounds.merge(t.bounds):this.bounds},FrameMorph.prototype.fullImage=function(){return this.image},FrameMorph.prototype.fullDrawOn=function(e,t){var o,i;return this.isVisible?(o=t||this.fullBounds(),(i=this.bounds.intersect(o)).extent().gt(new Point(0,0))?(this.drawOn(e,i),void this.children.forEach(function(t){t instanceof ShadowMorph?t.fullDrawOn(e,o):t.fullDrawOn(e,i)})):null):null},FrameMorph.prototype.topMorphAt=function(t){var e,o;if(!this.isVisible||!this.bounds.containsPoint(t))return null;for(e=this.children.length-1;0<=e;e-=1)if(o=this.children[e].topMorphAt(t))return o;return this.noticesTransparentClick||!this.isTransparentAt(t)?this:null},FrameMorph.prototype.submorphBounds=function(){var e=null;return 0<this.children.length&&(e=this.children[0].bounds,this.children.forEach(function(t){e=e.merge(t.fullBounds())})),e},FrameMorph.prototype.keepInScrollFrame=function(){if(null===this.scrollFrame)return null;this.left()>this.scrollFrame.left()&&this.moveBy(new Point(this.scrollFrame.left()-this.left(),0)),this.right()<this.scrollFrame.right()&&this.moveBy(new Point(this.scrollFrame.right()-this.right(),0)),this.top()>this.scrollFrame.top()&&this.moveBy(new Point(0,this.scrollFrame.top()-this.top())),this.bottom()<this.scrollFrame.bottom()&&this.moveBy(0,new Point(this.scrollFrame.bottom()-this.bottom(),0))},FrameMorph.prototype.adjustBounds=function(){var t,e,o=this;if(null===this.scrollFrame)return null;e=(t=this.submorphBounds())&&!this.scrollFrame.isTextLineWrapping?t.expandBy(this.scrollFrame.padding).growBy(this.scrollFrame.growth).merge(this.scrollFrame.bounds):this.scrollFrame.bounds.copy(),this.bounds.eq(e)||(this.bounds=e,this.drawNew(),this.keepInScrollFrame()),this.scrollFrame.isTextLineWrapping&&this.children.forEach(function(t){t instanceof TextMorph&&(t.setWidth(o.width()),o.setHeight(Math.max(t.height(),o.scrollFrame.height())))}),this.scrollFrame.adjustScrollBars()},FrameMorph.prototype.reactToDropOf=function(){this.adjustBounds()},FrameMorph.prototype.reactToGrabOf=function(){this.adjustBounds()},FrameMorph.prototype.developersMenu=function(){var t=FrameMorph.uber.developersMenu.call(this);return 0<this.children.length&&(t.addLine(),t.addItem("move all inside...","keepAllSubmorphsWithin","keep all submorphs\nwithin and visible")),t},FrameMorph.prototype.keepAllSubmorphsWithin=function(){var e=this;this.children.forEach(function(t){t.keepWithin(e)})},ScrollFrameMorph.prototype=new FrameMorph,ScrollFrameMorph.prototype.constructor=ScrollFrameMorph,ScrollFrameMorph.uber=FrameMorph.prototype,ScrollFrameMorph.prototype.init=function(t,e,o){var i=this;ScrollFrameMorph.uber.init.call(this),this.scrollBarSize=e||MorphicPreferences.scrollBarSize,this.autoScrollTrigger=null,this.enableAutoScrolling=!0,this.isScrollingByDragging=!0,this.hasVelocity=!0,this.padding=0,this.growth=0,this.isTextLineWrapping=!1,this.contents=t||new FrameMorph(this),this.add(this.contents),this.hBar=new SliderMorph(null,null,null,null,"horizontal",o),this.hBar.setHeight(this.scrollBarSize),this.hBar.action=function(t){i.contents.setPosition(new Point(i.left()-t,i.contents.position().y))},this.hBar.isDraggable=!1,this.add(this.hBar),this.vBar=new SliderMorph(null,null,null,null,"vertical",o),this.vBar.setWidth(this.scrollBarSize),this.vBar.action=function(t){i.contents.setPosition(new Point(i.contents.position().x,i.top()-t))},this.vBar.isDraggable=!1,this.add(this.vBar),this.toolBar=null},ScrollFrameMorph.prototype.adjustScrollBars=function(){var t=this.width()-this.scrollBarSize,e=this.height()-this.scrollBarSize;this.changed(),this.contents.width()>this.width()+MorphicPreferences.scrollBarSize?(this.hBar.show(),this.hBar.width()!==t&&this.hBar.setWidth(t),this.hBar.setPosition(new Point(this.left(),this.bottom()-this.hBar.height())),this.hBar.start=0,this.hBar.stop=this.contents.width()-this.width(),this.hBar.size=this.width()/this.contents.width()*this.hBar.stop,this.hBar.value=this.left()-this.contents.left(),this.hBar.drawNew()):this.hBar.hide(),this.contents.height()>this.height()+this.scrollBarSize?(this.vBar.show(),this.vBar.height()!==e&&this.vBar.setHeight(e),this.vBar.setPosition(new Point(this.right()-this.vBar.width(),this.top())),this.vBar.start=0,this.vBar.stop=this.contents.height()-this.height(),this.vBar.size=this.height()/this.contents.height()*this.vBar.stop,this.vBar.value=this.top()-this.contents.top(),this.vBar.drawNew()):this.vBar.hide(),this.adjustToolBar()},ScrollFrameMorph.prototype.adjustToolBar=function(){this.toolBar&&(this.toolBar.setTop(this.top()+3),this.toolBar.setRight((this.vBar.isVisible?this.vBar.left():this.right())-3))},ScrollFrameMorph.prototype.addContents=function(t){this.contents.add(t),this.contents.adjustBounds()},ScrollFrameMorph.prototype.setContents=function(t){this.contents.children.forEach(function(t){t.destroy()}),this.contents.children=[],t.setPosition(this.position().add(this.padding+2)),this.addContents(t)},ScrollFrameMorph.prototype.setExtent=function(t){this.isTextLineWrapping&&this.contents.setPosition(this.position().copy()),ScrollFrameMorph.uber.setExtent.call(this,t),this.contents.adjustBounds()},ScrollFrameMorph.prototype.scrollX=function(t){var e,o=this.contents.left(),i=this.left(),r=this.contents.width(),n=this.right();(e=o+t)+r<n&&(e=n-r),i<e&&(e=i),e!==o&&this.contents.setLeft(e)},ScrollFrameMorph.prototype.scrollY=function(t){var e,o=this.contents.top(),i=this.top(),r=this.contents.height(),n=this.bottom();(e=o+t)+r<n&&(e=n-r),i<e&&(e=i),e!==o&&this.contents.setTop(e)},ScrollFrameMorph.prototype.step=nop,ScrollFrameMorph.prototype.mouseDownLeft=function(t){if(!this.isScrollingByDragging)return null;var e=this.root().hand,o=t,i=this,r=0,n=0;this.step=function(){var t;if(e.mouseButton&&0===e.children.length&&i.bounds.containsPoint(e.bounds.origin)){if(e.grabPosition&&e.grabPosition.distanceTo(e.position())<=MorphicPreferences.grabThreshold)return null;t=e.bounds.origin,0!==(r=t.x-o.x)&&i.scrollX(r),0!==(n=t.y-o.y)&&i.scrollY(n),o=t}else i.hasVelocity?Math.abs(r)<.5&&Math.abs(n)<.5?i.step=function(){nop()}:(r*=.8,i.scrollX(Math.round(r)),n*=.8,i.scrollY(Math.round(n))):i.step=function(){nop()};this.adjustScrollBars()}},ScrollFrameMorph.prototype.startAutoScrolling=function(){var t,e,o,i=this,r=3*MorphicPreferences.scrollBarSize,n=this.world();if(!n)return null;t=n.hand,this.autoScrollTrigger||(this.autoScrollTrigger=Date.now()),this.step=function(){o=t.bounds.origin,e=i.bounds.insetBy(r),i.bounds.containsPoint(o)&&!e.containsPoint(o)&&0<t.children.length?i.autoScroll(o):(i.step=function(){nop()},i.autoScrollTrigger=null)}},ScrollFrameMorph.prototype.autoScroll=function(t){var e;if(Date.now()-this.autoScrollTrigger<500)return null;e=3*MorphicPreferences.scrollBarSize,this.topLeft().extent(new Point(this.width(),e)).containsPoint(t)&&this.scrollY(e-(t.y-this.top())),this.topLeft().extent(new Point(e,this.height())).containsPoint(t)&&this.scrollX(e-(t.x-this.left())),new Point(this.right()-e,this.top()).extent(new Point(e,this.height())).containsPoint(t)&&this.scrollX(-(e-(this.right()-t.x))),new Point(this.left(),this.bottom()-e).extent(new Point(this.width(),e)).containsPoint(t)&&this.scrollY(-(e-(this.bottom()-t.y))),this.adjustScrollBars()},ScrollFrameMorph.prototype.scrollCursorIntoView=function(t){var e=t.target,o=e.position().subtract(this.contents.position()),i=this.top()+this.padding,r=this.bottom()-this.padding;this.contents.setExtent(e.extent().add(o).add(this.padding)),t.top()<i?(this.contents.setTop(this.contents.top()+i-t.top()),t.setTop(i)):t.bottom()>r&&(this.contents.setBottom(this.contents.bottom()+r-t.bottom()),t.setBottom(r)),this.adjustScrollBars()},ScrollFrameMorph.prototype.mouseScroll=function(t,e){t&&this.scrollY(t*MorphicPreferences.mouseScrollAmount),e&&this.scrollX(e*MorphicPreferences.mouseScrollAmount),this.adjustScrollBars()},ScrollFrameMorph.prototype.updateReferences=function(t){var e=this;ScrollFrameMorph.uber.updateReferences.call(this,t),this.hBar&&(this.hBar.action=function(t){e.contents.setPosition(new Point(e.left()-t,e.contents.position().y))}),this.vBar&&(this.vBar.action=function(t){e.contents.setPosition(new Point(e.contents.position().x,e.top()-t))})},ScrollFrameMorph.prototype.developersMenu=function(){var t=ScrollFrameMorph.uber.developersMenu.call(this);return this.isTextLineWrapping?t.addItem("auto line wrap off...","toggleTextLineWrapping","turn automatic\nline wrapping\noff"):t.addItem("auto line wrap on...","toggleTextLineWrapping","enable automatic\nline wrapping"),t},ScrollFrameMorph.prototype.toggleTextLineWrapping=function(){this.isTextLineWrapping=!this.isTextLineWrapping},ListMorph.prototype=new ScrollFrameMorph,ListMorph.prototype.constructor=ListMorph,ListMorph.uber=ScrollFrameMorph.prototype,ListMorph.prototype.init=function(t,e,o,i){ListMorph.uber.init.call(this),this.contents.acceptsDrops=!1,this.color=new Color(255,255,255),this.hBar.alpha=.6,this.vBar.alpha=.6,this.elements=t||[],this.labelGetter=e,this.format=o,this.listContents=null,this.selected=null,this.active=null,this.action=null,this.doubleClickAction=i||null,this.acceptsDrops=!1,this.buildListContents()},ListMorph.prototype.buildListContents=function(){var t=this;this.listContents&&this.listContents.destroy(),this.listContents=new MenuMorph(this.select,null,this),0===this.elements.length&&(this.elements=["(empty)"]),this.elements.forEach(function(e){var o=null,i=!1,r=!1;t.format.forEach(function(t){t[1].call(null,e)&&("bold"===t[0]?i=!0:"italic"===t[0]?r=!0:o=t[0])}),t.listContents.addItem(t.labelGetter(e),e,null,o,i,r,t.doubleClickAction)}),this.listContents.setPosition(this.contents.position()),this.listContents.isListContents=!0,this.listContents.drawNew(),this.addContents(this.listContents)},ListMorph.prototype.select=function(t,e){isNil(t)||(this.selected=t,this.active=e,this.action&&this.action.call(null,t))},ListMorph.prototype.setExtent=function(t){var e=this.listContents.bounds,o=this.bounds.origin.copy().corner(this.bounds.origin.add(t));o.right()>e.right()&&o.width()<=e.width()&&this.listContents.setRight(o.right()),o.bottom()>e.bottom()&&o.height()<=e.height()&&this.listContents.setBottom(o.bottom()),ListMorph.uber.setExtent.call(this,t)},ListMorph.prototype.activeIndex=function(){return this.listContents.children.indexOf(this.active)},ListMorph.prototype.activateIndex=function(t){var e=this.listContents.children[t];e&&(e.image=e.pressImage,e.changed(),e.trigger())},StringFieldMorph.prototype=new FrameMorph,StringFieldMorph.prototype.constructor=StringFieldMorph,StringFieldMorph.uber=FrameMorph.prototype,StringFieldMorph.prototype.init=function(t,e,o,i,r,n,s){this.defaultContents=t,this.minWidth=e,this.fontSize=o,this.fontStyle=i,this.isBold=r,this.isItalic=n,this.isNumeric=s||!1,this.text=null,StringFieldMorph.uber.init.call(this),this.color=new Color(255,255,255),this.isEditable=!0,this.acceptsDrops=!1,this.drawNew()},StringFieldMorph.prototype.drawNew=function(){var t;t=this.text?this.string():this.defaultContents,this.text=null,this.children.forEach(function(t){t.destroy()}),this.children=[],this.text=new StringMorph(t,this.fontSize,this.fontStyle,this.isBold,this.isItalic,this.isNumeric),this.text.isNumeric=this.isNumeric,this.text.setPosition(this.bounds.origin.copy()),this.text.isEditable=this.isEditable,this.text.isDraggable=!1,this.text.enableSelecting(),this.silentSetExtent(new Point(Math.max(this.width(),this.minWidth),this.text.height())),StringFieldMorph.uber.drawNew.call(this),this.add(this.text)},StringFieldMorph.prototype.string=function(){return this.text.text},StringFieldMorph.prototype.mouseClickLeft=function(t){this.isEditable?this.text.edit():this.escalateEvent("mouseClickLeft",t)},BouncerMorph.prototype=new Morph,BouncerMorph.prototype.constructor=BouncerMorph,BouncerMorph.uber=Morph.prototype,BouncerMorph.prototype.init=function(t,e){BouncerMorph.uber.init.call(this),this.fps=50,this.isStopped=!1,this.type=t||"vertical","vertical"===this.type?this.direction="down":this.direction="right",this.speed=e||1},BouncerMorph.prototype.moveUp=function(){this.moveBy(new Point(0,-this.speed))},BouncerMorph.prototype.moveDown=function(){this.moveBy(new Point(0,this.speed))},BouncerMorph.prototype.moveRight=function(){this.moveBy(new Point(this.speed,0))},BouncerMorph.prototype.moveLeft=function(){this.moveBy(new Point(-this.speed,0))},BouncerMorph.prototype.step=function(){this.isStopped||("vertical"===this.type?("down"===this.direction?this.moveDown():this.moveUp(),this.fullBounds().top()<this.parent.top()&&"up"===this.direction&&(this.direction="down"),this.fullBounds().bottom()>this.parent.bottom()&&"down"===this.direction&&(this.direction="up")):"horizontal"===this.type&&("right"===this.direction?this.moveRight():this.moveLeft(),this.fullBounds().left()<this.parent.left()&&"left"===this.direction&&(this.direction="right"),this.fullBounds().right()>this.parent.right()&&"right"===this.direction&&(this.direction="left")))},HandMorph.prototype=new Morph,HandMorph.prototype.constructor=HandMorph,HandMorph.uber=Morph.prototype,HandMorph.prototype.init=function(t){HandMorph.uber.init.call(this,!0),this.bounds=new Rectangle,this.world=t,this.mouseButton=null,this.mouseOverList=[],this.morphToGrab=null,this.grabPosition=null,this.grabOrigin=null,this.temporaries=[],this.touchHoldTimeout=null,this.contextMenuEnabled=!1},HandMorph.prototype.changed=function(){var t;null!==this.world&&((t=this.fullBounds()).extent().eq(new Point)||this.world.broken.push(t.spread()))},HandMorph.prototype.fullChanged=HandMorph.prototype.changed,HandMorph.prototype.morphAtPointer=function(){return this.world.topMorphAt(this.bounds.origin)||this.world},HandMorph.prototype.allMorphsAtPointer=function(){var t=this.world.allChildren(),e=this;return t.filter(function(t){return t.isVisible&&t.visibleBounds().containsPoint(e.bounds.origin)})},HandMorph.prototype.dropTargetFor=function(t){for(var e=this.morphAtPointer();!e.wantsDropOf(t);)e=e.parent;return e},HandMorph.prototype.grab=function(t){var e=t.parent;if(t instanceof WorldMorph)return null;0===this.children.length&&(this.world.stopEditing(),this.grabOrigin=t.situation(),t.addShadow(),t.prepareToBeGrabbed&&t.prepareToBeGrabbed(this),t.cachedFullImage=t.fullImageClassic(),t.cachedFullBounds=t.fullBounds(),this.add(t),this.changed(),e&&e.reactToGrabOf&&e.reactToGrabOf(t))},HandMorph.prototype.drop=function(){var t,e;0!==this.children.length&&(e=this.children[0],t=this.dropTargetFor(e),this.changed(),t.add(e),e.cachedFullImage=null,e.cachedFullBounds=null,e.changed(),e.removeShadow(),this.children=[],this.setExtent(new Point),e.justDropped&&e.justDropped(this),t.reactToDropOf&&t.reactToDropOf(e,this))},HandMorph.prototype.processMouseDown=function(t){var e,o;if(this.destroyTemporaries(),this.contextMenuEnabled=!0,this.morphToGrab=null,this.grabPosition=null,0!==this.children.length)this.drop(),this.mouseButton=null;else{for(e=this.morphAtPointer(),this.world.activeMenu&&(contains(e.allParents(),this.world.activeMenu)?clearInterval(this.touchHoldTimeout):this.world.activeMenu.destroy()),this.world.activeHandle&&e!==this.world.activeHandle&&this.world.activeHandle.destroy(),this.world.cursor&&e!==this.world.cursor.target&&this.world.stopEditing(),e.mouseMove||(this.morphToGrab=e.rootForGrab(),this.grabPosition=this.bounds.origin.copy()),o=2===t.button||t.ctrlKey?(this.mouseButton="right","mouseDownRight"):(this.mouseButton="left","mouseDownLeft");!e[o];)e=e.parent;e[o](this.bounds.origin)}},HandMorph.prototype.processTouchStart=function(t){var e=this;MorphicPreferences.isTouchDevice=!0,clearInterval(this.touchHoldTimeout),1===t.touches.length&&(this.touchHoldTimeout=setInterval(function(){e.processMouseDown({button:2}),e.processMouseUp({button:2}),t.preventDefault(),clearInterval(e.touchHoldTimeout)},400),this.processMouseMove(t.touches[0]),this.processMouseDown({button:0}),t.preventDefault())},HandMorph.prototype.processTouchMove=function(t){if(MorphicPreferences.isTouchDevice=!0,1===t.touches.length){var e=t.touches[0];this.processMouseMove(e),clearInterval(this.touchHoldTimeout)}},HandMorph.prototype.processTouchEnd=function(t){MorphicPreferences.isTouchDevice=!0,clearInterval(this.touchHoldTimeout),nop(t),this.processMouseUp({button:0})},HandMorph.prototype.processMouseUp=function(){var t,e,o,i=this.morphAtPointer();if(this.destroyTemporaries(),0!==this.children.length)this.drop();else{if("left"===this.mouseButton)o="mouseClickLeft";else if(o="mouseClickRight",this.mouseButton&&this.contextMenuEnabled){for(e=(t=i).contextMenu();!e&&t.parent;)e=(t=t.parent).contextMenu();e&&e.popUpAtHand(this.world)}for(;!i[o];)i=i.parent;i[o](this.bounds.origin)}this.mouseButton=null},HandMorph.prototype.processDoubleClick=function(){var t=this.morphAtPointer();if(this.destroyTemporaries(),0!==this.children.length)this.drop();else{for(;t&&!t.mouseDoubleClick;)t=t.parent;t&&t.mouseDoubleClick(this.bounds.origin)}this.mouseButton=null},HandMorph.prototype.processMouseMove=function(t){var e,o,i,r,n=getDocumentPositionOf(this.world.worldCanvas),s=this;e=new Point(t.pageX-n.x,t.pageY-n.y),this.setPosition(e),o=this.morphAtPointer().allParents(),!this.children.length&&this.mouseButton&&(i=(r=this.morphAtPointer()).rootForGrab(),r.mouseMove&&(r.mouseMove(e,this.mouseButton),"right"===this.mouseButton&&(this.contextMenuEnabled=!1)),"left"===this.mouseButton&&this.morphToGrab&&this.grabPosition.distanceTo(this.bounds.origin)>MorphicPreferences.grabThreshold&&(this.setPosition(this.grabPosition),this.morphToGrab.isDraggable?(i=this.morphToGrab,this.grab(i)):this.morphToGrab.isTemplate&&((i=this.morphToGrab.fullCopy()).isTemplate=!1,i.isDraggable=!0,i.reactToTemplateCopy&&i.reactToTemplateCopy(),this.grab(i),this.grabOrigin=this.morphToGrab.situation()),this.setPosition(e))),this.mouseOverList.forEach(function(t){contains(o,t)||(t.mouseLeave&&t.mouseLeave(),t.mouseLeaveDragging&&s.mouseButton&&t.mouseLeaveDragging())}),o.forEach(function(t){contains(s.mouseOverList,t)||(t.mouseEnter&&t.mouseEnter(),t.mouseEnterDragging&&s.mouseButton&&t.mouseEnterDragging()),0<s.children.length&&t instanceof ScrollFrameMorph&&t.enableAutoScrolling&&t.contents.allChildren().some(function(t){return t.wantsDropOf(s.children[0])})&&(t.bounds.insetBy(3*MorphicPreferences.scrollBarSize).containsPoint(s.bounds.origin)||t.startAutoScrolling())}),this.mouseOverList=o},HandMorph.prototype.processMouseScroll=function(t){for(var e=this.morphAtPointer();e&&!e.mouseScroll;)e=e.parent;e&&e.mouseScroll(t.detail/-3||(Object.prototype.hasOwnProperty.call(t,"wheelDeltaY")?t.wheelDeltaY/120:t.wheelDelta/120),t.wheelDeltaX/120||0)},HandMorph.prototype.processDrop=function(t){var e,o,i,r,n,s,a,h,l=t instanceof FileList?t:t.target.files||t.dataTransfer.files,p=t.dataTransfer?t.dataTransfer.getData("URL"):null,c=t.dataTransfer?t.dataTransfer.getData("Text/HTML"):null,u=this.morphAtPointer(),d=new Image;function g(t){for(var e=new Image,o=new FileReader;!u.droppedSVG;)u=u.parent;e.onload=function(){u.droppedSVG(e,t.name)},(o=new FileReader).onloadend=function(t){e.src=t.target.result},o.readAsDataURL(t)}function f(t){for(var e=new Image,o=new FileReader;!u.droppedImage;)u=u.parent;e.onload=function(){(r=newCanvas(new Point(e.width,e.height),!0)).getContext("2d").drawImage(e,0,0),u.droppedImage(r,t.name)},(o=new FileReader).onloadend=function(t){e.src=t.target.result},o.readAsDataURL(t)}function m(e){for(var o=new Audio,t=new FileReader;!u.droppedAudio;)u=u.parent;t.onloadend=function(t){o.src=t.target.result,u.droppedAudio(o,e.name)},t.readAsDataURL(e)}function y(e){for(var t=new FileReader;!u.droppedText;)u=u.parent;t.onloadend=function(t){u.droppedText(t.target.result,e.name,e.type)},t.readAsText(e)}function M(e){for(var t=new FileReader;!u.droppedBinary;)u=u.parent;t.onloadend=function(t){u.droppedBinary(t.target.result,e.name)},t.readAsArrayBuffer(e)}if(0<l.length)for(n=0;n<l.length;n+=1)o=(e=l[n]).name.slice(e.name.lastIndexOf(".")+1).toLowerCase(),-1===e.type.indexOf("svg")||MorphicPreferences.rasterizeSVGs?0===e.type.indexOf("image")?f(e):0===e.type.indexOf("audio")||-1<e.type.indexOf("ogg")?m(e):0===e.type.indexOf("text")||contains(["txt","csv","json"],o)?y(e):M(e):g(e);else if(p){if(contains(["gif","png","jpg","jpeg","bmp"],o=p.slice(p.lastIndexOf(".")+1).toLowerCase())){for(;!u.droppedImage;)u=u.parent;(d=new Image).onload=function(){(r=newCanvas(new Point(d.width,d.height),!0)).getContext("2d").drawImage(d,0,0),u.droppedImage(r)},d.src=p}else if("svg"===o&&!MorphicPreferences.rasterizeSVGs){for(;!u.droppedSVG;)u=u.parent;s=p,a=function(t){var e=new Image;e.onload=function(){u.droppedSVG(e,p.slice(p.lastIndexOf("/")+1,p.lastIndexOf(".")))},e.src="data:image/svg+xml;utf8,"+encodeURIComponent(t)},(h=new XMLHttpRequest).open("GET",s),h.onreadystatechange=function(){if(4===h.readyState){if(!h.responseText)throw new Error("unable to retrieve "+s);a(h.responseText)}},h.send()}}else if(c){for(;!u.droppedImage;)u=u.parent;(d=new Image).onload=function(){(r=newCanvas(new Point(d.width,d.height),!0)).getContext("2d").drawImage(d,0,0),u.droppedImage(r)},(i=function(t){var e,o,i="",r=t.indexOf('<img src="');if(-1===r)return null;for(e=r+=10;e<t.length;e+=1){if('"'===(o=t[e]))return i;i=i.concat(o)}return null}(c))&&(d.src=i)}},HandMorph.prototype.destroyTemporaries=function(){var e=this;this.temporaries.forEach(function(t){t.isClickable&&t.bounds.containsPoint(e.position())||(t.destroy(),e.temporaries.splice(e.temporaries.indexOf(t),1))})},WorldMorph.prototype=new FrameMorph,WorldMorph.prototype.constructor=WorldMorph,WorldMorph.uber=FrameMorph.prototype,WorldMorph.prototype.init=function(t,e){for(WorldMorph.uber.init.call(this),this.color=new Color(205,205,205),this.alpha=1,this.bounds=new Rectangle(0,0,t.width,t.height),this.drawNew(),this.isVisible=!0,this.isDraggable=!1,this.currentKey=null,this.worldCanvas=t,this.noticesTransparentClick=!0,this.stamp=Date.now();this.stamp===Date.now();)nop();this.stamp=Date.now(),this.useFillPage=e,void 0===this.useFillPage&&(this.useFillPage=!0),this.isDevMode=!1,this.broken=[],this.animations=[],this.hand=new HandMorph(this),this.keyboardReceiver=null,this.cursor=null,this.lastEditedText=null,this.activeMenu=null,this.activeHandle=null,this.virtualKeyboard=null,this.initEventListeners()},WorldMorph.prototype.brokenFor=function(t){var e=t.fullBounds();return this.broken.filter(function(t){return t.intersects(e)})},WorldMorph.prototype.fullDrawOn=function(t,e){WorldMorph.uber.fullDrawOn.call(this,t,e),this.hand.fullDrawOn(t,e)},WorldMorph.prototype.updateBroken=function(){var e=this;this.condenseDamages(),this.broken.forEach(function(t){t.extent().gt(new Point(0,0))&&e.fullDrawOn(e.worldCanvas,t)}),this.broken=[]},WorldMorph.prototype.stepAnimations=function(){this.animations.forEach(function(t){t.step()}),this.animations=this.animations.filter(function(t){return t.isActive})},WorldMorph.prototype.condenseDamages=function(){function t(t){var o,i=[];return t.forEach(function(e){(o=detect(i,function(t){return t.isNearTo(e,20)}))?o.mergeWith(e):i.push(e)}),i}for(var e=!0,o=this.broken.length;e;)this.broken=t(this.broken),e=this.broken.length<o,o=this.broken.length},WorldMorph.prototype.doOneCycle=function(){this.stepFrame(),this.stepAnimations(),this.updateBroken()},WorldMorph.prototype.fillPage=function(){var t=window.innerHeight,e=window.innerWidth,o=this;this.worldCanvas.style.position="absolute",this.worldCanvas.style.left="0px",this.worldCanvas.style.right="0px",this.worldCanvas.style.width="100%",this.worldCanvas.style.height="100%",document.documentElement.scrollTop&&(t=document.documentElement.clientHeight),document.documentElement.scrollLeft&&(e=document.documentElement.clientWidth),this.worldCanvas.width!==e&&(this.worldCanvas.width=e,this.setWidth(e)),this.worldCanvas.height!==t&&(this.worldCanvas.height=t,this.setHeight(t)),this.children.forEach(function(t){t.reactToWorldResize&&t.reactToWorldResize(o.bounds.copy())})},WorldMorph.prototype.getGlobalPixelColor=function(t){return this.hand.morphAtPointer().getPixelColor(this.hand.position())},WorldMorph.prototype.initVirtualKeyboard=function(){var e=this;this.virtualKeyboard&&(document.body.removeChild(this.virtualKeyboard),this.virtualKeyboard=null),MorphicPreferences.isTouchDevice&&MorphicPreferences.useVirtualKeyboard&&(this.virtualKeyboard=document.createElement("input"),this.virtualKeyboard.type="text",this.virtualKeyboard.style.color="transparent",this.virtualKeyboard.style.backgroundColor="transparent",this.virtualKeyboard.style.border="none",this.virtualKeyboard.style.outline="none",this.virtualKeyboard.style.position="absolute",this.virtualKeyboard.style.top="0px",this.virtualKeyboard.style.left="0px",this.virtualKeyboard.style.width="0px",this.virtualKeyboard.style.height="0px",this.virtualKeyboard.autocapitalize="none",document.body.appendChild(this.virtualKeyboard),this.virtualKeyboard.addEventListener("keydown",function(t){e.currentKey=t.keyCode,e.keyboardReceiver&&e.keyboardReceiver.processKeyDown(t),8===t.keyCode&&t.preventDefault(),9===t.keyCode&&(e.keyboardReceiver&&e.keyboardReceiver.processKeyPress(t),t.preventDefault())},!1),this.virtualKeyboard.addEventListener("keyup",function(t){e.currentKey=null,e.keyboardReceiver&&e.keyboardReceiver.processKeyUp&&e.keyboardReceiver.processKeyUp(t),t.preventDefault()},!1),this.virtualKeyboard.addEventListener("keypress",function(t){e.keyboardReceiver&&e.keyboardReceiver.processKeyPress(t),t.preventDefault()},!1))},WorldMorph.prototype.initEventListeners=function(){var e=this.worldCanvas,o=this;o.useFillPage?o.fillPage():this.changed(),e.addEventListener("mousedown",function(t){t.preventDefault(),e.focus(),o.hand.processMouseDown(t)},!1),e.addEventListener("touchstart",function(t){o.hand.processTouchStart(t)},!1),e.addEventListener("mouseup",function(t){t.preventDefault(),o.hand.processMouseUp(t)},!1),e.addEventListener("dblclick",function(t){t.preventDefault(),o.hand.processDoubleClick(t)},!1),e.addEventListener("touchend",function(t){o.hand.processTouchEnd(t)},!1),e.addEventListener("mousemove",function(t){o.hand.processMouseMove(t)},!1),e.addEventListener("touchmove",function(t){o.hand.processTouchMove(t)},!1),e.addEventListener("contextmenu",function(t){t.preventDefault()},!1),e.addEventListener("keydown",function(t){o.currentKey=t.keyCode,o.keyboardReceiver&&o.keyboardReceiver.processKeyDown(t),8===t.keyCode&&t.preventDefault(),9===t.keyCode&&(o.keyboardReceiver&&o.keyboardReceiver.processKeyPress(t),t.preventDefault()),(t.ctrlKey&&!t.altKey||t.metaKey)&&86!==t.keyCode&&t.preventDefault()},!1),e.addEventListener("keyup",function(t){o.currentKey=null,o.keyboardReceiver&&o.keyboardReceiver.processKeyUp&&o.keyboardReceiver.processKeyUp(t),t.preventDefault()},!1),e.addEventListener("keypress",function(t){o.keyboardReceiver&&o.keyboardReceiver.processKeyPress(t),t.preventDefault()},!1),e.addEventListener("mousewheel",function(t){o.hand.processMouseScroll(t),t.preventDefault()},!1),e.addEventListener("DOMMouseScroll",function(t){o.hand.processMouseScroll(t),t.preventDefault()},!1),document.body.addEventListener("paste",function(t){var e=t.clipboardData.getData("Text");e&&o.cursor&&o.cursor.insert(e)},!1),window.addEventListener("dragover",function(t){t.preventDefault()},!1),window.addEventListener("drop",function(t){o.hand.processDrop(t),t.preventDefault()},!1),window.addEventListener("resize",function(){o.useFillPage&&o.fillPage()},!1),window.onbeforeunload=function(t){var e=t||window.event,o="Are you sure you want to leave?";return e&&(e.returnValue=o),o}},WorldMorph.prototype.mouseDownLeft=nop,WorldMorph.prototype.mouseClickLeft=nop,WorldMorph.prototype.mouseDownRight=nop,WorldMorph.prototype.mouseClickRight=nop,WorldMorph.prototype.wantsDropOf=function(){return this.acceptsDrops},WorldMorph.prototype.droppedImage=function(){return null},WorldMorph.prototype.droppedSVG=function(){return null},WorldMorph.prototype.nextTab=function(t){var e=this.nextEntryField(t);e&&(t.clearSelection(),e.selectAll(),e.edit())},WorldMorph.prototype.previousTab=function(t){var e=this.previousEntryField(t);e&&(t.clearSelection(),e.selectAll(),e.edit())},WorldMorph.prototype.contextMenu=function(){var t;return t=this.isDevMode?new MenuMorph(this,this.constructor.name||this.constructor.toString().split(" ")[1].split("(")[0]):new MenuMorph(this,"Morphic"),this.isDevMode&&(t.addItem("demo...","userCreateMorph","sample morphs"),t.addLine(),t.addItem("hide all...","hideAll"),t.addItem("show all...","showAllHiddens"),t.addItem("move all inside...","keepAllSubmorphsWithin","keep all submorphs\nwithin and visible"),t.addItem("inspect...","inspect","open a window on\nall properties"),t.addItem("screenshot...",function(){window.open(this.fullImageClassic().toDataURL())},"open a new window\nwith a picture of this morph"),t.addLine(),t.addItem("restore display","changed","redraw the\nscreen once"),t.addItem("fill page...","fillPage","let the World automatically\nadjust to browser resizing"),useBlurredShadows?t.addItem("sharp shadows...","toggleBlurredShadows","sharp drop shadows\nuse for old browsers"):t.addItem("blurred shadows...","toggleBlurredShadows","blurry shades,\n use for new browsers"),t.addItem("color...",function(){this.pickColor(t.title+localize("\ncolor:"),this.setColor,this,this.color)},"choose the World's\nbackground color"),MorphicPreferences===standardSettings?t.addItem("touch screen settings","togglePreferences","bigger menu fonts\nand sliders"):t.addItem("standard settings","togglePreferences","smaller menu fonts\nand sliders"),t.addLine()),this.isDevMode?t.addItem("user mode...","toggleDevMode","disable developers'\ncontext menus"):t.addItem("development mode...","toggleDevMode"),t.addItem("about morphic.js...","about"),t},WorldMorph.prototype.userCreateMorph=function(){var e,t,o=this;function n(t){t.isDraggable=!0,t.pickUp(o)}(e=new MenuMorph(this,"make a morph")).addItem("rectangle",function(){n(new Morph)}),e.addItem("box",function(){n(new BoxMorph)}),e.addItem("circle box",function(){n(new CircleBoxMorph)}),e.addLine(),e.addItem("slider",function(){n(new SliderMorph)}),e.addItem("frame",function(){(t=new FrameMorph).setExtent(new Point(350,250)),n(t)}),e.addItem("scroll frame",function(){(t=new ScrollFrameMorph).contents.acceptsDrops=!0,t.contents.adjustBounds(),t.setExtent(new Point(350,250)),n(t)}),e.addItem("handle",function(){n(new HandleMorph)}),e.addLine(),e.addItem("string",function(){(t=new StringMorph("Hello, World!")).isEditable=!0,n(t)}),e.addItem("text",function(){(t=new TextMorph("Ich weiß nicht, was soll es bedeuten, dass ich so traurig bin, ein Märchen aus uralten Zeiten, das kommt mir nicht aus dem Sinn. Die Luft ist kühl und es dunkelt, und ruhig fließt der Rhein; der Gipfel des Berges funkelt im Abendsonnenschein. Die schönste Jungfrau sitzet dort oben wunderbar, ihr gold'nes Geschmeide blitzet, sie kämmt ihr goldenes Haar, sie kämmt es mit goldenem Kamme, und singt ein Lied dabei; das hat eine wundersame, gewalt'ge Melodei. Den Schiffer im kleinen Schiffe, ergreift es mit wildem Weh; er schaut nicht die Felsenriffe, er schaut nur hinauf in die Höh'. Ich glaube, die Wellen verschlingen am Ende Schiffer und Kahn, und das hat mit ihrem Singen, die Loreley getan.")).isEditable=!0,t.maxWidth=300,t.drawNew(),n(t)}),e.addItem("speech bubble",function(){n(t=new SpeechBubbleMorph("Hello, World!"))}),e.addLine(),e.addItem("gray scale palette",function(){n(new GrayPaletteMorph)}),e.addItem("color palette",function(){n(new ColorPaletteMorph)}),e.addItem("color picker",function(){n(new ColorPickerMorph)}),e.addLine(),e.addItem("sensor demo",function(){(t=new MouseSensorMorph).setColor(new Color(230,200,100)),t.edge=35,t.border=15,t.borderColor=new Color(200,100,50),t.alpha=.2,t.setExtent(new Point(100,100)),n(t)}),e.addItem("animation demo",function(){var t,e,o,i,r;(t=new BouncerMorph).setPosition(new Point(50,20)),t.setExtent(new Point(300,200)),t.alpha=.9,t.speed=3,(e=new BouncerMorph).setColor(new Color(50,50,50)),e.setPosition(new Point(80,80)),e.setExtent(new Point(80,250)),e.type="horizontal",e.direction="right",e.alpha=.9,e.speed=5,(o=new BouncerMorph).setColor(new Color(20,20,20)),o.setPosition(new Point(90,140)),o.setExtent(new Point(40,30)),o.type="horizontal",o.direction="right",o.speed=3,(i=new BouncerMorph).setColor(new Color(200,20,20)),i.setPosition(new Point(90,140)),i.setExtent(new Point(20,20)),i.type="vertical",i.direction="up",i.speed=8,(r=new BouncerMorph).setColor(new Color(20,200,20)),r.setPosition(new Point(120,140)),r.setExtent(new Point(20,20)),r.type="vertical",r.direction="down",r.speed=4,e.add(i),e.add(o),t.add(r),t.add(e),n(t)}),e.addItem("pen",function(){n(new PenMorph)}),o.customMorphs&&(e.addLine(),o.customMorphs().forEach(function(t){e.addItem(t.toString(),function(){n(t)})})),e.popUpAtHand(this)},WorldMorph.prototype.toggleDevMode=function(){this.isDevMode=!this.isDevMode},WorldMorph.prototype.hideAll=function(){this.children.forEach(function(t){t.hide()})},WorldMorph.prototype.showAllHiddens=function(){this.forAllChildren(function(t){t.isVisible||t.show()})},WorldMorph.prototype.about=function(){var t,e="";for(t in modules)Object.prototype.hasOwnProperty.call(modules,t)&&(e+="\n"+t+" ("+modules[t]+")");""!==e&&(e="\n\nmodules:\n\nmorphic ("+morphicVersion+")"+e),this.inform("morphic.js\n\na lively Web GUI\ninspired by Squeak\n"+morphicVersion+"\n\nwritten by Jens Mönig\njens@moenig.org"+e)},WorldMorph.prototype.edit=function(t){var e=getDocumentPositionOf(this.worldCanvas);if(!t.isEditable)return null;this.cursor&&this.cursor.destroy(),this.cursor=new CursorMorph(t),t.parent.add(this.cursor),this.keyboardReceiver=this.cursor,this.initVirtualKeyboard(),MorphicPreferences.isTouchDevice&&MorphicPreferences.useVirtualKeyboard&&(this.virtualKeyboard.style.top=this.cursor.top()+e.y+"px",this.virtualKeyboard.style.left=this.cursor.left()+e.x+"px",this.virtualKeyboard.focus()),MorphicPreferences.useSliderForInput&&(t.parentThatIsA(MenuMorph)||this.slide(t)),this.lastEditedText!==t&&t.escalateEvent("freshTextEdit",t),this.lastEditedText=t},WorldMorph.prototype.slide=function(e){var t,o,i=parseFloat(e.text);isNaN(i)&&(i=0),t=new MenuMorph,(o=new SliderMorph(i-25,i+25,i,10,"horizontal")).alpha=1,o.color=new Color(225,225,225),o.button.color=t.borderColor,o.button.highlightColor=o.button.color.copy(),o.button.highlightColor.b+=100,o.button.pressColor=o.button.color.copy(),o.button.pressColor.b+=150,o.silentSetHeight(MorphicPreferences.scrollBarSize),o.silentSetWidth(10*MorphicPreferences.menuFontSize),o.drawNew(),o.action=function(t){e.changed(),e.text=Math.round(t).toString(),e.drawNew(),e.changed(),e.escalateEvent("reactToSliderEdit",e)},t.items.push(o),t.popup(this,e.bottomLeft().add(new Point(0,5)))},WorldMorph.prototype.stopEditing=function(){this.cursor&&(this.cursor.target.escalateEvent("reactToEdit",this.cursor.target),this.cursor.target.clearSelection(),this.cursor.destroy(),this.cursor=null),this.keyboardReceiver=null,this.virtualKeyboard&&(this.virtualKeyboard.blur(),document.body.removeChild(this.virtualKeyboard),this.virtualKeyboard=null),this.lastEditedText=null,this.worldCanvas.focus()},WorldMorph.prototype.toggleBlurredShadows=function(){useBlurredShadows=!useBlurredShadows},WorldMorph.prototype.togglePreferences=function(){MorphicPreferences=MorphicPreferences===standardSettings?touchScreenSettings:standardSettings},modules.locale="2017-January-13";var SnapTranslator=new Localizer,VideoMotion,PushButtonMorph,ToggleButtonMorph,TabMorph,ToggleMorph,ToggleElementMorph,DialogBoxMorph,AlignmentMorph,InputFieldMorph,SyntaxElementMorph,BlockMorph,CommandBlockMorph,ReporterBlockMorph,ScriptsMorph,ArgMorph,CommandSlotMorph,CSlotMorph,InputSlotMorph,BooleanSlotMorph,ArrowMorph,ColorSlotMorph,HatBlockMorph,BlockHighlightMorph,MultiArgMorph,TemplateSlotMorph,FunctionSlotMorph,ReporterSlotMorph,RingMorph,RingCommandSlotMorph,RingReporterSlotMorph,SymbolMorph,CommentMorph,ArgLabelMorph,TextSlotMorph,ScriptFocusMorph;function localize(t){return SnapTranslator.translate(t)}function Localizer(t,e){this.language=t||"en",this.dict=e||{}}function VideoMotion(t,e){this.width=t,this.height=e,this.frameNumber=0,this.winSize=8,this.lastAnalyzedFrame=0,this.motionAmount=0,this.motionDirection=0,this.imageBuffer=new ArrayBuffer(this.width*this.height*2),this.curr=new Uint8ClampedArray(this.imageBuffer,0,this.width*this.height),this.prev=new Uint8ClampedArray(this.imageBuffer,this.width*this.height,this.width*this.height),this.threshold=30,this.amountScale=100,this.toDegree=180/Math.PI}function PushButtonMorph(t,e,o,i,r,n){this.init(t,e,o,i,r,n)}function ToggleButtonMorph(t,e,o,i,r,n,s,a,h,l,p){this.init(t,e,o,i,r,n,s,a,h,l,p)}function TabMorph(t,e,o,i,r,n,s){this.init(t,e,o,i,r,n,s)}function ToggleMorph(t,e,o,i,r,n,s,a,h,l){this.init(t,e,o,i,r,n,s,a,h,l)}function ToggleElementMorph(t,e,o,i,r,n,s,a){this.init(t,e,o,i,r,n,s,a)}function DialogBoxMorph(t,e,o){this.init(t,e,o)}function AlignmentMorph(t,e){this.init(t,e)}function InputFieldMorph(t,e,o,i){this.init(t,e,o,i)}function SyntaxElementMorph(){this.init()}function BlockMorph(){this.init()}function CommandBlockMorph(){this.init()}function HatBlockMorph(){this.init()}function ReporterBlockMorph(t){this.init(t)}function RingMorph(){this.init()}function ScriptsMorph(t){this.init(t)}function ArgMorph(t){this.init(t)}function CommandSlotMorph(){this.init()}function RingCommandSlotMorph(){this.init()}function CSlotMorph(){this.init()}function InputSlotMorph(t,e,o,i){this.init(t,e,o,i)}function TemplateSlotMorph(t){this.init(t)}function BooleanSlotMorph(t){this.init(t)}function ArrowMorph(t,e,o,i){this.init(t,e,o,i)}function TextSlotMorph(t,e,o,i){this.init(t,e,o,i)}function SymbolMorph(t,e,o,i,r){this.init(t,e,o,i,r)}function ColorSlotMorph(t){this.init(t)}function BlockHighlightMorph(){this.init()}function MultiArgMorph(t,e,o,i,r,n,s,a,h){this.init(t,e,o,i,r,n,s,a,h)}function ArgLabelMorph(t,e){this.init(t,e)}function FunctionSlotMorph(t){this.init(t)}function ReporterSlotMorph(t){this.init(t)}function RingReporterSlotMorph(t){this.init(t)}function CommentMorph(t){this.init(t)}function ScriptFocusMorph(t,e,o){this.init(t,e,o)}function MultiHintArgMorph(t,e,o,i,r,n,s,a,h){this.init(t,e,o,i,r,n,s,a,h)}function StructInputSlotMorph(t,e,o,i,r){this.fields=[],this.fieldContent=[],this.getFieldNames="string"==typeof i?this[i]:i||nop,InputSlotMorph.call(this,t,e,o,r),this.isStatic=!0}function RPCInputSlotMorph(){StructInputSlotMorph.call(this,null,!1,"methodSignature",function(t){if((!this.fieldsFor||!this.fieldsFor[t])&&(this.methodSignature(),!!!this.fieldsFor)){var e='Service "'+this.getRPCName()+'" is not available';world.children[0].showMessage&&world.children[0].showMessage(e),this.fieldsFor={}}return this.fieldsFor[t]?this.fieldsFor[t].args.map(function(t){return t.name}):null},!0)}function HintInputSlotMorph(t,e,o){var i=this;this.hintText=e,this.empty=!0,InputSlotMorph.call(this,t,o),this.contents().mouseClickLeft=function(){i.empty&&(this.text=""),StringMorph.prototype.mouseClickLeft.apply(this,arguments)}}Localizer.prototype.translate=function(t){return Object.prototype.hasOwnProperty.call(this.dict[this.language],t)?this.dict[this.language][t]:t},Localizer.prototype.languages=function(){var t,e=[];for(t in this.dict)Object.prototype.hasOwnProperty.call(this.dict,t)&&e.push(t);return e.sort()},Localizer.prototype.languageName=function(t){return this.dict[t].language_name||t},Localizer.prototype.credits=function(){var e="",o=this;return this.languages().forEach(function(t){e=e+"\n"+o.languageName(t)+" ("+t+") - "+o.dict[t].language_translator+" - "+o.dict[t].last_changed}),e},Localizer.prototype.unload=function(){var o,i=["language_name","language_translator","last_changed"],r=this;this.languages().forEach(function(t){var e;if("en"!==t)for(e in o=r.dict[t])Object.prototype.hasOwnProperty.call(o,e)&&!contains(i,e)&&delete o[e]})},SnapTranslator.dict.en={language_name:"English",language_translator:"Jens Mönig","translator_e-mail":"jens@moenig.org",last_changed:"2015-12-22",any:"random","file menu import hint":"load an exported project file\nor block library, a costume\nor a sound","settings menu prefer empty slots hint":"check to focus on empty slots\nwhen dragging & dropping reporters","costumes tab help":"import a picture from another web page or from\na file on your computer by dropping it here\n","block deletion dialog text":"Are you sure you want to delete this\ncustom block and all its instances?","download to disk text":"This item could not be opened in a new tab.\nIt has been saved to your browser's downloads folder.","unable to export text":"This item could not be exported from Snap!.\nIt's likely that your project may contain a lot of media (sounds and images) or that you are using an older browser.Please try using a recent version of Chrome, Firefox, or Safari."},SnapTranslator.dict.de={language_name:"Deutsch",language_translator:"Jens Mönig","translator_e-mail":"jens@moenig.org",last_changed:"2017-01-10"},SnapTranslator.dict.it={language_name:"Italiano",language_translator:"Stefano Federici, Alberto Firpo, Massimo Ghisalberti","translator_e-mail":"s_federici@yahoo.com, albertofirpo12@gmail.com, zairik@gmail.com",last_changed:"2016-05-10"},SnapTranslator.dict.ja={language_name:"日本語",language_translator:"Kazuhiro Abe","translator_e-mail":"abee@squeakland.jp",last_changed:"2012-04-02"},SnapTranslator.dict.ja_HIRA={language_name:"にほんご",language_translator:"Kazuhiro Abe","translator_e-mail":"abee@squeakland.jp",last_changed:"2012-04-02"},SnapTranslator.dict.ko={language_name:"한국어",language_translator:"Yunjae Jang","translator_e-mail":"janggoons@gmail.com",last_changed:"2015-01-21"},SnapTranslator.dict.pt={language_name:"Português",language_translator:"Manuel Menezes de Sequeira","translator_e-mail":"mmsequeira@gmail.com",last_changed:"2016-10-30"},SnapTranslator.dict.cs={language_name:"Česky",language_translator:"Michal Moc, Jan Tomsa","translator_e-mail":"info@iguru.eu, jan.tomsa.1976@gmail.com",last_changed:"2015-11-16"},SnapTranslator.dict.zh_CN={language_name:"简体中文",language_translator:"五百刀/邓江华","translator_e-mail":"ubertao@qq.com/djh@rhjxx.cn",last_changed:"2016-05-09"},SnapTranslator.dict.eo={language_name:"Esperanto",language_translator:"Sebastian Cyprych","translator_e-mail":"scy(ĉe)epf.pl",last_changed:"2012-11-11"},SnapTranslator.dict.fr={language_name:"Français",language_translator:"Jean-Jacques Valliet, Mark Rafter, Martin Quinson, Damien Caselli","translator_e-mail":"i.scool@mac.com",last_changed:"2016-10-27"},SnapTranslator.dict.si={language_name:"Slovenščina",language_translator:"Sasa Divjak, Gorazd Breskvar","translator_e-mail":"sasa.divjak@fri.uni-lj.si",last_changed:"2016-04-22"},SnapTranslator.dict.ru={language_name:"Русский",language_translator:"Svetlana Ptashnaya, Проскурнёв Артём","translator_e-mail":"svetlanap@berkeley.edu, tema@school830.ru",last_changed:"2016-06-21"},SnapTranslator.dict.es={language_name:"Español",language_translator:"Víctor Manuel Muratalla Morales","translator_e-mail":"victor.muratalla@yahoo.com",last_changed:"2013-03-25"},SnapTranslator.dict.nl={language_name:"Nederlands",language_translator:"Frank Sierens, Sjoerd Dirk Meijer","translator_e-mail":"frank.sierens@telenet.be, sjoerddirk@fromScratchEd.nl",last_changed:"2015-12-15"},SnapTranslator.dict.pl={language_name:"Polski",language_translator:"Witek Kranas & deKrain","translator_e-mail":"witek@oeiizk.waw.pl",last_changed:"2016-11-14"},SnapTranslator.dict.zh_TW={language_name:"繁體中文",language_translator:"cch","translator_e-mail":"cchuang2009@gmail.com",last_changed:"2013-8-14"},SnapTranslator.dict.no={language_name:"Norsk",language_translator:"Olav A Marschall","translator_e-mail":"mattebananer@gmail.com",last_changed:"2013-09-16"},SnapTranslator.dict.dk={language_name:"Dansk",language_translator:"FAB, Pelle Hjek","translator_e-mail":"fab@nielsen.mail.dk, hjek@mail.com",last_changed:"2016-11-16"},SnapTranslator.dict.el={language_name:"Ελληνικά",language_translator:"Ino Samaras","translator_e-mail":"ino.samaras@berkeley.edu",last_changed:"2013-09-16"},SnapTranslator.dict.ca={language_name:"Català",language_translator:"Bernat Romagosa Carrasquer, Joan Guillén i Pelegay","translator_e-mail":"bernat@arduino.org, jguille2@xtec.cat",last_changed:"2017-01-09"},SnapTranslator.dict.fi={language_name:"suomi",language_translator:"Jouni K. Seppänen","translator_e-mail":"jks@iki.fi",last_changed:"2014-04-18"},SnapTranslator.dict.sv={language_name:"svenska",language_translator:"Erik A. Olsson","translator_e-mail":"eolsson@gmail.com",last_changed:"2016-06-09"},SnapTranslator.dict.pt_BR={language_name:"Português do Brasil",language_translator:"Aldo von Wangenheim","translator_e-mail":"awangenh@inf.ufsc.br",last_changed:"2014-04-20"},SnapTranslator.dict.bn={language_name:"বাংলা",language_translator:"Dr. Mokter Hossain","translator_e-mail":"mokter@gmail.com",last_changed:"2014-07-02"},SnapTranslator.dict.kn={language_name:"ಕನ್ನಡ",language_translator:"Vinayakumar R","translator_e-mail":"vnkmr7620@gmail.com",last_changed:"2014-12-02"},SnapTranslator.dict.ml={language_name:"Malayalam",language_translator:"vinayakumar R","translator_e-mail":"vnkmr7620@gmail.com",last_changed:"2015-02-20"},SnapTranslator.dict.ta={language_name:"Tamil",language_translator:"vinayakumar R","translator_e-mail":"vnkmr7620@gmail.com",last_changed:"2015-02-20"},SnapTranslator.dict.te={language_name:"Telagu",language_translator:"vinayakumar R","translator_e-mail":"vnkmr7620@gmail.com",last_changed:"2015-02-20"},SnapTranslator.dict.tr={language_name:"Türkçe",language_translator:"Hakan Atas","translator_e-mail":"hakanatas@gmail.com",last_changed:"2015-7-27"},SnapTranslator.dict.hu={language_name:"Magyar",language_translator:"Makány György","translator_e-mail":"makany.gyorgy@gmail.com",last_changed:"2015-07-27"},SnapTranslator.dict.ia={language_name:"Interlingua",language_translator:"Ken Dickey","translator_e-mail":"Ken.Dickey@whidbey.com",last_changed:"2015-08-09"},SnapTranslator.dict.hr={language_name:"Hrvatski",language_translator:"Željko Hrvoj","translator_e-mail":"zeljko.hrvoj@zg.t-com.hr",last_changed:"2015-09-15"},SnapTranslator.dict.bg={language_name:"Български",language_translator:"Ivan Savov","translator_e-mail":"ivan.savov@gmail.com",last_changed:"2015-11-16"},SnapTranslator.dict.ro={language_name:"Român",language_translator:"Cristian Macarascu","translator_e-mail":"",last_changed:"2015-10-24"},SnapTranslator.dict.ar={language_name:"العربية",language_translator:"طارق جلال","translator_e-mail":"tarekgalal46@hotmail.com",last_changed:"2016-02-24"},SnapTranslator.dict.id={language_name:"Bahasa Indonesia",language_translator:"Alexander Raphael Liu","translator_e-mail":"raphaxander@gmail.com",last_changed:"2016-5-2"},SnapTranslator.dict.et={language_name:"Eesti",language_translator:"Hasso Tepper","translator_e-mail":"hasso.tepper@gmail.com",last_changed:"2016-05-03"},SnapTranslator.dict.gl={language_name:"Galego",language_translator:"tecnoloxia","translator_e-mail":"",last_changed:"2016-11-09"},modules.video="2019-May-22",VideoMotion.prototype.reset=function(t,e){this.width=t,this.height=e,this.frameNumber=0,this.lastAnalyzedFrame=0,this.imageBuffer=new ArrayBuffer(this.width*this.height*2),this.curr=new Uint8ClampedArray(this.imageBuffer,0,this.width*this.height),this.prev=new Uint8ClampedArray(this.imageBuffer,this.width*this.height,this.width*this.height)},VideoMotion.prototype.addFrame=function(t){var e,o=this.prev,i=new Uint32Array(t.buffer.slice(0));for(this.frameNumber++,this.prev=this.curr,this.curr=o,e=0;e<i.length;e++)this.curr[e]=255&i[e]},VideoMotion.prototype.getStageMotion=function(){var t,e,o,i,r,n,s,a,h,l,p,c,u,d=0,g=0,f=0,m={u:0,v:0},y=2*this.winSize+1,M=this.width-this.winSize-1,b=this.height-this.winSize-1;if(this.curr&&this.prev){if(this.lastAnalyzedFrame!==this.frameNumber){for(this.lastAnalyzedFrame=this.frameNumber,t=this.winSize+1;t<b;t+=y)for(e=this.winSize+1;e<M;e+=y){for(l=h=a=s=n=0,i=(o=(t-this.winSize)*this.width+e-this.winSize)+y,r=(t+this.winSize)*this.width+e+this.winSize;o<=r;o+=this.width-y,i+=this.width)for(;o<=i;o+=1)u=this.prev[o]-this.curr[o],n+=(p=this.curr[o-1]-this.curr[o+1])*p,s+=p*(c=this.curr[o-this.width]-this.curr[o+this.width]),a+=c*c,l+=p*u,h+=c*u;-y<(m=this.getMotionVector(n,s,a,l,h)).u&&m.u<y&&-y<m.v&&m.v<y&&(d+=m.u,g+=m.v,f++)}d/=f,g/=f,this.motionAmount=Math.round(this.amountScale*Math.hypot(d,g)),this.motionAmount>this.threshold&&(this.motionDirection=((Math.atan2(g,d)*this.toDegree+270)%360-180).toFixed(2))}}else this.motionAmount=this.motionDirection=-1},VideoMotion.prototype.getMotionVector=function(t,e,o,i,r){var n,s,a,h,l,p=e*e-t*o,c={u:0,v:0};return c.v=p?(a=-(r*e-i*o),h=-(e*i-t*r),l=8/p,c.u=a*l,h*l):(n=(e+t)*(e+t)+(o+e)*(o+e))?(s=8/n,c.u=(e+t)*(-(r+i)*s),(o+e)*(-(r+i)*s)):c.u=0,c},VideoMotion.prototype.getLocalMotion=function(t){var e,o,i,r,n,s,a,h,l,p,c,u,d=t.parentThatIsA(StageMorph),g=0,f=Math.floor(t.width()/d.scale),m=this.winSize,y={u:0,v:0},M=0,b=0,S=0,w=0,C=0,v=this.threshold/3,x=2e-4*this.amountScale,k=0,B=0;if(this.curr&&this.prev){if(t.frameNumber!==this.frameNumber){for(p=t.getImageData(),c=function(t){var e=t.parentThatIsA(StageMorph),o=e.scale,i={sx:0,sy:0,sw:Math.floor(t.extent().x/o),sh:Math.floor(t.extent().y/o)};t.left()<e.left()&&(i.sw=Math.max(Math.floor((t.right()-e.left())/o),0),i.sx=Math.floor(t.width()/o-i.sw));t.right()>e.right()&&(i.sw=Math.max(Math.floor((e.right()-t.left())/o),0));t.top()<e.top()&&(i.sh=Math.max(Math.floor((t.bottom()-e.top())/o),0),i.sy=Math.floor(t.height()/o-i.sh));t.bottom()>e.bottom()&&(i.sh=Math.max(Math.floor((e.bottom()-t.top())/o),0));return i}(t),i=Math.max(Math.floor((t.left()-d.left())/d.scale),0),n=Math.max(Math.floor((t.top()-d.top())/d.scale),0),r=Math.min(c.sw+i,d.dimensions.x),s=Math.min(c.sh+n,d.dimensions.y-1),u=c.sy*f+c.sx,e=n;e<s;e++,u+=f-c.sw)for(o=i;o<r;o++,++u)0<o&&o<this.width&&0<e&&e<this.height&&255==(p[u]>>24&255)&&(B=e*this.width+o,a=this.prev[B]-this.curr[B],M+=(h=this.curr[B-1]-this.curr[B+1])*h,b+=h*(l=this.curr[B-this.width]-this.curr[B+this.width]),S+=l*l,C+=h*a,w+=l*a,k++);y=this.getMotionVector(M,b,S,C,w),k&&(g=k,k/=2*m*2*m,y.u=y.u/k,y.v=y.v/k),t.motionAmount=Math.round(x*g*Math.hypot(y.u,y.v)),100<t.motionAmount&&(t.motionAmount=Math.min(100,100)),t.motionAmount>v&&(t.motionDirection=((Math.atan2(y.v,y.u)*this.toDegree+270)%360-180).toFixed(2)),t.frameNumber=this.frameNumber}}else t.motionAmount=t.motionDirection=-1},modules.widgets="2017-January-03",PushButtonMorph.prototype=new TriggerMorph,PushButtonMorph.prototype.constructor=PushButtonMorph,PushButtonMorph.uber=TriggerMorph.prototype,PushButtonMorph.prototype.fontSize=10,PushButtonMorph.prototype.fontStyle="sans-serif",PushButtonMorph.prototype.labelColor=new Color(0,0,0),PushButtonMorph.prototype.disabledColor=new Color(75,75,75),PushButtonMorph.prototype.labelShadowColor=new Color(255,255,255),PushButtonMorph.prototype.labelShadowOffset=new Point(1,1),PushButtonMorph.prototype.color=new Color(220,220,220),PushButtonMorph.prototype.pressColor=new Color(115,180,240),PushButtonMorph.prototype.highlightColor=PushButtonMorph.prototype.pressColor.lighter(50),PushButtonMorph.prototype.outlineColor=new Color(30,30,30),PushButtonMorph.prototype.outlineGradient=!1,PushButtonMorph.prototype.contrast=60,PushButtonMorph.prototype.edge=2,PushButtonMorph.prototype.corner=5,PushButtonMorph.prototype.outline=1.00001,PushButtonMorph.prototype.padding=3,PushButtonMorph.prototype.init=function(t,e,o,i,r,n){this.is3D=!1,this.target=t||null,this.action=e||null,this.environment=i||null,this.labelString=o||null,this.label=null,this.labelMinExtent=new Point(0,0),this.hint=r||null,this.template=n||null,TriggerMorph.uber.init.call(this),this.disabled=!1,this.enabledColor=PushButtonMorph.prototype.labelColor,this.disabledColor=PushButtonMorph.prototype.disabledColor,this.color=PushButtonMorph.prototype.color,this.drawNew(),this.fixLayout()},PushButtonMorph.prototype.fixLayout=function(){if(null!==this.label){var t=2*this.padding+2*this.outline+2*this.edge;this.setExtent(new Point(Math.max(this.label.width(),this.labelMinExtent.x)+t,Math.max(this.label instanceof StringMorph?this.label.rawHeight():this.label.height(),this.labelMinExtent.y)+t)),this.label.setCenter(this.center())}},PushButtonMorph.prototype.mouseDownLeft=function(){PushButtonMorph.uber.mouseDownLeft.call(this),this.label&&this.label.setCenter(this.center().add(1))},PushButtonMorph.prototype.mouseClickLeft=function(){PushButtonMorph.uber.mouseClickLeft.call(this),this.label&&this.label.setCenter(this.center())},PushButtonMorph.prototype.mouseLeave=function(){PushButtonMorph.uber.mouseLeave.call(this),this.label&&this.label.setCenter(this.center())},PushButtonMorph.prototype.outlinePath=BoxMorph.prototype.outlinePath,PushButtonMorph.prototype.drawOutline=function(t){var e,o=MorphicPreferences.isFlat&&!this.is3D;if(!this.outline||o)return null;this.outlineGradient?((e=t.createLinearGradient(0,0,0,this.height())).addColorStop(0,this.outlineColor.darker().toString()),e.addColorStop(1,"white")):e=this.outlineColor.toString(),t.fillStyle=e,t.beginPath(),this.outlinePath(t,o?0:this.corner,0),t.closePath(),t.fill()},PushButtonMorph.prototype.drawBackground=function(t,e){var o=MorphicPreferences.isFlat&&!this.is3D;t.fillStyle=e.toString(),t.beginPath(),this.outlinePath(t,o?0:Math.max(this.corner-this.outline,0),this.outline),t.closePath(),t.fill(),t.lineWidth=this.outline},PushButtonMorph.prototype.drawEdges=function(t,e,o,i){if(!MorphicPreferences.isFlat||this.is3D){var r,n=Math.max(this.corner,this.outline+this.edge),s=this.width(),a=this.height();(r=t.createLinearGradient(0,this.outline,0,this.outline+this.edge)).addColorStop(0,o.toString()),r.addColorStop(1,e.toString()),t.strokeStyle=r,t.lineCap="round",t.lineWidth=this.edge,t.beginPath(),t.moveTo(n,this.outline+this.edge/2),t.lineTo(s-n,this.outline+this.edge/2),t.stroke(),(r=t.createRadialGradient(this.corner,this.corner,Math.max(this.corner-this.outline-this.edge,0),this.corner,this.corner,Math.max(this.corner-this.outline,0))).addColorStop(0,e.toString()),r.addColorStop(1,o.toString()),t.strokeStyle=r,t.lineCap="round",t.lineWidth=this.edge,t.beginPath(),t.arc(this.corner,this.corner,Math.max(this.corner-this.outline-this.edge/2,0),radians(180),radians(270),!1),t.stroke(),(r=t.createLinearGradient(this.outline,0,this.outline+this.edge,0)).addColorStop(0,o.toString()),r.addColorStop(1,e.toString()),t.strokeStyle=r,t.lineCap="round",t.lineWidth=this.edge,t.beginPath(),t.moveTo(this.outline+this.edge/2,n),t.lineTo(this.outline+this.edge/2,a-n),t.stroke(),(r=t.createLinearGradient(0,a-this.outline,0,a-this.outline-this.edge)).addColorStop(0,i.toString()),r.addColorStop(1,e.toString()),t.strokeStyle=r,t.lineCap="round",t.lineWidth=this.edge,t.beginPath(),t.moveTo(n,a-this.outline-this.edge/2),t.lineTo(s-n,a-this.outline-this.edge/2),t.stroke(),(r=t.createRadialGradient(s-this.corner,a-this.corner,Math.max(this.corner-this.outline-this.edge,0),s-this.corner,a-this.corner,Math.max(this.corner-this.outline,0))).addColorStop(0,e.toString()),r.addColorStop(1,i.toString()),t.strokeStyle=r,t.lineCap="round",t.lineWidth=this.edge,t.beginPath(),t.arc(s-this.corner,a-this.corner,Math.max(this.corner-this.outline-this.edge/2,0),radians(0),radians(90),!1),t.stroke(),(r=t.createLinearGradient(s-this.outline,0,s-this.outline-this.edge,0)).addColorStop(0,i.toString()),r.addColorStop(1,e.toString()),t.strokeStyle=r,t.lineCap="round",t.lineWidth=this.edge,t.beginPath(),t.moveTo(s-this.outline-this.edge/2,n),t.lineTo(s-this.outline-this.edge/2,a-n),t.stroke()}},PushButtonMorph.prototype.createBackgrounds=function(){var t,e=this.extent();if(this.template)return this.image=this.template.image,this.normalImage=this.template.normalImage,this.highlightImage=this.template.highlightImage,this.pressImage=this.template.pressImage,null;this.normalImage=newCanvas(e),t=this.normalImage.getContext("2d"),this.drawOutline(t),this.drawBackground(t,this.color),this.drawEdges(t,this.color,this.color.lighter(this.contrast),this.color.darker(this.contrast)),this.highlightImage=newCanvas(e),t=this.highlightImage.getContext("2d"),this.drawOutline(t),this.drawBackground(t,this.highlightColor),this.drawEdges(t,this.highlightColor,this.highlightColor.lighter(this.contrast),this.highlightColor.darker(this.contrast)),this.pressImage=newCanvas(e),t=this.pressImage.getContext("2d"),this.drawOutline(t),this.drawBackground(t,this.pressColor),this.drawEdges(t,this.pressColor,this.pressColor.darker(this.contrast),this.pressColor.lighter(this.contrast)),this.image=this.normalImage},PushButtonMorph.prototype.createLabel=function(){var t=!MorphicPreferences.isFlat||this.is3D;null!==this.label&&this.label.destroy(),this.labelString instanceof SymbolMorph?(this.label=this.labelString.fullCopy(),t&&(this.label.shadowOffset=this.labelShadowOffset,this.label.shadowColor=this.labelShadowColor),this.label.color=this.labelColor,this.label.drawNew()):this.label=new StringMorph(localize(this.labelString),this.fontSize,this.fontStyle,!0,!1,!1,t?this.labelShadowOffset:null,this.labelShadowColor,this.labelColor),this.add(this.label)},PushButtonMorph.prototype.trigger=function(){this.disabled||PushButtonMorph.uber.trigger.call(this)},PushButtonMorph.prototype.mouseDownLeft=function(){this.disabled||PushButtonMorph.uber.mouseDownLeft.call(this)},PushButtonMorph.prototype.mouseClickLeft=function(){this.disabled||PushButtonMorph.uber.mouseClickLeft.call(this)},PushButtonMorph.prototype.disable=function(){this.disabled||(this.enabledColor!==this.labelColor&&(this.enabledColor=this.labelColor),this.labelColor=this.disabledColor,this.drawNew(),this.fixLayout()),this.disabled=!0},PushButtonMorph.prototype.enable=function(){this.labelString instanceof SymbolMorph&&(this.labelColor=this.enabledColor,this.drawNew(),this.fixLayout()),this.disabled=!1},PushButtonMorph.prototype.isEnabled=function(){return!this.disabled},ToggleButtonMorph.prototype=new PushButtonMorph,ToggleButtonMorph.prototype.constructor=ToggleButtonMorph,ToggleButtonMorph.uber=PushButtonMorph.prototype,ToggleButtonMorph.prototype.contrast=30,ToggleButtonMorph.prototype.init=function(t,e,o,i,r,n,s,a,h,l,p){this.state=!1,this.query=r||function(){return!0},this.minWidth=h||null,this.hasPreview=l||!1,this.isPicture=p||!1,this.trueStateLabel=null,ToggleButtonMorph.uber.init.call(this,e,o,i,n,s,a),t&&(this.color=t[0],this.highlightColor=t[1],this.pressColor=t[2]),this.refresh(),this.drawNew()},ToggleButtonMorph.prototype.mouseEnter=function(){var t=this.hint instanceof Function?this.hint():this.hint;this.state||(this.image=this.highlightImage,this.changed()),t&&this.bubbleHelp(t)},ToggleButtonMorph.prototype.mouseLeave=function(){this.state||(this.image=this.normalImage,this.changed()),this.schedule&&(this.schedule.isActive=!1),this.hint&&this.world().hand.destroyTemporaries()},ToggleButtonMorph.prototype.mouseDownLeft=function(){this.state||(this.image=this.pressImage,this.changed())},ToggleButtonMorph.prototype.mouseClickLeft=function(){this.state||(this.image=this.highlightImage,this.changed()),this.trigger()},ToggleButtonMorph.prototype.trigger=function(){ToggleButtonMorph.uber.trigger.call(this),this.refresh()},ToggleButtonMorph.prototype.refresh=function(){"function"==typeof this.query?this.state=this.query.call(this.target):this.state=this.target[this.query](),this.state?(this.image=this.pressImage,this.trueStateLabel&&(this.label.hide(),this.trueStateLabel.show())):(this.image=this.normalImage,this.trueStateLabel&&(this.label.show(),this.trueStateLabel.hide())),this.changed()},ToggleButtonMorph.prototype.fixLayout=function(){if(null!==this.label){var t=Math.max(this.label.width(),this.labelMinExtent.x),e=2*this.padding+2*this.outline+2*this.edge;this.setExtent(new Point(this.minWidth?Math.max(this.minWidth,t)+e:t+e,Math.max(this.label instanceof StringMorph?this.label.rawHeight():this.label.height(),this.labelMinExtent.y)+e)),this.label.setCenter(this.center()),this.trueStateLabel&&this.trueStateLabel.setCenter(this.center()),this.minWidth&&this.label.setLeft(this.left()+this.outline+this.edge+this.corner+this.padding)}},ToggleButtonMorph.prototype.createBackgrounds=function(){var t,e=this.extent();if(this.template)return this.image=this.template.image,this.normalImage=this.template.normalImage,this.highlightImage=this.template.highlightImage,this.pressImage=this.template.pressImage,null;this.normalImage=newCanvas(e),t=this.normalImage.getContext("2d"),this.drawOutline(t),this.drawBackground(t,this.color),this.drawEdges(t,this.color,this.color.lighter(this.contrast),this.color.darker(this.contrast)),this.highlightImage=newCanvas(e),t=this.highlightImage.getContext("2d"),this.drawOutline(t),this.drawBackground(t,this.highlightColor),this.drawEdges(t,this.highlightColor,this.highlightColor.lighter(this.contrast),this.highlightColor.darker(this.contrast)),this.pressImage=newCanvas(e),t=this.pressImage.getContext("2d"),this.drawOutline(t),this.drawBackground(t,this.pressColor),this.drawEdges(t,this.pressColor,this.pressColor.lighter(40),this.pressColor.darker(40)),this.image=this.normalImage},ToggleButtonMorph.prototype.drawEdges=function(t,e,o,i){var r;if(ToggleButtonMorph.uber.drawEdges.call(this,t,e,o,i),this.hasPreview){if(MorphicPreferences.isFlat&&!this.is3D)return t.fillStyle=this.pressColor.toString(),void t.fillRect(this.outline,this.outline,this.corner,this.height()-2*this.outline);(r=t.createLinearGradient(0,0,this.corner,0)).addColorStop(0,this.pressColor.lighter(40).toString()),r.addColorStop(1,this.pressColor.darker(40).toString()),t.fillStyle=r,t.beginPath(),this.previewPath(t,Math.max(this.corner-this.outline,0),this.outline),t.closePath(),t.fill()}},ToggleButtonMorph.prototype.previewPath=function(t,e,o){var i=e+o,r=this.height();t.arc(i,i,e,radians(-180),radians(-90),!1),t.arc(i,r-i,e,radians(90),radians(180),!1)},ToggleButtonMorph.prototype.createLabel=function(){var t=!MorphicPreferences.isFlat||this.is3D,e=new Point;null!==this.label&&this.label.destroy(),null!==this.trueStateLabel&&this.trueStateLabel.destroy(),this.labelString instanceof Array&&2===this.labelString.length?this.labelString[0]instanceof SymbolMorph?(this.label=this.labelString[0].fullCopy(),this.trueStateLabel=this.labelString[1].fullCopy(),this.isPicture||(this.label.shadowOffset=t?this.labelShadowOffset:e,this.label.shadowColor=this.labelShadowColor,this.label.color=this.labelColor,this.label.drawNew(),this.trueStateLabel.shadowOffset=t?this.labelShadowOffset:e,this.trueStateLabel.shadowColor=this.labelShadowColor,this.trueStateLabel.color=this.labelColor,this.trueStateLabel.drawNew())):this.labelString[0]instanceof Morph?(this.label=this.labelString[0].fullCopy(),this.trueStateLabel=this.labelString[1].fullCopy()):(this.label=new StringMorph(localize(this.labelString[0]),this.fontSize,this.fontStyle,!0,!1,!1,t?this.labelShadowOffset:null,this.labelShadowColor,this.labelColor),this.trueStateLabel=new StringMorph(localize(this.labelString[1]),this.fontSize,this.fontStyle,!0,!1,!1,t?this.labelShadowOffset:null,this.labelShadowColor,this.labelColor)):this.labelString instanceof SymbolMorph?(this.label=this.labelString.fullCopy(),this.isPicture||(this.label.shadowOffset=t?this.labelShadowOffset:e,this.label.shadowColor=this.labelShadowColor,this.label.color=this.labelColor,this.label.drawNew())):this.labelString instanceof Morph?this.label=this.labelString.fullCopy():this.label=new StringMorph(localize(this.labelString),this.fontSize,this.fontStyle,!0,!1,!1,t?this.labelShadowOffset:e,this.labelShadowColor,this.labelColor),this.add(this.label),this.trueStateLabel&&this.add(this.trueStateLabel)},ToggleButtonMorph.prototype.hide=function(){this.isVisible=!1,this.changed()},ToggleButtonMorph.prototype.show=function(){this.isVisible=!0,this.changed()},TabMorph.prototype=new ToggleButtonMorph,TabMorph.prototype.constructor=TabMorph,TabMorph.uber=ToggleButtonMorph.prototype,TabMorph.prototype.fixLayout=function(){null!==this.label&&(this.setExtent(new Point(this.label.width()+2*this.padding+3*this.corner+2*this.edge,(this.label instanceof StringMorph?this.label.rawHeight():this.label.height())+2*this.padding+this.edge)),this.label.setCenter(this.center()))},TabMorph.prototype.refresh=function(){this.state&&this.parent&&this.parent.add(this),TabMorph.uber.refresh.call(this)},TabMorph.prototype.drawBackground=function(t,e){var o=this.width(),i=this.height(),r=this.corner;t.fillStyle=e.toString(),t.beginPath(),t.moveTo(0,i),t.bezierCurveTo(r,i,r,0,2*r,0),t.lineTo(o-2*r,0),t.bezierCurveTo(o-r,0,o-r,i,o,i),t.closePath(),t.fill()},TabMorph.prototype.drawOutline=function(){nop()},TabMorph.prototype.drawEdges=function(t,e,o,i){if(!MorphicPreferences.isFlat||this.is3D){var r,n=this.width(),s=this.height(),a=this.corner,h=this.edge,l=h/2;nop(e),(r=t.createLinearGradient(0,0,n,0)).addColorStop(0,o.toString()),r.addColorStop(1,i.toString()),t.strokeStyle=r,t.lineCap="round",t.lineWidth=h,t.beginPath(),t.moveTo(0,s+l),t.bezierCurveTo(a,s,a,0,2*a,l),t.lineTo(n-2*a,l),t.bezierCurveTo(n-a,0,n-a,s,n,s+l),t.stroke()}},ToggleMorph.prototype=new PushButtonMorph,ToggleMorph.prototype.constructor=ToggleMorph,ToggleMorph.uber=PushButtonMorph.prototype,ToggleMorph.prototype.init=function(t,e,o,i,r,n,s,a,h,l){this.padding=1,t=t||"checkbox",this.corner="checkbox"===t?0:fontHeight(this.fontSize)/2+this.outline+this.padding,this.state=!1,this.query=r||function(){return!0},this.tick=null,this.captionString=i||null,this.labelAlignment="right",this.element=h||null,this.builder=l||null,this.toggleElement=null,ToggleMorph.uber.init.call(this,e,o,"checkbox"===t?"✓":"●",n,s,a),this.refresh(),this.drawNew()},ToggleMorph.prototype.fixLayout=function(){var t,e=2*this.padding+2*this.outline;null!==this.tick&&(this.silentSetHeight(this.tick.rawHeight()+e),this.silentSetWidth(this.tick.width()+e),this.setExtent(new Point(Math.max(this.width(),this.height()),Math.max(this.width(),this.height()))),this.tick.setCenter(this.center())),this.state?this.tick.show():this.tick.hide(),this.toggleElement&&"right"===this.labelAlignment&&(t=this.top()+(this.height()-this.toggleElement.height())/2,this.toggleElement.setPosition(new Point(this.right()+e,t))),null!==this.label&&(t=this.top()+(this.height()-this.label.height())/2,"right"===this.labelAlignment?this.label.setPosition(new Point(this.toggleElement?this.toggleElement instanceof ToggleElementMorph?this.toggleElement.right():this.toggleElement.right()+e:this.right()+e,t)):this.label.setPosition(new Point(this.left()-this.label.width()-e,t)))},ToggleMorph.prototype.createLabel=function(){var t=!MorphicPreferences.isFlat||this.is3D;null===this.label&&this.captionString&&(this.label=new TextMorph(localize(this.captionString),this.fontSize,this.fontStyle,!0),this.add(this.label)),null===this.tick&&(this.tick=new StringMorph(localize(this.labelString),this.fontSize,this.fontStyle,!0,!1,!1,t?new Point(1,1):null,new Color(240,240,240)),this.add(this.tick)),null===this.toggleElement&&this.element&&(this.element instanceof Morph?this.toggleElement=new ToggleElementMorph(this.target,this.action,this.element,this.query,this.environment,this.hint,this.builder):this.element instanceof HTMLCanvasElement&&(this.toggleElement=new Morph,this.toggleElement.silentSetExtent(new Point(this.element.width,this.element.height)),this.toggleElement.image=this.element),this.add(this.toggleElement))},ToggleMorph.prototype.trigger=function(){ToggleMorph.uber.trigger.call(this),this.refresh()},ToggleMorph.prototype.refresh=function(){"function"==typeof this.query?this.state=this.query.call(this.target):this.state=this.target[this.query](),this.state?this.tick.show():this.tick.hide(),this.toggleElement&&this.toggleElement.refresh&&this.toggleElement.refresh()},ToggleMorph.prototype.mouseDownLeft=function(){PushButtonMorph.uber.mouseDownLeft.call(this),this.tick&&this.tick.setCenter(this.center().add(1))},ToggleMorph.prototype.mouseClickLeft=function(){PushButtonMorph.uber.mouseClickLeft.call(this),this.tick&&this.tick.setCenter(this.center())},ToggleMorph.prototype.mouseLeave=function(){PushButtonMorph.uber.mouseLeave.call(this),this.tick&&this.tick.setCenter(this.center())},ToggleMorph.prototype.hide=ToggleButtonMorph.prototype.hide,ToggleMorph.prototype.show=ToggleButtonMorph.prototype.show,ToggleElementMorph.prototype=new TriggerMorph,ToggleElementMorph.prototype.constructor=ToggleElementMorph,ToggleElementMorph.uber=TriggerMorph.prototype,ToggleElementMorph.prototype.contrast=50,ToggleElementMorph.prototype.shadowOffset=new Point(2,2),ToggleElementMorph.prototype.shadowAlpha=.6,ToggleElementMorph.prototype.fontSize=10,ToggleElementMorph.prototype.inactiveColor=new Color(180,180,180),ToggleElementMorph.prototype.init=function(t,e,o,i,r,n,s,a){this.target=t||null,this.action=e||null,this.element=o,this.query=i||function(){return!0},this.environment=r||null,this.hint=n||null,this.builder=s||"nop",this.captionString=a||null,this.labelAlignment="right",this.state=!1,TriggerMorph.uber.init.call(this),this.color=o.color,this.createLabel()},ToggleElementMorph.prototype.createBackgrounds=function(){var t=!MorphicPreferences.isFlat||this.is3D;this.color=this.element.color,this.element.removeShadow(),this.element[this.builder](),t&&this.element.addShadow(this.shadowOffset,this.shadowAlpha),this.silentSetExtent(this.element.fullBounds().extent()),this.pressImage=this.element.fullImage(),this.element.removeShadow(),this.element.setColor(this.inactiveColor),this.element[this.builder](this.contrast),t&&this.element.addShadow(this.shadowOffset,0),this.normalImage=this.element.fullImage(),this.element.removeShadow(),this.element.setColor(this.color.lighter(this.contrast)),this.element[this.builder](this.contrast),t&&this.element.addShadow(this.shadowOffset,this.shadowAlpha),this.highlightImage=this.element.fullImage(),this.element.removeShadow(),this.element.setColor(this.color),this.element[this.builder](),this.image=this.normalImage},ToggleElementMorph.prototype.setColor=function(t){this.element.setColor(t),this.createBackgrounds(),this.refresh()},ToggleElementMorph.prototype.createLabel=function(){var t;this.captionString&&(this.label=new StringMorph(this.captionString,this.fontSize,this.fontStyle,!0),this.add(this.label),t=this.top()+(this.height()-this.label.height())/2,"right"===this.labelAlignment?this.label.setPosition(new Point(this.right(),t)):this.label.setPosition(new Point(this.left()-this.label.width(),t)))},ToggleElementMorph.prototype.trigger=ToggleButtonMorph.prototype.trigger,ToggleElementMorph.prototype.refresh=ToggleButtonMorph.prototype.refresh,ToggleElementMorph.prototype.mouseEnter=ToggleButtonMorph.prototype.mouseEnter,ToggleElementMorph.prototype.mouseLeave=ToggleButtonMorph.prototype.mouseLeave,ToggleElementMorph.prototype.mouseDownLeft=ToggleButtonMorph.prototype.mouseDownLeft,ToggleElementMorph.prototype.mouseClickLeft=ToggleButtonMorph.prototype.mouseClickLeft,DialogBoxMorph.prototype=new Morph,DialogBoxMorph.prototype.constructor=DialogBoxMorph,DialogBoxMorph.uber=Morph.prototype,DialogBoxMorph.prototype.fontSize=12,DialogBoxMorph.prototype.titleFontSize=14,DialogBoxMorph.prototype.fontStyle="sans-serif",DialogBoxMorph.prototype.color=PushButtonMorph.prototype.color,DialogBoxMorph.prototype.titleTextColor=new Color(255,255,255),DialogBoxMorph.prototype.titleBarColor=PushButtonMorph.prototype.pressColor,DialogBoxMorph.prototype.contrast=40,DialogBoxMorph.prototype.corner=12,DialogBoxMorph.prototype.padding=14,DialogBoxMorph.prototype.titlePadding=6,DialogBoxMorph.prototype.buttonContrast=50,DialogBoxMorph.prototype.buttonFontSize=12,DialogBoxMorph.prototype.buttonCorner=12,DialogBoxMorph.prototype.buttonEdge=6,DialogBoxMorph.prototype.buttonPadding=0,DialogBoxMorph.prototype.buttonOutline=3,DialogBoxMorph.prototype.buttonOutlineColor=PushButtonMorph.prototype.color,DialogBoxMorph.prototype.buttonOutlineGradient=!0,DialogBoxMorph.prototype.instances={},DialogBoxMorph.prototype.init=function(t,e,o){this.is3D=!1,this.target=t||null,this.action=e||null,this.environment=o||null,this.key=null,this.labelString=null,this.label=null,this.head=null,this.body=null,this.buttons=null,DialogBoxMorph.uber.init.call(this),this.isDraggable=!0,this.color=PushButtonMorph.prototype.color,this.createLabel(),this.createButtons(),this.setExtent(new Point(300,150))},DialogBoxMorph.prototype.inform=function(t,e,o,i){var r=new TextMorph(e,this.fontSize,this.fontStyle,!0,!1,"center",null,null,MorphicPreferences.isFlat?null:new Point(1,1),new Color(255,255,255));this.key||(this.key="inform"+t+e),this.labelString=t,this.createLabel(),i&&this.setPicture(i),e&&this.addBody(r),this.addButton("ok","OK"),this.drawNew(),this.fixLayout(),this.popUp(o)},DialogBoxMorph.prototype.askYesNo=function(t,e,o,i){var r=new TextMorph(e,this.fontSize,this.fontStyle,!0,!1,"center",null,null,MorphicPreferences.isFlat?null:new Point(1,1),new Color(255,255,255));this.key||(this.key="decide"+t+e),this.labelString=t,this.createLabel(),i&&this.setPicture(i),this.addBody(r),this.addButton("ok","Yes"),this.addButton("cancel","No"),this.fixLayout(),this.drawNew(),this.fixLayout(),this.popUp(o)},DialogBoxMorph.prototype.prompt=function(t,e,o,i,r,n,s,a,h,l){var p,c,u=new InputFieldMorph(e,s||!1,r||null,r&&n||!1);u.setWidth(250),s?(i&&(c=new AlignmentMorph("column",this.padding),i.setPosition(c.position()),c.add(i)),isNil(a)||isNil(h)||((p=new SliderMorph(100*a,100*h,100*parseFloat(e),(h-a)/10*100,"horizontal")).alpha=1,p.color=this.color.lighter(50),p.setHeight(.7*u.height()),p.setWidth(u.width()),p.action=function(t){l&&l(t/100),u.setContents(t/100),u.edit()},c||(c=new AlignmentMorph("column",this.padding)),c.add(p)),c&&(c.fixLayout(),this.setPicture(c),c.fixLayout())):i&&this.setPicture(i),this.reactToChoice=function(t){p&&(p.value=100*t,p.drawNew(),p.changed()),l&&l(t)},u.reactToKeystroke=function(){var t=u.getValue();p&&(t=Math.max(t,a),p.value=100*t,p.drawNew(),p.changed()),l&&l(t)},this.labelString=t,this.createLabel(),this.key||(this.key="prompt"+t+e),this.addBody(u),u.drawNew(),this.addButton("ok","OK"),this.addButton("cancel","Cancel"),this.fixLayout(),this.drawNew(),this.fixLayout(),this.popUp(o)},DialogBoxMorph.prototype.promptCode=function(t,e,o,i,r){var n=new ScrollFrameMorph,s=new TextMorph(e||""),a=new AlignmentMorph("column",this.padding),h=i?Math.max(i.width,400):400;this.getInput=function(){return s.text},n.padding=6,n.setWidth(h),n.acceptsDrops=!1,n.contents.acceptsDrops=!1,s.fontName="monospace",s.fontStyle="monospace",s.fontSize=11,s.setPosition(n.topLeft().add(n.padding)),s.enableSelecting(),s.isEditable=!0,n.setHeight(h/4),n.fixLayout=nop,n.edge=InputFieldMorph.prototype.edge,n.fontSize=InputFieldMorph.prototype.fontSize,n.typeInPadding=InputFieldMorph.prototype.typeInPadding,n.contrast=InputFieldMorph.prototype.contrast,n.drawNew=InputFieldMorph.prototype.drawNew,n.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,n.addContents(s),s.drawNew(),i&&this.setPicture(i),this.labelString=t,this.createLabel(),this.key||(this.key="promptCode"+t+e),a.setColor(this.color),a.add(n),r&&a.add(new TextMorph(localize(r),10,null,!1,null,null,null,null,MorphicPreferences.isFlat?null:new Point(1,1),new Color(255,255,255))),a.fixLayout(),this.addBody(a),n.drawNew(),a.drawNew(),this.addButton("ok","OK"),this.addButton("cancel","Cancel"),this.fixLayout(),this.drawNew(),this.fixLayout(),this.popUp(o),s.edit()},DialogBoxMorph.prototype.promptVector=function(t,e,o,i,r,n,s,a){var h=new AlignmentMorph("row",4),l=new InputFieldMorph(e.x.toString(),!0),p=new InputFieldMorph(e.y.toString(),!0),c=new AlignmentMorph("column",2),u=new AlignmentMorph("column",2),d=new AlignmentMorph("column",2),g=new AlignmentMorph("column",this.padding);function f(t){return new TextMorph(localize(t),10,null,!1,null,null,null,null,MorphicPreferences.isFlat?null:new Point(1,1),new Color(255,255,255))}d.alignment="left",d.setColor(this.color),g.setColor(this.color),c.alignment="left",c.setColor(this.color),u.alignment="left",u.setColor(this.color),c.add(f(i)),c.add(l),u.add(f(r)),u.add(p),h.add(c),h.add(u),d.add(h),a&&g.add(f(a)),g.add(d),h.fixLayout(),c.fixLayout(),u.fixLayout(),d.fixLayout(),g.fixLayout(),this.labelString=t,this.createLabel(),s&&this.setPicture(s),this.addBody(g),h.drawNew(),c.drawNew(),l.drawNew(),u.drawNew(),p.drawNew(),g.fixLayout(),this.addButton("ok","OK"),o instanceof Point&&this.addButton(function(){l.setContents(o.x.toString()),p.setContents(o.y.toString())},"Default"),this.addButton("cancel","Cancel"),this.fixLayout(),this.drawNew(),this.fixLayout(),this.edit=function(){l.edit()},this.getInput=function(){return new Point(l.getValue(),p.getValue())},this.key||(this.key="vector"+t),this.popUp(n)},DialogBoxMorph.prototype.promptCredentials=function(t,r,e,o,i,n,s,a,h,l){var p,c,u,d,g=new InputFieldMorph,f=new InputFieldMorph,m=new InputFieldMorph,y=new InputFieldMorph,M=new InputFieldMorph,b=!1,S=new AlignmentMorph("row",4),w=new AlignmentMorph("column",2),C=new AlignmentMorph("column",2),v=new AlignmentMorph("column",2),x=new AlignmentMorph("row",4),k=new AlignmentMorph("column",this.padding),B={},P=(new Date).getFullYear(),T=P-20,I=this;function E(t){return new TextMorph(localize(t),10,null,!1,null,null,null,null,MorphicPreferences.isFlat?null:new Point(1,1),new Color(255,255,255))}function L(t,e){var o=new PushButtonMorph(I,function(){window.open(e)},"  "+localize(t)+"  ");return o.fontSize=10,o.corner=I.buttonCorner,o.edge=I.buttonEdge,o.outline=I.buttonOutline,o.outlineColor=I.buttonOutlineColor,o.outlineGradient=I.buttonOutlineGradient,o.padding=I.buttonPadding,o.contrast=I.buttonContrast,o.drawNew(),o.fixLayout(),o}for(p=new InputFieldMorph(null,!1,{January:["January"],February:["February"],March:["March"],April:["April"],May:["May"],June:["June"],July:["July"],August:["August"],September:["September"],October:["October"],November:["November"],December:["December"]},!0);T<P;P-=1)B[P.toString()+" "]=P;B[T+" "+localize("or before")]="< "+P,c=new InputFieldMorph(null,!1,B,!0),v.alignment="left",v.setColor(this.color),k.setColor(this.color),w.alignment="left",w.setColor(this.color),C.alignment="left",C.setColor(this.color),g.setWidth(200),p.setWidth(100),c.contents().minWidth=80,c.setWidth(80),f.setWidth(200),m.setWidth(200),y.setWidth(200),M.setWidth(200),m.contents().text.toggleIsPassword(),y.contents().text.toggleIsPassword(),M.contents().text.toggleIsPassword(),"login"===r&&(v.add(E("User name:")),v.add(g)),"signup"===r&&(v.add(E("User name:")),v.add(g),w.add(E("Birth date:")),w.add(p),C.add(E("year:")),C.add(c),S.add(w),S.add(C),v.add(S),u=E("foo"),v.add(u),v.add(f)),"login"===r&&(v.add(E("Password:")),v.add(m)),"changePassword"===r&&(v.add(E("Old password:")),v.add(M),v.add(E("New password:")),v.add(m),v.add(E("Repeat new password:")),v.add(y)),"resetPassword"===r&&(v.add(E("User name:")),v.add(g)),l&&k.add(E(l)),k.add(v),(e||i)&&k.add(x),e&&x.add(L(o,e)),i&&x.add(L(n,i)),s&&((d=new ToggleMorph("checkbox",this,function(){b=!b},s,function(){return b})).edge=this.buttonEdge/2,d.outline=this.buttonOutline/2,d.outlineColor=this.buttonOutlineColor,d.outlineGradient=this.buttonOutlineGradient,d.contrast=this.buttonContrast,d.drawNew(),d.fixLayout(),k.add(d)),S.fixLayout(),w.fixLayout(),C.fixLayout(),v.fixLayout(),x.fixLayout(),k.fixLayout(),this.labelString=t,this.createLabel(),h&&this.setPicture(h),this.addBody(k),g.drawNew(),S.drawNew(),w.drawNew(),p.drawNew(),C.drawNew(),c.drawNew(),m.drawNew(),y.drawNew(),M.drawNew(),f.drawNew(),k.fixLayout(),this.addButton("ok","OK"),this.addButton("cancel","Cancel"),this.fixLayout(),this.drawNew(),this.fixLayout(),this.accept=function(){(function(){var t,e,o=f.getValue();function i(t,e){var o=new SpeechBubbleMorph(localize(e));o.isPointingRight=!1,o.drawNew(),o.popUp(a,t.leftCenter().subtract(new Point(o.width()+2,0))),t.edit&&t.edit()}if("login"===r?t=[g,m]:"signup"===r?t=[g,p,c,f]:"changePassword"===r?t=[M,m,y]:"resetPassword"===r&&(t=[g]),e=detect(t,function(t){return!t.getValue()}))return i(e,"please fill out\nthis field"),!1;if("signup"===r){if(-1<g.getValue().indexOf("@"))return i(g,"User name cannot contain\nany @ symbols"),!1;if(g.getValue().length<4)return i(g,"User name must be four\ncharacters or longer"),!1;if(-1<o.indexOf(" ")||-1===o.indexOf("@")||-1===o.indexOf("."))return i(f,"please provide a valid\nemail address"),!1}if("changePassword"===r){if(m.getValue().length<6)return i(m,"password must be six\ncharacters or longer"),!1;if(m.getValue()!==y.getValue())return i(y,"passwords do\nnot match"),!1}return!("signup"===r&&!b&&(i(d,"please agree to\nthe TOS"),1))})()&&DialogBoxMorph.prototype.accept.call(I)},this.edit=function(){"changePassword"===r?M.edit():g.edit()},this.getInput=function(){return{username:g.getValue(),email:f.getValue(),oldpassword:M.getValue(),password:m.getValue(),choice:b}},this.reactToChoice=function(){var t,e,o,i;"signup"===r&&(u.changed(),u.text=(e=(new Date).getFullYear()+(new Date).getMonth()/12,o=+c.getValue()||0,(i=p.getValue())instanceof Array&&(i=i[0]),isNaN(o)&&(o=0),t=["January","February","March","April","May","June","July","August","September","October","November","December"].indexOf(i),isNaN(t)&&(t=0),e-(o+t/12)<=13?"E-mail address of parent or guardian:":"E-mail address:"),u.text=localize(u.text),u.drawNew(),u.changed())},this.reactToChoice(),this.key||(this.key="credentials"+t+r),this.popUp(a)},DialogBoxMorph.prototype.accept=function(){this.action&&("function"==typeof this.target?"function"==typeof this.action?this.target.call(this.environment,this.action.call()):this.target.call(this.environment,this.action):"function"==typeof this.action?this.action.call(this.target,this.getInput()):this.target[this.action](this.getInput())),this.destroy()},DialogBoxMorph.prototype.withKey=function(t){return this.key=t,this},DialogBoxMorph.prototype.popUp=function(t){t&&(this.key&&(this.instances[t.stamp]?this.instances[t.stamp][this.key]&&this.instances[t.stamp][this.key].destroy():this.instances[t.stamp]={},this.instances[t.stamp][this.key]=this),t.add(this),(t.keyboardReceiver=this).setCenter(t.center()),this.edit())},DialogBoxMorph.prototype.destroy=function(){DialogBoxMorph.uber.destroy.call(this),this.key&&delete this.instances[this.key]},DialogBoxMorph.prototype.ok=function(){this.accept()},DialogBoxMorph.prototype.cancel=function(){this.destroy()},DialogBoxMorph.prototype.edit=function(){this.children.forEach(function(t){if(t.edit)return t.edit()})},DialogBoxMorph.prototype.getInput=function(){return this.body instanceof InputFieldMorph?this.body.getValue():null},DialogBoxMorph.prototype.justDropped=function(t){(t.world.keyboardReceiver=this).edit()},DialogBoxMorph.prototype.destroy=function(){var t=this.world();t.keyboardReceiver=null,t.hand.destroyTemporaries(),DialogBoxMorph.uber.destroy.call(this)},DialogBoxMorph.prototype.normalizeSpaces=function(t){var e,o,i="",r=!1;for(e=0;e<t.length;e+=1)" "===(o=t[e])?r&&(i+=o,r=!1):(i+=o,r=!0);return i.trim()},DialogBoxMorph.prototype.createLabel=function(){var t=!MorphicPreferences.isFlat||this.is3D;this.label&&this.label.destroy(),this.labelString&&(this.label=new StringMorph(localize(this.labelString),this.titleFontSize,this.fontStyle,!0,!1,!1,t?new Point(2,1):null,this.titleBarColor.darker(this.contrast)),this.label.color=this.titleTextColor,this.label.drawNew(),this.add(this.label))},DialogBoxMorph.prototype.createButtons=function(){this.buttons&&this.buttons.destroy(),this.buttons=new AlignmentMorph("row",this.padding),this.add(this.buttons)},DialogBoxMorph.prototype.addButton=function(t,e){var o=new PushButtonMorph(this,t||"ok","  "+localize(e||"OK")+"  ");return o.fontSize=this.buttonFontSize,o.corner=this.buttonCorner,o.edge=this.buttonEdge,o.outline=this.buttonOutline,o.outlineColor=this.buttonOutlineColor,o.outlineGradient=this.buttonOutlineGradient,o.padding=this.buttonPadding,o.contrast=this.buttonContrast,o.drawNew(),o.fixLayout(),this.buttons.add(o),o},DialogBoxMorph.prototype.setPicture=function(t){var e;t instanceof Morph?e=t:((e=new Morph).image=t,e.silentSetWidth(t.width),e.silentSetHeight(t.height)),this.addHead(e)},DialogBoxMorph.prototype.addHead=function(t){this.head&&this.head.destroy(),this.head=t,this.add(this.head)},DialogBoxMorph.prototype.addBody=function(t){this.body&&this.body.destroy(),this.body=t,this.add(this.body)},DialogBoxMorph.prototype.addShadow=function(){nop()},DialogBoxMorph.prototype.removeShadow=function(){nop()},DialogBoxMorph.prototype.fixLayout=function(){var t,e=fontHeight(this.titleFontSize)+2*this.titlePadding;this.head&&(this.head.setPosition(this.position().add(new Point(this.padding,e+this.padding))),this.silentSetWidth(this.head.width()+2*this.padding),this.silentSetHeight(this.head.height()+2*this.padding+e)),this.body&&(this.head?(this.body.setPosition(this.head.bottomLeft().add(new Point(0,this.padding))),this.silentSetWidth(Math.max(this.width(),this.body.width()+2*this.padding)),this.silentSetHeight(this.height()+this.body.height()+this.padding),t=this.width(),this.head.setLeft(this.left()+Math.round((t-this.head.width())/2)),this.body.setLeft(this.left()+Math.round((t-this.body.width())/2))):(this.body.setPosition(this.position().add(new Point(this.padding,e+this.padding))),this.silentSetWidth(this.body.width()+2*this.padding),this.silentSetHeight(this.body.height()+2*this.padding+e))),this.label&&(this.label.setCenter(this.center()),this.label.setTop(this.top()+(e-this.label.height())/2)),this.buttons&&0<this.buttons.children.length&&(this.buttons.fixLayout(),this.silentSetHeight(this.height()+this.buttons.height()+this.padding),this.silentSetWidth(Math.max(this.width(),this.buttons.width()+2*this.padding)),this.buttons.setCenter(this.center()),this.buttons.setBottom(this.bottom()-this.padding))},DialogBoxMorph.prototype.shadowImage=function(t,e){var o,i,r,n,s,a=t||new Point(7,7),h=e||new Color(0,0,0);return o=this.extent(),i=this.image,(s=(r=newCanvas(o)).getContext("2d")).drawImage(i,0,0),s.globalCompositeOperation="destination-out",s.drawImage(i,-a.x,-a.y),(s=(n=newCanvas(o)).getContext("2d")).drawImage(r,0,0),s.globalCompositeOperation="source-atop",s.fillStyle=h.toString(),s.fillRect(0,0,o.x,o.y),n},DialogBoxMorph.prototype.shadowImageBlurred=function(t,e){var o,i,r,n,s=t||new Point(7,7),a=this.shadowBlur,h=e||new Color(0,0,0);return o=this.extent().add(2*a),i=this.image,(n=(r=newCanvas(o)).getContext("2d")).shadowOffsetX=s.x,n.shadowOffsetY=s.y,n.shadowBlur=a,n.shadowColor=h.toString(),n.drawImage(i,a-s.x,a-s.y),n.shadowOffsetX=0,n.shadowOffsetY=0,n.shadowBlur=0,n.globalCompositeOperation="destination-out",n.drawImage(i,a-s.x,a-s.y),r},DialogBoxMorph.prototype.processKeyPress=function(){nop()},DialogBoxMorph.prototype.processKeyDown=function(t){switch(t.keyCode){case 13:this.ok();break;case 27:this.cancel();break;default:nop()}},DialogBoxMorph.prototype.drawNew=function(){this.fullChanged(),Morph.prototype.trackChanges=!1,DialogBoxMorph.uber.removeShadow.call(this),this.fixLayout();var t,e,o,i,r=this.width(),n=this.height(),s=Math.floor(fontHeight(this.titleFontSize)+2*this.titlePadding),a=this.corner/2,h=MorphicPreferences.isFlat&&!this.is3D;if(this.image=newCanvas(this.extent()),(t=this.image.getContext("2d")).fillStyle=h?this.titleBarColor.toString():((e=t.createLinearGradient(0,0,0,s)).addColorStop(0,this.titleBarColor.lighter(this.contrast/2).toString()),e.addColorStop(1,this.titleBarColor.darker(this.contrast).toString()),e),t.beginPath(),this.outlinePathTitle(t,h?0:this.corner),t.closePath(),t.fill(),t.fillStyle=this.color.toString(),t.beginPath(),this.outlinePathBody(t,h?0:this.corner),t.closePath(),t.fill(),h)return DialogBoxMorph.uber.addShadow.call(this),Morph.prototype.trackChanges=!0,void this.fullChanged();(e=t.createLinearGradient(0,n-this.corner,0,n)).addColorStop(0,this.color.toString()),e.addColorStop(1,this.color.darker(this.contrast.toString())),t.lineWidth=this.corner,t.lineCap="round",t.strokeStyle=e,t.beginPath(),t.moveTo(this.corner,n-a),t.lineTo(this.corner+1,n-a),t.stroke(),(e=t.createLinearGradient(0,n-this.corner,0,n)).addColorStop(0,this.color.toString()),e.addColorStop(1,this.color.darker(this.contrast.toString())),t.lineWidth=this.corner,t.lineCap="butt",t.strokeStyle=e,t.beginPath(),t.moveTo(this.corner,n-a),t.lineTo(r-this.corner,n-a),t.stroke(),(e=t.createLinearGradient(r-this.corner,0,r,0)).addColorStop(0,this.color.toString()),e.addColorStop(1,this.color.darker(this.contrast).toString()),t.lineWidth=this.corner,t.lineCap="butt",t.strokeStyle=e,t.beginPath(),t.moveTo(r-a,s),t.lineTo(r-a,n-this.corner),t.stroke(),o=r-this.corner,i=n-this.corner,(e=t.createRadialGradient(o,i,0,o,i,this.corner)).addColorStop(0,this.color.toString()),e.addColorStop(1,this.color.darker(this.contrast.toString())),t.lineCap="butt",t.strokeStyle=e,t.beginPath(),t.arc(o,i,a,radians(90),radians(0),!0),t.stroke(),(e=t.createLinearGradient(0,0,this.corner,0)).addColorStop(0,this.color.lighter(this.contrast).toString()),e.addColorStop(1,this.color.toString()),t.lineCap="butt",t.strokeStyle=e,t.beginPath(),t.moveTo(a,s),t.lineTo(a,n-2*this.corner),t.stroke(),(e=t.createLinearGradient(0,0,this.corner,0)).addColorStop(0,this.color.lighter(this.contrast).toString()),e.addColorStop(1,this.color.toString()),t.lineCap="round",t.strokeStyle=e,t.beginPath(),t.moveTo(a,n-2*this.corner),t.lineTo(a,n-this.corner-a),t.stroke(),DialogBoxMorph.uber.addShadow.call(this),Morph.prototype.trackChanges=!0,this.fullChanged()},DialogBoxMorph.prototype.outlinePathTitle=function(t,e){var o=this.width(),i=Math.ceil(fontHeight(this.titleFontSize))+2*this.titlePadding;t.arc(e,e,e,radians(-180),radians(-90),!1),t.arc(o-e,e,e,radians(-90),radians(-0),!1),t.lineTo(o,i),t.lineTo(0,i)},DialogBoxMorph.prototype.outlinePathBody=function(t,e){var o=this.width(),i=this.height(),r=Math.floor(fontHeight(this.titleFontSize))+2*this.titlePadding;t.moveTo(0,r),t.lineTo(o,r),t.arc(o-e,i-e,e,radians(0),radians(90),!1),t.arc(e,i-e,e,radians(90),radians(180),!1)},AlignmentMorph.prototype=new Morph,AlignmentMorph.prototype.constructor=AlignmentMorph,AlignmentMorph.uber=Morph.prototype,AlignmentMorph.prototype.init=function(t,e){this.orientation=t||"row",this.alignment="center",this.padding=e||0,this.respectHiddens=!1,AlignmentMorph.uber.init.call(this)},AlignmentMorph.prototype.drawNew=function(){this.image=newCanvas(new Point(1,1)),this.fixLayout()},AlignmentMorph.prototype.fixLayout=function(){var i,r=this,n=null;if(0===this.children.length)return null;this.children.forEach(function(t){var e,o=t.fullBounds();(t.isVisible||r.respectHiddens)&&(i=n?(e=n.fullBounds(),"row"===r.orientation?t.setPosition(e.topRight().add(new Point(r.padding,(e.height()-o.height())/2))):t.setPosition(e.bottomLeft().add(new Point("center"===r.alignment?(e.width()-o.width())/2:0,r.padding))),o=t.fullBounds(),i.merge(o)):o,n=t)}),this.bounds=i},InputFieldMorph.prototype=new Morph,InputFieldMorph.prototype.constructor=InputFieldMorph,InputFieldMorph.uber=Morph.prototype,InputFieldMorph.prototype.edge=2,InputFieldMorph.prototype.fontSize=12,InputFieldMorph.prototype.typeInPadding=2,InputFieldMorph.prototype.contrast=65,InputFieldMorph.prototype.init=function(t,e,o,i){var r=new StringFieldMorph(t||""),n=new ArrowMorph("down",0,Math.max(Math.floor(this.fontSize/6),1));this.choices=o||null,this.isReadOnly=i||!1,this.isNumeric=e||!1,r.alpha=0,r.fontSize=this.fontSize,r.drawNew(),this.oldContentsExtent=r.extent(),this.isNumeric=e||!1,InputFieldMorph.uber.init.call(this),this.color=new Color(255,255,255),this.add(r),this.add(n),r.isDraggable=!1,this.drawNew()},InputFieldMorph.prototype.contents=function(){return detect(this.children,function(t){return t instanceof StringFieldMorph})},InputFieldMorph.prototype.arrow=function(){return detect(this.children,function(t){return t instanceof ArrowMorph})},InputFieldMorph.prototype.setChoice=function(t){this.setContents(t),this.escalateEvent("reactToChoice",t)},InputFieldMorph.prototype.setContents=function(t){var e=this.contents();if(void 0===(e.text.text=t))return null;null===t?e.text.text="":t.toString&&(e.text.text=t.toString()),e.drawNew(),e.changed()},InputFieldMorph.prototype.edit=function(){var t=this.contents();t.text.edit(),t.text.selectAll()},InputFieldMorph.prototype.setIsNumeric=function(t){var e;this.isNumeric=t,this.contents().isNumeric=t,this.contents().text.isNumeric=t,e=this.getValue(),this.isNumeric&&(e=parseFloat(e),isNaN(e)&&(e=null)),this.setContents(e)},InputFieldMorph.prototype.dropDownMenu=function(){var t,e=this.choices,o=new MenuMorph(this.setChoice,null,this,this.fontSize);if(e instanceof Function?e=e.call(this):isString(e)&&(e=this[e]()),!e)return null;if(o.addItem(" ",null),e instanceof Array)e.forEach(function(t){o.addItem(t[0],t[1])});else for(t in e)Object.prototype.hasOwnProperty.call(e,t)&&("~"===t[0]?o.addLine():o.addItem(t,e[t]));if(!(0<o.items.length))return null;o.popUpAtHand(this.world())},InputFieldMorph.prototype.fixLayout=function(){var t=this.contents(),e=this.arrow();if(!t)return null;t.isNumeric=this.isNumeric,t.isEditable=!this.isReadOnly,this.choices?(e.setSize(this.fontSize),e.show()):(e.setSize(0),e.hide()),this.silentSetHeight(t.height()+2*this.edge+2*this.typeInPadding),this.silentSetWidth(Math.max(t.minWidth+2*this.edge+2*this.typeInPadding,this.width())),t.setWidth(this.width()-this.edge-this.typeInPadding-(this.choices?e.width()+this.typeInPadding:0)),t.silentSetPosition(new Point(this.edge,this.edge).add(this.typeInPadding).add(this.position())),e.silentSetPosition(new Point(this.right()-e.width()-this.edge,t.top()))},InputFieldMorph.prototype.mouseClickLeft=function(t){this.arrow().bounds.containsPoint(t)?this.dropDownMenu():this.isReadOnly?this.dropDownMenu():this.escalateEvent("mouseClickLeft",t)},InputFieldMorph.prototype.getValue=function(){var t,e=this.contents();return this.isNumeric&&(t=parseFloat(e.text),!isNaN(t))?t:this.normalizeSpaces(e.string())},InputFieldMorph.prototype.normalizeSpaces=DialogBoxMorph.prototype.normalizeSpaces,InputFieldMorph.prototype.drawNew=function(){var t,e;this.fixLayout(),this.image=newCanvas(this.extent()),t=this.image.getContext("2d"),e=this.parent?(this.parent.color.eq(new Color(255,255,255))?this.color=this.parent.color.darker(.1*this.contrast):this.color=this.parent.color.lighter(.75*this.contrast),this.parent.color):new Color(120,120,120),t.fillStyle=this.color.toString(),this.cachedClr=e.toString(),this.cachedClrBright=e.lighter(this.contrast).toString(),this.cachedClrDark=e.darker(this.contrast).toString(),t.fillRect(this.edge,this.edge,this.width()-2*this.edge,this.height()-2*this.edge),this.drawRectBorder(t)},InputFieldMorph.prototype.drawRectBorder=function(t){var e,o=.5*this.edge;MorphicPreferences.isFlat&&!this.is3D||(t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.shadowOffsetY=o,t.shadowBlur=4*this.edge,t.shadowColor=this.cachedClrDark,(e=t.createLinearGradient(0,0,0,this.edge)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.moveTo(this.edge,o),t.lineTo(this.width()-this.edge-o,o),t.stroke(),t.shadowOffsetY=0,(e=t.createLinearGradient(0,0,this.edge,0)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.moveTo(o,this.edge),t.lineTo(o,this.height()-this.edge-o),t.stroke(),t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0,(e=t.createLinearGradient(0,this.height()-this.edge,0,this.height())).addColorStop(0,this.cachedClrBright),e.addColorStop(1,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(this.edge,this.height()-o),t.lineTo(this.width()-this.edge,this.height()-o),t.stroke(),(e=t.createLinearGradient(this.width()-this.edge,0,this.width(),0)).addColorStop(0,this.cachedClrBright),e.addColorStop(1,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(this.width()-o,this.edge),t.lineTo(this.width()-o,this.height()-this.edge),t.stroke())},modules.blocks="2017-April-10",WorldMorph.prototype.customMorphs=function(){return[]},SyntaxElementMorph.prototype=new Morph,SyntaxElementMorph.prototype.constructor=SyntaxElementMorph,SyntaxElementMorph.uber=Morph.prototype,SyntaxElementMorph.prototype.setScale=function(t){var e=Math.min(Math.max(t,1),25);this.scale=e,this.corner=3*e,this.rounding=9*e,this.edge=1.000001*e,this.inset=6*e,this.hatHeight=12*e,this.hatWidth=70*e,this.rfBorder=3*e,this.minWidth=0,this.dent=8*e,this.bottomPadding=3*e,this.cSlotPadding=4*e,this.typeInPadding=e,this.labelPadding=4*e,this.labelFontName="Verdana",this.labelFontStyle="sans-serif",this.fontSize=10*e,this.embossing=new Point(-1*Math.max(e/2,1),-1*Math.max(e/2,1)),this.labelWidth=450*e,this.labelWordWrap=!0,this.dynamicInputLabels=!0,this.feedbackColor=new Color(255,255,255),this.feedbackMinHeight=5,this.minSnapDistance=20,this.reporterDropFeedbackPadding=10*e,this.contrast=65,this.labelContrast=25,this.activeHighlight=new Color(153,255,213),this.errorHighlight=new Color(173,15,0),this.activeBlur=20,this.activeBorder=4,this.rfColor=new Color(120,120,120)},SyntaxElementMorph.prototype.setScale(1),SyntaxElementMorph.prototype.isCachingInputs=!1,SyntaxElementMorph.prototype.init=function(t){this.cachedClr=null,this.cachedClrBright=null,this.cachedClrDark=null,this.cachedNormalColor=null,this.isStatic=!1,SyntaxElementMorph.uber.init.call(this,t),this.defaults=[],this.cachedInputs=null},SyntaxElementMorph.prototype.parts=function(){var e=null;return this.nextBlock&&(e=this.nextBlock()),this.children.filter(function(t){return!(t===e||t instanceof ShadowMorph||t instanceof BlockHighlightMorph)})},SyntaxElementMorph.prototype.inputs=function(){return!isNil(this.cachedInputs)&&this.isCachingInputs||(this.cachedInputs=this.parts().filter(function(t){return t instanceof SyntaxElementMorph})),this.cachedInputs},SyntaxElementMorph.prototype.debugCachedInputs=function(){var t,e;if(isNil(this.cachedInputs)||(t=this.parts().filter(function(t){return t instanceof SyntaxElementMorph})),this.cachedInputs.length!==t.length)throw new Error("cached inputs size do not match: "+this.constructor.name);for(e=0;e<t.length;e+=1)if(this.cachedInputs[e]!==t[e])throw new Error("cached input does not match: "+this.constructor.name+" #"+e+" "+this.cachedInputs[e].constructor.name+" != "+t[e].constructor.name)},SyntaxElementMorph.prototype.allInputs=function(){var e=this;return this.allChildren().slice(0).reverse().filter(function(t){return t instanceof ArgMorph||t instanceof ReporterBlockMorph&&t!==e})},SyntaxElementMorph.prototype.allEmptySlots=function(){var e=[];return this instanceof RingMorph||"reportJSFunction"===this.selector||this.children.forEach(function(t){t.isEmptySlot&&t.isEmptySlot()?e.push(t):t.allEmptySlots&&(e=e.concat(t.allEmptySlots()))}),e},SyntaxElementMorph.prototype.tagExitBlocks=function(e,o){"doReport"===this.selector?this.partOfCustomCommand=o:"doStopThis"===this.selector?this.exitTag=e:this instanceof RingMorph||this.children.forEach(function(t){t.tagExitBlocks&&t.tagExitBlocks(e,o)})},SyntaxElementMorph.prototype.replaceInput=function(e,t){var o=this.parentThatIsA(ScriptsMorph),i=t,r=this.children.indexOf(e),n=0;if(-1===r&&t instanceof MultiArgMorph&&this.children.forEach(function(t){t instanceof ArgLabelMorph&&t.argMorph()===e&&(r=n),n+=1}),-1===r||null===o)return null;e.cachedSlotSpec&&(e.cachedSlotSpec=null),t.cachedSlotSpec&&(t.cachedSlotSpec=null),this.startLayout(),t.parent&&t.parent.removeChild(t),e instanceof MultiArgMorph&&(e.inputs().forEach(function(t){e.replaceInput(t,new InputSlotMorph)}),this.dynamicInputLabels&&(i=new ArgLabelMorph(t))),(i.parent=this).children[r]=i,e instanceof ReporterBlockMorph&&(e instanceof RingMorph&&!(e instanceof RingMorph&&e.contents())||(o.add(e),e.moveBy(i.extent()),e.fixBlockColor())),i instanceof MultiArgMorph||i instanceof ArgLabelMorph||i.constructor===CommandSlotMorph?(i.fixLayout(),this.fixLabelColor&&this.fixLabelColor()):(i.drawNew(),this.fixLayout()),this.cachedInputs=null,this.endLayout()},SyntaxElementMorph.prototype.silentReplaceInput=function(t,e){var o,i=this.children.indexOf(t);-1!==i&&(t.cachedSlotSpec&&(t.cachedSlotSpec=null),e.cachedSlotSpec&&(e.cachedSlotSpec=null),e.parent&&e.parent.removeChild(e),(((o=t instanceof MultiArgMorph&&this.dynamicInputLabels?new ArgLabelMorph(e):e).parent=this).children[i]=o)instanceof MultiArgMorph||o instanceof ArgLabelMorph||o.constructor===CommandSlotMorph?(o.fixLayout(),this.fixLabelColor&&this.fixLabelColor()):(o.drawNew(),this.fixLayout()),this.cachedInputs=null)},SyntaxElementMorph.prototype.revertToDefaultInput=function(t,e){var o=this.parts().indexOf(t),i=this.inputs().indexOf(t),r=new InputSlotMorph,n=this.parts().filter(function(t){return t instanceof StructInputSlotMorph}).reduce(function(t,e){return t+e.fields.length},0);-1!==(o=-1!==o?o-n:o)&&(this instanceof BlockMorph?(r=this.labelPart(this.parseSpec(this.blockSpec)[o]))instanceof InputSlotMorph&&this.definition&&(r.setChoices.apply(r,this.definition.inputOptionsOfIdx(i)),r.setContents(this.definition.defaultValueOfInputIdx(i))):this instanceof MultiArgMorph?r=this.labelPart(this.slotSpec):this instanceof ReporterSlotMorph&&(r=this.emptySlot()));var s=SnapActions.getFieldValue(this,i);void 0!==s?r.setContents(s):e||-1!==i&&(r instanceof MultiArgMorph?(r.setContents(this.defaults),r.defaults=this.defaults):isNil(this.defaults[i])||r.setContents(this.defaults[i])),this.silentReplaceInput(t,r),r instanceof MultiArgMorph?r.refresh():r instanceof RingMorph&&r.fixBlockColor(),this.cachedInputs=null},SyntaxElementMorph.prototype.isLocked=function(){return this.isStatic},SyntaxElementMorph.prototype.topBlock=function(){return this.parent&&this.parent.topBlock?this.parent.topBlock():this},SyntaxElementMorph.prototype.getVarNamesDict=function(){var t,e,o=this.parentThatIsA(BlockMorph),i=[];return o?(t=o.receiver(),o.allParents().forEach(function(t){t instanceof PrototypeHatBlockMorph?(i.push.apply(i,t.variableNames()),i.push.apply(i,t.inputs()[0].inputFragmentNames())):t instanceof BlockMorph&&t.inputs().forEach(function(t){t instanceof TemplateSlotMorph?i.push(t.contents()):t instanceof MultiArgMorph&&t.children.forEach(function(t){t instanceof TemplateSlotMorph&&i.push(t.contents())})})}),t?(e=t.variables.allNamesDict(),i.forEach(function(t){e[t]=t}),e):{}):{}},SyntaxElementMorph.prototype.refactorVarInStack=function(e,o,t){if(!(this instanceof RingMorph&&contains(this.inputNames(),e)||!t&&this.definesScriptVariable(e))&&("reportGetVar"===this.selector&&this.blockSpec===e&&(this.setSpec(o),this.fullChanged(),this.fixLabelColor()),"getVarNamesDict"===this.choices&&this.contents().text===e&&this.setContents(o),this instanceof CustomCommandBlockMorph&&this.definition.body&&isNil(this.definition.declarations[e])&&!contains(this.definition.variableNames,e)&&this.definition.body.expression.refactorVarInStack(e,o),this.inputs().forEach(function(t){t.refactorVarInStack(e,o)}),this.nextBlock)){var i=this.nextBlock();i&&i.refactorVarInStack(e,o)}},SyntaxElementMorph.prototype.definesScriptVariable=function(e){return("doDeclareVariables"===this.selector||this.blockSpec&&this.blockSpec.match("%upvar"))&&detect(this.inputs()[0].allInputs(),function(t){return"reportGetVar"===t.selector&&t.blockSpec===e})},SyntaxElementMorph.prototype.reactToGrabOf=function(t){var e,o=this.topBlock();t instanceof CommandBlockMorph&&(e=this.parentThatIsA(CommandSlotMorph))&&(this.startLayout(),e.fixLayout(),this.endLayout()),o&&(o.allComments().forEach(function(t){t.align(o)}),o.getHighlight()&&o.addHighlight(o.removeHighlight()))},SyntaxElementMorph.prototype.bright=function(){return this.color.lighter(this.contrast).toString()},SyntaxElementMorph.prototype.dark=function(){return this.color.darker(this.contrast).toString()},SyntaxElementMorph.prototype.setColor=function(t,e){t&&(this.color.eq(t)||(this.color=t,e||this.drawNew(),this.children.forEach(function(t){(!e||t instanceof TemplateSlotMorph)&&(t.drawNew(),t.changed())}),this.changed()))},SyntaxElementMorph.prototype.setLabelColor=function(e,o,i){this.children.forEach(function(t){t instanceof StringMorph&&!t.isProtectedLabel?(t.shadowOffset=i||t.shadowOffset,t.shadowColor=o||t.shadowColor,t.setColor(e)):(t instanceof MultiArgMorph||t instanceof ArgLabelMorph||t instanceof SymbolMorph&&!t.isProtectedLabel||t instanceof InputSlotMorph&&t.isReadOnly)&&t.setLabelColor(e,o,i)})},SyntaxElementMorph.prototype.flash=function(){this.cachedNormalColor||(this.cachedNormalColor=this.color,this.setColor(this.activeHighlight))},SyntaxElementMorph.prototype.unflash=function(){if(this.cachedNormalColor){var t=this.cachedNormalColor;this.cachedNormalColor=null,this.setColor(t)}},SyntaxElementMorph.prototype.fixBlockColor=function(e,o){this.children.forEach(function(t){t instanceof SyntaxElementMorph&&t.fixBlockColor(e,o)})},SyntaxElementMorph.prototype.labelPart=function(t){var e,o;if("%"===t[0]&&1<t.length&&("reportGetVar"!==this.selector||"%turtleOutline"===t&&this.isObjInputFragment())){if(5<t.length&&"%mult"===t.slice(0,5))return(e=new MultiArgMorph(t.slice(5))).addInput(),e;if(5<t.length&&"%hint"===t.slice(0,5))return e=new HintInputSlotMorph("",t.slice(5));if(6<t.length&&"%mhint"===t.slice(0,6))return(e=new MultiHintArgMorph(t.slice(6),null,0)).isStatic=!0,e.canBeEmpty=!1,e;switch(t){case"%imgsource":(e=new InputSlotMorph(null,!1,{"pen trails":["pen trails"],"stage image":["stage image"]},!0)).setContents(["pen trails"]);break;case"%inputs":(e=new MultiArgMorph("%s","with inputs")).isStatic=!1,e.canBeEmpty=!1;break;case"%scriptVars":(e=new MultiArgMorph("%t",null,1,t)).canBeEmpty=!1;break;case"%blockVars":(e=new MultiArgMorph("%t","block variables",0,t)).canBeEmpty=!1;break;case"%parms":(e=new MultiArgMorph("%t","Input Names:",0,t)).canBeEmpty=!1;break;case"%ringparms":e=new MultiArgMorph("%t","input names:",0,t);break;case"%cmdRing":(e=new RingMorph).color=SpriteMorph.prototype.blockColor.other,e.selector="reifyScript",e.setSpec("%rc %ringparms"),e.isDraggable=!0;break;case"%repRing":(e=new RingMorph).color=SpriteMorph.prototype.blockColor.other,e.selector="reifyReporter",e.setSpec("%rr %ringparms"),e.isDraggable=!0,e.isStatic=!0;break;case"%predRing":(e=new RingMorph(!0)).color=SpriteMorph.prototype.blockColor.other,e.selector="reifyPredicate",e.setSpec("%rp %ringparms"),e.isDraggable=!0,e.isStatic=!0;break;case"%words":(e=new MultiArgMorph("%s",null,0)).addInput(),e.addInput(),e.isStatic=!1;break;case"%exp":(e=new MultiArgMorph("%s",null,0)).addInput(),e.isStatic=!0,e.canBeEmpty=!1;break;case"%br":(e=new Morph).setExtent(new Point(0,0)),e.isBlockLabelBreak=!0,e.getSpec=function(){return"%br"};break;case"%inputName":(e=new ReporterBlockMorph).category="variables",e.color=SpriteMorph.prototype.blockColor.variables,e.setSpec(localize("Input name"));break;case"%s":e=new InputSlotMorph;break;case"%anyUE":(e=new InputSlotMorph).isUnevaluated=!0;break;case"%txt":(e=new InputSlotMorph).minWidth=1.7*e.height(),e.fixLayout();break;case"%mlt":(e=new TextSlotMorph).fixLayout();break;case"%code":(e=new TextSlotMorph).contents().fontName="monospace",e.contents().fontStyle="monospace",e.fixLayout();break;case"%obj":e=new ArgMorph("object");break;case"%n":e=new InputSlotMorph(null,!0);break;case"%dir":(e=new InputSlotMorph(null,!0,{"(90) right":90,"(-90) left":-90,"(0) up":"0","(180) down":180})).setContents(90);break;case"%inst":(e=new InputSlotMorph(null,!0,{"(1) Acoustic Grand":1,"(2) Bright Acoustic":2,"(3) Electric Grand":3,"(4) Honky Tonk":4,"(5) Electric Piano 1":5,"(6) Electric Piano 2":6,"(7) Harpsichord":7})).setContents(1);break;case"%audio":e=new InputSlotMorph(null,!1,"audioMenu",!0);break;case"%aa":e=new InputSlotMorph(null,!1,{name:["name"],duration:["duration"],length:["length"],"number of channels":["number of channels"],"sample rate":["sample rate"],samples:["samples"]},!0);break;case"%img":e=new InputSlotMorph(null,!1,{name:["name"],width:["width"],height:["height"],pixels:["pixels"]},!0);break;case"%rate":(e=new InputSlotMorph(null,!0,{"22.05 kHz":22050,"44.1 kHz":44100,"88.2 kHz":88200,"96 kHz":96e3})).setContents(1);break;case"%month":e=new InputSlotMorph(null,!1,{January:["January"],February:["February"],March:["March"],April:["April"],May:["May"],June:["June"],July:["July"],August:["August"],September:["September"],October:["October"],November:["November"],December:["December"]},!0);break;case"%interaction":(e=new InputSlotMorph(null,!1,{clicked:["clicked"],pressed:["pressed"],dropped:["dropped"],"mouse-entered":["mouse-entered"],"mouse-departed":["mouse-departed"]},!0)).isStatic=!0;break;case"%dates":(e=new InputSlotMorph(null,!1,{year:["year"],month:["month"],date:["date"],"day of week":["day of week"],hour:["hour"],minute:["minute"],second:["second"],"time in milliseconds":["time in milliseconds"]},!0)).setContents(["date"]);break;case"%delim":e=new InputSlotMorph(null,!1,{letter:["letter"],whitespace:["whitespace"],line:["line"],tab:["tab"],cr:["cr"]},!1);break;case"%ida":(e=new InputSlotMorph(null,!0,{1:1,last:["last"],"~":null,all:["all"]})).setContents(1);break;case"%idx":(e=new InputSlotMorph(null,!0,{1:1,last:["last"],any:["any"]})).setContents(1);break;case"%spr":e=new InputSlotMorph(null,!1,"objectsMenu",!0);break;case"%col":e=new InputSlotMorph(null,!1,"collidablesMenu",!0);break;case"%dst":e=new InputSlotMorph(null,!1,"distancesMenu",!0);break;case"%cln":e=new InputSlotMorph(null,!1,"clonablesMenu",!0);break;case"%get":(e=new InputSlotMorph(null,!1,"gettablesMenu",!0)).isStatic=!0;break;case"%cst":e=new InputSlotMorph(null,!1,"costumesMenu",!0);break;case"%eff":(e=new InputSlotMorph(null,!1,{color:["color"],fisheye:["fisheye"],whirl:["whirl"],pixelate:["pixelate"],mosaic:["mosaic"],duplicate:["duplicate"],negative:["negative"],comic:["comic"],confetti:["confetti"],saturation:["saturation"],brightness:["brightness"],ghost:["ghost"]},!0)).setContents(["ghost"]);break;case"%snd":e=new InputSlotMorph(null,!1,"soundsMenu",!0);break;case"%key":(e=new InputSlotMorph(null,!1,{"any key":["any key"],"up arrow":["up arrow"],"down arrow":["down arrow"],"right arrow":["right arrow"],"left arrow":["left arrow"],space:["space"],"+":["+"],"-":["-"],a:["a"],b:["b"],c:["c"],d:["d"],e:["e"],f:["f"],g:["g"],h:["h"],i:["i"],j:["j"],k:["k"],l:["l"],m:["m"],n:["n"],o:["o"],p:["p"],q:["q"],r:["r"],s:["s"],t:["t"],u:["u"],v:["v"],w:["w"],x:["x"],y:["y"],z:["z"],0:["0"],1:["1"],2:["2"],3:["3"],4:["4"],5:["5"],6:["6"],7:["7"],8:["8"],9:["9"]},!0)).setContents(["space"]);break;case"%keyHat":(e=this.labelPart("%key")).isStatic=!0;break;case"%msgType":e=new InputSlotMorph(null,!1,"messageTypes",!0);break;case"%msgOutput":e=new MessageOutputSlotMorph;break;case"%msgInput":e=new MessageInputSlotMorph;break;case"%roles":e=new InputSlotMorph(null,!1,"roleNames");break;case"%rpcNames":(e=new InputSlotMorph(null,!1,"rpcNames",!0)).isStatic=!0;break;case"%rpcActions":e=new InputSlotMorph(null,!1,"rpcActions",!0);break;case"%rpcMethod":e=new RPCInputSlotMorph;break;case"%msg":e=new InputSlotMorph(null,!1,"messagesMenu",!0);break;case"%msgHat":(e=new InputSlotMorph(null,!1,"messagesReceivedMenu",!0)).isStatic=!0;break;case"%att":e=new InputSlotMorph(null,!1,"attributesMenu",!0);break;case"%fun":(e=new InputSlotMorph(null,!1,{abs:["abs"],ceiling:["ceiling"],floor:["floor"],sqrt:["sqrt"],sin:["sin"],cos:["cos"],tan:["tan"],asin:["asin"],acos:["acos"],atan:["atan"],ln:["ln"],log:["log"],"e^":["e^"],"10^":["10^"]},!0)).setContents(["sqrt"]);break;case"%txtfun":(e=new InputSlotMorph(null,!1,{"encode URI":["encode URI"],"decode URI":["decode URI"],"encode URI component":["encode URI component"],"decode URI component":["decode URI component"],"XML escape":["XML escape"],"XML unescape":["XML unescape"],"hex sha512 hash":["hex sha512 hash"]},!0)).setContents(["encode URI"]);break;case"%stopChoices":(e=new InputSlotMorph(null,!1,{all:["all"],"this script":["this script"],"this block":["this block"]},!0)).setContents(["all"]),e.isStatic=!0;break;case"%setting":(e=new InputSlotMorph(null,!1,{"turbo mode":["turbo mode"],"flat line ends":["flat line ends"],"video capture":["video capture"],"mirror video":["mirror video"]},!0)).setContents(["turbo mode"]),e.isStatic=!0;break;case"%stopOthersChoices":(e=new InputSlotMorph(null,!1,{"all but this script":["all but this script"],"other scripts in sprite":["other scripts in sprite"]},!0)).setContents(["all but this script"]),e.isStatic=!0;break;case"%typ":(e=new InputSlotMorph(null,!1,"typesMenu",!0)).setContents(["number"]);break;case"%var":(e=new InputSlotMorph(null,!1,"getVarNamesDict",!0)).isStatic=!0;break;case"%shd":(e=new InputSlotMorph(null,!1,"shadowedVariablesMenu",!0)).isStatic=!0;break;case"%lst":e=new InputSlotMorph(null,!1,{list1:"list1",list2:"list2",list3:"list3"},!0);break;case"%codeKind":(e=new InputSlotMorph(null,!1,{code:["code"],header:["header"]},!0)).setContents(["code"]);break;case"%l":e=new ArgMorph("list");break;case"%b":e=new BooleanSlotMorph;break;case"%boolUE":(e=new BooleanSlotMorph).isUnevaluated=!0;break;case"%bool":(e=new BooleanSlotMorph(!0)).isStatic=!0;break;case"%cmd":e=new CommandSlotMorph;break;case"%rc":(e=new RingCommandSlotMorph).isStatic=!0;break;case"%rr":(e=new RingReporterSlotMorph).isStatic=!0;break;case"%rp":(e=new RingReporterSlotMorph(!0)).isStatic=!0;break;case"%c":(e=new CSlotMorph).isStatic=!0;break;case"%cs":e=new CSlotMorph;break;case"%cl":(e=new CSlotMorph).isStatic=!0,e.isLambda=!0;break;case"%clr":(e=new ColorSlotMorph).isStatic=!0;break;case"%t":e=new TemplateSlotMorph("a");break;case"%upvar":e=new TemplateSlotMorph("↑");break;case"%f":e=new FunctionSlotMorph;break;case"%r":e=new ReporterSlotMorph;break;case"%p":e=new ReporterSlotMorph(!0);break;case"%codeListPart":e=new InputSlotMorph(null,!1,{list:["list"],item:["item"],delimiter:["delimiter"]},!0);break;case"%codeListKind":e=new InputSlotMorph(null,!1,{collection:["collection"],variables:["variables"],parameters:["parameters"]},!0);break;case"%turtle":(e=new SymbolMorph("turtle")).size=1.2*this.fontSize,e.color=new Color(255,255,255),e.shadowColor=this.color.darker(this.labelContrast),e.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing,e.drawNew();break;case"%turtleOutline":(e=new SymbolMorph("turtleOutline")).size=this.fontSize,e.color=new Color(255,255,255),e.isProtectedLabel=!0,e.shadowColor=this.color.darker(this.labelContrast),e.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing,e.drawNew();break;case"%clockwise":(e=new SymbolMorph("turnRight")).size=1.5*this.fontSize,e.color=new Color(255,255,255),e.isProtectedLabel=!1,e.shadowColor=this.color.darker(this.labelContrast),e.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing,e.drawNew();break;case"%counterclockwise":(e=new SymbolMorph("turnLeft")).size=1.5*this.fontSize,e.color=new Color(255,255,255),e.isProtectedLabel=!1,e.shadowColor=this.color.darker(this.labelContrast),e.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing,e.drawNew();break;case"%greenflag":(e=new SymbolMorph("flag")).size=1.5*this.fontSize,e.color=new Color(0,200,0),e.isProtectedLabel=!0,e.shadowColor=this.color.darker(this.labelContrast),e.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing,e.drawNew();break;case"%stop":(e=new SymbolMorph("octagon")).size=1.5*this.fontSize,e.color=new Color(200,0,0),e.isProtectedLabel=!0,e.shadowColor=this.color.darker(this.labelContrast),e.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing,e.drawNew();break;case"%pause":(e=new SymbolMorph("pause")).size=this.fontSize,e.color=new Color(255,220,0),e.isProtectedLabel=!0,e.shadowColor=this.color.darker(this.labelContrast),e.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing,e.drawNew();break;case"%self":e=new InputSlotMorph(null,!1,"objectsMenuWithSelf",!0);break;case"%vid":(e=new InputSlotMorph(null,!1,{snap:["snap"],motion:["motion"],direction:["direction"]},!0)).setContents(["motion"]);break;default:nop()}}else"$"===t[0]&&1<t.length&&"reportGetVar"!==this.selector?(o=t.slice(1).split("-"),contains(SymbolMorph.prototype.names,o[0])?(e=new SymbolMorph(o[0])).size=this.fontSize*(+o[1]||1.2):((e=new StringMorph(o[0])).fontName=this.labelFontName,e.fontStyle=this.labelFontStyle,e.fontSize=this.fontSize*(+o[1]||1)),e.color=new Color(0==+o[2]?0:+o[2]||255,0==+o[3]?0:+o[3]||255,0==+o[4]?0:+o[4]||255),e.isProtectedLabel=2<o.length,e.shadowColor=this.color.darker(this.labelContrast),e.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing,e.drawNew()):e=new StringMorph(t,this.fontSize,this.labelFontStyle,!0,!1,!1,MorphicPreferences.isFlat?new Point:this.embossing,this.color.darker(this.labelContrast),new Color(255,255,255),this.labelFontName);return e},SyntaxElementMorph.prototype.isObjInputFragment=function(){return"reportGetVar"===this.selector&&"%t"===this.getSlotSpec()&&"%obj"===this.parent.fragment.type},SyntaxElementMorph.prototype.fixLayout=function(t){var e,o,i,r,n,s=this.parts(),a=this,h=0,l=0,p=0,c=this.minWidth,u=[],d=[],g=this.isPrototype?1:Math.floor(fontHeight(this.fontSize)/3),f=this.extent();if(this instanceof MultiArgMorph&&"%c"!==this.slotSpec?c+=this.arrows().width():c+=this instanceof ReporterBlockMorph?2*this.rounding+2*this.edge:4*this.corner+2*this.edge+3*this.inset+this.dent,this.nextBlock&&(e=this.nextBlock()),s.forEach(function(t){t instanceof CSlotMorph||"%c"===t.slotSpec?0<u.length?(d.push(u),d.push([t]),u=[],h=0):d.push([t]):t instanceof BlockHighlightMorph?nop():(t.isVisible&&(h+=t.fullBounds().width()+g),(h>a.labelWidth||t.isBlockLabelBreak)&&0<u.length&&(d.push(u),u=[],h=t.fullBounds().width()+g),u.push(t),t.isBlockLabelBreak&&(h=0))}),0<u.length&&d.push(u),this instanceof CommandBlockMorph?(o=this.top()+this.corner+this.edge,this instanceof HatBlockMorph&&(o+=this.hatHeight)):this instanceof ReporterBlockMorph?o=this.top()+2*this.edge:(this instanceof MultiArgMorph||this instanceof ArgLabelMorph)&&(o=this.top()),d.forEach(function(t){h=a.left()+a.edge+a.labelPadding,a instanceof RingMorph?h=a.left()+g:a.isPredicate?h=a.left()+a.rounding:(a instanceof MultiArgMorph||a instanceof ArgLabelMorph)&&(h=a.left()),o+=l,l=0,t.forEach(function(t){l=t instanceof CSlotMorph?(h-=a.labelPadding,a.isPredicate&&(h=a.left()+a.rounding),t.setColor(a.color),t.setPosition(new Point(h,o)),t.height()):(t.setPosition(new Point(h,o)),t.isBlockLabelBreak||("%c"===t.slotSpec?h+=t.width():t.isVisible&&(h+=t.fullBounds().width()+g)),p=Math.max(p,h),Math.max(l,t instanceof StringMorph?t.rawHeight():t.height()))}),t.forEach(function(t){t.moveBy(new Point(0,Math.floor((l-t.height())/2)))})}),o+=l,this.children.some(function(t){return t instanceof CSlotMorph})&&(n=this.bottomPadding,this instanceof ReporterBlockMorph&&!this.isPredicate&&(n=Math.max(this.bottomPadding,this.rounding-this.bottomPadding)),o+=n),this instanceof CommandBlockMorph?i=o-this.top()+2*this.corner:this instanceof ReporterBlockMorph?i=o-this.top()+2*this.edge:(this instanceof MultiArgMorph||this instanceof ArgLabelMorph)&&(i=o-this.top()),this.isPredicate?c=Math.max(c,p-this.left()+this.rounding):this instanceof MultiArgMorph||this instanceof ArgLabelMorph?c=Math.max(c,p-this.left()-g):(c=Math.max(c,p-this.left()+this.labelPadding-this.edge),s[s.length-1]instanceof MultiArgMorph&&1===d.length&&(c-=g),this instanceof HatBlockMorph&&(c=Math.max(c,1.5*this.hatWidth))),this.silentSetExtent(new Point(c,i)),s.forEach(function(t){t instanceof CSlotMorph&&(a.isPredicate?t.setWidth(c-2*a.rounding):t.setWidth(c-a.edge))}),t||this.drawNew(),e&&e.setPosition(new Point(this.left(),this.bottom()-this.corner)),this instanceof CommandBlockMorph){if(this.height()!==f.y&&(r=this.parentThatIsA(CommandSlotMorph))&&r.fixLayout(),this.width()!==f.x&&(r=this.parentThatIsAnyOf([ReporterBlockMorph,CommandSlotMorph,RingCommandSlotMorph]))&&r.fixLayout(),r)return}else if(this instanceof ReporterBlockMorph&&this.parent&&this.parent.fixLayout)return this.parent.fixLayout();this.fixHighlight()},SyntaxElementMorph.prototype.fixHighlight=function(){var t=this.topBlock();t.getHighlight&&t.getHighlight()&&t.addHighlight(t.removeHighlight())},SyntaxElementMorph.prototype.evaluate=function(){return null},SyntaxElementMorph.prototype.isEmptySlot=function(){return!1},SyntaxElementMorph.prototype.showBubble=function(t,e){var o,i,r,n,s=!1,a=this.parentThatIsA(IDE_Morph),h=this.receiver(),l=this,p=this.rightCenter().add(new Point(2,0)),c=this.parentThatIsA(ScrollFrameMorph),u=this.world();if(void 0===t||!u)return null;t instanceof ListWatcherMorph?((n=t).update(!0),n.step=t.update,n.isDraggable=!1,n.expand(this.parentThatIsA(ScrollFrameMorph).extent()),s=!0):t instanceof TableFrameMorph?((n=t).isDraggable=!1,n.expand(this.parentThatIsA(ScrollFrameMorph).extent()),s=!0):t instanceof Morph?isSnapObject(t)?(r=t.thumbnail(new Point(40,40)),(n=new Morph).silentSetWidth(r.width),n.silentSetHeight(r.height),n.image=r,n.version=t.version,n.step=function(){this.version!==t.version&&(r=t.thumbnail(new Point(40,40)),this.image=r,this.version=t.version,this.changed())}):(r=t.fullImage(),(n=new Morph).silentSetWidth(r.width),n.silentSetHeight(r.height),n.image=r):t instanceof Costume?(r=t.thumbnail(new Point(40,40)),(n=new Morph).silentSetWidth(r.width),n.silentSetHeight(r.height),n.image=r):t instanceof Context?(r=t.image(),(n=new Morph).silentSetWidth(r.width),n.silentSetHeight(r.height),n.image=r):"boolean"==typeof t?n=SpriteMorph.prototype.booleanMorph.call(null,t):isString(t)?(i=500<t.length?t.slice(0,500)+"...":t,n=new TextMorph(i,this.fontSize)):null===t?n=new TextMorph("",this.fontSize):0===t?n=new TextMorph("0",this.fontSize):t.toString&&(n=new TextMorph(t.toString(),this.fontSize)),a&&a.currentSprite!==h&&(p=(l=h instanceof StageMorph?a.corral.stageIcon:detect(a.corral.frame.contents.children,function(t){return t.object===h})).center()),(o=new SpeechBubbleMorph(n,null,Math.max(this.rounding-2,6),0)).popUp(u,p,s),e&&this.exportPictureWithResult(o),l instanceof SpriteIconMorph?o.keepWithin(a.corral):c&&o.keepWithin(c)},SyntaxElementMorph.prototype.exportPictureWithResult=function(t){var e=this.parentThatIsA(IDE_Morph),o=this.fullImage(),i=t.fullImageClassic(),r=Math.max(0,i.height-o.height),n=newCanvas(new Point(o.width+i.width+2,o.height+r)),s=n.getContext("2d");s.drawImage(o,0,n.height-o.height),s.drawImage(i,o.width+2,0),e.saveCanvasAs(n,e.projectName||localize("Untitled")+" "+localize("script pic"))},SyntaxElementMorph.prototype.mappedCode=function(t){var e=this.evaluate();return e instanceof BlockMorph?e.mappedCode(t):e},SyntaxElementMorph.prototype.startLayout=function(){this.topBlock().fullChanged(),Morph.prototype.trackChanges=!1},SyntaxElementMorph.prototype.endLayout=function(){Morph.prototype.trackChanges=!0,this.topBlock().fullChanged()},BlockMorph.prototype=new SyntaxElementMorph,BlockMorph.prototype.constructor=BlockMorph,BlockMorph.uber=SyntaxElementMorph.prototype,BlockMorph.prototype.isCachingInputs=!0,BlockMorph.prototype.zebraContrast=40,BlockMorph.prototype.snapSound=null,BlockMorph.prototype.toggleSnapSound=function(){null!==this.snapSound?this.snapSound=null:(BlockMorph.prototype.snapSound=document.createElement("audio"),BlockMorph.prototype.snapSound.src="click.wav"),CommentMorph.prototype.snapSound=BlockMorph.prototype.snapSound},BlockMorph.prototype.init=function(t){this.id=null,this.selector=null,this.blockSpec="",this.comment=null,this.instantiationSpec=null,this.category=null,BlockMorph.uber.init.call(this,t),this.color=new Color(0,17,173),this.cashedInputs=null},BlockMorph.prototype.receiver=function(){for(var t=this.parent;t;){if(t.owner)return t.owner;t=t.parent}return null},BlockMorph.prototype.toString=function(){return"a "+(this.constructor.name||this.constructor.toString().split(" ")[1].split("(")[0])+' ("'+this.blockSpec.slice(0,30)+'...")'},BlockMorph.prototype.parseSpec=function(t){var e,o=[],i="";if(0===(e=isString(t)?t.split(" "):[]).length&&(e=[t]),this.labelWordWrap)return e;return e.forEach(function(t){var e;"%"===(e=t)[0]&&1<e.length?(""!==i&&(o.push(i),i=""),o.push(e)):""!==i?i+=" "+e:i=e}),""!==i&&o.push(i),o},BlockMorph.prototype.setSpec=function(t,e){var o,i=this,r=-1;t&&(this.parts().forEach(function(t){t.destroy()}),this.isPrototype&&this.add(this.placeHolder()),this.parseSpec(t).forEach(function(t){"%"===t[0]&&(r+=1),o=i.labelPart(t),i.add(o),o instanceof CommandSlotMorph||o instanceof StringMorph||o.drawNew(),o instanceof RingMorph&&o.fixBlockColor(),(o instanceof MultiArgMorph||o.constructor===CommandSlotMorph||o.constructor===RingCommandSlotMorph)&&o.fixLayout(),i.isPrototype&&i.add(i.placeHolder()),o instanceof InputSlotMorph&&i.definition&&o.setChoices.apply(o,i.definition.inputOptionsOfIdx(r))}),this.blockSpec=t,this.fixLayout(e),this.cachedInputs=null)},BlockMorph.prototype.userSetSpec=function(t){var e=this.topBlock();e.fullChanged(),this.setSpec(t),e.fullChanged()},BlockMorph.prototype.buildSpec=function(){var e=this;this.blockSpec="",this.parts().forEach(function(t){t instanceof StringMorph?e.blockSpec+=t.text:t instanceof ArgMorph?e.blockSpec+=t.getSpec():t.isBlockLabelBreak?e.blockSpec+=t.getSpec():e.blockSpec+="[undefined]",e.blockSpec+=" "}),this.blockSpec=this.blockSpec.trim()},BlockMorph.prototype.rebuild=function(e){this.setSpec(this.blockSpec),e&&this.inputs().forEach(function(t){t instanceof ReporterBlockMorph&&(t.setColor(t.color.lighter(e)),t.setSpec(t.blockSpec))})},BlockMorph.prototype.userMenu=function(){var t,e,o,i,r,n,s,a=new MenuMorph(this),h=this.world(),l=this,p=16===h.currentKey,c=this.activeProcess(),u=c&&c.context&&c.context.outerContext?c.context.outerContext.variables.names():[];return a.addItem("help...","showHelp"),p&&(e=this.topBlock())instanceof ReporterBlockMorph&&a.addItem("script pic with result...",function(){e.exportResultPic()},"open a new window\nwith a picture of both\nthis script and its result",new Color(100,0,0)),this.isTemplate?(this.parent instanceof SyntaxElementMorph?"reportGetVar"===this.selector&&(a.addLine(),a.addItem("rename...",function(){l.refactorThisVar(!0)},"rename only\nthis reporter"),a.addItem("rename all...","refactorThisVar","rename all blocks that\naccess this variable")):("reportGetVar"===this.selector?this.isInheritedVariable()||(o="transient",i="toggleTransientVariable",r=l.isTransientVariable(),n="uncheck to save contents\nin the project",s="check to prevent contents\nfrom being saved",a.addItem((r?"☑ ":"☐ ")+localize(o),i,r?n:s),a.addLine(),a.addItem("rename...",function(){l.refactorThisVar(!0)},"rename only\nthis reporter"),a.addItem("rename all...","refactorThisVar","rename all blocks that\naccess this variable")):"evaluateCustomBlock"!==this.selector&&a.addItem("hide","hidePrimitive"),StageMorph.prototype.enableCodeMapping&&(a.addLine(),a.addItem("header mapping...","mapToHeader"),a.addItem("code mapping...","mapToCode"))),a):(a.addLine(),"reportGetVar"===this.selector?a.addItem("rename...",function(){var t=l.fullCopy();t.addShadow(),new DialogBoxMorph(l,function(t){SnapActions.setBlockSpec(this,t)},l).prompt("Variable name",l.blockSpec,h,t.fullImage(),InputSlotMorph.prototype.getVarNamesDict.call(l))},"rename only\nthis reporter"):SpriteMorph.prototype.blockAlternatives[this.selector]?a.addItem("relabel...",function(){l.relabel(SpriteMorph.prototype.blockAlternatives[l.selector])}):this.definition&&this.alternatives&&0<(t=this.alternatives()).length&&a.addItem("relabel...",function(){l.relabel(t)}),a.addItem("duplicate",function(){var t=l.fullCopy(),e=l.parentThatIsA(IDE_Morph),o=l.parentThatIsA(BlockEditorMorph);t.id=null,t.pickUp(h),!e&&o&&(e=o.target.parentThatIsA(IDE_Morph)),e&&(h.hand.grabOrigin={origin:e.palette,position:e.palette.center()})},"make a copy\nand pick it up"),this instanceof CommandBlockMorph&&this.nextBlock()&&a.addItem((c?this.fullCopy():this).thumbnail(.5,60),function(){var t=l.fullCopy(),e=t.nextBlock(),o=l.parentThatIsA(IDE_Morph);e&&e.destroy(),t.id=null,t.pickUp(h),o&&(h.hand.grabOrigin={origin:o.palette,position:o.palette.center()})},"only duplicate this block"),a.addItem("delete",function(){this.id?SnapActions.removeBlock(this,!0):this.userDestroy()}),a.addItem("script pic...",function(){var t=l.parentThatIsA(IDE_Morph)||l.parentThatIsA(BlockEditorMorph).target.parentThatIsA(IDE_Morph);t.saveCanvasAs(l.topBlock().scriptPic(),(t.projectName||localize("Untitled"))+" "+localize("script pic"))},"download a picture of this script"),c?u.length&&(a.addLine(),u.forEach(function(t){a.addItem(t+"...",function(){c.doShowVar(t)})})):this.parent.parentThatIsA(RingMorph)?(a.addLine(),a.addItem("unringify",function(){SnapActions.unringify(this)}),e=this.topBlock(),!(this instanceof ReporterBlockMorph)&&e instanceof HatBlockMorph||a.addItem("ringify",function(){SnapActions.ringify(this)})):this.parent instanceof ReporterSlotMorph||this.parent instanceof CommandSlotMorph||this instanceof HatBlockMorph||this instanceof CommandBlockMorph&&this.topBlock()instanceof HatBlockMorph||(a.addLine(),a.addItem("ringify",function(){SnapActions.ringify(this)}),StageMorph.prototype.enableCodeMapping&&(a.addLine(),a.addItem("header mapping...","mapToHeader"),a.addItem("code mapping...","mapToCode"))),a)},BlockMorph.prototype.developersMenu=function(){var t=BlockMorph.uber.developersMenu.call(this);return t.addLine(),t.addItem("delete block","deleteBlock"),t.addItem("spec...",function(){new DialogBoxMorph(this,function(t){SnapActions.setBlockSpec(this,t)},this).prompt(t.title+"\nspec",this.blockSpec,this.world())}),t},BlockMorph.prototype.hidePrimitive=function(){var t,e=this.parentThatIsA(IDE_Morph);e&&(StageMorph.prototype.hiddenPrimitives[this.selector]=!0,"lists"===(t={doWarp:"control",reifyScript:"operators",reifyReporter:"operators",reifyPredicate:"operators",doDeclareVariables:"variables"}[this.selector]||this.category)&&(t="variables"),e.flushBlocksCache(t),e.refreshPalette())},BlockMorph.prototype.isInheritedVariable=function(){return!!(this.isTemplate&&"reportGetVar"===this.selector&&this.parent instanceof FrameMorph)&&contains(this.receiver().inheritedVariableNames(),this.blockSpec)},BlockMorph.prototype.isTransientVariable=function(){var t=this.receiver().variables.silentFind(this.blockSpec);return!!t&&t.vars[this.blockSpec].isTransient},BlockMorph.prototype.toggleTransientVariable=function(){var t=this.receiver().variables.silentFind(this.blockSpec);t&&(t.vars[this.blockSpec].isTransient=!t.vars[this.blockSpec].isTransient)},BlockMorph.prototype.deleteBlock=function(){var t,e,o=this.parentThatIsA(ScriptsMorph),i=this.nextBlock?this.nextBlock():null;o&&(i&&o.add(i),this.inputs().forEach(function(t){t instanceof BlockMorph&&o.add(t)})),this instanceof ReporterBlockMorph&&(this.parent instanceof BlockMorph||this.parent instanceof MultiArgMorph||this.parent instanceof ReporterSlotMorph)?this.parent.revertToDefaultInput(this):this.parent?this.parent.fixLayout&&(t=this.parentThatIsA(ArgMorph)):e=!0,this.destroy(),e&&(this.isCorpse=!0),t&&t.fixLayout()},BlockMorph.prototype.ringify=function(){var t=new RingMorph,e=this.topBlock(),o=e.fullBounds().center();if(null===this.parent)return null;if(e.fullChanged(),this.parent instanceof SyntaxElementMorph){if(this instanceof ReporterBlockMorph)this.parent.silentReplaceInput(this,t),t.embed(this);else if(e){if(e instanceof HatBlockMorph)return;e.parent.add(t),t.embed(e),t.setCenter(o)}}else this.parent.add(t),t.embed(this),t.setCenter(o);return this.fixBlockColor(null,!0),e.fullChanged(),t},BlockMorph.prototype.unringify=function(){var t,e,o=this.parent.parentThatIsA(RingMorph),i=this.topBlock(),r=this.parentThatIsA(ScriptsMorph);return null===o?null:(t=o.contents(),e=o.center(),i.fullChanged(),o.parent instanceof SyntaxElementMorph?t instanceof ReporterBlockMorph?o.parent.silentReplaceInput(o,t):r&&(r.add(t),t.setFullCenter(e),t.moveBy(20),o.parent.revertToDefaultInput(o)):(o.parent.add(t),t.setFullCenter(e),o.destroy()),this.fixBlockColor(null,!0),i.fullChanged(),o)},BlockMorph.prototype.relabel=function(t){var o=new MenuMorph(this),i=this.inputs(),r=this;t.forEach(function(t){var e=SpriteMorph.prototype.blockForSelector(t);e.restoreInputs(i),e.fixBlockColor(null,!0),e.addShadow(new Point(3,3)),o.addItem(e,function(){SnapActions.setSelector(r,t)})}),o.popup(this.world(),this.bottomLeft().subtract(new Point(8,this instanceof CommandBlockMorph?this.corner:0)))},BlockMorph.prototype.setSelector=function(t){var e,o,i=this.inputs(),r=this.parentThatIsA(ScriptsMorph);o=SpriteMorph.prototype.blocks[t],this.setCategory(o.category),this.selector=t,this.setSpec(localize(o.spec)),e=this.restoreInputs(i),this.fixLabelColor(),r&&e.length&&e.forEach(function(t){t.moveBy(10),r.add(t)})},BlockMorph.prototype.restoreInputs=function(e){var o,i,r=0,t=[],n=this;for(this.inputs().forEach(function(t){(o=e[r])instanceof ReporterBlockMorph?n.silentReplaceInput(t,o.fullCopy()):o&&t instanceof InputSlotMorph?o.contents&&t.setContents(o.contents().text):o instanceof CSlotMorph&&t instanceof CSlotMorph&&(i=o.nestedBlock())&&t.nestedBlock(i.fullCopy()),r+=1});r<e.length;r+=1)(o=e[r])instanceof ReporterBlockMorph?t.push(o):o instanceof CommandSlotMorph&&o.nestedBlock()&&t.push(o.nestedBlock());return this.cachedInputs=null,t},BlockMorph.prototype.showHelp=function(){var t,e,o,i,r=this,n=this.parentThatIsA(IDE_Morph),s=new Image,a="evaluateCustomBlock"===this.selector,h=a?this.definition.helpSpec():this.selector;n||(t=this.parentThatIsA(BlockEditorMorph))&&(n=t.target.parentThatIsA(IDE_Morph)),s.onload=function(){e=newCanvas(new Point(s.width,s.height),!0),e.getContext("2d").drawImage(s,0,0),(new DialogBoxMorph).inform("Help",null,r.world(),e)},a&&this.definition.comment?((i=this.fullCopy()).addShadow(),(o=this.definition.comment.fullCopy()).contents.parse(),e="",o.contents.lines.forEach(function(t){e=e+"\n"+t}),(new DialogBoxMorph).inform("Help",e.substr(1),r.world(),i.fullImage())):s.src=n.resourceURL("help",h+".png")},BlockMorph.prototype.mapToHeader=function(){var t,e,o="reify"===this.selector.substr(0,5)?"reify":this.selector,i=this.codeDefinitionHeader(),r=this;i.addShadow(new Point(3,3)),e=i.fullImageClassic(),t=this.definition?"Enter code that corresponds to the block's definition. Use the formal parameter\nnames as shown and <body> to reference the definition body's generated text code.":"Enter code that corresponds to the block's definition. Choose your own\nformal parameter names (ignoring the ones shown).",new DialogBoxMorph(this,function(t){"evaluateCustomBlock"===o?r.definition.codeHeader=t:StageMorph.prototype.codeHeaders[o]=t},this).promptCode("Header mapping","evaluateCustomBlock"===o?this.definition.codeHeader||"":StageMorph.prototype.codeHeaders[o]||"",this.world(),e,t)},BlockMorph.prototype.mapToCode=function(){var t,e="reify"===this.selector.substr(0,5)?"reify":this.selector,o=this.codeMappingHeader(),i=this;o.addShadow(new Point(3,3)),t=o.fullImageClassic(),new DialogBoxMorph(this,function(t){"evaluateCustomBlock"===e?i.definition.codeMapping=t:StageMorph.prototype.codeMappings[e]=t},this).promptCode("Code mapping","evaluateCustomBlock"===e?this.definition.codeMapping||"":StageMorph.prototype.codeMappings[e]||"",this.world(),t,"Enter code that corresponds to the block's operation (usually a single\nfunction invocation). Use <#n> to reference actual arguments as shown.")},BlockMorph.prototype.mapHeader=function(t,e){var o=e||"reify"===this.selector.substr(0,5)?"reify":this.selector;t&&(this.definition?this.definition.codeHeader=t:StageMorph.prototype.codeHeaders[o]=t)},BlockMorph.prototype.mapCode=function(t,e){var o=e||"reify"===this.selector.substr(0,5)?"reify":this.selector;t&&(this.definition?this.definition.codeMapping=t:StageMorph.prototype.codeMappings[o]=t)},BlockMorph.prototype.mappedCode=function(t){var e,a,o,i,r,n,s,h="reify"===this.selector.substr(0,5)?"reify":this.selector,l=1,p=this.definition?this.definition.spec:h,c=t||{},u=[];return e="reportGetVar"===h?this.blockSpec:this.definition?this.definition.codeMapping||"":StageMorph.prototype.codeMappings[h]||"","reportGetVar"===h||c.hasOwnProperty(p)||(c[p]=null,this.definition?(-1!==(o=this.definition.codeHeader||"").indexOf("<body")&&(n="",this.definition.body&&(n=this.definition.body.expression.mappedCode(c)),s=n.split("\n"),(r=o.split("\n")).forEach(function(t,e){var o,i="";0===t.trimLeft().indexOf("<body")&&(o=t.indexOf("<body"),i=t.slice(0,o)),r[e]=t.replace(new RegExp("<body>"),s.join("\n"+i)),r[e]=r[e].replace(new RegExp("<body>","g"),s.join("\n"))}),o=r.join("\n")),c[p]=o):c[p]=StageMorph.prototype.codeHeaders[p]),a=e.split("\n"),this.inputs().forEach(function(t){u.push(t.mappedCode(c).toString())}),u.forEach(function(t){var r=t.split("\n"),n="<#"+l+">",s=new RegExp(n,"g");a.forEach(function(t,e){var o,i="";0===t.trimLeft().indexOf(n)&&(o=t.indexOf(n),i=t.slice(0,o)),a[e]=t.replace(new RegExp(n),r.join("\n"+i)),a[e]=a[e].replace(s,r.join("\n"))}),l+=1}),e=a.join("\n"),this.nextBlock&&this.nextBlock()&&(e+="\n"+this.nextBlock().mappedCode(c)),!t&&(i=[],Object.keys(c).forEach(function(t){c[t]&&i.push(c[t])}),i.length)?i.join("\n\n")+"\n\n"+e:e},BlockMorph.prototype.codeDefinitionHeader=function(){var o=this.definition?new PrototypeHatBlockMorph(this.definition):SpriteMorph.prototype.blockForSelector(this.selector),t=new HatBlockMorph,i=1;return this.definition?o:(o.inputs().forEach(function(t){var e=new TemplateSlotMorph("#"+i);o.silentReplaceInput(t,e),i+=1}),o.isPrototype=!0,t.setCategory("control"),t.setSpec("%s"),t.silentReplaceInput(t.inputs()[0],o),"control"===this.category&&t.alternateBlockColor(),t)},BlockMorph.prototype.codeMappingHeader=function(){var o=this.definition?this.definition.blockInstance():SpriteMorph.prototype.blockForSelector(this.selector),t=new HatBlockMorph,i=1;return o.inputs().forEach(function(t){var e=new TemplateSlotMorph("<#"+i+">");o.silentReplaceInput(t,e),i+=1}),o.isPrototype=!0,t.setCategory("control"),t.setSpec("%s"),t.silentReplaceInput(t.inputs()[0],o),"control"===this.category&&t.alternateBlockColor(),t},BlockMorph.prototype.refactorThisVar=function(o){var i,r=this,n=this.blockSpec,s=this.receiver(),a=this.parentThatIsA(IDE_Morph),h=a.stage,l=s.findVariableWatcher(n),t=this.fullCopy();function p(t){a.inform("Variable exists","A variable with this name already exists "+(t||"in this context")+".")}t.addShadow(),new DialogBoxMorph(this,function(e){var t;if(this.parent instanceof SyntaxElementMorph){if(o)return void r.userSetSpec(e);if((t=this.parentThatIsA(CommandBlockMorph)).definesScriptVariable(e))return void p();t.refactorVarInStack(n,e,!0)}else if(s.hasSpriteVariable(n)){if(s.hasSpriteVariable(e))return void p();if(!isNil(a.globalVariables.vars[e]))return void p("as a global variable");i=s.variables.getVar(n),s.deleteVariable(n),s.addVariable(e,!1),s.variables.setVar(e,i),l&&l.isVisible&&s.toggleVariableWatcher(e,!1).setPosition(l.position()),o||(s.refactorVariableInstances(n,e,!1),s.customBlocks.forEach(function(t){t.body.expression.refactorVarInStack(n,e)}))}else{if(!isNil(a.globalVariables.vars[e]))return void p();if(detect(h.children,function(t){return t instanceof SpriteMorph&&t.hasSpriteVariable(e)}))return void p("as a sprite local variable");i=a.globalVariables.getVar(n),h.deleteVariable(n),h.addVariable(e,!0),a.globalVariables.setVar(e,i),l&&l.isVisible&&s.toggleVariableWatcher(e,!0).setPosition(l.position()),o||(h.refactorVariableInstances(n,e,!0),h.globalBlocks.forEach(function(t){t.body.expression.refactorVarInStack(n,e)}),h.forAllChildren(function(t){t instanceof SpriteMorph&&(t.refactorVariableInstances(n,e,!0),t.customBlocks.forEach(function(t){t.body.expression.refactorVarInStack(n,e)}))}))}a.flushBlocksCache("variables"),a.refreshPalette()},this).prompt("Variable name",n,this.world(),t.fullImage(),InputSlotMorph.prototype.getVarNamesDict.call(this))},BlockMorph.prototype.eraseHoles=function(i){var t,e,r=this,n=this instanceof RingMorph,o=.5*this.edge,s=this.parts().filter(function(t){return t.isHole});this.isPredicate&&0<s.length&&(e=this.width()-this.rounding,i.clearRect(e,0,this.width(),this.height()),(t=i.createLinearGradient(e-this.edge,0,this.width(),0)).addColorStop(0,this.color.toString()),t.addColorStop(1,this.dark()),i.lineWidth=this.edge,i.lineJoin="round",i.lineCap="round",i.strokeStyle=t,i.beginPath(),i.moveTo(e-o,this.edge+o),i.lineTo(e-o,this.height()-this.edge-o),i.stroke()),s.forEach(function(t){var e=t.width(),o=Math.floor(t.height())-2;i.clearRect(t.bounds.origin.x-r.bounds.origin.x+1,t.bounds.origin.y-r.bounds.origin.y+1,n?e-2:e+1,o)})},BlockMorph.prototype.addHighlight=function(t){var e,o=!this.isVisible;return o&&this.show(),e=this.highlight(t?t.color:this.activeHighlight,this.activeBlur,this.activeBorder),this.addBack(e),this.fullChanged(),o&&this.hide(),e},BlockMorph.prototype.addErrorHighlight=function(){var t,e=!this.isVisible;return e&&this.show(),this.removeHighlight(),t=this.highlight(this.errorHighlight,this.activeBlur,this.activeBorder),this.addBack(t),this.fullChanged(),e&&this.hide(),t},BlockMorph.prototype.removeHighlight=function(){var t=this.getHighlight();return null!==t&&(this.fullChanged(),this.removeChild(t)),t},BlockMorph.prototype.toggleHighlight=function(){this.getHighlight()?this.removeHighlight():this.addHighlight()},BlockMorph.prototype.highlight=function(t,e,o){var i=new BlockHighlightMorph,r=this.fullBounds(),n=useBlurredShadows&&!MorphicPreferences.isFlat?e:o;return i.setExtent(r.extent().add(2*n)),i.color=t,i.image=useBlurredShadows&&!MorphicPreferences.isFlat?this.highlightImageBlurred(t,e):this.highlightImage(t,o),i.setPosition(r.origin.subtract(new Point(n,n))),i},BlockMorph.prototype.highlightImage=function(t,e){var o,i,r,n,s;return o=this.fullBounds().extent(),i=this.fullImage(),(n=(r=newCanvas(o.add(2*e))).getContext("2d")).drawImage(i,0,0),n.drawImage(i,e,0),n.drawImage(i,2*e,0),n.drawImage(i,2*e,e),n.drawImage(i,2*e,2*e),n.drawImage(i,e,2*e),n.drawImage(i,0,2*e),n.drawImage(i,0,e),n.globalCompositeOperation="destination-out",n.drawImage(i,e,e),(n=(s=newCanvas(o.add(2*e))).getContext("2d")).drawImage(r,0,0),n.globalCompositeOperation="source-atop",n.fillStyle=t.toString(),n.fillRect(0,0,s.width,s.height),s},BlockMorph.prototype.highlightImageBlurred=function(t,e){var o,i,r,n;return o=this.fullBounds().extent(),i=this.fullImage(),(n=(r=newCanvas(o.add(2*e))).getContext("2d")).shadowBlur=e,n.shadowColor=t.toString(),n.drawImage(i,e,e),n.shadowBlur=0,n.globalCompositeOperation="destination-out",n.drawImage(i,e,e),r},BlockMorph.prototype.getHighlight=function(){var t;return 0!==(t=this.children.slice(0).reverse().filter(function(t){return t instanceof BlockHighlightMorph})).length?t[0]:null},BlockMorph.prototype.outline=function(t,e){var o=new BlockHighlightMorph,i=this.fullBounds(),r=e;return o.setExtent(i.extent().add(2*r)),o.color=t,o.image=this.highlightImage(t,e),o.setPosition(i.origin.subtract(new Point(r,r))),o},BlockMorph.prototype.getCategoryColor=function(t){return SpriteMorph.prototype.blockColor[t]||SpriteMorph.prototype.blockColor.other},BlockMorph.prototype.fixBlockColor=function(t,e){var o,i,r=t;if(this.zebraContrast||e){if(!this.zebraContrast&&e)return this.forceNormalColoring();r||this.parent&&(this.isPrototype?r=null:this instanceof ReporterBlockMorph?r=this.parent.parentThatIsA(BlockMorph):(i=this.parentThatIsA(CommandSlotMorph))&&(r=i.parentThatIsA(BlockMorph))),r?r.category===this.category?r.color.eq(this.color)&&this.alternateBlockColor():this.category&&!this.color.eq(this.getCategoryColor(this.category))&&this.alternateBlockColor():(o=this.getCategoryColor(this.category),this.color.eq(o)||this.alternateBlockColor()),e&&this.fixChildrensBlockColor(!0)}},BlockMorph.prototype.forceNormalColoring=function(){var t=this.getCategoryColor(this.category);this.setColor(t,!0),this.setLabelColor(new Color(255,255,255),t.darker(this.labelContrast),new Point(-1,-1)),this.fixChildrensBlockColor(!0)},BlockMorph.prototype.alternateBlockColor=function(){var t=this.getCategoryColor(this.category);this.color.eq(t)?this.setColor(this.zebraContrast<0?t.darker(Math.abs(this.zebraContrast)):t.lighter(this.zebraContrast),this.hasLabels()):this.setColor(t,this.hasLabels()),this.fixLabelColor(),this.fixChildrensBlockColor(!0)},BlockMorph.prototype.ghost=function(){this.setColor(this.getCategoryColor(this.category).lighter(35))},BlockMorph.prototype.fixLabelColor=function(){if(0<this.zebraContrast&&this.category){var t=this.getCategoryColor(this.category);this.color.eq(t)?this.setLabelColor(new Color(255,255,255),t.darker(this.labelContrast),MorphicPreferences.isFlat?null:new Point(-1,-1)):this.setLabelColor(new Color(0,0,0),t.lighter(this.zebraContrast).lighter(2*this.labelContrast),MorphicPreferences.isFlat?null:new Point(1,1))}},BlockMorph.prototype.fixChildrensBlockColor=function(e){var o=this;this.children.forEach(function(t){t instanceof CommandBlockMorph?t.fixBlockColor(null,e):t instanceof SyntaxElementMorph&&(t.fixBlockColor(o,e),t instanceof BooleanSlotMorph&&t.drawNew())})},BlockMorph.prototype.setCategory=function(t){this.category=t,this.startLayout(),this.fixBlockColor(),this.endLayout()},BlockMorph.prototype.hasLabels=function(){return this.children.some(function(t){return t instanceof StringMorph})},BlockMorph.prototype.copy=function(){var t=BlockMorph.uber.copy.call(this);return t.id=this.id,t},BlockMorph.prototype.fullCopy=function(t){if(t){if(!this.hasBlockVars())return copy(this);t=!1}var e=BlockMorph.uber.fullCopy.call(this);return e.removeHighlight(),e.isDraggable=!0,this.instantiationSpec&&e.setSpec(this.instantiationSpec),e.allChildren().filter(function(t){return t instanceof SyntaxElementMorph&&(t.cachedInputs=null,t.definition&&t.initializeVariables()),!isNil(t.comment)}).forEach(function(t){var e=t.comment.fullCopy();(t.comment=e).block=t}),e.cachedInputs=null,e},BlockMorph.prototype.reactToTemplateCopy=function(){this.forceNormalColoring()},BlockMorph.prototype.hasBlockVars=function(){return this.anyChild(function(t){return t.definition&&t.definition.variableNames.length})},BlockMorph.prototype.mouseClickLeft=function(){var t,e=this.topBlock(),o=e.receiver();if(16===this.world().currentKey&&!this.isTemplate)return this.focus();if(e instanceof PrototypeHatBlockMorph)return e.mouseClickLeft();if(o&&(t=o.parentThatIsA(StageMorph))){var i=t.threads.findProcess(e);("receiveSocketMessage"!==e.selector||i)&&(t.threads.toggleProcess(e),e.id&&SnapActions.startScript(e,i))}},BlockMorph.prototype.focus=function(){var t,e=this.parentThatIsA(ScriptsMorph),o=this.world();e&&ScriptsMorph.prototype.enableKeyboard&&(e.focus&&e.focus.stopEditing(),o.stopEditing(),t=new ScriptFocusMorph(e,this),(e.focus=t).getFocus(o),this instanceof HatBlockMorph&&t.nextCommand())},BlockMorph.prototype.activeProcess=function(){var t,e=this.topBlock(),o=e.receiver();return e instanceof PrototypeHatBlockMorph?null:o&&(t=o.parentThatIsA(StageMorph))?t.threads.findProcess(e):null},BlockMorph.prototype.thumbnail=function(t,e){var o,i,r,n,s=this.nextBlock();return s&&(s.isVisible=!1),o=this.fullBounds().extent(),(r=(i=newCanvas(new Point(e?Math.min(o.x*t,e):o.x*t,o.y*t))).getContext("2d")).scale(t,t),r.drawImage(this.fullImage(),0,0),e&&o.x*t>e&&((n=r.createLinearGradient(i.width/t-12,0,i.width/t,0)).addColorStop(0,"transparent"),n.addColorStop(1,"black"),r.globalCompositeOperation="destination-out",r.fillStyle=n,r.fillRect(i.width/t-12,0,i.width/t,i.height/t)),s&&(s.isVisible=!0),i},BlockMorph.prototype.scriptPic=function(){var t=this.fullImage(),e=this.stackFullBounds(),o=newCanvas(e.extent()),i=o.getContext("2d");return this.allComments().forEach(function(t){i.drawImage(t.fullImageClassic(),t.fullBounds().left()-e.left(),t.top()-e.top())}),i.drawImage(t,0,0),o},BlockMorph.prototype.rootForGrab=function(){return this},BlockMorph.prototype.wantsDropOf=function(t){return(t instanceof ArgMorph||t instanceof StringMorph||t instanceof TextMorph)&&!this.isTemplate},BlockMorph.prototype.reactToDropOf=function(t){t.isDraggable=!1,t instanceof InputSlotMorph?t.drawNew():t instanceof MultiArgMorph&&t.fixLayout(),this.fixLayout(),this.buildSpec()},BlockMorph.prototype.situation=function(){if(!(this.parent instanceof TemplateSlotMorph)){var t=this.parentThatIsA(ScriptsMorph);if(t)return{origin:t,position:this.position().subtract(t.position())}}return BlockMorph.uber.situation.call(this)},BlockMorph.prototype.prepareToBeGrabbed=function(e){var o=this;this.allComments().forEach(function(t){t.startFollowing(o,e.world)})},BlockMorph.prototype.justDropped=function(){this.alpha=1,this.allComments().forEach(function(t){t.stopFollowing()})},BlockMorph.prototype.allComments=function(){return this.allChildren().filter(function(t){return!isNil(t.comment)}).map(function(t){return t.comment})},BlockMorph.prototype.destroy=function(){this.allComments().forEach(function(t){t.destroy()}),this.parent&&this.parent.topBlock||!this.activeProcess()||this.activeProcess().stop(),BlockMorph.uber.destroy.call(this)},BlockMorph.prototype.stackHeight=function(){var t=this.fullBounds(),e=Math.max(this.allComments().map(function(t){return t.bottom()}))||this.bottom();return Math.max(t.bottom(),e)-t.top()},BlockMorph.prototype.stackFullBounds=function(){var e=this.fullBounds();return this.allComments().forEach(function(t){e.mergeWith(t.bounds)}),e},BlockMorph.prototype.stackWidth=function(){var t=this.fullBounds(),e=Math.max(this.allComments().map(function(t){return t.right()}))||this.right();return Math.max(t.right(),e)-t.left()},BlockMorph.prototype.snapTarget=function(){return null},BlockMorph.prototype.snap=function(){var t,e,o,i=this.topBlock();i.allComments().forEach(function(t){t.align(i)}),this.getHighlight()&&this!==i&&this.removeHighlight(),i.getHighlight()&&i.addHighlight(i.removeHighlight()),"receiveCondition"===this.selector&&(t=i.receiver())&&(e=t.parentThatIsA(StageMorph))&&(e.enableCustomHatBlocks=!0,e.threads.pauseCustomHatBlocks=!1,(o=e.parentThatIsA(IDE_Morph))&&o.controlBar.stopButton.refresh())},CommandBlockMorph.prototype=new BlockMorph,CommandBlockMorph.prototype.constructor=CommandBlockMorph,CommandBlockMorph.uber=BlockMorph.prototype,CommandBlockMorph.prototype.init=function(t){CommandBlockMorph.uber.init.call(this,t),this.setExtent(new Point(200,100),t),this.partOfCustomCommand=!1,this.exitTag=null},CommandBlockMorph.prototype.blockSequence=function(){var t=this.nextBlock(),e=[this];return t&&(e=e.concat(t.blockSequence())),e},CommandBlockMorph.prototype.bottomBlock=function(){return this.nextBlock()?this.nextBlock().bottomBlock():this},CommandBlockMorph.prototype.nextBlock=function(t){if(!t)return detect(this.children,function(t){return t instanceof CommandBlockMorph&&!t.isPrototype});var e=this.nextBlock(),o=this.parentThatIsA(CommandSlotMorph);this.add(t),e&&t.bottomBlock().nextBlock(e),t.setPosition(new Point(this.left(),this.bottom()-this.corner)),o&&o.fixLayout()},CommandBlockMorph.prototype.topAttachPoint=function(){return new Point(this.dentCenter(),this.top())},CommandBlockMorph.prototype.bottomAttachPoint=function(){return new Point(this.dentCenter(),this.bottom())},CommandBlockMorph.prototype.wrapAttachPoint=function(){var t=detect(this.inputs(),function(t){return t instanceof CSlotMorph});return t&&!t.nestedBlock()?new Point(t.left()+2*t.inset+t.corner,t.top()+2*t.corner):null},CommandBlockMorph.prototype.dentLeft=function(){return this.left()+this.corner+this.inset},CommandBlockMorph.prototype.dentCenter=function(){return this.dentLeft()+this.corner+.5*this.dent},CommandBlockMorph.prototype.attachTargets=function(){var t,e=[];return this instanceof HatBlockMorph||(t=this.topAttachPoint(),this.parent instanceof SyntaxElementMorph||e.push({point:t,element:this,loc:"top",type:"block"}),!ScriptsMorph.prototype.enableNestedAutoWrapping&&this.parentThatIsA(CommandSlotMorph)||e.push({point:t,element:this,loc:"wrap",type:"block"})),this.isStop()||e.push({point:this.bottomAttachPoint(),element:this,loc:"bottom",type:"block"}),e},CommandBlockMorph.prototype.allAttachTargets=function(t){var e=this,o=t||this.parent,i=[];return this instanceof HatBlockMorph&&t.rejectsHats||o.children.filter(function(t){return t!==e&&t instanceof SyntaxElementMorph&&!t.isTemplate}).forEach(function(t){t.forAllChildren(function(t){t.attachTargets&&t.attachTargets().forEach(function(t){i.push(t)})})}),i},CommandBlockMorph.prototype.closestAttachTarget=function(t){var o,e,i=t||this.parent,r=this.bottomBlock(),n=null,s=Math.max(2*this.corner+this.dent,this.minSnapDistance),a=[],h=1e3;return this instanceof HatBlockMorph||(a.push({point:this.topAttachPoint(),loc:"top"}),(e=this.wrapAttachPoint())&&a.push({point:e,loc:"wrap"})),r.isStop()||a.push({point:r.bottomAttachPoint(),loc:"bottom"}),this.allAttachTargets(i).forEach(function(e){a.forEach(function(t){("wrap"===t.loc&&"wrap"===e.loc||t.loc!==e.loc&&"wrap"!==t.loc&&"wrap"!==e.loc)&&(o=t.point.distanceTo(e.point))<s&&o<h&&(h=o,n=e)})}),n},CommandBlockMorph.prototype.snapTarget=function(){return this.closestAttachTarget()},CommandBlockMorph.prototype.snap=function(t){var e,o,i,r,n,s=this.parentThatIsA(ScriptsMorph);if(null===t)return this.startLayout(),this.fixBlockColor(),this.endLayout(),void CommandBlockMorph.uber.snap.call(this);this.startLayout(),"bottom"===t.loc?("slot"===t.type?(this.removeHighlight(),t.element.nestedBlock(this)):t.element.nextBlock(this),this.isStop()&&(o=this.nextBlock())&&(s.add(o),o.moveBy(this.extent().floorDivideBy(2)),(n=this.parentThatIsA(CommandSlotMorph))&&n.fixLayout())):"top"===t.loc?(t.element.removeHighlight(),i=this.bottomBlock().bottom()-this.bottom(),this.setBottom(t.element.top()+this.corner-i),this.setLeft(t.element.left()),this.bottomBlock().nextBlock(t.element)):"wrap"===t.loc&&(r=detect(this.inputs(),function(t){return t instanceof CSlotMorph}),e=t.element.parent,this.moveBy(t.point.subtract(r.slotAttachPoint())),r.nestedBlock(t.element),e instanceof CommandBlockMorph?e.nextBlock(this):e instanceof CommandSlotMorph&&e.nestedBlock(this),t.element.blockSequence().forEach(function(t){t.fixBlockColor()})),this.fixBlockColor(),this.endLayout(),CommandBlockMorph.uber.snap.call(this),this.snapSound&&this.snapSound.play()},CommandBlockMorph.prototype.isStop=function(){return-1<["doStopThis","doStop","doStopBlock","doStopAll","doForever","doReport","removeClone"].indexOf(this.selector)},CommandBlockMorph.prototype.userDestroy=function(){if(this.nextBlock())this.userDestroyJustThis();else{this.parentThatIsA(ScriptsMorph);var t=this.parentThatIsA(SyntaxElementMorph),e=this.parentThatIsA(CSlotMorph);this.destroy(),e&&e.fixLayout(),t&&t.reactToGrabOf(this)}},CommandBlockMorph.prototype.userDestroyJustThis=function(){var t,e,o=this.parentThatIsA(ScriptsMorph),i=this.parentThatIsA(CommandSlotMorph),r=this.nextBlock(),n=this.parentThatIsA(SyntaxElementMorph),s=this.parentThatIsA(CSlotMorph);this.topBlock().fullChanged(),this.parent&&(t=this.parent.parentThatIsA(CommandBlockMorph)),t&&t.nextBlock()===this?e=t:i&&i.nestedBlock()===this&&(e=i),this.destroy(),r?e instanceof CommandSlotMorph?e.nestedBlock(r):e instanceof CommandBlockMorph?e.nextBlock(r):o.add(r):s&&s.fixLayout(),n&&n.reactToGrabOf(this)},CommandBlockMorph.prototype.drawNew=function(){var t;this.cachedClr=this.color.toString(),this.cachedClrBright=this.bright(),this.cachedClrDark=this.dark(),this.image=newCanvas(this.extent()),(t=this.image.getContext("2d")).fillStyle=this.cachedClr,this.drawTop(t),this.drawBody(t),this.drawBottom(t),MorphicPreferences.isFlat?nop():(this.drawTopDentEdge(t,0,0),this.drawBottomDentEdge(t,0,this.height()-this.corner),this.drawLeftEdge(t),this.drawRightEdge(t),this.drawTopLeftEdge(t),this.drawBottomRightEdge(t)),this.eraseHoles(t)},CommandBlockMorph.prototype.drawBody=function(t){t.fillRect(0,Math.floor(this.corner),this.width(),this.height()-Math.floor(3*this.corner)+1)},CommandBlockMorph.prototype.drawTop=function(t){t.beginPath(),t.arc(this.corner,this.corner,this.corner,radians(-180),radians(-90),!1),this.drawDent(t,0,0),t.arc(this.width()-this.corner,this.corner,this.corner,radians(-90),radians(-0),!1),t.closePath(),t.fill()},CommandBlockMorph.prototype.drawBottom=function(t){var e=this.height()-2*this.corner;t.beginPath(),t.arc(this.corner,e,this.corner,radians(180),radians(90),!0),this.isStop()||this.drawDent(t,0,this.height()-this.corner),t.arc(this.width()-this.corner,e,this.corner,radians(90),radians(0),!0),t.closePath(),t.fill()},CommandBlockMorph.prototype.drawDent=function(t,e,o){var i=e+2*this.corner+this.inset;t.lineTo(e+this.corner+this.inset,o),t.lineTo(i,o+this.corner),t.lineTo(i+this.dent,o+this.corner),t.lineTo(e+3*this.corner+this.inset+this.dent,o),t.lineTo(this.width()-this.corner,o)},CommandBlockMorph.prototype.drawTopDentEdge=function(t,e,o){var i,r,n,s,a=.5*this.edge,h=e+2*this.corner+this.inset;t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",(i=t.createLinearGradient(0,o,0,o+this.edge)).addColorStop(0,this.cachedClrBright),i.addColorStop(1,this.cachedClr),t.strokeStyle=i,t.beginPath(),t.moveTo(this.corner,o+a),t.lineTo(e+this.corner+this.inset,o+a),t.stroke(),t.strokeStyle=i,t.beginPath(),t.moveTo(e+3*this.corner+this.inset+this.dent+a,o+a),t.lineTo(this.width()-this.corner,o+a),t.stroke(),s=e+this.corner+this.inset,(n=t.createLinearGradient(s-this.edge,o+this.edge,s,o)).addColorStop(0,this.cachedClr),n.addColorStop(1,this.cachedClrBright),t.strokeStyle=n,t.beginPath(),t.moveTo(e+this.corner+this.inset,o+a),t.lineTo(h,o+this.corner+a),t.stroke(),(r=t.createLinearGradient(0,o+this.corner,0,o+this.corner+this.edge)).addColorStop(0,this.cachedClrBright),r.addColorStop(1,this.cachedClr),t.strokeStyle=r,t.beginPath(),t.moveTo(h,o+this.corner+a),t.lineTo(h+this.dent,o+this.corner+a),t.stroke()},CommandBlockMorph.prototype.drawBottomDentEdge=function(t,e,o){var i,r,n,s=.5*this.edge,a=e+2*this.corner+this.inset;if(t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",(i=t.createLinearGradient(0,o-this.edge,0,o)).addColorStop(0,this.cachedClr),i.addColorStop(1,this.cachedClrDark),t.strokeStyle=i,t.beginPath(),t.moveTo(this.corner,o-s),this.isStop()?t.lineTo(this.width()-this.corner,o-s):t.lineTo(e+this.corner+this.inset-s,o-s),t.stroke(),this.isStop())return null;(r=t.createLinearGradient(0,o+this.corner-this.edge,0,o+this.corner)).addColorStop(0,this.cachedClr),r.addColorStop(1,this.cachedClrDark),t.strokeStyle=r,t.beginPath(),t.moveTo(a+s,o+this.corner-s),t.lineTo(a+this.dent,o+this.corner-s),t.stroke(),(n=t.createLinearGradient(e+a+this.dent-this.edge,o+this.corner-this.edge,e+a+this.dent,o+this.corner)).addColorStop(0,this.cachedClr),n.addColorStop(1,this.cachedClrDark),t.strokeStyle=n,t.beginPath(),t.moveTo(e+a+this.dent,o+this.corner-s),t.lineTo(e+3*this.corner+this.inset+this.dent,o-s),t.stroke(),t.strokeStyle=i,t.beginPath(),t.moveTo(e+3*this.corner+this.inset+this.dent,o-s),t.lineTo(this.width()-this.corner,o-s),t.stroke()},CommandBlockMorph.prototype.drawFlatBottomDentEdge=function(t){this.isStop()||(t.fillStyle=this.color.darker(this.contrast/2).toString(),t.beginPath(),this.drawDent(t,0,this.height()-this.corner),t.closePath(),t.fill())},CommandBlockMorph.prototype.drawLeftEdge=function(t){var e=.5*this.edge,o=t.createLinearGradient(0,0,this.edge,0);o.addColorStop(0,this.cachedClrBright),o.addColorStop(1,this.cachedClr),t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=o,t.beginPath(),t.moveTo(e,this.corner),t.lineTo(e,this.height()-2*this.corner-e),t.stroke()},CommandBlockMorph.prototype.drawRightEdge=function(t){var e,o=.5*this.edge,i=this.width();(e=t.createLinearGradient(i-this.edge,0,i,0)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=e,t.beginPath(),t.moveTo(i-o,this.corner+o),t.lineTo(i-o,this.height()-2*this.corner),t.stroke()},CommandBlockMorph.prototype.drawTopLeftEdge=function(t){var e,o=.5*this.edge;(e=t.createRadialGradient(this.corner,this.corner,this.corner,this.corner,this.corner,this.corner-this.edge)).addColorStop(0,this.cachedClrBright),e.addColorStop(1,this.cachedClr),t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=e,t.beginPath(),t.arc(this.corner,this.corner,this.corner-o,radians(-180),radians(-90),!1),t.stroke()},CommandBlockMorph.prototype.drawBottomRightEdge=function(t){var e,o=.5*this.edge,i=this.width()-this.corner,r=this.height()-2*this.corner;(e=t.createRadialGradient(i,r,this.corner,i,r,this.corner-this.edge)).addColorStop(0,this.cachedClrDark),e.addColorStop(1,this.cachedClr),t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=e,t.beginPath(),t.arc(i,r,this.corner-o,radians(90),radians(0),!0),t.stroke()},HatBlockMorph.prototype=new CommandBlockMorph,HatBlockMorph.prototype.constructor=HatBlockMorph,HatBlockMorph.uber=CommandBlockMorph.prototype,HatBlockMorph.prototype.init=function(){HatBlockMorph.uber.init.call(this,!0),this.setExtent(new Point(300,150))},HatBlockMorph.prototype.readout=function(){for(var t=0;t<this.children.length;t++)if(this.children[t]instanceof SpeechBubbleMorph)return this.children[t]},HatBlockMorph.prototype._msgQueue=function(){for(var t=this.world().children[0].sockets.processes,e=0;e<t.length;e++){var o=t[e];if(o.length&&o[0].block===this)return o}},HatBlockMorph.prototype.clearMessages=function(){for(var t=this.world().children[0].sockets.processes,e=this._msgQueue(),o=0;o<t.length;o++)if(t[o]===e)return t.splice(o,1),void this.updateReadout()},HatBlockMorph.prototype.updateReadout=function(){var e=this,o=this.world(),t=new Color(242,119,68);if(o){var i=this._msgQueue();this.msgCount=i?i.length:0;var r=this.readout();if(this.msgCount<1)r&&r.destroy();else{r?(r.contents=this.msgCount.toString(),r.fullChanged(),r.drawNew(),r.fullChanged()):((r=new SpeechBubbleMorph(this.msgCount.toString(),t,null,null,t.darker(),null,1)).mouseClickLeft=function(){var t=new DialogBoxMorph;t.askYesNo("Clear Message Queue","Do you want to clear the message queue for this block?",o),t.ok=function(){e.clearMessages(),this.destroy()}},this.add(r));var n=this.position().add(new Point(this.width(),0)).add(new Point(5,-10));r.setPosition(n)}}},HatBlockMorph.prototype.blockSequence=function(){var t=HatBlockMorph.uber.blockSequence.call(this);return t.shift(),t},HatBlockMorph.prototype.drawTop=function(t){var e=this.hatWidth,o=this.hatHeight,i=(4*o*o+e*e)/(8*o),r=degrees(4*Math.atan(2*o/e))/2,n=Math.min(1.7*e,this.width()-this.corner);t.beginPath(),t.moveTo(0,o+this.corner),t.arc(e/2,i,i,radians(-r-90),radians(-90),!1),t.bezierCurveTo(e,0,e,o,n,o),t.arc(this.width()-this.corner,o+this.corner,this.corner,radians(-90),radians(-0),!1),t.closePath(),t.fill()},HatBlockMorph.prototype.drawBody=function(t){t.fillRect(0,this.hatHeight+Math.floor(this.corner)-1,this.width(),this.height()-Math.floor(3*this.corner)-this.hatHeight+2)},HatBlockMorph.prototype.drawLeftEdge=function(t){var e=.5*this.edge,o=t.createLinearGradient(0,0,this.edge,0);o.addColorStop(0,this.cachedClrBright),o.addColorStop(1,this.cachedClr),t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=o,t.beginPath(),t.moveTo(e,this.hatHeight+e),t.lineTo(e,this.height()-2*this.corner-e),t.stroke()},HatBlockMorph.prototype.drawRightEdge=function(t){var e,o=.5*this.edge,i=this.width();(e=t.createLinearGradient(i-this.edge,0,i,0)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=e,t.beginPath(),t.moveTo(i-o,this.corner+this.hatHeight+o),t.lineTo(i-o,this.height()-2*this.corner),t.stroke()},HatBlockMorph.prototype.drawTopDentEdge=function(){return null},HatBlockMorph.prototype.drawTopLeftEdge=function(t){var e,o=.5*this.edge,i=this.hatWidth,r=this.hatHeight,n=(4*r*r+i*i)/(8*r),s=degrees(4*Math.atan(2*r/i))/2,a=Math.min(1.7*i,this.width()-this.corner);(e=t.createRadialGradient(i/2,n,n-this.edge,i/2,n,n)).addColorStop(1,this.cachedClrBright),e.addColorStop(0,this.cachedClr),t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=e,t.beginPath(),t.arc(Math.round(i/2),n,n-o,radians(-s-90),radians(-90),!1),t.moveTo(i/2,o),t.bezierCurveTo(i,o,i,r+o,a,r+o),t.lineTo(this.width()-this.corner,r+o),t.stroke()},ReporterBlockMorph.prototype=new BlockMorph,ReporterBlockMorph.prototype.constructor=ReporterBlockMorph,ReporterBlockMorph.uber=BlockMorph.prototype,ReporterBlockMorph.prototype.init=function(t,e){ReporterBlockMorph.uber.init.call(this,e),this.isPredicate=t||!1,this.setExtent(new Point(200,80),e),this.cachedSlotSpec=null},ReporterBlockMorph.prototype.snapTarget=function(t){return this.parent.closestInput(this,t)},ReporterBlockMorph.prototype.snap=function(t){var e,o=this.parent;if(this.cachedSlotSpec=null,!(o instanceof ScriptsMorph))return null;null!==t&&(t instanceof CommandSlotMorph&&(e=t.nestedBlock())&&(e=e.fullCopy(),o.add(e),e.moveBy(e.extent()),e.fixBlockColor()),t.parent.replaceInput(t,this),this.snapSound&&this.snapSound.play()),this.startLayout(),this.fixBlockColor(),this.endLayout(),ReporterBlockMorph.uber.snap.call(this)},ReporterBlockMorph.prototype.prepareToBeGrabbed=function(t){var e=this.position();nop(t),(this.parent instanceof BlockMorph||this.parent instanceof MultiArgMorph||this.parent instanceof ReporterSlotMorph)&&(this.parent.revertToDefaultInput(this),this.setPosition(e)),ReporterBlockMorph.uber.prepareToBeGrabbed.call(this,t),this.alpha=.85,this.cachedSlotSpec=null},ReporterBlockMorph.prototype.blockSequence=function(){return this},ReporterBlockMorph.prototype.isUnevaluated=function(){var t=this.getSlotSpec();return"%anyUE"===t||"%boolUE"===t||"%f"===t},ReporterBlockMorph.prototype.isLocked=function(){return this.isStatic||"%t"===this.getSlotSpec()},ReporterBlockMorph.prototype.getSlotSpec=function(){return this.cachedSlotSpec||(this.cachedSlotSpec=this.determineSlotSpec()),this.cachedSlotSpec},ReporterBlockMorph.prototype.determineSlotSpec=function(){var t;return this.parent instanceof BlockMorph&&-1!==(t=this.parent.parts().filter(function(t){return!(t instanceof BlockHighlightMorph)}).indexOf(this))&&this.parent.blockSpec?this.parseSpec(this.parent.blockSpec)[t]:this.parent instanceof MultiArgMorph?this.parent.slotSpec:this.parent instanceof TemplateSlotMorph?this.parent.getSpec():null},ReporterBlockMorph.prototype.mouseClickLeft=function(t){var e;if(this.parent instanceof BlockInputFragmentMorph)return this.parent.mouseClickLeft();this.parent instanceof TemplateSlotMorph?(e=this.parent.parent&&this.parent.parent.parent&&this.parent.parent.parent instanceof RingMorph?"Input name":"%blockVars"===this.parent.parent.elementSpec?"Block variable name":"Script variable name",new DialogBoxMorph(this,function(t){this.id?SnapActions.setBlockSpec(this,t):this.userSetSpec(t)},this).prompt(e,this.blockSpec,this.world())):ReporterBlockMorph.uber.mouseClickLeft.call(this,t)},ReporterBlockMorph.prototype.exportResultPic=function(){var t,e=this.topBlock(),o=e.receiver();e===this&&o&&(t=o.parentThatIsA(StageMorph))&&(t.threads.stopProcess(e),t.threads.startProcess(e,!1,!0))},ReporterBlockMorph.prototype.userDestroy=function(){var t,e=this.world();e&&(t=e.hand),this.topBlock().fullChanged(),this.prepareToBeGrabbed(t),this.destroy()},ReporterBlockMorph.prototype.drawNew=function(){var t;this.cachedClr=this.color.toString(),this.cachedClrBright=this.bright(),this.cachedClrDark=this.dark(),this.image=newCanvas(this.extent()),(t=this.image.getContext("2d")).fillStyle=this.cachedClr,this.isPredicate?this.drawDiamond(t):this.drawRounded(t),this.eraseHoles(t)},ReporterBlockMorph.prototype.drawRounded=function(t){var e,o=this.height(),i=Math.min(this.rounding,o/2),r=this.width(),n=this.edge/2;t.fillStyle=this.cachedClr,t.beginPath(),t.arc(i,i,i,radians(-180),radians(-90),!1),t.arc(r-i,i,i,radians(-90),radians(-0),!1),t.arc(r-i,o-i,i,radians(0),radians(90),!1),t.arc(i,o-i,i,radians(90),radians(180),!1),t.closePath(),t.fill(),MorphicPreferences.isFlat||(t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",(e=t.createRadialGradient(i,o-i,i-this.edge,i,o-i,i+this.edge)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.arc(i,o-i,i-n,radians(90),radians(180),!1),t.stroke(),(e=t.createRadialGradient(r-i,i,i-this.edge,r-i,i,i+this.edge)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.arc(r-i,i,i-n,radians(-90),radians(0),!1),t.stroke(),(e=t.createLinearGradient(0,0,0,this.edge)).addColorStop(0,this.cachedClrBright),e.addColorStop(1,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(i-n,n),t.lineTo(r-i+n,n),t.stroke(),(e=t.createRadialGradient(i,i,i-this.edge,i,i,i)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.arc(i,i,i-n,radians(180),radians(270),!1),t.stroke(),(e=t.createRadialGradient(r-i,o-i,i-this.edge,r-i,o-i,i)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.arc(r-i,o-i,i-n,radians(0),radians(90),!1),t.stroke(),(e=t.createLinearGradient(0,o-this.edge,0,o)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.moveTo(i-n,o-n),t.lineTo(r-i+n,o-n),t.stroke(),(e=t.createLinearGradient(0,0,this.edge,0)).addColorStop(0,this.cachedClrBright),e.addColorStop(1,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(n,i),t.lineTo(n,o-i),t.stroke(),(e=t.createLinearGradient(r-this.edge,0,r,0)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.moveTo(r-n,i+n),t.lineTo(r-n,o-i),t.stroke())},ReporterBlockMorph.prototype.drawDiamond=function(t){var e,o=this.width(),i=this.height(),r=Math.floor(i/2),n=this.rounding,s=this.edge/2;t.fillStyle=this.cachedClr,t.beginPath(),t.moveTo(0,r),t.lineTo(n,0),t.lineTo(o-n,0),t.lineTo(o,r),t.lineTo(o-n,i),t.lineTo(n,i),t.closePath(),t.fill(),MorphicPreferences.isFlat||(t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",(e=t.createLinearGradient(-n,0,n,0)).addColorStop(1,this.cachedClr),e.addColorStop(0,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.moveTo(s,r),t.lineTo(n,i-s),t.closePath(),t.stroke(),(e=t.createLinearGradient(o-n,0,o+n,0)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.moveTo(o-s,r),t.lineTo(o-n,s),t.closePath(),t.stroke(),(e=t.createLinearGradient(0,0,n,0)).addColorStop(0,this.cachedClrBright),e.addColorStop(1,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(s,r),t.lineTo(n,s),t.closePath(),t.stroke(),(e=t.createLinearGradient(0,0,0,this.edge)).addColorStop(0,this.cachedClrBright),e.addColorStop(1,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(n,s),t.lineTo(o-n,s),t.closePath(),t.stroke(),(e=t.createLinearGradient(o-n,0,o,0)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.moveTo(o-n,i-s),t.lineTo(o-s,r),t.closePath(),t.stroke(),(e=t.createLinearGradient(0,i-this.edge,0,i)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.moveTo(n+s,i-s),t.lineTo(o-n-s,i-s),t.closePath(),t.stroke())},RingMorph.prototype=new ReporterBlockMorph,RingMorph.prototype.constructor=RingMorph,RingMorph.uber=ReporterBlockMorph.prototype,RingMorph.prototype.isCachingInputs=!1,RingMorph.prototype.init=function(){RingMorph.uber.init.call(this),this.category="other",this.alpha=RingMorph.prototype.alpha,this.contrast=RingMorph.prototype.contrast,this.setExtent(new Point(200,80))},RingMorph.prototype.rootForGrab=function(){return this.isDraggable?this:BlockMorph.uber.rootForGrab.call(this)},RingMorph.prototype.embed=function(t,e){var o;this.color=SpriteMorph.prototype.blockColor.other,this.isDraggable=!0,t instanceof CommandBlockMorph?(this.isStatic=!1,this.setSpec("%rc %ringparms"),this.selector="reifyScript",(o=this.parts()[0]).nestedBlock(t)):(t.isPredicate?(this.isStatic=!0,this.setSpec("%rp %ringparms"),this.selector="reifyPredicate"):this.selector=t instanceof BooleanSlotMorph?(this.isStatic=!1,this.setSpec("%rp %ringparms"),"reifyPredicate"):(this.isStatic=!1,this.setSpec("%rr %ringparms"),"reifyReporter"),(o=this.parts()[0]).silentReplaceInput(o.contents(),t)),o=this.parts()[1],e&&e.forEach(function(t){o.addInput(t)}),this.fixBlockColor(null,!0)},RingMorph.prototype.vanishForSimilar=function(){var t=this.parts()[0].nestedBlock();return t&&this.parent instanceof SyntaxElementMorph?this.parent instanceof RingReporterSlotMorph||this.parent instanceof RingCommandSlotMorph?null:void(("reportGetVar"===t.selector||"reportJSFunction"===t.selector||t instanceof RingMorph)&&this.parent.silentReplaceInput(this,t)):null},RingMorph.prototype.contents=function(){return this.parts()[0].nestedBlock()},RingMorph.prototype.inputNames=function(){return this.parts()[1].evaluate()},RingMorph.prototype.dataType=function(){switch(this.selector){case"reifyScript":return"command";case"reifyPredicate":return"predicate";default:return"reporter"}},RingMorph.prototype.fixBlockColor=function(t,e){var o=this.parts()[0];RingMorph.uber.fixBlockColor.call(this,t,e),o.fixLayout()},ScriptsMorph.prototype=new FrameMorph,ScriptsMorph.prototype.constructor=ScriptsMorph,ScriptsMorph.prototype.undoCategory="scripts",ScriptsMorph.uber=FrameMorph.prototype,ScriptsMorph.prototype.cleanUpMargin=20,ScriptsMorph.prototype.cleanUpSpacing=15,ScriptsMorph.prototype.isPreferringEmptySlots=!0,ScriptsMorph.prototype.enableKeyboard=!0,ScriptsMorph.prototype.enableNestedAutoWrapping=!0,ScriptsMorph.prototype.init=function(t){this.owner=t||null,this.feedbackColor=SyntaxElementMorph.prototype.feedbackColor,this.feedbackMorph=new BoxMorph,this.rejectsHats=!1,this.focus=null,ScriptsMorph.uber.init.call(this),this.setColor(new Color(70,70,70)),this.noticesTransparentClick=!0},ScriptsMorph.prototype.fullCopy=function(e){var o,i=new ScriptsMorph,r=this.position();return this.focus&&this.focus.stopEditing(),this.children.forEach(function(t){t.block||(o=t.fullCopy(e),i.add(o),e||(o.setPosition(t.position().subtract(r)),o instanceof BlockMorph&&o.allComments().forEach(function(t){t.align(o)})))}),e||i.adjustBounds(),i},ScriptsMorph.prototype.step=function(){var t,e=this.world(),o=e.hand;return this.feedbackMorph.parent&&(this.feedbackMorph.destroy(),this.feedbackMorph.parent=null),this.focus&&(!e.keyboardReceiver||e.keyboardReceiver instanceof StageMorph)&&this.focus.getFocus(e),0===o.children.length?null:this.bounds.containsPoint(o.bounds.origin)&&((t=o.children[0])instanceof BlockMorph||t instanceof CommentMorph)&&contains(o.morphAtPointer().allParents(),this)?void(t instanceof CommentMorph?this.showCommentDropFeedback(t,o):t instanceof ReporterBlockMorph?this.showReporterDropFeedback(t,o):this.showCommandDropFeedback(t)):null},ScriptsMorph.prototype.showReporterDropFeedback=function(t,e){var o=this.closestInput(t,e);if(null===o)return null;this.feedbackMorph.bounds=o.fullBounds().expandBy(Math.max(2*t.edge,t.reporterDropFeedbackPadding)),this.feedbackMorph.edge=SyntaxElementMorph.prototype.rounding,this.feedbackMorph.border=Math.max(SyntaxElementMorph.prototype.edge,3),this.add(this.feedbackMorph),this.feedbackMorph.borderColor=o instanceof MultiArgMorph?(this.feedbackMorph.color=SpriteMorph.prototype.blockColor.lists.copy(),SpriteMorph.prototype.blockColor.lists):(this.feedbackMorph.color=this.feedbackColor.copy(),this.feedbackColor),this.feedbackMorph.color.a=.5,this.feedbackMorph.drawNew(),this.feedbackMorph.changed()},ScriptsMorph.prototype.showCommandDropFeedback=function(t){var e,o;if(!(o=t.closestAttachTarget(this)))return null;"wrap"!==o.loc?(this.add(this.feedbackMorph),this.feedbackMorph.border=0,this.feedbackMorph.edge=0,this.feedbackMorph.alpha=1,this.feedbackMorph.setExtent(new Point(o.element.width(),Math.max(SyntaxElementMorph.prototype.corner,SyntaxElementMorph.prototype.feedbackMinHeight))),this.feedbackMorph.color=this.feedbackColor,this.feedbackMorph.drawNew(),this.feedbackMorph.changed(),e=o.point.y,"bottom"===o.loc&&("block"===o.type?o.element.nextBlock()&&(e-=SyntaxElementMorph.prototype.corner):"slot"===o.type&&o.element.nestedBlock()&&(e-=SyntaxElementMorph.prototype.corner)),this.feedbackMorph.setPosition(new Point(o.element.left(),e))):this.showCSlotWrapFeedback(t,o.element)},ScriptsMorph.prototype.showCommentDropFeedback=function(t,e){var o=this.closestBlock(t,e);if(!o)return null;this.feedbackMorph.bounds=o.bounds.expandBy(Math.max(2*BlockMorph.prototype.edge,BlockMorph.prototype.reporterDropFeedbackPadding)),this.feedbackMorph.edge=SyntaxElementMorph.prototype.rounding,this.feedbackMorph.border=Math.max(SyntaxElementMorph.prototype.edge,3),this.add(this.feedbackMorph),this.feedbackMorph.color=t.color.copy(),this.feedbackMorph.color.a=.25,this.feedbackMorph.borderColor=t.titleBar.color,this.feedbackMorph.drawNew(),this.feedbackMorph.changed()},ScriptsMorph.prototype.showCSlotWrapFeedback=function(t,e){var o;this.feedbackMorph.bounds=e.fullBounds().expandBy(BlockMorph.prototype.corner),this.feedbackMorph.edge=SyntaxElementMorph.prototype.corner,this.feedbackMorph.border=Math.max(SyntaxElementMorph.prototype.edge,3),this.add(this.feedbackMorph),o=t.color.lighter(40),this.feedbackMorph.color=o.copy(),this.feedbackMorph.color.a=.1,this.feedbackMorph.borderColor=o,this.feedbackMorph.drawNew(),this.feedbackMorph.changed()},ScriptsMorph.prototype.closestInput=function(e,t){var o,i,r,n=e.fullBoundsNoShadow(),s=this.children.filter(function(t){return t instanceof BlockMorph&&t.fullBounds().intersects(n)}),a=e.allInputs();if(r=[],s.forEach(function(t){r=r.concat(t.allInputs())}),0===r.length)return null;if(this.isPreferringEmptySlots){if(t&&(o=t.position(),i=detect(r,function(t){return(t instanceof InputSlotMorph||t instanceof ArgMorph&&!(t instanceof CommandSlotMorph)&&!(t instanceof MultiArgMorph)||t instanceof RingMorph&&!t.contents()||t.isEmptySlot())&&!t.isLocked()&&t.bounds.containsPoint(o)&&!contains(a,t)})))return i;if(i=detect(r,function(t){return(t instanceof InputSlotMorph||t instanceof ArgMorph||t instanceof RingMorph&&!t.contents()||t.isEmptySlot())&&!t.isLocked()&&t.bounds.intersects(n)&&!contains(a,t)&&(!((e=t)instanceof MultiArgMorph)||(o?e.arrows().bounds.containsPoint(o):e.arrows().bounds.intersects(n)));var e,o}))return i}return t&&(o=t.position(),i=detect(r,function(t){return t!==e&&!t.isLocked()&&t.bounds.containsPoint(o)&&!(t.parent instanceof PrototypeHatBlockMorph)&&!contains(a,t)}))?i:detect(r,function(t){return t!==e&&!t.isLocked()&&t.fullBounds().intersects(n)&&!(t.parent instanceof PrototypeHatBlockMorph)&&!contains(a,t)})},ScriptsMorph.prototype.closestBlock=function(t,e){var o,i,r,n=t.bounds,s=this.children.filter(function(t){return t instanceof BlockMorph&&t.fullBounds().intersects(n)});return r=[],s.forEach(function(t){r=r.concat(t.allChildren().slice(0).reverse().filter(function(t){return t instanceof BlockMorph&&!t.isTemplate}))}),0===r.length?null:e&&(o=e.position(),i=detect(r,function(t){return!t.comment&&!t.isPrototype&&t.bounds.containsPoint(o)}))?i:detect(r,function(t){return!t.comment&&!t.isPrototype&&t.bounds.intersects(n)})},ScriptsMorph.prototype.userMenu=function(){var t,e=new MenuMorph(this),o=this.parentThatIsA(IDE_Morph),i=(this.world().currentKey,this),r=this.owner;r.parentThatIsA(StageMorph);return o||(t=this.parentThatIsA(BlockEditorMorph))&&(o=t.target.parentThatIsA(IDE_Morph)),SnapUndo.canUndo(r)&&e.addItem([new SymbolMorph("turnBack",MorphicPreferences.menuFontSize),"undo"],function(){SnapUndo.undo(r)},"undo the last edit"),SnapUndo.canRedo(r)&&e.addItem([new SymbolMorph("turnForward",MorphicPreferences.menuFontSize),"redo"],function(){SnapUndo.redo(r)},"redo the last edit"),(SnapUndo.canUndo(r)||SnapUndo.canRedo(r))&&e.addLine(),e.addItem("clean up","cleanUp","arrange scripts\nvertically"),e.addItem("add comment","addComment"),e.addItem("scripts pic...","exportScriptsPicture","open a new window\nwith a picture of all scripts"),o&&(e.addLine(),e.addItem("make a block...",function(){new BlockDialogMorph(null,function(t){SnapActions.addCustomBlock(t,r).then(function(t){new BlockEditorMorph(t,r).popUp()})},i).prompt("Make a block",null,i.world())})),e},ScriptsMorph.prototype.cleanUp=function(){var t,e,o,i=this.topLeft(),r=this.cleanUpMargin,n=this;this.children.sort(function(t,e){return t instanceof PrototypeHatBlockMorph?0:t.top()-e.top()}),o=this.children.map(function(t){return t.id}),t=this.children.map(function(t){if(!(t instanceof CommentMorph&&t.block))return e=i.add(new Point(n.cleanUpMargin,r)),r+=t.stackHeight()+n.cleanUpSpacing,e}),SnapActions.setBlocksPositions(o,t),this.parent&&this.setPosition(this.parent.topLeft()),this.adjustBounds()},ScriptsMorph.prototype.exportScriptsPicture=function(){var t=this.scriptsPicture(),e=this.world().children[0];t&&e.saveCanvasAs(t,e.projectName||localize("Untitled")+" "+localize("script pic"))},ScriptsMorph.prototype.scriptsPicture=function(){var o,t,i;if(0!==this.children.length)return o=this.children[0].fullBounds(),this.children.forEach(function(t){t.isVisible&&(o=o.merge(t.fullBounds()))}),t=newCanvas(o.extent()),i=t.getContext("2d"),this.children.forEach(function(t){var e=t.fullBounds().origin;t.isVisible&&i.drawImage(t.fullImageClassic(),e.x-o.origin.x,e.y-o.origin.y)}),t},ScriptsMorph.prototype.addComment=function(){var t=this.parentThatIsA(IDE_Morph),e=this.parentThatIsA(BlockEditorMorph),o=this.world();(new CommentMorph).pickUp(o),!t&&e&&(t=e.target.parentThatIsA(IDE_Morph)),t&&(o.hand.grabOrigin={origin:t.palette,position:t.palette.center()})},ScriptsMorph.prototype.definitionOrSprite=function(){var t=this.parent.parent,e=this.owner;return t instanceof BlockEditorMorph&&(e=t.definition),e},ScriptsMorph.prototype.undoOwnerId=function(){return this.definitionOrSprite().id+"/"+this.undoCategory},ScriptsMorph.prototype.addUndoControls=function(){var t=this,e=new AlignmentMorph,o=new Color(140,140,140);this.undoOwnerId();return e.undoButton=new PushButtonMorph(this,function(){SnapUndo.undo(t.undoOwnerId())},new SymbolMorph("turnBack",12)),e.redoButton=new PushButtonMorph(this,function(){SnapUndo.redo(t.undoOwnerId())},new SymbolMorph("turnForward",12)),e.undoButton.alpha=.2,e.undoButton.labelShadowColor=o,e.undoButton.drawNew(),e.undoButton.fixLayout(),e.add(e.undoButton),e.redoButton.alpha=.2,e.redoButton.labelShadowColor=o,e.redoButton.drawNew(),e.redoButton.fixLayout(),e.add(e.redoButton),e},ScriptsMorph.prototype.updateUndoControls=function(){var t,e=this.parentThatIsA(ScrollFrameMorph),o=!1;e&&(t=this.undoOwnerId(),e.toolBar||(e.toolBar=this.addUndoControls(),e.add(e.toolBar),o=!0),SnapUndo.canUndo(t)?e.toolBar.undoButton.isEnabled()||(e.toolBar.undoButton.enable(),o=!0):e.toolBar.undoButton.isEnabled()&&(e.toolBar.undoButton.disable(),o=!0),SnapUndo.canRedo(t)?e.toolBar.redoButton.isEnabled()||(e.toolBar.redoButton.enable(),e.toolBar.undoButton.mouseLeave(),o=!0):e.toolBar.redoButton.isEnabled()&&(e.toolBar.redoButton.disable(),o=!0),e.toolBar.undoButton.isVisible&&e.toolBar.redoButton.isVisible||(e.toolBar.undoButton.show(),e.toolBar.redoButton.show(),o=!0),!o&&e.toolBar.isVisible||(e.toolBar.isVisible=!0,e.toolBar.drawNew(),e.toolBar.changed()),e.adjustToolBar())},ScriptsMorph.prototype.hideUndoControls=function(){var t=this.parentThatIsA(ScrollFrameMorph);t.toolBar&&(t.toolBar.isVisible=!1,t.toolBar.changed())},ScriptsMorph.prototype.sortedElements=function(){var t=this.children.filter(function(t){return!(t instanceof CommentMorph)||!t.block});return t.sort(function(t,e){return t instanceof PrototypeHatBlockMorph?0:t.top()-e.top()}),t},ScriptsMorph.prototype.fixMultiArgs=function(){var t=Morph.prototype.trackChanges;Morph.prototype.trackChanges=!1,this.forAllChildren(function(t){t instanceof MultiArgMorph&&t.fixLayout()}),Morph.prototype.trackChanges=t},ScriptsMorph.prototype.wantsDropOf=function(t){return t instanceof HatBlockMorph?!this.rejectsHats:t instanceof SyntaxElementMorph||t instanceof CommentMorph},ScriptsMorph.prototype.reactToDropOf=function(t,e){var o;(t instanceof BlockMorph||t instanceof CommentMorph)&&((o=t.snapTarget(e))?this.moveBlock(t,o,e):t.id?e&&this.setBlockPosition(t,e):this.addBlock(t)),this.adjustBounds()},ScriptsMorph.prototype.moveBlock=function(t,e,o){var i=o&&o.grabOrigin.origin;if(i!==this&&i instanceof ScriptsMorph){var r=o.grabOrigin.position.add(o.grabOrigin.origin.position()),n=t.fullCopy();this.definitionOrSprite().id;return SnapActions.isCollaborating()&&t.setPosition(r),n.id=null,o.grabOrigin.origin.add(t),SnapActions.moveBlock(n,e).then(function(){return SnapActions.removeBlock(t)})}SnapActions.moveBlock(t,e)},ScriptsMorph.prototype.addBlock=function(t){var e=t.position(),o=t.parentThatIsA(ScriptsMorph),i=this.definitionOrSprite().id;SnapActions.addBlock(t,o,e,i),t.destroy()},ScriptsMorph.prototype.setBlockPosition=function(t,e){var o,i,r=t.position();if(o=e.grabOrigin.position.add(e.grabOrigin.origin.position()),i=function(){t.setPosition(o)},e){if(e.grabOrigin.origin!==this){e.grabOrigin.origin.add(t);var n=t.fullCopy();return ownerId=this.definitionOrSprite().id,SnapActions.addBlock(n,this,r,ownerId).then(function(){return SnapActions.removeBlock(t)})}SnapActions.isReadOnly()&&i()}return SnapActions.setBlockPosition(t,r).catch(i)},ScriptsMorph.prototype.mouseClickLeft=function(t){if(16===this.world().currentKey)return this.edit(t);this.focus&&this.focus.stopEditing(),this.escalateEvent("mouseClickLeft",t)},ScriptsMorph.prototype.edit=function(t){var e=this.world();this.focus&&this.focus.stopEditing(),e.stopEditing(),ScriptsMorph.prototype.enableKeyboard&&(this.focus=new ScriptFocusMorph(this,this,t),this.focus.getFocus(e))},ArgMorph.prototype=new SyntaxElementMorph,ArgMorph.prototype.constructor=ArgMorph,ArgMorph.uber=SyntaxElementMorph.prototype,ArgMorph.prototype.init=function(t,e){this.type=t||null,this.isHole=!1,ArgMorph.uber.init.call(this,e),this.color=new Color(0,17,173),this.setExtent(new Point(50,50),e)},ArgMorph.prototype.executeOnSliderEdit=!1,ArgMorph.prototype.reactToSliderEdit=function(){var t,e,o,i;if(this.executeOnSliderEdit&&(t=this.parentThatIsA(BlockMorph))){if(o=(e=t.topBlock()).receiver(),e instanceof PrototypeHatBlockMorph)return;o&&((i=o.parentThatIsA(StageMorph))&&(i.isThreadSafe||Process.prototype.enableSingleStepping)?i.threads.startProcess(e,i.isThreadSafe):e.mouseClickLeft())}},ArgMorph.prototype.justDropped=function(){this instanceof CommandSlotMorph||(this.drawNew(),this.changed())},ArgMorph.prototype.getSpec=function(){return"%s"},ArgMorph.prototype.drawNew=function(){"list"===this.type?(this.image=this.listIcon(),this.silentSetExtent(new Point(this.image.width,this.image.height))):"object"===this.type?(this.image=this.objectIcon(),this.silentSetExtent(new Point(this.image.width,this.image.height))):ArgMorph.uber.drawNew.call(this)},ArgMorph.prototype.listIcon=function(){var t,e,o,i,r=new Morph,n=new CellMorph,s=new CellMorph;return r.color=new Color(255,255,255),s.setPosition(n.bottomLeft().add(new Point(0,this.fontSize/3))),n.add(s),n.setPosition(r.position().add(this.fontSize)),r.add(n),r.bounds.corner=s.bounds.corner.add(this.fontSize),r.drawNew(),t=r.fullImage(),i=(this.fontSize+this.edge)/t.height,(o=(e=newCanvas(new Point(Math.ceil(t.width*i)+1,Math.ceil(t.height*i)+1))).getContext("2d")).fillStyle="black",o.fillRect(0,0,e.width,e.height),o.scale(i,i),o.drawImage(t,1/i,1/i),e},ArgMorph.prototype.objectIcon=function(){return this.labelPart("%turtle").image},ArgMorph.prototype.isEmptySlot=function(){return null!==this.type},CommandSlotMorph.prototype=new ArgMorph,CommandSlotMorph.prototype.constructor=CommandSlotMorph,CommandSlotMorph.uber=ArgMorph.prototype,CommandSlotMorph.prototype.init=function(t){CommandSlotMorph.uber.init.call(this,null,!0),this.color=new Color(0,17,173),this.setExtent(new Point(230,4*this.corner+this.cSlotPadding),t)},CommandSlotMorph.prototype.getSpec=function(){return"%cmd"},CommandSlotMorph.prototype.topBlock=function(){return this.parent.topBlock?this.parent.topBlock():this.nestedBlock()},CommandSlotMorph.prototype.nestedBlock=function(t){if(!t)return detect(this.children,function(t){return t instanceof CommandBlockMorph});var e=this.nestedBlock();this.add(t),e&&t.bottomBlock().nextBlock(e),this.fixLayout()},CommandSlotMorph.prototype.slotAttachPoint=function(){return new Point(this.dentCenter(),this.top()+2*this.corner)},CommandSlotMorph.prototype.dentLeft=function(){return this.left()+this.corner+2*this.inset},CommandSlotMorph.prototype.dentCenter=function(){return this.dentLeft()+this.corner+.5*this.dent},CommandSlotMorph.prototype.attachTargets=function(){var t=[];return t.push({point:this.slotAttachPoint(),element:this,loc:"bottom",type:"slot"}),t},CommandSlotMorph.prototype.fixLayout=function(){var t=this.nestedBlock();this.parent&&(this.color.eq(this.parent.color)||this.setColor(this.parent.color)),t?(t.setPosition(new Point(this.left()+this.edge+this.rfBorder,this.top()+this.edge+this.rfBorder)),this.setWidth(t.fullBounds().width()+2*(this.edge+this.rfBorder)),this.setHeight(t.fullBounds().height()+this.edge+2*this.rfBorder-(this.corner-this.edge))):(this.setHeight(4*this.corner),this.setWidth(4*this.corner+this.inset+this.dent)),this.parent.fixLayout&&this.parent.fixLayout()},CommandSlotMorph.prototype.evaluate=function(){return this.nestedBlock()},CommandSlotMorph.prototype.isEmptySlot=function(){return!this.isStatic&&null===this.nestedBlock()},CommandSlotMorph.prototype.attach=function(){var t=this.overlappedMorphs(),e=new MenuMorph(this,"choose new parent:"),o=this;t.forEach(function(t){e.addItem(t.toString().slice(0,50),function(){t.add(o),o.isDraggable=!1,t.fixLayout&&t.fixLayout()})}),0<t.length&&e.popUpAtHand(this.world())},CommandSlotMorph.prototype.drawNew=function(){var t;this.cachedClr=this.color.toString(),this.cachedClrBright=this.bright(),this.cachedClrDark=this.dark(),this.image=newCanvas(this.extent()),(t=this.image.getContext("2d")).fillStyle=this.cachedClr,t.fillRect(0,0,this.width(),this.height()),t.fillStyle=this.rfColor.toString(),this.drawFlat(t),MorphicPreferences.isFlat||this.drawEdges(t)},CommandSlotMorph.prototype.drawFlat=function(t){var e=null!==this.nestedBlock(),o=e?this.inset:this.inset/2,i=e?this.dent:this.dent/2,r=2*this.corner+o,n=this.edge,s=e?this.rfBorder:0,a=this.height()-this.corner-n;t.beginPath(),t.arc(this.corner+n,this.corner+n,this.corner,radians(-180),radians(-90),!1),t.lineTo(this.corner+o+n+2*s,n),t.lineTo(r+n+2*s,this.corner+n),t.lineTo(r+n+2*s+(i-2*s),this.corner+n),t.lineTo(r+n+2*s+(i-2*s)+this.corner,n),t.lineTo(this.width()-this.corner-n,n),t.arc(this.width()-this.corner-n,this.corner+n,this.corner,radians(-90),radians(-0),!1),t.arc(this.width()-this.corner-n,a,this.corner,radians(0),radians(90),!1),t.arc(this.corner+n,a,this.corner,radians(90),radians(180),!1),t.closePath(),t.fill()},CommandSlotMorph.prototype.drawEdges=function(t){var e,o,i,r,n=null!==this.nestedBlock(),s=n?this.inset:this.inset/2,a=n?this.dent:this.dent/2,h=2*this.corner+s,l=this.edge,p=n?this.rfBorder:0,c=.5*this.edge;t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",(e=t.createLinearGradient(0,this.height(),0,this.height()-this.edge)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.moveTo(this.corner+l,this.height()-c),t.lineTo(this.width()-this.corner-l,this.height()-c),t.stroke(),(e=t.createRadialGradient(this.width()-(this.corner+l),this.height()-(this.corner+l),this.corner,this.width()-(this.corner+l),this.height()-(this.corner+l),this.corner+l)).addColorStop(0,this.cachedClrBright),e.addColorStop(1,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.arc(this.width()-(this.corner+l),this.height()-(this.corner+l),this.corner+c,radians(0),radians(90),!1),t.stroke(),(e=t.createLinearGradient(this.width(),0,this.width()-this.edge,0)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.moveTo(this.width()-c,this.height()-this.corner-this.edge),t.lineTo(this.width()-c,l+this.corner),t.stroke(),t.shadowOffsetY=c,t.shadowBlur=this.edge,t.shadowColor=this.rfColor.darker(80).toString(),(e=t.createLinearGradient(0,0,l,0)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.moveTo(c,l+this.corner),t.lineTo(c,this.height()-l-this.corner),t.stroke(),(e=t.createRadialGradient(this.corner+l,this.corner+l,this.corner,this.corner+l,this.corner+l,this.corner+l)).addColorStop(0,this.cachedClrDark),e.addColorStop(1,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.arc(this.corner+l,this.corner+l,this.corner+c,radians(-180),radians(-90),!1),t.stroke(),(o=t.createLinearGradient(0,0,0,this.edge)).addColorStop(0,this.cachedClr),o.addColorStop(1,this.cachedClrDark),t.strokeStyle=o,t.beginPath(),t.moveTo(this.corner+l,c),t.lineTo(this.corner+s+l+2*p-c,c),t.stroke(),(i=t.createLinearGradient(0,this.corner,0,this.corner+l)).addColorStop(0,this.cachedClr),i.addColorStop(1,this.cachedClrDark),t.strokeStyle=i,t.beginPath(),t.moveTo(h+l+2*p+c,this.corner+c),t.lineTo(h+l+2*p+(a-2*p),this.corner+c),t.stroke(),(r=t.createLinearGradient(h+l+2*p+(a-2*p)-c,this.corner,h+l+2*p+(a-2*p)+.7*c,this.corner+c+.7*c)).addColorStop(0,this.cachedClr),r.addColorStop(1,this.cachedClrDark),t.strokeStyle=r,t.beginPath(),t.moveTo(h+l+2*p+(a-2*p),this.corner+c),t.lineTo(h+l+2*p+(a-2*p)+this.corner,c),t.stroke(),t.strokeStyle=o,t.beginPath(),t.moveTo(h+l+2*p+(a-2*p)+this.corner,c),t.lineTo(this.width()-this.corner-l,c),t.stroke()},RingCommandSlotMorph.prototype=new CommandSlotMorph,RingCommandSlotMorph.prototype.constructor=RingCommandSlotMorph,RingCommandSlotMorph.uber=CommandSlotMorph.prototype,RingCommandSlotMorph.prototype.rfBorder=0,RingCommandSlotMorph.prototype.edge=RingMorph.prototype.edge,RingCommandSlotMorph.prototype.init=function(t){RingCommandSlotMorph.uber.init.call(this,t),this.isHole=!0,this.noticesTransparentClick=!0,this.color=new Color(0,17,173),this.alpha=RingMorph.prototype.alpha,this.contrast=RingMorph.prototype.contrast},RingCommandSlotMorph.prototype.getSpec=function(){return"%rc"},RingCommandSlotMorph.prototype.drawNew=function(){var t;this.cachedClr=this.color.toString(),this.cachedClrBright=this.bright(),this.cachedClrDark=this.dark(),this.image=newCanvas(this.extent()),(t=this.image.getContext("2d")).fillStyle=this.cachedClr,this.drawFlat(t),MorphicPreferences.isFlat||this.drawEdges(t)},RingCommandSlotMorph.prototype.drawFlat=function(t){var e=null!==this.nestedBlock(),o=e?this.inset:this.inset/2,i=e?this.dent:this.dent/2,r=2*this.corner+o,n=this.edge,s=this.width(),a=this.height(),h=e?this.rfBorder:0,l=a-this.corner-n;t.beginPath(),t.moveTo(0,a/2),t.lineTo(n,a/2),t.arc(this.corner+n,this.corner+n,this.corner,radians(-180),radians(-90),!1),t.lineTo(this.corner+o+n+2*h,n),t.lineTo(r+n+2*h,this.corner+n),t.lineTo(r+n+2*h+(i-2*h),this.corner+n),t.lineTo(r+n+2*h+(i-2*h)+this.corner,n),t.lineTo(this.width()-this.corner-n,n),t.arc(s-this.corner-n,this.corner+n,this.corner,radians(-90),radians(-0),!1),t.lineTo(s-this.edge,a/2),t.lineTo(s,a/2),t.lineTo(s,0),t.lineTo(0,0),t.closePath(),t.fill(),t.beginPath(),t.moveTo(s,a/2),t.lineTo(s-n,a/2),t.arc(this.width()-this.corner-n,l,this.corner,radians(0),radians(90),!1),t.arc(this.corner+n,l,this.corner,radians(90),radians(180),!1),t.lineTo(n,a/2),t.lineTo(0,a/2),t.lineTo(0,a),t.lineTo(s,a),t.closePath(),t.fill()},CSlotMorph.prototype=new CommandSlotMorph,CSlotMorph.prototype.constructor=CSlotMorph,CSlotMorph.uber=CommandSlotMorph.prototype,CSlotMorph.prototype.init=function(t){CommandSlotMorph.uber.init.call(this,null,!0),this.isHole=!0,this.isLambda=!1,this.color=new Color(0,17,173),this.setExtent(new Point(230,4*this.corner+this.cSlotPadding),t)},CSlotMorph.prototype.getSpec=function(){return"%c"},CSlotMorph.prototype.mappedCode=function(t){var r=(StageMorph.prototype.codeMappings.reify||"<#1>").split("\n"),e=this.nestedBlock(),n=(e?e.mappedCode(t):"").toString().split("\n"),s=new RegExp("<#1>","g");return r.forEach(function(t,e){var o,i="";0===t.trimLeft().indexOf("<#1>")&&(o=t.indexOf("<#1>"),i=t.slice(0,o)),r[e]=t.replace(new RegExp("<#1>"),n.join("\n"+i)),r[e]=r[e].replace(s,n.join("\n"))}),r.join("\n")},CSlotMorph.prototype.fixLayout=function(){var t=this.nestedBlock();t?(t.setPosition(new Point(this.left()+this.inset,this.top()+this.corner)),this.setHeight(t.fullBounds().height()+this.corner),this.setWidth(t.fullBounds().width()+2*this.cSlotPadding)):(this.setHeight(4*this.corner+this.cSlotPadding),this.setWidth(4*this.corner+2*this.inset+this.dent+2*this.cSlotPadding)),this.parent.fixLayout&&this.parent.fixLayout()},CSlotMorph.prototype.drawNew=function(){var t;this.cachedClr=this.color.toString(),this.cachedClrBright=this.bright(),this.cachedClrDark=this.dark(),this.image=newCanvas(this.extent()),(t=this.image.getContext("2d")).fillStyle=this.cachedClr,this.drawFlat(t),MorphicPreferences.isFlat||(this.drawTopRightEdge(t),this.drawTopEdge(t,this.inset,this.corner),this.drawTopLeftEdge(t),this.drawBottomEdge(t),this.drawRightEdge(t))},CSlotMorph.prototype.drawFlat=function(t){t.beginPath(),t.moveTo(0,0),t.lineTo(this.width(),0),t.arc(this.width()-this.corner,0,this.corner,radians(90),radians(0),!0),t.lineTo(this.width()-this.corner,this.corner),t.lineTo(2*this.inset+3*this.corner+this.dent,this.corner),t.lineTo(2*this.inset+2*this.corner+this.dent,2*this.corner),t.lineTo(2*this.inset+2*this.corner,2*this.corner),t.lineTo(2*this.inset+this.corner,this.corner),t.lineTo(this.inset+this.corner,this.corner),t.arc(this.inset+this.corner,2*this.corner,this.corner,radians(270),radians(180),!0),t.lineTo(this.inset,this.height()-2*this.corner),t.arc(this.inset+this.corner,this.height()-2*this.corner,this.corner,radians(180),radians(90),!0),t.lineTo(this.width()-this.corner,this.height()-this.corner),t.arc(this.width()-this.corner,this.height(),this.corner,radians(-90),radians(-0),!1),t.lineTo(0,this.height()),t.closePath(),t.fill()},CSlotMorph.prototype.drawTopRightEdge=function(t){var e,o=.5*this.edge,i=this.width()-this.corner;(e=t.createRadialGradient(i,0,this.corner,i,0,this.corner-this.edge)).addColorStop(0,this.cachedClrDark),e.addColorStop(1,this.cachedClr),t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=e,t.beginPath(),t.arc(i,0,this.corner-o,radians(90),radians(0),!0),t.stroke()},CSlotMorph.prototype.drawTopEdge=function(t,e,o){var i,r,n,s=.5*this.edge,a=e+2*this.corner+this.inset;t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",(i=t.createLinearGradient(0,o-this.edge,0,o)).addColorStop(0,this.cachedClr),i.addColorStop(1,this.cachedClrDark),t.strokeStyle=i,t.beginPath(),t.moveTo(e+this.corner,o-s),t.lineTo(e+this.corner+this.inset-s,o-s),t.stroke(),(r=t.createLinearGradient(0,o+this.corner-this.edge,0,o+this.corner)).addColorStop(0,this.cachedClr),r.addColorStop(1,this.cachedClrDark),t.strokeStyle=r,t.beginPath(),t.moveTo(a+s,o+this.corner-s),t.lineTo(a+this.dent,o+this.corner-s),t.stroke(),(n=t.createLinearGradient(e+this.inset+2*this.corner+this.dent-s,o+this.corner-s-s,e+this.inset+2*this.corner+this.dent+.7*s,o+this.corner-s+.7*s)).addColorStop(0,this.cachedClr),n.addColorStop(1,this.cachedClrDark),t.strokeStyle=n,t.beginPath(),t.moveTo(e+this.inset+2*this.corner+this.dent,o+this.corner-s),t.lineTo(e+3*this.corner+this.inset+this.dent,o-s),t.stroke(),t.strokeStyle=i,t.beginPath(),t.moveTo(e+3*this.corner+this.inset+this.dent,o-s),t.lineTo(this.width()-this.corner,o-s),t.stroke()},CSlotMorph.prototype.drawTopLeftEdge=function(t){var e,o=.5*this.edge;(e=t.createRadialGradient(this.corner+this.inset,2*this.corner,this.corner,this.corner+this.inset,2*this.corner,this.corner+this.edge)).addColorStop(0,this.cachedClrDark),e.addColorStop(1,this.cachedClr),t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=e,t.beginPath(),t.arc(this.corner+this.inset,2*this.corner,this.corner+o,radians(-180),radians(-90),!1),t.stroke()},CSlotMorph.prototype.drawRightEdge=function(t){var e,o=.5*this.edge,i=this.inset;(e=t.createLinearGradient(i-this.edge,0,i,0)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=e,t.beginPath(),t.moveTo(i-o,2*this.corner),t.lineTo(i-o,this.height()-2*this.corner),t.stroke()},CSlotMorph.prototype.drawBottomEdge=function(t){var e,o,i=.5*this.edge;t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",(o=t.createRadialGradient(this.corner+this.inset,this.height()-2*this.corner,this.corner,this.corner+this.inset,this.height()-2*this.corner,this.corner+this.edge)).addColorStop(0,this.cachedClrBright),o.addColorStop(1,this.cachedClr),t.strokeStyle=o,t.beginPath(),t.arc(this.corner+this.inset,this.height()-2*this.corner,this.corner+i,radians(180),radians(90),!0),t.stroke(),(e=t.createLinearGradient(0,this.height()-this.corner,0,this.height()-this.corner+this.edge)).addColorStop(0,this.cachedClrBright),e.addColorStop(1,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(this.inset+this.corner,this.height()-this.corner+i),t.lineTo(this.width()-this.corner,this.height()-this.corner+i),t.stroke()},InputSlotMorph.prototype=new ArgMorph,InputSlotMorph.prototype.constructor=InputSlotMorph,InputSlotMorph.uber=ArgMorph.prototype,InputSlotMorph.prototype.init=function(t,e,o,i){var r=new StringMorph(""),n=new ArrowMorph("down",0,Math.max(Math.floor(this.fontSize/6),1));r.fontSize=this.fontSize,r.isShowingBlanks=!0,r.drawNew(),this.isUnevaluated=!1,this.choices=o||null,this.oldContentsExtent=r.extent(),this.isNumeric=e||!1,this.isReadOnly=i||!1,this.minWidth=0,this.constant=null,InputSlotMorph.uber.init.call(this,null,!0),this.color=new Color(255,255,255),this.add(r),this.add(n),r.isEditable=!0,r.isDraggable=!1,r.enableSelecting(),this.setContents(t)},InputSlotMorph.prototype.getSpec=function(){return this.isNumeric?"%n":"%s"},InputSlotMorph.prototype.contents=function(){return detect(this.children,function(t){return t instanceof StringMorph})},InputSlotMorph.prototype.arrow=function(){return detect(this.children,function(t){return t instanceof ArrowMorph})},InputSlotMorph.prototype.setContents=function(t){var e=this.contents(),o=t,i=o instanceof Array;if(i)o=localize(o[0]),e.isItalic=!this.isReadOnly;else if(e.isItalic=!1,!isNil(this.choices)&&this.choices[o]instanceof Array)return this.setContents(this.choices[o]);isNil(e.text=o)?e.text="":o.toString&&(e.text=o.toString()),e.drawNew(),this.isReadOnly&&this.parent instanceof BlockMorph&&this.parent.fixLabelColor(),this.constant=i?t:null,this.lastValue=t},InputSlotMorph.prototype.setDropDownValue=function(t){this.updateFieldValue(t)},InputSlotMorph.prototype.dropDownMenu=function(t){var e=this.menuFromDict(this.choices);0<e.items.length&&(t?(e.popup(this.world(),this.bottomLeft()),e.getFocus()):e.popUpAtHand(this.world()))},InputSlotMorph.prototype.menuFromDict=function(t,e){var o,i=new MenuMorph(this.setDropDownValue,null,this,this.fontSize);for(o in t instanceof Function?t=t.call(this):isString(t)&&(t=this[t]()),e||i.addItem(" ",null),t)Object.prototype.hasOwnProperty.call(t,o)&&("~"===o[0]?i.addLine():t[o]instanceof Object&&!(t[o]instanceof Array)&&"function"!=typeof t[o]?i.addMenu(o,this.menuFromDict(t[o],!0)):i.addItem(o,t[o]));return i},InputSlotMorph.prototype.messageTypesMenu=function(){for(var t=this.parentThatIsA(BlockMorph).receiver().parentThatIsA(StageMorph).messageTypes.names(),e={},o=t.length;o--;)e[t[o]]=t[o];return e},InputSlotMorph.prototype.messageTypes=function(){for(var t=this.parentThatIsA(IDE_Morph).stage.messageTypes.names(),e={},o=t.length;o--;)e[t[o]]=t[o];return e},InputSlotMorph.prototype.roleNames=function(){for(var t=this.root().children[0],e=t.room.getRoleNames(),o={},i=e.length;i--;)t.projectName!==e[i]&&(o[e[i]]=e[i]);return o["others in room"]=["others in room"],o["everyone in room"]=["everyone in room"],o},InputSlotMorph.prototype.getURL=function(t){try{return utils.getUrlSync(t)}catch(t){return""}},InputSlotMorph.prototype.rpcActions=function(){var t,e,o=this.parent.inputs()[0],i={};if(o&&(e=o.evaluate()),e)for(var r=(t=Object.keys(JSON.parse(this.getURL("/rpc/"+e)))).length;r--;)i[t[r]]=t[r];return i},InputSlotMorph.prototype.messagesMenu=function(){var e={},t=this.parentThatIsA(BlockMorph).receiver().parentThatIsA(StageMorph),o=this,i=[];return t.children.concat(t).forEach(function(t){isSnapObject(t)&&(i=i.concat(t.allMessageNames()))}),i.forEach(function(t){e[t]=t}),0<i.length&&(e["~"]=null),e["new..."]=function(){new DialogBoxMorph(o,o.setContents,o).prompt("Message name",null,o.world())},e},InputSlotMorph.prototype.messagesReceivedMenu=function(){var e={"any message":["any message"]},t=this.parentThatIsA(BlockMorph).receiver().parentThatIsA(StageMorph),o=this,i=[];return t.children.concat(t).forEach(function(t){isSnapObject(t)&&(i=i.concat(t.allMessageNames()))}),i.forEach(function(t){e[t]=t}),e["~"]=null,e["new..."]=function(){new DialogBoxMorph(o,o.setContents,o).prompt("Message name",null,o.world())},e},InputSlotMorph.prototype.collidablesMenu=function(){var e={"mouse-pointer":["mouse-pointer"],edge:["edge"],"pen trails":["pen trails"]},o=this.parentThatIsA(BlockMorph).receiver(),t=o.parentThatIsA(StageMorph),i=[];return t.children.forEach(function(t){t instanceof SpriteMorph&&!t.isClone&&t.name!==o.name&&(i=i.concat(t.name))}),0<i.length&&(e["~"]=null,i.forEach(function(t){e[t]=t})),e},InputSlotMorph.prototype.distancesMenu=function(){var e={"mouse-pointer":["mouse-pointer"]},o=this.parentThatIsA(BlockMorph).receiver(),t=o.parentThatIsA(StageMorph),i=[];return t.children.forEach(function(t){t instanceof SpriteMorph&&t.name!==o.name&&(i=i.concat(t.name))}),0<i.length&&(e["~"]=null,i.forEach(function(t){e[t]=t})),e},InputSlotMorph.prototype.clonablesMenu=function(){var e={},t=this.parentThatIsA(BlockMorph).receiver(),o=t.parentThatIsA(StageMorph),i=[];return t instanceof SpriteMorph&&(e.myself=["myself"]),o.children.forEach(function(t){t instanceof SpriteMorph&&!t.isClone&&(i=i.concat(t.name))}),0<i.length&&(e["~"]=null,i.forEach(function(t){e[t]=t})),e},InputSlotMorph.prototype.objectsMenuWithSelf=function(){return this.objectsMenu(!0)},InputSlotMorph.prototype.objectsMenu=function(t){var e=this.parentThatIsA(BlockMorph).receiver().parentThatIsA(StageMorph),o={},i=[];return t&&(o.myself=["myself"]),o[e.name]=e.name,e.children.forEach(function(t){t instanceof SpriteMorph&&i.push(t.name)}),0<i.length&&(o["~"]=null,i.forEach(function(t){o[t]=t})),o},InputSlotMorph.prototype.typesMenu=function(){var t={number:["number"],text:["text"],Boolean:["Boolean"],list:["list"]};return SpriteMorph.prototype.enableFirstClass&&(t.sprite=["sprite"]),t.command=["command"],t.reporter=["reporter"],t.predicate=["predicate"],t},InputSlotMorph.prototype.gettablesMenu=function(){var t={neighbors:["neighbors"],self:["self"],"other sprites":["other sprites"],clones:["clones"],"other clones":["other clones"]};return SpriteMorph.prototype.enableNesting&&(t.parts=["parts"],t.anchor=["anchor"]),t.stage=["stage"],StageMorph.prototype.enableInheritance&&(t.children=["children"],t.parent=["parent"]),t.name=["name"],t["dangling?"]=["dangling?"],t["rotation x"]=["rotation x"],t["rotation y"]=["rotation y"],t["center x"]=["center x"],t["center y"]=["center y"],t},InputSlotMorph.prototype.attributesMenu=function(){var t,e=this.parentThatIsA(BlockMorph),o=e.inputs()[1].evaluate(),i=e.receiver().parentThatIsA(StageMorph),r={},n=[];return(t=o===i.name?i:detect(i.children,function(t){return t.name===o}))&&(r=t instanceof SpriteMorph?{"x position":["x position"],"y position":["y position"],direction:["direction"],"costume #":["costume #"],"costume name":["costume name"],size:["size"]}:{"costume #":["costume #"],"costume name":["costume name"]},0<(n=t.variables.names()).length&&(r["~"]=null,n.forEach(function(t){r[t]=t}))),r},InputSlotMorph.prototype.costumesMenu=function(){var e,t=this.parentThatIsA(BlockMorph).receiver(),o=[];return e=t instanceof SpriteMorph?{Turtle:["Turtle"]}:{Empty:["Empty"]},t.costumes.asArray().forEach(function(t){o=o.concat(t.name)}),0<o.length&&(e["~"]=null,o.forEach(function(t){e[t]=t})),e},InputSlotMorph.prototype.soundsMenu=function(){var t=this.parentThatIsA(BlockMorph).receiver(),e=[],o={};return t.sounds.asArray().forEach(function(t){e=e.concat(t.name)}),0<e.length&&e.forEach(function(t){o[t]=t}),o},InputSlotMorph.prototype.setChoices=function(t,e){var o=this.contents();this.choices=t,this.isReadOnly=e||!1,this.parent instanceof BlockMorph&&(this.parent.fixLabelColor(),e||(o.shadowOffset=new Point,o.shadowColor=null,o.setColor(new Color(0,0,0)))),this.fixLayout()},InputSlotMorph.prototype.shadowedVariablesMenu=function(){var t,e=this.parentThatIsA(BlockMorph),o={};return e&&(t=e.receiver())&&t.inheritedVariableNames(!0).forEach(function(t){o[t]=t}),o},InputSlotMorph.prototype.directionDialMenu=function(){return{"§_dir":null}},InputSlotMorph.prototype.audioMenu=function(){var t={volume:["volume"],note:["note"],frequency:["frequency"],samples:["samples"],"sample rate":["sample rate"],spectrum:["spectrum"],resolution:["resolution"]};return 16===this.world().currentKey&&(t["~"]=null,t.modifier=["modifier"],t.output=["output"]),t},InputSlotMorph.prototype.fixLayout=function(){var t,e,o,i=this.contents(),r=this.arrow();i.isNumeric=this.isNumeric,i.isEditable=!this.isReadOnly,this.isReadOnly?(i.disableSelecting(),i.color=new Color(254,254,254)):(i.enableSelecting(),i.color=new Color(0,0,0)),this.choices?(r.setSize(this.fontSize),r.show()):r.hide(),o=r.isVisible?r.width():0,e=i.height()+2*this.edge,t=this.isNumeric?i.width()+Math.floor(.5*o)+e+2*this.typeInPadding:Math.max(i.width()+o+2*this.edge+2*this.typeInPadding,i.rawHeight?i.rawHeight()+o:fontHeight(i.fontSize)/1.3+o,this.minWidth),this.setExtent(new Point(t,e)),this.isNumeric?i.setPosition(new Point(Math.floor(e/2),this.edge).add(new Point(this.typeInPadding,0)).add(this.position())):i.setPosition(new Point(this.edge,this.edge).add(new Point(this.typeInPadding,0)).add(this.position())),r.isVisible&&r.setPosition(new Point(this.right()-o-this.edge,i.top())),this.parent&&this.parent.fixLayout&&(this.world()?(this.startLayout(),this.parent.fixLayout(),this.endLayout()):this.parent.fixLayout())},InputSlotMorph.prototype.mouseDownLeft=function(t){this.isReadOnly||this.arrow().bounds.containsPoint(t)?this.escalateEvent("mouseDownLeft",t):this.contents().edit()},InputSlotMorph.prototype.mouseClickLeft=function(t){this.arrow().bounds.containsPoint(t)?this.dropDownMenu():this.isReadOnly?this.dropDownMenu():this.contents().edit()},InputSlotMorph.prototype.reactToKeystroke=function(){var t;this.constant&&(t=this.contents(),this.constant=null,t.isItalic=!1,t.drawNew())},InputSlotMorph.prototype.updateFieldValue=function(t){var e=this.parentThatIsA(BlockMorph);if(t=void 0!==t?t:this.contents().text,e.id)return this.setContents(this.lastValue),SnapActions.setField(this,t)},InputSlotMorph.prototype.reactToEdit=function(){this.updateFieldValue(),this.contents().clearSelection()},InputSlotMorph.prototype.freshTextEdit=function(t){this.onNextStep=function(){t.selectAll()}},InputSlotMorph.prototype.userMenu=function(){var t=new MenuMorph(this);return!StageMorph.prototype.enableCodeMapping||this.isNumeric?this.parent.userMenu():(t.addItem("code string mapping...","mapToCode"),t)},InputSlotMorph.prototype.mapToCode=function(){new DialogBoxMorph(this,function(t){StageMorph.prototype.codeMappings.string=t},this).promptCode("Code mapping - String <#1>",StageMorph.prototype.codeMappings.string||"",this.world())},InputSlotMorph.prototype.mappedCode=function(){var t=StageMorph.prototype.codeMappings.string||"<#1>",e=this.parentThatIsA(BlockMorph),o=this.evaluate();return this.isNumeric?o:isNaN(parseFloat(o))&&isString(o)?e&&contains(["doSetVar","doChangeVar","doShowVar","doHideVar"],e.selector)?o:t.replace(/<#1>/g,o):o},InputSlotMorph.prototype.evaluate=function(){var t,e=this.contents();return this.constant?this.constant:this.isNumeric&&(t=parseFloat(e.text||"0"),!isNaN(t))?t:e.text},InputSlotMorph.prototype.isEmptySlot=function(){return""===this.contents().text},InputSlotMorph.prototype.flash=function(){this.cachedNormalColor||(this.cachedNormalColor=this.color,this.color=this.activeHighlight,this.drawNew(),this.changed())},InputSlotMorph.prototype.unflash=function(){if(this.cachedNormalColor){var t=this.cachedNormalColor;this.cachedNormalColor=null,this.color=t,this.drawNew(),this.changed()}},InputSlotMorph.prototype.drawNew=function(){var t,e,o;this.image=newCanvas(this.extent()),t=this.image.getContext("2d"),e=this.cachedNormalColor?this.color:this.parent?this.parent.color:new Color(120,120,120),t.fillStyle=this.color.toString(),this.isReadOnly&&!this.cachedNormalColor&&(t.fillStyle=e.darker().toString()),this.cachedClr=e.toString(),this.cachedClrBright=e.lighter(this.contrast).toString(),this.cachedClrDark=e.darker(this.contrast).toString(),this.isNumeric?(o=(this.height()-2*this.edge)/2,t.beginPath(),t.arc(o+this.edge,o+this.edge,o,radians(90),radians(-90),!1),t.arc(this.width()-o-this.edge,o+this.edge,o,radians(-90),radians(90),!1),t.closePath(),t.fill(),MorphicPreferences.isFlat||this.drawRoundBorder(t)):(t.fillRect(this.edge,this.edge,this.width()-2*this.edge,this.height()-2*this.edge),MorphicPreferences.isFlat||this.drawRectBorder(t))},InputSlotMorph.prototype.drawRectBorder=function(t){var e,o=.5*this.edge;t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.shadowOffsetY=o,t.shadowBlur=this.edge,t.shadowColor=this.color.darker(80).toString(),(e=t.createLinearGradient(0,0,0,this.edge)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.moveTo(this.edge,o),t.lineTo(this.width()-this.edge-o,o),t.stroke(),t.shadowOffsetY=0,(e=t.createLinearGradient(0,0,this.edge,0)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.moveTo(o,this.edge),t.lineTo(o,this.height()-this.edge-o),t.stroke(),t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0,(e=t.createLinearGradient(0,this.height()-this.edge,0,this.height())).addColorStop(0,this.cachedClrBright),e.addColorStop(1,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(this.edge,this.height()-o),t.lineTo(this.width()-this.edge,this.height()-o),t.stroke(),(e=t.createLinearGradient(this.width()-this.edge,0,this.width(),0)).addColorStop(0,this.cachedClrBright),e.addColorStop(1,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(this.width()-o,this.edge),t.lineTo(this.width()-o,this.height()-this.edge),t.stroke()},InputSlotMorph.prototype.drawRoundBorder=function(t){var e,o,i,r=.5*this.edge,n=(this.height()-2*this.edge)/2;t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",(e=n+this.edge)<(o=this.width()-n-this.edge)&&(t.shadowOffsetX=r,t.shadowOffsetY=r,t.shadowBlur=this.edge,t.shadowColor=this.color.darker(80).toString(),(i=t.createLinearGradient(0,0,0,this.edge)).addColorStop(0,this.cachedClr),i.addColorStop(1,this.cachedClrDark),t.strokeStyle=i,t.beginPath(),t.moveTo(e,r),t.lineTo(o,r),t.stroke(),t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0),(i=t.createLinearGradient(0,this.height()-this.edge,0,this.height())).addColorStop(0,this.cachedClrBright),i.addColorStop(1,this.cachedClr),t.strokeStyle=i,t.beginPath(),t.moveTo(n+this.edge,this.height()-r),t.lineTo(this.width()-n-this.edge,this.height()-r),t.stroke(),n=this.height()/2,t.shadowOffsetX=r,t.shadowOffsetY=r,t.shadowBlur=this.edge,t.shadowColor=this.color.darker(80).toString(),(i=t.createRadialGradient(n,n,n-this.edge,n,n,n)).addColorStop(1,this.cachedClr),i.addColorStop(0,this.cachedClrDark),t.strokeStyle=i,t.beginPath(),t.arc(n,n,n-r,radians(180),radians(270),!1),t.stroke(),t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0,(i=t.createRadialGradient(this.width()-n,n,n-this.edge,this.width()-n,n,n)).addColorStop(1,this.cachedClr),i.addColorStop(0,this.cachedClrBright),t.strokeStyle=i,t.beginPath(),t.arc(this.width()-n,n,n-r,radians(0),radians(90),!1),t.stroke()},TemplateSlotMorph.prototype=new ArgMorph,TemplateSlotMorph.prototype.constructor=TemplateSlotMorph,TemplateSlotMorph.uber=ArgMorph.prototype,TemplateSlotMorph.prototype.init=function(t){var e=new ReporterBlockMorph;this.labelString=t||"",e.isDraggable=!1,e.isTemplate=!0,void 0!==modules.objects?(e.color=SpriteMorph.prototype.blockColor.variables,e.category="variables"):(e.color=new Color(243,118,29),e.category=null),e.setSpec(this.labelString),e.selector="reportGetVar",TemplateSlotMorph.uber.init.call(this),this.add(e),this.fixLayout(),this.isDraggable=!1,this.isStatic=!0},TemplateSlotMorph.prototype.getSpec=function(){return"%t"},TemplateSlotMorph.prototype.template=function(){return this.children[0]},TemplateSlotMorph.prototype.contents=function(){return this.template().blockSpec},TemplateSlotMorph.prototype.setContents=function(t){var e=this.template();e.setSpec(t),e.fixBlockColor(),e.fixLabelColor()},TemplateSlotMorph.prototype.evaluate=function(){return this.contents()},TemplateSlotMorph.prototype.fixLayout=function(){var t=this.template();this.setExtent(t.extent().add(2*this.edge+2)),t.setPosition(this.position().add(this.edge+1)),this.parent&&this.parent.fixLayout&&this.parent.fixLayout()},TemplateSlotMorph.prototype.wantsDropOf=function(t){return"reportGetVar"===t.selector},TemplateSlotMorph.prototype.reactToDropOf=function(t){"reportGetVar"===t.selector&&t.destroy()},TemplateSlotMorph.prototype.drawNew=function(){var t;this.parent instanceof Morph&&(this.color=this.parent.color.copy()),this.cachedClr=this.color.toString(),this.cachedClrBright=this.bright(),this.cachedClrDark=this.dark(),this.image=newCanvas(this.extent()),(t=this.image.getContext("2d")).fillStyle=this.cachedClr,this.drawRounded(t)},TemplateSlotMorph.prototype.drawRounded=ReporterBlockMorph.prototype.drawRounded,TemplateSlotMorph.prototype.flash=function(){this.template().flash()},TemplateSlotMorph.prototype.unflash=function(){this.template().unflash()},BooleanSlotMorph.prototype=new ArgMorph,BooleanSlotMorph.prototype.constructor=BooleanSlotMorph,BooleanSlotMorph.uber=ArgMorph.prototype,BooleanSlotMorph.prototype.init=function(t){this.value="boolean"==typeof t?t:null,this.isUnevaluated=!1,BooleanSlotMorph.uber.init.call(this)},BooleanSlotMorph.prototype.getSpec=function(){return this.isUnevaluated?"%boolUE":"%b"},BooleanSlotMorph.prototype.evaluate=function(){return this.value},BooleanSlotMorph.prototype.isEmptySlot=function(){return null===this.value},BooleanSlotMorph.prototype.setContents=function(t,e){this.value="boolean"==typeof t?t:null,e||(this.drawNew(),this.changed())},BooleanSlotMorph.prototype.toggleValue=function(){var t=this.parentThatIsA(IDE_Morph);if(this.isStatic)this.setContents(!this.value,!0);else switch(this.value){case!0:this.value=!1;break;case!1:this.value=null;break;default:this.value=!0}if(t&&!t.isAnimating)return this.drawNew(),void this.changed();this.drawNew(3),this.changed(),this.nextSteps([function(){this.drawNew(2),this.changed()},function(){this.drawNew(1),this.changed()},function(){this.drawNew(),this.changed()}])},BooleanSlotMorph.prototype.mouseClickLeft=function(){this.parentThatIsA(BlockMorph).id?SnapActions.toggleBoolean(this,this.value):this.toggleValue()},BooleanSlotMorph.prototype.mouseEnter=function(){if(!this.isStatic){if(!1===this.value){var t=this.value;return this.value=null,this.drawNew(3),this.changed(),void(this.value=t)}this.drawNew(1),this.changed()}},BooleanSlotMorph.prototype.mouseLeave=function(){this.isStatic||(this.drawNew(),this.changed())},BooleanSlotMorph.prototype.drawNew=function(t){var e,o,i=this.isStatic?this.textLabel():null;i?(o=i.height+3*this.edge,this.silentSetExtent(new Point(i.width+1.5*o+2*this.edge,o))):this.silentSetExtent(new Point(2*(this.fontSize+2*this.edge),this.fontSize+2*this.edge)),this.cachedNormalColor||(this.color=this.parent?this.parent.color:new Color(200,200,200)),this.cachedClr=this.color.toString(),this.cachedClrBright=this.bright(),this.cachedClrDark=this.dark(),this.image=newCanvas(this.extent()),e=this.image.getContext("2d"),this.drawDiamond(e,t),this.drawLabel(e,i),this.drawKnob(e,t)},BooleanSlotMorph.prototype.drawDiamond=function(t,e){var o,i=this.width(),r=this.height(),n=r/2,s=i/2,a=this.edge/2;if(this.cachedNormalColor)t.fillStyle=this.color.toString();else switch(this.value){case!0:t.fillStyle="rgb(0, 200, 0)";break;case!1:t.fillStyle="rgb(200, 0, 0)";break;default:t.fillStyle=this.color.darker(25).toString()}e&&!this.isEmptySlot()?(t.fillStyle="rgb(0, 200, 0)",t.beginPath(),t.moveTo(0,n),t.lineTo(n,0),t.lineTo(s,0),t.lineTo(s,r),t.lineTo(n,r),t.closePath(),t.fill(),t.fillStyle="rgb(200, 0, 0)",t.beginPath(),t.moveTo(s,0),t.lineTo(i-n,0),t.lineTo(i,n),t.lineTo(i-n,r),t.lineTo(s,r)):(t.beginPath(),t.moveTo(0,n),t.lineTo(n,0),t.lineTo(i-n,0),t.lineTo(i,n),t.lineTo(i-n,r),t.lineTo(n,r)),t.closePath(),t.fill(),MorphicPreferences.isFlat||(t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.shadowOffsetX=a,t.shadowBlur=a,t.shadowColor="black",(o=t.createLinearGradient(0,n,.6*this.edge,n+.6*this.edge)).addColorStop(1,this.cachedClrDark),o.addColorStop(0,this.cachedClr),t.strokeStyle=o,t.beginPath(),t.moveTo(a,n),t.lineTo(n,a),t.closePath(),t.stroke(),t.shadowOffsetX=0,t.shadowOffsetY=a,t.shadowBlur=this.edge,(o=t.createLinearGradient(0,0,0,this.edge)).addColorStop(1,this.cachedClrDark),o.addColorStop(0,this.cachedClr),t.strokeStyle=o,t.beginPath(),t.moveTo(n,a),t.lineTo(i-n,a),t.closePath(),t.stroke(),t.shadowOffsetY=0,t.shadowBlur=0,(o=t.createLinearGradient(i-n-.6*this.edge,r-.6*this.edge,i-n,r)).addColorStop(1,this.cachedClr),o.addColorStop(0,this.cachedClrBright),t.strokeStyle=o,t.beginPath(),t.moveTo(i-n,r-a),t.lineTo(i-a,n),t.closePath(),t.stroke(),(o=t.createLinearGradient(0,r-this.edge,0,r)).addColorStop(1,this.cachedClr),o.addColorStop(0,this.cachedClrBright),t.strokeStyle=o,t.beginPath(),t.moveTo(n,r-a),t.lineTo(i-n-a,r-a),t.closePath(),t.stroke())},BooleanSlotMorph.prototype.drawLabel=function(t,e){var o,i=this.width(),r=this.height()/2-this.edge,n=r/2,s=this.edge/2,a=this.height()/2;if(!this.isEmptySlot()){if(e)return a=(this.height()-e.height)/2,o=this.value?this.height()/2:this.width()-this.height()/2-e.width,MorphicPreferences.isFlat||(t.shadowOffsetX=-s,t.shadowOffsetY=-s,t.shadowBlur=s,t.shadowColor=this.value?"rgb(0, 100, 0)":"rgb(100, 0, 0)"),void t.drawImage(e,o,a);o=r+2*this.edge+s,MorphicPreferences.isFlat||(t.shadowOffsetX=-s,t.shadowOffsetY=-s,t.shadowBlur=s,t.shadowColor="rgb(0, 100, 0)"),t.strokeStyle="white",t.lineWidth=this.edge+s,t.lineCap="round",t.lineJoin="miter",t.beginPath(),t.moveTo(o-n,a),t.lineTo(o,a+n),t.lineTo(o+n,n+this.edge),t.stroke(),o=i-a-2*this.edge,MorphicPreferences.isFlat||(t.shadowOffsetX=-s,t.shadowOffsetY=-s,t.shadowBlur=s,t.shadowColor="rgb(100, 0, 0)"),t.strokeStyle="white",t.lineWidth=this.edge,t.lineCap="butt",t.beginPath(),t.moveTo(o-n,a-n),t.lineTo(o+n,a+n),t.moveTo(o-n,a+n),t.lineTo(o+n,a-n),t.stroke()}},BooleanSlotMorph.prototype.drawKnob=function(t,e){var o,i,r=this.width(),n=this.height()/2,s=this.edge/2,a=(this.width()-this.height())/4*(e||0),h=n,l=PushButtonMorph.prototype.outline/2,p=PushButtonMorph.prototype.outlineColor,c=PushButtonMorph.prototype.color,u=PushButtonMorph.prototype.contrast,d=c.lighter(u),g=c.darker(u);switch(this.value){case!1:i=n+a,MorphicPreferences.isFlat||(t.shadowOffsetX=s,t.shadowOffsetY=0,t.shadowBlur=s,t.shadowColor="black");break;case!0:i=r-n-a,MorphicPreferences.isFlat||(t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0);break;default:if(!e)return;i=n,MorphicPreferences.isFlat||(t.shadowOffsetX=s,t.shadowOffsetY=0,t.shadowBlur=s,t.shadowColor="black"),t.globalAlpha=.2*((e||0)+1)}t.fillStyle=c.toString(),t.beginPath(),t.arc(i,h,n,radians(0),radians(360)),t.closePath(),t.fill(),MorphicPreferences.isFlat||(t.shadowOffsetX=0,t.shadowBlur=0,t.shadowColor="black",t.lineWidth=l,t.strokeStyle=p.toString(),t.beginPath(),t.arc(i,h,n-l/2,radians(0),radians(360)),t.stroke(),(o=t.createRadialGradient(i,h,n-l-this.edge,i,h,n-l)).addColorStop(1,d.toString()),o.addColorStop(0,c.toString()),t.strokeStyle=o,t.lineCap="round",t.lineWidth=this.edge,t.beginPath(),t.arc(i,h,n-l-this.edge/2,radians(180),radians(270),!1),t.stroke(),(o=t.createRadialGradient(i,h,n-l-this.edge,i,h,n-l)).addColorStop(1,g.toString()),o.addColorStop(0,c.toString()),t.strokeStyle=o,t.lineCap="round",t.lineWidth=this.edge,t.beginPath(),t.arc(i,h,n-l-this.edge/2,radians(0),radians(90),!1),t.stroke())},BooleanSlotMorph.prototype.textLabel=function(){return this.isEmptySlot()?null:(t=new StringMorph(localize("true"),this.fontSize,null,!0,null,null,null,null,new Color(255,255,255)).image,e=new StringMorph(localize("false"),this.fontSize,null,!0,null,null,null,null,new Color(255,255,255)).image,o=newCanvas(new Point(Math.max(t.width,e.width),Math.max(t.height,e.height))),i=this.value?t:e,r=(o.width-i.width)/2,n=(o.height-i.height)/2,o.getContext("2d").drawImage(i,r,n),o);var t,e,o,i,r,n},ArrowMorph.prototype=new Morph,ArrowMorph.prototype.constructor=ArrowMorph,ArrowMorph.uber=Morph.prototype,ArrowMorph.prototype.init=function(t,e,o,i){this.direction=t||"down",this.size=e||(0===e?0:50),this.padding=o||0,ArrowMorph.uber.init.call(this,!0),this.color=i||new Color(0,0,0),this.setExtent(new Point(this.size,this.size))},ArrowMorph.prototype.setSize=function(t){var e=Math.max(t,1);this.size=t,this.setExtent(new Point(e,e))},ArrowMorph.prototype.drawNew=function(){this.image=newCanvas(this.extent());var t=this.image.getContext("2d"),e=this.padding,o=this.height(),i=Math.floor(o/2),r=this.width(),n=Math.floor(r/2);t.fillStyle=this.color.toString(),t.beginPath(),"down"===this.direction?(t.moveTo(e,i),t.lineTo(r-e,i),t.lineTo(n,o-e)):"up"===this.direction?(t.moveTo(e,i),t.lineTo(r-e,i),t.lineTo(n,e)):("left"===this.direction?(t.moveTo(e,i),t.lineTo(n,e)):(t.moveTo(n,e),t.lineTo(r-e,i)),t.lineTo(n,o-e)),t.closePath(),t.fill()},TextSlotMorph.prototype=new InputSlotMorph,TextSlotMorph.prototype.constructor=TextSlotMorph,TextSlotMorph.uber=InputSlotMorph.prototype,TextSlotMorph.prototype.init=function(t,e,o,i){var r=new TextMorph(""),n=new ArrowMorph("down",0,Math.max(Math.floor(this.fontSize/6),1));r.fontSize=this.fontSize,r.drawNew(),this.isUnevaluated=!1,this.choices=o||null,this.oldContentsExtent=r.extent(),this.isNumeric=e||!1,this.isReadOnly=i||!1,this.minWidth=0,this.constant=null,InputSlotMorph.uber.init.call(this,null,null,null,null,!0),this.color=new Color(255,255,255),this.add(r),this.add(n),r.isEditable=!0,r.isDraggable=!1,r.enableSelecting(),this.setContents(t)},TextSlotMorph.prototype.getSpec=function(){return this.isNumeric?"%mln":"%mlt"},TextSlotMorph.prototype.contents=function(){return detect(this.children,function(t){return t instanceof TextMorph})},TextSlotMorph.prototype.layoutChanged=function(){this.fixLayout()},SymbolMorph.prototype=new Morph,SymbolMorph.prototype.constructor=SymbolMorph,SymbolMorph.uber=Morph.prototype,SymbolMorph.prototype.names=["square","pointRight","stepForward","stepBackward","gears","file","fullScreen","normalScreen","smallStage","normalStage","turtle","stage","turtleOutline","pause","flag","octagon","cloud","cloudOutline","cloudGradient","turnRight","turnLeft","storage","poster","flash","brush","rectangle","rectangleSolid","circle","circleSolid","line","crosshairs","paintbucket","eraser","pipette","speechBubble","speechBubbleOutline","turnBack","turnForward","arrowUp","arrowUpOutline","arrowLeft","arrowLeftOutline","arrowDown","arrowDownOutline","arrowRight","arrowRightOutline","robot","magnifiyingGlass","footprints"],SymbolMorph.prototype.init=function(t,e,o,i,r){this.isProtectedLabel=!1,this.isReadOnly=!0,this.name=t||"square",this.size=e||(0===e?0:50),this.shadowOffset=i||new Point(0,0),this.shadowColor=r||null,SymbolMorph.uber.init.call(this,!0),this.color=o||new Color(0,0,0),this.drawNew()},SymbolMorph.prototype.setLabelColor=function(t,e,o){this.shadowOffset=o||new Point,this.shadowColor=e,this.setColor(t)},SymbolMorph.prototype.drawNew=function(){var t,e,o,i,r;this.image=newCanvas(new Point(this.symbolWidth()+Math.abs(this.shadowOffset.x),this.size+Math.abs(this.shadowOffset.y))),this.silentSetWidth(this.image.width),this.silentSetHeight(this.image.height),t=this.image.getContext("2d"),i=this.shadowOffset.x<0?0:this.shadowOffset.x,r=this.shadowOffset.y<0?0:this.shadowOffset.y,e=this.shadowOffset.x<0?Math.abs(this.shadowOffset.x):0,o=this.shadowOffset.y<0?Math.abs(this.shadowOffset.y):0,this.shadowColor&&t.drawImage(this.symbolCanvasColored(this.shadowColor),i,r),t.drawImage(this.symbolCanvasColored(this.color),e,o)},SymbolMorph.prototype.symbolCanvasColored=function(t){if(this.name instanceof Costume)return this.name.thumbnail(new Point(this.symbolWidth(),this.size));var e=newCanvas(new Point(this.symbolWidth(),this.size));switch(this.name){case"square":return this.drawSymbolStop(e,t);case"plus":return this.drawSymbolPlus(e,t);case"mail":return this.drawSymbolMail(e,t);case"pointRight":return this.drawSymbolPointRight(e,t);case"doubleArrowForward":case"stepForward":return this.drawSymbolStepForward(e,t);case"stepBackward":return this.drawSymbolStepBackward(e,t);case"jumpForward":return this.drawSymbolJumpForward(e,t);case"jumpBackward":return this.drawSymbolJumpBackward(e,t);case"gears":return this.drawSymbolGears(e,t);case"file":return this.drawSymbolFile(e,t);case"fullScreen":return this.drawSymbolFullScreen(e,t);case"normalScreen":return this.drawSymbolNormalScreen(e,t);case"smallStage":return this.drawSymbolSmallStage(e,t);case"normalStage":return this.drawSymbolNormalStage(e,t);case"turtle":return this.drawSymbolTurtle(e,t);case"stage":return this.drawSymbolStop(e,t);case"turtleOutline":return this.drawSymbolTurtleOutline(e,t);case"pause":return this.drawSymbolPause(e,t);case"flag":return this.drawSymbolFlag(e,t);case"octagon":return this.drawSymbolOctagon(e,t);case"cloud":return this.drawSymbolCloud(e,t);case"cloudOutline":return this.drawSymbolCloudOutline(e,t);case"cloudGradient":return this.drawSymbolCloudGradient(e,t);case"turnRight":return this.drawSymbolTurnRight(e,t);case"turnLeft":return this.drawSymbolTurnLeft(e,t);case"storage":return this.drawSymbolStorage(e,t);case"poster":return this.drawSymbolPoster(e,t);case"flash":return this.drawSymbolFlash(e,t);case"brush":return this.drawSymbolBrush(e,t);case"rectangle":return this.drawSymbolRectangle(e,t);case"rectangleSolid":return this.drawSymbolRectangleSolid(e,t);case"circle":return this.drawSymbolCircle(e,t);case"circleSolid":return this.drawSymbolCircleSolid(e,t);case"encircledCircle":return this.drawSymbolEncircledCircle(e,t);case"line":return this.drawSymbolLine(e,t);case"crosshairs":return this.drawSymbolCrosshairs(e,t);case"paintbucket":return this.drawSymbolPaintbucket(e,t);case"eraser":return this.drawSymbolEraser(e,t);case"pipette":return this.drawSymbolPipette(e,t);case"speechBubble":return this.drawSymbolSpeechBubble(e,t);case"speechBubbleOutline":return this.drawSymbolSpeechBubbleOutline(e,t);case"turnBack":return this.drawSymbolTurnBack(e,t);case"turnForward":return this.drawSymbolTurnForward(e,t);case"arrowUp":return this.drawSymbolArrowUp(e,t);case"arrowUpOutline":return this.drawSymbolArrowUpOutline(e,t);case"arrowLeft":return this.drawSymbolArrowLeft(e,t);case"arrowLeftOutline":return this.drawSymbolArrowLeftOutline(e,t);case"arrowDown":return this.drawSymbolArrowDown(e,t);case"arrowDownOutline":return this.drawSymbolArrowDownOutline(e,t);case"arrowRight":return this.drawSymbolArrowRight(e,t);case"arrowRightOutline":return this.drawSymbolArrowRightOutline(e,t);case"robot":return this.drawSymbolRobot(e,t);case"magnifiyingGlass":return this.drawSymbolMagnifyingGlass(e,t);case"queue":return this.drawSymbolQueue(e,t);case"footprints":return this.drawSymbolFootprints(e,t);default:return e}},SymbolMorph.prototype.symbolWidth=function(){var t=this.size;if(this.name instanceof Costume)return t/this.name.height()*this.name.width();switch(this.name){case"pointRight":return Math.sqrt(t*t-Math.pow(t/2,2));case"flash":case"file":return.8*t;case"smallStage":case"normalStage":return 1.2*t;case"turtle":case"turtleOutline":case"mail":case"stage":return 1.3*t;case"cloud":case"cloudGradient":case"cloudOutline":case"turnBack":case"turnForward":return 1.6*t;case"turnRight":case"turnLeft":return t/3*2;default:return t}},SymbolMorph.prototype.drawSymbolStop=function(t,e){var o=t.getContext("2d");return o.fillStyle=e.toString(),o.fillRect(0,0,t.width,t.height),t},SymbolMorph.prototype.drawSymbolPlus=function(t,e){var o=t.getContext("2d"),i=t.width,r=Math.max(i/12,1),n=t.height;return o.lineWidth=r,o.strokeStyle=e.toString(),o.fillStyle=e.toString(),o.moveTo(0,n/2),o.lineTo(i,n/2),o.moveTo(i/2,0),o.lineTo(i/2,n),o.stroke(),t},SymbolMorph.prototype.drawSymbolMail=function(t,e){var o=t.getContext("2d"),i=t.width,r=Math.max(i/12,1),n=t.height;return o.lineWidth=r,o.fillStyle=e.toString(),o.strokeStyle=e.darker(50).toString(),o.fillRect(0,0,i,n),o.rect(0,0,i,n),o.moveTo(0,0),o.lineTo(i/2,2*n/3),o.lineTo(i,0),o.stroke(),t},SymbolMorph.prototype.drawSymbolPointRight=function(t,e){var o=t.getContext("2d");return o.fillStyle=e.toString(),o.beginPath(),o.moveTo(0,0),o.lineTo(t.width,Math.round(t.height/2)),o.lineTo(0,t.height),o.lineTo(0,0),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolStepForward=function(t,e){var o=t.getContext("2d");return o.fillStyle=e.toString(),o.beginPath(),o.moveTo(0,0),o.lineTo(.75*t.width,Math.round(t.height/2)),o.lineTo(0,t.height),o.lineTo(0,0),o.closePath(),o.fill(),o.fillRect(.75*t.width,0,.25*t.width,t.height),t},SymbolMorph.prototype.drawSymbolStepBackward=function(t,e){var o=t.getContext("2d");return o.fillStyle=e.toString(),o.beginPath(),o.moveTo(.25*t.width,Math.round(t.height/2)),o.lineTo(t.width,0),o.lineTo(t.width,t.height),o.lineTo(.25*t.width,Math.round(t.height/2)),o.closePath(),o.fill(),o.fillRect(0,0,.25*t.width,t.height),t},SymbolMorph.prototype.drawSymbolJumpForward=function(t,e){var o=t.getContext("2d"),i=3/7*t.width,r=4/7*t.height,n=1.5/7*t.height,s=1/7*t.width;return o.fillStyle=e.toString(),o.beginPath(),o.moveTo(0,n),o.lineTo(i,n+Math.round(r/2)),o.lineTo(0,n+r),o.lineTo(0,n),o.closePath(),o.fill(),o.beginPath(),o.moveTo(i,n),o.lineTo(2*i,n+Math.round(r/2)),o.lineTo(i,n+r),o.lineTo(i,n),o.closePath(),o.fill(),o.fillRect(2*i,n,s,r),t},SymbolMorph.prototype.drawSymbolJumpBackward=function(t,e){var o=t.getContext("2d"),i=3/7*t.width,r=4/7*t.height,n=1.5/7*t.height,s=1/7*t.width;return o.fillStyle=e.toString(),o.beginPath(),o.moveTo(s+i,n),o.lineTo(s,n+Math.round(r/2)),o.lineTo(s+i,n+r),o.lineTo(s+i,n),o.closePath(),o.fill(),o.beginPath(),o.moveTo(s+2*i,n),o.lineTo(s+i,n+Math.round(r/2)),o.lineTo(s+2*i,n+r),o.lineTo(s+2*i,n),o.closePath(),o.fill(),o.fillRect(0,n,s,r),t},SymbolMorph.prototype.drawSymbolGears=function(t,e){var o=t.getContext("2d"),i=t.width,r=i/2,n=i/6;return o.strokeStyle=e.toString(),o.lineWidth=t.width/7,o.beginPath(),o.arc(r,r,i,radians(0),radians(360),!0),o.arc(r,r,1.5*n,radians(0),radians(360),!1),o.closePath(),o.clip(),o.moveTo(0,r),o.lineTo(i,r),o.stroke(),o.moveTo(r,0),o.lineTo(r,i),o.stroke(),o.moveTo(n,n),o.lineTo(i-n,i-n),o.stroke(),o.moveTo(i-n,n),o.lineTo(n,i-n),o.stroke(),t},SymbolMorph.prototype.drawSymbolFile=function(t,e){var o=t.getContext("2d"),i=Math.min(t.width,t.height)/2;return o.fillStyle=e.toString(),o.beginPath(),o.moveTo(0,0),o.lineTo(i,0),o.lineTo(i,i),o.lineTo(t.width,i),o.lineTo(t.width,t.height),o.lineTo(0,t.height),o.closePath(),o.fill(),o.fillStyle=e.darker(25).toString(),o.beginPath(),o.moveTo(i,0),o.lineTo(t.width,i),o.lineTo(i,i),o.lineTo(i,0),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolFullScreen=function(t,e){var o=t.getContext("2d"),i=t.height,r=t.width/2,n=t.width/20,s=t.width/2;return o.strokeStyle=e.toString(),o.lineWidth=t.width/5,o.moveTo(r-n,r+n),o.lineTo(0,i),o.stroke(),o.strokeStyle=e.toString(),o.lineWidth=t.width/5,o.moveTo(r+n,r-n),o.lineTo(i,0),o.stroke(),o.fillStyle=e.toString(),o.beginPath(),o.moveTo(0,i),o.lineTo(0,i-s),o.lineTo(s,i),o.closePath(),o.fill(),o.fillStyle=e.toString(),o.beginPath(),o.moveTo(i,0),o.lineTo(i-s,0),o.lineTo(i,s),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolNormalScreen=function(t,e){var o=t.getContext("2d"),i=t.height,r=t.width/2,n=t.width/20,s=t.width;return o.strokeStyle=e.toString(),o.lineWidth=t.width/5,o.moveTo(r-3*n,r+3*n),o.lineTo(0,i),o.stroke(),o.strokeStyle=e.toString(),o.lineWidth=t.width/5,o.moveTo(r+3*n,r-3*n),o.lineTo(i,0),o.stroke(),o.fillStyle=e.toString(),o.beginPath(),o.moveTo(r+n,r-n),o.lineTo(s,r-n),o.lineTo(r+n,0),o.closePath(),o.fill(),o.fillStyle=e.toString(),o.beginPath(),o.moveTo(r-n,r+n),o.lineTo(0,r+n),o.lineTo(r-n,s),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolSmallStage=function(t,e){var o=t.getContext("2d"),i=t.width,r=t.height,n=i/2,s=r/2;return o.fillStyle=e.darker(40).toString(),o.fillRect(0,0,i,r),o.fillStyle=e.toString(),o.fillRect(n,0,n,s),t},SymbolMorph.prototype.drawSymbolNormalStage=function(t,e){var o=t.getContext("2d"),i=t.width,r=t.height,n=i/2,s=r/2;return o.fillStyle=e.toString(),o.fillRect(0,0,i,r),o.fillStyle=e.darker(25).toString(),o.fillRect(n,0,n,s),t},SymbolMorph.prototype.drawSymbolTurtle=function(t,e){var o=t.getContext("2d");return o.fillStyle=e.toString(),o.beginPath(),o.moveTo(0,0),o.lineTo(t.width,t.height/2),o.lineTo(0,t.height),o.lineTo(t.height/2,t.height/2),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolTurtleOutline=function(t,e){var o=t.getContext("2d");return o.strokeStyle=e.toString(),o.beginPath(),o.moveTo(0,0),o.lineTo(t.width,t.height/2),o.lineTo(0,t.height),o.lineTo(t.height/2,t.height/2),o.closePath(),o.stroke(),t},SymbolMorph.prototype.drawSymbolPause=function(t,e){var o=t.getContext("2d"),i=t.width/5;return o.fillStyle=e.toString(),o.fillRect(0,0,2*i,t.height),o.fillRect(3*i,0,2*i,t.height),t},SymbolMorph.prototype.drawSymbolFlag=function(t,e){var o=t.getContext("2d"),i=t.width,r=Math.max(i/12,1),n=t.height;return o.lineWidth=r,o.strokeStyle=e.toString(),o.beginPath(),o.moveTo(r/2,0),o.lineTo(r/2,t.height),o.stroke(),o.lineWidth=n/2,o.beginPath(),o.moveTo(0,n/4),o.bezierCurveTo(.8*i,n/4,.1*i,.5*n,i,.5*n),o.stroke(),t},SymbolMorph.prototype.drawSymbolOctagon=function(t,e){var o=t.getContext("2d"),i=t.width,r=(i-.383*i)/2;return o.fillStyle=e.toString(),o.beginPath(),o.moveTo(r,0),o.lineTo(i-r,0),o.lineTo(i,r),o.lineTo(i,i-r),o.lineTo(i-r,i),o.lineTo(r,i),o.lineTo(0,i-r),o.lineTo(0,r),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolCloud=function(t,e){var o=t.getContext("2d"),i=t.width,r=t.height,n=2*r/5,s=r/4,a=3*r/10,h=r/5;return o.fillStyle=e.toString(),o.beginPath(),o.arc(s,r-s,s,radians(90),radians(259),!1),o.arc(i/20*5,r/9*4,h,radians(165),radians(300),!1),o.arc(i/20*11,n,n,radians(200),radians(357),!1),o.arc(i-a,r-a,a,radians(269),radians(90),!1),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolCloudGradient=function(t,e){var o,i=t.getContext("2d"),r=t.width,n=t.height,s=2*n/5,a=n/4,h=3*n/10,l=n/5;return(o=i.createRadialGradient(0,0,0,0,0,r)).addColorStop(0,e.lighter(25).toString()),o.addColorStop(1,e.darker(25).toString()),i.fillStyle=o,i.beginPath(),i.arc(a,n-a,a,radians(90),radians(259),!1),i.arc(r/20*5,n/9*4,l,radians(165),radians(300),!1),i.arc(r/20*11,s,s,radians(200),radians(357),!1),i.arc(r-h,n-h,h,radians(269),radians(90),!1),i.closePath(),i.fill(),t},SymbolMorph.prototype.drawSymbolCloudOutline=function(t,e){var o=t.getContext("2d"),i=t.width,r=t.height,n=2*r/5,s=r/4,a=3*r/10,h=r/5;return o.strokeStyle=e.toString(),o.beginPath(),o.arc(s+1,r-s-1,s,radians(90),radians(259),!1),o.arc(i/20*5,r/9*4,h,radians(165),radians(300),!1),o.arc(i/20*11,n+1,n,radians(200),radians(357),!1),o.arc(i-a-1,r-a-1,a,radians(269),radians(90),!1),o.closePath(),o.stroke(),t},SymbolMorph.prototype.drawSymbolTurnRight=function(t,e){var o=t.getContext("2d"),i=t.width,r=Math.max(i/10,1),n=i/2;return o.lineWidth=r,o.strokeStyle=e.toString(),o.beginPath(),o.arc(n,2*n,n-r/2,radians(0),radians(-90),!1),o.stroke(),o.fillStyle=e.toString(),o.beginPath(),o.moveTo(i,n),o.lineTo(n,0),o.lineTo(n,2*n),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolTurnLeft=function(t,e){var o=t.getContext("2d"),i=t.width,r=Math.max(i/10,1),n=i/2;return o.lineWidth=r,o.strokeStyle=e.toString(),o.beginPath(),o.arc(n,2*n,n-r/2,radians(180),radians(-90),!0),o.stroke(),o.fillStyle=e.toString(),o.beginPath(),o.moveTo(0,n),o.lineTo(n,0),o.lineTo(n,2*n),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolStorage=function(t,o){var i=t.getContext("2d"),r=t.width,n=t.height,s=t.height,a=t.height/11;function e(t,e){i.fillStyle=o.toString(),i.beginPath(),i.arc(r/2,t-n,s,radians(60),radians(120),!1),i.lineTo(0,t-2*a),i.arc(r/2,t-n-2*a,s,radians(120),radians(60),!0),i.closePath(),i.fill(),i.fillStyle=o.darker(25).toString(),i.beginPath(),e&&i.arc(r/2,t-n-2*a,s,radians(120),radians(60),!0),i.arc(r/2,t+6*a+1,s,radians(60),radians(120),!0),i.closePath(),e?i.fill():i.stroke()}return i.strokeStyle=o.toString(),e(n),e(n-3*a),e(n-6*a,!1),t},SymbolMorph.prototype.drawSymbolPoster=function(t,e){var o=t.getContext("2d"),i=t.width,r=t.height,n=.75*r,s=t.height/5;return o.fillStyle=e.toString(),o.strokeStyle=e.toString(),o.lineWidth=i/15,o.moveTo(i/2,r/3),o.lineTo(i/6,r),o.stroke(),o.moveTo(i/2,r/3),o.lineTo(i/2,r),o.stroke(),o.moveTo(i/2,r/3),o.lineTo(5*i/6,r),o.stroke(),o.fillRect(0,0,i,n),o.clearRect(0,n,i,i/20),o.clearRect(i-s,n-s,s+1,s+1),o.fillStyle=e.darker(25).toString(),o.beginPath(),o.moveTo(i,n-s),o.lineTo(i-s,n-s),o.lineTo(i-s,n),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolFlash=function(t,e){var o=t.getContext("2d"),i=t.width,r=i/3,n=t.height,s=n/3,a=s/3;return o.fillStyle=e.toString(),o.beginPath(),o.moveTo(r,0),o.lineTo(0,s),o.lineTo(r,s),o.lineTo(0,2*s),o.lineTo(r,2*s),o.lineTo(0,n),o.lineTo(i,2*s-a),o.lineTo(2*r,2*s-a),o.lineTo(i,s-a),o.lineTo(2*r,s-a),o.lineTo(i,0),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolBrush=function(t,e){var o=t.getContext("2d"),i=t.width,r=t.height,n=Math.max(i/30,.5);return o.fillStyle=e.toString(),o.lineWidth=2*n,o.beginPath(),o.moveTo(i/8*3,r/2),o.quadraticCurveTo(0,r/2,n,r-n),o.quadraticCurveTo(i/2,r,i/2,r/8*5),o.closePath(),o.fill(),o.lineJoin="round",o.lineCap="round",o.strokeStyle=e.toString(),o.moveTo(i/8*3,r/2),o.lineTo(.75*i,n),o.quadraticCurveTo(i,0,i-n,.25*r),o.stroke(),o.moveTo(i/2,r/8*5),o.lineTo(i-n,.25*r),o.stroke(),t},SymbolMorph.prototype.drawSymbolRectangle=function(t,e){var o=t.getContext("2d"),i=t.width,r=t.width,n=Math.max(i/20,.5);return o.strokeStyle=e.toString(),o.lineWidth=2*n,o.beginPath(),o.moveTo(n,n),o.lineTo(i-n,n),o.lineTo(i-n,r-n),o.lineTo(n,r-n),o.closePath(),o.stroke(),t},SymbolMorph.prototype.drawSymbolRectangleSolid=function(t,e){var o=t.getContext("2d"),i=t.width,r=t.width;return o.fillStyle=e.toString(),o.beginPath(),o.moveTo(0,0),o.lineTo(i,0),o.lineTo(i,r),o.lineTo(0,r),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolCircle=function(t,e){var o=t.getContext("2d"),i=t.width,r=Math.max(i/20,.5);return o.strokeStyle=e.toString(),o.lineWidth=2*r,o.arc(i/2,i/2,i/2-r,radians(0),radians(360),!1),o.stroke(),t},SymbolMorph.prototype.drawSymbolCircleSolid=function(t,e){var o=t.getContext("2d"),i=t.width;return o.fillStyle=e.toString(),o.arc(i/2,i/2,i/2,radians(0),radians(360),!1),o.fill(),t},SymbolMorph.prototype.drawSymbolEncircledCircle=function(t,e){var o=t.getContext("2d"),i=t.width,r=Math.max(i/30,.5);return o.strokeStyle=e.toString(),o.fillStyle=e.toString(),o.beginPath(),o.arc(i/2,i/2,i/4,radians(0),radians(360),!1),o.fill(),o.beginPath(),o.lineWidth=2*r,o.arc(i/2,i/2,i/2-r,radians(0),radians(360),!1),o.stroke(),t},SymbolMorph.prototype.drawSymbolLine=function(t,e){var o=t.getContext("2d"),i=t.width,r=t.height,n=Math.max(i/20,.5);return o.strokeStyle=e.toString(),o.lineWidth=2*n,o.lineCap="round",o.moveTo(n,n),o.lineTo(i-n,r-n),o.stroke(),t},SymbolMorph.prototype.drawSymbolCrosshairs=function(t,e){var o=t.getContext("2d"),i=t.width,r=t.height;return o.strokeStyle=e.toString(),o.lineWidth=1,o.moveTo(.5,r/2),o.lineTo(i-.5,r/2),o.stroke(),o.moveTo(i/2,.5),o.lineTo(i/2,r-.5),o.stroke(),o.moveTo(i/2,r/2),o.arc(i/2,i/2,i/3-.5,radians(0),radians(360),!1),o.stroke(),t},SymbolMorph.prototype.drawSymbolPaintbucket=function(t,e){var o=t.getContext("2d"),i=t.width,r=t.height,n=t.width/5,s=Math.max(i/30,.5);return o.strokeStyle=e.toString(),o.lineWidth=2*s,o.beginPath(),o.moveTo(2*n,n),o.lineTo(4*n,3*n),o.lineTo(3*n,4*n),o.quadraticCurveTo(2*n,r,n,4*n),o.quadraticCurveTo(0,3*n,n,2*n),o.closePath(),o.stroke(),o.lineWidth=s,o.moveTo(2*n,2.5*n),o.arc(2*n,2.5*n,s,radians(0),radians(360),!1),o.stroke(),o.moveTo(2*n,2.5*n),o.lineTo(2*n,n/2+s),o.stroke(),o.arc(1.5*n,n/2+s,n/2,radians(0),radians(180),!0),o.stroke(),o.moveTo(n,n/2+s),o.lineTo(n,2*n),o.stroke(),o.fillStyle=e.toString(),o.beginPath(),o.moveTo(3.5*n,3.5*n),o.quadraticCurveTo(i,3.5*n,i-s,r),o.lineTo(i,r),o.quadraticCurveTo(i,2*n,2.5*n,1.5*n),o.lineTo(4*n,3*n),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolEraser=function(t,e){var o=t.getContext("2d"),i=t.width,r=t.height,n=t.width/4,s=Math.max(i/20,.5);return o.strokeStyle=e.toString(),o.lineWidth=2*s,o.beginPath(),o.moveTo(3*n,s),o.lineTo(s,3*n),o.quadraticCurveTo(n,r,2*n,3*n),o.lineTo(i-s,n),o.closePath(),o.stroke(),o.fillStyle=e.toString(),o.beginPath(),o.moveTo(3*n,0),o.lineTo(1.5*n,1.5*n),o.lineTo(2.5*n,2.5*n),o.lineTo(i,n),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolPipette=function(t,e){var o=t.getContext("2d"),i=t.width,r=t.height,n=t.width/4,s=n/2,a=Math.max(i/20,.5);return o.strokeStyle=e.toString(),o.lineWidth=2*a,o.beginPath(),o.moveTo(a,r-a),o.quadraticCurveTo(s,r-s,s,r-n),o.lineTo(2*n,1.5*n),o.stroke(),o.beginPath(),o.moveTo(a,r-a),o.quadraticCurveTo(s,r-s,n,r-s),o.lineTo(2.5*n,2*n),o.stroke(),o.fillStyle=e.toString(),o.arc(3*n,n,n-a,radians(0),radians(360),!1),o.fill(),o.beginPath(),o.moveTo(2*n,n),o.lineTo(3*n,2*n),o.stroke(),t},SymbolMorph.prototype.drawSymbolSpeechBubble=function(t,e){var o=t.getContext("2d"),i=t.width,r=t.height,n=t.width/3,s=Math.max(i/20,.5);return o.fillStyle=e.toString(),o.lineWidth=2*s,o.beginPath(),o.moveTo(n,2*n),o.quadraticCurveTo(s,2*n,s,n),o.quadraticCurveTo(s,s,n,s),o.lineTo(2*n,s),o.quadraticCurveTo(i-s,s,i-s,n),o.quadraticCurveTo(i-s,2*n,2*n,2*n),o.lineTo(n/2,r-s),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolSpeechBubbleOutline=function(t,e){var o=t.getContext("2d"),i=t.width,r=t.height,n=t.width/3,s=Math.max(i/20,.5);return o.strokeStyle=e.toString(),o.lineWidth=2*s,o.beginPath(),o.moveTo(n,2*n),o.quadraticCurveTo(s,2*n,s,n),o.quadraticCurveTo(s,s,n,s),o.lineTo(2*n,s),o.quadraticCurveTo(i-s,s,i-s,n),o.quadraticCurveTo(i-s,2*n,2*n,2*n),o.lineTo(n/2,r-s),o.closePath(),o.stroke(),t},SymbolMorph.prototype.drawSymbolTurnBack=function(t,e){var o=t.getContext("2d"),i=t.width,r=t.height,n=t.width/2,s=t.height/2,a=Math.max(i/20,.5);return o.fillStyle=e.toString(),o.lineWidth=2*a,o.beginPath(),o.moveTo(0,s),o.lineTo(n,0),o.lineTo(n,r),o.closePath(),o.fill(),o.lineWidth=3*a,o.strokeStyle=e.toString(),o.beginPath(),o.arc(n,r,s,radians(0),radians(-90),!0),o.stroke(),t},SymbolMorph.prototype.drawSymbolTurnForward=function(t,e){var o=t.getContext("2d"),i=t.width,r=t.height,n=t.width/2,s=t.height/2,a=Math.max(i/20,.5);return o.fillStyle=e.toString(),o.lineWidth=2*a,o.beginPath(),o.moveTo(i,s),o.lineTo(n,0),o.lineTo(n,r),o.closePath(),o.fill(),o.lineWidth=3*a,o.strokeStyle=e.toString(),o.beginPath(),o.arc(n,r,s,radians(-180),radians(-90),!1),o.stroke(),t},SymbolMorph.prototype.drawSymbolArrowUp=function(t,e){var o=t.getContext("2d"),i=t.width,r=t.height,n=t.width/2,s=Math.max(i/20,.5);return o.fillStyle=e.toString(),o.lineWidth=2*s,o.beginPath(),o.moveTo(s,n),o.lineTo(n,s),o.lineTo(i-s,n),o.lineTo(.65*i,n),o.lineTo(.65*i,r-s),o.lineTo(.35*i,r-s),o.lineTo(.35*i,n),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolArrowUpOutline=function(t,e){var o=t.getContext("2d"),i=t.width,r=t.height,n=t.width/2,s=Math.max(i/20,.5);return o.strokeStyle=e.toString(),o.lineWidth=2*s,o.beginPath(),o.moveTo(s,n),o.lineTo(n,s),o.lineTo(i-s,n),o.lineTo(.65*i,n),o.lineTo(.65*i,r-s),o.lineTo(.35*i,r-s),o.lineTo(.35*i,n),o.closePath(),o.stroke(),t},SymbolMorph.prototype.drawSymbolArrowDown=function(t,e){var o=t.getContext("2d"),i=t.width;return o.save(),o.translate(i,i),o.rotate(radians(180)),this.drawSymbolArrowUp(t,e),o.restore(),t},SymbolMorph.prototype.drawSymbolArrowDownOutline=function(t,e){var o=t.getContext("2d"),i=t.width;return o.save(),o.translate(i,i),o.rotate(radians(180)),this.drawSymbolArrowUpOutline(t,e),o.restore(),t},SymbolMorph.prototype.drawSymbolArrowLeft=function(t,e){var o=t.getContext("2d"),i=t.width;return o.save(),o.translate(0,i),o.rotate(radians(-90)),this.drawSymbolArrowUp(t,e),o.restore(),t},SymbolMorph.prototype.drawSymbolArrowLeftOutline=function(t,e){var o=t.getContext("2d"),i=t.width;return o.save(),o.translate(0,i),o.rotate(radians(-90)),this.drawSymbolArrowUpOutline(t,e),o.restore(),t},SymbolMorph.prototype.drawSymbolArrowRight=function(t,e){var o=t.getContext("2d"),i=t.width;return o.save(),o.translate(i,0),o.rotate(radians(90)),this.drawSymbolArrowUp(t,e),o.restore(),t},SymbolMorph.prototype.drawSymbolArrowRightOutline=function(t,e){var o=t.getContext("2d"),i=t.width;return o.save(),o.translate(i,0),o.rotate(radians(90)),this.drawSymbolArrowUpOutline(t,e),o.restore(),t},SymbolMorph.prototype.drawSymbolRobot=function(t,e){var o=t.getContext("2d"),i=t.width,r=t.height,n=t.width/6,s=n/2,a=Math.max(i/20,.5);return o.fillStyle=e.toString(),o.beginPath(),o.moveTo(n+a,n),o.lineTo(2*n,n),o.lineTo(2.5*n,1.5*n),o.lineTo(3.5*n,1.5*n),o.lineTo(4*n,n),o.lineTo(5*n-a,n),o.lineTo(4*n,3*n),o.lineTo(4*n,4*n-a),o.lineTo(2*n,4*n-a),o.lineTo(2*n,3*n),o.closePath(),o.fill(),o.beginPath(),o.moveTo(2.75*n,n+a),o.lineTo(2.4*n,n),o.lineTo(2.2*n,0),o.lineTo(3.8*n,0),o.lineTo(3.6*n,n),o.lineTo(3.25*n,n+a),o.closePath(),o.fill(),o.beginPath(),o.moveTo(2.5*n,4*n),o.lineTo(n,4*n),o.lineTo(s+a,r),o.lineTo(2*n,r),o.closePath(),o.fill(),o.beginPath(),o.moveTo(3.5*n,4*n),o.lineTo(5*n,4*n),o.lineTo(i-(s+a),r),o.lineTo(4*n,r),o.closePath(),o.fill(),o.beginPath(),o.moveTo(n,n),o.lineTo(a,1.5*n),o.lineTo(a,3.25*n),o.lineTo(1.5*n,3.5*n),o.closePath(),o.fill(),o.beginPath(),o.moveTo(5*n,n),o.lineTo(i-a,1.5*n),o.lineTo(i-a,3.25*n),o.lineTo(4.5*n,3.5*n),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolMagnifyingGlass=function(t,e){var o,i=t.getContext("2d"),r=t.width,n=t.height,s=.3*r,a=2*r/3-Math.sqrt(s),h=n/3+Math.sqrt(s),l=Math.max(r/5,.5);return i.strokeStyle=e.toString(),(o=i.createRadialGradient(a,h,0,a+s,h+s,r)).addColorStop(0,e.inverted().lighter(50).toString()),o.addColorStop(1,e.inverted().darker(25).toString()),i.fillStyle=o,i.arc(a,h,s,radians(0),radians(360),!1),i.fill(),i.lineWidth=l/2,i.arc(a,h,s,radians(0),radians(360),!1),i.stroke(),i.lineWidth=l,i.beginPath(),i.moveTo(l/2,n-l/2),i.lineTo(a-Math.sqrt(s+l),h+Math.sqrt(s+l)),i.closePath(),i.stroke(),t},SymbolMorph.prototype.drawSymbolQueue=function(t,a){var h=t.getContext("2d"),e=t.width/5,o=e/2,l=e,p=3*e,c=1*o+p/2,i=o;h.fillStyle=a.toString();var r=function(t){var e,o,i,r,n,s;e=h,o=a,r=(i={tipPos:{x:t+l,y:c},dims:{h:p/2,w:l},direction:"right"}).dims.h,n=i.dims.w,s="left"===i.direction?1:-1,e.fillStyle=o.toString(),e.beginPath(),e.moveTo(i.tipPos.x,i.tipPos.y),e.lineTo(i.tipPos.x+s*n,i.tipPos.y+r/2),e.lineTo(i.tipPos.x+s*n,i.tipPos.y-r/2),e.fill()};return r(i),i+=l+o,h.fillRect(i,o,l,p),i+=l+o,h.fillRect(i,o,l,p),r(i+=l+o),t},SymbolMorph.prototype.drawSymbolFootprints=function(t,e){var o=t.getContext("2d"),i=t.width,r=i/10,n=1.5*r;return o.fillStyle=e.toString(),o.beginPath(),o.arc(n,n,n,radians(-200),radians(0),!1),o.lineTo(2*n,5.5*r),o.lineTo(r,6*r),o.closePath(),o.fill(),o.beginPath(),o.arc(2.25*r,6.75*r,r,radians(-40),radians(-170),!1),o.closePath(),o.fill(),o.beginPath(),o.arc(i-n,4.5*r,n,radians(-180),radians(20),!1),o.lineTo(i-r,8.5*r),o.lineTo(i-2*n,8*r),o.closePath(),o.fill(),o.beginPath(),o.arc(i-2.25*r,9*r,r,radians(0),radians(-150),!1),o.closePath(),o.fill(),t},ColorSlotMorph.prototype=new ArgMorph,ColorSlotMorph.prototype.constructor=ColorSlotMorph,ColorSlotMorph.uber=ArgMorph.prototype,ColorSlotMorph.prototype.init=function(t){ColorSlotMorph.uber.init.call(this,null,!0),this.setColor(t||new Color(145,26,68))},ColorSlotMorph.prototype.getSpec=function(){return"%clr"},ColorSlotMorph.prototype.getUserColor=function(){var o=this,i=this.world(),r=i.hand,t=this.color,n=getDocumentPositionOf(i.worldCanvas),e=r.processMouseMove,s=r.processMouseDown,a=r.processMouseUp,h=new ColorPaletteMorph(null,new Point(16*this.fontSize,10*this.fontSize));i.add(h),h.setPosition(this.bottomLeft().add(new Point(0,this.edge))),r.processMouseMove=function(t){var e=i.getGlobalPixelColor(r.position());r.setPosition(new Point(t.pageX-n.x,t.pageY-n.y)),e.a&&o.setColor(e)},r.processMouseDown=nop,r.processMouseUp=function(){o.parentThatIsA(ScriptsMorph)?SnapActions.setColorField(o,o.color).catch(function(){o.setColor(t)}):o.setColor(o.color),h.destroy(),r.processMouseMove=e,r.processMouseDown=s,r.processMouseUp=a}},ColorSlotMorph.prototype.mouseClickLeft=function(){this.getUserColor()},ColorSlotMorph.prototype.evaluate=function(){return this.color},ColorSlotMorph.prototype.drawNew=function(){var t,e,o;o=this.fontSize+2*this.edge+2*this.typeInPadding,this.silentSetExtent(new Point(o,o)),this.image=newCanvas(this.extent()),t=this.image.getContext("2d"),e=this.parent?this.parent.color:new Color(120,120,120),t.fillStyle=this.color.toString(),this.cachedClr=e.toString(),this.cachedClrBright=e.lighter(this.contrast).toString(),this.cachedClrDark=e.darker(this.contrast).toString(),t.fillRect(this.edge,this.edge,this.width()-2*this.edge,this.height()-2*this.edge),MorphicPreferences.isFlat||this.drawRectBorder(t)},ColorSlotMorph.prototype.drawRectBorder=InputSlotMorph.prototype.drawRectBorder,BlockHighlightMorph.prototype=new Morph,BlockHighlightMorph.prototype.constructor=BlockHighlightMorph,BlockHighlightMorph.uber=Morph.prototype,MultiArgMorph.prototype=new ArgMorph,MultiArgMorph.prototype.constructor=MultiArgMorph,MultiArgMorph.uber=ArgMorph.prototype,MultiArgMorph.prototype.init=function(t,e,o,i,r,n,s,a,h){var l,p,c,u,d=new FrameMorph;for(this.slotSpec=t||"%s",this.labelText=localize(e||""),this.minInputs=o||0,this.elementSpec=i||null,this.labelColor=n||null,this.shadowColor=s||null,this.shadowOffset=a||null,this.canBeEmpty=!0,MultiArgMorph.uber.init.call(this,null,!0),this.alpha=!1===h?1:0,d.alpha=!1===h?1:0,d.noticesTransparentClick=!0,this.noticesTransparentclick=!0,l=this.labelPart(this.labelText),this.add(l),l.hide(),p=new ArrowMorph("left",this.fontSize,Math.max(Math.floor(this.fontSize/6),1),r),c=new ArrowMorph("right",this.fontSize,Math.max(Math.floor(this.fontSize/6),1),r),d.add(p),d.add(c),d.drawNew(),d.acceptsDrops=!1,this.add(d),u=0;u<this.minInputs;u+=1)this.addInput()},MultiArgMorph.prototype.label=function(){return this.children[0]},MultiArgMorph.prototype.arrows=function(){return this.children[this.children.length-1]},MultiArgMorph.prototype.getSpec=function(){return"%mult"+this.slotSpec},MultiArgMorph.prototype.setContents=function(t){var e,o=this.inputs();for(e=0;e<t.length;e+=1)null!==t[e]&&o[e]&&o[e].setContents(t[e])},MultiArgMorph.prototype.hide=function(){this.isVisible=!1,this.changed()},MultiArgMorph.prototype.show=function(){this.isVisible=!0,this.changed()},MultiArgMorph.prototype.setLabelColor=function(t,e,o){this.textColor=t,this.shadowColor=e,this.shadowOffset=o,MultiArgMorph.uber.setLabelColor.call(this,t,e,o)},MultiArgMorph.prototype.fixLayout=function(){if("%t"===this.slotSpec&&(this.isStatic=!0),this.parent){var t,e,o=this.label();this.color=this.parent.color,t=this.shadowColor||this.parent.color.darker(this.labelContrast),e=this.shadowOffset||o.shadowOffset,this.arrows().color=this.color,""!==this.labelText&&(o.shadowColor.eq(t)||(o.shadowColor=t,o.shadowOffset=e,o.drawNew()))}this.fixArrowsLayout(),MultiArgMorph.uber.fixLayout.call(this),this.parent&&this.parent.fixLayout()},MultiArgMorph.prototype.fixArrowsLayout=function(){var t=this.label(),e=this.arrows(),o=e.children[0],i=e.children[1],r=new Point(i.width()/2,i.height());this.inputs().length<this.minInputs+1?(t.hide(),o.hide(),i.setPosition(e.position().subtract(new Point(r.x,0))),e.setExtent(r)):(""!==this.labelText&&t.show(),o.show(),i.setPosition(o.topCenter()),e.bounds.corner=i.bottomRight().copy()),e.drawNew()},MultiArgMorph.prototype.refresh=function(){this.inputs().forEach(function(t){t.drawNew()})},MultiArgMorph.prototype.drawNew=function(){MultiArgMorph.uber.drawNew.call(this),this.refresh()},MultiArgMorph.prototype.addInput=function(t){var e,o,i=this.labelPart(this.slotSpec),r=this.children.length-1;if(t)i.setContents(t);else if("%scriptVars"===this.elementSpec||"%blockVars"===this.elementSpec){for(o="",e=r;0<e;)o=String.fromCharCode(97+(e-1)%26)+o,e=Math.floor((e-1)/26);i.setContents(o)}else contains(["%parms","%ringparms"],this.elementSpec)&&i.setContents("#"+r);(i.parent=this).children.splice(r,0,i),i.drawNew(),this.fixLayout()},MultiArgMorph.prototype.removeInput=function(){var t,e;1<this.children.length&&(t=this.children[this.children.length-2],this.removeChild(t),t instanceof BlockMorph&&(e=this.parentThatIsA(ScriptsMorph))&&e.add(t)),this.fixLayout()},MultiArgMorph.prototype.mouseClickLeft=function(t){var e=this.parentThatIsA(MessageDefinitionBlock);if(this.parentThatIsA(ScriptsMorph)||e){var o,i=this.arrows(),r=i.children[0],n=i.children[1],s=16===this.world().currentKey?3:1;if(this.startLayout(),n.bounds.containsPoint(t)){if(n.isVisible)if(e)for(o=0;o<s;o++)this.addInput();else SnapActions.addListInput(this,s)}else if(r.bounds.containsPoint(t)){if(r.isVisible)if(s=Math.min(s,this.inputs().length-this.minInputs),e)for(o=0;o<s;o++)this.removeInput();else SnapActions.removeListInput(this,s)}else this.escalateEvent("mouseClickLeft",t);this.endLayout()}else this.escalateEvent("mouseClickLeft",t)},MultiArgMorph.prototype.userMenu=function(){var t=new MenuMorph(this),e=this.parentThatIsA(BlockMorph),o="",i=this;return StageMorph.prototype.enableCodeMapping?(e&&(e instanceof RingMorph?o="parms_":"doDeclareVariables"===e.selector&&(o="tempvars_")),t.addItem("code list mapping...",function(){i.mapCodeList(o)}),t.addItem("code item mapping...",function(){i.mapCodeItem(o)}),t.addItem("code delimiter mapping...",function(){i.mapCodeDelimiter(o)}),t):this.parent.userMenu()},MultiArgMorph.prototype.mapCodeDelimiter=function(t){this.mapToCode(t+"delim","list item delimiter")},MultiArgMorph.prototype.mapCodeList=function(t){this.mapToCode(t+"list","list contents <#1>")},MultiArgMorph.prototype.mapCodeItem=function(t){this.mapToCode(t+"item","list item <#1>")},MultiArgMorph.prototype.mapToCode=function(e,t){new DialogBoxMorph(this,function(t){StageMorph.prototype.codeMappings[e]=t},this).promptCode("Code mapping - "+t,StageMorph.prototype.codeMappings[e]||"",this.world())},MultiArgMorph.prototype.mappedCode=function(e){var t,o,i,r=this.parentThatIsA(BlockMorph),n="",s="",a=0,h=[];return r&&(r instanceof RingMorph?n="parms_":"doDeclareVariables"===r.selector&&(n="tempvars_")),t=StageMorph.prototype.codeMappings[n+"list"]||"<#1>",o=StageMorph.prototype.codeMappings[n+"item"]||"<#1>",i=StageMorph.prototype.codeMappings[n+"delim"]||" ",this.inputs().forEach(function(t){h.push(o.replace(/<#1>/g,t.mappedCode(e)))}),h.forEach(function(t){a&&(s+=i),s+=t,a+=1}),t=t.replace(/<#1>/g,s)},MultiArgMorph.prototype.evaluate=function(){var e=[];return this.inputs().forEach(function(t){e.push(t.evaluate())}),e},MultiArgMorph.prototype.isEmptySlot=function(){return!!this.canBeEmpty&&0===this.inputs().length},ArgLabelMorph.prototype=new ArgMorph,ArgLabelMorph.prototype.constructor=ArgLabelMorph,ArgLabelMorph.uber=ArgMorph.prototype,ArgLabelMorph.prototype.init=function(t,e){var o;this.labelText=localize(e||"input list:"),ArgLabelMorph.uber.init.call(this,null,!0),this.isStatic=!0,this.alpha=0,this.noticesTransparentclick=!0,o=this.labelPart(this.labelText),this.add(o),this.add(t)},ArgLabelMorph.prototype.label=function(){return this.children[0]},ArgLabelMorph.prototype.argMorph=function(){return this.children[1]},ArgLabelMorph.prototype.fixLayout=function(){var t,e,o=this.label();this.parent&&(this.color=this.parent.color,t=(e=o.shadowOffset||new Point).x<0?this.parent.color.darker(this.labelContrast):this.parent.color.lighter(this.labelContrast),""!==this.labelText&&(o.shadowColor.eq(t)||(o.shadowColor=t,o.shadowOffset=e,o.drawNew()))),ArgLabelMorph.uber.fixLayout.call(this),this.parent&&this.parent.fixLayout()},ArgLabelMorph.prototype.refresh=function(){this.inputs().forEach(function(t){t.drawNew()})},ArgLabelMorph.prototype.drawNew=function(){ArgLabelMorph.uber.drawNew.call(this),this.refresh()},ArgLabelMorph.prototype.setLabelColor=function(t,e,o){if(""!==this.labelText){var i=this.label();i.color=t,i.shadowColor=e,i.shadowOffset=o,i.drawNew()}},ArgLabelMorph.prototype.reactToGrabOf=function(){this.parent instanceof SyntaxElementMorph&&this.parent.revertToDefaultInput(this)},ArgLabelMorph.prototype.evaluate=function(){return this.argMorph().evaluate()},ArgLabelMorph.prototype.isEmptySlot=function(){return!1},FunctionSlotMorph.prototype=new ArgMorph,FunctionSlotMorph.prototype.constructor=FunctionSlotMorph,FunctionSlotMorph.uber=ArgMorph.prototype,FunctionSlotMorph.prototype.init=function(t,e){FunctionSlotMorph.uber.init.call(this,null,!0),this.isPredicate=t||!1,this.color=this.rfColor,this.setExtent(new Point(2*(this.fontSize+2*this.edge),this.fontSize+2*this.edge),e)},FunctionSlotMorph.prototype.getSpec=function(){return"%f"},FunctionSlotMorph.prototype.drawNew=function(){var t,e;this.image=newCanvas(this.extent()),t=this.image.getContext("2d"),e=this.parent?this.parent.color:new Color(120,120,120),this.cachedClr=e.toString(),this.cachedClrBright=e.lighter(this.contrast).toString(),this.cachedClrDark=e.darker(this.contrast).toString(),this.isPredicate?this.drawDiamond(t):this.drawRounded(t)},FunctionSlotMorph.prototype.drawRounded=function(t){var e,o=this.height(),i=Math.min(this.rounding,o/2),r=this.width(),n=this.edge/2;t.fillStyle=this.color.toString(),t.beginPath(),t.arc(i,i,i,radians(-180),radians(-90),!1),t.arc(r-i,i,i,radians(-90),radians(-0),!1),t.arc(r-i,o-i,i,radians(0),radians(90),!1),t.arc(i,o-i,i,radians(90),radians(180),!1),t.closePath(),t.fill(),MorphicPreferences.isFlat||(t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=this.cachedClr,t.beginPath(),t.arc(i,o-i,i-n,radians(90),radians(180),!1),t.stroke(),t.strokeStyle=this.cachedClr,t.beginPath(),t.arc(r-i,i,i-n,radians(-90),radians(0),!1),t.stroke(),t.shadowOffsetX=n,t.shadowOffsetY=n,t.shadowBlur=this.edge,t.shadowColor=this.color.darker(80).toString(),(e=t.createLinearGradient(0,0,0,this.edge)).addColorStop(1,this.cachedClrDark),e.addColorStop(0,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(i-n,n),t.lineTo(r-i+n,n),t.stroke(),(e=t.createRadialGradient(i,i,i-this.edge,i,i,i)).addColorStop(1,this.cachedClr),e.addColorStop(0,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.arc(i,i,i-n,radians(180),radians(270),!1),t.stroke(),(e=t.createLinearGradient(0,0,this.edge,0)).addColorStop(1,this.cachedClrDark),e.addColorStop(0,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(n,i),t.lineTo(n,o-i),t.stroke(),t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0,(e=t.createRadialGradient(r-i,o-i,i-this.edge,r-i,o-i,i)).addColorStop(1,this.cachedClr),e.addColorStop(0,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.arc(r-i,o-i,i-n,radians(0),radians(90),!1),t.stroke(),(e=t.createLinearGradient(0,o-this.edge,0,o)).addColorStop(1,this.cachedClr),e.addColorStop(0,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.moveTo(i-n,o-n),t.lineTo(r-i+n,o-n),t.stroke(),(e=t.createLinearGradient(r-this.edge,0,r,0)).addColorStop(1,this.cachedClr),e.addColorStop(0,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.moveTo(r-n,i+n),t.lineTo(r-n,o-i),t.stroke())},FunctionSlotMorph.prototype.drawDiamond=function(t){var e,o=this.width(),i=this.height(),r=Math.floor(i/2),n=Math.min(this.rounding,r),s=this.edge/2;t.fillStyle=this.color.toString(),t.beginPath(),t.moveTo(0,r),t.lineTo(n,0),t.lineTo(o-n,0),t.lineTo(o,r),t.lineTo(o-n,i),t.lineTo(n,i),t.closePath(),t.fill(),MorphicPreferences.isFlat||(t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=this.cachedClr,t.beginPath(),t.moveTo(s,r),t.lineTo(n,i-s),t.stroke(),t.strokeStyle=this.cachedClr,t.beginPath(),t.moveTo(o-s,r),t.lineTo(o-n,s),t.stroke(),t.shadowOffsetX=s,t.shadowOffsetY=s,t.shadowBlur=this.edge,t.shadowColor=this.color.darker(80).toString(),(e=t.createLinearGradient(0,0,n,0)).addColorStop(1,this.cachedClrDark),e.addColorStop(0,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(s,r),t.lineTo(n,s),t.stroke(),(e=t.createLinearGradient(0,0,0,this.edge)).addColorStop(1,this.cachedClrDark),e.addColorStop(0,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(n,s),t.lineTo(o-n,s),t.stroke(),t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0,(e=t.createLinearGradient(o-n,0,o,0)).addColorStop(1,this.cachedClr),e.addColorStop(0,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.moveTo(o-n,i-s),t.lineTo(o-s,r),t.stroke(),(e=t.createLinearGradient(0,i-this.edge,0,i)).addColorStop(1,this.cachedClr),e.addColorStop(0,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.moveTo(n+s,i-s),t.lineTo(o-n-s,i-s),t.stroke())},ReporterSlotMorph.prototype=new FunctionSlotMorph,ReporterSlotMorph.prototype.constructor=ReporterSlotMorph,ReporterSlotMorph.uber=FunctionSlotMorph.prototype,ReporterSlotMorph.prototype.init=function(t){ReporterSlotMorph.uber.init.call(this,t,!0),this.add(this.emptySlot()),this.fixLayout()},ReporterSlotMorph.prototype.emptySlot=function(){var t=new ArgMorph,e=2*this.rfBorder+2*this.edge;return t.color=this.rfColor,t.alpha=0,t.setExtent(new Point(2*(this.fontSize+2*this.edge)-e,this.fontSize+2*this.edge-e)),t},ReporterSlotMorph.prototype.getSpec=function(){return"%r"},ReporterSlotMorph.prototype.contents=function(){return this.children[0]},ReporterSlotMorph.prototype.nestedBlock=function(){var t=this.contents();return t instanceof ReporterBlockMorph?t:null},ReporterSlotMorph.prototype.evaluate=function(){return this.nestedBlock()},ReporterSlotMorph.prototype.isEmptySlot=function(){return null===this.nestedBlock()},ReporterSlotMorph.prototype.fixLayout=function(){var t=this.contents();this.setExtent(t.extent().add(2*this.edge+2*this.rfBorder)),t.setCenter(this.center()),this.parent&&this.parent.fixLayout&&this.parent.fixLayout()},RingReporterSlotMorph.prototype=new ReporterSlotMorph,RingReporterSlotMorph.prototype.constructor=RingReporterSlotMorph,RingReporterSlotMorph.uber=ReporterSlotMorph.prototype,RingReporterSlotMorph.prototype.rfBorder=RingCommandSlotMorph.prototype.rfBorder,RingReporterSlotMorph.prototype.edge=RingCommandSlotMorph.prototype.edge,RingReporterSlotMorph.prototype.init=function(t){RingReporterSlotMorph.uber.init.call(this,t,!0),this.alpha=RingMorph.prototype.alpha,this.contrast=RingMorph.prototype.contrast,this.isHole=!0},RingReporterSlotMorph.prototype.getSpec=function(){return"%rr"},RingReporterSlotMorph.prototype.replaceInput=function(t,e){RingReporterSlotMorph.uber.replaceInput.call(this,t,e),this.parent instanceof RingMorph&&this.parent.vanishForSimilar()},RingReporterSlotMorph.prototype.drawRounded=function(t){var e,o=this.height(),i=Math.min(this.rounding,o/2),r=this.width(),n=this.edge/2;t.fillStyle=this.cachedClr,t.beginPath(),t.moveTo(0,o/2),t.arc(i,i,i,radians(-180),radians(-90),!1),t.arc(r-i,i,i,radians(-90),radians(-0),!1),t.lineTo(r,o/2),t.lineTo(r,0),t.lineTo(0,0),t.closePath(),t.fill(),t.beginPath(),t.moveTo(r,o/2),t.arc(r-i,o-i,i,radians(0),radians(90),!1),t.arc(i,o-i,i,radians(90),radians(180),!1),t.lineTo(0,o/2),t.lineTo(0,o),t.lineTo(r,o),t.closePath(),t.fill(),MorphicPreferences.isFlat||(t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=this.cachedClr,t.beginPath(),t.arc(i,o-i,i-n,radians(90),radians(180),!1),t.stroke(),t.strokeStyle=this.cachedClr,t.beginPath(),t.arc(r-i,i,i-n,radians(-90),radians(0),!1),t.stroke(),t.shadowOffsetX=n,t.shadowOffsetY=n,t.shadowBlur=this.edge,t.shadowColor=this.color.darker(80).toString(),(e=t.createLinearGradient(0,0,0,this.edge)).addColorStop(1,this.cachedClrDark),e.addColorStop(0,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(i-n,n),t.lineTo(r-i+n,n),t.stroke(),(e=t.createRadialGradient(i,i,i-this.edge,i,i,i)).addColorStop(1,this.cachedClr),e.addColorStop(0,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.arc(i,i,i-n,radians(180),radians(270),!1),t.stroke(),(e=t.createLinearGradient(0,0,this.edge,0)).addColorStop(1,this.cachedClrDark),e.addColorStop(0,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(n,i),t.lineTo(n,o-i),t.stroke(),t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0,(e=t.createRadialGradient(r-i,o-i,i-this.edge,r-i,o-i,i)).addColorStop(1,this.cachedClr),e.addColorStop(0,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.arc(r-i,o-i,i-n,radians(0),radians(90),!1),t.stroke(),(e=t.createLinearGradient(0,o-this.edge,0,o)).addColorStop(1,this.cachedClr),e.addColorStop(0,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.moveTo(i-n,o-n),t.lineTo(r-i+n,o-n),t.stroke(),(e=t.createLinearGradient(r-this.edge,0,r,0)).addColorStop(1,this.cachedClr),e.addColorStop(0,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.moveTo(r-n,i+n),t.lineTo(r-n,o-i),t.stroke())},RingReporterSlotMorph.prototype.drawDiamond=function(t){var e,o=this.width(),i=this.height(),r=Math.floor(i/2),n=Math.min(this.rounding,r),s=this.edge/2;t.fillStyle=this.cachedClr,t.beginPath(),t.moveTo(0,0),t.lineTo(0,r),t.lineTo(n,0),t.lineTo(o-n,0),t.lineTo(o,r),t.lineTo(o,0),t.closePath(),t.fill(),t.moveTo(o,r),t.lineTo(o-n,i),t.lineTo(n,i),t.lineTo(0,r),t.lineTo(0,i),t.lineTo(o,i),t.closePath(),t.fill(),MorphicPreferences.isFlat||(t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=this.cachedClr,t.beginPath(),t.moveTo(s,r),t.lineTo(n,i-s),t.stroke(),t.strokeStyle=this.cachedClr,t.beginPath(),t.moveTo(o-s,r),t.lineTo(o-n,s),t.stroke(),t.shadowOffsetX=s,t.shadowOffsetY=s,t.shadowBlur=this.edge,t.shadowColor=this.color.darker(80).toString(),(e=t.createLinearGradient(0,0,n,0)).addColorStop(1,this.cachedClrDark),e.addColorStop(0,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(s,r),t.lineTo(n,s),t.stroke(),(e=t.createLinearGradient(0,0,0,this.edge)).addColorStop(1,this.cachedClrDark),e.addColorStop(0,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(n,s),t.lineTo(o-n,s),t.stroke(),t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0,(e=t.createLinearGradient(o-n,0,o,0)).addColorStop(1,this.cachedClr),e.addColorStop(0,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.moveTo(o-n,i-s),t.lineTo(o-s,r),t.stroke(),(e=t.createLinearGradient(0,i-this.edge,0,i)).addColorStop(1,this.cachedClr),e.addColorStop(0,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.moveTo(n+s,i-s),t.lineTo(o-n-s,i-s),t.stroke())},CommentMorph.prototype=new BoxMorph,CommentMorph.prototype.constructor=CommentMorph,CommentMorph.uber=BoxMorph.prototype,CommentMorph.prototype.refreshScale=function(){CommentMorph.prototype.fontSize=SyntaxElementMorph.prototype.fontSize,CommentMorph.prototype.padding=5*SyntaxElementMorph.prototype.scale,CommentMorph.prototype.rounding=8*SyntaxElementMorph.prototype.scale},CommentMorph.prototype.refreshScale(),CommentMorph.prototype.init=function(t){var e=this,o=SyntaxElementMorph.prototype.scale;this.block=null,this.stickyOffset=null,this.isCollapsed=!1,this.titleBar=new BoxMorph(this.rounding,1.000001*o,new Color(255,255,180)),this.titleBar.color=new Color(255,255,180),this.titleBar.setHeight(fontHeight(this.fontSize)+this.padding),this.title=null,this.arrow=new ArrowMorph("down",this.fontSize),this.arrow.noticesTransparentClick=!0,this.arrow.mouseClickLeft=function(){e.toggleExpand()},this.contents=new TextMorph(t||localize("add comment here..."),this.fontSize),this.lastValue=this.contents.text,this.contents.isEditable=!0,this.contents.enableSelecting(),this.contents.maxWidth=90*o,this.contents.drawNew(),this.handle=new HandleMorph(this.contents,80,2*this.fontSize,-2,-2),this.handle.setExtent(new Point(11*o,11*o)),this.anchor=null,CommentMorph.uber.init.call(this,this.rounding,1.000001*o,new Color(255,255,180)),this.color=new Color(255,255,220),this.isDraggable=!0,this.add(this.titleBar),this.add(this.arrow),this.add(this.contents),this.add(this.handle),this.fixLayout()},CommentMorph.prototype.reactToEdit=function(t){var e=t.text;e!==this.lastValue&&(this.contents.text=this.lastValue,this.contents.drawNew(),this.contents.changed(),this.layoutChanged(),SnapActions.setCommentText(this,e))},CommentMorph.prototype.fullCopy=function(){var t=new CommentMorph(this.contents.text);return t.isCollapsed=this.isCollapsed,t.setTextWidth(this.textWidth()),t.id=this.id,t},CommentMorph.prototype.setTextWidth=function(t){this.contents.maxWidth=t,this.contents.drawNew(),this.fixLayout()},CommentMorph.prototype.textWidth=function(){return this.contents.maxWidth},CommentMorph.prototype.text=function(){return this.contents.text},CommentMorph.prototype.toggleExpand=function(){this.isCollapsed=!this.isCollapsed,this.fixLayout(),this.align()},CommentMorph.prototype.layoutChanged=function(){this.fixLayout(),this.align()},CommentMorph.prototype.fixLayout=function(){var t,e=this.contents.width()+2*this.padding,o=this,i=Morph.prototype.trackChanges;Morph.prototype.trackChanges=!1,this.title&&(this.title.destroy(),this.title=null),this.isCollapsed?(this.contents.hide(),this.title=new FrameMorph,this.title.alpha=0,this.title.acceptsDrops=!1,(t=new StringMorph(this.contents.text,this.fontSize,null,!0)).rootForGrab=function(){return o},this.title.add(t),this.title.setHeight(t.height()),this.title.setWidth(e-this.arrow.width()-2*this.padding-this.rounding),this.add(this.title)):this.contents.show(),this.titleBar.setWidth(e),this.contents.setLeft(this.titleBar.left()+this.padding),this.contents.setTop(this.titleBar.bottom()+this.padding),this.arrow.direction=this.isCollapsed?"right":"down",this.arrow.drawNew(),this.arrow.setCenter(this.titleBar.center()),this.arrow.setLeft(this.titleBar.left()+this.padding),this.title&&this.title.setPosition(this.arrow.topRight().add(new Point(this.padding,0))),Morph.prototype.trackChanges=i,this.changed(),this.silentSetHeight(this.titleBar.height()+(this.isCollapsed?0:this.padding+this.contents.height()+this.padding)),this.silentSetWidth(this.titleBar.width()),this.drawNew(),this.handle.drawNew(),this.changed()},CommentMorph.prototype.userMenu=function(){var t=new MenuMorph(this),e=this;return t.addItem("duplicate",function(){var t=e.fullCopy();t.id=null,t.pickUp(e.world())},"make a copy\nand pick it up"),t.addItem("delete",function(){this.id?SnapActions.removeBlock(this):this.destroy()}),t.addItem("comment pic...",function(){var t=e.parentThatIsA(IDE_Morph);t.saveCanvasAs(e.fullImageClassic(),t.projectName||localize("Untitled")+" "+localize("comment pic"))},"download a picture of this comment"),t},CommentMorph.prototype.hide=function(){this.isVisible=!1,this.changed()},CommentMorph.prototype.show=function(){this.isVisible=!0,this.changed()},CommentMorph.prototype.prepareToBeGrabbed=function(t){this.block&&(this.block.comment=null,this.block=null),this.anchor&&(this.anchor.destroy(),this.anchor=null,this.removeShadow(),this.addShadow())},CommentMorph.prototype.snapTarget=function(t){return this.parent.closestBlock(this,t)},CommentMorph.prototype.snap=function(t){if(!(this.parent instanceof ScriptsMorph))return null;null!==t&&((t.comment=this).block=t,this.snapSound&&this.snapSound.play()),this.align()},CommentMorph.prototype.align=function(t,e){if(this.block){var o,i,r,n,s=t||this.block.topBlock(),a=s.parentThatIsA(ScriptsMorph);this.setTop(this.block.top()+this.block.corner),i=this.top(),r=this.bottom(),o=s.allChildren().filter(function(t){return t instanceof BlockMorph&&t.bottom()>i&&t.top()<r}),n=Math.max.apply(null,o.map(function(t){return t.right()})),this.setLeft(n+5),!e&&a&&a.addBack(this),this.anchor||(this.anchor=new Morph,this.anchor.color=this.titleBar.color),this.anchor.silentSetPosition(new Point(this.block.right(),this.top()+this.edge)),this.anchor.bounds.corner=new Point(this.left(),this.top()+this.edge+1),this.anchor.drawNew(),this.addBack(this.anchor),this.anchor.changed()}},CommentMorph.prototype.startFollowing=function(t,e){this.align(t),e.add(this),this.addShadow(),this.stickyOffset=this.position().subtract(this.block.position()),this.step=function(){this.setPosition(this.block.position().add(this.stickyOffset))}},CommentMorph.prototype.stopFollowing=function(){this.removeShadow(),delete this.step},CommentMorph.prototype.destroy=function(){this.block&&(this.block.comment=null),CommentMorph.uber.destroy.call(this)},CommentMorph.prototype.stackHeight=function(){return this.height()},ScriptFocusMorph.prototype=new BoxMorph,ScriptFocusMorph.prototype.constructor=ScriptFocusMorph,ScriptFocusMorph.uber=BoxMorph.prototype,ScriptFocusMorph.prototype.init=function(t,e,o){this.editor=t,this.element=e,this.atEnd=!1,ScriptFocusMorph.uber.init.call(this),this.element instanceof ScriptsMorph&&this.setPosition(o)},ScriptFocusMorph.prototype.getFocus=function(t){t||(t=this.world()),t&&t.keyboardReceiver!==this&&t.stopEditing(),(t.keyboardReceiver=this).fixLayout()},ScriptFocusMorph.prototype.fixLayout=function(){this.changed(),this.element instanceof CommandBlockMorph||this.element instanceof CommandSlotMorph||this.element instanceof ScriptsMorph?this.manifestStatement():this.manifestExpression(),this.editor.add(this),this.scrollIntoView(),this.changed()},ScriptFocusMorph.prototype.manifestStatement=function(){var t=this.element instanceof ScriptsMorph,e=this.element.top();this.border=0,this.edge=0,this.alpha=1,this.color=this.editor.feedbackColor,this.setExtent(new Point(t?SyntaxElementMorph.prototype.hatWidth:this.element.width(),Math.max(SyntaxElementMorph.prototype.corner,SyntaxElementMorph.prototype.feedbackMinHeight))),this.element instanceof CommandSlotMorph?e+=SyntaxElementMorph.prototype.corner:this.atEnd&&(e=this.element.bottom()),t||this.setPosition(new Point(this.element.left(),e)),this.fps=2,this.show(),this.step=function(){this.toggleVisibility()}},ScriptFocusMorph.prototype.manifestExpression=function(){this.edge=SyntaxElementMorph.prototype.rounding,this.border=Math.max(SyntaxElementMorph.prototype.edge,3),this.color=this.editor.feedbackColor.copy(),this.color.a=.5,this.borderColor=this.editor.feedbackColor,this.bounds=this.element.fullBounds().expandBy(Math.max(2*SyntaxElementMorph.prototype.edge,SyntaxElementMorph.prototype.reporterDropFeedbackPadding)),this.drawNew(),delete this.fps,delete this.step,this.show()},ScriptFocusMorph.prototype.trigger=function(){var t=this.element,e=this;if(t instanceof MultiArgMorph)t.arrows().children[1].isVisible&&SnapActions.addListInput(t).then(function(){e.fixLayout()});else if(t.parent instanceof TemplateSlotMorph)t.mouseClickLeft();else if(t instanceof BooleanSlotMorph)SnapActions.toggleBoolean(t,t.value);else if(t instanceof InputSlotMorph){var o=t.updateFieldValue;t.updateFieldValue=function(){var t=o.apply(this,arguments);t&&t.then(function(){e.fixLayout()}),this.updateFieldValue=o},t.isReadOnly?t.choices&&(t.dropDownMenu(!0),delete this.fps,delete this.step,this.hide()):(delete this.fps,delete this.step,this.hide(),this.world().onNextStep=function(){t.contents().edit(),t.contents().selectAll()})}},ScriptFocusMorph.prototype.menu=function(){var t=this.element;t instanceof InputSlotMorph&&t.choices?(t.dropDownMenu(!0),delete this.fps,delete this.step,this.hide()):this.insertVariableGetter()},ScriptFocusMorph.prototype.deleteLastElement=function(){var t,e,o=this.element,i=this;if(o.parent instanceof ScriptsMorph){if(this.atEnd||o instanceof ReporterBlockMorph)return void SnapActions.removeBlock(o).then(function(){i.element=i.editor,i.atEnd=!1,i.editor.adjustBounds(),i.fixLayout()})}else if(o instanceof MultiArgMorph)o.arrows().children[0].isVisible&&(e=SnapActions.removeListInput(o));else if(o instanceof BooleanSlotMorph)o.isStatic||(e=SnapActions.toggleBoolean(o,!1));else if(o instanceof ReporterBlockMorph){if(!o.isTemplate)return void SnapActions.removeBlock(o).then(function(){i.lastElement(),i.editor.adjustBounds(),i.fixLayout()})}else if(o instanceof CommandBlockMorph){if(this.atEnd)return t=o.parent,void SnapActions.removeBlock(o,!0).then(function(){i.element=t,i.editor.adjustBounds(),i.fixLayout()});o.parent instanceof CommandBlockMorph&&(e=SnapActions.removeBlock(o.parent,!0))}e&&e.then(function(){i.editor.adjustBounds(),i.fixLayout()})},ScriptFocusMorph.prototype.insertBlock=function(t){var e,o,i,r,n=this;if(t.isTemplate=!1,t.isDraggable=!0,this.element instanceof ScriptsMorph)t instanceof CommandBlockMorph?t.isStop()?i=this.topLeft():(i=new Point(this.left(),this.top()-t.height()),r=!0):i=new Point(this.left(),this.center().y+t.height()/2),o=SnapActions.addBlock(t,this.editor,i);else if(this.element instanceof CommandBlockMorph){var s;this.atEnd?s={point:this.element.bottomAttachPoint(),element:this.element,loc:"bottom",type:"block"}:(e=this.element.parent)instanceof ScriptsMorph?s={point:this.element.topAttachPoint(),element:this.element,loc:"top",type:"block"}:e instanceof CommandSlotMorph?s={point:e.slotAttachPoint(),element:e,loc:"bottom",type:"slot"}:e instanceof CommandBlockMorph&&(s={point:e.bottomAttachPoint(),element:e,loc:"bottom",type:"block"}),o=SnapActions.moveBlock(t,s)}else o=this.element instanceof CommandSlotMorph?(s={point:this.element.slotAttachPoint(),element:this.element,loc:"bottom",type:"slot"},r=!0,SnapActions.moveBlock(t,s)):(e=this.element.parent)instanceof ScriptsMorph?SnapActions.replaceBlock(this.element,t):(r=!0,SnapActions.moveBlock(t,this.element));o.then(function(t){r&&(n.atEnd=!0),n.element=t,n.fixLayout(),t.inputs&&t.inputs().length&&(n.element=t,n.atEnd=!1,n.nextElement())})},ScriptFocusMorph.prototype.insertVariableGetter=function(){var t,e=this.blockTypes(),o=this,i=new MenuMorph;e&&contains(e,"reporter")&&(t=InputSlotMorph.prototype.getVarNamesDict.call(this.element),Object.keys(t).forEach(function(t){var e=SpriteMorph.prototype.variableBlock(t);e.addShadow(new Point(3,3)),i.addItem(e,function(){e.removeShadow(),o.insertBlock(e)})}),0<i.items.length&&(i.popup(this.world(),this.element.bottomLeft()),i.getFocus()))},ScriptFocusMorph.prototype.stopEditing=function(){this.editor.focus=null,this.world().keyboardReceiver=null,this.destroy()},ScriptFocusMorph.prototype.lastElement=function(){var t,e=this.items();e.length?(this.atEnd?(this.element=e[e.length-1],this.atEnd=!1):((t=e.indexOf(this.element)-1)<0&&(t=e.length-1),this.element=e[t]),this.element instanceof CommandSlotMorph&&this.element.nestedBlock()?this.lastElement():this.element instanceof HatBlockMorph&&(1<e.length?this.lastElement():this.atEnd=!0),this.fixLayout()):this.shiftScript(new Point(-50,0))},ScriptFocusMorph.prototype.nextElement=function(){var t,e,o=this.items();o.length?((t=o.indexOf(this.element)+1)>=o.length&&(t=0),this.atEnd=!1,this.element=o[t],this.element instanceof CommandSlotMorph?(e=this.element.nestedBlock())&&(this.element=e):this.element instanceof HatBlockMorph&&(1===o.length?this.atEnd=!0:this.nextElement()),this.fixLayout()):this.shiftScript(new Point(50,0))},ScriptFocusMorph.prototype.lastCommand=function(){var t,e=this.element.parentThatIsA(CommandBlockMorph);e?(this.element instanceof CommandBlockMorph?this.atEnd?this.atEnd=!1:(t=e.parent.parentThatIsA(CommandBlockMorph))?this.element=t:(t=e.topBlock().bottomBlock())&&(this.element=t,this.atEnd=!0):(this.element=e,this.atEnd=!1),this.element instanceof HatBlockMorph&&!this.atEnd&&this.lastCommand(),this.fixLayout()):this.element instanceof ScriptsMorph&&this.shiftScript(new Point(0,-50))},ScriptFocusMorph.prototype.nextCommand=function(){var t,e,o,i=this.element;if(i instanceof ScriptsMorph)this.shiftScript(new Point(0,50));else{for(;!(i instanceof CommandBlockMorph);)if((i=i.parent)instanceof ScriptsMorph)return;this.atEnd?(o=i.parentThatIsA(CommandSlotMorph))?(this.element=o.parentThatIsA(CommandBlockMorph),this.atEnd=!1,this.nextCommand()):(t=i.topBlock().parentThatIsA(CommandBlockMorph))&&(this.element=t,this.atEnd=!1,this.element instanceof HatBlockMorph&&this.nextCommand()):(e=i.nextBlock())?this.element=e:(this.element=i,this.atEnd=!0),this.fixLayout()}},ScriptFocusMorph.prototype.nextScript=function(){var t,e=this.sortedScripts();if(!(e.length<1)){if(this.element instanceof ScriptsMorph&&(this.element=e[0]),(t=e.indexOf(this.element.topBlock())+1)>=e.length&&(t=0),this.element=e[t],this.element.scrollIntoView(),this.atEnd=!1,this.element instanceof HatBlockMorph)return this.nextElement();this.fixLayout()}},ScriptFocusMorph.prototype.lastScript=function(){var t,e=this.sortedScripts();if(!(e.length<1)){if(this.element instanceof ScriptsMorph&&(this.element=e[0]),(t=e.indexOf(this.element.topBlock())-1)<0&&(t=e.length-1),this.element=e[t],this.element.scrollIntoView(),this.atEnd=!1,this.element instanceof HatBlockMorph)return this.nextElement();this.fixLayout()}},ScriptFocusMorph.prototype.shiftScript=function(t){var e,o,i=this;this.element instanceof ScriptsMorph?(this.moveBy(t),this.editor.adjustBounds(),this.fixLayout()):!(o=this.element.topBlock())||o instanceof PrototypeHatBlockMorph||(e=o.topLeft().add(t),SnapActions.setBlockPosition(o,e).then(function(){i.editor.adjustBounds(),i.fixLayout()}))},ScriptFocusMorph.prototype.newScript=function(){var t=this.position();this.element instanceof ScriptsMorph||(t=this.element.topBlock().fullBounds().bottomLeft().add(new Point(0,50))),this.setPosition(t),this.element=this.editor,this.editor.adjustBounds(),this.fixLayout()},ScriptFocusMorph.prototype.runScript=function(){this.element instanceof ScriptsMorph||this.element.topBlock().mouseClickLeft()};ScriptFocusMorph.prototype.items=function(){return this.element instanceof ScriptsMorph?[]:this.element.topBlock().allChildren().filter(function(t){return t instanceof SyntaxElementMorph&&!(t instanceof TemplateSlotMorph)&&(!t.isStatic||t.choices||t instanceof BooleanSlotMorph||t instanceof RingMorph||t instanceof MultiArgMorph||t instanceof CommandSlotMorph)})},ScriptFocusMorph.prototype.sortedScripts=function(){var t=this.editor.children.filter(function(t){return t instanceof BlockMorph});return t.sort(function(t,e){return t instanceof PrototypeHatBlockMorph?0:t.top()-e.top()}),t},ScriptFocusMorph.prototype.blockTypes=function(){return this.element.isTemplate?null:this.element instanceof ScriptsMorph?["hat","command","reporter","predicate","ring"]:this.element instanceof HatBlockMorph||this.element instanceof CommandSlotMorph?["command"]:this.element instanceof CommandBlockMorph?this.atEnd&&this.element.isStop()?null:this.element.parent instanceof ScriptsMorph?["hat","command"]:["command"]:this.element instanceof ReporterBlockMorph?"%n"===this.element.getSlotSpec()?["reporter"]:["reporter","predicate","ring"]:"%n"===this.element.getSpec()?["reporter"]:this.element.isStatic?null:["reporter","predicate","ring"]},ScriptFocusMorph.prototype.processKeyDown=function(t){this.processKeyEvent(t,this.reactToKeyEvent)},ScriptFocusMorph.prototype.processKeyUp=function(t){nop(t)},ScriptFocusMorph.prototype.processKeyPress=function(t){nop(t)},ScriptFocusMorph.prototype.processKeyEvent=function(t,e){var o;switch(this.world().hand.destroyTemporaries(),t.keyCode){case 8:o="backspace";break;case 9:o="tab";break;case 13:o="enter";break;case 16:case 17:case 18:return;case 27:o="esc";break;case 32:o="space";break;case 37:o="left arrow";break;case 39:o="right arrow";break;case 38:o="up arrow";break;case 40:o="down arrow";break;default:o=String.fromCharCode(t.keyCode||t.charCode)}o=(t.ctrlKey||t.metaKey?"ctrl ":"")+(t.shiftKey?"shift ":"")+o,e.call(this,o)},ScriptFocusMorph.prototype.reactToKeyEvent=function(t){var e,o;switch(t.toLowerCase()){case"esc":return this.stopEditing();case"enter":return this.trigger();case"shift enter":return this.newScript();case"ctrl shift enter":return this.runScript();case"space":return this.menu();case"left arrow":return this.lastElement();case"shift left arrow":return this.shiftScript(new Point(-50,0));case"right arrow":return this.nextElement();case"shift right arrow":return this.shiftScript(new Point(50,0));case"up arrow":return this.lastCommand();case"shift up arrow":return this.shiftScript(new Point(0,-50));case"down arrow":return this.nextCommand();case"shift down arrow":return this.shiftScript(new Point(0,50));case"tab":return this.nextScript();case"shift tab":return this.lastScript();case"backspace":return this.deleteLastElement();case"ctrl z":return SnapUndo.undo(this.editor.owner);case"ctrl y":case"ctrl shift z":return SnapUndo.redo(this.editor.owner);case"ctrl [":return;default:e=this.blockTypes(),this.element instanceof ScriptsMorph||!e||!contains(e,"reporter")||(o=Object.keys(this.element.getVarNamesDict())),e&&(delete this.fps,delete this.step,this.show(),this.editor.owner.searchBlocks(t,e,o,this))}},BlockMorph.prototype._showHelp=BlockMorph.prototype.showHelp,BlockMorph.prototype.showHelp=function(){if(!this.isServiceBlock())return this._showHelp();var t,e,o,i=this.inputs(),r=i[0].evaluate(),n=i[1].evaluate()[0],s=SERVICES_URL+"/"+r,a=JSON.parse(utils.getUrlSync(s));if(""!==r){if(""!==n){t=(a=a.rpcs[n]).description;for(var h=a.args,l=0;l<h.length;l++){var p=h[l];if(p.description){var c=p.optional?"[optional]":"";t+="\n"+p.name+": "+p.description+" "+c}}}else t=a.description;t||(t="Description not available")}else t="Get information from different providers, save information and more. \nTo get more help select one of the services: "+a.slice(0,3).map(function(t){return t.name}).join(", ")+" ...";(e=this.fullCopy())instanceof CommandBlockMorph&&(o=e.nextBlock())&&o.destroy(),e.inputs().slice(2).forEach(function(t){t instanceof HintInputSlotMorph?t.setContents(""):t.userDestroy()}),e.addShadow(),(new DialogBoxMorph).inform("Help",t,this.world(),e.fullImage())},BlockMorph.prototype.isServiceBlock=function(){return contains(["getJSFromRPCStruct","doRunRPC"],this.selector)},MultiHintArgMorph.prototype=new MultiArgMorph,MultiHintArgMorph.prototype.constructor=MultiHintArgMorph,MultiHintArgMorph.uber=MultiArgMorph.prototype,MultiHintArgMorph.prototype.executeOnSliderEdit=!1,MultiHintArgMorph.prototype.init=function(t,e,o,i,r,n,s,a,h){this.hintText=t||"",MultiHintArgMorph.uber.init.call(this,"%s",e,o,i,r,n,s,a,h),0===this.inputs().length&&this.addInput()},MultiHintArgMorph.prototype.addInput=function(){var t=this.labelPart("%hint"+this.hintText),e=this.children.length-1;(t.parent=this).children.splice(e,0,t),t.drawNew(),this.fixLayout()},StructInputSlotMorph.prototype=new InputSlotMorph,StructInputSlotMorph.prototype.constructor=StructInputSlotMorph,StructInputSlotMorph.uber=InputSlotMorph.prototype,StructInputSlotMorph.prototype.executeOnSliderEdit=!1,StructInputSlotMorph.prototype.evaluate=function(){return[StructInputSlotMorph.uber.evaluate.call(this),this.fields]},StructInputSlotMorph.prototype.setContents=function(t,e){if(e=e||[],InputSlotMorph.prototype.setContents.call(this,t),this.parent){var o,i,r=this.parent.children,n=r.indexOf(this),s=this.fields.length+n+1,a=r[--s],h=[],l=this.parentThatIsA(ScriptsMorph),p=this.parent.inputs(),c=p.indexOf(this);for(s=0;s<this.fieldContent.length;s++)a=p[c+1+s],h.push(a),this.parent.removeChild(a),this.parent.removeChild(this.fieldContent[s]);for(this.fields=this.getFieldNames(t),this.fields||(this.fields=e.map(function(){return"???"})),l&&h.filter(function(t){return t instanceof BlockMorph}).forEach(l.add.bind(l)),this.fieldContent=[],s=0;s<this.fields.length;s++)o=n+s+1,i=this.getFieldValue(this.fields[s],e[s]),this.parent.children.splice(o,0,i),i.parent=this.parent,i.drawNew(),this.fieldContent.push(i);for(p=this.parent.inputs(),s=this.fields.length;s<e.length&&s<p.length;s++)p[s].setContents(e[s]);this.fixLayout(),this.drawNew(),this.parent.cachedInputs=null,this.parent.fixLayout(),this.parent.changed()}},StructInputSlotMorph.prototype.getFieldValue=function(t,e){return e&&"string"!=typeof e?e:new HintInputSlotMorph(e||"",t)},StructInputSlotMorph.prototype.setDefaultFieldArg=function(t){var e,o;return t<this.fields.length&&(e=this.parent.children.indexOf(this)+t+1,o=this.fieldContent[t]=this.getFieldValue(this.fields[t]),this.parent.children.splice(e,1,o),o.parent=this.parent),o.drawNew(),o.fixLayout(),o.drawNew(),this.parent.drawNew(),this.parent.fixLayout(),this.parent.drawNew(),o},InputSlotMorph.prototype.rpcNames=function(){var t,e,o,i=JSON.parse(utils.getUrlSync(SERVICES_URL)),r={};for(var n=i.length;n--;)if(o=i[n].name,i[n].categories.length)for(var s=i[n].categories.length;s--;){t=i[n].categories[s],e=r;for(var a=0;a<t.length;a++)e[t[a]]||(e[t[a]]={}),e=e[t[a]];e[o]=o}else r[o]=o;return r=function t(e){for(var o=Object.keys(e).sort(),i={},r=0;r<o.length;r++)e[o[r]]instanceof Object&&!Array.isArray(e[o[r]])?i[o[r]]=t(e[o[r]]):i[o[r]]=e[o[r]];return i}(r),SnapCloud.username&&r.Community&&r.Community[SnapCloud.username]&&((e={})[SnapCloud.username]=r.Community[SnapCloud.username],Object.keys(r.Community).forEach(function(t){t!==SnapCloud.username&&(e[t]=r.Community[t])}),r.Community=e),r},RPCInputSlotMorph.prototype=new StructInputSlotMorph,RPCInputSlotMorph.prototype.constructor=RPCInputSlotMorph,RPCInputSlotMorph.uber=StructInputSlotMorph.prototype,RPCInputSlotMorph.prototype.getRPCName=function(){var t,e,o=this.parent.inputs();return e=o.indexOf(this),(t=o[e-1])?t.evaluate():null},RPCInputSlotMorph.prototype.methodSignature=function(){var e,o,t,i={};if(o=this.getRPCName()){try{t=SERVICES_URL+"/"+o,this.fieldsFor=JSON.parse(utils.getUrlSync(t)).rpcs,e=Object.keys(this.fieldsFor),this.isCurrentRPCSupported=!0}catch(t){this.isCurrentRPCSupported=!1,this.parentThatIsA(BlockMorph).showBubble(localize('Service "'+o+'" is not available')),e=[]}for(var r=e.length;r--;){var n=e[r];this.fieldsFor[n].deprecated||(i[n]=n)}}return i},RPCInputSlotMorph.prototype.evaluate=function(){var t,e;return this.isCurrentRPCSupported||(e=InputSlotMorph.prototype.evaluate.call(this),t=this.getFieldNames(e),this.isCurrentRPCSupported&&(this.fields=t)),RPCInputSlotMorph.uber.evaluate.call(this)},HintInputSlotMorph.prototype=new InputSlotMorph,HintInputSlotMorph.prototype.constructor=HintInputSlotMorph,HintInputSlotMorph.uber=InputSlotMorph.prototype,HintInputSlotMorph.prototype.evaluate=function(){return this.empty?this.isNumeric?0:"":InputSlotMorph.prototype.evaluate.call(this)},HintInputSlotMorph.prototype.setContents=function(t){var e=new Color(0,0,0),o=this.contents();InputSlotMorph.prototype.setContents.apply(this,arguments),this.empty=""===t,this.empty&&(o.text=this.hintText,e=new Color(100,100,100)),o.color=e,o.drawNew()},HintInputSlotMorph.prototype.changed=function(){var t=this.contents();return t&&(this.empty=t.text===this.hintText),InputSlotMorph.prototype.changed.call(this)};var addStructReplaceSupport=function(h){return function(t){for(var e,o,i=-1,r=this.inputs(),n=r.indexOf(t),s=r.length;s--;)r[s]instanceof StructInputSlotMorph&&(e=r[i=s]);if(e&&i<n&&e.fields.length>=n-i){o=n-i-1;var a=e.setDefaultFieldArg(o);this.silentReplaceInput(t,a),this.cachedInputs=null}else h.apply(this,arguments)}},ThreadManager,Process,Context,VariableFrame,JSCompiler,SpriteMorph,StageMorph,SpriteBubbleMorph,Costume,SVG_Costume,CostumeEditorMorph,Sound,Note,CellMorph,WatcherMorph,StagePrompterMorph,Note,SpriteHighlightMorph,IDE_Morph,ProjectDialogMorph,LibraryImportDialogMorph,SpriteIconMorph,CostumeIconMorph,TurtleIconMorph,WardrobeMorph,SoundIconMorph,JukeboxMorph,StageHandleMorph,PaletteHandleMorph;function snapEquals(t,e){if(t instanceof List||e instanceof List)return t instanceof List&&e instanceof List&&t.equalTo(e);var o,i=+t,r=+e,n=[!0,!1,""];for(o=9;o<=13;o+=1)n.push(String.fromCharCode(o));return n.push(String.fromCharCode(160)),(isNaN(i)||isNaN(r)||[t,e].some(function(t){return contains(n,t)||isString(t)&&-1<t.indexOf(" ")}))&&(i=t,r=e),isString(i)&&isString(r)?i.toLowerCase()===r.toLowerCase():i===r}function invoke(t,e,o,i,r,n,s,a){var h=new Process,l=i?Date.now()+i:null;if(t instanceof Context)o&&(t=h.reportContextFor(o)),h.initializeFor(t,e||new List);else{if(!(t instanceof BlockMorph)){if(t.evaluate)return t.evaluate();if(t instanceof Function)return t.apply(o,e.asArray().concat(s));throw new Error("expecting a block or ring but getting "+t)}if(h.topBlock=t,!o)throw new Error("expecting a receiver but getting "+o);h.homeContext=new Context,(h.homeContext.receiver=o).variables&&(h.homeContext.variables.parentFrame=o.variables),h.context=new Context(null,t.blockSequence(),h.homeContext)}for(n&&(h.isCatchingErrors=!1);h.isRunning();){if(l&&Date.now()>l)throw new Error(localize(r||"a synchronous script has timed out"));h.runStep(l)}return a?h.homeContext:h.homeContext.inputs[0]}function ThreadManager(){this.processes=[],this.wantsToPause=!1}function Process(t,e,o){this.topBlock=t||null,this.readyToYield=!1,this.readyToTerminate=!1,this.isDead=!1,this.isClicked=!1,this.isShowingResult=!1,this.errorFlag=!1,this.context=null,this.homeContext=new Context,this.lastYield=Date.now(),this.isFirstStep=!0,this.isAtomic=!1,this.prompter=null,this.httpRequest=null,this.isPaused=!1,this.pauseOffset=null,this.frameCount=0,this.exportResult=!1,this.onComplete=e||null,this.procedureCount=0,this.flashingContext=null,this.isInterrupted=!1,t&&(this.homeContext.receiver=t.receiver(),this.homeContext.variables.parentFrame=this.homeContext.receiver.variables,this.context=new Context(null,t.blockSequence(),this.homeContext),o||this.pushContext("doYield"))}function Context(t,e,o,i){this.outerContext=o||null,this.parentContext=t||null,this.expression=e||null,this.receiver=i||null,this.variables=new VariableFrame,this.outerContext&&(this.variables.parentFrame=this.outerContext.variables,this.receiver=this.outerContext.receiver),this.inputs=[],this.pc=0,this.isContinuation=!1,this.startTime=null,this.activeAudio=null,this.activeNote=null,this.isCustomBlock=!1,this.emptySlots=0,this.tag=null,this.isFlashing=!1}function Variable(t,e){this.value=t,this.isTransient=e||!1}function VariableFrame(t,e){this.vars={},this.parentFrame=t||null,this.owner=e||null}function JSCompiler(t){this.process=t,this.source=null,this.gensyms=null,this.implicitParams=null,this.paramCount=null}function isSnapObject(t){return t instanceof SpriteMorph||t instanceof StageMorph}function SpriteMorph(t){this.init(t)}function SpriteHighlightMorph(){this.init()}function StageMorph(t){this.init(t)}function SpriteBubbleMorph(t,e,o,i){this.init(t,e,o,i)}function Costume(t,e,o){this.contents=t?normalizeCanvas(t,!0):newCanvas(null,!0),this.shrinkToFit(this.maxExtent()),this.name=e||null,this.rotationCenter=o||this.center(),this.version=Date.now(),this.loaded=null}function SVG_Costume(t,e,o){this.contents=t,this.shrinkToFit(this.maxExtent()),this.name=e||null,this.rotationCenter=o||this.center(),this.version=Date.now(),this.loaded=null}function CostumeEditorMorph(t){this.init(t)}function Sound(t,e){this.audio=t,this.name=e||"Sound"}function Note(t){this.pitch=0===t?0:t||69,this.setupContext(),this.oscillator=null}function Microphone(){this.audioContext=null,this.sourceStream=null,this.processor=null,this.analyser=null,this.resolution=2,this.GOOD_ENOUGH_CORRELATION=.96,this.modifier=null,this.compiledModifier=null,this.compilerProcess=null,this.correlations=[],this.wrapper=new List([0]),this.outChannels=[],this.volume=0,this.signals=[],this.output=[],this.frequencies=[],this.pitch=-1,this.isStarted=!1,this.isReady=!1,this.isAutoStop="file:"!==location.protocol,this.lastTime=Date.now()}function CellMorph(t,e,o,i){this.init(t,e,o,i)}function WatcherMorph(t,e,o,i,r){this.init(t,e,o,i,r)}function StagePrompterMorph(t){this.init(t)}function ReplayControls(){this.init()}ReporterBlockMorph.prototype.revertToDefaultInput=addStructReplaceSupport(ReporterBlockMorph.prototype.revertToDefaultInput),CommandBlockMorph.prototype.revertToDefaultInput=addStructReplaceSupport(CommandBlockMorph.prototype.revertToDefaultInput),modules.threads="2017-January-11",ThreadManager.prototype.pauseCustomHatBlocks=!1,ThreadManager.prototype.toggleProcess=function(t){var e=this.findProcess(t);if(!e)return this.startProcess(t,null,null,null,!0);e.stop()},ThreadManager.prototype.startProcess=function(t,e,o,i,r,n,s){var a,h=this.findProcess(t),l=t.topBlock();if(h){if(e)return h;h.stop(),this.removeTerminatedProcesses()}return(a=new NetsProcess(t.topBlock(),i,n,s)).exportResult=o,a.isClicked=r||!1,a.homeContext.receiver.isClone||l.addHighlight(),this.processes.push(a),n&&a.runStep(),a},ThreadManager.prototype.stopAll=function(e){this.processes.forEach(function(t){t!==e&&t.stop()})},ThreadManager.prototype.stopAllForReceiver=function(e,o){this.processes.forEach(function(t){t.homeContext.receiver===e&&t!==o&&(t.stop(),e.isClone&&(t.isDead=!0))})},ThreadManager.prototype.stopProcess=function(t){var e=this.findProcess(t);e&&e.stop()},ThreadManager.prototype.pauseAll=function(t){this.processes.forEach(function(t){t.pause()}),t&&t.pauseAllActiveSounds()},ThreadManager.prototype.isPaused=function(){return null!==detect(this.processes,function(t){return t.isPaused})},ThreadManager.prototype.resumeAll=function(t){this.processes.forEach(function(t){t.resume()}),t&&t.resumeAllActiveSounds()},ThreadManager.prototype.step=function(){var e;Process.prototype.enableSingleStepping&&(this.processes.forEach(function(t){t.isInterrupted?(t.runStep(),e=!0):t.lastYield=Date.now()}),this.wantsToPause=.5<Process.prototype.flashTime,e)?this.wantsToPause&&this.pauseAll():(this.processes.forEach(function(t){t.homeContext.receiver.isPickedUp()||t.isDead||t.runStep()}),this.removeTerminatedProcesses())},ThreadManager.prototype.removeTerminatedProcesses=function(){var o=[];this.processes.forEach(function(t){var e;!t.isRunning()&&!t.errorFlag||t.isDead?(t.topBlock instanceof BlockMorph&&(t.unflash(),t.topBlock.removeHighlight()),t.prompter&&(t.prompter.destroy(),t.homeContext.receiver.stopTalking&&t.homeContext.receiver.stopTalking()),(t.topBlock instanceof ReporterBlockMorph||t.isShowingResult)&&(e=t.homeContext.inputs[0],t.onComplete instanceof Function?t.onComplete(e):e instanceof List?t.topBlock.showBubble(e.isTable()?new TableFrameMorph(new TableMorph(e,10)):new ListWatcherMorph(e),t.exportResult):t.topBlock.showBubble(e,t.exportResult))):o.push(t)}),this.processes=o},ThreadManager.prototype.findProcess=function(t){var e=t.topBlock();return detect(this.processes,function(t){return t.topBlock===e})},ThreadManager.prototype.doWhen=function(e,t){if(!this.pauseCustomHatBlocks&&e&&!this.findProcess(e)){var o,i=e.inputs()[0];if(e.removeHighlight()&&(o=e.world())&&o.hand.destroyTemporaries(),!t)try{!0===invoke(i,null,e.receiver(),50,"the predicate takes\ntoo long for a\ncustom hat block",!0)&&this.startProcess(e,null,null,null,null,!0)}catch(t){e.addErrorHighlight(),e.showBubble(t.name+"\n"+t.message)}}},ThreadManager.prototype.toggleSingleStepping=function(){Process.prototype.enableSingleStepping=!Process.prototype.enableSingleStepping,Process.prototype.enableSingleStepping||this.processes.forEach(function(t){t.isPaused||t.unflash()})},Process.prototype={},Process.prototype.constructor=Process,Process.prototype.timeout=500,Process.prototype.isCatchingErrors=!0,Process.prototype.enableLiveCoding=!1,Process.prototype.enableSingleStepping=!1,Process.prototype.flashTime=0,Process.prototype.isRunning=function(){return null!==this.context&&!this.readyToTerminate},Process.prototype.runStep=function(t){if(this.isPaused)return this.pauseStep();for(this.readyToYield=!1,this.isInterrupted=!1;!this.readyToYield&&!this.isInterrupted&&this.context&&Date.now()-this.lastYield<this.timeout;){if(this.isPaused)return this.pauseStep();if(t&&Date.now()>t)return void(this.isAtomic&&this.homeContext.receiver&&this.homeContext.receiver.endWarp&&this.homeContext.receiver.endWarp());this.evaluateContext()}if(this.lastYield=Date.now(),this.isFirstStep=!1,this.isAtomic&&this.homeContext.receiver&&this.homeContext.receiver.endWarp&&(this.homeContext.receiver.endWarp(),this.homeContext.receiver.startWarp()),this.readyToTerminate){for(;this.context;)this.popContext();this.homeContext.receiver&&this.homeContext.receiver.endWarp&&this.homeContext.receiver.endWarp()}},Process.prototype.stop=function(){this.readyToYield=!0,this.readyToTerminate=!0,this.errorFlag=!1,this.context&&this.context.stopMusic()},Process.prototype.pause=function(){this.readyToTerminate||(this.isPaused=!0,this.flashPausedContext(),this.context&&this.context.startTime&&(this.pauseOffset=Date.now()-this.context.startTime))},Process.prototype.resume=function(){this.enableSingleStepping||this.unflash(),this.isPaused=!1,this.pauseOffset=null},Process.prototype.pauseStep=function(){this.lastYield=Date.now(),this.context&&this.context.startTime&&(this.context.startTime=this.lastYield-this.pauseOffset)},Process.prototype.evaluateContext=function(){var t=this.context.expression;return this.frameCount+=1,"exit"===this.context.tag&&this.expectReport(),t instanceof Array?this.evaluateSequence(t):t instanceof MultiArgMorph?this.evaluateMultiSlot(t,t.inputs().length):t instanceof ArgLabelMorph?this.evaluateArgLabel(t):t instanceof ArgMorph||t.bindingID?this.evaluateInput(t):t instanceof BlockMorph?this.evaluateBlock(t,t.inputs().length):isString(t)?this[t].apply(this,this.context.inputs):void this.popContext()},Process.prototype.evaluateBlock=function(e,t){var o=e.selector;if("reportOr"===o||"reportAnd"===o||"doReport"===o)return this[o](e);var i=this.context.receiver||this.topBlock.receiver(),r=this.context.inputs;if(t>r.length)this.evaluateNextInput(e);else{if(this.flashContext())return;if(this[o]&&(i=this),this.isCatchingErrors)try{this.returnValueToParentContext(i[o].apply(i,r)),this.popContext()}catch(t){this.handleError(t,e)}else this.returnValueToParentContext(i[o].apply(i,r)),this.popContext()}},Process.prototype.reportOr=function(t){var e=this.context.inputs;if(e.length<1)this.evaluateNextInput(t);else if(e[0]){if(this.flashContext())return;this.returnValueToParentContext(!0),this.popContext()}else if(e.length<2)this.evaluateNextInput(t);else{if(this.flashContext())return;this.returnValueToParentContext(!0===e[1]),this.popContext()}},Process.prototype.reportAnd=function(t){var e=this.context.inputs;if(e.length<1)this.evaluateNextInput(t);else if(e[0])if(e.length<2)this.evaluateNextInput(t);else{if(this.flashContext())return;this.returnValueToParentContext(!0===e[1]),this.popContext()}else{if(this.flashContext())return;this.returnValueToParentContext(!1),this.popContext()}},Process.prototype.doReport=function(t){var e=this.context.outerContext;if(!this.flashContext()){if(this.isClicked&&t.topBlock()===this.topBlock&&(this.isShowingResult=!0),this.context.expression.partOfCustomCommand)this.doStopCustomBlock(),this.popContext();else{for(;this.context&&"exit"!==this.context.tag;)"doStopWarping"===this.context.expression?this.doStopWarping():this.popContext();this.context&&("expectReport"===this.context.expression?this.popContext():this.context.tag=null)}this.pushContext(t.inputs()[0],e)}},Process.prototype.evaluateMultiSlot=function(e,t){var o,i=this.context.inputs;if(e.bindingID){if(this.isCatchingErrors)try{o=this.context.variables.getVar(e.bindingID)}catch(t){this.handleError(t,e)}else o=this.context.variables.getVar(e.bindingID);this.returnValueToParentContext(o),this.popContext()}else t>i.length?this.evaluateNextInput(e):(this.returnValueToParentContext(new List(i)),this.popContext())},Process.prototype.evaluateArgLabel=function(t){var e=this.context.inputs;e.length<1?this.evaluateNextInput(t):(this.returnValueToParentContext(e[0]),this.popContext())},Process.prototype.evaluateInput=function(e){var t;if(!this.flashContext()){if(e.bindingID)if(this.isCatchingErrors)try{t=this.context.variables.getVar(e.bindingID)}catch(t){this.handleError(t,e)}else t=this.context.variables.getVar(e.bindingID);else(t=e.evaluate())&&(e.constructor===CommandSlotMorph||e.constructor===ReporterSlotMorph||e instanceof CSlotMorph&&(!e.isStatic||e.isLambda))&&(t=this.reify(t,new List));this.returnValueToParentContext(t),this.popContext()}},Process.prototype.evaluateSequence=function(t){var e=this.context.pc,o=this.context.outerContext,i=this.context.isCustomBlock;e===t.length-1?(this.context=new Context(this.context.parentContext,t[e],this.context.outerContext,this.context.receiver),this.context.isCustomBlock=i):e>=t.length?this.popContext():(this.context.pc+=1,this.pushContext(t[e],o))},Process.prototype.evaluateNextInput=function(t){var e=this.context.inputs.length,o=t.inputs()[e],i=this.context.expression.selector,r=this.context.outerContext;o.isUnevaluated&&(!0===o.isUnevaluated||o.isUnevaluated())?"reify"===i||"reportScript"===i?this.context.addInput(o):this.context.addInput(this.reify(o,new List)):this.pushContext(o,r)},Process.prototype.doYield=function(){this.popContext(),this.isAtomic||(this.readyToYield=!0)},Process.prototype.expectReport=function(){this.handleError(new Error("reporter didn't report"))},Process.prototype.handleError=function(t,e){var o=e;this.stop(),this.errorFlag=!0,this.topBlock.addErrorHighlight(),(isNil(o)||isNil(o.world()))&&(o=this.topBlock),o.showBubble((o===e?"":"Inside: ")+t.name+"\n"+t.message,this.exportResult)},Process.prototype.errorObsolete=function(){throw new Error("a custom block definition is missing")},Process.prototype.reify=function(t,e,o){var i=this instanceof Process,r=new Context(null,null,i&&this.context?this.context.outerContext:null),n=0;return t?(r.expression=i&&(this.enableLiveCoding||this.enableSingleStepping)?t:t.fullCopy(),r.expression.show(),o||(r.expression.allEmptySlots().forEach(function(t){n+=1,t.bindingID=t instanceof MultiArgMorph?["arguments"]:n}),r.emptySlots=n)):r.expression=this.enableLiveCoding||this.enableSingleStepping?[this.context.expression]:[this.context.expression.fullCopy()],r.inputs=e.asArray(),r.receiver=i&&this.context?this.context.receiver:t.receiver(),r},Process.prototype.reportScript=function(t,e){return this.reify(e,t)},Process.prototype.reifyScript=function(t,e){return this.reify(t,e)},Process.prototype.reifyReporter=function(t,e){return this.reify(t,e)},Process.prototype.reifyPredicate=function(t,e){return this.reify(t,e)},Process.prototype.reportJSFunction=function(t,e){return Function.apply(null,t.asArray().concat([e]))},Process.prototype.doRun=function(t,e){return this.evaluate(t,e,!0)},Process.prototype.evaluate=function(t,e,o){if(!t)return null;if(t instanceof Function)return t.apply(this.blockReceiver(),e.asArray().concat([this]));if(t.isContinuation)return this.runContinuation(t,e);if(!(t instanceof Context))throw new Error("expecting a ring but getting "+t);var i,r,n,s,a=new Context(null,null,t.outerContext),h=this.context.parentContext,l=e.asArray();if(a.receiver||(a.receiver=t.receiver),r=new Context(this.context.parentContext,t.expression,a,t.receiver),this.context.parentContext=r,t.expression instanceof ReporterBlockMorph&&(this.readyToYield=Date.now()-this.lastYield>this.timeout),0<l.length){for(n=0;n<t.inputs.length;n+=1)s=0,isNil(l[n])||(s=l[n]),a.variables.addVar(t.inputs[n],s);if(0===t.inputs.length)if(a.variables.addVar(["arguments"],e),1===l.length)for(n=1;n<=t.emptySlots;n+=1)a.variables.addVar(n,l[0]);else if(l.length===t.emptySlots)for(n=1;n<=l.length;n+=1)a.variables.addVar(n,l[n-1]);else if(1!==t.emptySlots)throw new Error(localize("expecting")+" "+t.emptySlots+" "+localize("input(s), but getting")+" "+l.length)}r.expression instanceof CommandBlockMorph&&(r.expression=r.expression.blockSequence(),o||(h?h.tag="exit":((i=new Context(r.parentContext,"expectReport",a,a.receiver)).tag="exit",r.parentContext=i)))},Process.prototype.fork=function(t,e){var o=new Process,i=this.homeContext.receiver.parentThatIsA(StageMorph);o.initializeFor(t,e),i.threads.processes.push(o)},Process.prototype.initializeFor=function(t,e){if(t.isContinuation)throw new Error("continuations cannot be forked");if(!(t instanceof Context))throw new Error("expecting a ring but getting "+t);var o,i,r,n=new Context(null,null,t.outerContext),s=new Context(null,t.expression,n),a=e.asArray();if(0<a.length){for(o=0;o<t.inputs.length;o+=1)i=0,isNil(a[o])||(i=a[o]),n.variables.addVar(t.inputs[o],i);if(0===t.inputs.length)if(n.variables.addVar(["arguments"],e),1===a.length)for(o=1;o<=t.emptySlots;o+=1)n.variables.addVar(o,a[0]);else if(a.length===t.emptySlots)for(o=1;o<=a.length;o+=1)n.variables.addVar(o,a[o-1]);else if(1!==t.emptySlots)throw new Error(localize("expecting")+" "+t.emptySlots+" "+localize("input(s), but getting")+" "+a.length)}s.expression instanceof CommandBlockMorph&&(s.expression=s.expression.blockSequence(),(r=new Context(s.parentContext,"expectReport",n,n.receiver)).tag="exit",s.parentContext=r),this.homeContext=new Context,this.homeContext.receiver=t.outerContext.receiver,this.topBlock=t.expression,this.context=s},Process.prototype.doStopBlock=function(){var t=this.context.expression.exitTag;if(isNil(t))return this.doStopCustomBlock();for(;this.context&&(isNil(this.context.tag)||this.context.tag>t);)"doStopWarping"===this.context.expression?this.doStopWarping():this.popContext();this.pushContext()},Process.prototype.doStopCustomBlock=function(){for(;this.context&&!this.context.isCustomBlock;)"doStopWarping"===this.context.expression?this.doStopWarping():this.popContext()},Process.prototype.doCallCC=function(t,e){this.evaluate(t,new List([this.context.continuation()]),!e)},Process.prototype.reportCallCC=function(t){this.doCallCC(t,!0)},Process.prototype.runContinuation=function(t,e){var o=e.asArray();if("expectReport"===t.expression&&o.length)return this.stop(),void(this.homeContext.inputs[0]=o[0]);this.context.parentContext=t.copyForContinuationCall(),1===o.length&&this.context.parentContext.outerContext.variables.addVar(1,o[0])},Process.prototype.evaluateCustomBlock=function(){var t,e,o,i,r,n=this.context.parentContext,s=this.context.expression.definition.body,a=this.context.expression.definition.declarations,h=new List(this.context.inputs).asArray();if(!s)return null;if(this.procedureCount+=1,(r=new Context).receiver=this.context.receiver,r.variables.parentFrame=this.context.expression.variables,this.context.expression.definition.variableNames.length?this.context.expression.variables.parentFrame=r.receiver?r.receiver.variables:null:r.variables.parentFrame=r.receiver?r.receiver.variables:null,(t=new Context(this.context.parentContext,s.expression,r,r.receiver)).isCustomBlock=!0,this.context.parentContext=t,0<h.length)for(o=0;o<s.inputs.length;o+=1)i=0,isNil(h[o])||(i=h[o]),r.variables.addVar(s.inputs[o],i),"%upvar"===a[s.inputs[o]][0]&&(this.context.outerContext.variables.vars[i]=r.variables.vars[s.inputs[o]]);"command"!==this.context.expression.definition.type?(n?n.tag="exit":((e=new Context(t.parentContext,"expectReport",r,r.receiver)).tag="exit",t.parentContext=e),this.readyToYield=Date.now()-this.lastYield>this.timeout):(t.expression.tagExitBlocks(this.procedureCount,!0),n&&!n.tag&&(n.tag=this.procedureCount),!this.isAtomic&&this.context.expression.definition.isDirectlyRecursive()&&(this.readyToYield=!0)),t.expression=t.expression.blockSequence()},Process.prototype.doDeclareVariables=function(t){var e=this.context.outerContext.variables;t.asArray().forEach(function(t){e.addVar(t)})},Process.prototype.doSetVar=function(t,e){var o,i=this.context.variables,r=t;if(r instanceof Context)return o=this.blockReceiver(),"reportGetVar"===r.expression.selector?void r.variables.setVar(r.expression.blockSpec,e,o):void this.doSet(r,e);i.setVar(r,e,this.blockReceiver())},Process.prototype.doChangeVar=function(t,e){var o=this.context.variables,i=t;i instanceof Context&&"reportGetVar"===i.expression.selector?i.variables.changeVar(i.expression.blockSpec,e,this.blockReceiver()):o.changeVar(i,e,this.blockReceiver())},Process.prototype.reportGetVar=function(){return this.context.variables.getVar(this.context.expression.blockSpec)},Process.prototype.doShowVar=function(t){var e,o,i,r,n,s=this.context.variables,a=t;if(a instanceof Context&&"reportGetVar"===a.expression.selector&&(a=a.expression.blockSpec),this.homeContext.receiver&&(e=this.homeContext.receiver.parentThatIsA(StageMorph))){if(!(i=s.silentFind(a)))return;if(null!==(o=detect(e.children,function(t){return t instanceof WatcherMorph&&t.target===i&&t.getter===a})))return o.show(),void o.fixLayout();r=contains(this.homeContext.receiver.globalVariables().names(),t)||i.owner?a:a+" "+localize("(temporary)"),(o=new WatcherMorph(r,SpriteMorph.prototype.blockColor.variables,i,a)).setPosition(e.position().add(10)),0<(n=e.watchers(o.left())).length&&o.setTop(n[n.length-1].bottom()),e.add(o),o.fixLayout()}},Process.prototype.doHideVar=function(t){var e,o,i,r=this.context.variables,n=t;n instanceof Context&&"reportGetVar"===n.expression.selector&&(n=n.expression.blockSpec),n?this.homeContext.receiver&&(e=this.homeContext.receiver.parentThatIsA(StageMorph))&&(i=r.find(n),null!==(o=detect(e.children,function(t){return t instanceof WatcherMorph&&t.target===i&&t.getter===n}))&&(o.isTemporary()?o.destroy():o.hide())):this.doRemoveTemporaries()},Process.prototype.doRemoveTemporaries=function(){var t;this.homeContext.receiver&&(t=this.homeContext.receiver.parentThatIsA(StageMorph))&&t.watchers().forEach(function(t){t.isTemporary()&&t.destroy()})},Process.prototype.doDeleteAttr=function(t){var e=t,o=this.blockReceiver();e instanceof Context&&"reportGetVar"===e.expression.selector&&(e=e.expression.blockSpec),contains(o.inheritedVariableNames(!0),e)&&o.deleteVariable(e)},Process.prototype.reportNewList=function(t){return t},Process.prototype.reportCONS=function(t,e){return(new List).cons(t,e)},Process.prototype.reportCDR=function(t){return t.cdr()},Process.prototype.doAddToList=function(t,e){e.add(t)},Process.prototype.doDeleteFromList=function(t,e){var o=t;if("all"===this.inputOption(t))return e.clear();if(""===t)return null;if("last"===this.inputOption(t))o=e.length();else if(isNaN(+this.inputOption(t)))return null;e.remove(o)},Process.prototype.doInsertInList=function(t,e,o){var i=e;if(""===e)return null;"any"===this.inputOption(e)&&(i=this.reportRandom(1,o.length()+1)),"last"===this.inputOption(e)&&(i=o.length()+1),o.add(t,i)},Process.prototype.doReplaceInList=function(t,e,o){var i=t;if(""===t)return null;"any"===this.inputOption(t)&&(i=this.reportRandom(1,e.length())),"last"===this.inputOption(t)&&(i=e.length()),e.put(o,i)},Process.prototype.reportListItem=function(t,e){var o=t;return""===t?"":("any"===this.inputOption(t)&&(o=this.reportRandom(1,e.length())),"last"===this.inputOption(t)&&(o=e.length()),e.at(o))},Process.prototype.reportListLength=function(t){return t.length()},Process.prototype.reportListContainsItem=function(t,e){return t.contains(e)},Process.prototype.doShowTable=function(t){this.assertType(t,"list"),new TableDialogMorph(t).popUp(this.blockReceiver().world())},Process.prototype.doIf=function(){var t=this.context.inputs,e=this.context.outerContext,o=this.context.isCustomBlock;this.popContext(),t[0]&&t[1]&&(this.pushContext(t[1].blockSequence(),e),this.context.isCustomBlock=o),this.pushContext()},Process.prototype.doIfElse=function(){var t=this.context.inputs,e=this.context.outerContext,o=this.context.isCustomBlock;this.popContext(),t[0]?t[1]&&this.pushContext(t[1].blockSequence(),e):t[2]?this.pushContext(t[2].blockSequence(),e):this.pushContext("doYield"),this.context&&(this.context.isCustomBlock=o),this.pushContext()},Process.prototype.doStop=function(){this.stop()},Process.prototype.doStopAll=function(){var t,e;this.homeContext.receiver&&((t=this.homeContext.receiver.parentThatIsA(StageMorph))&&(t.threads.resumeAll(t),t.keysPressed={},t.threads.stopAll(),t.stopAllActiveSounds(),t.children.forEach(function(t){t.stopTalking&&t.stopTalking()}),t.removeAllClones()),(e=t.parentThatIsA(IDE_Morph))&&e.controlBar.pauseButton.refresh())},Process.prototype.doStopThis=function(t){switch(this.inputOption(t)){case"all":this.doStopAll();break;case"this script":this.doStop();break;case"this block":this.doStopBlock();break;default:nop()}},Process.prototype.doStopOthers=function(t){var e;if(this.homeContext.receiver&&(e=this.homeContext.receiver.parentThatIsA(StageMorph)))switch(this.inputOption(t)){case"all but this script":e.threads.stopAll(this);break;case"other scripts in sprite":e.threads.stopAllForReceiver(this.homeContext.receiver,this);break;default:nop()}},Process.prototype.doWarp=function(t){var e,o=this.context.outerContext,i=this.context.isCustomBlock;this.popContext(),t&&(this.homeContext.receiver&&(this.homeContext.receiver.startWarp&&this.homeContext.receiver.startWarp(),(e=this.homeContext.receiver.parentThatIsA(StageMorph))&&(e.fps=0)),this.pushContext("doYield"),this.context.isCustomBlock=i,this.isAtomic||this.pushContext("doStopWarping"),this.pushContext(t.blockSequence(),o),this.isAtomic=!0),this.pushContext()},Process.prototype.doStopWarping=function(){var t;this.popContext(),this.isAtomic=!1,this.homeContext.receiver&&(this.homeContext.receiver.endWarp&&this.homeContext.receiver.endWarp(),(t=this.homeContext.receiver.parentThatIsA(StageMorph))&&(t.fps=t.frameRate))},Process.prototype.reportIsFastTracking=function(){var t;return!(!this.homeContext.receiver||!(t=this.homeContext.receiver.parentThatIsA(IDE_Morph)))&&t.stage.isFastTracked},Process.prototype.doSetGlobalFlag=function(t,e){var o=this.homeContext.receiver.parentThatIsA(StageMorph);switch(t=this.inputOption(t),this.assertType(e,"Boolean"),t){case"turbo mode":this.doSetFastTracking(e);break;case"flat line ends":SpriteMorph.prototype.useFlatLineEnds=e;break;case"video capture":e?o.startVideo():o.stopProjection();break;case"mirror video":o.mirrorVideo=e}},Process.prototype.reportGlobalFlag=function(t){var e=this.homeContext.receiver.parentThatIsA(StageMorph);switch(t=this.inputOption(t)){case"turbo mode":return this.reportIsFastTracking();case"flat line ends":return SpriteMorph.prototype.useFlatLineEnds;case"video capture":return!isNil(e.projectionSource);case"mirror video":return e.mirrorVideo;default:return""}},Process.prototype.doSetFastTracking=function(t){var e;this.reportIsA(t,"Boolean")&&this.homeContext.receiver&&(e=this.homeContext.receiver.parentThatIsA(IDE_Morph))&&(t?e.startFastTracking():e.stopFastTracking())},Process.prototype.doSetFastTracking=function(t){var e;this.reportIsA(t,"Boolean")&&this.homeContext.receiver&&(e=this.homeContext.receiver.parentThatIsA(IDE_Morph))&&(t?e.startFastTracking():e.stopFastTracking())},Process.prototype.doPauseAll=function(){var t,e;this.homeContext.receiver&&((t=this.homeContext.receiver.parentThatIsA(StageMorph))&&t.threads.pauseAll(t),(e=t.parentThatIsA(IDE_Morph))&&e.controlBar.pauseButton.refresh())},Process.prototype.doForever=function(t){this.context.inputs=[],this.pushContext("doYield"),t&&this.pushContext(t.blockSequence()),this.pushContext()},Process.prototype.doRepeat=function(t,e){var o=this.context.expression,i=this.context.outerContext,r=this.context.isCustomBlock;if(t<1)return null;this.popContext(),this.pushContext(o,i),this.context.isCustomBlock=r,this.context.addInput(t-1),this.pushContext("doYield"),e&&this.pushContext(e.blockSequence()),this.pushContext()},Process.prototype.doUntil=function(t,e){if(t)return this.popContext(),this.pushContext("doYield"),null;this.context.inputs=[],this.pushContext("doYield"),e&&this.pushContext(e.blockSequence()),this.pushContext()},Process.prototype.doWaitUntil=function(t){if(t)return this.popContext(),this.pushContext("doYield"),null;this.context.inputs=[],this.pushContext("doYield"),this.pushContext()},Process.prototype.reportMap=function(t,e){var o;if(e.isLinked){if(this.context.inputs.length<3&&(this.context.addInput(new List),this.context.inputs[2].isLinked=!0,this.context.addInput(this.context.inputs[2]),this.context.addInput(e)),0===this.context.inputs[4].length())return this.context.inputs[3].rest=e.cons(this.context.inputs[5]),void this.returnValueToParentContext(this.context.inputs[2].cdr());5<this.context.inputs.length&&(this.context.inputs[3].rest=e.cons(this.context.inputs[5]),this.context.inputs[3]=this.context.inputs[3].rest,this.context.inputs.splice(5)),o=this.context.inputs[4].at(1),this.context.inputs[4]=this.context.inputs[4].cdr(),this.pushContext(),this.evaluate(t,new List([o]))}else{if(this.context.inputs.length-2===e.length())return void this.returnValueToParentContext(new List(this.context.inputs.slice(2)));o=e.at(this.context.inputs.length-1),this.pushContext(),this.evaluate(t,new List([o]))}},Process.prototype.doForEach=function(t,e,o){isNil(this.context.inputs[3])&&(this.context.inputs[3]=1);var i=this.context.inputs[3];this.context.outerContext.variables.addVar(t),this.context.outerContext.variables.setVar(t,e.at(i)),i>e.length()||(this.context.inputs[3]+=1,this.pushContext("doYield"),this.pushContext(),this.evaluate(o,new List,!0))},Process.prototype.doWait=function(t){if(this.context.startTime||(this.context.startTime=Date.now()),Date.now()-this.context.startTime>=1e3*t)return this.isAtomic||0!==t||(this.readyToYield=!0),null;this.pushContext("doYield"),this.pushContext()},Process.prototype.doGlide=function(t,e,o){if(this.context.startTime||(this.context.startTime=Date.now(),this.context.startValue=new Point(this.blockReceiver().xPosition(),this.blockReceiver().yPosition())),Date.now()-this.context.startTime>=1e3*t)return this.blockReceiver().gotoXY(e,o),null;this.blockReceiver().glide(1e3*t,e,o,Date.now()-this.context.startTime,this.context.startValue),this.pushContext("doYield"),this.pushContext()},Process.prototype.doSayFor=function(t,e){if(this.context.startTime||(this.context.startTime=Date.now(),this.blockReceiver().bubble(t)),Date.now()-this.context.startTime>=1e3*e)return this.blockReceiver().stopTalking(),null;this.pushContext("doYield"),this.pushContext()},Process.prototype.doThinkFor=function(t,e){if(this.context.startTime||(this.context.startTime=Date.now(),this.blockReceiver().doThink(t)),Date.now()-this.context.startTime>=1e3*e)return this.blockReceiver().stopTalking(),null;this.pushContext("doYield"),this.pushContext()},Process.prototype.blockReceiver=function(){return this.context&&this.context.receiver||this.homeContext.receiver},Process.prototype.doPlaySoundUntilDone=function(t){var e=this.blockReceiver();if(null===this.context.activeAudio&&(this.context.activeAudio=e.playSound(t)),this.context.activeAudio.ended||this.context.activeAudio.terminated)return null;this.pushContext("doYield"),this.pushContext()},Process.prototype.doStopAllSounds=function(){var t=this.homeContext.receiver.parentThatIsA(StageMorph);t&&(t.threads.processes.forEach(function(t){t.context&&(t.context.stopMusic(),t.context.activeAudio&&t.popContext())}),t.stopAllActiveSounds())},Process.prototype.doPlaySoundAtRate=function(e,t){var o,i,r,n,s,a,h;if(e instanceof List)i=e;else{if(!(o=e instanceof Sound?e:"number"==typeof e?this.blockReceiver().sounds.at(e):detect(this.blockReceiver().sounds.asArray(),function(t){return t.name===e.toString()})).audioBuffer)return void this.decodeSound(o);i=this.reportGetSoundAttribute("samples",o)}return r=(h=this.blockReceiver()).audioContext(),n=h.getGainNode(),s=h.getPannerNode(),a=this.encodeSound(i,t),h.setVolume(h.volume),a.connect(n),s?(n.connect(s),s.connect(r.destination),h.setPan(h.pan)):n.connect(r.destination),a.pause=a.stop,a.ended=!1,a.onended=function(){this.ended=!0},a.start(),h.parentThatIsA(StageMorph).activeSounds.push(a),a},Process.prototype.reportGetSoundAttribute=function(t,e){var r=e instanceof Sound?e:"number"==typeof e?this.blockReceiver().sounds.at(e):e instanceof List?this.encodeSound(e):detect(this.blockReceiver().sounds.asArray(),function(t){return t.name===e.toString()}),o=this.inputOption(t);if("name"===o)return r.name;if(r.audioBuffer)switch(o){case"samples":return r.cachedSamples||(r.cachedSamples=function(t){var e,o,i=r.audioBuffer;if(1<i.numberOfChannels){for(e=new List,o=0;o<i.numberOfChannels;o+=1)e.add(new List(i.getChannelData(o)));return e}return new List(i.getChannelData(0))}()),r.cachedSamples;case"sample rate":return r.audioBuffer.sampleRate;case"duration":return r.audioBuffer.duration;case"length":return r.audioBuffer.length;case"number of channels":return r.audioBuffer.numberOfChannels;default:return 0}else this.decodeSound(r)},Process.prototype.decodeSound=function(e,t){var o,i,r,n,s,a,h,l=this;if(e.audioBuffer)return(t||nop)(e);if(!e.isDecoding){for(o=e.audio.src.split(",")[1],r=(i=window.atob(o)).length,n=new Uint8Array(r),s=0;s<r;s+=1)n[s]=i.charCodeAt(s);a=n.buffer,h=Note.prototype.getAudioContext(),e.isDecoding=!0,h.decodeAudioData(a,function(t){e.audioBuffer=t,e.isDecoding=!1},function(t){e.isDecoding=!1,l.handleError(t)})}this.pushContext("doYield"),this.pushContext()},Process.prototype.encodeSound=function(t,e){var i,o,r=this.blockReceiver().audioContext(),n=t.at(1)instanceof List?t.length():1,s=1===n?t.length():t.at(1).length(),a=r.createBuffer(n,s,+e||44100);if(a.copyToChannel||(a.copyToChannel=function(t,e){var o=this.getChannelData(e);for(i=0;i<t.length;i+=1)o[i]=t[i]}),1===n)a.copyToChannel(Float32Array.from(t.asArray()),0,0);else for(i=0;i<n;i+=1)a.copyToChannel(Float32Array.from(t.at(i+1).asArray()),i,0);return(o=r.createBufferSource()).buffer=a,o.audioBuffer=o.buffer,o},Process.prototype.reportAudio=function(t){var e=this.blockReceiver().parentThatIsA(StageMorph),o=this.inputOption(t);if("resolution"===o)return e.microphone.binSize();if("modifier"===o)return e.microphone.modifier;if(e.microphone.isOn())switch(o){case"volume":return 100*e.microphone.volume;case"frequency":return e.microphone.pitch;case"note":return e.microphone.note;case"samples":return new List(e.microphone.signals);case"sample rate":return e.microphone.audioContext.sampleRate;case"output":return new List(e.microphone.output);case"spectrum":return new List(e.microphone.frequencies);default:return null}this.pushContext("doYield"),this.pushContext()},Process.prototype.setMicrophoneModifier=function(t){var e=this.blockReceiver().parentThatIsA(StageMorph);if(!t||contains(["sprite","stage","list","costume","sound","number","text","Boolean"],this.reportTypeOf(t)))return e.microphone.modifier=null,void e.microphone.stop();e.microphone.modifier=t,e.microphone.compiledModifier=this.reportCompiled(t,1),e.microphone.compilerProcess=this},Process.prototype.doAsk=function(t){var e=this.homeContext.receiver.parentThatIsA(StageMorph),o=this.blockReceiver(),i=o instanceof StageMorph,r=o instanceof SpriteMorph&&!o.isVisible;if(e.keysPressed={},this.prompter){if(this.prompter.isDone)return e.lastAnswer=this.prompter.inputField.getValue(),this.prompter.destroy(),this.prompter=null,i||o.stopTalking(),null}else detect(e.children,function(t){return t instanceof StagePrompterMorph})||(i||r||o.bubble(t,!1,!0),this.prompter=new StagePrompterMorph(i||r?t:null),e.scale<1?this.prompter.setWidth(e.width()-10):this.prompter.setWidth(e.dimensions.x-20),this.prompter.fixLayout(),this.prompter.setCenter(e.center()),this.prompter.setBottom(e.bottom()-this.prompter.border),e.add(this.prompter),this.prompter.inputField.edit(),e.changed());this.pushContext("doYield"),this.pushContext()},Process.prototype.reportLastAnswer=function(){return this.homeContext.receiver.parentThatIsA(StageMorph).lastAnswer},Process.prototype.reportURL=function(t){var e;if(this.httpRequest){if(4===this.httpRequest.readyState)return e=this.httpRequest.responseText,this.httpRequest=null,e}else/^https?:\/\//.test(t)||(t="http://"+t),console.log("url is",t),this.httpRequest=new XMLHttpRequest,this.httpRequest.open("GET",t,!0),this.httpRequest.send(null);this.pushContext("doYield"),this.pushContext()},Process.prototype.doBroadcast=function(t){var e,o,i,r=this.homeContext.receiver.parentThatIsA(StageMorph),n=t,s=this,a=[],h=[];if(t instanceof List&&2===t.length())if(e=this.blockReceiver(),n=t.at(1),isSnapObject(o=t.at(2)))i=[o];else if(isString(o))i=o===r.name?[r]:[this.getOtherObject(o,e,r)];else{if(!(o instanceof List))return;i=o.itemsArray().map(function(t){return s.getOtherObject(t,e,r)})}else i=r.children.concat(r);return""!==n&&(r.lastMessage=t,i.forEach(function(t){isSnapObject(t)&&(a=a.concat(t.allHatBlocksFor(n)))}),a.forEach(function(t){h.push(r.threads.startProcess(t,r.isThreadSafe))})),h},Process.prototype.doBroadcastAndWait=function(t){if(this.context.activeSends||(this.context.activeSends=this.doBroadcast(t)),this.context.activeSends=this.context.activeSends.filter(function(t){return t.isRunning()}),0===this.context.activeSends.length)return null;this.pushContext("doYield"),this.pushContext()},Process.prototype.getLastMessage=function(){var t;return this.homeContext.receiver&&(t=this.homeContext.receiver.parentThatIsA(StageMorph))?t.getLastMessage():""},Process.prototype.reportIsA=function(t,e){return this.reportTypeOf(t)===this.inputOption(e)},Process.prototype.assertType=function(t,e){var o=this.reportTypeOf(t);if(o===e)return!0;if(e instanceof Array&&contains(e,o))return!0;throw new Error("expecting "+e+" but getting "+o)},Process.prototype.assertAlive=function(t){if(t&&t.isCorpse)throw new Error("cannot operate on a deleted sprite")},Process.prototype.reportTypeOf=function(t){var e;return null==t?"nothing":!0===t||!1===t?"Boolean":isNaN(+t)?isString(t)?"text":t instanceof List?"list":t instanceof SpriteMorph?"sprite":t instanceof StageMorph?"stage":t instanceof Context?t.expression instanceof RingMorph?t.expression.dataType():t.expression instanceof ReporterBlockMorph?t.expression.isPredicate?"predicate":"reporter":t.expression instanceof Array?(e=t.expression[t.pc||0]).isPredicate?"predicate":e instanceof RingMorph?e.dataType():e instanceof ReporterBlockMorph?"reporter":e instanceof CommandBlockMorph?"command":"reporter":t.expression instanceof CommandBlockMorph?"command":"reporter":"undefined":"number"},Process.prototype.reportSum=function(t,e){return+t+ +e},Process.prototype.reportDifference=function(t,e){return+t-+e},Process.prototype.reportProduct=function(t,e){return+t*+e},Process.prototype.reportQuotient=function(t,e){return+t/+e},Process.prototype.reportPower=function(t,e){return Math.pow(+t,+e)},Process.prototype.reportModulus=function(t,e){var o=+e;return(+t%o+o)%o},Process.prototype.reportRandom=function(t,e){var o=+t,i=+e;return o%1!=0||i%1!=0?Math.random()*(i-o)+o:Math.floor(Math.random()*(i-o+1))+o},Process.prototype.reportLessThan=function(t,e){var o=+t,i=+e;return(isNaN(o)||isNaN(i))&&(o=t,i=e),o<i},Process.prototype.reportNot=function(t){return!t},Process.prototype.reportGreaterThan=function(t,e){var o=+t,i=+e;return(isNaN(o)||isNaN(i))&&(o=t,i=e),i<o},Process.prototype.reportEquals=function(t,e){return snapEquals(t,e)},Process.prototype.reportIsIdentical=function(t,e){var o="idTag";if(this.isImmutable(t)||this.isImmutable(e))return snapEquals(t,e);function i(){Object.prototype.hasOwnProperty.call(t,o)&&delete t[o],Object.prototype.hasOwnProperty.call(e,o)&&delete e[o]}return i(),t[o]=Date.now(),e[o]===t[o]?(i(),!0):(i(),!1)},Process.prototype.isImmutable=function(t){var e=this.reportTypeOf(t);return"nothing"===e||"Boolean"===e||"text"===e||"number"===e||"undefined"===e},Process.prototype.reportBoolean=function(t){return t},Process.prototype.reportRound=function(t){return Math.round(+t)},Process.prototype.reportMonadic=function(t,e){var o=+e,i=0;switch(this.inputOption(t)){case"abs":i=Math.abs(o);break;case"ceiling":i=Math.ceil(o);break;case"floor":i=Math.floor(o);break;case"sqrt":i=Math.sqrt(o);break;case"sin":i=Math.sin(radians(o));break;case"cos":i=Math.cos(radians(o));break;case"tan":i=Math.tan(radians(o));break;case"asin":i=degrees(Math.asin(o));break;case"acos":i=degrees(Math.acos(o));break;case"atan":i=degrees(Math.atan(o));break;case"ln":i=Math.log(o);break;case"log":i=Math.log(o)/Math.LN10;break;case"e^":i=Math.exp(o);break;case"10^":i=Math.pow(10,o);break;default:nop()}return i},Process.prototype.reportTextFunction=function(t,e){var o=(isNil(e)?"":e).toString(),i="";switch(this.inputOption(t)){case"encode URI":i=encodeURI(o);break;case"decode URI":i=decodeURI(o);break;case"encode URI component":i=encodeURIComponent(o);break;case"decode URI component":i=decodeURIComponent(o);break;case"XML escape":i=(new XML_Element).escape(o);break;case"XML unescape":i=(new XML_Element).unescape(o);break;case"hex sha512 hash":i=hex_sha512(o);break;default:nop()}return i},Process.prototype.reportJoin=function(t,e){var o=(isNil(t)?"":t).toString(),i=(isNil(e)?"":e).toString();return o.concat(i)},Process.prototype.reportJoinWords=function(t){return t instanceof List?t.asText():(t||"").toString()},Process.prototype.reportLetter=function(t,e){if(e instanceof List)return"";var o=+(t||0);return(isNil(e)?"":e.toString())[o-1]||""},Process.prototype.reportStringSize=function(t){return t instanceof List?t.length():isNil(t)?0:t.toString().length},Process.prototype.reportUnicode=function(t){var e=(t||"").toString()[0];return e?e.charCodeAt(0):0},Process.prototype.reportUnicodeAsLetter=function(t){var e=+(t||0);return String.fromCharCode(e)},Process.prototype.reportTextSplit=function(t,e){var o,i,r=["text","number"],n=this.reportTypeOf(t),s=this.reportTypeOf(this.inputOption(e));if(!contains(r,n))throw new Error("expecting text instead of a "+n);if(!contains(r,s))throw new Error("expecting a text delimiter instead of a "+s);switch(o=isNil(t)?"":t.toString(),this.inputOption(e)){case"line":i=/\r\n|[\n\v\f\r\x85\u2028\u2029]/;break;case"tab":i="\t";break;case"cr":i="\r";break;case"whitespace":o=o.trim(),i=/\s+/;break;case"letter":i="";break;default:i=isNil(e)?"":e.toString()}return new List(o.split(i))},Process.prototype.reportTextSplit=function(t,e){var o,i,r=["text","number"],n=this.reportTypeOf(t),s=this.reportTypeOf(this.inputOption(e));if(!contains(r,n))throw new Error("expecting text instead of a "+n);if(!contains(r,s))throw new Error("expecting a text delimiter instead of a "+s);switch(o=isNil(t)?"":t.toString(),this.inputOption(e)){case"line":i=/\r\n|[\n\v\f\r\x85\u2028\u2029]/;break;case"tab":i="\t";break;case"cr":i="\r";break;case"word":case"whitespace":o=o.trim(),i=/\s+/;break;case"letter":i="";break;case"csv":return this.parseCSV(t);case"json":return this.parseJSON(t);default:i=isNil(e)?"":e.toString()}return new List(o.split(i))},Process.prototype.parseCSV=function(t){return this.rawParseCSV(t,this.guessDelimiterCSV(t))},Process.prototype.guessDelimiterCSV=function(t){var e,o=[",",";","|","\t"],i=o.length,r=t.split("\n")[0];for(e=0;e<i;e+=1)if(1<this.rawParseCSV(r,o[e]).length())return o[e];return o[0]},Process.prototype.rawParseCSV=function(t,e){var o,i,r="",n=[""],s=[n],a=0,h=0,l=!0,p=t.length;for(e=e||",",o=0;o<p;o+=1)'"'===(i=t[o])?(l&&i===r&&(n[a]+=i),l=!l):i===e&&l?(i="",n[a+=1]=i):"\r"===i&&l?(s[h+=1]=[""],n=s[h],a=0):"\n"===i&&l?"\r"!==r&&(s[h+=1]=[""],n=s[h],a=0):n[a]+=i,r=i;return 1===s[s.length-1].length&&""===s[s.length-1][0]&&s.pop(),1===(s=new List(s.map(function(t){return new List(t)}))).length()?s.at(1):s},Process.prototype.parseJSON=function(t){return function e(o){return o instanceof Array?new List(o.map(function(t){return e(t)})):o instanceof Object?new List(Object.keys(o).map(function(t){return new List([t,e(o[t])])})):o}(JSON.parse(t))},Process.prototype.alert=function(t){this.homeContext.receiver&&this.homeContext.receiver.world().isDevMode&&alert("Snap! "+t.asArray())},Process.prototype.log=function(t){this.homeContext.receiver&&this.homeContext.receiver.world().isDevMode&&console.log("Snap! "+t.asArray())},Process.prototype.getOtherObject=function(e,t,o){if(isSnapObject(e))return e;var i=isNil(o)?t.parentThatIsA(StageMorph):o,r=null;return i&&((r=detect(i.children,function(t){return t.name===e}))||(r=detect(i.world().hand.children,function(t){return t instanceof SpriteMorph&&t.name===e}))),r},Process.prototype.getObjectsNamed=function(e,t,o){var i=isNil(o)?t.parentThatIsA(StageMorph):o,r=[];function n(t){return t instanceof SpriteMorph&&t.isClone?t.cloneOriginName===e:t.name===e}return i&&((r=i.children.filter(n)).length||(r=i.world().hand.children.filter(n))),r},Process.prototype.doFaceTowards=function(t){var e,o=this.blockReceiver();o&&("mouse-pointer"===this.inputOption(t)?o.faceToXY(this.reportMouseX(),this.reportMouseY()):(e=this.getOtherObject(t,this.homeContext.receiver))&&o.faceToXY(e.xPosition(),e.yPosition()))},Process.prototype.doGotoObject=function(t){var e,o=this.blockReceiver();o&&("mouse-pointer"===this.inputOption(t)?o.gotoXY(this.reportMouseX(),this.reportMouseY()):(e=this.getOtherObject(t,this.homeContext.receiver))&&o.gotoXY(e.xPosition(),e.yPosition()))},Process.prototype.createClone=function(t){var e,o=this.blockReceiver();t&&o&&("myself"===this.inputOption(t)?o.createClone(!this.isFirstStep):(e=this.getOtherObject(t,o))&&e.createClone(!this.isFirstStep))},Process.prototype.reportTouchingObject=function(t){var e=this.blockReceiver();return!!e&&this.objectTouchingObject(e,t)},Process.prototype.objectTouchingObject=function(e,o){var t,i,r,n=this;if("mouse-pointer"===this.inputOption(o)){if(r=e.world().hand.position(),e.bounds.containsPoint(r)&&!e.isTransparentAt(r))return!0}else if(t=e.parentThatIsA(StageMorph)){if("edge"===this.inputOption(o)&&(i=e.bounds,!e.costume&&e.penBounds&&(i=e.penBounds.translateBy(e.position())),!t.bounds.containsRectangle(i)))return!0;if("pen trails"===this.inputOption(o)&&e.isTouching(t.penTrailsMorph()))return!0;if(isSnapObject(o))return e.isTouching(o);if((o instanceof List?o.itemsArray():this.getObjectsNamed(o,e,t)).some(function(t){return e.isTouching(t)}))return!0}return e.parts.some(function(t){return n.objectTouchingObject(t,o)})},Process.prototype.reportTouchingColor=function(e){var o,t=this.blockReceiver();return!(!t||!(o=t.parentThatIsA(StageMorph)))&&(!!t.isTouching(o.colorFiltered(e,t))||t.parts.some(function(t){return t.isTouching(o.colorFiltered(e,t))}))},Process.prototype.reportColorIsTouchingColor=function(e,o){var i,t=this.blockReceiver();return!(!t||!(i=t.parentThatIsA(StageMorph)))&&(!!t.colorFiltered(e).isTouching(i.colorFiltered(o,t))||t.parts.some(function(t){return t.colorFiltered(e).isTouching(i.colorFiltered(o,t))}))},Process.prototype.reportDistanceTo=function(t){var e,o,i,r,n=this.blockReceiver();return n?(r=i=n.rotationCenter(),"mouse-pointer"===this.inputOption(t)&&(r=n.world().hand.position()),o=n.parentThatIsA(StageMorph),(e=this.getOtherObject(t,n,o))&&(r=e.rotationCenter()),i.distanceTo(r)/o.scale):0},Process.prototype.reportAttributeOf=function(t,e){var o,i,r=this.blockReceiver();if(r&&(this.assertAlive(r),o=(i=r.parentThatIsA(StageMorph)).name===e?i:this.getOtherObject(e,r,i))){if(this.assertAlive(o),t instanceof Context)return this.reportContextFor(t,o);if(isString(t))return o.variables.getVar(t);switch(this.inputOption(t)){case"x position":return o.xPosition?o.xPosition():"";case"y position":return o.yPosition?o.yPosition():"";case"direction":return o.direction?o.direction():"";case"costume #":return o.getCostumeIdx();case"costume name":return o.costume?o.costume.name:localize(o instanceof SpriteMorph?"Turtle":"Empty");case"size":return o.getScale?o.getScale():""}}return""},Process.prototype.reportGet=function(t){var e,o,i,r=this.blockReceiver();if(r)switch(this.inputOption(t)){case"self":return r;case"other sprites":return o=r.parentThatIsA(StageMorph),new List(o.children.filter(function(t){return t instanceof SpriteMorph&&t!==r}));case"parts":return new List(r.parts||[]);case"anchor":return r.anchor||"";case"parent":return r.exemplar||"";case"children":return new List(r.specimens?r.specimens():[]);case"clones":return o=r.parentThatIsA(StageMorph),i=r.name||r.cloneOriginName,new List(o.children.filter(function(t){return t.isClone&&t!==r&&t.cloneOriginName===i}));case"other clones":return r.isClone?this.reportGet(["clones"]):new List;case"neighbors":return o=r.parentThatIsA(StageMorph),e=r.bounds.expandBy(new Point(r.width(),r.height())),new List(o.children.filter(function(t){return t instanceof SpriteMorph&&t!==r&&t.bounds.intersects(e)}));case"dangling?":return!r.rotatesWithAnchor;case"rotation x":return r.xPosition();case"rotation y":return r.yPosition();case"center x":return r.xCenter();case"center y":return r.yCenter();case"name":return r.name;case"stage":return r.parentThatIsA(StageMorph)}return""},Process.prototype.doSet=function(t,e){var o,i;if(t instanceof Context){if(i=this.blockReceiver(),this.assertAlive(i),!(t instanceof Context)||"reportGet"!==t.expression.selector)throw new Error(localize("unsupported attribute"));switch((o=t.expression.inputs()[0].evaluate())instanceof Array&&(o=o[0]),o){case"anchor":if(this.assertType(i,"sprite"),e instanceof SpriteMorph){if(!i.enableNesting||contains(i.allParts(),e))throw new Error(localize("unable to nest\n(disabled or circular?)"));e.attachPart(i)}else i.detachFromAnchor();break;case"parent":this.assertType(i,"sprite"),e=e instanceof SpriteMorph?e:null,i.setExemplar(e);break;case"dangling?":this.assertType(i,"sprite"),this.assertType(e,"Boolean"),i.rotatesWithAnchor=!e,i.version=Date.now();break;case"rotation x":this.assertType(i,"sprite"),this.assertType(e,"number"),i.setRotationX(e);break;case"rotation y":this.assertType(i,"sprite"),this.assertType(e,"number"),i.setRotationY(e);break;default:throw new Error('"'+localize(o)+'" '+localize("is read-only"))}}},Process.prototype.reportContextFor=function(t,e){var o=copy(t);return o.receiver=e,o.outerContext&&(o.outerContext=copy(o.outerContext),o.outerContext.variables=copy(o.outerContext.variables),o.outerContext.receiver=e,o.outerContext.variables.parentFrame=e.variables),o},Process.prototype.reportMouseX=function(){var t,e;return this.homeContext.receiver&&(t=this.homeContext.receiver.parentThatIsA(StageMorph))&&(e=t.world())?(e.hand.position().x-t.center().x)/t.scale:0},Process.prototype.reportMouseY=function(){var t,e;return this.homeContext.receiver&&(t=this.homeContext.receiver.parentThatIsA(StageMorph))&&(e=t.world())?(t.center().y-e.hand.position().y)/t.scale:0},Process.prototype.reportMouseDown=function(){var t;return!(!this.homeContext.receiver||!(t=this.homeContext.receiver.world()))&&"left"===t.hand.mouseButton},Process.prototype.reportKeyPressed=function(t){var e;return!(!this.homeContext.receiver||!(e=this.homeContext.receiver.parentThatIsA(StageMorph)))&&("any key"===this.inputOption(t)?0<Object.keys(e.keysPressed).length:void 0!==e.keysPressed[t])},Process.prototype.doResetTimer=function(){var t;this.homeContext.receiver&&(t=this.homeContext.receiver.parentThatIsA(StageMorph))&&t.resetTimer()},Process.prototype.reportTimer=function(){var t;return this.homeContext.receiver&&(t=this.homeContext.receiver.parentThatIsA(StageMorph))?t.getTimer():0},Process.prototype.reportDate=function(t){var e,o=this.inputOption(t),i={year:"getFullYear",month:"getMonth",date:"getDate","day of week":"getDay",hour:"getHours",minute:"getMinutes",second:"getSeconds","time in milliseconds":"getTime"};return i[o]?(e=(new Date)[i[o]](),"month"!==o&&"day of week"!==o||(e+=1),e):""},Process.prototype.doSetVideoTransparency=function(t){var e;this.homeContext.receiver&&(e=this.homeContext.receiver.parentThatIsA(StageMorph))&&(e.projectionTransparency=Math.max(0,Math.min(100,t)))},Process.prototype.reportVideo=function(t,e){var o=this.blockReceiver(),i=o.parentThatIsA(StageMorph),r=this.getOtherObject(e,o,i);if(!i.projectionSource||!i.projectionSource.stream)return this.context.accumulator||(this.context.accumulator=!0,i.startVideo()),this.pushContext("doYield"),void this.pushContext();switch(this.inputOption(t)){case"motion":return r instanceof SpriteMorph?(i.videoMotion.getLocalMotion(r),r.motionAmount):(i.videoMotion.getStageMotion(),i.videoMotion.motionAmount);case"direction":return r instanceof SpriteMorph?(i.videoMotion.getLocalMotion(r),r.motionDirection):(i.videoMotion.getStageMotion(),i.videoMotion.motionDirection);case"snap":return r instanceof SpriteMorph?r.projectionSnap():i.projectionSnap()}return-1},Process.prototype.doMapCodeOrHeader=function(t,e,o){if("code"===this.inputOption(e))return this.doMapCode(t,o);if("header"===this.inputOption(e))return this.doMapHeader(t,o);throw new Error(" '"+e+"'\nis not a valid option")},Process.prototype.doMapHeader=function(t,e){if(t instanceof Context&&t.expression instanceof SyntaxElementMorph)return t.expression.mapHeader(e||"")},Process.prototype.doMapCode=function(t,e){if(t instanceof Context&&t.expression instanceof SyntaxElementMorph)return t.expression.mapCode(e||"")},Process.prototype.doMapStringCode=function(t){StageMorph.prototype.codeMappings.string=t||"<#1>"},Process.prototype.doMapListCode=function(t,e,o){var i="",r="delim";"parameters"===this.inputOption(e)?i="parms_":"variables"===this.inputOption(e)&&(i="tempvars_"),"list"===this.inputOption(t)?r="list":"item"===this.inputOption(t)&&(r="item"),StageMorph.prototype.codeMappings[i+r]=o||""},Process.prototype.reportMappedCode=function(t){return t instanceof Context&&t.expression instanceof SyntaxElementMorph?t.expression.mappedCode():""},Process.prototype.doRest=function(t){var e=this.reportTempo();this.doWait(60/e*t)},Process.prototype.reportTempo=function(){var t;return this.homeContext.receiver&&(t=this.homeContext.receiver.parentThatIsA(StageMorph))?t.getTempo():0},Process.prototype.doChangeTempo=function(t){var e;this.homeContext.receiver&&(e=this.homeContext.receiver.parentThatIsA(StageMorph))&&e.changeTempo(t)},Process.prototype.doSetTempo=function(t){var e;this.homeContext.receiver&&(e=this.homeContext.receiver.parentThatIsA(StageMorph))&&e.setTempo(t)},Process.prototype.doPlayNote=function(t,e){var o=this.reportTempo();this.doPlayNoteForSecs(parseFloat(t||"0"),60/o*parseFloat(e||"0"))},Process.prototype.doPlayNoteForSecs=function(t,e){if(this.context.startTime||(this.context.startTime=Date.now(),this.context.activeNote=new Note(t),this.context.activeNote.play()),Date.now()-this.context.startTime>=1e3*e)return this.context.activeNote&&(this.context.activeNote.stop(),this.context.activeNote=null),null;this.pushContext("doYield"),this.pushContext()},Process.prototype.inputOption=function(t){return t instanceof Array?t[0]:t},Process.prototype.pushContext=function(t,e){this.context=new Context(this.context,t,e||(this.context?this.context.outerContext:null),this.context?this.context.receiver:this.homeContext.receiver)},Process.prototype.popContext=function(){this.context&&this.context.stopMusic(),this.context=this.context?this.context.parentContext:null},Process.prototype.returnValueToParentContext=function(t){void 0!==t&&(this.context&&this.context.parentContext||this.homeContext).addInput(t)},Process.prototype.reportStackSize=function(){return this.context?this.context.stackSize():0},Process.prototype.reportFrameCount=function(){return this.frameCount},Process.prototype.flashContext=function(){var t=this.context.expression;return!(!(this.enableSingleStepping&&!this.isAtomic&&t instanceof SyntaxElementMorph)||t instanceof CommandSlotMorph||this.context.isFlashing||!t.world()||t instanceof ColorSlotMorph)&&(this.unflash(),t.flash(),this.context.isFlashing=!0,this.flashingContext=this.context,0<this.flashTime&&this.flashTime<=.5?(this.pushContext("doIdle"),this.context.addInput(this.flashTime)):this.pushContext("doInterrupt"),!0)},Process.prototype.flashPausedContext=function(){var t=this.context?this.context.lastFlashable():null;t&&(this.unflash(),t.expression.flash(),t.isFlashing=!0,this.flashingContext=t)},Process.prototype.doInterrupt=function(){this.popContext(),this.isAtomic||(this.isInterrupted=!0)},Process.prototype.doIdle=function(t){this.context.startTime||(this.context.startTime=Date.now()),Date.now()-this.context.startTime<1e3*t?this.pushContext("doInterrupt"):this.popContext()},Process.prototype.unflash=function(){this.flashingContext&&(this.flashingContext.expression.unflash(),this.flashingContext.isFlashing=!1,this.flashingContext=null)},Process.prototype.reportCompiled=function(t,e){return new JSCompiler(this).compileFunction(t,e)},Process.prototype.capture=function(t){var e=new Process(this.topBlock,this.receiver),o=new Context(t.parentContext,t.expression,t.outerContext,t.receiver);return o.variables=t.variables.fullCopy(),o.variables.root().parentFrame=e.variables,e.context=o,e},Process.prototype.getVarNamed=function(t){var e,o=this.homeContext.variables.silentFind(t)||this.context.variables.silentFind(t);if(o)return 0===(e=o.vars[t].value)?0:!1!==e&&(""===e?"":e||0);throw new Error(localize("a variable of name '")+t+localize("'\ndoes not exist in this context"))},Process.prototype.setVarNamed=function(t,e){var o=this.homeContext.variables.silentFind(t)||this.context.variables.silentFind(t);if(isNil(o))throw new Error(localize("a variable of name '")+t+localize("'\ndoes not exist in this context"));o.vars[t].value=e},Process.prototype.incrementVarNamed=function(t,e){this.setVarNamed(t,this.getVarNamed(t)+ +e)},Process.prototype.reportAtomicMap=function(e,t){this.assertType(t,"list");var o,i,r,n=[],s=t.asArray(),a=s.length,h=e.inputs.length;try{i=this.reportCompiled(e,1)}catch(t){console.log(t.message),i=e}for(r=0;r<a;r+=1)o=[s[r]],1<h&&o.push(r+1),2<h&&o.push(t),n.push(invoke(i,new List(o),null,null,null,null,this.capture(e)));return new List(n)},Process.prototype.reportAtomicKeep=function(e,t){this.assertType(t,"list");var o,i,r,n=[],s=t.asArray(),a=s.length,h=e.inputs.length;try{i=this.reportCompiled(e,1)}catch(t){console.log(t.message),i=e}for(r=0;r<a;r+=1)o=[s[r]],1<h&&o.push(r+1),2<h&&o.push(t),invoke(i,new List(o),null,null,null,null,this.capture(e))&&n.push(s[r]);return new List(n)},Process.prototype.reportAtomicFindFirst=function(e,t){this.assertType(t,"list");var o,i,r,n=t.asArray(),s=n.length,a=e.inputs.length;try{i=this.reportCompiled(e,1)}catch(t){console.log(t.message),i=e}for(r=0;r<s;r+=1)if(o=[n[r]],1<a&&o.push(r+1),2<a&&o.push(t),invoke(i,new List(o),null,null,null,null,this.capture(e)))return n[r];return!1},Process.prototype.reportAtomicCombine=function(t,e){this.assertType(t,"list");var o,i,r,n="",s=t.asArray(),a=s.length,h=e.inputs.length;if(0===a)return n;n=s[0];try{i=this.reportCompiled(e,2)}catch(t){console.log(t.message),i=e}for(r=1;r<a;r+=1)o=[n,s[r]],2<h&&o.push(r+1),3<h&&o.push(t),n=invoke(i,new List(o),null,null,null,null,this.capture(e));return n},Process.prototype.reportAtomicSort=function(t,o){this.assertType(t,"list");var i,r=this;try{i=this.reportCompiled(o,2)}catch(t){console.log(t.message),i=o}return new List(t.asArray().slice().sort(function(t,e){return invoke(i,new List([t,e]),null,null,null,null,r.capture(o))?-1:1}))},Process.prototype.reportAtomicGroup=function(t,e){this.assertType(t,"list");var o,i,r,n=[],s=new Map,a=t.asArray(),h=a.length;try{i=this.reportCompiled(e,1)}catch(t){console.log(t.message),i=e}for(r=0;r<h;r+=1)o=invoke(i,new List([a[r]]),null,null,null,null,this.capture(e)),s.has(o)?s.get(o).push(a[r]):s.set(o,[a[r]]);return s.forEach(function(t,e){n.push(new List([e,t.length,new List(t)]))}),new List(n)},Context.prototype.toString=function(){var t=this.expression;return t instanceof Array&&0<t.length&&(t="["+t[0]+"]"),"Context >> "+t+" "+this.variables},Context.prototype.image=function(){var t,e,o=new RingMorph;return this.expression instanceof Morph?(t=this.expression.fullCopy(),this.isContinuation&&(e=detect(t.allInputs(),function(t){return 1===t.bindingID}))&&t.revertToDefaultInput(e,!0),o.embed(t,this.inputs),o.fullImage()):this.expression instanceof Array?(t=this.expression[this.pc].fullCopy())instanceof RingMorph&&!t.contents()?t.fullImage():(o.embed(t,this.isContinuation?[]:this.inputs),o.fullImage()):(o.color=SpriteMorph.prototype.blockColor.other,o.setSpec("%rc %ringparms"),this.isContinuation||this.inputs.forEach(function(t){o.parts()[1].addInput(t)}),o.fullImage())},Context.prototype.continuation=function(){var t;if(this.expression instanceof Array)t=this;else{if(!this.parentContext)return(t=new Context(null,"expectReport")).isContinuation=!0,t;t=this.parentContext}return(t=t.copyForContinuation()).tag=null,t.isContinuation=!0,t},Context.prototype.copyForContinuation=function(){var t=copy(this),e=t;if(!(this.expression instanceof Array||isString(this.expression)))for(e.prepareContinuationForBinding();e.parentContext;)e.parentContext=copy(e.parentContext),(e=e.parentContext).inputs=[];return t},Context.prototype.copyForContinuationCall=function(){var t=copy(this),e=t;if(!(this.expression instanceof Array||isString(this.expression)))for(this.expression=this.expression.fullCopy(),this.inputs=[];e.parentContext;)e.parentContext=copy(e.parentContext),(e=e.parentContext).inputs=[];return t},Context.prototype.prepareContinuationForBinding=function(){var t,e=this.inputs.length;this.expression=this.expression.fullCopy(),(t=this.expression.inputs()[e])&&(this.inputs=[],t.bindingID=1,this.emptySlots=1)},Context.prototype.addInput=function(t){this.inputs.push(t)},Context.prototype.stopMusic=function(){this.activeNote&&(this.activeNote.stop(),this.activeNote=null)},Context.prototype.lastFlashable=function(){return this.expression instanceof SyntaxElementMorph&&!(this.expression instanceof CommandSlotMorph)?this:this.parentContext?this.parentContext.lastFlashable():null},Context.prototype.stackSize=function(){return this.parentContext?1+this.parentContext.stackSize():1},Variable.prototype.toString=function(){return this.isTransient,"transient "},Variable.prototype.copy=function(){return new Variable(this.value,this.isTransient)},VariableFrame.prototype.toString=function(){return"a VariableFrame {"+this.names()+"}"},VariableFrame.prototype.copy=function(){var e=new VariableFrame(this.parentFrame),o=this;return this.names().forEach(function(t){e.addVar(t,o.getVar(t))}),e},VariableFrame.prototype.fullCopy=function(){var t;return(t=this.parentFrame?new VariableFrame(this.parentFrame.fullCopy()):new VariableFrame).vars=copy(this.vars),t},VariableFrame.prototype.root=function(){return this.parentFrame?this.parentFrame.root():this},VariableFrame.prototype.find=function(t){var e=this.silentFind(t);if(e)return e;throw new Error(localize("a variable of name '")+t+localize("'\ndoes not exist in this context"))},VariableFrame.prototype.silentFind=function(t){return void 0!==this.vars[t]?this:this.parentFrame?this.parentFrame.silentFind(t):null},VariableFrame.prototype.setVar=function(t,e,o){var i=this.find(t);i&&(o instanceof SpriteMorph&&i.owner instanceof SpriteMorph&&o!==i.owner?o.shadowVar(t,e):i.vars[t].value=e)},VariableFrame.prototype.changeVar=function(t,e,o){var i,r,n=this.find(t);n&&(i=parseFloat(n.vars[t].value),r=isNaN(i)?e:i+parseFloat(e),o instanceof SpriteMorph&&n.owner instanceof SpriteMorph&&o!==n.owner?o.shadowVar(t,r):n.vars[t].value=r)},VariableFrame.prototype.getVar=function(t){var e,o=this.silentFind(t);if(o)return 0===(e=o.vars[t].value)?0:!1!==e&&(""===e?"":e||0);if("number"==typeof t)return"";throw new Error(localize("a variable of name '")+t+localize("'\ndoes not exist in this context"))},VariableFrame.prototype.addVar=function(t,e){this.vars[t]=new Variable(0===e?0:!1!==e&&(""===e?"":e||0))},VariableFrame.prototype.deleteVar=function(t){var e=this.find(t);e&&delete e.vars[t]},VariableFrame.prototype.names=function(){var t,e=[];for(t in this.vars)Object.prototype.hasOwnProperty.call(this.vars,t)&&e.push(t);return e},VariableFrame.prototype.allNamesDict=function(){var t={},e=this;function o(t,e){var o;for(o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=o)}for(;e;)o(e.vars,t),e=e.parentFrame;return t},VariableFrame.prototype.allNames=function(){var t,e=[],o=this.allNamesDict();for(t in o)Object.prototype.hasOwnProperty.call(o,t)&&e.push(t);return e},JSCompiler.prototype.toString=function(){return"a JSCompiler"},JSCompiler.prototype.compileFunction=function(t,e){var o,i,r=t.expression,n=t.inputs,s=[],a=this;if(this.source=t,this.implicitParams=e||1,o=!isNil(detect(r.allChildren(),function(t){return t.isEmptySlot&&t.isEmptySlot()})),this.gensyms={},this.paramCount=0,n.length){if(o)throw new Error("compiling does not yet support\nmixing explicit formal parameters\nwith empty input slots");n.forEach(function(t,e){var o="p"+e;s.push(o),a.gensyms[t]=o})}else if(o)if(1<this.implicitParams)for(i=0;i<this.implicitParams;i+=1)s.push("p"+i);else s=["p0"];return r instanceof CommandBlockMorph?Function.apply(null,s.concat([this.compileSequence(r)])):Function.apply(null,s.concat(["return "+this.compileExpression(r)]))},JSCompiler.prototype.compileExpression=function(t){var e,o,i,r=t.selector,n=t.inputs();switch(r){case"reportOr":return this.compileInfix("||",n);case"reportAnd":return this.compileInfix("&&",n);case"reportIfElse":return"("+this.compileInput(n[0])+" ? "+this.compileInput(n[1])+" : "+this.compileInput(n[2])+")";case"evaluateCustomBlock":throw new Error("compiling does not yet support\ncustom blocks");case"doSetVar":return"arguments[arguments.length - 1].setVarNamed("+this.compileInput(n[0])+","+this.compileInput(n[1])+")";case"doChangeVar":return"arguments[arguments.length - 1].incrementVarNamed("+this.compileInput(n[0])+","+this.compileInput(n[1])+")";case"doReport":return"return "+this.compileInput(n[0]);case"doIf":return"if ("+this.compileInput(n[0])+") {\n"+this.compileSequence(n[1].evaluate())+"}";case"doIfElse":return"if ("+this.compileInput(n[0])+") {\n"+this.compileSequence(n[1].evaluate())+"} else {\n"+this.compileSequence(n[2].evaluate())+"}";default:return o=(e=this.process[r]?this.process:this.source.receiver||this.process.receiver).constructor.name+".prototype",i=this.compileInputs(n),isSnapObject(e)?o+"."+r+".apply("+o+", ["+i+"])":"arguments[arguments.length - 1]."+r+".apply(arguments[arguments.length - 1], ["+i+"])"}},JSCompiler.prototype.compileSequence=function(t){var e="",o=this;return t.blockSequence().forEach(function(t){e+=o.compileExpression(t),e+=";\n"}),e},JSCompiler.prototype.compileInfix=function(t,e){return"("+this.compileInput(e[0])+" "+t+" "+this.compileInput(e[1])+")"},JSCompiler.prototype.compileInputs=function(t){var e="",o=this;return t.forEach(function(t){e.length&&(e+=", "),e+=o.compileInput(t)}),e},JSCompiler.prototype.compileInput=function(t){var e,o;if(t.isEmptySlot&&t.isEmptySlot()){if(1<this.implicitParams){if(this.paramCount<this.implicitParams)return this.paramCount+=1,"p"+(this.paramCount-1);throw new Error(localize("expecting")+" "+this.implicitParams+" "+localize("input(s), but getting")+" "+this.paramCount)}return"p0"}if(t instanceof MultiArgMorph)return"new List(["+this.compileInputs(t.inputs())+"])";if(t instanceof ArgLabelMorph)return this.compileInput(t.argMorph());if(!(t instanceof ArgMorph)){if(t instanceof BlockMorph)return"reportGetVar"===t.selector?contains(this.source.inputs,t.blockSpec)?this.gensyms[t.blockSpec]:'arguments[arguments.length - 1].getVarNamed("'+t.blockSpec+'")':this.compileExpression(t);throw new Error("compiling does not yet support\ninput slots of type\n"+t.constructor.name)}switch(e=t.evaluate(),o=this.process.reportTypeOf(e)){case"number":case"Boolean":return""+e;case"text":return'"'+e+'"';case"list":return"new List(["+this.compileInputs(e)+"])";default:if(e instanceof Array)return'"'+e[0]+'"';throw new Error("compiling does not yet support\ninputs of type\n"+o)}},modules.objects="2017-January-13",SpriteMorph.prototype=new PenMorph,SpriteMorph.prototype.constructor=SpriteMorph,SpriteMorph.uber=PenMorph.prototype,SpriteMorph.prototype.categories=["motion","control","looks","sensing","sound","operators","pen","variables","lists","other"],SpriteMorph.prototype.blockColor={motion:new Color(74,108,212),looks:new Color(143,86,227),sound:new Color(207,74,217),pen:new Color(0,161,120),control:new Color(230,168,34),sensing:new Color(4,148,220),operators:new Color(98,194,19),variables:new Color(243,118,29),lists:new Color(217,77,17),other:new Color(150,150,150)},SpriteMorph.prototype.paletteColor=new Color(55,55,55),SpriteMorph.prototype.paletteTextColor=new Color(230,230,230),SpriteMorph.prototype.sliderColor=SpriteMorph.prototype.paletteColor.lighter(30),SpriteMorph.prototype.isCachingPrimitives=!0,SpriteMorph.prototype.enableNesting=!0,SpriteMorph.prototype.enableFirstClass=!0,SpriteMorph.prototype.useFlatLineEnds=!1,SpriteMorph.prototype.highlightColor=new Color(250,200,130),SpriteMorph.prototype.highlightBorder=8,SpriteMorph.prototype.bubbleColor=new Color(255,255,255),SpriteMorph.prototype.bubbleFontSize=14,SpriteMorph.prototype.bubbleFontIsBold=!0,SpriteMorph.prototype.bubbleCorner=10,SpriteMorph.prototype.bubbleBorder=3,SpriteMorph.prototype.bubbleBorderColor=new Color(190,190,190),SpriteMorph.prototype.bubbleMaxTextWidth=130,SpriteMorph.prototype.initBlocks=function(){SpriteMorph.prototype.blocks={forward:{only:SpriteMorph,type:"command",category:"motion",spec:"move %n steps",defaults:[10]},turn:{only:SpriteMorph,type:"command",category:"motion",spec:"turn %clockwise %n degrees",defaults:[15]},turnLeft:{only:SpriteMorph,type:"command",category:"motion",spec:"turn %counterclockwise %n degrees",defaults:[15]},setHeading:{only:SpriteMorph,type:"command",category:"motion",spec:"point in direction %dir"},doFaceTowards:{only:SpriteMorph,type:"command",category:"motion",spec:"point towards %dst"},gotoXY:{only:SpriteMorph,type:"command",category:"motion",spec:"go to x: %n y: %n",defaults:[0,0]},doGotoObject:{only:SpriteMorph,type:"command",category:"motion",spec:"go to %dst"},doGlide:{only:SpriteMorph,type:"command",category:"motion",spec:"glide %n secs to x: %n y: %n",defaults:[1,0,0]},changeXPosition:{only:SpriteMorph,type:"command",category:"motion",spec:"change x by %n",defaults:[10]},setXPosition:{only:SpriteMorph,type:"command",category:"motion",spec:"set x to %n",defaults:[0]},changeYPosition:{only:SpriteMorph,type:"command",category:"motion",spec:"change y by %n",defaults:[10]},setYPosition:{only:SpriteMorph,type:"command",category:"motion",spec:"set y to %n",defaults:[0]},bounceOffEdge:{only:SpriteMorph,type:"command",category:"motion",spec:"if on edge, bounce"},xPosition:{only:SpriteMorph,type:"reporter",category:"motion",spec:"x position"},yPosition:{only:SpriteMorph,type:"reporter",category:"motion",spec:"y position"},direction:{only:SpriteMorph,type:"reporter",category:"motion",spec:"direction"},doSwitchToCostume:{type:"command",category:"looks",spec:"switch to costume %cst"},doWearNextCostume:{type:"command",category:"looks",spec:"next costume"},getCostumeIdx:{type:"reporter",category:"looks",spec:"costume #"},doSayFor:{only:SpriteMorph,type:"command",category:"looks",spec:"say %s for %n secs",defaults:[localize("Hello!"),2]},bubble:{only:SpriteMorph,type:"command",category:"looks",spec:"say %s",defaults:[localize("Hello!")]},doThinkFor:{only:SpriteMorph,type:"command",category:"looks",spec:"think %s for %n secs",defaults:[localize("Hmm..."),2]},doThink:{only:SpriteMorph,type:"command",category:"looks",spec:"think %s",defaults:[localize("Hmm...")]},changeEffect:{type:"command",category:"looks",spec:"change %eff effect by %n",defaults:[null,25]},setEffect:{type:"command",category:"looks",spec:"set %eff effect to %n",defaults:[null,0]},clearEffects:{type:"command",category:"looks",spec:"clear graphic effects"},changeScale:{only:SpriteMorph,type:"command",category:"looks",spec:"change size by %n",defaults:[10]},setScale:{only:SpriteMorph,type:"command",category:"looks",spec:"set size to %n %",defaults:[100]},getScale:{only:SpriteMorph,type:"reporter",category:"looks",spec:"size"},show:{only:SpriteMorph,type:"command",category:"looks",spec:"show"},hide:{only:SpriteMorph,type:"command",category:"looks",spec:"hide"},comeToFront:{only:SpriteMorph,type:"command",category:"looks",spec:"go to front"},goBack:{only:SpriteMorph,type:"command",category:"looks",spec:"go back %n layers",defaults:[1]},reportCostumes:{dev:!0,type:"reporter",category:"looks",spec:"wardrobe"},alert:{dev:!0,type:"command",category:"looks",spec:"alert %mult%s"},log:{dev:!0,type:"command",category:"looks",spec:"console log %mult%s"},playSound:{type:"command",category:"sound",spec:"play sound %snd"},doPlaySoundUntilDone:{type:"command",category:"sound",spec:"play sound %snd until done"},doStopAllSounds:{type:"command",category:"sound",spec:"stop all sounds"},doRest:{type:"command",category:"sound",spec:"rest for %n beats",defaults:[.2]},doPlayNote:{type:"command",category:"sound",spec:"play note %n for %n beats",defaults:[60,.5]},doChangeTempo:{type:"command",category:"sound",spec:"change tempo by %n",defaults:[20]},doSetTempo:{type:"command",category:"sound",spec:"set tempo to %n bpm",defaults:[60]},getTempo:{type:"reporter",category:"sound",spec:"tempo"},reportSounds:{dev:!0,type:"reporter",category:"sound",spec:"jukebox"},clear:{type:"command",category:"pen",spec:"clear"},down:{only:SpriteMorph,type:"command",category:"pen",spec:"pen down"},up:{only:SpriteMorph,type:"command",category:"pen",spec:"pen up"},setColor:{only:SpriteMorph,type:"command",category:"pen",spec:"set pen color to %clr"},changeHue:{only:SpriteMorph,type:"command",category:"pen",spec:"change pen color by %n",defaults:[10]},setHue:{only:SpriteMorph,type:"command",category:"pen",spec:"set pen color to %n",defaults:[0]},changeBrightness:{only:SpriteMorph,type:"command",category:"pen",spec:"change pen shade by %n",defaults:[10]},setBrightness:{only:SpriteMorph,type:"command",category:"pen",spec:"set pen shade to %n",defaults:[100]},changeSize:{only:SpriteMorph,type:"command",category:"pen",spec:"change pen size by %n",defaults:[1]},setSize:{only:SpriteMorph,type:"command",category:"pen",spec:"set pen size to %n",defaults:[1]},doStamp:{only:SpriteMorph,type:"command",category:"pen",spec:"stamp"},floodFill:{only:SpriteMorph,type:"command",category:"pen",spec:"fill"},receiveGo:{type:"hat",category:"control",spec:"when %greenflag clicked"},receiveKey:{type:"hat",category:"control",spec:"when %keyHat key pressed"},receiveInteraction:{type:"hat",category:"control",spec:"when I am %interaction",defaults:["clicked"]},receiveMessage:{type:"hat",category:"control",spec:"when I receive %msgHat"},receiveCondition:{type:"hat",category:"control",spec:"when %b"},doBroadcast:{type:"command",category:"control",spec:"broadcast %msg"},doBroadcastAndWait:{type:"command",category:"control",spec:"broadcast %msg and wait"},getLastMessage:{type:"reporter",category:"control",spec:"message"},doWait:{type:"command",category:"control",spec:"wait %n secs",defaults:[1]},doWaitUntil:{type:"command",category:"control",spec:"wait until %b"},doForever:{type:"command",category:"control",spec:"forever %c"},doRepeat:{type:"command",category:"control",spec:"repeat %n %c",defaults:[10]},doUntil:{type:"command",category:"control",spec:"repeat until %b %c"},doIf:{type:"command",category:"control",spec:"if %b %c"},doIfElse:{type:"command",category:"control",spec:"if %b %c else %c"},doStopThis:{type:"command",category:"control",spec:"stop %stopChoices"},doStopOthers:{type:"command",category:"control",spec:"stop %stopOthersChoices"},doRun:{type:"command",category:"control",spec:"run %cmdRing %inputs"},fork:{type:"command",category:"control",spec:"launch %cmdRing %inputs"},evaluate:{type:"reporter",category:"control",spec:"call %repRing %inputs"},doReport:{type:"command",category:"control",spec:"report %s"},doCallCC:{type:"command",category:"control",spec:"run %cmdRing w/continuation"},reportCallCC:{type:"reporter",category:"control",spec:"call %cmdRing w/continuation"},doWarp:{type:"command",category:"other",spec:"warp %c"},receiveOnClone:{type:"hat",category:"control",spec:"when I start as a clone"},createClone:{type:"command",category:"control",spec:"create a clone of %cln"},removeClone:{type:"command",category:"control",spec:"delete this clone"},doPauseAll:{type:"command",category:"control",spec:"pause all %pause"},reportTouchingObject:{only:SpriteMorph,type:"predicate",category:"sensing",spec:"touching %col ?"},reportTouchingColor:{only:SpriteMorph,type:"predicate",category:"sensing",spec:"touching %clr ?"},reportColorIsTouchingColor:{only:SpriteMorph,type:"predicate",category:"sensing",spec:"color %clr is touching %clr ?"},colorFiltered:{dev:!0,type:"reporter",category:"sensing",spec:"filtered for %clr"},reportStackSize:{dev:!0,type:"reporter",category:"sensing",spec:"stack size"},reportFrameCount:{dev:!0,type:"reporter",category:"sensing",spec:"frames"},reportThreadCount:{dev:!0,type:"reporter",category:"sensing",spec:"processes"},doAsk:{type:"command",category:"sensing",spec:"ask %s and wait",defaults:[localize("what's your name?")]},reportLastAnswer:{dev:!0,type:"reporter",category:"sensing",spec:"answer"},getLastAnswer:{type:"reporter",category:"sensing",spec:"answer"},reportMouseX:{type:"reporter",category:"sensing",spec:"mouse x"},reportMouseY:{type:"reporter",category:"sensing",spec:"mouse y"},reportMouseDown:{type:"predicate",category:"sensing",spec:"mouse down?"},reportKeyPressed:{type:"predicate",category:"sensing",spec:"key %key pressed?"},reportDistanceTo:{type:"reporter",category:"sensing",spec:"distance to %dst"},doResetTimer:{type:"command",category:"sensing",spec:"reset timer"},reportTimer:{dev:!0,type:"reporter",category:"sensing",spec:"timer"},getTimer:{type:"reporter",category:"sensing",spec:"timer"},reportAttributeOf:{type:"reporter",category:"sensing",spec:"%att of %spr",defaults:[["costume #"]]},reportURL:{type:"reporter",category:"sensing",spec:"url %s",defaults:["snap.berkeley.edu"]},doSetGlobalFlag:{type:"command",category:"sensing",spec:"set %setting to %b",defaults:[["video capture"]]},reportGlobalFlag:{type:"predicate",category:"sensing",spec:"is %setting on?",defaults:[["turbo mode"]]},reportDate:{type:"reporter",category:"sensing",spec:"current %dates"},reportGet:{type:"reporter",category:"sensing",spec:"my %get",defaults:[["neighbors"]]},reportAudio:{type:"reporter",category:"sensing",spec:"microphone %audio",defaults:[["volume"]]},reifyScript:{type:"ring",category:"other",spec:"%rc %ringparms",alias:"command ring lambda"},reifyReporter:{type:"ring",category:"other",spec:"%rr %ringparms",alias:"reporter ring lambda"},reifyPredicate:{type:"ring",category:"other",spec:"%rp %ringparms",alias:"predicate ring lambda"},reportSum:{type:"reporter",category:"operators",spec:"%n + %n"},reportDifference:{type:"reporter",category:"operators",spec:"%n − %n",alias:"-"},reportProduct:{type:"reporter",category:"operators",spec:"%n × %n",alias:"*"},reportQuotient:{type:"reporter",category:"operators",spec:"%n / %n"},reportRound:{type:"reporter",category:"operators",spec:"round %n"},reportMonadic:{type:"reporter",category:"operators",spec:"%fun of %n",defaults:[null,10]},reportPower:{type:"reporter",category:"operators",spec:"%n ^ %n"},reportModulus:{type:"reporter",category:"operators",spec:"%n mod %n"},reportRandom:{type:"reporter",category:"operators",spec:"pick random %n to %n",defaults:[1,10]},reportLessThan:{type:"predicate",category:"operators",spec:"%s < %s"},reportEquals:{type:"predicate",category:"operators",spec:"%s = %s"},reportGreaterThan:{type:"predicate",category:"operators",spec:"%s > %s"},reportAnd:{type:"predicate",category:"operators",spec:"%b and %b"},reportOr:{type:"predicate",category:"operators",spec:"%b or %b"},reportNot:{type:"predicate",category:"operators",spec:"not %b"},reportBoolean:{type:"predicate",category:"operators",spec:"%bool",alias:"true boolean"},reportFalse:{type:"predicate",category:"operators",spec:"%bool",defaults:[!1],alias:"false boolean"},reportJoinWords:{type:"reporter",category:"operators",spec:"join %words",defaults:[localize("hello")+" ",localize("world")]},reportLetter:{type:"reporter",category:"operators",spec:"letter %n of %s",defaults:[1,localize("world")]},reportStringSize:{type:"reporter",category:"operators",spec:"length of %s",defaults:[localize("world")]},reportUnicode:{type:"reporter",category:"operators",spec:"unicode of %s",defaults:["a"]},reportUnicodeAsLetter:{type:"reporter",category:"operators",spec:"unicode %n as letter",defaults:[65]},reportIsA:{type:"predicate",category:"operators",spec:"is %s a %typ ?",defaults:[5]},reportIsIdentical:{type:"predicate",category:"operators",spec:"is %s identical to %s ?"},reportTextSplit:{type:"reporter",category:"operators",spec:"split %s by %delim",defaults:[localize("hello")+" "+localize("world")," "]},reportJSFunction:{type:"reporter",category:"operators",spec:"JavaScript function ( %mult%s ) { %code }"},reportTypeOf:{dev:!0,type:"reporter",category:"operators",spec:"type of %s",defaults:[5]},reportTextFunction:{dev:!0,type:"reporter",category:"operators",spec:"%txtfun of %s",defaults:[null,"Abelson & Sussman"]},doSetVar:{type:"command",category:"variables",spec:"set %var to %s",defaults:[null,0]},doChangeVar:{type:"command",category:"variables",spec:"change %var by %n",defaults:[null,1]},doShowVar:{type:"command",category:"variables",spec:"show variable %var"},doHideVar:{type:"command",category:"variables",spec:"hide variable %var"},doDeclareVariables:{type:"command",category:"other",spec:"script variables %scriptVars"},doDeleteAttr:{type:"command",category:"variables",spec:"delete %shd"},reportNewList:{type:"reporter",category:"lists",spec:"list %exp"},reportCONS:{type:"reporter",category:"lists",spec:"%s in front of %l"},reportListItem:{type:"reporter",category:"lists",spec:"item %idx of %l",defaults:[1]},reportCDR:{type:"reporter",category:"lists",spec:"all but first of %l"},reportListLength:{type:"reporter",category:"lists",spec:"length of %l"},reportListContainsItem:{type:"predicate",category:"lists",spec:"%l contains %s",defaults:[null,localize("thing")]},doAddToList:{type:"command",category:"lists",spec:"add %s to %l",defaults:[localize("thing")]},doDeleteFromList:{type:"command",category:"lists",spec:"delete %ida of %l",defaults:[1]},doInsertInList:{type:"command",category:"lists",spec:"insert %s at %idx of %l",defaults:[localize("thing"),1]},doReplaceInList:{type:"command",category:"lists",spec:"replace item %idx of %l with %s",defaults:[1,null,localize("thing")]},reportMap:{dev:!0,type:"reporter",category:"lists",spec:"map %repRing over %l"},doForEach:{dev:!0,type:"command",category:"lists",spec:"for %upvar in %l %cl",defaults:[localize("each item")]},doShowTable:{dev:!0,type:"command",category:"lists",spec:"show table %l"},doMapCodeOrHeader:{type:"command",category:"other",spec:"map %cmdRing to %codeKind %code"},doMapStringCode:{type:"command",category:"other",spec:"map String to code %code",defaults:["<#1>"]},doMapListCode:{type:"command",category:"other",spec:"map %codeListPart of %codeListKind to code %code"},reportMappedCode:{type:"reporter",category:"other",spec:"code of %cmdRing"},doSetVideoTransparency:{type:"command",category:"sensing",spec:"set video transparency to %n",defaults:[50]},reportVideo:{type:"reporter",category:"sensing",spec:"video %vid on %self",defaults:[["motion"],["myself"]]}}},SpriteMorph.prototype.initBlocks(),SpriteMorph.prototype.initBlockMigrations=function(){SpriteMorph.prototype.blockMigrations={doStopAll:{selector:"doStopThis",inputs:[["all"]]},doStop:{selector:"doStopThis",inputs:[["this script"]]},doStopBlock:{selector:"doStopThis",inputs:[["this block"]]},receiveClick:{selector:"receiveInteraction",inputs:[["clicked"]]},reportTrue:{selector:"reportBoolean",inputs:[!0]},reportFalse:{selector:"reportBoolean",inputs:[!1]},reportIsFastTracking:{selector:"reportGlobalFlag",inputs:[["turbo mode"]],offset:1},doSetFastTracking:{selector:"doSetGlobalFlag",inputs:[["turbo mode"]],offset:1}}},SpriteMorph.prototype.initBlockMigrations(),SpriteMorph.prototype.blockAlternatives={turn:["turnLeft"],turnLeft:["turn"],changeXPosition:["changeYPosition","setXPosition","setYPosition"],setXPosition:["setYPosition","changeXPosition","changeYPosition"],changeYPosition:["changeXPosition","setYPosition","setXPosition"],setYPosition:["setXPosition","changeYPosition","changeXPosition"],xPosition:["yPosition"],yPosition:["xPosition"],doSayFor:["doThinkFor","bubble","doThink","doAsk"],doThinkFor:["doSayFor","doThink","bubble","doAsk"],bubble:["doThink","doAsk","doSayFor","doThinkFor"],doThink:["bubble","doAsk","doSayFor","doThinkFor"],show:["hide"],hide:["show"],changeEffect:["setEffect"],setEffect:["changeEffect"],changeScale:["setScale"],setScale:["changeScale"],playSound:["doPlaySoundUntilDone"],doPlaySoundUntilDone:["playSound"],doChangeTempo:["doSetTempo"],doSetTempo:["doChangeTempo"],clear:["down","up","doStamp"],down:["up","clear","doStamp"],up:["down","clear","doStamp"],doStamp:["clear","down","up"],changeHue:["setHue","changeBrightness","setBrightness"],setHue:["changeHue","changeBrightness","setBrightness"],changeBrightness:["setBrightness","setHue","changeHue"],setBrightness:["changeBrightness","setHue","changeHue"],changeSize:["setSize"],setSize:["changeSize"],doBroadcast:["doBroadcastAndWait"],doBroadcastAndWait:["doBroadcast"],doIf:["doIfElse","doUntil"],doIfElse:["doIf","doUntil"],doRepeat:["doUntil"],doUntil:["doRepeat","doIf"],doAsk:["bubble","doThink","doSayFor","doThinkFor"],getLastAnswer:["getTimer"],getTimer:["getLastAnswer"],reportMouseX:["reportMouseY"],reportMouseY:["reportMouseX"],reportSum:["reportDifference","reportProduct","reportQuotient","reportPower","reportModulus"],reportDifference:["reportSum","reportProduct","reportQuotient","reportPower","reportModulus"],reportProduct:["reportDifference","reportSum","reportQuotient","reportPower","reportModulus"],reportQuotient:["reportDifference","reportProduct","reportSum","reportPower","reportModulus"],reportPower:["reportDifference","reportProduct","reportSum","reportQuotient","reportModulus"],reportModulus:["reportDifference","reportProduct","reportSum","reportQuotient","reportPower"],reportLessThan:["reportEquals","reportGreaterThan"],reportEquals:["reportLessThan","reportGreaterThan"],reportGreaterThan:["reportEquals","reportLessThan"],reportAnd:["reportOr"],reportOr:["reportAnd"],doSetVar:["doChangeVar"],doChangeVar:["doSetVar"],doShowVar:["doHideVar"],doHideVar:["doShowVar"]},SpriteMorph.prototype.init=function(t){this.name=localize("Sprite"),this.variables=new VariableFrame(t||null,this),this.scripts=new ScriptsMorph(this),this.customBlocks=[],this.costumes=new List,this.costume=null,this.sounds=new List,this.normalExtent=new Point(60,60),this.scale=1,this.rotationStyle=1,this.version=Date.now(),this.isClone=!1,this.isCorpse=!1,this.cloneOriginName="",this.parts=[],this.anchor=null,this.nestingScale=1,this.rotatesWithAnchor=!0,this.layers=null,this.blocksCache={},this.paletteCache={},this.rotationOffset=new Point,this.idx=0,this.wasWarped=!1,this.graphicsValues={color:0,fisheye:0,whirl:0,pixelate:0,mosaic:0,duplicate:0,negative:0,comic:0,confetti:0,saturation:0,brightness:0},this.exemplar=null,SpriteMorph.uber.init.call(this),this.isDraggable=!0,this.isDown=!1,this.heading=90,this.changed(),this.drawNew(),this.changed()},SpriteMorph.prototype.fullCopy=function(o){var e,t,i=SpriteMorph.uber.fullCopy.call(this),r=this,n=[];for(t in i.stopTalking(),i.color=this.color.copy(),i.blocksCache={},i.paletteCache={},i.scripts=this.scripts.fullCopy(o),(i.scripts.owner=i).variables=this.variables.copy(),(i.variables.owner=i).customBlocks=[],o||this.customBlocks.forEach(function(t){e=t.copyAndBindTo(i),i.customBlocks.push(e),i.allBlockInstances(t).forEach(function(t){t.definition=e})}),this.costumes.asArray().forEach(function(t){var e=o?t:t.copy();n.push(e),t===r.costume&&(i.costume=e)}),i.costumes=new List(n),n=[],this.sounds.asArray().forEach(function(t){var e=o?t:t.copy();n.push(e)}),i.sounds=new List(n),n=[],i.nestingScale=1,i.rotatesWithAnchor=!0,i.anchor=null,i.parts=[],this.parts.forEach(function(t){var e=t.fullCopy(o);e.nestingScale=t.nestingScale,e.rotatesWithAnchor=t.rotatesWithAnchor,i.attachPart(e)}),i.graphicsValues={},this.graphicsValues)this.graphicsValues.hasOwnProperty(t)&&(i.graphicsValues[t]=this.graphicsValues[t]);return i},SpriteMorph.prototype.appearIn=function(e){this.isClone||(this.name=e.newSpriteName(this.name),e.corral.addSprite(this),e.sprites.add(this)),e.stage.add(this),this.parts.forEach(function(t){t.appearIn(e)})},SpriteMorph.prototype.setName=function(t){this.name=t||this.name,this.version=Date.now()},SpriteMorph.prototype.drawNew=function(){var t,e,o,i,r,n,s,a,h,l,p,c,u,d,g=this,f=[];if(this.isWarped)this.wantsRedraw=!0;else{if(t=this.center(),i=this.costume&&"function"==typeof this.costume.loaded,s=this.parent instanceof StageMorph?this.parent.scale:1,e=this.rotationStyle?this.heading:90,2===this.rotationStyle&&(e=90,(180<this.heading&&this.heading<360||this.heading<0&&-180<this.heading)&&(o=!0)),this.costume&&!i)f=(n=o?this.costume.flipped():this.costume).bounds().corners().map(function(t){return t.rotateBy(radians(e-90),g.costume.center())}),h=f[0],p=f[0],f.forEach(function(t){h=h.min(t),p=p.max(t)}),c=h.corner(p).extent().multiplyBy(this.scale*s),l=new Point(0,0).rotateBy(radians(-(e-90)),n.center()).subtract(h),this.image=newCanvas(c,!0),this.silentSetExtent(c),(u=this.image.getContext("2d")).scale(this.scale*s,this.scale*s),u.translate(l.x,l.y),u.rotate(radians(e-90)),u.drawImage(n.contents,0,0),this.image=this.applyGraphicsEffects(this.image),this.setCenter(t,!0),this.rotationOffset=l.translateBy(n.rotationCenter).rotateBy(radians(-(e-90)),l).scaleBy(this.scale*s);else if(e=o?-90:e,a=Math.min(Math.max(this.normalExtent.x*this.scale*s,5),1e3),this.silentSetExtent(new Point(a,a)),this.image=newCanvas(this.extent(),!0),this.setCenter(t,!0),SpriteMorph.uber.drawNew.call(this,e),this.rotationOffset=this.extent().divideBy(2),this.image=this.applyGraphicsEffects(this.image),i)return r=this.costume,d=setInterval(function(){g.wearCostume(r),clearInterval(d)},100),g.wearCostume(null);this.version=Date.now()}},SpriteMorph.prototype.endWarp=function(){if(this.isWarped=!1,this.wantsRedraw){var t=this.xPosition(),e=this.yPosition();this.drawNew(),this.silentGotoXY(t,e,!0),this.wantsRedraw=!1}this.parent.changed()},SpriteMorph.prototype.rotationCenter=function(){return this.position().add(this.rotationOffset)},SpriteMorph.prototype.colorFiltered=function(t){var e,o,i,r,n=new Morph,s=this.extent();for(o=normalizeCanvas(this.image,!0).getContext("2d").getImageData(0,0,s.x,s.y),n.image=newCanvas(s,!0),n.bounds=this.bounds.copy(),r=(e=n.image.getContext("2d")).createImageData(s.x,s.y),i=0;i<s.x*s.y*4;i+=4)new Color(o.data[i],o.data[i+1],o.data[i+2]).eq(t)&&(r.data[i]=o.data[i],r.data[i+1]=o.data[i+1],r.data[i+2]=o.data[i+2],r.data[i+3]=255);return e.putImageData(r,0,0),n},SpriteMorph.prototype.blockForSelector=function(t,e){var o,i,r,n,s,a;if(o=this.blockMigrations[t],!(i=this.blocks[o?o.selector:t]))return null;if((r="command"===i.type?new CommandBlockMorph:"hat"===i.type?new HatBlockMorph:"ring"===i.type?new RingMorph:new ReporterBlockMorph("predicate"===i.type)).color=this.blockColor[i.category],r.category=i.category,r.selector=o?o.selector:t,contains(["reifyReporter","reifyPredicate"],r.selector)&&(r.isStatic=!0),r.setSpec(localize(i.spec)),e&&i.defaults||o&&o.inputs)if(n=o?o.inputs:i.defaults,r.defaults=n,(s=r.inputs())[0]instanceof MultiArgMorph)s[0].setContents(n),s[0].defaults=n;else for(a=0;a<n.length;a+=1)null!==n[a]&&s[a].setContents(n[a]);return r},SpriteMorph.prototype.variableBlock=function(t){var e=new ReporterBlockMorph(!1);return e.selector="reportGetVar",e.color=this.blockColor.variables,e.category="variables",e.setSpec(t),e.isDraggable=!0,e},SpriteMorph.prototype.blockTemplates=function(t){var e,o,i,r=[],n=this,s=t||"motion",a=this.inheritedVariableNames();function h(t){if(StageMorph.prototype.hiddenPrimitives[t])return null;var e=SpriteMorph.prototype.blockForSelector(t,!0);return e.isTemplate=!0,e}function l(t){if(StageMorph.prototype.hiddenPrimitives[t])return null;var e=SpriteMorph.prototype.blocks[t];return new ToggleMorph("checkbox",this,function(){n.toggleWatcher(t,localize(e.spec),n.blockColor[e.category])},null,function(){return n.showingWatcher(t)},null)}function p(){var t=new MenuMorph(this);return t.addItem("help...","showHelp"),t}function c(t){t&&(n.isVariableNameInUse(t[0],t[1])?n.inform("that name is already in use"):SnapActions.addVariable(t[0],t[1]||n.id))}function u(t){SnapActions.deleteVariable(t,n.id)}function d(t){var e=n.parentThatIsA(StageMorph);t.fields=t.fields.filter(function(t){return!!t}),e.messageTypes.getMsgType(t.name)?n.inform("that name is already in use"):SnapActions.addMessageType(t.name,t.fields)}return"motion"===s?(r.push(h("forward")),r.push(h("turn")),r.push(h("turnLeft")),r.push("-"),r.push(h("setHeading")),r.push(h("doFaceTowards")),r.push("-"),r.push(h("gotoXY")),r.push(h("doGotoObject")),r.push(h("doGlide")),r.push("-"),r.push(h("changeXPosition")),r.push(h("setXPosition")),r.push(h("changeYPosition")),r.push(h("setYPosition")),r.push("-"),r.push(h("bounceOffEdge")),r.push("-"),r.push(l("xPosition")),r.push(h("xPosition")),r.push(l("yPosition")),r.push(h("yPosition")),r.push(l("direction")),r.push(h("direction"))):"looks"===s?(r.push(h("doSwitchToCostume")),r.push(h("doWearNextCostume")),r.push(l("getCostumeIdx")),r.push(h("getCostumeIdx")),r.push("-"),r.push(h("doSayFor")),r.push(h("bubble")),r.push(h("doThinkFor")),r.push(h("doThink")),r.push("-"),r.push(h("changeEffect")),r.push(h("setEffect")),r.push(h("clearEffects")),r.push("-"),r.push(h("changeScale")),r.push(h("setScale")),r.push(l("getScale")),r.push(h("getScale")),r.push("-"),r.push(h("show")),r.push(h("hide")),r.push("-"),r.push(h("comeToFront")),r.push(h("goBack")),this.world().isDevMode&&(r.push("-"),(i=new TextMorph(localize("development mode \ndebugging primitives:"))).fontSize=9,i.setColor(this.paletteTextColor),r.push(i),r.push("-"),r.push(h("reportCostumes")),r.push("-"),r.push(h("log")),r.push(h("alert")))):"sound"===s?(r.push(h("playSound")),r.push(h("doPlaySoundUntilDone")),r.push(h("doStopAllSounds")),r.push("-"),r.push(h("doRest")),r.push("-"),r.push(h("doPlayNote")),r.push("-"),r.push(h("doChangeTempo")),r.push(h("doSetTempo")),r.push(l("getTempo")),r.push(h("getTempo")),this.world().isDevMode&&(r.push("-"),(i=new TextMorph(localize("development mode \ndebugging primitives:"))).fontSize=9,i.setColor(this.paletteTextColor),r.push(i),r.push("-"),r.push(h("reportSounds")))):"pen"===s?(r.push(h("clear")),r.push("-"),r.push(h("down")),r.push(h("up")),r.push("-"),r.push(h("setColor")),r.push(h("changeHue")),r.push(h("setHue")),r.push("-"),r.push(h("changeBrightness")),r.push(h("setBrightness")),r.push("-"),r.push(h("changeSize")),r.push(h("setSize")),r.push("-"),r.push(h("doStamp")),r.push(h("floodFill"))):"network"===s?(r.push(h("receiveSocketMessage")),r.push(h("doSocketMessage")),r.push("-"),r.push(h("doSocketRequest")),r.push(h("doSocketResponse")),r.push("-"),r.push(h("getJSFromRPCStruct")),r.push(h("doRunRPC")),r.push(l("reportRPCError")),r.push(h("reportRPCError")),r.push("-"),r.push(h("getProjectIds")),r.push(h("getProjectId")),o=new PushButtonMorph(null,function(){new MessageCreatorMorph(n,d).popUp()},"Make a message type"),r.push(o),0<this.deletableMessageNames().length&&((o=new PushButtonMorph(null,function(){var e=new MenuMorph(function(t){SnapActions.deleteMessageType(t)},null);n.deletableMessageNames().forEach(function(t){e.addItem(t,t)}),e.popUpAtHand(n.world())},"Delete a message type")).userMenu=p,o.selector="deleteMessageType",o.showHelp=BlockMorph.prototype.showHelp,r.push(o))):"control"===s?(r.push(h("receiveGo")),r.push(h("receiveKey")),r.push(h("receiveInteraction")),r.push(h("receiveCondition")),r.push(h("receiveMessage")),r.push("-"),r.push(h("doBroadcast")),r.push(h("doBroadcastAndWait")),r.push(l("getLastMessage")),r.push(h("getLastMessage")),r.push("-"),r.push(h("doWarp")),r.push("-"),r.push(h("doWait")),r.push(h("doWaitUntil")),r.push("-"),r.push(h("doForever")),r.push(h("doRepeat")),r.push(h("doUntil")),r.push("-"),r.push(h("doIf")),r.push(h("doIfElse")),r.push("-"),r.push(h("doReport")),r.push("-"),r.push(h("doStopThis")),r.push(h("doStopOthers")),r.push("-"),r.push(h("doRun")),r.push(h("fork")),r.push(h("evaluate")),r.push("-"),r.push(h("doCallCC")),r.push(h("reportCallCC")),r.push("-"),r.push(h("receiveOnClone")),r.push(h("createClone")),r.push(h("removeClone")),r.push("-"),r.push(h("doPauseAll"))):"sensing"===s?(r.push(h("reportTouchingObject")),r.push(h("reportTouchingColor")),r.push(h("reportColorIsTouchingColor")),r.push("-"),r.push(h("doAsk")),r.push(l("getLastAnswer")),r.push(h("getLastAnswer")),r.push("-"),r.push(l("reportMouseX")),r.push(h("reportMouseX")),r.push(l("reportMouseY")),r.push(h("reportMouseY")),r.push(h("reportMouseDown")),r.push("-"),r.push(h("reportKeyPressed")),r.push("-"),r.push(h("reportDistanceTo")),r.push("-"),r.push(h("doResetTimer")),r.push(l("getTimer")),r.push(h("getTimer")),r.push("-"),r.push(h("reportAttributeOf")),SpriteMorph.prototype.enableFirstClass&&r.push(h("reportGet")),r.push("-"),r.push(h("reportURL")),r.push(h("reportAudio")),r.push(h("reportVideo")),r.push(h("doSetVideoTransparency")),r.push("-"),r.push(h("reportGlobalFlag")),r.push(h("doSetGlobalFlag")),r.push("-"),r.push(h("reportDate")),r.push(h("reportUsername")),r.push("-"),r.push(h("reportLatitude")),r.push(h("reportLongitude")),r.push("-"),r.push(h("reportStageHeight")),r.push(h("reportStageWidth")),this.world().isDevMode&&(r.push("-"),(i=new TextMorph(localize("development mode \ndebugging primitives:"))).fontSize=9,i.setColor(this.paletteTextColor),r.push(i),r.push("-"),r.push(l("reportThreadCount")),r.push(h("reportThreadCount")),r.push(h("colorFiltered")),r.push(h("reportStackSize")),r.push(h("reportFrameCount")))):"operators"===s?(r.push(h("reifyScript")),r.push(h("reifyReporter")),r.push(h("reifyPredicate")),r.push("#"),r.push("-"),r.push(h("reportSum")),r.push(h("reportDifference")),r.push(h("reportProduct")),r.push(h("reportQuotient")),r.push(h("reportPower")),r.push("-"),r.push(h("reportModulus")),r.push(h("reportRound")),r.push(h("reportMonadic")),r.push(h("reportRandom")),r.push("-"),r.push(h("reportLessThan")),r.push(h("reportEquals")),r.push(h("reportGreaterThan")),r.push("-"),r.push(h("reportAnd")),r.push(h("reportOr")),r.push(h("reportNot")),r.push(h("reportBoolean")),r.push("-"),r.push(h("reportJoinWords")),r.push(h("reportTextSplit")),r.push(h("reportLetter")),r.push(h("reportStringSize")),r.push("-"),r.push(h("reportUnicode")),r.push(h("reportUnicodeAsLetter")),r.push("-"),r.push(h("reportIsA")),r.push(h("reportIsIdentical")),r.push("-"),r.push(h("reportJSFunction")),this.world().isDevMode&&(r.push("-"),(i=new TextMorph(localize("development mode \ndebugging primitives:"))).fontSize=9,i.setColor(this.paletteTextColor),r.push(i),r.push("-"),r.push(h("reportTypeOf")),r.push(h("reportTextFunction")))):"variables"===s?((o=new PushButtonMorph(null,function(){new VariableDialogMorph(null,c,n).prompt("Variable name",null,n.world())},"Make a variable")).userMenu=p,o.selector="addVariable",o.showHelp=BlockMorph.prototype.showHelp,r.push(o),0<this.deletableVariableNames().length&&((o=new PushButtonMorph(null,function(){var e=new MenuMorph(u,null,n);n.deletableVariableNames().forEach(function(t){e.addItem(t,t)}),e.popUpAtHand(n.world())},"Delete a variable")).userMenu=p,o.selector="deleteVariable",o.showHelp=BlockMorph.prototype.showHelp,r.push(o)),r.push("-"),0<(e=this.variables.allNames()).length&&(e.forEach(function(t){var e,o;r.push(function(t){return new ToggleMorph("checkbox",this,function(){n.toggleVariableWatcher(t)},null,function(){return n.showingVariableWatcher(t)},null)}(t)),r.push((e=t,(o=SpriteMorph.prototype.variableBlock(e)).isDraggable=!1,o.isTemplate=!0,contains(a,e)&&o.ghost(),o))}),r.push("-")),r.push(h("doSetVar")),r.push(h("doChangeVar")),r.push(h("doShowVar")),r.push(h("doHideVar")),r.push(h("doDeclareVariables")),StageMorph.prototype.enableInheritance&&(r.push("-"),r.push(h("doDeleteAttr"))),r.push("="),r.push(h("reportNewList")),r.push("-"),r.push(h("reportCONS")),r.push(h("reportListItem")),r.push(h("reportCDR")),r.push("-"),r.push(h("reportListLength")),r.push(h("reportListContainsItem")),r.push("-"),r.push(h("doAddToList")),r.push(h("doDeleteFromList")),r.push(h("doInsertInList")),r.push(h("doReplaceInList")),this.world().isDevMode&&(r.push("-"),(i=new TextMorph(localize("development mode \ndebugging primitives:"))).fontSize=9,i.setColor(this.paletteTextColor),r.push(i),r.push("-"),r.push(h("reportMap")),r.push("-"),r.push(h("doForEach")),r.push(h("doShowTable"))),r.push("="),StageMorph.prototype.enableCodeMapping&&(r.push(h("doMapCodeOrHeader")),r.push(h("doMapStringCode")),r.push(h("doMapListCode")),r.push("-"),r.push(h("reportMappedCode")),r.push("=")),(o=new PushButtonMorph(null,function(){n.parentThatIsA(IDE_Morph),n.parentThatIsA(StageMorph);new BlockDialogMorph(null,function(t){""!==t.spec&&SnapActions.addCustomBlock(t,n).then(function(t){new BlockEditorMorph(t,n).popUp()})},n).prompt("Make a block",null,n.world())},"Make a block")).userMenu=p,o.selector="addCustomBlock",o.showHelp=BlockMorph.prototype.showHelp,r.push(o)):"custom"===s&&((o=new PushButtonMorph(null,function(){new BlockDialogMorph(null,function(t){""!==t.spec&&SnapActions.addCustomBlock(t,n).then(function(t){new BlockEditorMorph(t,n).popUp()})},n).prompt("Make a block",null,n.world())},"Make a block")).userMenu=p,o.selector="addCustomBlock",o.showHelp=BlockMorph.prototype.showHelp,r.push(o)),r},SpriteMorph.prototype.palette=function(t){return this.paletteCache[t]||(this.paletteCache[t]=this.freshPalette(t)),this.paletteCache[t]},SpriteMorph.prototype.freshPalette=function(h){var t,l=new ScrollFrameMorph(null,null,this.sliderColor),o=SyntaxElementMorph.prototype.fontSize,i=0,r=5,e=0,n=!1,p=this,s=this.parentThatIsA(StageMorph),a=Morph.prototype.trackChanges;return Morph.prototype.trackChanges=!1,l.owner=this,l.padding=o/2,l.color=this.paletteColor,l.growth=new Point(0,MorphicPreferences.scrollBarSize),l.userMenu=function(){var e,t,o=new MenuMorph,i=this.parentThatIsA(IDE_Morph),r={operators:["reifyScript","reifyReporter","reifyPredicate"],control:["doWarp"],variables:["doDeclareVariables","reportNewList","reportCONS","reportListItem","reportCDR","reportListLength","reportListContainsItem","doAddToList","doDeleteFromList","doInsertInList","doReplaceInList"]};if(o.addPair("find blocks...",function(){p.searchBlocks()},"⌘F"),l.contents.children.some(function(t){return contains(Object.keys(SpriteMorph.prototype.blocks),t.selector)})&&o.addItem("hide primitives",function(){var e=SpriteMorph.prototype.blocks;Object.keys(e).forEach(function(t){e[t].category===h&&(StageMorph.prototype.hiddenPrimitives[t]=!0)}),(r[h]||[]).forEach(function(t){StageMorph.prototype.hiddenPrimitives[t]=!0}),i.flushBlocksCache(h),i.refreshPalette()}),e=SpriteMorph.prototype.blocks,t=StageMorph.prototype.hiddenPrimitives,Object.keys(t).some(function(t){return!isNil(e[t])&&(e[t].category===h||contains(r[h]||[],t))})&&o.addItem("show primitives",function(){var t=StageMorph.prototype.hiddenPrimitives,e=SpriteMorph.prototype.blocks;Object.keys(t).forEach(function(t){e[t]&&e[t].category===h&&delete StageMorph.prototype.hiddenPrimitives[t]}),(r[h]||[]).forEach(function(t){delete StageMorph.prototype.hiddenPrimitives[t]}),i.flushBlocksCache(h),i.refreshPalette()}),SnapUndo.canUndo("palette")){var n=SnapUndo.eventHistory.palette.length,s=SnapUndo.eventHistory.palette[n-1],a=i.serializer.parse(s.args[2]);o.addItem('restore "'+a.attributes.s+'"',function(){SnapUndo.undo("palette")})}return o},(t=this.blocksCache[h])||(t=p.blockTemplates(h),this.isCachingPrimitives&&(p.blocksCache[h]=t)),t.forEach(function(t){if(null!==t)if("-"===t){if(n)return;r+=.8*o,n=!0}else if("="===t){if(n)return;r+=1.6*o,n=!0}else"#"===t?(i=0,r=e):(n=!1,0===i&&(r+=.3*o),t.setPosition(new Point(i,r)),l.addContents(t),t instanceof ToggleMorph||t instanceof RingMorph?(i=t.right()+o/2,e=t.bottom()):(i=0,r+=t.height()))}),s&&(r+=1.6*o,s.globalBlocks.forEach(function(t){if("custom"===h||t.category===h){var e=t.templateInstance();r+=.3*o,e.setPosition(new Point(i,r)),l.addContents(e),i=0,r+=e.height()}})),r+=1.6*o,this.customBlocks.forEach(function(t){if("custom"===h||t.category===h){var e=t.templateInstance();r+=.3*o,e.setPosition(new Point(i,r)),l.addContents(e),i=0,r+=e.height()}}),l.scrollX(l.padding),l.scrollY(l.padding),Morph.prototype.trackChanges=a,l},SpriteMorph.prototype.blocksMatching=function(t,n,s,e){var a,o,h=[],l=this,p=t.toLowerCase(),i=this.parentThatIsA(StageMorph);function c(t){return BlockMorph.prototype.parseSpec(t).filter(function(t){return 0!==t.indexOf("%")}).join(" ")}function u(t,e){var o,i=" "+t,r=i.indexOf(e);return-1===r?-1:(o=" "===i.charAt(r-1),n&&!o?-1:(o?"1":"2")+function(t,e,o){for(var i=String(t);i.length<e;)i=o+i;return i}(r,4,"0"))}return s&&s.length||(s=["hat","command","reporter","predicate","ring"]),e||(e=[]),e.forEach(function(t){var e=u(c(t.toLowerCase()),p);-1!==e&&h.push([l.variableBlock(t),e+"1"])}),[this.customBlocks,i.globalBlocks].forEach(function(t){t.forEach(function(t){if(contains(s,t.type)){var e=u(c(localize(t.blockSpec()).toLowerCase()),p);-1!==e&&h.push([t.templateInstance(),e+"2"])}})}),a=SpriteMorph.prototype.blocks,Object.keys(a).forEach(function(t){if(!StageMorph.prototype.hiddenPrimitives[t]&&contains(s,a[t].type)&&!a[t].deprecated){var e=a[t],o=u(c(localize(e.alias||e.spec).toLowerCase()),p);-1===o||e.dev||e.only&&e.only!==l.constructor||h.push([(i=t,r=SpriteMorph.prototype.blockForSelector(i,!0),r.isTemplate=!0,r),o+"3"])}var i,r}),contains(s,"reporter")&&(o=this.reporterize(t))&&h.push([o,""]),h.sort(function(t,e){return t[1]<e[1]?-1:1}),h.map(function(t){return t[0]})},SpriteMorph.prototype.searchBlocks=function(t,i,r,n){var s,e,a=this,h=SyntaxElementMorph.prototype.fontSize,l=this.parentThatIsA(IDE_Morph),p="",c=new InputFieldMorph(t||""),u=l.createPalette("forSearch"),d=[];function g(){e&&e.destroy(),s&&n&&(e=s.outline(MorphicPreferences.isFlat?new Color(150,200,255):new Color(255,255,255),2),u.contents.add(e),e.scrollIntoView())}function f(t){var e=Morph.prototype.trackChanges,o=u.contents.left()+5,i=c.bottom()+h;s=null,(d=t).length&&n&&(s=t[0]),Morph.prototype.trackChanges=!1,u.contents.children=[u.contents.children[0]],t.forEach(function(t){t.setPosition(new Point(o,i)),u.addContents(t),i+=t.height(),i+=.3*h}),Morph.prototype.trackChanges=e,g(),u.changed()}u.mouseClickLeft=function(){16===world.currentKey&&l.prompt("Search for used blocks",function(t){if(t&&!(t.length<3)){t=t.toLowerCase(),console.log("searching with query:",t);var e,o=l.findBlocks({specs:[t]});if(console.log("found",o.length,"blocks"),o.length){var i=o.map(function(t){return l.blockAddress(t).join(" => ")}),r={};for(var n in i.forEach(function(t){r[t]=void 0===r[t]?1:r[t]+1}),e="",r)1<r[n]&&(e+="["+r[n]+"x] "),e+=n+"\n"}else e="No blocks found";l.inform("Search Results",e)}},null,"searchBlocks")},u.owner=this,u.color=a.paletteColor,u.contents.color=a.paletteColor,u.addContents(c),c.drawNew(),c.setWidth(l.logo.width()-30),c.contrast=90,c.setPosition(u.contents.topLeft().add(new Point(10,10))),c.drawNew(),u.accept=function(){var t;n?(c.cancel(),s&&n.insertBlock(s)):0<(t=c.getValue()).length&&f(a.blocksMatching(t))},u.reactToKeystroke=function(t){var e,o;switch(t?t.keyCode:0){case 38:if(!n||!s)return;return(o=d.indexOf(s)-1)<0&&(o=d.length-1),s=d[o],void g();case 40:if(!n||!s)return;return(o=d.indexOf(s)+1)>=d.length&&(o=0),s=d[o],void g();default:(e=c.getValue())!==p&&(p=e,f(a.blocksMatching(e,e.length<2,i,r)))}},c.cancel=function(){l.refreshPalette(),l.palette.adjustScrollBars()},l.fixLayout("refreshPalette"),c.edit(),t&&u.reactToKeystroke()},SpriteMorph.prototype.reporterize=function(t){var e;if(100<t.length)return null;try{return(e=function t(o,e,i){var r,n=["",""],s=0;function a(t){return t instanceof Array||isNaN(+t)?t:+t}function h(){for(var t=1,e="";s<o.length;){switch(r=o[s],s+=1,r){case"(":t+=1;break;case")":if(!(t-=1))return e}e+=r}}for(;s<o.length;)switch(r=o[s],s+=1,r){case" ":break;case"(":n[e?1:0].length?n[e?1:0]=[n[e?1:0],t(h())]:n[e?1:0]=t(h());break;case"-":case"+":case"*":case"/":case"%":case"=":case"<":case">":case"&":case"|":if(e||n[0].length)if(e){if(n[1].length)return t(o.slice(s),r,[e,i,a(n[1])]);n[1]=r}else e=r,i=a(n[0]);else n[0]=r;break;default:n[e?1:0]+=r}return e?[e,i,a(n[1])]:a(n[0])}(t))instanceof Array?function t(e){var o,i,r,n,s,a,h=1;for(i={"+":"reportSum","-":"reportDifference","*":"reportProduct","/":"reportQuotient","%":"reportModulus","^":"reportPower","=":"reportEquals","<":"reportLessThan",">":"reportGreaterThan","&":"reportAnd","|":"reportOr",round:"reportRound",not:"reportNot"},contains(["abs","ceiling","floor","sqrt","sin","cos","tan","asin","acos","atan","ln","log","round","not"],r={ceil:"ceiling","!":"not"}[e[0]]||e[0])?(n=i[r])?a=(o=SpriteMorph.prototype.blockForSelector(n)).inputs():((a=(o=SpriteMorph.prototype.blockForSelector("reportMonadic")).inputs())[0].setContents([r]),h=0):a=(o=SpriteMorph.prototype.blockForSelector(i[r])).inputs(),s=1;s<e.length;s+=1)e[s]instanceof Array?o.silentReplaceInput(a[s-h],t(e[s])):isString(e[s])?contains(["true","false"],e[s])?o.silentReplaceInput(a[s-h],SpriteMorph.prototype.blockForSelector("true"===e[s]?"reportTrue":"reportFalse")):"_"!==e[s]&&o.silentReplaceInput(a[s-h],SpriteMorph.prototype.variableBlock(e[s])):a[s-h].setContents(e[s]);return o.isDraggable=!0,o.fixLayout(),o.fixBlockColor(null,!0),o}(e):null}catch(t){return null}},SpriteMorph.prototype.addVariable=function(t,e){var o=this.parentThatIsA(IDE_Morph);e?(this.globalVariables().addVar(t),o&&o.flushBlocksCache("variables")):(this.variables.addVar(t),this.blocksCache.variables=null)},SpriteMorph.prototype.deleteVariable=function(t){var e=this.parentThatIsA(IDE_Morph);contains(this.inheritedVariableNames(!0),t)||this.deleteVariableWatcher(t),this.variables.deleteVar(t),e&&(e.flushBlocksCache("variables"),e.refreshPalette())},SpriteMorph.prototype.addCostume=function(t){t.name||(t.name="costume"+(this.costumes.length()+1)),this.costumes.add(t)},SpriteMorph.prototype.wearCostume=function(t){var e=this.xPosition?this.xPosition():null,o=this.yPosition?this.yPosition():null,i=this.isWarped;i&&this.endWarp(),this.changed(),this.costume=t,this.drawNew(),this.changed(),i&&this.startWarp(),null!==e&&this.silentGotoXY(e,o,!0),this.positionTalkBubble&&this.positionTalkBubble(),this.version=Date.now()},SpriteMorph.prototype.getCostumeIdx=function(){return this.costumes.asArray().indexOf(this.costume)+1},SpriteMorph.prototype.doWearNextCostume=function(){var t,e=this.costumes.asArray();1<e.length&&-1<(t=e.indexOf(this.costume))&&((t+=1)>e.length-1&&(t=0),this.wearCostume(e[t]))},SpriteMorph.prototype.doWearPreviousCostume=function(){var t,e=this.costumes.asArray();1<e.length&&-1<(t=e.indexOf(this.costume))&&((t-=1)<0&&(t=e.length-1),this.wearCostume(e[t]))},SpriteMorph.prototype.doSwitchToCostume=function(e){if(e instanceof Costume)this.wearCostume(e);else{var t,o,i=this.costumes.asArray();if(contains([localize("Turtle"),localize("Empty")],e instanceof Array?e[0]:null))o=null;else{if(-1===e)return void this.doWearPreviousCostume();null===(o=detect(i,function(t){return t.name===e}))&&(o=0===(t=parseFloat(e))?null:i[t-1]||null)}this.wearCostume(o)}},SpriteMorph.prototype.reportCostumes=function(){return this.costumes},SpriteMorph.prototype.addSound=function(t){this.sounds.add(t)},SpriteMorph.prototype.playSound=function(e){var t,o=this.parentThatIsA(StageMorph),i=detect(this.sounds.asArray(),function(t){return t.name===e});if(i)return t=i.play(),o&&(o.activeSounds.push(t),o.activeSounds=o.activeSounds.filter(function(t){return!t.ended&&!t.terminated})),t},SpriteMorph.prototype.reportSounds=function(){return this.sounds},SpriteMorph.prototype.userMenu=function(){var t=this.parentThatIsA(IDE_Morph),e=new MenuMorph(this);return t&&t.isAppMode||(this.isClone||e.addItem("duplicate","duplicate"),e.addItem("delete","remove"),e.addItem("move","moveCenter"),this.isClone||e.addItem("edit","edit"),e.addLine(),this.anchor&&e.addItem(localize("detach from")+" "+this.anchor.name,function(){SnapActions.detachParts([this])}),this.parts.length&&e.addItem("detach all parts",function(){SnapActions.detachParts(this.parts)}),e.addItem("export...","exportSprite")),e},SpriteMorph.prototype.exportSprite=function(){if(!this.isClone){var t=this.parentThatIsA(IDE_Morph);t&&t.exportSprite(this)}},SpriteMorph.prototype.edit=function(){var t=this.parentThatIsA(IDE_Morph);t&&!t.isAppMode&&t.selectSprite(this)},SpriteMorph.prototype.showOnStage=function(){var t=this.parentThatIsA(StageMorph);t&&(this.keepWithin(t),t.add(this)),this.show()},SpriteMorph.prototype.duplicate=function(){SnapActions.duplicateSprite(this)},SpriteMorph.prototype.remove=function(){SnapActions.removeSprite(this)},SpriteMorph.prototype.createClone=function(t){var e=this.parentThatIsA(StageMorph);e&&e.cloneCount<=2e3&&this.fullCopy(!0).clonify(e,t)},SpriteMorph.prototype.clonify=function(e,o){this.parts.forEach(function(t){t.clonify(e)}),e.cloneCount+=1,this.cloneOriginName=this.isClone?this.cloneOriginName:this.name,this.isClone=!0,this.name="",e.add(this),this.allHatBlocksFor("__clone__init__").forEach(function(t){e.threads.startProcess(t,e.isThreadSafe,null,null,null,o)}),this.endWarp()},SpriteMorph.prototype.removeClone=function(){this.isClone&&(this.parent.threads.stopAllForReceiver(this),this.corpsify(),this.destroy(),this.parent.cloneCount-=1)},SpriteMorph.prototype.corpsify=function(){this.isCorpse=!0,this.version=Date.now()},SpriteMorph.prototype.hide=function(){SpriteMorph.uber.hide.call(this),this.parts.forEach(function(t){t.hide()})},SpriteMorph.prototype.show=function(){SpriteMorph.uber.show.call(this),this.parts.forEach(function(t){t.show()})},SpriteMorph.prototype.setColor=function(t){var e=this.xPosition(),o=this.yPosition();this.color.eq(t)||(this.color=t.copy(),this.costume||(this.drawNew(),this.silentGotoXY(e,o)))},SpriteMorph.prototype.getHue=function(){return 100*this.color.hsv()[0]},SpriteMorph.prototype.setHue=function(t){var e=this.color.hsv(),o=this.xPosition(),i=this.yPosition();e[0]=Math.max(Math.min(+t||0,100),0)/100,e[1]=1,this.color.set_hsv.apply(this.color,e),this.costume||(this.drawNew(),this.changed()),this.gotoXY(o,i)},SpriteMorph.prototype.changeHue=function(t){this.setHue(this.getHue()+(+t||0))},SpriteMorph.prototype.getBrightness=function(){return 100*this.color.hsv()[2]},SpriteMorph.prototype.setBrightness=function(t){var e=this.color.hsv(),o=this.xPosition(),i=this.yPosition();e[1]=1,e[2]=Math.max(Math.min(+t||0,100),0)/100,this.color.set_hsv.apply(this.color,e),this.costume||(this.drawNew(),this.changed()),this.gotoXY(o,i)},SpriteMorph.prototype.changeBrightness=function(t){this.setBrightness(this.getBrightness()+(+t||0))},SpriteMorph.prototype.comeToFront=function(){this.parent&&(this.parent.add(this),this.changed())},SpriteMorph.prototype.goBack=function(t){var e,o,i=+t;if(!this.parent)return null;e=this.parent.children.indexOf(this),this.parent.removeChild(this),o=Math.max(e-i,0),this.parent.children.splice(o,null,this),this.parent.changed()},SpriteMorph.prototype.overlappingImage=function(t){var e=this.bounds.intersect(t.bounds),o=newCanvas(e.extent(),!0),i=o.getContext("2d");return e.width()<1||e.height()<1?newCanvas(new Point(1,1),!0):(i.drawImage(this.image,this.left()-e.left(),this.top()-e.top()),i.globalCompositeOperation="source-in",i.drawImage(t.image,t.left()-e.left(),t.top()-e.top()),o)},SpriteMorph.prototype.doStamp=function(){var t=this.parent,e=t.penTrails().getContext("2d"),o=this.isWarped,i=e.globalAlpha;o&&this.endWarp(),e.save(),e.scale(1/t.scale,1/t.scale),e.globalAlpha=this.alpha,e.drawImage(this.image,this.left()-t.left(),this.top()-t.top()),e.globalAlpha=i,e.restore(),this.changed(),o&&this.startWarp()},SpriteMorph.prototype.clear=function(){this.parent.clearPenTrails()},SpriteMorph.prototype.setSize=function(t){isNaN(t)||(this.size=Math.min(Math.max(+t,1e-4),1e3))},SpriteMorph.prototype.changeSize=function(t){this.setSize(this.size+(+t||0))},SpriteMorph.prototype.getScale=function(){return 100*this.scale},SpriteMorph.prototype.setScale=function(t){var e,i,r=this.xPosition(),n=this.yPosition(),o=this.isWarped;o&&this.endWarp(),i=(e=(+t||0)/100)/this.nestingScale,this.nestingScale=e,this.scale=Math.max(e,.01),this.changed(),this.drawNew(),this.changed(),o&&this.startWarp(),this.silentGotoXY(r,n,!0),this.positionTalkBubble(),this.parts.forEach(function(t){var e=t.xPosition()-r,o=t.yPosition()-n;t.setScale(100*t.scale*i),t.silentGotoXY(r+e*i,n+o*i)})},SpriteMorph.prototype.changeScale=function(t){this.setScale(this.getScale()+(+t||0))},SpriteMorph.prototype.graphicsChanged=function(){var e=this;return Object.keys(this.graphicsValues).some(function(t){return e.graphicsValues[t]<0||0<e.graphicsValues[t]})},SpriteMorph.prototype.applyGraphicsEffects=function(t){var B,e;return this.graphicsChanged()&&(e=(B=t.getContext("2d")).getImageData(0,0,t.width,t.height),this.graphicsValues.fisheye&&(e=function(t,e){var o,i,r,n,s,a,h,l,p,c,u,d,g,f,m,y;for(a=t.width,h=t.height,o=t.data,r=(i=B.createImageData(a,h)).data,n=a/2,s=h/2,e=Math.max(0,(e+100)/100),p=0;p<h;p++)for(l=0;l<a;l++)c=(l-n)/n,u=(p-s)/s,y=4*(((d=Math.pow(Math.sqrt(c*c+u*u),e))<=1?(g=Math.atan2(u,c),f=Math.floor(n+d*Math.cos(g)*n),Math.floor(s+d*Math.sin(g)*s)):(f=l,p))*a+f),r[m=4*(p*a+l)]=o[y],r[m+1]=o[y+1],r[m+2]=o[y+2],r[m+3]=o[y+3];return i}(e,this.graphicsValues.fisheye)),this.graphicsValues.whirl&&(e=function(t,e){var o,i,r,n,s,a,h,l,p,c,u,d,g,f,m,y,M,b,S,w,C,v,x,k;for(n=t.width,s=t.height,o=t.data,r=(i=B.createImageData(n,s)).data,a=n/2,h=s/2,c=Math.min(a,h),d=n<s?(u=s/n,1):(u=1,n/s),g=-radians(e),f=c*c,p=0;p<s;p++)for(l=0;l<n;l++)v=4*(((M=(m=u*(l-a))*m+(y=d*(p-h))*y)<f?(S=g*((b=1-Math.sqrt(M)/c)*b),x=Math.sin(S),k=Math.cos(S),w=Math.floor((k*m-x*y)/u+a),Math.floor((x*m+k*y)/d+h)):(w=l,p))*n+w),r[C=4*(p*n+l)]=o[v],r[C+1]=o[v+1],r[C+2]=o[v+2],r[C+3]=o[v+3];return i}(e,this.graphicsValues.whirl)),this.graphicsValues.pixelate&&(e=function(t,e){var o,i,r,n,s,a,h,l,p,c;for(n=t.width,s=t.height,o=t.data,r=(i=B.createImageData(n,s)).data,e=Math.floor(Math.abs(e/10)+1),h=0;h<s;h++)for(a=0;a<n;a++)l=Math.floor(a/e)*e,c=4*(Math.floor(h/e)*e*n+l),r[p=4*(h*n+a)]=o[c],r[p+1]=o[c+1],r[p+2]=o[c+2],r[p+3]=o[c+3];return i}(e,this.graphicsValues.pixelate)),this.graphicsValues.mosaic&&(e=function(t,e){var o,i,r,n,s,a;for(o=t.data,s=(n=B.createImageData(t.width,t.height)).data,e=Math.round((Math.abs(e)+10)/10),e=Math.max(0,Math.min(e,Math.min(t.width,t.height))),i=0,r=o.length;i<r;i+=4)a=i*e%r,s[i]=o[a],s[i+1]=o[a+1],s[i+2]=o[a+2],s[i+3]=o[a+3];return n}(e,this.graphicsValues.mosaic)),this.graphicsValues.duplicate&&(e=function(t,e){var o,i;for(o=t.data,i=0;i<o.length;i+=4)o[i]=o[i*e],o[i+1]=o[i*e+1],o[i+2]=o[i*e+2],o[i+3]=o[i*e+3];return t}(e,this.graphicsValues.duplicate)),(this.graphicsValues.color||this.graphicsValues.saturation||this.graphicsValues.brightness)&&(e=function(t,e,o,i){var r,n,s,a,h,l,p,c,u,d,g,f,m,y,M,b,S,w,C,v;for(n=0,s=(r=t.data).length;n<s;n+=4)a=r[n],h=r[n+1],l=r[n+2],0==(u=(p=Math.max(a,h,l))-(c=Math.min(a,h,l)))?d=g=0:(p===a?d=60*(h-l)/u:p===h?d=120+60*(l-a)/u:p===l&&(d=240+60*(a-h)/u),g=(p-c)/p),d<0&&(d+=360),f=p/255,d=(d+360*e/200)%360,g=Math.max(0,Math.min(g+o/100,1)),M=(f=Math.max(0,Math.min(f+i/100,1)))*(1-g),b=f*(1-g*(y=d/60-(m=Math.floor(d/60)))),S=f*(1-g*(1-y)),0===m||6===m?(w=f,C=S,v=M):1===m?(w=b,C=f,v=M):2===m?(w=M,C=f,v=S):3===m?(w=M,C=b,v=f):4===m?(w=S,C=M,v=f):5===m&&(w=f,C=M,v=b),r[n]=255*w,r[n+1]=255*C,r[n+2]=255*v;return t}(e,this.graphicsValues.color,this.graphicsValues.saturation,this.graphicsValues.brightness)),this.graphicsValues.negative&&(e=function(t,e){var o,i,r,n,s,a;for(i=0,r=(o=t.data).length;i<r;i+=4)n=255-o[i],s=255-o[i+1],a=255-o[i+2],o[i]<n?o[i]+=e:o[i]>n&&(o[i]-=e),o[i+1]<s?o[i+1]+=e:o[i+1]>s&&(o[i+1]-=e),o[i+2]<a?o[i+2]+=e:o[i+2]>a&&(o[i+2]-=e);return t}(e,this.graphicsValues.negative)),this.graphicsValues.comic&&(e=function(t,e){var o,i,r;for(i=0,r=(o=t.data).length;i<r;i+=4)o[i]+=127*Math.sin(i*e)+128,o[i+1]+=127*Math.sin(i*e)+128,o[i+2]+=127*Math.sin(i*e)+128;return t}(e,this.graphicsValues.comic)),this.graphicsValues.confetti&&(e=function(t,e){var o,i,r;for(i=0,r=(o=t.data).length;i<r;i+=1)o[i]=127*Math.sin(e*o[i])+o[i];return t}(e,this.graphicsValues.confetti)),B.putImageData(e,0,0)),t},SpriteMorph.prototype.setEffect=function(t,e){var o=t instanceof Array?t[0]:null;"ghost"===o?this.alpha=1-Math.min(Math.max(+e||0,0),100)/100:this.graphicsValues[o]=+e,this.drawNew(),this.changed()},SpriteMorph.prototype.getGhostEffect=function(){return 100*(1-this.alpha)},SpriteMorph.prototype.changeEffect=function(t,e){var o=t instanceof Array?t[0]:null;"ghost"===o?this.setEffect(t,this.getGhostEffect()+(+e||0)):this.setEffect(t,+this.graphicsValues[o]+ +e)},SpriteMorph.prototype.clearEffects=function(){var t;for(t in this.graphicsValues)this.graphicsValues.hasOwnProperty(t)&&this.setEffect([t],0);this.setEffect(["ghost"],0)},SpriteMorph.prototype.stopTalking=function(){var t=this.talkBubble();t&&t.destroy()},SpriteMorph.prototype.doThink=function(t){this.bubble(t,!0)},SpriteMorph.prototype.bubble=function(t,e,o){var i,r=this.parentThatIsA(StageMorph);this.stopTalking(),""===t||isNil(t)||(i=new SpriteBubbleMorph(t,r,e,o),this.add(i),this.positionTalkBubble())},SpriteMorph.prototype.talkBubble=function(){return detect(this.children,function(t){return t instanceof SpeechBubbleMorph})},SpriteMorph.prototype.positionTalkBubble=function(){var t=this.parentThatIsA(StageMorph),e=t?t.scale:1,o=this.talkBubble(),i=this.center().y;if(!o)return null;for(o.show(),o.isPointingRight||(o.isPointingRight=!0,o.drawNew(),o.changed()),o.setLeft(this.right()),o.setBottom(this.top());!this.isTouching(o)&&o.bottom()<i;)o.silentMoveBy(new Point(-1,1).scaleBy(e));if(!t)return null;o.right()>t.right()&&(o.isPointingRight=!1,o.drawNew(),o.setRight(this.center().x)),o.keepWithin(t),o.changed()},SpriteMorph.prototype.prepareToBeGrabbed=function(t){this.removeShadow(),this.recordLayers(),!this.bounds.containsPoint(t.position())&&this.isCorrectingOutsideDrag()&&this.setCenter(t.position()),this.addShadow()},SpriteMorph.prototype.isCorrectingOutsideDrag=function(){return!this.parts.length},SpriteMorph.prototype.justDropped=function(){var t=this.parentThatIsA(StageMorph);t&&(SnapActions.setSpritePosition(this),t.enableCustomHatBlocks=!0),this.restoreLayers(),this.positionTalkBubble(),this.receiveUserInteraction("dropped")},SpriteMorph.prototype.drawLine=function(t,e){var o=this.parent.bounds.origin,i=this.parent.scale,r=this.parent.penTrails().getContext("2d"),n=t.subtract(o).divideBy(i),s=e.subtract(o).divideBy(i),a=n.multiplyBy(i).add(o),h=s.multiplyBy(i).add(o),l=a.rectangle(h).expandBy(Math.max(this.size*i/2,1)).intersect(this.parent.visibleBounds()).spread();this.isDown&&(r.lineWidth=this.size,r.strokeStyle=this.color.toString(),this.useFlatLineEnds?(r.lineCap="butt",r.lineJoin="miter"):(r.lineCap="round",r.lineJoin="round"),r.beginPath(),r.moveTo(n.x,n.y),r.lineTo(s.x,s.y),r.stroke(),!1===this.isWarped&&this.world().broken.push(l))},SpriteMorph.prototype.floodFill=function(){if(this.parent.bounds.containsPoint(this.rotationCenter())){var t,e,o=normalizeCanvas(this.parent.penTrails()),i=o.width,r=o.height,n=o.getContext("2d"),s=n.getImageData(0,0,i,r),a=s.data,h=[(r/2-Math.round(this.yPosition()))*i+Math.round(this.xPosition()+i/2)];if((e=p(h[0]))[0]!==Math.round(this.color.r)||e[1]!==Math.round(this.color.g)||e[2]!==Math.round(this.color.b)||e[3]!==Math.round(255*this.color.a)){for(;0<h.length;)t=h.pop(),(l=p(t))[0]===e[0]&&l[1]===e[1]&&l[2]===e[2]&&l[3]===e[3]&&(1<t%i&&(h.push(t+1),h.push(t-1)),0<t&&t<r*i&&(h.push(t+i),h.push(t-i))),a[4*t]=Math.round(this.color.r),a[4*t+1]=Math.round(this.color.g),a[4*t+2]=Math.round(this.color.b),a[4*t+3]=Math.round(255*this.color.a);var l;n.putImageData(s,0,0),this.parent.changed()}}function p(t){var e=4*t;return[a[e],a[e+1],a[e+2],a[e+3]]}},SpriteMorph.prototype.moveBy=function(e,t){var o=this.isDown&&!t&&this.parent?this.rotationCenter():null;SpriteMorph.uber.moveBy.call(this,e),o&&this.drawLine(o,this.rotationCenter()),t||this.parts.forEach(function(t){t.moveBy(e)})},SpriteMorph.prototype.silentMoveBy=function(e,t){SpriteMorph.uber.silentMoveBy.call(this,e),!t&&this.parent instanceof HandMorph&&this.parts.forEach(function(t){t.moveBy(e)})},SpriteMorph.prototype.rootForGrab=function(){return this.anchor?this.anchor.rootForGrab():SpriteMorph.uber.rootForGrab.call(this)},SpriteMorph.prototype.setCenter=function(t,e){var o=t.subtract(this.center());this.moveBy(o,e)},SpriteMorph.prototype.nestingBounds=function(){var e=this.bounds;return!this.costume&&this.penBounds&&(e=this.penBounds.translateBy(this.position())),this.parts.forEach(function(t){t.isVisible&&(e=e.merge(t.nestingBounds()))}),e},SpriteMorph.prototype.setPosition=function(t,e){var o=t.subtract(this.topLeft());0===o.x&&0===o.y||this.moveBy(o,e)},SpriteMorph.prototype.forward=function(t){var e,o=t*this.parent.scale||0;e=0<=o?this.position().distanceAngle(o,this.heading):this.position().distanceAngle(Math.abs(o),this.heading-180),this.setPosition(e),this.positionTalkBubble()},SpriteMorph.prototype.setHeading=function(t){var o=this.xPosition(),i=this.yPosition(),e=+t||0,r=e-this.heading;this.rotationStyle?(this.changed(),SpriteMorph.uber.setHeading.call(this,e),this.silentGotoXY(o,i,!0),this.positionTalkBubble()):this.heading=parseFloat(t)%360,this.parts.forEach(function(t){var e=new Point(t.xPosition(),t.yPosition()).rotateBy(radians(r),new Point(o,i));t.rotatesWithAnchor&&t.turn(r),t.gotoXY(e.x,e.y)})},SpriteMorph.prototype.faceToXY=function(t,e){var o=(t-this.xPosition())*this.parent.scale,i=(e-this.yPosition())*this.parent.scale,r=Math.abs(o)<.001?i<0?90:270:Math.round((0<=o?0:180)-57.2957795131*Math.atan(i/o));this.setHeading(r+90)},SpriteMorph.prototype.turn=function(t){this.setHeading(this.heading+(+t||0))},SpriteMorph.prototype.turnLeft=function(t){this.setHeading(this.heading-(+t||0))},SpriteMorph.prototype.xPosition=function(){var t=this.parentThatIsA(StageMorph);return!t&&this.parent.grabOrigin&&(t=this.parent.grabOrigin.origin),t?(this.rotationCenter().x-t.center().x)/t.scale:this.rotationCenter().x},SpriteMorph.prototype.yPosition=function(){var t=this.parentThatIsA(StageMorph);return!t&&this.parent.grabOrigin&&(t=this.parent.grabOrigin.origin),t?(t.center().y-this.rotationCenter().y)/t.scale:this.rotationCenter().y},SpriteMorph.prototype.direction=function(){return this.heading},SpriteMorph.prototype.penSize=function(){return this.size},SpriteMorph.prototype.gotoXY=function(t,e,o){var i,r,n,s=this.parentThatIsA(StageMorph);s&&(i=s.center().x+(+t||0)*s.scale,r=s.center().y-(+e||0)*s.scale,n=this.costume?new Point(i,r).subtract(this.rotationOffset):new Point(i,r).subtract(this.extent().divideBy(2)),this.setPosition(n,o),this.positionTalkBubble())},SpriteMorph.prototype.silentGotoXY=function(t,e,o){var i=this.isDown;this.isDown=!1,this.gotoXY(t,e,o),this.isDown=i},SpriteMorph.prototype.setXPosition=function(t){this.gotoXY(+t||0,this.yPosition())},SpriteMorph.prototype.changeXPosition=function(t){this.setXPosition(this.xPosition()+(+t||0))},SpriteMorph.prototype.setYPosition=function(t){this.gotoXY(this.xPosition(),+t||0)},SpriteMorph.prototype.changeYPosition=function(t){this.setYPosition(this.yPosition()+(+t||0))},SpriteMorph.prototype.glide=function(t,e,o,i,r){var n,s,a;s=new Point(e,o),n=Math.max(Math.min(i/t,1),0),a=r.add(s.subtract(r).multiplyBy(n)),this.gotoXY(a.x,a.y)},SpriteMorph.prototype.bounceOffEdge=function(){var t,e,o=this.parentThatIsA(StageMorph),i=this.nestingBounds();return o?o.bounds.containsRectangle(i)?null:(t=Math.cos(radians(this.heading-90)),e=-Math.sin(radians(this.heading-90)),i.left()<o.left()&&(t=Math.abs(t)),i.right()>o.right()&&(t=-Math.abs(t)),i.top()<o.top()&&(e=-Math.abs(e)),i.bottom()>o.bottom()&&(e=Math.abs(e)),this.setHeading(degrees(Math.atan2(-e,t))+90),this.setPosition(this.position().add(i.amountToTranslateWithin(o.bounds))),void this.positionTalkBubble()):null},SpriteMorph.prototype.setRotationX=function(t){this.setRotationCenter(new Point(t,this.yPosition()))},SpriteMorph.prototype.setRotationY=function(t){this.setRotationCenter(new Point(this.xPosition(),t))},SpriteMorph.prototype.setRotationCenter=function(t){var e,o;if(!this.costume)throw new Error("setting the rotation center requires a costume");e=t.subtract(new Point(this.xPosition(),this.yPosition())).divideBy(this.scale).rotateBy(radians(90-this.heading)),o=this.costume.rotationCenter.add(new Point(e.x,-e.y)),this.costume.rotationCenter=o,this.drawNew()},SpriteMorph.prototype.xCenter=function(){var t=this.parentThatIsA(StageMorph);return!t&&this.parent.grabOrigin&&(t=this.parent.grabOrigin.origin),t?(this.center().x-t.center().x)/t.scale:this.center().x},SpriteMorph.prototype.yCenter=function(){var t=this.parentThatIsA(StageMorph);return!t&&this.parent.grabOrigin&&(t=this.parent.grabOrigin.origin),t?(t.center().y-this.center().y)/t.scale:this.center().y},SpriteMorph.prototype.allMessageNames=function(){var o=[],e=this.scripts.children.slice();return this.customBlocks.forEach(function(t){t.body&&e.push(t.body.expression),t.scripts.forEach(function(t){e.push(t)})}),this.globalBlocks&&this.globalBlocks.forEach(function(t){t.body&&e.push(t.body.expression),t.scripts.forEach(function(t){e.push(t)})}),e.forEach(function(t){t.allChildren().forEach(function(t){var e;t.selector&&contains(["receiveMessage","doBroadcast","doBroadcastAndWait"],t.selector)&&isString(e=t.inputs()[0].evaluate())&&""!==e&&(contains(o,e)||o.push(e))})}),o},SpriteMorph.prototype.allHatBlocksFor=function(o){return"number"==typeof o&&(o=o.toString()),this.scripts.children.filter(function(t){var e;if(t.selector){if("receiveMessage"===t.selector)return(e=t.inputs()[0].evaluate())===o||e instanceof Array&&"__shout__go__"!==o&&"__clone__init__"!==o;if("receiveGo"===t.selector)return"__shout__go__"===o;if("receiveOnClone"===t.selector)return"__clone__init__"===o}return!1})},SpriteMorph.prototype.allHatBlocksForKey=function(o){return this.scripts.children.filter(function(t){if(t.selector&&"receiveKey"===t.selector){var e=t.inputs()[0].evaluate()[0];return e===o||"any key"===e}return!1})},SpriteMorph.prototype.allHatBlocksForInteraction=function(e){return this.scripts.children.filter(function(t){return!(!t.selector||"receiveInteraction"!==t.selector)&&t.inputs()[0].evaluate()[0]===e})},SpriteMorph.prototype.allGenericHatBlocks=function(){return this.scripts.children.filter(function(t){return!!t.selector&&"receiveCondition"===t.selector})},SpriteMorph.prototype.mouseClickLeft=function(){return this.receiveUserInteraction("clicked")},SpriteMorph.prototype.mouseEnter=function(){return this.receiveUserInteraction("mouse-entered")},SpriteMorph.prototype.mouseDownLeft=function(){return this.receiveUserInteraction("pressed")},SpriteMorph.prototype.receiveUserInteraction=function(t){var e=this.parentThatIsA(StageMorph),o=[];if(e)return this.allHatBlocksForInteraction(t).forEach(function(t){o.push(e.threads.startProcess(t,e.isThreadSafe))}),o},SpriteMorph.prototype.mouseDoubleClick=function(){this.isClone||this.edit()},SpriteMorph.prototype.getTimer=function(){var t=this.parentThatIsA(StageMorph);return t?t.getTimer():0},SpriteMorph.prototype.getTempo=function(){var t=this.parentThatIsA(StageMorph);return t?t.getTempo():0},SpriteMorph.prototype.getLastMessage=function(){var t=this.parentThatIsA(StageMorph);return t?t.getLastMessage():""},SpriteMorph.prototype.getLastAnswer=function(){return this.parentThatIsA(StageMorph).lastAnswer},SpriteMorph.prototype.reportMouseX=function(){var t=this.parentThatIsA(StageMorph);return t?t.reportMouseX():0},SpriteMorph.prototype.reportMouseY=function(){var t=this.parentThatIsA(StageMorph);return t?t.reportMouseY():0},SpriteMorph.prototype.reportThreadCount=function(){var t=this.parentThatIsA(StageMorph);return t?t.threads.processes.length:0},SpriteMorph.prototype.findVariableWatcher=function(e){var t=this.parentThatIsA(StageMorph),o=this.globalVariables(),i=this;return null===t?null:detect(t.children,function(t){return t instanceof WatcherMorph&&(t.target===i.variables||t.target===o)&&t.getter===e})},SpriteMorph.prototype.toggleVariableWatcher=function(t,e){var o,i,r=this.parentThatIsA(StageMorph),n=this.globalVariables();return null===r?null:(o=this.findVariableWatcher(t),SnapActions.toggleVariableWatcher(t,e,o&&o.isVisible),null===o?(isNil(e)&&(e=contains(n.names(),t)),(o=new WatcherMorph(t,this.blockColor.variables,e?n:this.variables,t)).setPosition(r.position().add(10)),0<(i=r.watchers(o.left())).length&&o.setTop(i[i.length-1].bottom()),r.add(o),o.fixLayout(),o.keepWithin(r),o):void(o.isVisible?o.hide():(o.show(),o.fixLayout(),o.keepWithin(r))))},SpriteMorph.prototype.showingVariableWatcher=function(t){var e;return null!==this.parentThatIsA(StageMorph)&&(!!(e=this.findVariableWatcher(t))&&e.isVisible)},SpriteMorph.prototype.deleteVariableWatcher=function(t){var e;if(null===this.parentThatIsA(StageMorph))return null;null!==(e=this.findVariableWatcher(t))&&e.destroy()},SpriteMorph.prototype.toggleWatcher=function(t,e,o){var i,r,n=this.parentThatIsA(StageMorph);n&&(i=this.watcherFor(n,t),SnapActions.toggleWatcher(t,i&&i.isVisible),i?i.isVisible?i.hide():(i.show(),i.fixLayout(),i.keepWithin(n)):((i=new WatcherMorph(e,o,WatcherMorph.prototype.isGlobal(t)?n:this,t)).setPosition(n.position().add(10)),0<(r=n.watchers(i.left())).length&&i.setTop(r[r.length-1].bottom()),n.add(i),i.fixLayout(),i.keepWithin(n)))},SpriteMorph.prototype.showingWatcher=function(t){var e,o=this.parentThatIsA(StageMorph);return null!==o&&(!!(e=this.watcherFor(o,t))&&e.isVisible)},SpriteMorph.prototype.watcherFor=function(e,o){var i=this;return detect(e.children,function(t){return t instanceof WatcherMorph&&t.getter===o&&t.target===(t.isGlobal(o)?e:i)})},SpriteMorph.prototype.deleteAllBlockInstances=function(t){this.allBlockInstances(t).forEach(function(t){t.deleteBlock()}),this.customBlocks.forEach(function(t){t.body&&t.body.expression.isCorpse&&(t.body=null)})},SpriteMorph.prototype.allBlockInstances=function(e){var t,o,i,r=[];return e.isGlobal?((o=(t=this.parentThatIsA(StageMorph)).children.filter(function(t){return t instanceof SpriteMorph})).push(t),o.forEach(function(t){r=r.concat(t.allLocalBlockInstances(e))}),i=[],t.globalBlocks.forEach(function(t){t.body&&t.body.expression.allChildren().forEach(function(t){t.definition&&t.definition===e&&i.push(t)})}),r.concat(i)):this.allLocalBlockInstances(e)},SpriteMorph.prototype.allLocalBlockInstances=function(e){var t,o,i,r,n;return t=this.scripts.allChildren().filter(function(t){return t.definition&&t.definition===e}),o=[],this.customBlocks.forEach(function(t){t.body&&t.body.expression.allChildren().forEach(function(t){t.definition&&t.definition===e&&o.push(t)})}),i=this.allEditorBlockInstances(e),r=this.paletteBlockInstance(e),n=t.concat(o).concat(i),r&&n.push(r),n},SpriteMorph.prototype.allEditorBlockInstances=function(e){var o=[];return this.world()?(this.world().children.forEach(function(t){t instanceof BlockEditorMorph&&t.body.contents.allChildren().forEach(function(t){t.isPrototype||t instanceof PrototypeHatBlockMorph||t.definition!==e||o.push(t)})}),o):[]},SpriteMorph.prototype.paletteBlockInstance=function(e){var t=this.parentThatIsA(IDE_Morph);return t?detect(t.palette.contents.children,function(t){return t.definition===e}):null},SpriteMorph.prototype.usesBlockInstance=function(e,o,t,i){var r;return!!detect(this.scripts.allChildren(),function(t){return t.definition&&t.definition===e})||(!!(e.isGlobal&&!t&&(r=[],this.parentThatIsA(StageMorph).globalBlocks.forEach(function(t){o&&e===t||i&&contains(i,t)||t.body&&t.body.expression.allChildren().forEach(function(t){t.definition&&t.definition===e&&r.push(t)})}),0<r.length))||(r=[],this.customBlocks.forEach(function(t){t.body&&t.body.expression.allChildren().forEach(function(t){t.definition&&t.definition===e&&r.push(t)})}),0<r.length))},SpriteMorph.prototype.doubleDefinitionsFor=function(t){var e,o,i,r=t.blockSpec();if(t.isGlobal){if(!(i=this.parentThatIsA(StageMorph)))return[];e=i.globalBlocks}else e=this.customBlocks;return-1===(o=e.indexOf(t))?[]:e.filter(function(t,e){return t.blockSpec()===r&&e!==o})},SpriteMorph.prototype.replaceDoubleDefinitionsFor=function(e){var t,o,i=this.doubleDefinitionsFor(e),r=this;i.forEach(function(t){r.allBlockInstances(t).forEach(function(t){t.definition=e,t.refresh()})}),e.isGlobal?(t=this.parentThatIsA(StageMorph)).globalBlocks=t.globalBlocks.filter(function(t){return!contains(i,t)}):this.customBlocks=this.customBlocks.filter(function(t){return!contains(i,t)}),(o=this.parentThatIsA(IDE_Morph))&&(o.flushPaletteCache(),o.refreshPalette())},SpriteMorph.prototype.chooseExemplar=function(){var e,t=this.parentThatIsA(StageMorph),o=this,i=t.children.filter(function(t){return t instanceof SpriteMorph&&!contains(t.allExemplars(),o)});e=new MenuMorph(function(t){o.setExemplar(t)},localize("current parent")+":\n"+(this.exemplar?this.exemplar.name:localize("none"))),i.forEach(function(t){e.addItem(t.name,t)}),e.addLine(),e.addItem(localize("none"),null),e.popUpAtHand(this.world())},SpriteMorph.prototype.setExemplar=function(t){var e=this.parentThatIsA(IDE_Morph);isNil(this.exemplar=t)?this.variables.parentFrame=this.globalVariables():this.variables.parentFrame=t.variables,e&&(e.flushBlocksCache("variables"),e.refreshPalette())},SpriteMorph.prototype.allExemplars=function(){for(var t=[],e=this;!isNil(e);)t.push(e),e=e.exemplar;return t},SpriteMorph.prototype.specimens=function(){var e=this;return this.siblings().filter(function(t){return t instanceof SpriteMorph&&t.exemplar===e})},SpriteMorph.prototype.allSpecimens=function(){var e=this;return this.siblings().filter(function(t){return t instanceof SpriteMorph&&contains(t.allExemplars(),e)})},SpriteMorph.prototype.isVariableNameInUse=function(t,e){return e?contains(this.variables.allNames(),t):!!contains(this.variables.names(),t)||contains(this.globalVariables().names(),t)},SpriteMorph.prototype.globalVariables=function(){for(var t=this.variables.parentFrame;t.owner;)t=t.parentFrame;return t},SpriteMorph.prototype.shadowVar=function(t,e){var o=this.parentThatIsA(IDE_Morph);this.variables.addVar(t,e),o&&(o.flushBlocksCache("variables"),o.refreshPalette())},SpriteMorph.prototype.inheritedVariableNames=function(e){var t=[],o=this.variables.names(),i=this.variables.parentFrame;function r(t){return e?contains(o,t):!contains(o,t)}for(;i.owner instanceof SpriteMorph;)t.push.apply(t,i.names().filter(r)),i=i.parentFrame;return t},SpriteMorph.prototype.deletableVariableNames=function(){var e=this.variables.names(),o=this.inheritedVariableNames();return e.concat(this.globalVariables().names().filter(function(t){return!contains(e,t)&&!contains(o,t)}))},SpriteMorph.prototype.hasSpriteVariable=function(t){return contains(this.variables.names(),t)},SpriteMorph.prototype.refactorVariableInstances=function(e,o,t){t&&this.hasSpriteVariable(e)||this.scripts.children.forEach(function(t){t instanceof BlockMorph&&t.refactorVarInStack(e,o)})},SpriteMorph.prototype.thumbnail=function(r){var t,e,n,s,o=this.image,i=Math.min(r.x/o.width,r.y/o.height);function a(t,e,o){var i=Math.min(r.x,r.y)/10;s.strokeStyle=t,s.globalAlpha=e,s.compositeOperation="lighter",s.lineWidth=o||1,s.moveTo(i,i),s.lineTo(n.width-i,n.height-i),s.moveTo(i,n.height-i),s.lineTo(n.width-i,i),s.stroke()}return t=((r=new Point(o.width*i,o.height*i)).x-o.width*i)/2,e=(r.y-o.height*i)/2,n=newCanvas(r),(s=n.getContext("2d")).save(),this.isCorpse&&(s.globalAlpha=.3),o.width&&o.height&&(s.scale(i,i),s.drawImage(o,Math.floor(t/i),Math.floor(e/i))),this.isCorpse&&(s.restore(),a("white",.8,6),a("black",.8,1)),n},SpriteMorph.prototype.fullThumbnail=function(t){var e=this.thumbnail(t),o=e.getContext("2d"),i=t.divideBy(3),r=0;for(o.restore(),this.anchor&&o.drawImage(this.anchor.thumbnail(i),0,0),r=0;r<3;r+=1)this.parts[r]&&o.drawImage(this.parts[r].thumbnail(i),r*i.x,t.y-i.y);return e},SpriteMorph.prototype.booleanMorph=function(t){var e=new BooleanSlotMorph(t);return e.isStatic=!0,e.drawNew(),e},SpriteMorph.prototype.attachPart=function(t){var e=Date.now();t.anchor&&t.anchor.detachPart(t),this.parts.push(t),this.version=e,(t.anchor=this).allParts().forEach(function(t){t.nestingScale=t.scale}),t.version=e},SpriteMorph.prototype.detachPart=function(t){var e,o=this.parts.indexOf(t);-1!==o&&(e=Date.now(),this.parts.splice(o,1),this.version=e,t.anchor=null,t.version=e)},SpriteMorph.prototype.detachAllParts=function(){var e=Date.now();this.parts.forEach(function(t){t.anchor=null,t.version=e}),this.parts=[],this.version=e},SpriteMorph.prototype.detachFromAnchor=function(){this.anchor&&this.anchor.detachPart(this)},SpriteMorph.prototype.allParts=function(){var e=[this];return this.parts.forEach(function(t){e=e.concat(t.allParts())}),e},SpriteMorph.prototype.allAnchors=function(){var t=[this];return null!==this.anchor&&(t=t.concat(this.anchor.allAnchors())),t},SpriteMorph.prototype.recordLayers=function(){var o=this.parentThatIsA(StageMorph);o?(this.layers=this.allParts(),this.layers.forEach(function(t){var e=t.talkBubble();e&&e.hide()}),this.layers.sort(function(t,e){return o.children.indexOf(t)<o.children.indexOf(e)?-1:1})):this.layerCache=null},SpriteMorph.prototype.restoreLayers=function(){this.layers&&1<this.layers.length&&this.layers.forEach(function(t){t.comeToFront(),t.positionTalkBubble()}),this.layers=null},SpriteMorph.prototype.addHighlight=function(t){var e,o=!this.isVisible;return o&&this.show(),e=this.highlight(t?t.color:this.highlightColor,this.highlightBorder),this.addBack(e),this.fullChanged(),o&&this.hide(),e},SpriteMorph.prototype.removeHighlight=function(){var t=this.getHighlight();return null!==t&&(this.fullChanged(),this.removeChild(t)),t},SpriteMorph.prototype.toggleHighlight=function(){this.getHighlight()?this.removeHighlight():this.addHighlight()},SpriteMorph.prototype.highlight=function(t,e){var o,i=new SpriteHighlightMorph,r=this.bounds,n=e;return i.setExtent(r.extent().add(2*n)),i.color=t,i.image=this.highlightImage(t,e),(o=i.image.getContext("2d")).drawImage(this.highlightImage(new Color(255,255,255),4),e-4,e-4),o.drawImage(this.highlightImage(new Color(50,50,50),2),e-2,e-2),o.drawImage(this.highlightImage(new Color(255,255,255),1),e-1,e-1),i.setPosition(r.origin.subtract(new Point(n,n))),i},SpriteMorph.prototype.highlightImage=function(t,e){var o,i,r,n,s;return o=this.extent(),i=this.image,(n=(r=newCanvas(o.add(2*e))).getContext("2d")).drawImage(i,0,0),n.drawImage(i,e,0),n.drawImage(i,2*e,0),n.drawImage(i,2*e,e),n.drawImage(i,2*e,2*e),n.drawImage(i,e,2*e),n.drawImage(i,0,2*e),n.drawImage(i,0,e),n.globalCompositeOperation="destination-out",n.drawImage(i,e,e),(n=(s=newCanvas(o.add(2*e))).getContext("2d")).drawImage(r,0,0),n.globalCompositeOperation="source-atop",n.fillStyle=t.toString(),n.fillRect(0,0,s.width,s.height),s},SpriteMorph.prototype.getHighlight=function(){var t;return 0!==(t=this.children.slice(0).reverse().filter(function(t){return t instanceof SpriteHighlightMorph})).length?t[0]:null},SpriteMorph.prototype.mouseEnterDragging=function(){var t;this.enableNesting&&(t=this.world().hand.children[0],this.wantsDropOf(t)&&this.addHighlight())},SpriteMorph.prototype.mouseLeave=function(){this.receiveUserInteraction("mouse-departed"),this.enableNesting&&this.removeHighlight()},SpriteMorph.prototype.wantsDropOf=function(t){return this.enableNesting&&t instanceof SpriteIconMorph&&!contains(t.object.allParts(),this)},SpriteMorph.prototype.reactToDropOf=function(t,e){this.removeHighlight(),SnapActions.attachParts(this,[t.object]),this.world().add(t),t.slideBackTo(e.grabOrigin)},SpriteMorph.prototype.newCostumeName=function(t,e){for(var o=t.indexOf("("),i=o<0?t:t.substring(0,o),r=1,n=i,s=this.costumes.asArray().filter(function(t){return t!==e}).map(function(t){return t.name});contains(s,n);)n=i+"("+(r+=1)+")";return n},SpriteHighlightMorph.prototype=new Morph,SpriteHighlightMorph.prototype.constructor=SpriteHighlightMorph,SpriteHighlightMorph.uber=Morph.prototype,StageMorph.prototype=new FrameMorph,StageMorph.prototype.constructor=StageMorph,StageMorph.uber=FrameMorph.prototype,StageMorph.prototype.dimensions=new Point(480,360),StageMorph.prototype.frameRate=0,StageMorph.prototype.isCachingPrimitives=SpriteMorph.prototype.isCachingPrimitives,StageMorph.prototype.sliderColor=SpriteMorph.prototype.sliderColor,StageMorph.prototype.paletteTextColor=SpriteMorph.prototype.paletteTextColor,StageMorph.prototype.hiddenPrimitives={},StageMorph.prototype.codeMappings={},StageMorph.prototype.codeHeaders={},StageMorph.prototype.enableCodeMapping=!1,StageMorph.prototype.enableInheritance=!1,StageMorph.prototype.enableSublistIDs=!1,StageMorph.prototype.init=function(t){this.name=localize("Stage"),this.threads=new ThreadManager,this.variables=new VariableFrame(t||null,this),this.scripts=new ScriptsMorph(this),this.customBlocks=[],this.globalBlocks=[],this.costumes=new List,this.costume=null,this.sounds=new List,this.version=Date.now(),this.isFastTracked=!1,this.enableCustomHatBlocks=!0,this.cloneCount=0,this.timerStart=Date.now(),this.tempo=60,this.lastMessage="",this.watcherUpdateFrequency=2,this.lastWatcherUpdate=Date.now(),this.scale=1,this.keysPressed={},this.blocksCache={},this.paletteCache={},this.lastAnswer="",this.activeSounds=[],this.trailsCanvas=null,this.isThreadSafe=!1,this.microphone=new Microphone,this.graphicsValues={color:0,fisheye:0,whirl:0,pixelate:0,mosaic:0,duplicate:0,negative:0,comic:0,confetti:0,saturation:0,brightness:0},this.projectionSource=null,this.getProjectionImage=null,this.stopProjectionSource=null,this.continuousProjection=!1,this.projectionCanvas=null,this.projectionTransparency=50,this.mirrorVideo=!0,this.videoMotion=null,StageMorph.uber.init.call(this),this.acceptsDrops=!1,this.setColor(new Color(255,255,255)),this.fps=this.frameRate},StageMorph.prototype.setScale=function(e){var o,i,r=e/this.scale,n=this.position(),t=Morph.prototype.trackChanges,s=this;1!==r&&(Morph.prototype.trackChanges=!1,this.scale=e,this.setExtent(this.dimensions.multiplyBy(e)),this.children.forEach(function(t){o=t.position().subtract(n),t.drawNew(),t.setPosition(o.multiplyBy(r).add(n),!0),t instanceof SpriteMorph?(i=t.talkBubble())&&(i.setScale(e),t.positionTalkBubble()):t instanceof StagePrompterMorph&&(s.scale<1?t.setWidth(s.width()-10):t.setWidth(s.dimensions.x-20),t.fixLayout(),t.setCenter(s.center()),t.setBottom(s.bottom()))}),Morph.prototype.trackChanges=t,this.changed())},StageMorph.prototype.drawNew=function(){var t;StageMorph.uber.drawNew.call(this),this.costume&&((t=this.image.getContext("2d")).scale(this.scale,this.scale),t.drawImage(this.costume.contents,(this.width()/this.scale-this.costume.width())/2,(this.height()/this.scale-this.costume.height())/2),this.image=this.applyGraphicsEffects(this.image)),this.version=Date.now()},StageMorph.prototype.drawOn=function(t,e){var o,i,r,n,s,a,h,l,p,c;if(!this.isVisible)return null;if((o=(e||this.bounds).intersect(this.bounds)).extent().gt(new Point(0,0))){if(i=this.position().neg(),r=o.copy().translateBy(i),(n=t.getContext("2d")).globalAlpha=this.alpha,h=r.left(),l=r.top(),s=Math.min(r.width(),this.image.width-h),a=Math.min(r.height(),this.image.height-l),s<1||a<1)return null;n.drawImage(this.image,h,l,s,a,o.left(),o.top(),s,a),this.projectionSource&&(p=s/this.scale,c=a/this.scale,n.save(),n.scale(this.scale,this.scale),n.globalAlpha=1-this.projectionTransparency/100,n.drawImage(this.projectionLayer(),h/this.scale,l/this.scale,p,c,o.left()/this.scale,o.top()/this.scale,p,c),n.restore(),this.version=Date.now()),p=s/this.scale,c=a/this.scale,n.save(),n.scale(this.scale,this.scale);try{n.drawImage(this.penTrails(),h/this.scale,l/this.scale,p,c,o.left()/this.scale,o.top()/this.scale,p,c)}catch(t){n.restore(),n.drawImage(this.penTrails(),0,0,this.dimensions.x,this.dimensions.y,this.left(),this.top(),this.dimensions.x*this.scale,this.dimensions.y*this.scale)}n.restore()}},StageMorph.prototype.clearPenTrails=function(){this.trailsCanvas=newCanvas(this.dimensions),this.changed()},StageMorph.prototype.penTrails=function(){return this.trailsCanvas||(this.trailsCanvas=newCanvas(this.dimensions)),this.trailsCanvas},StageMorph.prototype.penTrailsMorph=function(){var t=new Morph,e=this.penTrails();return t.bounds=this.bounds.copy(),t.image=newCanvas(this.extent()),t.image.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,this.image.width,this.image.height),t},StageMorph.prototype.projectionLayer=function(){return this.projectionCanvas||(this.projectionCanvas=newCanvas(this.dimensions,!0)),this.projectionCanvas},StageMorph.prototype.clearProjectionLayer=function(){this.projectionCanvas=null,this.changed()},StageMorph.prototype.colorFiltered=function(t,e){var o,i,r,n,s=new Morph,a=this.extent();for(i=normalizeCanvas(this.thumbnail(a,e),!0).getContext("2d").getImageData(0,0,a.x,a.y),s.bounds=this.bounds.copy(),s.image=newCanvas(a,!0),n=(o=s.image.getContext("2d")).createImageData(a.x,a.y),r=0;r<a.x*a.y*4;r+=4)new Color(i.data[r],i.data[r+1],i.data[r+2]).eq(t)&&(n.data[r]=i.data[r],n.data[r+1]=i.data[r+1],n.data[r+2]=i.data[r+2],n.data[r+3]=255);return o.putImageData(n,0,0),s},StageMorph.prototype.startVideo=function(){var e=this;function o(){var t=new DialogBoxMorph;t.inform(localize("Camera not supported"),localize("Please make sure your web browser is up to date\nand your camera is properly configured."),this.world),t.fixLayout(),t.drawNew(),e.projectionSource&&(e.projectionSource.remove(),e.projectionSource=null)}this.projectionSource||(this.projectionSource=document.createElement("video"),this.projectionSource.width=this.dimensions.x,this.projectionSource.height=this.dimensions.y,this.projectionSource.hidden=!0,document.body.appendChild(this.projectionSource),this.videoMotion||(this.videoMotion=new VideoMotion(this.dimensions.x,this.dimensions.y)),navigator.mediaDevices&&navigator.mediaDevices.getUserMedia&&navigator.mediaDevices.getUserMedia({video:!0}).then(function(t){e.getProjectionImage=e.getVideoImage,e.stopProjectionSource=e.stopVideo,e.continuousProjection=!0,e.projectionSource.srcObject=t,e.projectionSource.play().catch(o),e.projectionSource.stream=t}).catch(o))},StageMorph.prototype.getVideoImage=function(){return this.projectionSource},StageMorph.prototype.stopVideo=function(){this.projectionSource&&this.projectionSource.stream&&this.projectionSource.stream.getTracks().forEach(function(t){t.stop()}),this.videoMotion=null},StageMorph.prototype.stopProjection=function(){this.projectionSource&&(this.stopProjectionSource(),this.projectionSource.remove(),this.projectionSource=null,this.continuousProjection=!1),this.clearProjectionLayer()},StageMorph.prototype.projectionSnap=function(){var t=newCanvas(this.dimensions,!0);return t.getContext("2d").drawImage(this.projectionLayer(),0,0),new Costume(t,this.newCostumeName(localize("snap")))},StageMorph.prototype.getPixelColor=function(t){var e,o;if(this.trailsCanvas)return e=t.subtract(this.bounds.origin),0===(o=this.penTrailsMorph().image.getContext("2d").getImageData(e.x,e.y,1,1)).data[3]?this.projectionCanvas?(e=e.divideBy(this.scale),new Color((o=this.projectionCanvas.getContext("2d").getImageData(e.x,e.y,1,1)).data[0],o.data[1],o.data[2],o.data[3]/255)):StageMorph.uber.getPixelColor.call(this,t):new Color(o.data[0],o.data[1],o.data[2],o.data[3]/255)},StageMorph.prototype.watchers=function(e){return this.children.filter(function(t){return t instanceof WatcherMorph&&(e?t.left()===e:t.isVisible)})},StageMorph.prototype.resetTimer=function(){this.timerStart=Date.now()},StageMorph.prototype.getTimer=function(){return Math.floor((Date.now()-this.timerStart)/100)/10},StageMorph.prototype.setTempo=function(t){this.tempo=Math.max(20,+t||0)},StageMorph.prototype.changeTempo=function(t){this.setTempo(this.getTempo()+(+t||0))},StageMorph.prototype.getTempo=function(){return+this.tempo},StageMorph.prototype.getLastMessage=function(){return this.lastMessage||""},StageMorph.prototype.reportMouseX=function(){var t=this.world();return t?(t.hand.position().x-this.center().x)/this.scale:0},StageMorph.prototype.reportMouseY=function(){var t=this.world();return t?(this.center().y-t.hand.position().y)/this.scale:0},StageMorph.prototype.wantsDropOf=function(t){return t instanceof SpriteMorph||t instanceof WatcherMorph||t instanceof ListWatcherMorph||t instanceof SpriteIconMorph},StageMorph.prototype.reactToDropOf=function(t,e){t instanceof SpriteIconMorph&&(t.object.anchor&&SnapActions.detachParts([t.object]),this.world().add(t),t.slideBackTo(e.grabOrigin))},StageMorph.prototype.step=function(){var t,e,o=this.world();if(null===o.keyboardReceiver&&(o.keyboardReceiver=this),null===o.currentKey&&(this.keyPressed=null),this.enableCustomHatBlocks&&this.stepGenericConditions(),this.isFastTracked&&this.threads.processes.length){for(this.children.forEach(function(t){t instanceof SpriteMorph&&(t.wasWarped=t.isWarped,t.isWarped||t.startWarp())});Date.now()-this.lastTime<100;)this.threads.step();this.children.forEach(function(t){t instanceof SpriteMorph&&(t.wasWarped||t.endWarp())}),this.changed()}else this.threads.step(),this.threads.wantsToPause&&(e=this.parentThatIsA(IDE_Morph))&&e.controlBar.pauseButton.refresh();t=Date.now()-this.lastWatcherUpdate,1e3/this.watcherUpdateFrequency-t<1&&(this.watchers().forEach(function(t){t.update()}),this.lastWatcherUpdate=Date.now()),this.continuousProjection&&this.projectionSource&&this.updateProjection()},StageMorph.prototype.updateProjection=function(){var t=this.projectionLayer().getContext("2d");t.save(),this.mirrorVideo&&(t.translate(this.dimensions.x,0),t.scale(-1,1)),t.drawImage(this.getProjectionImage(),0,0,this.projectionSource.width,this.projectionSource.height),this.videoMotion&&this.videoMotion.addFrame(t.getImageData(0,0,this.projectionSource.width,this.projectionSource.height).data),t.restore(),this.changed()},StageMorph.prototype.stepGenericConditions=function(e){var t,o=[],i=this;if(this.children.concat(this).forEach(function(t){(t instanceof SpriteMorph||t instanceof StageMorph)&&(o=o.concat(t.allGenericHatBlocks()))}),!o.length)return this.enableCustomHatBlocks=!1,void((t=this.parentThatIsA(IDE_Morph))&&t.controlBar.stopButton.refresh());o.forEach(function(t){i.threads.doWhen(t,e)})},StageMorph.prototype.developersMenu=function(){var t=this,e=StageMorph.uber.developersMenu.call(this);return e.addItem("stop",function(){t.threads.stopAll()},"terminate all running threads"),e},StageMorph.prototype.processKeyDown=function(t){this.processKeyEvent(t,this.fireKeyEvent)},StageMorph.prototype.processKeyUp=function(t){this.processKeyEvent(t,this.removePressedKey)},StageMorph.prototype.processKeyEvent=function(t,e){var o;switch(t.keyCode){case 13:o="enter",t.ctrlKey||t.metaKey?o="ctrl enter":t.shiftKey&&(o="shift enter");break;case 27:o="esc";break;case 32:o="space";break;case 37:o="left arrow";break;case 39:o="right arrow";break;case 38:o="up arrow";break;case 40:o="down arrow";break;default:o=String.fromCharCode(t.keyCode||t.charCode),(t.ctrlKey||t.metaKey)&&(o="ctrl "+(t.shiftKey?"shift ":"")+o)}switch(t.key){case"+":case"-":o=t.key}e.call(this,o)},StageMorph.prototype.fireKeyEvent=function(t){var e=t.toLowerCase(),o=[],i=[],r=this.parentThatIsA(IDE_Morph),n=this;if(this.keysPressed[e]=!0,"ctrl enter"===e)return this.fireGreenFlagEvent();if("shift enter"===e)return this.editScripts();if("ctrl f"!==e)if("ctrl z"!==e)if("ctrl shift z"!==e&&"ctrl y"!==e)if("ctrl n"!==e)if("ctrl o"!==e){if("ctrl s"!==e)return"ctrl shift s"===e?r.isAppMode?void 0:r.saveProjectsBrowser():"esc"===e?this.fireStopAllEvent():(this.children.concat(this).forEach(function(t){isSnapObject(t)&&(o=o.concat(t.allHatBlocksForKey(e)))}),o.forEach(function(t){i.push(n.threads.startProcess(t,n.isThreadSafe))}),i);r.isAppMode||r.save()}else r.isAppMode||r.openProjectsBrowser();else r.isAppMode||r.createNewProject();else r.isAppMode||SnapUndo.redo(r.getActiveEntity());else r.isAppMode||SnapUndo.undo(r.getActiveEntity());else r.isAppMode||r.currentSprite.searchBlocks()},StageMorph.prototype.removePressedKey=function(t){delete this.keysPressed[t.toLowerCase()]},StageMorph.prototype.processKeyPress=function(t){nop(t)},StageMorph.prototype.inspectKeyEvent=CursorMorph.prototype.inspectKeyEvent,StageMorph.prototype.fireGreenFlagEvent=function(){var e=[],o=[],t=this.parentThatIsA(IDE_Morph),i=this;return this.children.concat(this).forEach(function(t){isSnapObject(t)&&(o=o.concat(t.allHatBlocksFor("__shout__go__")))}),o.forEach(function(t){e.push(i.threads.startProcess(t,i.isThreadSafe))}),t&&t.controlBar.pauseButton.refresh(),e},StageMorph.prototype.fireStopAllEvent=function(){var t=this.parentThatIsA(IDE_Morph);this.threads.resumeAll(this.stage),this.keysPressed={},this.threads.stopAll(),this.stopAllActiveSounds(),this.children.forEach(function(t){t.stopTalking&&t.stopTalking()}),this.removeAllClones(),t&&t.nextSteps([nop,function(){t.controlBar.pauseButton.refresh()}])},StageMorph.prototype.removeAllClones=function(){var e=this;this.children.filter(function(t){return t.isClone}).forEach(function(t){e.threads.stopAllForReceiver(t),t.detachFromAnchor(),t.corpsify(),t.destroy()}),this.cloneCount=0},StageMorph.prototype.editScripts=function(){var t,e,o=this.parentThatIsA(IDE_Morph);!o.isAppMode&&ScriptsMorph.prototype.enableKeyboard&&((t=o.getActiveScripts()).edit(t.position()),(e=t.focus.sortedScripts()).length?(t.focus.element=e[0],t.focus.element instanceof HatBlockMorph&&t.focus.nextCommand()):t.focus.moveBy(new Point(50,50)),t.focus.fixLayout())},StageMorph.prototype.blockTemplates=function(t){var e,o,i,r=[],n=this,s=t||"motion";function a(t){if(n.hiddenPrimitives[t])return null;var e=SpriteMorph.prototype.blockForSelector(t,!0);return e.isTemplate=!0,e}function h(t){if(n.hiddenPrimitives[t])return null;var e=SpriteMorph.prototype.blocks[t];return new ToggleMorph("checkbox",this,function(){n.toggleWatcher(t,localize(e.spec),n.blockColor[e.category])},null,function(){return n.showingWatcher(t)},null)}function l(t){t&&(n.isVariableNameInUse(t[0])?n.inform("that name is already in use"):SnapActions.addVariable(t[0],t[1]||n.id))}function p(t){SnapActions.deleteVariable(t,n.id)}function c(t){var e=n.parentThatIsA(StageMorph);t.fields=t.fields.filter(function(t){return!!t}),e.messageTypes.getMsgType(t.name)?n.inform("that name is already in use"):SnapActions.addMessageType(t.name,t.fields)}return"motion"===s?((i=new TextMorph(localize("Stage selected:\nno motion primitives"))).fontSize=9,i.setColor(this.paletteTextColor),r.push(i)):"looks"===s?(r.push(a("doSwitchToCostume")),r.push(a("doWearNextCostume")),r.push(h("getCostumeIdx")),r.push(a("getCostumeIdx")),r.push("-"),r.push(a("changeEffect")),r.push(a("setEffect")),r.push(a("clearEffects")),r.push("-"),r.push(a("show")),r.push(a("hide")),this.world().isDevMode&&(r.push("-"),(i=new TextMorph(localize("development mode \ndebugging primitives:"))).fontSize=9,i.setColor(this.paletteTextColor),r.push(i),r.push("-"),r.push(a("reportCostumes")),r.push("-"),r.push(a("log")),r.push(a("alert")))):"sound"===s?(r.push(a("playSound")),r.push(a("doPlaySoundUntilDone")),r.push(a("doStopAllSounds")),r.push("-"),r.push(a("doRest")),r.push("-"),r.push(a("doPlayNote")),r.push("-"),r.push(a("doChangeTempo")),r.push(a("doSetTempo")),r.push(h("getTempo")),r.push(a("getTempo")),this.world().isDevMode&&(r.push("-"),(i=new TextMorph(localize("development mode \ndebugging primitives:"))).fontSize=9,i.setColor(this.paletteTextColor),r.push(i),r.push("-"),r.push(a("reportSounds")))):"pen"===s?r.push(a("clear")):"network"===s?(r.push(a("receiveSocketMessage")),r.push(a("doSocketMessage")),r.push("-"),r.push(a("doSocketRequest")),r.push(a("doSocketResponse")),r.push("-"),r.push(a("getJSFromRPCStruct")),r.push(a("doRunRPC")),r.push(h("reportRPCError")),r.push(a("reportRPCError")),r.push("-"),r.push(a("getProjectIds")),r.push(a("getProjectId")),o=new PushButtonMorph(null,function(){new MessageCreatorMorph(n,c).popUp()},"Make a message type"),r.push(o),0<this.deletableMessageNames().length&&((o=new PushButtonMorph(null,function(){var e=new MenuMorph(function(t){SnapActions.deleteMessageType(t)},null);n.deletableMessageNames().forEach(function(t){e.addItem(t,t)}),e.popUpAtHand(n.world())},"Delete a message type")).selector="deleteMessageType",o.showHelp=BlockMorph.prototype.showHelp,r.push(o))):"control"===s?(r.push(a("receiveGo")),r.push(a("receiveKey")),r.push(a("receiveInteraction")),r.push(a("receiveCondition")),r.push(a("receiveMessage")),r.push("-"),r.push(a("doBroadcast")),r.push(a("doBroadcastAndWait")),r.push(h("getLastMessage")),r.push(a("getLastMessage")),r.push("-"),r.push(a("doWarp")),r.push("-"),r.push(a("doWait")),r.push(a("doWaitUntil")),r.push("-"),r.push(a("doForever")),r.push(a("doRepeat")),r.push(a("doUntil")),r.push("-"),r.push(a("doIf")),r.push(a("doIfElse")),r.push("-"),r.push(a("doReport")),r.push("-"),r.push(a("doStopThis")),r.push(a("doStopOthers")),r.push("-"),r.push(a("doRun")),r.push(a("fork")),r.push(a("evaluate")),r.push("-"),r.push(a("doCallCC")),r.push(a("reportCallCC")),r.push("-"),r.push(a("createClone")),r.push("-"),r.push(a("doPauseAll"))):"sensing"===s?(r.push(a("doAsk")),r.push(h("getLastAnswer")),r.push(a("getLastAnswer")),r.push("-"),r.push(h("reportMouseX")),r.push(a("reportMouseX")),r.push(h("reportMouseY")),r.push(a("reportMouseY")),r.push(a("reportMouseDown")),r.push("-"),r.push(a("reportKeyPressed")),r.push("-"),r.push(a("doResetTimer")),r.push(h("getTimer")),r.push(a("getTimer")),r.push("-"),r.push(a("reportAttributeOf")),SpriteMorph.prototype.enableFirstClass&&r.push(a("reportGet")),r.push("-"),r.push(a("reportURL")),r.push(a("reportAudio")),r.push(a("reportVideo")),r.push(a("doSetVideoTransparency")),r.push("-"),r.push(a("reportGlobalFlag")),r.push(a("doSetGlobalFlag")),r.push("-"),r.push(a("reportDate")),r.push(a("reportUsername")),r.push("-"),r.push(a("reportLatitude")),r.push(a("reportLongitude")),r.push("-"),r.push(a("reportStageHeight")),r.push(a("reportStageWidth")),this.world().isDevMode&&(r.push("-"),(i=new TextMorph(localize("development mode \ndebugging primitives:"))).fontSize=9,i.setColor(this.paletteTextColor),r.push(i),r.push("-"),r.push(h("reportThreadCount")),r.push(a("reportThreadCount")),r.push(a("colorFiltered")),r.push(a("reportStackSize")),r.push(a("reportFrameCount")))):"operators"===s?(r.push(a("reifyScript")),r.push(a("reifyReporter")),r.push(a("reifyPredicate")),r.push("#"),r.push("-"),r.push(a("reportSum")),r.push(a("reportDifference")),r.push(a("reportProduct")),r.push(a("reportQuotient")),r.push(a("reportPower")),r.push("-"),r.push(a("reportModulus")),r.push(a("reportRound")),r.push(a("reportMonadic")),r.push(a("reportRandom")),r.push("-"),r.push(a("reportLessThan")),r.push(a("reportEquals")),r.push(a("reportGreaterThan")),r.push("-"),r.push(a("reportAnd")),r.push(a("reportOr")),r.push(a("reportNot")),r.push(a("reportBoolean")),r.push("-"),r.push(a("reportJoinWords")),r.push(a("reportTextSplit")),r.push(a("reportLetter")),r.push(a("reportStringSize")),r.push("-"),r.push(a("reportUnicode")),r.push(a("reportUnicodeAsLetter")),r.push("-"),r.push(a("reportIsA")),r.push(a("reportIsIdentical")),r.push("-"),r.push(a("reportJSFunction")),this.world().isDevMode&&(r.push("-"),(i=new TextMorph("development mode \ndebugging primitives:")).fontSize=9,i.setColor(this.paletteTextColor),r.push(i),r.push("-"),r.push(a("reportTypeOf")),r.push(a("reportTextFunction")))):"variables"===s?(o=new PushButtonMorph(null,function(){new VariableDialogMorph(null,l,n).prompt("Variable name",null,n.world())},"Make a variable"),r.push(o),0<this.variables.allNames().length&&(o=new PushButtonMorph(null,function(){var e=new MenuMorph(p,null,n);n.variables.allNames().forEach(function(t){e.addItem(t,t)}),e.popUpAtHand(n.world())},"Delete a variable"),r.push(o)),r.push("-"),0<(e=this.variables.allNames()).length&&(e.forEach(function(t){var e,o;r.push(function(t){return new ToggleMorph("checkbox",this,function(){n.toggleVariableWatcher(t)},null,function(){return n.showingVariableWatcher(t)},null)}(t)),r.push((e=t,(o=SpriteMorph.prototype.variableBlock(e)).isDraggable=!1,o.isTemplate=!0,o))}),r.push("-")),r.push(a("doSetVar")),r.push(a("doChangeVar")),r.push(a("doShowVar")),r.push(a("doHideVar")),r.push(a("doDeclareVariables")),r.push("="),r.push(a("reportNewList")),r.push("-"),r.push(a("reportCONS")),r.push(a("reportListItem")),r.push(a("reportCDR")),r.push("-"),r.push(a("reportListLength")),r.push(a("reportListContainsItem")),r.push("-"),r.push(a("doAddToList")),r.push(a("doDeleteFromList")),r.push(a("doInsertInList")),r.push(a("doReplaceInList")),this.world().isDevMode&&(r.push("-"),(i=new TextMorph(localize("development mode \ndebugging primitives:"))).fontSize=9,i.setColor(this.paletteTextColor),r.push(i),r.push("-"),r.push(a("reportMap")),r.push("-"),r.push(a("doForEach")),r.push(a("doShowTable"))),r.push("="),StageMorph.prototype.enableCodeMapping&&(r.push(a("doMapCodeOrHeader")),r.push(a("doMapStringCode")),r.push(a("doMapListCode")),r.push("-"),r.push(a("reportMappedCode")),r.push("=")),o=new PushButtonMorph(null,function(){n.parentThatIsA(IDE_Morph);new BlockDialogMorph(null,function(t){""!==t.spec&&SnapActions.addCustomBlock(t,n).then(function(t){new BlockEditorMorph(t,n).popUp()})},n).prompt("Make a block",null,n.world())},"Make a block"),r.push(o)):"custom"===s&&(o=new PushButtonMorph(null,function(){new BlockDialogMorph(null,function(t){""!==t.spec&&SnapActions.addCustomBlock(t,n).then(function(t){new BlockEditorMorph(t,n).popUp()})},n).prompt("Make a block",null,n.world())},"Make a block"),r.push(o)),r},StageMorph.prototype.clear=function(){this.clearPenTrails()},StageMorph.prototype.userMenu=function(){var e=this.parentThatIsA(IDE_Morph),t=new MenuMorph(this),o=16===this.world().currentKey,i=this;return e&&e.isAppMode||(t.addItem("edit","edit"),t.addItem("show all","showAll"),t.addItem("pic...",function(){e.saveCanvasAs(i.fullImageClassic(),i.name)},"download a picture of stage"),o&&(t.addLine(),t.addItem(e.currentSprite instanceof SpriteMorph?"turn pen trails into new costume...":"turn pen trails into new background...",function(){var t=new Costume(i.trailsCanvas,Date.now().toString()).copy();e.currentSprite.addCostume(t),e.currentSprite.wearCostume(t),e.hasChangedMedia=!0},e.currentSprite instanceof SpriteMorph?"turn all pen trails and stamps\ninto a new costume for the\ncurrently selected sprite":"turn all pen trails and stamps\ninto a new background for the stage",new Color(100,0,0)))),t},StageMorph.prototype.showAll=function(){var e=this;this.children.forEach(function(t){t instanceof SpriteMorph?t.anchor||(t.show(),t.keepWithin(e)):(t.show(),t.keepWithin(e),t.fixLayout&&t.fixLayout())})},StageMorph.prototype.edit=SpriteMorph.prototype.edit,StageMorph.prototype.thumbnail=function(t,e){var o,i,r,n,s=this,a=this.image,h=Math.min(t.x/a.width,t.y/a.height);return o=newCanvas(t=new Point(a.width*h,a.height*h)),(i=o.getContext("2d")).scale(h,h),i.drawImage(a,0,0),i.drawImage(this.penTrails(),0,0,this.dimensions.x*this.scale,this.dimensions.y*this.scale),this.children.forEach(function(t){t.isVisible&&t!==e&&(r=t.fullBounds(),(n=t.fullImage()).width&&n.height&&i.drawImage(t.fullImage(),r.origin.x-s.bounds.origin.x,r.origin.y-s.bounds.origin.y))}),o},StageMorph.prototype.hide=function(){this.isVisible=!1,this.changed()},StageMorph.prototype.show=function(){this.isVisible=!0,this.changed()},StageMorph.prototype.createClone=nop,StageMorph.prototype.categories=SpriteMorph.prototype.categories,StageMorph.prototype.blockColor=SpriteMorph.prototype.blockColor,StageMorph.prototype.paletteColor=SpriteMorph.prototype.paletteColor,StageMorph.prototype.setName=SpriteMorph.prototype.setName,StageMorph.prototype.palette=SpriteMorph.prototype.palette,StageMorph.prototype.freshPalette=SpriteMorph.prototype.freshPalette,StageMorph.prototype.blocksMatching=SpriteMorph.prototype.blocksMatching,StageMorph.prototype.searchBlocks=SpriteMorph.prototype.searchBlocks,StageMorph.prototype.reporterize=SpriteMorph.prototype.reporterize,StageMorph.prototype.showingWatcher=SpriteMorph.prototype.showingWatcher,StageMorph.prototype.addVariable=SpriteMorph.prototype.addVariable,StageMorph.prototype.deleteVariable=SpriteMorph.prototype.deleteVariable,StageMorph.prototype.newCostumeName=SpriteMorph.prototype.newCostumeName,StageMorph.prototype.blockForSelector=SpriteMorph.prototype.blockForSelector,StageMorph.prototype.findVariableWatcher=SpriteMorph.prototype.findVariableWatcher,StageMorph.prototype.toggleVariableWatcher=SpriteMorph.prototype.toggleVariableWatcher,StageMorph.prototype.showingVariableWatcher=SpriteMorph.prototype.showingVariableWatcher,StageMorph.prototype.deleteVariableWatcher=SpriteMorph.prototype.deleteVariableWatcher,StageMorph.prototype.addCostume=SpriteMorph.prototype.addCostume,StageMorph.prototype.wearCostume=SpriteMorph.prototype.wearCostume,StageMorph.prototype.getCostumeIdx=SpriteMorph.prototype.getCostumeIdx,StageMorph.prototype.doWearNextCostume=SpriteMorph.prototype.doWearNextCostume,StageMorph.prototype.doWearPreviousCostume=SpriteMorph.prototype.doWearPreviousCostume,StageMorph.prototype.doSwitchToCostume=SpriteMorph.prototype.doSwitchToCostume,StageMorph.prototype.reportCostumes=SpriteMorph.prototype.reportCostumes,StageMorph.prototype.graphicsChanged=SpriteMorph.prototype.graphicsChanged,StageMorph.prototype.applyGraphicsEffects=SpriteMorph.prototype.applyGraphicsEffects,StageMorph.prototype.setEffect=SpriteMorph.prototype.setEffect,StageMorph.prototype.getGhostEffect=SpriteMorph.prototype.getGhostEffect,StageMorph.prototype.changeEffect=SpriteMorph.prototype.changeEffect,StageMorph.prototype.clearEffects=SpriteMorph.prototype.clearEffects,StageMorph.prototype.addSound=SpriteMorph.prototype.addSound,StageMorph.prototype.playSound=SpriteMorph.prototype.playSound,StageMorph.prototype.stopAllActiveSounds=function(){this.activeSounds.forEach(function(t){t.pause()}),this.activeSounds=[]},StageMorph.prototype.pauseAllActiveSounds=function(){this.activeSounds.forEach(function(t){t.pause()})},StageMorph.prototype.resumeAllActiveSounds=function(){this.activeSounds.forEach(function(t){t.play()})},StageMorph.prototype.reportSounds=SpriteMorph.prototype.reportSounds,StageMorph.prototype.toggleWatcher=SpriteMorph.prototype.toggleWatcher,StageMorph.prototype.showingWatcher=SpriteMorph.prototype.showingWatcher,StageMorph.prototype.watcherFor=SpriteMorph.prototype.watcherFor,StageMorph.prototype.getLastAnswer=SpriteMorph.prototype.getLastAnswer,StageMorph.prototype.reportThreadCount=SpriteMorph.prototype.reportThreadCount,StageMorph.prototype.allMessageNames=SpriteMorph.prototype.allMessageNames,StageMorph.prototype.allHatBlocksFor=SpriteMorph.prototype.allHatBlocksFor,StageMorph.prototype.allHatBlocksForKey=SpriteMorph.prototype.allHatBlocksForKey,StageMorph.prototype.allHatBlocksForInteraction=SpriteMorph.prototype.allHatBlocksForInteraction,StageMorph.prototype.allGenericHatBlocks=SpriteMorph.prototype.allGenericHatBlocks,StageMorph.prototype.mouseClickLeft=SpriteMorph.prototype.mouseClickLeft,StageMorph.prototype.mouseEnter=SpriteMorph.prototype.mouseEnter,StageMorph.prototype.mouseLeave=function(){this.receiveUserInteraction("mouse-departed")},StageMorph.prototype.mouseDownLeft=SpriteMorph.prototype.mouseDownLeft,StageMorph.prototype.receiveUserInteraction=SpriteMorph.prototype.receiveUserInteraction,StageMorph.prototype.deleteAllBlockInstances=SpriteMorph.prototype.deleteAllBlockInstances,StageMorph.prototype.allBlockInstances=SpriteMorph.prototype.allBlockInstances,StageMorph.prototype.allLocalBlockInstances=SpriteMorph.prototype.allLocalBlockInstances,StageMorph.prototype.allEditorBlockInstances=SpriteMorph.prototype.allEditorBlockInstances,StageMorph.prototype.paletteBlockInstance=SpriteMorph.prototype.paletteBlockInstance,StageMorph.prototype.usesBlockInstance=SpriteMorph.prototype.usesBlockInstance,StageMorph.prototype.doubleDefinitionsFor=SpriteMorph.prototype.doubleDefinitionsFor,StageMorph.prototype.replaceDoubleDefinitionsFor=SpriteMorph.prototype.replaceDoubleDefinitionsFor,StageMorph.prototype.isVariableNameInUse=SpriteMorph.prototype.isVariableNameInUse,StageMorph.prototype.globalVariables=SpriteMorph.prototype.globalVariables,StageMorph.prototype.inheritedVariableNames=function(){return[]},StageMorph.prototype.hasSpriteVariable=SpriteMorph.prototype.hasSpriteVariable,StageMorph.prototype.refactorVariableInstances=SpriteMorph.prototype.refactorVariableInstances,SpriteBubbleMorph.prototype=new SpeechBubbleMorph,SpriteBubbleMorph.prototype.constructor=SpriteBubbleMorph,SpriteBubbleMorph.uber=SpeechBubbleMorph.prototype,SpriteBubbleMorph.prototype.init=function(t,e,o,i){var r=SpriteMorph.prototype;this.stage=e,this.scale=e?e.scale:1,this.data=t,this.isQuestion=i,SpriteBubbleMorph.uber.init.call(this,this.dataAsMorph(t),r.bubbleColor,null,null,i?r.blockColor.sensing:r.bubbleBorderColor,null,o)},SpriteBubbleMorph.prototype.dataAsMorph=function(t,e){var o,i,r,n,s,a=SpriteMorph.prototype;return t instanceof Morph?isSnapObject(t)?(r=t.thumbnail(new Point(40,40)),(o=new Morph).silentSetWidth(r.width),o.silentSetHeight(r.height),o.image=r,o.version=t.version,o.step=function(){this.version!==t.version&&(r=t.thumbnail(new Point(40,40)),this.image=r,this.version=t.version,this.changed())}):o=t:isString(t)?(i=!0,o=new TextMorph(t,a.bubbleFontSize*this.scale,null,a.bubbleFontIsBold,!1,"center")):"boolean"==typeof t?(r=a.booleanMorph(t).fullImage(),(o=new Morph).silentSetWidth(r.width),o.silentSetHeight(r.height),o.image=r):t instanceof Costume?(r=t.thumbnail(new Point(40,40)),(o=new Morph).silentSetWidth(r.width),o.silentSetHeight(r.height),o.image=r):t instanceof HTMLCanvasElement?((o=new Morph).silentSetWidth(t.width),o.silentSetHeight(t.height),o.image=t):t instanceof List?((e&&this.contentsMorph?this.contentsMorph instanceof ListWatcherMorph:t.isTable())?o=new TableFrameMorph(new TableMorph(t,10)):((o=new ListWatcherMorph(t)).update(!0),o.step=o.update),this.stage&&o.expand(this.stage.extent().translateBy(-2*(this.edge+this.border+this.padding))),o.isDraggable=!1):t instanceof Context?(r=t.image(),(o=new Morph).silentSetWidth(r.width),o.silentSetHeight(r.height),o.image=r):o=new TextMorph(t.toString(),a.bubbleFontSize*this.scale,null,a.bubbleFontIsBold,!1,"center"),o instanceof TextMorph?(s=Math.max(o.width(),2*a.bubbleCorner*this.scale),i&&(s=Math.min(s,a.bubbleMaxTextWidth*this.scale)),o.setWidth(s)):t instanceof List||((n=newCanvas(o.extent().multiplyBy(this.scale))).getContext("2d").drawImage(o.image,0,0,n.width,n.height),o.image=n,o.bounds=o.bounds.scaleBy(this.scale)),o},SpriteBubbleMorph.prototype.setScale=function(t){this.scale=t,this.changed(),this.drawNew(),this.changed()},SpriteBubbleMorph.prototype.drawNew=function(t){var e=SpriteMorph.prototype;this.edge=e.bubbleCorner*this.scale,this.border=e.bubbleBorder*this.scale,this.padding=e.bubbleCorner/2*this.scale,this.contentsMorph&&this.contentsMorph.destroy(),this.contentsMorph=this.dataAsMorph(this.data,t),this.add(this.contentsMorph),this.silentSetWidth(this.contentsMorph.width()+(this.padding?2*this.padding:2*this.edge)),this.silentSetHeight(this.contentsMorph.height()+this.edge+2*this.border+2*this.padding+2),SpeechBubbleMorph.uber.drawNew.call(this),this.contentsMorph.setPosition(this.position().add(new Point(this.padding||this.edge,this.border+this.padding+1)))},SpriteBubbleMorph.prototype.fixLayout=function(){var t=SpriteMorph.prototype;this.changed(),this.edge=t.bubbleCorner*this.scale,this.border=t.bubbleBorder*this.scale,this.padding=t.bubbleCorner/2*this.scale,this.silentSetWidth(this.contentsMorph.width()+(this.padding?2*this.padding:2*this.edge)),this.silentSetHeight(this.contentsMorph.height()+this.edge+2*this.border+2*this.padding+2),SpeechBubbleMorph.uber.drawNew.call(this),this.contentsMorph.setPosition(this.position().add(new Point(this.padding||this.edge,this.border+this.padding+1))),this.changed()},Costume.prototype.maxExtent=function(){return StageMorph.prototype.dimensions},Costume.prototype.toString=function(){return"a Costume("+this.name+")"},Costume.prototype.extent=function(){return new Point(this.contents.width,this.contents.height)},Costume.prototype.center=function(){return this.extent().divideBy(2)},Costume.prototype.width=function(){return this.contents.width},Costume.prototype.height=function(){return this.contents.height},Costume.prototype.bounds=function(){return new Rectangle(0,0,this.width(),this.height())},Costume.prototype.shrinkWrap=function(){var t=this.boundingBox(),e=t.extent(),o=newCanvas(e,!0);o.getContext("2d").drawImage(this.contents,t.origin.x,t.origin.y,e.x,e.y,0,0,e.x,e.y),this.rotationCenter=this.rotationCenter.subtract(t.origin),this.contents=o,this.version=Date.now()},Costume.prototype.canvasBoundingBox=function(t){var e,o,i=t.width,r=t.height,n=t.getContext("2d").getImageData(0,0,i,r);function s(t,e){return n.data[e*i*4+4*t+3]}return new Rectangle(function(){for(o=0;o<=i;o+=1)for(e=0;e<=r;e+=1)if(s(o,e))return o;return 0}(),function(){for(e=0;e<=r;e+=1)for(o=0;o<=r;o+=1)if(s(o,e))return e;return 0}(),function(){for(o=i;0<=o;o-=1)for(e=r;0<=e;e-=1)if(s(o,e))return Math.min(o+1,i);return i}(),function(){for(e=r;0<=e;e-=1)for(o=i;0<=o;o-=1)if(s(o,e))return Math.min(e+1,r);return r}())},Costume.prototype.boundingBox=function(){return this.canvasBoundingBox(this.contents)},Costume.prototype.copy=function(){var t,e=newCanvas(this.extent(),!0);return e.getContext("2d").drawImage(this.contents,0,0),(t=new Costume(e,this.name?copy(this.name):null)).rotationCenter=this.rotationCenter.copy(),t},Costume.prototype.flipped=function(){var t=newCanvas(this.extent(),!0),e=t.getContext("2d");return e.translate(this.width(),0),e.scale(-1,1),e.drawImage(this.contents,0,0),new Costume(t,new Point(this.width()-this.rotationCenter.x,this.rotationCenter.y))},Costume.prototype.edit=function(o,i,t,e,r){var n=this,s=new PaintEditorMorph;s.oncancel=e||nop,s.openIn(o,t?newCanvas(StageMorph.prototype.dimensions,!0):this.contents,t?null:this.rotationCenter,function(t,e){n.contents=t,n.rotationCenter=e,n.version=Date.now(),o.changed(),i&&(i.currentSprite instanceof SpriteMorph&&n.shrinkWrap(),i.currentSprite.wearCostume(n),i.hasChangedMedia=!0),(r||nop)()})},Costume.prototype.editRotationPointOnly=function(t,e){var o,i,r=new CostumeEditorMorph(this);o=new DialogBoxMorph(this,function(){r.accept(),e&&e.call(this)}),i=new TextMorph(localize("click or drag crosshairs to move the rotation center"),o.fontSize,o.fontStyle,!0,!1,"center",null,null,new Point(1,1),new Color(255,255,255)),o.labelString="Costume Editor",o.createLabel(),o.setPicture(r),o.addBody(i),o.addButton("ok","Ok"),o.addButton("cancel","Cancel"),o.fixLayout(),o.drawNew(),o.fixLayout(),o.popUp(t)},Costume.prototype.shrinkToFit=function(t){(t.x<this.width()||t.y<this.height())&&(this.contents=this.thumbnail(t))},Costume.prototype.thumbnail=function(t){var e=this.contents,o=Math.min(t.x/e.width,t.y/e.height),i=(t.x-e.width*o)/2,r=(t.y-e.height*o)/2,n=newCanvas(t),s=n.getContext("2d");return e&&e.width+e.height!==0&&(s.scale(o,o),s.drawImage(e,Math.floor(i/o),Math.floor(r/o))),n},Costume.prototype.isTainted=function(){try{this.contents.getContext("2d").getImageData(0,0,this.contents.width,this.contents.height)}catch(t){return!0}return!1},SVG_Costume.prototype=new Costume,SVG_Costume.prototype.constructor=SVG_Costume,SVG_Costume.uber=Costume.prototype,SVG_Costume.prototype.toString=function(){return"an SVG_Costume("+this.name+")"},SVG_Costume.prototype.copy=function(){var t,e=new Image;return e.src=this.contents.src,(t=new SVG_Costume(e,this.name?copy(this.name):null)).rotationCenter=this.rotationCenter.copy(),t},SVG_Costume.prototype.shrinkToFit=function(t){nop(t)},CostumeEditorMorph.prototype=new Morph,CostumeEditorMorph.prototype.constructor=CostumeEditorMorph,CostumeEditorMorph.uber=Morph.prototype,CostumeEditorMorph.prototype.size=Costume.prototype.maxExtent(),CostumeEditorMorph.prototype.init=function(t){this.costume=t||new Costume,this.rotationCenter=this.costume.rotationCenter.copy(),this.margin=new Point(0,0),CostumeEditorMorph.uber.init.call(this),this.noticesTransparentClick=!0},CostumeEditorMorph.prototype.accept=function(){this.costume.rotationCenter=this.rotationCenter.copy(),this.costume.version=Date.now()},CostumeEditorMorph.prototype.drawNew=function(){var t,e;this.margin=this.size.subtract(this.costume.extent()).divideBy(2),t=this.rotationCenter.add(this.margin),this.silentSetExtent(this.size),this.image=newCanvas(this.extent()),this.cachedTexture||(this.cachedTexture=this.createTexture()),this.drawCachedTexture(),(e=this.image.getContext("2d")).drawImage(this.costume.contents,this.margin.x,this.margin.y),e.globalAlpha=.5,e.fillStyle="white",e.beginPath(),e.arc(t.x,t.y,20,radians(0),radians(360),!1),e.closePath(),e.fill(),e.stroke(),e.beginPath(),e.arc(t.x,t.y,10,radians(0),radians(360),!1),e.stroke(),e.beginPath(),e.moveTo(0,t.y),e.lineTo(this.costume.width()+2*this.margin.x,t.y),e.stroke(),e.beginPath(),e.moveTo(t.x,0),e.lineTo(t.x,this.costume.height()+2*this.margin.y),e.stroke()},CostumeEditorMorph.prototype.createTexture=function(){var t=newCanvas(new Point(10,10)),e=t.getContext("2d"),o=new Color(230,230,230);return e.fillStyle="white",e.fillRect(0,0,10,10),e.fillStyle=o.toString(),e.fillRect(0,0,5,5),e.fillRect(5,5,5,5),t},CostumeEditorMorph.prototype.mouseDownLeft=function(t){this.rotationCenter=t.subtract(this.position().add(this.margin)),this.drawNew(),this.changed()},CostumeEditorMorph.prototype.mouseMove=CostumeEditorMorph.prototype.mouseDownLeft,Sound.prototype.play=function(){var t=document.createElement("audio");return t.src=this.audio.src,t.play(),t},Sound.prototype.copy=function(){var t=document.createElement("audio");return t.src=this.audio.src,new Sound(t,this.name?copy(this.name):null)},Sound.prototype.toDataURL=function(){return this.audio.src},Note.prototype.audioContext=null,Note.prototype.gainNode=null,Note.prototype.setupContext=function(){if(!this.audioContext){var t,e=((t=window.AudioContext||window.mozAudioContext||window.msAudioContext||window.oAudioContext||window.webkitAudioContext).prototype.createGain||(t.prototype.createGain=t.prototype.createGainNode),t);if(!e)throw new Error("Web Audio API is not supported\nin this browser");Note.prototype.audioContext=new e,Note.prototype.gainNode=Note.prototype.audioContext.createGain(),Note.prototype.gainNode.gain.value=.25}},Note.prototype.getAudioContext=function(){return this.audioContext||this.setupContext(),this.audioContext},Note.prototype.play=function(){this.oscillator=this.audioContext.createOscillator(),this.oscillator.start||(this.oscillator.start=this.oscillator.noteOn),this.oscillator.stop||(this.oscillator.stop=this.oscillator.noteOff),this.oscillator.type="sine",this.oscillator.frequency.value=440*Math.pow(2,(this.pitch-69)/12),this.oscillator.connect(this.gainNode),this.gainNode.connect(this.audioContext.destination),this.oscillator.start(0)},Note.prototype.stop=function(){this.oscillator&&(this.oscillator.stop(0),this.oscillator=null)},Microphone.prototype.isOn=function(){return this.isReady?(this.lastTime=Date.now(),!0):(this.start(),!1)},Microphone.prototype.binSizes=[256,512,1024,2048,4096],Microphone.prototype.binSize=function(){return this.binSizes[this.resolution-1]},Microphone.prototype.setResolution=function(t){contains([1,2,3,4],t)&&(this.isReady&&this.stop(),this.resolution=t)},Microphone.prototype.start=function(){var e=this;this.isStarted||(this.isStarted=!0,this.isReady=!1,this.audioContext=Note.prototype.getAudioContext(),navigator.mediaDevices.getUserMedia({audio:{mandatory:{googEchoCancellation:"false",googAutoGainControl:"false",googNoiseSuppression:"false",googHighpassFilter:"false"},optional:[]}}).then(function(t){e.setupNodes(t)}).catch(nop))},Microphone.prototype.stop=function(){this.processor.onaudioprocess=null,this.sourceStream.getTracks().forEach(function(t){t.stop()}),this.processor.disconnect(),this.analyser.disconnect(),this.processor=null,this.analyser=null,this.audioContext=null,this.isReady=!1,this.isStarted=!1},Microphone.prototype.setupNodes=function(t){this.sourceStream=t,this.createProcessor(),this.createAnalyser(),this.analyser.connect(this.processor),this.processor.connect(this.audioContext.destination),this.audioContext.createMediaStreamSource(t).connect(this.analyser),this.lastTime=Date.now()},Microphone.prototype.createAnalyser=function(){var t;this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=this.binSizes[this.resolution],t=this.analyser.frequencyBinCount,this.frequencies=new Uint8Array(t),this.correlations=new Array(Math.floor(t/2))},Microphone.prototype.createProcessor=function(){var e=this;this.processor=this.audioContext.createScriptProcessor(this.binSizes[this.resolution-1]),this.processor.onaudioprocess=function(t){e.stepAudio(t)},this.processor.clipping=!1,this.processor.lastClip=0,this.processor.clipLevel=.98,this.processor.averaging=.95,this.processor.clipLag=750},Microphone.prototype.stepAudio=function(t){var e,o;if(this.isAutoStop&&5e3<Date.now()-this.lastTime&&!this.modifier)this.stop();else{if(this.signals=t.inputBuffer.getChannelData(0),this.modifier){for(e=t.outputBuffer.numberOfChannels,this.outChannels.length!==e&&(this.outChannels=new Array(e)),o=0;o<e;o+=1)this.outChannels[o]=t.outputBuffer.getChannelData(o);this.output=this.outChannels[0]}else this.output=t.outputBuffer.getChannelData(0);this.analyser.getByteFrequencyData(this.frequencies),this.pitch=this.detectPitchAndVolume(this.signals,this.audioContext.sampleRate),0<this.pitch&&(this.note=Math.round(Math.log(this.pitch/440)/Math.log(2)*12)+69),this.isReady=!0,this.isStarted=!1}},Microphone.prototype.detectPitchAndVolume=function(t,e){var o,i,r,n,s,a,h,l=t.length,p=Math.floor(l/2),c=-1,u=0,d=0,g=!1,f=this.correlations,m=this.outChannels.length;for(n=0;n<l;n+=1)if(a=t[n],Math.abs(a)>=this.processor.clipLevel&&(this.processor.clipping=!0,this.processor.lastClip=window.performance.now()),d+=a*a,this.modifier)for(this.wrapper.contents[0]=a,h=invoke(this.compiledModifier,this.wrapper,null,null,null,null,this.compilerProcess),s=0;s<m;s+=1)this.outChannels[s][n]=h;if(d=Math.sqrt(d/l),this.volume=Math.max(d,this.volume*this.processor.averaging),d<.01)return this.pitch;for(r=i=1;r<p;r+=1){for(n=o=0;n<p;n+=1)o+=Math.abs(t[n]-t[n+r]);if(o=1-o/p,(f[r]=o)>this.GOOD_ENOUGH_CORRELATION&&i<o)g=!0,u<o&&(u=o,c=r);else if(g)return e/(c+8*((f[c+1]-f[c-1])/f[c]));i=o}return.01<u?e/c:this.pitch},CellMorph.prototype=new BoxMorph,CellMorph.prototype.constructor=CellMorph,CellMorph.uber=BoxMorph.prototype,CellMorph.prototype.init=function(t,e,o,i){this.contents=0===t?0:!1!==t&&(t||""),this.isEditable=!isNil(o),this.idx=o||null,this.parentCell=i||null,CellMorph.uber.init.call(this,SyntaxElementMorph.prototype.corner,1.000001,new Color(255,255,255)),this.color=e||new Color(255,140,0),this.isBig=!1,this.version=null,this.drawNew()},CellMorph.prototype.big=function(){this.isBig=!0,this.changed(),this.drawNew(),this.changed()},CellMorph.prototype.normal=function(){this.isBig=!1,this.changed(),this.drawNew(),this.changed()},CellMorph.prototype.isCircular=function(t){return!!this.parentCell&&(t instanceof List?this.contents===t||this.parentCell.isCircular(t):this.parentCell.isCircular(this.contents))},CellMorph.prototype.fixLayout=function(){var t;this.changed(),this.drawNew(),this.changed(),this.parent&&this.parent.fixLayout?this.parent.fixLayout():(t=this.parentThatIsA(ListWatcherMorph))&&t.fixLayout()},CellMorph.prototype.update=function(){isSnapObject(this.contents)&&this.version!==this.contents.version&&this.drawNew()},CellMorph.prototype.drawNew=function(t,e){var o,i,r,n=SyntaxElementMorph.prototype.fontSize,s=this.contentsMorph instanceof ListWatcherMorph&&this.contentsMorph.list===this.contents,a=this.contentsMorph instanceof TableFrameMorph&&this.contentsMorph.tableMorph.table===this.contents;if(this.isBig&&(n*=1.5),(t||this.contentsMorph&&!s&&!a)&&(this.contentsMorph.destroy(),this.version=null),(t||!s&&!a)&&(this.contents instanceof Morph?isSnapObject(this.contents)?(r=this.contents.thumbnail(new Point(40,40)),this.contentsMorph=new Morph,this.contentsMorph.silentSetWidth(r.width),this.contentsMorph.silentSetHeight(r.height),this.contentsMorph.image=r,this.version=this.contents.version):this.contentsMorph=this.contents:isString(this.contents)?(i=500<this.contents.length?this.contents.slice(0,500)+"...":this.contents,this.contentsMorph=new TextMorph(i,n,null,!0,!1,"left"),this.isEditable&&(this.contentsMorph.isEditable=!0,this.contentsMorph.enableSelecting()),this.contentsMorph.setColor(new Color(255,255,255))):"boolean"==typeof this.contents?(r=SpriteMorph.prototype.booleanMorph.call(null,this.contents).fullImage(),this.contentsMorph=new Morph,this.contentsMorph.silentSetWidth(r.width),this.contentsMorph.silentSetHeight(r.height),this.contentsMorph.image=r):this.contents instanceof HTMLCanvasElement?(this.contentsMorph=new Morph,this.contentsMorph.silentSetWidth(this.contents.width),this.contentsMorph.silentSetHeight(this.contents.height),this.contentsMorph.image=this.contents):this.contents instanceof Context?(r=this.contents.image(),this.contentsMorph=new Morph,this.contentsMorph.silentSetWidth(r.width),this.contentsMorph.silentSetHeight(r.height),this.contentsMorph.image=r):this.contents instanceof Costume?(r=this.contents.thumbnail(new Point(40,40)),this.contentsMorph=new Morph,this.contentsMorph.silentSetWidth(r.width),this.contentsMorph.silentSetHeight(r.height),this.contentsMorph.image=r):this.contents instanceof List?("table"===e||!t&&this.contents.isTable()?(this.contentsMorph=new TableFrameMorph(new TableMorph(this.contents,10)),this.contentsMorph.expand(new Point(200,150))):this.isCircular()?(this.contentsMorph=new TextMorph("(...)",n,null,!1,!0,"center"),this.contentsMorph.setColor(new Color(255,255,255))):this.contentsMorph=new ListWatcherMorph(this.contents,this),this.contentsMorph.isDraggable=!1):(this.contentsMorph=new TextMorph(isNil(this.contents)?"":this.contents.toString(),n,null,!0,!1,"center"),this.isEditable&&(this.contentsMorph.isEditable=!0,this.contentsMorph.enableSelecting()),this.contentsMorph.setColor(new Color(255,255,255))),this.add(this.contentsMorph)),this.silentSetHeight(this.contentsMorph.height()+this.edge+2*this.border),this.silentSetWidth(Math.max(this.contentsMorph.width()+2*this.edge,this.contents instanceof Context||this.contents instanceof List?0:3.5*SyntaxElementMorph.prototype.fontSize)),this.image=newCanvas(this.extent()),o=this.image.getContext("2d"),0===this.edge&&0===this.border)return BoxMorph.uber.drawNew.call(this),null;o.fillStyle=this.color.toString(),o.beginPath(),this.outlinePath(o,Math.max(this.edge-this.border,0),this.border),o.closePath(),o.fill(),0<this.border&&!MorphicPreferences.isFlat&&(o.lineWidth=this.border,o.strokeStyle=this.borderColor.toString(),o.beginPath(),this.outlinePath(o,this.edge,this.border/2),o.closePath(),o.stroke(),o.shadowOffsetX=this.border,o.shadowOffsetY=this.border,o.shadowBlur=this.border,o.shadowColor=this.color.darker(80).toString(),this.drawShadow(o,this.edge,this.border/2)),(t||!s&&!a)&&this.contentsMorph.setCenter(this.center())},CellMorph.prototype.drawShadow=function(t,e,o){var i=e+o,r=this.width(),n=this.height();t.beginPath(),t.moveTo(0,n-i),t.lineTo(0,i),t.stroke(),t.beginPath(),t.arc(i,i,e,radians(-180),radians(-90),!1),t.stroke(),t.beginPath(),t.moveTo(i,0),t.lineTo(r-i,0),t.stroke()},CellMorph.prototype.layoutChanged=function(){SyntaxElementMorph.prototype.fontSize;var t,e=this.parentThatIsA(ListWatcherMorph);if(this.isBig&&1.5,this.silentSetHeight(this.contentsMorph.height()+this.edge+2*this.border),this.silentSetWidth(Math.max(this.contentsMorph.width()+2*this.edge,this.contents instanceof Context||this.contents instanceof List?0:2*this.height())),this.image=newCanvas(this.extent()),t=this.image.getContext("2d"),0===this.edge&&0===this.border)return BoxMorph.uber.drawNew.call(this),null;t.fillStyle=this.color.toString(),t.beginPath(),this.outlinePath(t,Math.max(this.edge-this.border,0),this.border),t.closePath(),t.fill(),0<this.border&&!MorphicPreferences.isFlat&&(t.lineWidth=this.border,t.strokeStyle=this.borderColor.toString(),t.beginPath(),this.outlinePath(t,this.edge,this.border/2),t.closePath(),t.stroke(),t.shadowOffsetX=this.border,t.shadowOffsetY=this.border,t.shadowBlur=this.border,t.shadowColor=this.color.darker(80).toString(),this.drawShadow(t,this.edge,this.border/2)),this.contentsMorph.setCenter(this.center()),e&&e.fixLayout()},CellMorph.prototype.reactToEdit=function(t){var e;isNil(this.idx)||(e=this.parentThatIsA(ListWatcherMorph))&&e.list.put(t.text,this.idx)},CellMorph.prototype.mouseClickLeft=function(t){this.isEditable&&this.contentsMorph instanceof TextMorph?this.contentsMorph.selectAllAndEdit():this.escalateEvent("mouseClickLeft",t)},CellMorph.prototype.mouseDoubleClick=function(t){List.prototype.enableTables&&this.currentValue instanceof List?new TableDialogMorph(this.contents).popUp(this.world()):this.escalateEvent("mouseDoubleClick",t)},WatcherMorph.prototype=new BoxMorph,WatcherMorph.prototype.constructor=WatcherMorph,WatcherMorph.uber=BoxMorph.prototype,WatcherMorph.prototype.init=function(t,e,o,i,r){this.labelText=t||"",this.version=null,this.objName="",WatcherMorph.uber.init.call(this,SyntaxElementMorph.prototype.rounding,1.000001,new Color(120,120,120)),this.color=new Color(220,220,220),this.readoutColor=e,this.style="normal",this.target=o||null,this.getter=i||null,this.currentValue=null,this.labelMorph=null,this.sliderMorph=null,this.cellMorph=null,this.isDraggable=!0,this.fixLayout(),this.update(),r&&this.hide()},WatcherMorph.prototype.isTemporary=function(){var t=this.parentThatIsA(StageMorph);return this.target instanceof VariableFrame&&((!t||this.target!==t.variables.parentFrame)&&null===this.target.owner)},WatcherMorph.prototype.object=function(){return this.target instanceof VariableFrame?this.target.owner:this.target},WatcherMorph.prototype.isGlobal=function(t){return contains(["getLastAnswer","getLastMessage","getTempo","getTimer","reportMouseX","reportMouseY","reportThreadCount"],t)},WatcherMorph.prototype.setSliderMin=function(t,e){this.target instanceof VariableFrame&&(this.sliderMorph.setSize(1,e),this.sliderMorph.setStart(t,e),this.sliderMorph.setSize(this.sliderMorph.rangeSize()/5,e))},WatcherMorph.prototype.setSliderMax=function(t,e){this.target instanceof VariableFrame&&(this.sliderMorph.setSize(1,e),this.sliderMorph.setStop(t,e),this.sliderMorph.setSize(this.sliderMorph.rangeSize()/5,e))},WatcherMorph.prototype.update=function(){var t;if(this.target&&this.getter){if(this.updateLabel(),this.target instanceof VariableFrame)if(void 0===(t=this.target.vars[this.getter]?this.target.vars[this.getter].value:void 0)&&this.target.owner){if(!contains(this.target.owner.inheritedVariableNames(),this.getter))return void this.destroy();t=this.target.getVar(this.getter),this.cellMorph.setColor(SpriteMorph.prototype.blockColor.variables.lighter(35))}else this.cellMorph.setColor(SpriteMorph.prototype.blockColor.variables);else t=this.target[this.getter]();""===t||isNil(t)||"boolean"==typeof t||isNaN(+t)||(t=Math.round(1e9*t)/1e9),t!==this.currentValue&&(this.changed(),this.cellMorph.contents=t,this.cellMorph.drawNew(),isNaN(t)||(this.sliderMorph.value=t,this.sliderMorph.drawNew()),this.fixLayout(),this.currentValue=t)}this.cellMorph.contentsMorph instanceof ListWatcherMorph?this.cellMorph.contentsMorph.update():isSnapObject(this.cellMorph.contents)&&this.cellMorph.update()},WatcherMorph.prototype.updateLabel=function(){var t=this.object();t&&!this.isGlobal(this.getter)&&t.version!==this.version&&(this.objName=t.name?t.name+" ":" ",this.labelMorph&&(this.labelMorph.destroy(),this.labelMorph=null,this.fixLayout()))},WatcherMorph.prototype.fixLayout=function(){var t,e=SyntaxElementMorph.prototype.fontSize,o=this;if(this.changed(),null===this.labelMorph&&(this.labelMorph=new StringMorph(this.objName+this.labelText,e,null,!0,!1,!1,MorphicPreferences.isFlat?new Point:new Point(1,1),new Color(255,255,255)),this.add(this.labelMorph)),null===this.cellMorph&&(this.cellMorph=new CellMorph("",this.readoutColor),this.add(this.cellMorph)),null===this.sliderMorph&&(this.sliderMorph=new SliderMorph(0,100,0,20,"horizontal"),this.sliderMorph.alpha=1,this.sliderMorph.button.color=this.color.darker(),this.sliderMorph.color=this.color.lighter(60),this.sliderMorph.button.highlightColor=this.color.darker(),this.sliderMorph.button.highlightColor.b+=50,this.sliderMorph.button.pressColor=this.color.darker(),this.sliderMorph.button.pressColor.b+=100,this.sliderMorph.setHeight(e),this.sliderMorph.action=function(t){o.target.setVar(o.getter,Math.round(t),o.target.owner)},this.add(this.sliderMorph)),(t=this.cellMorph.contents instanceof List)&&(this.style="normal"),"large"===this.style)return this.labelMorph.hide(),this.sliderMorph.hide(),this.cellMorph.big(),this.cellMorph.setPosition(this.position()),void this.setExtent(this.cellMorph.extent().subtract(1));this.labelMorph.show(),this.sliderMorph.show(),this.cellMorph.normal(),this.labelMorph.setPosition(this.position().add(new Point(this.edge,this.border+SyntaxElementMorph.prototype.typeInPadding))),t?this.cellMorph.setPosition(this.labelMorph.bottomLeft().add(new Point(0,SyntaxElementMorph.prototype.typeInPadding))):(this.cellMorph.setPosition(this.labelMorph.topRight().add(new Point(e/3,0))),this.labelMorph.setTop(this.cellMorph.top()+(this.cellMorph.height()-this.labelMorph.height())/2)),"slider"===this.style?(this.sliderMorph.silentSetPosition(new Point(this.labelMorph.left(),this.cellMorph.bottom()+SyntaxElementMorph.prototype.typeInPadding)),this.sliderMorph.setWidth(this.cellMorph.right()-this.labelMorph.left()),this.silentSetHeight(this.cellMorph.height()+this.sliderMorph.height()+2*this.border+3*SyntaxElementMorph.prototype.typeInPadding)):(this.sliderMorph.hide(),this.bounds.corner.y=this.cellMorph.bottom()+this.border+SyntaxElementMorph.prototype.typeInPadding),this.bounds.corner.x=Math.max(this.cellMorph.right(),this.labelMorph.right())+this.edge+SyntaxElementMorph.prototype.typeInPadding,this.drawNew(),this.changed()},WatcherMorph.prototype.mouseDoubleClick=function(t){List.prototype.enableTables&&this.currentValue instanceof List?new TableDialogMorph(this.currentValue).popUp(this.world()):this.escalateEvent("mouseDoubleClick",t)},WatcherMorph.prototype.userMenu=function(){var t,e=this,o=this.parentThatIsA(IDE_Morph),i=16===this.world().currentKey,n=new MenuMorph(this);if(!o||!o.isAppMode)return n.addItem(("normal"===this.style?"●":"○")+" "+localize("normal"),"styleNormal"),n.addItem(("large"===this.style?"●":"○")+" "+localize("large"),"styleLarge"),this.target instanceof VariableFrame&&(n.addItem(("slider"===this.style?"●":"○")+" "+localize("slider"),"styleSlider"),n.addLine(),n.addItem("slider min...","userSetSliderMin"),n.addItem("slider max...","userSetSliderMax"),n.addLine(),n.addItem("import...","importData"),n.addItem("raw data...",function(){e.importData(!0)},"import without attempting to\nparse or format data"),i&&(this.currentValue instanceof List&&this.currentValue.canBeCSV()&&n.addItem("export as CSV...",function(){e.parentThatIsA(IDE_Morph).saveFileAs(e.currentValue.asCSV(),"text/csv;charset=utf-8",e.getter)},null,new Color(100,0,0)),this.currentValue instanceof List&&this.currentValue.canBeJSON()&&n.addItem("export as JSON...",function(){e.parentThatIsA(IDE_Morph).saveFileAs(e.currentValue.asJSON(!0),"text/json;charset=utf-8",e.getter)},null,new Color(100,0,0))),isString(this.currentValue)||!isNaN(+this.currentValue)?(i&&n.addItem("parse","parseTxt","try to convert\nraw data into a list",new Color(100,0,0)),n.addItem("export...",function(){e.parentThatIsA(IDE_Morph).saveFileAs(e.currentValue.toString(),"text/plain;charset=utf-8",e.getter)})):this.currentValue instanceof List&&this.currentValue.canBeCSV()?n.addItem("export...",function(){e.parentThatIsA(IDE_Morph).saveFileAs(e.currentValue.asCSV(),"text/csv;charset=utf-8",e.getter)}):this.currentValue instanceof List&&this.currentValue.canBeJSON()?n.addItem("export...",function(){e.parentThatIsA(IDE_Morph).saveFileAs(e.currentValue.asJSON(!0),"text/json;charset=utf-8",e.getter)}):this.currentValue instanceof Context&&(t=this.currentValue.outerContext.variables.names()).length&&(n.addLine(),t.forEach(function(t){var o,i,r;o=t,i=e.parentThatIsA(StageMorph),r=e.currentValue.outerContext.variables,n.addItem(o+"...",function(){var t,e=detect(i.children,function(t){return t instanceof WatcherMorph&&t.target===r&&t.getter===o});if(null!==e)return e.show(),void e.fixLayout();(e=new WatcherMorph(o+" "+localize("(temporary)"),SpriteMorph.prototype.blockColor.variables,r,o)).setPosition(i.position().add(10)),0<(t=i.watchers(e.left())).length&&e.setTop(t[t.length-1].bottom()),i.add(e),e.fixLayout()})}))),n},WatcherMorph.prototype.setStyle=function(t){this.style=t,this.fixLayout()},WatcherMorph.prototype.styleNormal=function(){this.setStyle("normal")},WatcherMorph.prototype.styleLarge=function(){this.setStyle("large")},WatcherMorph.prototype.styleSlider=function(){this.setStyle("slider")},WatcherMorph.prototype.userSetSliderMin=function(){new DialogBoxMorph(this,this.setSliderMin,this).prompt("Slider minimum value",this.sliderMorph.start.toString(),this.world(),null,null,null,!0)},WatcherMorph.prototype.userSetSliderMax=function(){new DialogBoxMorph(this,this.setSliderMax,this).prompt("Slider maximum value",this.sliderMorph.stop.toString(),this.world(),null,null,null,!0)},WatcherMorph.prototype.drawNew=function(){var t,e;this.image=newCanvas(this.extent()),t=this.image.getContext("2d"),MorphicPreferences.isFlat||0===this.edge&&0===this.border?BoxMorph.uber.drawNew.call(this):((e=t.createLinearGradient(0,0,0,this.height())).addColorStop(0,this.color.lighter().toString()),e.addColorStop(1,this.color.darker().toString()),t.fillStyle=e,t.beginPath(),this.outlinePath(t,Math.max(this.edge-this.border,0),this.border),t.closePath(),t.fill(),0<this.border&&((e=t.createLinearGradient(0,0,0,this.height())).addColorStop(0,this.borderColor.lighter().toString()),e.addColorStop(1,this.borderColor.darker().toString()),t.lineWidth=this.border,t.strokeStyle=e,t.beginPath(),this.outlinePath(t,this.edge,this.border/2),t.closePath(),t.stroke()))},StagePrompterMorph.prototype=new BoxMorph,StagePrompterMorph.prototype.constructor=StagePrompterMorph,StagePrompterMorph.uber=BoxMorph.prototype,StagePrompterMorph.prototype.init=function(t){var e=this;this.isDone=!1,this.label=t?new StringMorph(t,SpriteMorph.prototype.bubbleFontSize,null,SpriteMorph.prototype.bubbleFontIsBold,!1,"left"):null,this.inputField=new InputFieldMorph,this.button=new PushButtonMorph(null,function(){e.accept()},"✓"),StagePrompterMorph.uber.init.call(this,SyntaxElementMorph.prototype.rounding,SpriteMorph.prototype.bubbleBorder,SpriteMorph.prototype.blockColor.sensing),this.color=new Color(255,255,255),this.label&&this.add(this.label),this.add(this.inputField),this.add(this.button),this.setWidth(StageMorph.prototype.dimensions.x-20),this.fixLayout()},StagePrompterMorph.prototype.fixLayout=function(){var t=0;this.label&&(this.label.setPosition(new Point(this.left()+this.edge,this.top()+this.edge)),t=this.label.bottom()-this.top()),this.inputField.setPosition(new Point(this.left()+this.edge,this.top()+t+this.edge)),this.inputField.setWidth(this.width()-2*this.edge-this.button.width()-this.border),this.button.setCenter(this.inputField.center()),this.button.setLeft(this.inputField.right()+this.border),this.setHeight(this.inputField.bottom()-this.top()+this.edge)},StagePrompterMorph.prototype.mouseClickLeft=function(){this.inputField.edit()},StagePrompterMorph.prototype.accept=function(){this.isDone=!0},ReplayControls.prototype=new Morph,ReplayControls.prototype.buttonColor=new Color(200,200,200),ReplayControls.prototype.constructor=ReplayControls,ReplayControls.uber=Morph.prototype,ReplayControls.prototype.init=function(){var e,i=this;ReplayControls.uber.init.call(this),this.alpha=0,this.actions=null,this.actionIndex=-1,this.actionTime=0,this.isApplyingAction=!1,this.isPlaying=!1,this.maxGapDuration=12e4,this.gapFolds=[],this.isShowingCaptions=!1,this.lastCaption=null,this.replaySpeed=1,this.maxInactiveDuration=0,this.playButton=new SymbolMorph("pointRight",40,this.buttonColor),this.playButton.mouseClickLeft=function(){i.play()},this.stepForwardButton=new SymbolMorph("stepForward",17,this.buttonColor),this.stepForwardButton.mouseClickLeft=function(){i.stepForward()},this.stepBackwardButton=new SymbolMorph("stepBackward",17,this.buttonColor),this.stepBackwardButton.mouseClickLeft=function(){i.stepBackward()},this.jumpBackwardButton=new SymbolMorph("jumpBackward",20,this.buttonColor),this.jumpBackwardButton.mouseClickLeft=function(){i.jumpToBeginning()},this.jumpForwardButton=new SymbolMorph("jumpForward",20,this.buttonColor),this.jumpForwardButton.mouseClickLeft=function(){i.jumpToEnd()},this.displayTime=new TextMorph("0:00 / 1:00",1.5*PushButtonMorph.prototype.fontSize,PushButtonMorph.prototype.fontStyle,!0),this.displayTime.color=this.buttonColor,this.settingsButton=new SymbolMorph("gears",30,this.buttonColor),this.settingsButton.mouseClickLeft=function(){var t=this.world(),e=i.settingsMenu(),o=t.hand.position().subtract(e.extent());e.popup(t,o)},this.captionsButton=new SymbolMorph("speechBubble",30,this.buttonColor),this.captionsButton.mouseClickLeft=function(){i.toggleCaptions()},this.slider=new SliderMorph(0,100,0,1,"horizontal"),this.slider.start=0,this.slider.value=0,e=this.slider.mouseDownLeft,this.slider.mouseDownLeft=function(t){i.pause(),e.call(this,t)};var t=this.slider.updateValue;this.slider.updateValue=function(){t.apply(this,arguments),i.updateDisplayTime()},this.add(this.slider),this.add(this.playButton),this.add(this.stepForwardButton),this.add(this.jumpForwardButton),this.add(this.jumpBackwardButton),this.add(this.stepBackwardButton),this.add(this.displayTime),this.add(this.captionsButton),this.add(this.settingsButton),this.update()},ReplayControls.prototype.settingsMenu=function(){var h=this,t=new MenuMorph(this),e=new MenuMorph(this),o={slow:.5,normal:1,"slightly faster":3,fast:5,"really fast":10,"ludicrous speed":20},i={"1 minute":6e4,"2 minute":12e4,"5 minutes":3e5,"10 minutes":6e5,"20 minutes":12e5},r=function(i,r,n){var s=new MenuMorph(h),a=n.skip||[];return Object.keys(i).forEach(function(t){var e=i[t],o=contains(a,t);delete i[t],t=o?localize(t):localize(t)+" ("+e+n.suffix+")",i[t]=e,s.addItem(o?t:e+n.suffix,function(){if(h[r]=e,n.refresh){var t=h.getTimeFromPosition(h.slider.value);h.setActions(h.actions),h.slider.value=h.getSliderPositionFromTime(t),h.slider.drawNew(),h.updateDisplayTime()}},null,null,h[r]===e)}),s};return t.addMenu("Max inactive duration...",r({"no acceleration":0,tiny:.5,small:1,medium:2,long:5},"maxInactiveDuration",{suffix:"s",skip:["no acceleration"]})),(e=r(o,"replaySpeed",{suffix:"x"})).addItem("other...",function(){new DialogBoxMorph(null,function(t){h.replaySpeed=Math.max(+t,0)||1}).withKey("replaySpeed").prompt("Replay Speed",h.replaySpeed.toString(),h.world(),null,o,!1,!0)}),t.addMenu("Replay speed...",e),t.addMenu("Auto-condense gap size...",r(i,"maxGapDuration",{skip:Object.keys(i),refresh:!0})),t.drawNew(),t},ReplayControls.prototype.toggleCaptions=function(){var t,e=this.parentThatIsA(IDE_Morph);this.isShowingCaptions=!this.isShowingCaptions,t=this.isShowingCaptions?new Color(98,194,19):this.buttonColor,e.showMessage(localize("captions "+(this.isShowingCaptions?"enabled":"disabled")),1),this.lastCaption&&(this.lastCaption.destroy(),this.lastCaption=null),this.captionsButton.color=t,this.captionsButton.drawNew(),this.captionsButton.changed()},ReplayControls.prototype.jumpToBeginning=function(){var t=this.slider.start;this.slider.button.setLeft(this.getSliderLeftFromValue(t)),this.slider.updateValue()},ReplayControls.prototype.jumpToEnd=function(){var t=this.slider.stop;this.slider.button.setLeft(this.getSliderLeftFromValue(t)),this.slider.updateValue()},ReplayControls.prototype.stepForward=function(){this.pause(),this.playNext()},ReplayControls.prototype.stepBackward=function(){this.pause(),this.playNext(-1)},ReplayControls.prototype.displayCaption=function(t,e){var o,i,r;o=t.type,t.replayType===UndoManager.UNDO?(e===t&&(e=this.getInverseEvent(t)),o=e.type+" (undo)"):t.replayType===UndoManager.REDO&&(o+=" (redo)"),r=new MenuMorph(null,o,null,16);var n=new Point(this.center().x,this.top()-50),s=this.world();return this.lastCaption&&this.lastCaption.destroy(),r.drawNew(),r.setPosition(n),r.addShadow(new Point(2,2),80),r.keepWithin(s),s.add(r),r.world=s,r.fullChanged(),this.lastCaption=r,i=setInterval(function(){r.destroy(),clearInterval(i)},4e3),r},ReplayControls.prototype.getCaptionFor=function(t){return t.type},ReplayControls.prototype.play=function(){var t=this;this.isAtEnd()||(this.isPlaying=!0,this.lastPlayUpdate=Date.now(),this.removeChild(this.playButton),this.playButton=new SymbolMorph("pause",40,this.buttonColor),this.playButton.mouseClickLeft=function(){t.pause()},this.add(this.playButton),this.fixLayout())},ReplayControls.prototype.isAtEnd=function(){return this.actionIndex===this.actions.length-1},ReplayControls.prototype.getSliderLeftFromValue=function(t){return(t-this.slider.start)*this.slider.unitSize()+this.slider.left()},ReplayControls.prototype.step=function(){if(this.isPlaying){var t,e,o=Date.now(),i=o-this.lastPlayUpdate,r=this.actions[this.actionIndex+1];this.maxInactiveDuration&&r&&(t=r.time-this.slider.value,1e3*this.maxInactiveDuration<t&&(i=r.time-1e3*this.maxInactiveDuration-this.slider.value)),i*=this.replaySpeed,(e=this.slider.value+i)>this.slider.stop&&(e=this.slider.stop,this.pause()),this.slider.button.setLeft(this.getSliderLeftFromValue(e)),this.slider.updateValue(),this.lastPlayUpdate=o}},ReplayControls.prototype.formatTime=function(t){var e,o,i,r,n=function(t,e){for(t=t.toString();t.length<e;)t="0"+t;return t};return 36e5<t&&(t-=36e5*(i=Math.floor(t/36e5))),t-=6e4*(o=Math.floor(t/6e4)),t-=1e3*(e=Math.floor(t/1e3)),e=n(e,2),i?(o=n(o,2),24<i?[r=Math.floor(i/24),i-=24*r,o,e].join(":"):[i,o,e].join(":")):[o,e].join(":")},ReplayControls.prototype.updateDisplayTime=function(){var t=this.actions[this.actions.length-1].time-this.actions[0].time,e=this.getTimeFromPosition(this.slider.value)-this.getTimeFromPosition(this.slider.start);this.displayTime.text=this.formatTime(e)+" / "+this.formatTime(t),this.displayTime.drawNew(),this.displayTime.changed()},ReplayControls.prototype.playNext=function(t){var e,o;t=t||1,(e=this.actions[this.actionIndex+Math.max(t,0)])&&(o=this.getSliderPosition(e)+t,this.slider.button.setLeft(this.getSliderLeftFromValue(o)),this.slider.updateValue()),this.pause()},ReplayControls.prototype.pause=function(){var t=this;this.removeChild(this.playButton),this.playButton=new SymbolMorph("pointRight",40,this.buttonColor),this.playButton.mouseClickLeft=function(){t.play()},this.add(this.playButton),this.fixLayout(),this.isPlaying=!1},ReplayControls.prototype.fixLayout=function(){var t,e=this.center(),o=(this.bottom(),this.top()),i=this.width();t=this.height()-45,this.playButton.size=t,this.playButton.setTop(o+15+10),this.playButton.drawNew(),this.jumpBackwardButton.setCenter(this.playButton.center()),this.stepBackwardButton.setCenter(this.playButton.center()),this.jumpBackwardButton.setLeft(this.left()+25),this.jumpBackwardButton.drawNew(),this.stepBackwardButton.setLeft(this.jumpBackwardButton.right()+15),this.stepBackwardButton.drawNew(),this.playButton.setLeft(this.stepBackwardButton.right()+20),this.playButton.drawNew(),this.stepForwardButton.setCenter(this.playButton.center()),this.stepForwardButton.setLeft(this.playButton.right()+20),this.stepForwardButton.drawNew(),this.jumpForwardButton.setCenter(this.stepForwardButton.center()),this.jumpForwardButton.setLeft(this.stepForwardButton.right()+15),this.jumpForwardButton.drawNew(),this.displayTime.setCenter(this.playButton.center()),this.displayTime.setLeft(this.jumpForwardButton.right()+40),this.displayTime.drawNew(),this.settingsButton.setTop(o+15+10),this.settingsButton.setRight(this.right()-30),this.settingsButton.drawNew(),this.captionsButton.setTop(o+15+10),this.captionsButton.setRight(this.settingsButton.left()-10),this.captionsButton.drawNew(),this.slider.setWidth(i-20),this.slider.setHeight(15),this.slider.setCenter(new Point(e.x,0)),this.slider.setTop(o),this.slider.drawNew(),this.slider.changed()},ReplayControls.prototype.enable=function(){this.enabled=!0,this.show()},ReplayControls.prototype.disable=function(){this.enabled=!1,this.actions=null,this.isPlaying=!1,this.lastCaption&&this.lastCaption.destroy(),this.hide()},ReplayControls.prototype.getCurrentHistory=function(){return this.actions.slice(0,this.actionIndex+1)},ReplayControls.prototype.getSliderPosition=function(t){return this.getSliderPositionFromTime(t.time)},ReplayControls.prototype.getSliderPositionFromTime=function(t){for(var e=0,o=this.gapFolds.length;o--;)this.gapFolds[o][1]<=t&&(e+=this.gapFolds[o][1]-this.gapFolds[o][0]);return t-e},ReplayControls.prototype.getTimeFromPosition=function(t){for(var e=0;e<this.gapFolds.length;e++)this.gapFolds[e][0]<=t&&(t+=this.gapFolds[e][1]-this.gapFolds[e][0]);return t},ReplayControls.prototype.computeGapFolds=function(){for(var t,e,o=[],i=1;i<this.actions.length;i++)0<this.actions[i].time-this.actions[i-1].time-this.maxGapDuration&&(t=this.actions[i-1].time+this.maxGapDuration/2,e=this.actions[i].time-this.maxGapDuration/2,o.push([t,e]));this.gapFolds=o},ReplayControls.prototype.setActions=function(t,e){var o,i,r;for(this.slider.clearTicks(),this.isPlaying=!1,this.actions=t,this.computeGapFolds(),r=this.gapFolds.length;r--;)this.slider.addTick(this.getSliderPositionFromTime(this.gapFolds[r][0]),this.color.lighter(),4),this.slider.addTick(this.getSliderPositionFromTime(this.gapFolds[r][1]),this.color.lighter(),4);for(i=this.actions[this.actions.length-1].time,o=this.getSliderPosition(this.actions[this.actions.length-1])+1,this.slider.start=this.getSliderPosition(this.actions[0])-1,e?(this.slider.value=o,this.actionIndex=this.actions.length-1,this.actionTime=i):(this.actionIndex=-1,this.slider.value=this.slider.start),this.slider.setStop(o),r=0;r<this.actions.length;r++)this.slider.addTick(this.getSliderPosition(this.actions[r]),this.getColorForTick(this.actions[r]));this.slider.drawNew(),this.updateDisplayTime()},ReplayControls.prototype.getColorForTick=function(){return null},ReplayControls.prototype.update=function(){var t,e,o,i,r=this,n=this.getTimeFromPosition(this.slider.value);if(!this.enabled)return setTimeout(this.update.bind(this),100);if(this.actionTime!==n&&this.actions&&!this.isApplyingAction){if(1===(o=(e=n-this.actionTime)/Math.abs(e))){if(t=this.actions[this.actionIndex+1],i=copy(t),!t||t.time>=n)return setTimeout(this.update.bind(this),100)}else{if(!(t=this.actions[this.actionIndex])||t.time<=n)return setTimeout(this.update.bind(this),100);i=this.getInverseEvent(t)}if("openProject"===i.type&&!i.replayType&&i.args.length<2){var s=this.parentThatIsA(IDE_Morph),a=s.serializer.serialize(s.stage);0===i.args.length&&i.args.push(null),i.args.push(a)}this.isApplyingAction=!0,i.isReplay=!0,this.actionIndex+=o,this.actionTime=t.time,this.applyEvent(i,function(){r.isApplyingAction=!1,r.isShowingCaptions&&r.displayCaption(i,t),setTimeout(r.update.bind(r),10)},o)}else setTimeout(this.update.bind(this),100)},ReplayControls.prototype.applyEvent=function(e,o,i){if(e.isUserAction)return o();var t,r,n,s,a=this,h=this.parentThatIsA(IDE_Morph);return e.owner&&(r=(t=e.owner.split("/"))[0],n=t[1],(s=SnapActions.getOwnerFromId(r))&&(h.selectSprite(s),h.spriteBar.tabBar.tabTo(n))),SnapActions.applyEvent(e).then(o).catch(function(t){a.onReplayError(t,e,i),o()})},ReplayControls.prototype.onReplayError=function(t,e,o){var i=1===o?"apply":"revert",r=".";e&&(r=" "+localize("when trying to ")+e.type),t&&(r+=":\n\n"+t.message);var n=localize("Something went wrong")+r+"\n\n"+localize("The error has been reported. Reloading the page is recommended.");this.pause(),(new DialogBoxMorph).inform(localize("Could not "+i+" action"),n,this.world()),console.error("Could not apply event: "+JSON.stringify(e,null,2)),console.error(t)},ReplayControls.prototype.getInverseEvent=function(t){if(!t.replayType){var e=SnapUndo.getInverseEvent(t);return e.replayType=UndoManager.UNDO,e.owner=t.owner,e}for(var o,i=0,r=this.actionIndex;r--;)if((o=this.actions[r]).replayType=o.replayType||0,o.owner===t.owner){if(t.replayType===o.replayType+1&&0===i)return this.actions[r];o.replayType===t.replayType?i--:i++}},modules.gui="2017-April-23";var SERVER_URL=SERVER_URL||window.location.origin,SERVER_ADDRESS=SERVER_URL.replace(/^.*\/\//,""),PaintEditorMorph,PaintCanvasMorph,PaintColorPickerMorph,List,ListWatcherMorph,CustomBlockDefinition,CustomCommandBlockMorph,CustomReporterBlockMorph,BlockDialogMorph,BlockEditorMorph,PrototypeHatBlockMorph,BlockLabelFragment,BlockLabelFragmentMorph,BlockInputFragmentMorph,BlockLabelPlaceHolderMorph,InputSlotDialogMorph,VariableDialogMorph,JaggedBlockMorph,BlockExportDialogMorph,BlockImportDialogMorph,BlockRemovalDialogMorph,Table,TableCellMorph,TableMorph,TableFrameMorph,ReadStream,XML_Element,SnapSerializer,Cloud;function ensureFullUrl(t){return null===t.match(/^\w+:\/\//)&&(t="/"===t.substring(0,1)[0]?SERVER_URL+t:SERVER_URL+"/"+t),t}function IDE_Morph(t){this.init(t)}function ProjectDialogMorph(t,e){this.init(t,e)}function LibraryImportDialogMorph(t,e){this.init(t,e)}function SpriteIconMorph(t,e){this.init(t,e)}function CostumeIconMorph(t,e){this.init(t,e)}function TurtleIconMorph(t,e){this.init(t,e)}function WardrobeMorph(t,e){this.init(t,e)}function SoundIconMorph(t,e){this.init(t,e)}function JukeboxMorph(t,e){this.init(t,e)}function StageHandleMorph(t){this.init(t)}function PaletteHandleMorph(t){this.init(t)}function PaintEditorMorph(){this.init()}function PaintColorPickerMorph(t,e){this.init(t,e)}function PaintCanvasMorph(t){this.init(t)}function List(t){this.contents=t||[],this.first=null,this.rest=null,this.isLinked=!1,this.lastChanged=Date.now()}function ListWatcherMorph(t,e){this.init(t,e)}function CustomBlockDefinition(t,e){this.body=null,this.scripts=[],this.category=null,this.isGlobal=!1,this.type="command",this.spec=t||"",this.declarations={},this.variableNames=[],this.comment=null,this.codeMapping=null,this.codeHeader=null,this.receiver=e||null,this.editorDimensions=null,this.cachedIsRecursive=null}function CustomCommandBlockMorph(t,e){this.init(t,e)}function CustomReporterBlockMorph(t,e,o){this.init(t,e,o)}function JaggedBlockMorph(t){this.init(t)}function BlockDialogMorph(t,e,o){this.init(t,e,o)}function BlockEditorMorph(t,e){this.init(t,e)}function PrototypeHatBlockMorph(t){this.init(t)}function BlockLabelFragment(t){this.labelString=t||"",this.type="%s",this.defaultValue="",this.options="",this.isReadOnly=!1,this.isDeleted=!1}function BlockLabelFragmentMorph(t){this.init(t)}function BlockLabelPlaceHolderMorph(){this.init()}function BlockInputFragmentMorph(t){this.init(t)}function InputSlotDialogMorph(t,e,o,i,r){this.init(t,e,o,i,r)}function VariableDialogMorph(t,e,o){this.init(t,e,o)}function BlockExportDialogMorph(t,e,o){this.init(t,e,o)}function BlockImportDialogMorph(t,e,o){this.init(t,e,o)}function BlockRemovalDialogMorph(t,e){this.init(t,e)}function Table(t,e){this.colCount=+t,this.rowCount=+e,this.colNames=[],this.rowNames=[],this.contents=new Array(+e);for(var o=0;o<e;o+=1)this.contents[o]=new Array(+t);this.lastChanged=Date.now()}function TableCellMorph(t,e,o){this.init(t,e,o)}function TableMorph(t,e,o,i,r,n,s,a,h,l){this.init(t,e,o,i,r,n,s,a,h,l)}function TableFrameMorph(t,e){this.init(t,e)}function TableDialogMorph(t,e,o,i){this.init(t,e,o,i)}function ReadStream(t){this.contents=t||"",this.index=0}function XML_Element(t,e,o){this.init(t,e,o)}function XML_Serializer(){this.contents=[],this.media=[],this.isCollectingMedia=!1,this.dependencies=null}function SnapSerializer(){this.init()}IDE_Morph.prototype=new Morph,IDE_Morph.prototype.constructor=IDE_Morph,IDE_Morph.uber=Morph.prototype,IDE_Morph.prototype.setDefaultDesign=function(){MorphicPreferences.isFlat=!1,SpriteMorph.prototype.paletteColor=new Color(55,55,55),SpriteMorph.prototype.paletteTextColor=new Color(230,230,230),StageMorph.prototype.paletteTextColor=SpriteMorph.prototype.paletteTextColor,StageMorph.prototype.paletteColor=SpriteMorph.prototype.paletteColor,SpriteMorph.prototype.sliderColor=SpriteMorph.prototype.paletteColor.lighter(30),IDE_Morph.prototype.buttonContrast=30,IDE_Morph.prototype.backgroundColor=new Color(40,40,40),IDE_Morph.prototype.frameColor=SpriteMorph.prototype.paletteColor,IDE_Morph.prototype.groupColor=SpriteMorph.prototype.paletteColor.lighter(8),IDE_Morph.prototype.sliderColor=SpriteMorph.prototype.sliderColor,IDE_Morph.prototype.buttonLabelColor=new Color(255,255,255),IDE_Morph.prototype.tabColors=[IDE_Morph.prototype.groupColor.darker(40),IDE_Morph.prototype.groupColor.darker(60),IDE_Morph.prototype.groupColor],IDE_Morph.prototype.rotationStyleColors=IDE_Morph.prototype.tabColors,IDE_Morph.prototype.appModeColor=new Color,IDE_Morph.prototype.scriptsPaneTexture=this.scriptsTexture(),IDE_Morph.prototype.padding=5,SpriteIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor,CostumeIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor,SoundIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor,TurtleIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor},IDE_Morph.prototype.setFlatDesign=function(){MorphicPreferences.isFlat=!0,SpriteMorph.prototype.paletteColor=new Color(255,255,255),SpriteMorph.prototype.paletteTextColor=new Color(70,70,70),StageMorph.prototype.paletteTextColor=SpriteMorph.prototype.paletteTextColor,StageMorph.prototype.paletteColor=SpriteMorph.prototype.paletteColor,SpriteMorph.prototype.sliderColor=SpriteMorph.prototype.paletteColor,IDE_Morph.prototype.buttonContrast=30,IDE_Morph.prototype.backgroundColor=new Color(200,200,200),IDE_Morph.prototype.frameColor=new Color(255,255,255),IDE_Morph.prototype.groupColor=new Color(230,230,230),IDE_Morph.prototype.sliderColor=SpriteMorph.prototype.sliderColor,IDE_Morph.prototype.buttonLabelColor=new Color(70,70,70),IDE_Morph.prototype.tabColors=[IDE_Morph.prototype.groupColor.lighter(60),IDE_Morph.prototype.groupColor.darker(10),IDE_Morph.prototype.groupColor],IDE_Morph.prototype.rotationStyleColors=[IDE_Morph.prototype.groupColor,IDE_Morph.prototype.groupColor.darker(10),IDE_Morph.prototype.groupColor.darker(30)],IDE_Morph.prototype.appModeColor=IDE_Morph.prototype.frameColor,IDE_Morph.prototype.scriptsPaneTexture=null,IDE_Morph.prototype.padding=1,SpriteIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor,CostumeIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor,SoundIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor,TurtleIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor},IDE_Morph.prototype.scriptsTexture=function(){var t,e=newCanvas(new Point(100,100)),o=e.getContext("2d");for(t=0;t<100;t+=4)o.fillStyle=this.frameColor.toString(),o.fillRect(t,0,1,100),o.fillStyle=this.groupColor.lighter(6).toString(),o.fillRect(t+1,0,1,100),o.fillRect(t+3,0,1,100),o.fillStyle=this.groupColor.toString(),o.fillRect(t+2,0,1,100);return e},IDE_Morph.prototype.setDefaultDesign(),IDE_Morph.prototype.init=function(t){MorphicPreferences.globalFontFamily="Helvetica, Arial",this.userLanguage=null,this.projectsInURLs=!1,this.applySavedSettings(),this.cloudMsg=null,this.source="local",this.serializer=new SnapSerializer,this.globalVariables=new VariableFrame,this.currentSprite=new SpriteMorph(this.globalVariables),this.sprites=new List([this.currentSprite]),this.currentCategory="motion",this.currentTab="scripts",this.projectName="",this.projectNotes="",this.logoURL=this.resourceURL("snap_logo_sm.png"),this.logo=null,this.controlBar=null,this.categories=null,this.palette=null,this.paletteHandle=null,this.spriteBar=null,this.spriteEditor=null,this.stage=null,this.stageHandle=null,this.corralBar=null,this.corral=null,this.isAutoFill=void 0===t||t,this.isAppMode=!1,this.isReplayMode=!1,this.preReplayUndoState=null,this.isSmallStage=!1,this.filePicker=null,this.hasChangedMedia=!1,this.isAnimating=!0,this.paletteWidth=200,this.stageRatio=1,this.wasSingleStepping=!1,this.loadNewProject=!1,this.shield=null,this.savingPreferences=!0,IDE_Morph.uber.init.call(this),this.color=this.backgroundColor,this.activeEditor=this},IDE_Morph.prototype.openIn=function(i){var t;this.projectName="myRole",localStorage&&(t=localStorage["-snap-user"])&&(t=SnapCloud.parseSnapResponse(t)[0])&&(SnapCloud.username=t.username||null,SnapCloud.password=t.password||null,SnapCloud.username&&(this.source="cloud")),this.buildPanes(),SnapActions.configure(this),SnapActions.disableCollaboration(),SnapUndo.reset(),i.add(this),i.userMenu=this.userMenu,SnapCloud.message=function(t){var e,o=new MenuMorph(null,t);o.popUpCenteredInWorld(i),e=setInterval(function(){o.destroy(),clearInterval(e)},2e3)},i.reactToDropOf=function(t){t instanceof DialogBoxMorph||(i.hand.grabOrigin?t.slideBackTo(i.hand.grabOrigin):i.hand.grab(t))},this.reactToWorldResize(i.bounds),this.userLanguage?(this.loadNewProject=!0,this.setLanguage(this.userLanguage,this.onOpen)):this.onOpen(),this.initializeEmbeddedAPI(),window.dispatchEvent(new CustomEvent("ideLoaded"))},IDE_Morph.prototype.onOpen=function(){var t=this,e=this.sockets.onConnect,o=-1<location.href.indexOf("?")||location.hash,i=!1;if(o){var r=new MenuMorph(null,"Loading...");r.popUpCenteredInWorld(this.world()),this.sockets.onConnect=function(){r.destroy(),i=!0,t.sockets.onConnect=e,t.interpretUrlAnchors(),t.sockets.onConnect()},setTimeout(function(){i||(r.destroy(),t.interpretUrlAnchors())},750)}else this.interpretUrlAnchors()},IDE_Morph.prototype.interpretUrlAnchors=function(t){var e,o,i,r,n=this;function s(t){try{return utils.getUrlSync(t)}catch(t){return n.showMessage("unable to retrieve project"),""}}function a(t){t.editMode?n.toggleAppMode(!1):n.toggleAppMode(!0),t.noRun||n.runScripts(),t.hideControls&&(n.controlBar.hide(),window.onbeforeunload=nop),t.noExitWarning&&(window.onbeforeunload=nop)}if(t=t||location,i={},-1<t.href.indexOf("?")){var h=t.href.replace(/^.*\?/,"").replace("#"+t.hash,"");i=SnapCloud.parseDict(h)}if("#open:"===t.hash.substr(0,6))("%"===(o=t.hash.substr(6)).charAt(0)||-1<o.search(/\%(?:[0-9a-f]{2})/i))&&(o=decodeURIComponent(o)),contains(["project","blocks","sprites","snapdata"].map(function(t){return o.substr(0,8).indexOf(t)}),1)?this.droppedText(o):this.droppedText(s(o));else if("#run:"===t.hash.substr(0,5))0<(r=(o=t.hash.substr(5)).indexOf("&"))&&(o=o.slice(0,r)),("%"===o.charAt(0)||-1<o.search(/\%(?:[0-9a-f]{2})/i))&&(o=decodeURIComponent(o)),"<project>"===o.substr(0,8)?SnapActions.openProject(o):SnapActions.openProject(s(o)),this.toggleAppMode(!0),this.runScripts();else if("#present:"===t.hash.substr(0,9)||"present"===i.action)this.shield=new Morph,this.shield.color=this.color,this.shield.setExtent(this.parent.extent()),this.parent.add(this.shield),n.showMessage("Fetching project\nfrom the cloud..."),"#present:"===t.hash.substr(0,9)&&(i=SnapCloud.parseDict(t.hash.substr(9))),SnapCloud.getPublicProject(SnapCloud.encodeDict(i),function(e){var o;n.nextSteps([function(){o=n.showMessage("Opening project...")},function(){nop()},function(){var t=n.droppedText(e);t&&t.then(function(){n.hasChangedMedia=!0,n.shield.destroy(),n.shield=null,o.destroy(),a(i)})}])},this.cloudError());else if("#cloud:"===t.hash.substr(0,7))this.shield=new Morph,this.shield.alpha=0,this.shield.setExtent(this.parent.extent()),this.parent.add(this.shield),n.showMessage("Fetching project\nfrom the cloud..."),(i=SnapCloud.parseDict(t.hash.substr(7))).Username=i.Username.toLowerCase(),SnapCloud.getPublicProject(SnapCloud.encodeDict(i),function(t){var e;n.nextSteps([function(){e=n.showMessage("Opening project...")},function(){nop()},function(){SnapActions.openProject(t).then(function(){n.hasChangedMedia=!0,n.shield.destroy(),n.shield=null,e.destroy(),n.toggleAppMode(!1)})}])},this.cloudError());else if("#dl:"===t.hash.substr(0,4))n.showMessage("Fetching project\nfrom the cloud..."),(i=SnapCloud.parseDict(t.hash.substr(4))).Username=i.Username.toLowerCase(),SnapCloud.getPublicProject(SnapCloud.encodeDict(i),function(t){window.open("data:text/xml,"+t)},this.cloudError());else if("#lang:"===t.hash.substr(0,6))e=t.hash.substr(6),this.setLanguage(e),this.loadNewProject=!0;else if("#signup"===t.hash.substr(0,7))this.createCloudAccount();else if("#collaborate"===t.hash.substr(0,12)){var l=t.hash.substr(13);SnapActions.enableCollaboration(),SnapActions.joinSession(l,this.cloudError())}else if("#example:"===t.hash.substr(0,9)||"example"===i.action){var p,c=i?i.ProjectName:t.hash.substr(9);this.shield=new Morph,this.shield.alpha=0,this.shield.setExtent(this.parent.extent()),this.parent.add(this.shield);var u=n.getURL(n.resourceURL("Examples",c));n.nextSteps([function(){p=n.showMessage("Opening "+c+" example...")},function(){nop()},function(){var t=n.droppedText(u);t&&t.then(function(){n.hasChangedMedia=!0,n.shield&&(n.shield.destroy(),n.shield=null),p.destroy(),a(i)})}])}else if("#private:"===t.hash.substr(0,9)||"private"===i.action){var d=i?i.ProjectName:t.hash.substr(9);if(!(null!==SnapCloud.username))return void n.showMessage("You are not logged in. Cannot open "+d);n.nextSteps([function(){p=n.showMessage("Opening "+d+" example...")},function(){nop()},function(){SnapCloud.getProjectByName(SnapCloud.username,i.ProjectName,function(t){p.destroy();var e=n.rawLoadCloudProject(t);e?e.then(function(){a(i)}):a(i)},n.cloudError())}])}else n.newProject()},IDE_Morph.prototype.buildPanes=function(){this.createLogo(),this.createControlBar(),this.createCategories(),this.createPalette(),this.createStage(),this.createSpriteBar(),this.createSpriteEditor(),this.createCorralBar(),this.createCorral(),this.createReplayControls()},IDE_Morph.prototype.createLogo=function(){var o=this;this.logo&&this.logo.destroy(),this.logo=new Morph,this.logo.texture=this.logoURL,this.logo.drawNew=function(){this.image=newCanvas(this.extent());var t=this.image.getContext("2d"),e=t.createLinearGradient(0,0,this.width(),0);e.addColorStop(0,"black"),e.addColorStop(.5,o.frameColor.toString()),t.fillStyle=MorphicPreferences.isFlat?o.frameColor.toString():e,t.fillRect(0,0,this.width(),this.height()),this.texture&&this.drawTexture(this.texture)},this.logo.drawCachedTexture=function(){this.image.getContext("2d").drawImage(this.cachedTexture,5,Math.round((this.height()-this.cachedTexture.height)/2)),this.changed()},this.logo.mouseClickLeft=function(){o.snapMenu()},this.logo.color=new Color,this.logo.setExtent(new Point(200,28)),this.add(this.logo)},IDE_Morph.prototype.mouseClickLeft=function(){this.setActiveEditor()},IDE_Morph.prototype.setActiveEditor=function(t){this.activeEditor!==t&&(this.activeEditor.onUnsetActive(),this.activeEditor=t||this,this.activeEditor.onSetActive())},IDE_Morph.prototype.onSetActive=function(){this.isAppMode?this.spriteEditor.hide():"scripts"===this.currentTab?this.currentSprite.scripts.updateUndoControls():this.spriteEditor.updateUndoControls&&this.spriteEditor.updateUndoControls()},IDE_Morph.prototype.onUnsetActive=function(){"scripts"===this.currentTab?this.currentSprite.scripts.hideUndoControls():this.spriteEditor.hideUndoControls&&this.spriteEditor.hideUndoControls()},IDE_Morph.prototype.getActiveScripts=function(){return this.activeEditor instanceof BlockEditorMorph?this.activeEditor.body.contents:this.currentSprite.scripts},IDE_Morph.prototype.getActiveEntity=function(){return this.activeEditor instanceof BlockEditorMorph?this.activeEditor.definition.id+"/scripts":this.currentSprite.id+"/"+this.currentTab},IDE_Morph.prototype.createControlBar=function(){var t,e,o,i,r,n,s,a,h,l,p,c,u=[this.groupColor,this.frameColor.darker(50),this.frameColor.darker(50)],d=this;this.controlBar&&this.controlBar.destroy(),this.controlBar=new Morph,this.controlBar.color=this.frameColor,this.controlBar.setHeight(this.logo.height()),this.controlBar.mouseClickLeft=function(){this.world().fillPage()},this.add(this.controlBar),(t=new ToggleButtonMorph(null,d,"toggleStageSize",[new SymbolMorph("smallStage",14),new SymbolMorph("normalStage",14)],function(){return d.isSmallStage})).corner=12,t.color=u[0],t.highlightColor=u[1],t.pressColor=u[2],t.labelMinExtent=new Point(36,18),t.padding=0,t.labelShadowOffset=new Point(-1,-1),t.labelShadowColor=u[1],t.labelColor=this.buttonLabelColor,t.contrast=this.buttonContrast,t.drawNew(),t.fixLayout(),t.refresh(),a=t,this.controlBar.add(a),this.controlBar.stageSizeButton=t,(t=new ToggleButtonMorph(null,d,"toggleAppMode",[new SymbolMorph("fullScreen",14),new SymbolMorph("normalScreen",14)],function(){return d.isAppMode})).corner=12,t.color=u[0],t.highlightColor=u[1],t.pressColor=u[2],t.labelMinExtent=new Point(36,18),t.padding=0,t.labelShadowOffset=new Point(-1,-1),t.labelShadowColor=u[1],t.labelColor=this.buttonLabelColor,t.contrast=this.buttonContrast,t.drawNew(),t.fixLayout(),t.refresh(),h=t,this.controlBar.add(h),this.controlBar.appModeButton=h,(t=new ToggleButtonMorph(null,d,"toggleSingleStepping",[new SymbolMorph("footprints",16),new SymbolMorph("footprints",16)],function(){return Process.prototype.enableSingleStepping})).corner=12,t.color=u[0],t.highlightColor=u[1],t.pressColor=new Color(153,255,213),t.labelMinExtent=new Point(36,18),t.padding=0,t.labelShadowOffset=new Point(-1,-1),t.labelShadowColor=u[1],t.labelColor=this.buttonLabelColor,t.contrast=this.buttonContrast,t.drawNew(),t.hint="Visible stepping",t.fixLayout(),t.refresh(),l=t,this.controlBar.add(l),this.controlBar.steppingButton=l,(t=new ToggleButtonMorph(null,this,"stopAllScripts",[new SymbolMorph("octagon",14),new SymbolMorph("square",14)],function(){return!d.stage||d.stage.enableCustomHatBlocks&&d.stage.threads.pauseCustomHatBlocks})).corner=12,t.color=u[0],t.highlightColor=u[1],t.pressColor=u[2],t.labelMinExtent=new Point(36,18),t.padding=0,t.labelShadowOffset=new Point(-1,-1),t.labelShadowColor=u[1],t.labelColor=new Color(200,0,0),t.contrast=this.buttonContrast,t.drawNew(),t.fixLayout(),t.refresh(),o=t,this.controlBar.add(o),this.controlBar.stopButton=o,(t=new ToggleButtonMorph(null,this,"togglePauseResume",[new SymbolMorph("pause",12),new SymbolMorph("pointRight",14)],function(){return d.isPaused()})).corner=12,t.color=u[0],t.highlightColor=u[1],t.pressColor=u[2],t.labelMinExtent=new Point(36,18),t.padding=0,t.labelShadowOffset=new Point(-1,-1),t.labelShadowColor=u[1],t.labelColor=new Color(255,220,0),t.contrast=this.buttonContrast,t.drawNew(),t.fixLayout(),t.refresh(),i=t,this.controlBar.add(i),this.controlBar.pauseButton=i,(t=new PushButtonMorph(this,"pressStart",new SymbolMorph("flag",14))).corner=12,t.color=u[0],t.highlightColor=u[1],t.pressColor=u[2],t.labelMinExtent=new Point(36,18),t.padding=0,t.labelShadowOffset=new Point(-1,-1),t.labelShadowColor=u[1],t.labelColor=new Color(0,200,0),t.contrast=this.buttonContrast,t.drawNew(),t.fixLayout(),r=t,this.controlBar.add(r),this.controlBar.startButton=r,(e=new SliderMorph(61,1,100*Process.prototype.flashTime+1,6,"horizontal")).action=function(t){Process.prototype.flashTime=(t-1)/100,d.controlBar.refreshResumeSymbol()},e.color=new Color(153,255,213),e.alpha=.3,e.setExtent(new Point(50,14)),this.controlBar.add(e),this.controlBar.steppingSlider=e,(t=new PushButtonMorph(this,function(){var t=d.projectMenu(),e=d.controlBar.projectButton.bottomLeft(),o=d.world();t.popup(o,e)},new SymbolMorph("file",14))).corner=12,t.color=u[0],t.highlightColor=u[1],t.pressColor=u[2],t.labelMinExtent=new Point(36,18),t.padding=0,t.labelShadowOffset=new Point(-1,-1),t.labelShadowColor=u[1],t.labelColor=this.buttonLabelColor,t.contrast=this.buttonContrast,t.drawNew(),t.fixLayout(),n=t,this.controlBar.add(n),this.controlBar.projectButton=n,(t=new PushButtonMorph(this,function(){var t=d.settingsMenu(),e=d.controlBar.settingsButton.bottomLeft();t.popup(d.world(),e)},new SymbolMorph("gears",14))).corner=12,t.color=u[0],t.highlightColor=u[1],t.pressColor=u[2],t.labelMinExtent=new Point(36,18),t.padding=0,t.labelShadowOffset=new Point(-1,-1),t.labelShadowColor=u[1],t.labelColor=this.buttonLabelColor,t.contrast=this.buttonContrast,t.drawNew(),t.fixLayout(),s=t,this.controlBar.add(s),this.controlBar.settingsButton=s,(t=new PushButtonMorph(this,function(){var t=d.cloudMenu(),e=d.controlBar.cloudButton.bottomLeft();t.popup(d.world(),e)},new SymbolMorph("cloud",11))).corner=12,t.color=u[0],t.highlightColor=u[1],t.pressColor=u[2],t.labelMinExtent=new Point(36,18),t.padding=0,t.labelShadowOffset=new Point(-1,-1),t.labelShadowColor=u[1],t.labelColor=this.buttonLabelColor,t.contrast=this.buttonContrast,t.drawNew(),t.fixLayout(),p=t,this.controlBar.add(p),this.controlBar.cloudButton=p,this.controlBar.fixLayout=function(){c=this.right()-5,[o,i,r].forEach(function(t){t.setCenter(d.controlBar.center()),t.setRight(c),c-=t.width(),c-=5}),c=Math.min(r.left()-(15+2*a.width()),d.right()-StageMorph.prototype.dimensions.x*(d.isSmallStage?d.stageRatio:1)),[a,h].forEach(function(t){c+=5,t.setCenter(d.controlBar.center()),t.setLeft(c),c+=t.width()}),e.setCenter(d.controlBar.center()),e.setRight(a.left()-5),l.setCenter(d.controlBar.center()),l.setRight(e.left()-5),s.setCenter(d.controlBar.center()),s.setLeft(this.left()),p.setCenter(d.controlBar.center()),p.setRight(s.left()-5),n.setCenter(d.controlBar.center()),n.setRight(p.left()-5),this.refreshSlider(),this.updateLabel()},this.controlBar.refreshSlider=function(){Process.prototype.enableSingleStepping&&!d.isAppMode?(e.drawNew(),e.show()):e.hide(),this.refreshResumeSymbol()},this.controlBar.refreshResumeSymbol=function(){var t;t=Process.prototype.enableSingleStepping&&.5<Process.prototype.flashTime?(d.stage.threads.pauseAll(d.stage),[new SymbolMorph("pause",12),new SymbolMorph("stepForward",14)]):[new SymbolMorph("pause",12),new SymbolMorph("pointRight",14)],i.labelString=t,i.createLabel(),i.fixLayout(),i.refresh()},this.controlBar.updateLabel=function(){var t=d.world().isDevMode?" - "+localize("development mode"):"";this.label&&this.label.destroy(),d.isAppMode||(this.label=new StringMorph((d.projectName||localize("untitled"))+t,14,"sans-serif",!0,!1,!1,MorphicPreferences.isFlat?null:new Point(2,1),d.frameColor.darker(d.buttonContrast)),this.label.color=d.buttonLabelColor,this.label.drawNew(),this.add(this.label),this.label.setCenter(this.center()),this.label.setLeft(this.settingsButton.right()+5))}},IDE_Morph.prototype.createCategories=function(){var e,o,i,r,t,n,s,a,h,l=this;this.categories&&this.categories.destroy(),this.categories=new Morph,this.categories.color=this.groupColor,this.categories.silentSetWidth(this.paletteWidth),SpriteMorph.prototype.categories.forEach(function(t){var e,o,i;contains(["lists","other"],t)||(e=t,i=[l.frameColor,l.frameColor.darker(50),SpriteMorph.prototype.blockColor[e]],(o=new ToggleButtonMorph(i,l,function(){l.currentCategory=e,l.categories.children.forEach(function(t){t.refresh()}),l.refreshPalette(!0)},e[0].toUpperCase().concat(e.slice(1)),function(){return l.currentCategory===e},null,null,null,75,!0)).corner=8,o.padding=0,o.labelShadowOffset=new Point(-1,-1),o.labelShadowColor=i[1],o.labelColor=l.buttonLabelColor,o.fixLayout(),o.refresh(),l.categories.add(o))}),i=l.categories.children[0].width(),r=l.categories.children[0].height(),t=Math.ceil(l.categories.children.length/2),n=(197-2*i)/3,s=l.categories.left(),a=l.categories.top(),h=0,l.categories.children.forEach(function(t){h+=1,e=Math.ceil(h/2),o=2-h%2,t.setPosition(new Point(s+(o*n+(o-1)*i),a+(2*e+(e-1)*r+3)))}),l.categories.setHeight(2*(t+1)+t*r+6),this.add(this.categories)},IDE_Morph.prototype.createPalette=function(t){var o=this;return this.palette&&this.palette.destroy(),this.palette=t?new ScrollFrameMorph(null,null,this.currentSprite.sliderColor):this.currentSprite.palette(this.currentCategory),this.palette.isDraggable=!1,this.palette.acceptsDrops=!0,this.palette.enableAutoScrolling=!1,this.palette.contents.acceptsDrops=!1,this.palette.reactToDropOf=function(t,e){t instanceof DialogBoxMorph?o.world().add(t):t instanceof SpriteMorph?SnapActions.removeSprite(t):t instanceof SpriteIconMorph?(t.destroy(),SnapActions.removeSprite(t.object)):t instanceof CostumeIconMorph?(SnapActions.removeCostume(t.object),t.destroy()):t instanceof SoundIconMorph?(SnapActions.removeSound(t.object),t.destroy()):t.id?SnapActions.removeBlock(t):t.destroy()},this.palette.contents.reactToDropOf=function(t){t instanceof BlockMorph&&t.destroy()},this.palette.setWidth(this.logo.width()),this.add(this.palette),this.isAppMode&&this.palette.hide(),this.palette},IDE_Morph.prototype.createPaletteHandle=function(){this.paletteHandle&&this.paletteHandle.destroy(),this.paletteHandle=new PaletteHandleMorph(this.categories),this.add(this.paletteHandle),this.isAppMode&&this.paletteHandle.hide()},IDE_Morph.prototype.createStage=function(){this.stage&&this.stage.destroy(),StageMorph.prototype.frameRate=0,this.stage=new StageMorph(this.globalVariables),this.stage.setExtent(this.stage.dimensions),this.currentSprite instanceof SpriteMorph&&(this.currentSprite.setPosition(this.stage.center().subtract(this.currentSprite.extent().divideBy(2))),this.stage.add(this.currentSprite)),this.add(this.stage)},IDE_Morph.prototype.createStageHandle=function(){this.stageHandle&&this.stageHandle.destroy(),this.stageHandle=new StageHandleMorph(this.stage),this.add(this.stageHandle)},IDE_Morph.prototype.createSpriteBar=function(){var i,t,e,o,r=[],n=new Point(45,45),s=this.tabColors,a=new AlignmentMorph("row",-30),h=["→","↻","↔"],l=["don't rotate","can rotate","only face left/right"],p=this;function c(t){var e,o=p.rotationStyleColors;return(e=new ToggleButtonMorph(o,p,function(){p.currentSprite instanceof SpriteMorph&&SnapActions.setRotationStyle(p.currentSprite,t)},h[t],function(){return p.currentSprite instanceof SpriteMorph&&p.currentSprite.rotationStyle===t},null,localize(l[t]))).corner=8,e.labelMinExtent=new Point(11,11),e.padding=0,e.labelShadowOffset=new Point(-1,-1),e.labelShadowColor=o[1],e.labelColor=p.buttonLabelColor,e.fixLayout(),e.refresh(),r.push(e),e.setPosition(p.spriteBar.position().add(2)),e.setTop(e.top()+(r.length-1)*(e.height()+2)),p.spriteBar.add(e),p.currentSprite instanceof StageMorph&&e.hide(),e}this.spriteBar&&this.spriteBar.destroy(),this.spriteBar=new Morph,this.spriteBar.color=this.frameColor,this.add(this.spriteBar),c(1),c(2),c(0),this.rotationStyleButtons=r,(e=new Morph).setExtent(n),e.image=this.currentSprite.thumbnail(n),e.setPosition(r[0].topRight().add(new Point(5,3))),this.spriteBar.add(e),e.fps=3,e.step=function(){e.version!==p.currentSprite.version&&(e.image=p.currentSprite.thumbnail(n),e.changed(),e.version=p.currentSprite.version)},(i=new InputFieldMorph(this.currentSprite.name)).setWidth(100),i.contrast=90,i.setPosition(e.topRight().add(new Point(10,3))),this.spriteBar.add(i),i.drawNew(),i.accept=function(){var t=i.getValue(),e=p.currentSprite.name,o=p.newSpriteName(t,p.currentSprite);if(o!==e)return SnapActions.renameSprite(p.currentSprite,o);i.setContents(o)},this.spriteBar.nameField=i,this.spriteBar.reactToEdit=i.accept,(t=new ToggleMorph("checkbox",null,function(){SnapActions.toggleDraggable(p.currentSprite,!p.currentSprite.isDraggable)},localize("draggable"),function(){return p.currentSprite.isDraggable})).label.isBold=!1,t.label.setColor(this.buttonLabelColor),t.color=s[2],t.highlightColor=s[0],t.pressColor=s[1],t.tick.shadowOffset=MorphicPreferences.isFlat?new Point:new Point(-1,-1),t.tick.shadowColor=new Color,t.tick.color=this.buttonLabelColor,t.tick.isBold=!1,t.tick.drawNew(),t.setPosition(i.bottomLeft().add(2)),t.drawNew(),this.spriteBar.add(t),this.spriteBar.padlock=t,this.currentSprite instanceof StageMorph&&t.hide(),a.tabTo=function(t){var e;p.currentTab=t,this.children.forEach(function(t){t.refresh(),t.state&&(e=t)}),e.refresh(),p.createSpriteEditor(),p.fixLayout("tabEditor")},(o=new TabMorph(s,null,function(){SnapActions.selectTab("scripts"),a.tabTo("scripts")},localize("Scripts"),function(){return"scripts"===p.currentTab})).padding=3,o.corner=15,o.edge=1,o.labelShadowOffset=new Point(-1,-1),o.labelShadowColor=s[1],o.labelColor=this.buttonLabelColor,o.drawNew(),o.fixLayout(),a.add(o),(o=new TabMorph(s,null,function(){SnapActions.selectTab("costumes"),a.tabTo("costumes")},localize(this.currentSprite instanceof SpriteMorph?"Costumes":"Backgrounds"),function(){return"costumes"===p.currentTab})).padding=3,o.corner=15,o.edge=1,o.labelShadowOffset=new Point(-1,-1),o.labelShadowColor=s[1],o.labelColor=this.buttonLabelColor,o.drawNew(),o.fixLayout(),a.add(o),(o=new TabMorph(s,null,function(){SnapActions.selectTab("sounds"),a.tabTo("sounds")},localize("Sounds"),function(){return"sounds"===p.currentTab})).padding=3,o.corner=15,o.edge=1,o.labelShadowOffset=new Point(-1,-1),o.labelShadowColor=s[1],o.labelColor=this.buttonLabelColor,o.drawNew(),o.fixLayout(),a.add(o),a.fixLayout(),a.children.forEach(function(t){t.refresh()}),this.spriteBar.tabBar=a,this.spriteBar.add(this.spriteBar.tabBar),this.spriteBar.fixLayout=function(){this.tabBar.setLeft(this.left()),this.tabBar.setBottom(this.bottom())},this.isAppMode&&this.spriteBar.hide()},IDE_Morph.prototype.createSpriteEditor=function(){var t=this.currentSprite.scripts,e=this;this.spriteEditor&&this.spriteEditor.destroy(),"scripts"===this.currentTab?(t.isDraggable=!1,t.color=this.groupColor,t.cachedTexture=this.scriptsPaneTexture,this.spriteEditor=new ScrollFrameMorph(t,null,this.sliderColor),this.spriteEditor.padding=10,this.spriteEditor.growth=50,this.spriteEditor.isDraggable=!1,this.spriteEditor.acceptsDrops=!1,this.spriteEditor.contents.acceptsDrops=!0,t.scrollFrame=this.spriteEditor,this.add(this.spriteEditor),this.spriteEditor.scrollX(this.spriteEditor.padding),this.spriteEditor.scrollY(this.spriteEditor.padding)):"costumes"===this.currentTab?(this.spriteEditor=new WardrobeMorph(this.currentSprite,this.sliderColor),this.spriteEditor.color=this.groupColor,this.add(this.spriteEditor),this.spriteEditor.updateSelection(),this.spriteEditor.acceptsDrops=!1,this.spriteEditor.contents.acceptsDrops=!1):"sounds"===this.currentTab?(this.spriteEditor=new JukeboxMorph(this.currentSprite,this.sliderColor),this.spriteEditor.color=this.groupColor,this.add(this.spriteEditor),this.spriteEditor.updateSelection(),this.spriteEditor.acceptDrops=!1,this.spriteEditor.contents.acceptsDrops=!1):(this.spriteEditor=new Morph,this.spriteEditor.color=this.groupColor,this.spriteEditor.acceptsDrops=!0,this.spriteEditor.reactToDropOf=function(t){t instanceof DialogBoxMorph?e.world().add(t):t instanceof SpriteMorph?e.removeSprite(t):t.destroy()},this.add(this.spriteEditor)),this.activeEditor.onSetActive()},IDE_Morph.prototype.createCorralBar=function(){var t,e,o=[this.groupColor,this.frameColor.darker(50),this.frameColor.darker(50)];this.corralBar&&this.corralBar.destroy(),this.corralBar=new Morph,this.corralBar.color=this.frameColor,this.corralBar.setHeight(this.logo.height()),this.add(this.corralBar),(t=new PushButtonMorph(this,"addNewSprite",new SymbolMorph("turtle",14))).corner=12,t.color=o[0],t.highlightColor=o[1],t.pressColor=o[2],t.labelMinExtent=new Point(36,18),t.padding=0,t.labelShadowOffset=new Point(-1,-1),t.labelShadowColor=o[1],t.labelColor=this.buttonLabelColor,t.contrast=this.buttonContrast,t.drawNew(),t.hint="add a new Turtle sprite",t.fixLayout(),t.setCenter(this.corralBar.center()),t.setLeft(this.corralBar.left()+5),this.corralBar.add(t),(e=new PushButtonMorph(this,"paintNewSprite",new SymbolMorph("brush",15))).corner=12,e.color=o[0],e.highlightColor=o[1],e.pressColor=o[2],e.labelMinExtent=new Point(36,18),e.padding=0,e.labelShadowOffset=new Point(-1,-1),e.labelShadowColor=o[1],e.labelColor=this.buttonLabelColor,e.contrast=this.buttonContrast,e.drawNew(),e.hint="paint a new sprite",e.fixLayout(),e.setCenter(this.corralBar.center()),e.setLeft(this.corralBar.left()+5+t.width()+5),this.corralBar.add(e)},IDE_Morph.prototype.createCorral=function(){var e,o,r=this;this.createStageHandle(),this.createPaletteHandle(),this.corral&&this.corral.destroy(),this.corral=new Morph,this.corral.color=this.groupColor,this.add(this.corral),this.corral.stageIcon=new SpriteIconMorph(this.stage),this.corral.stageIcon.isDraggable=!1,this.corral.add(this.corral.stageIcon),(e=new ScrollFrameMorph(null,null,this.sliderColor)).acceptsDrops=!1,e.contents.acceptsDrops=!1,e.contents.wantsDropOf=function(t){return t instanceof SpriteIconMorph},e.contents.reactToDropOf=function(t){r.corral.reactToDropOf(t)},e.alpha=0,this.sprites.asArray().forEach(function(t){t.isClone||(o=new SpriteIconMorph(t,o),e.contents.add(o))}),this.corral.frame=e,this.corral.add(e),this.corral.fixLayout=function(){this.stageIcon.setCenter(this.center()),this.stageIcon.setLeft(this.left()+5),this.frame.setLeft(this.stageIcon.right()+5),this.frame.setExtent(new Point(this.right()-this.frame.left(),this.height())),this.arrangeIcons(),this.refresh()},this.corral.arrangeIcons=function(){var o=this.frame.left(),i=this.frame.top(),r=this.frame.right(),n=this.frame.left();this.frame.contents.children.forEach(function(t){var e=t.width();r<o+e&&(o=n,i+=t.height()),t.setPosition(new Point(o,i)),o+=e}),this.frame.contents.adjustBounds()},this.corral.addSprite=function(t){this.frame.contents.add(new SpriteIconMorph(t)),this.fixLayout()},this.corral.refresh=function(){this.stageIcon.refresh(),this.frame.contents.children.forEach(function(t){t.refresh()})},this.corral.wantsDropOf=function(t){return t instanceof SpriteIconMorph},this.corral.reactToDropOf=function(t){var e=1,o=t.position(),i=!!SnapActions.getOwnerFromId(t.object.id);t.destroy(),i&&(this.frame.contents.children.forEach(function(t){(o.gt(t.position())||o.y>t.bottom())&&(e+=1)}),r.sprites.add(t.object,e),r.createCorral(),r.fixLayout())},this.corral.userMenu=function(){var t,e,o,i=new MenuMorph(this);return SnapUndo.canUndo("corral")&&(o=SnapUndo.eventHistory.corral.length,t=SnapUndo.eventHistory.corral[o-1],e=r.serializer.parse(t.args[1]).childrenNamed("sprite")[0],i.addItem("restore "+e.attributes.name,function(){SnapUndo.undo("corral")})),i},this.isAppMode&&this.corral.hide()},IDE_Morph.prototype.createReplayControls=function(){this.replayControls=new ReplayControls(this),this.add(this.replayControls),this.replayControls.drawNew(),this.replayControls.hide()},IDE_Morph.prototype.fixLayout=function(t){var e,o=this.padding;if(Morph.prototype.trackChanges=!1,"refreshPalette"!==t&&(this.controlBar.setPosition(this.logo.topRight()),this.controlBar.setWidth(this.right()-this.controlBar.left()),this.controlBar.fixLayout(),this.categories.setLeft(this.logo.left()),this.categories.setTop(this.logo.bottom()),this.categories.setWidth(this.paletteWidth)),this.palette.setLeft(this.logo.left()),this.palette.setTop(this.categories.bottom()),this.palette.setHeight(this.bottom()-this.palette.top()),this.palette.setWidth(this.paletteWidth),"refreshPalette"!==t){if(this.isAppMode){var i;if(this.isMobileDevice()){var r=(this.width()-2*o)/this.stage.dimensions.x,n=(this.height()-2*o)/this.stage.dimensions.y;i=Math.floor(1e3*Math.min(r,n))/1e3}else i=Math.floor(10*Math.min((this.width()-2*o)/this.stage.dimensions.x,(this.height()-2*this.controlBar.height()-2*o)/this.stage.dimensions.y))/10;this.stage.setScale(i),this.stage.setCenter(this.center())}else this.stage.setScale(this.isSmallStage?this.stageRatio:1),this.stage.setTop(this.logo.bottom()+o),this.stage.setRight(this.right()),e=Math.max(200,this.width()-this.stage.width()-this.spriteBar.tabBar.width()-2*this.padding),this.paletteWidth>e&&(this.paletteWidth=e,this.fixLayout()),this.stageHandle.fixLayout(),this.paletteHandle.fixLayout();this.spriteBar.setLeft(this.paletteWidth+o),this.spriteBar.setTop(this.logo.bottom()+o),this.spriteBar.setExtent(new Point(Math.max(0,this.stage.left()-o-this.spriteBar.left()),this.categories.bottom()-this.spriteBar.top()-o)),this.spriteBar.fixLayout(),this.spriteEditor.isVisible&&(this.spriteEditor.setPosition(this.spriteBar.bottomLeft()),this.spriteEditor.setExtent(new Point(this.spriteBar.width(),this.bottom()-this.spriteEditor.top()))),this.corralBar.setLeft(this.stage.left()),this.corralBar.setTop(this.stage.bottom()+o),this.corralBar.setWidth(this.stage.width()),contains(["selectSprite","tabEditor"],t)||(this.corral.setPosition(this.corralBar.bottomLeft()),this.corral.setWidth(this.stage.width()),this.corral.setHeight(this.bottom()-this.corral.top()),this.corral.fixLayout())}Math.max(.8*this.width(),250);this.removeChild(this.replayControls),this.add(this.replayControls),this.replayControls.setWidth(this.width()-40),this.replayControls.setHeight(80),this.replayControls.setCenter(new Point(this.width()/2,0)),this.replayControls.setBottom(this.bottom()),this.replayControls.fixLayout(),Morph.prototype.trackChanges=!0,this.changed(),this.isAppMode&&this.isMobileDevice()&&0!==this.mobileMode.buttons.length&&this.mobileMode.fixLayout()},IDE_Morph.prototype.setProjectName=function(t){this.projectName=t.replace(/['"]/g,""),this.hasChangedMedia=!0,this.controlBar.updateLabel()},IDE_Morph.prototype.setExtent=function(t){var e,o,i,r,n,s,a,h=new Point(430,110);e=this.isAppMode?this.isMobileDevice()?{x:10,y:10}:StageMorph.prototype.dimensions.add(this.controlBar.height()+10):1<this.stageRatio?h.add(StageMorph.prototype.dimensions):h.add(StageMorph.prototype.dimensions.multiplyBy(this.stageRatio)),i=(o=t.max(e)).x-(200+this.spriteBar.tabBar.width()+2*this.padding),r=3*SpriteIconMorph.prototype.thumbSize.x,n=o.y-3.5*SpriteIconMorph.prototype.thumbSize.y,s=r/this.stage.dimensions.x,a=Math.min(i/this.stage.dimensions.x,n/this.stage.dimensions.y),this.stageRatio=Math.min(a,Math.max(s,this.stageRatio)),IDE_Morph.uber.setExtent.call(this,o),this.fixLayout()},IDE_Morph.prototype.reactToWorldResize=function(t){this.isAutoFill&&(this.setPosition(t.origin),this.setExtent(t.extent())),this.filePicker&&(document.body.removeChild(this.filePicker),this.filePicker=null)},IDE_Morph.prototype.droppedImage=function(t,e){var o=new Costume(t,this.currentSprite.newCostumeName(e?e.split(".")[0]:""));o.isTainted()?this.inform("Unable to import this image","The picture you wish to import has been\ntainted by a restrictive cross-origin policy\nmaking it unusable for costumes in Snap!. \n\nTry downloading this picture first to your\ncomputer, and import it from there."):SnapActions.addCostume(o,this.currentSprite,!0)},IDE_Morph.prototype.droppedSVG=function(t,e){var o=new SVG_Costume(t,e.split(".")[0]);SnapActions.addCostume(o,this.currentSprite,!0)},IDE_Morph.prototype.droppedAudio=function(t,e){var o=new Sound(t,e.split(".")[0]);SnapActions.addSound(o,this.currentSprite,!0)},IDE_Morph.prototype.droppedText=function(t,e,o){var i=e?e.split(".")[0]:"",r=e?e.slice(e.lastIndexOf(".")+1).toLowerCase():"";return 0===t.indexOf("<project")?(location.hash="",SnapActions.disableCollaboration(),SnapUndo.reset(),this.openProjectString(t)):0===t.indexOf("<replay")?this.openReplayString(t):0===t.indexOf("<snapdata")?(SnapActions.disableCollaboration(),SnapUndo.reset(),location.hash="",this.openCloudDataString(t)):0===t.indexOf("<blocks")?SnapActions.importBlocks(t,i):0===t.indexOf("<sprites")?SnapActions.importSprites(t):0===t.indexOf("<media")?this.openMediaString(t):-1!==o.indexOf("csv")||"csv"===r?this.openDataString(t,i,"csv"):-1!==o.indexOf("json")||"json"===r?this.openDataString(t,i,"json"):void this.openDataString(t,i,"text")},IDE_Morph.prototype.droppedBinary=function(t,e){var o=document.getElementById("ypr"),r=this;function i(t,e){var o=new sb.Reader,i=e.split(".")[0];o.onload=function(t){r.droppedText((new sb.XMLWriter).write(i,t))},o.readYPR(new Uint8Array(t))}"ypr"===e.substring(e.length-3).toLowerCase()&&(o?i(t,e):((o=document.createElement("script")).id="ypr",o.onload=function(){i(t,e)},document.head.appendChild(o),o.src="ypr.js"))},IDE_Morph.prototype.refreshPalette=function(t){var e=this.palette.contents.top();this.createPalette(),this.fixLayout("refreshPalette"),t||this.palette.contents.setTop(e)},IDE_Morph.prototype.pressStart=function(){SnapActions.pressStart(16===this.world().currentKey),16===this.world().currentKey?this.toggleFastTracking():(this.stage.threads.pauseCustomHatBlocks=!1,this.controlBar.stopButton.refresh(),this.runScripts())},IDE_Morph.prototype.toggleFastTracking=function(){this.stage.isFastTracked?this.stopFastTracking():this.startFastTracking()},IDE_Morph.prototype.toggleVariableFrameRate=function(){StageMorph.prototype.frameRate?(StageMorph.prototype.frameRate=0,this.stage.fps=0):(StageMorph.prototype.frameRate=30,this.stage.fps=30)},IDE_Morph.prototype.toggleCollaborativeEditing=function(){var t=this;SnapActions.isCollaborating()?SnapActions.disableCollaboration():this.isReplayMode?this.confirm("Cannot enter collaborate while in replay mode. \nWould you like to exit replay mode and enable collaborative editing?","Exit Replay Mode?",function(){t.exitReplayMode(),SnapActions.enableCollaboration()}):SnapActions.enableCollaboration()},IDE_Morph.prototype.toggleSingleStepping=function(){this.stage.threads.toggleSingleStepping(),this.controlBar.steppingButton.refresh(),this.controlBar.refreshSlider()},IDE_Morph.prototype.startFastTracking=function(){this.stage.isFastTracked=!0,this.stage.fps=0,this.controlBar.startButton.labelString=new SymbolMorph("flash",14),this.controlBar.startButton.drawNew(),this.controlBar.startButton.fixLayout()},IDE_Morph.prototype.stopFastTracking=function(){this.stage.isFastTracked=!1,this.stage.fps=this.stage.frameRate,this.controlBar.startButton.labelString=new SymbolMorph("flag",14),this.controlBar.startButton.drawNew(),this.controlBar.startButton.fixLayout()},IDE_Morph.prototype.runScripts=function(){this.stage.fireGreenFlagEvent()},IDE_Morph.prototype.togglePauseResume=function(){SnapActions.togglePause(this.stage.threads.isPaused()),this.stage.threads.isPaused()?this.stage.threads.resumeAll(this.stage):this.stage.threads.pauseAll(this.stage),this.controlBar.pauseButton.refresh()},IDE_Morph.prototype.isPaused=function(){return!!this.stage&&this.stage.threads.isPaused()},IDE_Morph.prototype.stopAllScripts=function(){SnapActions.stopAllScripts(),this.stage.enableCustomHatBlocks?this.stage.threads.pauseCustomHatBlocks=!this.stage.threads.pauseCustomHatBlocks:this.stage.threads.pauseCustomHatBlocks=!1,this.controlBar.stopButton.refresh(),this.stage.fireStopAllEvent()},IDE_Morph.prototype.selectSprite=function(t){this.currentSprite&&this.currentSprite.scripts.focus&&this.currentSprite.scripts.focus.stopEditing(),this.currentSprite=t,this.createPalette(),this.createSpriteBar(),this.createSpriteEditor(),this.corral.refresh(),this.fixLayout("selectSprite"),this.currentSprite.scripts.fixMultiArgs()},IDE_Morph.prototype.toggleRetina=function(){isRetinaEnabled()?disableRetinaSupport():enableRetinaSupport(),this.world().fillPage(),IDE_Morph.prototype.scriptsPaneTexture=this.scriptsTexture(),this.stage.clearPenTrails(),this.drawNew(),this.refreshIDE()},IDE_Morph.prototype.defaultDesign=function(){this.setDefaultDesign(),this.refreshIDE(),this.removeSetting("design")},IDE_Morph.prototype.flatDesign=function(){this.setFlatDesign(),this.refreshIDE(),this.saveSetting("design","flat")},IDE_Morph.prototype.refreshIDE=function(){var t;if(Process.prototype.isCatchingErrors)try{t=this.serializer.serialize(this.stage)}catch(t){this.showMessage("Serialization failed: "+t)}else t=this.serializer.serialize(this.stage);SpriteMorph.prototype.initBlocks(),this.buildPanes(),this.fixLayout(),this.loadNewProject?SnapActions.openProject():(SnapUndo.reset(),this.openProjectString(t))},IDE_Morph.prototype.applySavedSettings=function(){var t=this.getSetting("design"),e=this.getSetting("zoom"),o=this.getSetting("language"),i=this.getSetting("click"),r=this.getSetting("longform"),n=this.getSetting("longurls"),s=this.getSetting("plainprototype"),a=this.getSetting("keyboard"),h=this.getSetting("tables"),l=this.getSetting("tableLines"),p=this.getSetting("autowrapping");"flat"===t?this.setFlatDesign():this.setDefaultDesign(),e&&(SyntaxElementMorph.prototype.setScale(Math.min(e,12)),CommentMorph.prototype.refreshScale(),SpriteMorph.prototype.initBlocks()),this.userLanguage=o||"pt_BR",i&&!BlockMorph.prototype.snapSound&&BlockMorph.prototype.toggleSnapSound(),r&&(InputSlotDialogMorph.prototype.isLaunchingExpanded=!0),this.projectsInURLs=!!n,ScriptsMorph.prototype.enableKeyboard="false"!==a,List.prototype.enableTables="false"!==h,TableMorph.prototype.highContrast=!!l,ScriptsMorph.prototype.enableNestedAutoWrapping="false"!==p,s&&(BlockLabelPlaceHolderMorph.prototype.plainLabel=!0)},IDE_Morph.prototype.saveSetting=function(t,e){this.savingPreferences&&localStorage&&(localStorage["-snap-setting-"+t]=e)},IDE_Morph.prototype.getSetting=function(t){return localStorage?localStorage["-snap-setting-"+t]:null},IDE_Morph.prototype.removeSetting=function(t){localStorage&&delete localStorage["-snap-setting-"+t]},IDE_Morph.prototype.addNewSprite=function(){var t=new SpriteMorph(this.globalVariables),e=Process.prototype.reportRandom;return t.name=this.newSpriteName(t.name),t.setCenter(this.stage.center()),t.parent=this.stage,t.setHue(e.call(this,0,100)),t.setBrightness(e.call(this,50,100)),t.turn(e.call(this,1,360)),t.setXPosition(e.call(this,-220,220)),t.setYPosition(e.call(this,-160,160)),SnapActions.addSprite(t)},IDE_Morph.prototype.paintNewSprite=function(){var t=new SpriteMorph(this.globalVariables),e=new Costume,o=this;this.newSpriteName(t.name),e.edit(this.world(),null,!0,nop,function(){e.shrinkWrap(),t.parent=o.stage,t.addCostume(e),t.wearCostume(e),t.gotoXY(0,0),SnapActions.addSprite(t)})},IDE_Morph.prototype.duplicateSprite=function(t){var e=t.fullCopy();return e.appearIn(this),e},IDE_Morph.prototype.removeSprite=function(e){var t,o=this;e.parts.forEach(function(t){o.removeSprite(t)}),t=this.sprites.asArray().indexOf(e)+1,this.stage.threads.stopAllForReceiver(e),e.corpsify(),e.destroy(),this.stage.watchers().forEach(function(t){t.object()===e&&t.destroy()}),0<t&&this.sprites.remove(t),this.createCorral(),this.fixLayout(),this.currentSprite=detect(this.stage.children,function(t){return t instanceof SpriteMorph})||this.stage,this.selectSprite(this.currentSprite)},IDE_Morph.prototype.newSpriteName=function(t,e){for(var o=t.indexOf("("),i=o<0?t:t.substring(0,o),r=1,n=i,s=this.sprites.asArray().concat(this.stage).filter(function(t){return t!==e}).map(function(t){return t.name});contains(s,n);)n=i+"("+(r+=1)+")";return n},IDE_Morph.prototype.userMenu=function(){return new MenuMorph(this)},IDE_Morph.prototype.snapMenu=function(){var t,e=this,o=this.world();(t=new MenuMorph(this)).addItem("About...","aboutSnap"),t.addLine(),t.addItem("Reference manual",function(){var t=e.resourceURL("help","SnapManual.pdf");window.open(t,"SnapReferenceManual")}),t.addItem("Snap! website",function(){window.open("http://snap.berkeley.edu/","SnapWebsite")}),t.addItem("Download source",function(){window.open("http://snap.berkeley.edu/snapsource/snap.zip","SnapSource")}),o.isDevMode?(t.addLine(),t.addItem("Switch back to user mode","switchToUserMode","disable deep-Morphic\ncontext menus\nand show user-friendly ones",new Color(0,100,0))):16===o.currentKey&&(t.addLine(),t.addItem("Switch to dev mode","switchToDevMode","enable Morphic\ncontext menus\nand inspectors,\nnot user-friendly!",new Color(100,0,0))),t.popup(o,this.logo.bottomLeft())},IDE_Morph.prototype.cloudMenu=function(){var t,i=this,e=16===this.world().currentKey;return t=new MenuMorph(this),e&&(t.addItem("url...","setCloudURL",null,new Color(100,0,0)),t.addLine()),SnapCloud.username?t.addItem(localize("Logout")+" "+SnapCloud.username,"logout"):(t.addItem("Login...","initializeCloud"),SnapActions.isCollaborating()&&SnapActions.sessionId&&(t.addLine(),t.addItem("Collaboration url...","promptCollaboration"))),e&&(t.addLine(),t.addItem("export project media only...",function(){i.projectName?i.exportProjectMedia(i.projectName):i.prompt("Export Project As...",function(t){i.exportProjectMedia(t)},null,"exportProject")},null,this.hasChangedMedia?new Color(100,0,0):new Color(0,100,0)),t.addItem("export project without media...",function(){i.projectName?i.exportProjectNoMedia(i.projectName):i.prompt("Export Project As...",function(t){i.exportProjectNoMedia(t)},null,"exportProject")},null,new Color(100,0,0)),t.addItem("export project as cloud data...",function(){i.projectName?i.exportProjectAsCloudData(i.projectName):i.prompt("Export Project As...",function(t){i.exportProjectAsCloudData(t)},null,"exportProject")},null,new Color(100,0,0)),t.addLine(),t.addItem("open shared project from cloud...",function(){i.prompt("Author name…",function(o){i.prompt("Project name...",function(t){var e="Username="+encodeURIComponent(o.toLowerCase())+"&ProjectName="+encodeURIComponent(t);i.showMessage("Fetching project\nfrom the cloud..."),SnapCloud.getPublicProject(e,function(t){var e;Process.prototype.isCatchingErrors||window.open("data:text/xml,"+t),i.nextSteps([function(){e=i.showMessage("Opening project...")},function(){nop()},function(){SnapActions.openProject(t).then(function(){e.destroy()})}])},i.cloudError())},null,"project")},null,"project")},null,new Color(100,0,0))),t},IDE_Morph.prototype.settingsMenu=function(){var s,t=this.stage,e=this.world(),o=this,a=16===e.currentKey;function i(t,e,o,i,r,n){n&&!a||s.addItem((o?"☑ ":"☐ ")+localize(t),e,o?i:r,n?new Color(100,0,0):null)}return(s=new MenuMorph(this)).addItem("Language...","languageMenu"),s.addItem("Zoom blocks...","userSetBlocksScale"),s.addItem("Stage size...","userSetStageSize"),a&&s.addItem("Dragging threshold...","userSetDragThreshold","specify the distance the hand has to move\nbefore it picks up an object",new Color(100,0,0)),s.addLine(),isRetinaSupported()&&i("Retina display support","toggleRetina",isRetinaEnabled(),"uncheck for lower resolution,\nsaves computing resources","check for higher resolution,\nuses more computing resources"),i("Blurred shadows","toggleBlurredShadows",useBlurredShadows,"uncheck to use solid drop\nshadows and highlights","check to use blurred drop\nshadows and highlights",!0),i("Zebra coloring","toggleZebraColoring",BlockMorph.prototype.zebraContrast,"uncheck to disable alternating\ncolors for nested block","check to enable alternating\ncolors for nested blocks",!0),i("Dynamic input labels","toggleDynamicInputLabels",SyntaxElementMorph.prototype.dynamicInputLabels,"uncheck to disable dynamic\nlabels for variadic inputs","check to enable dynamic\nlabels for variadic inputs",!0),i("Prefer empty slot drops","togglePreferEmptySlotDrops",ScriptsMorph.prototype.isPreferringEmptySlots,"uncheck to allow dropped\nreporters to kick out others","settings menu prefer empty slots hint",!0),i("Long form input dialog","toggleLongFormInputDialog",InputSlotDialogMorph.prototype.isLaunchingExpanded,"uncheck to use the input\ndialog in short form","check to always show slot\ntypes in the input dialog"),i("Plain prototype labels","togglePlainPrototypeLabels",BlockLabelPlaceHolderMorph.prototype.plainLabel,"uncheck to always show (+) symbols\nin block prototype labels","check to hide (+) symbols\nin block prototype labels"),i("Virtual keyboard","toggleVirtualKeyboard",MorphicPreferences.useVirtualKeyboard,"uncheck to disable\nvirtual keyboard support\nfor mobile devices","check to enable\nvirtual keyboard support\nfor mobile devices",!0),i("Input sliders","toggleInputSliders",MorphicPreferences.useSliderForInput,"uncheck to disable\ninput sliders for\nentry fields","check to enable\ninput sliders for\nentry fields"),MorphicPreferences.useSliderForInput&&i("Execute on slider change","toggleSliderExecute",ArgMorph.prototype.executeOnSliderEdit,"uncheck to suppress\nrunning scripts\nwhen moving the slider","check to run\nthe edited script\nwhen moving the slider"),i("Clicking sound",function(){BlockMorph.prototype.toggleSnapSound(),BlockMorph.prototype.snapSound?o.saveSetting("click",!0):o.removeSetting("click")},BlockMorph.prototype.snapSound,"uncheck to turn\nblock clicking\nsound off","check to turn\nblock clicking\nsound on"),i("Animations",function(){o.isAnimating=!o.isAnimating},o.isAnimating,"uncheck to disable\nIDE animations","check to enable\nIDE animations",!0),i("Turbo mode","toggleFastTracking",this.stage.isFastTracked,"uncheck to run scripts\nat normal speed","check to prioritize\nscript execution"),i("Cache Inputs",function(){BlockMorph.prototype.isCachingInputs=!BlockMorph.prototype.isCachingInputs},BlockMorph.prototype.isCachingInputs,"uncheck to stop caching\ninputs (for debugging the evaluator)","check to cache inputs\nboosts recursion",!0),i("Rasterize SVGs",function(){MorphicPreferences.rasterizeSVGs=!MorphicPreferences.rasterizeSVGs},MorphicPreferences.rasterizeSVGs,"uncheck for smooth\nscaling of vector costumes","check to rasterize\nSVGs on import",!0),i("Flat design",function(){if(MorphicPreferences.isFlat)return o.defaultDesign();o.flatDesign()},MorphicPreferences.isFlat,"uncheck for default\nGUI design","check for alternative\nGUI design",!1),i("Nested auto-wrapping",function(){ScriptsMorph.prototype.enableNestedAutoWrapping=!ScriptsMorph.prototype.enableNestedAutoWrapping,ScriptsMorph.prototype.enableNestedAutoWrapping?o.removeSetting("autowrapping"):o.saveSetting("autowrapping",!1)},ScriptsMorph.prototype.enableNestedAutoWrapping,"uncheck to confine auto-wrapping\nto top-level block stacks","check to enable auto-wrapping\ninside nested block stacks",!1),i("Project URLs",function(){o.projectsInURLs=!o.projectsInURLs,o.projectsInURLs?o.saveSetting("longurls",!0):o.removeSetting("longurls")},o.projectsInURLs,"uncheck to disable\nproject data in URLs","check to enable\nproject data in URLs",!0),i("Sprite Nesting",function(){SpriteMorph.prototype.enableNesting=!SpriteMorph.prototype.enableNesting},SpriteMorph.prototype.enableNesting,"uncheck to disable\nsprite composition","check to enable\nsprite composition",!0),i("First-Class Sprites",function(){SpriteMorph.prototype.enableFirstClass=!SpriteMorph.prototype.enableFirstClass,o.currentSprite.blocksCache.sensing=null,o.currentSprite.paletteCache.sensing=null,o.refreshPalette()},SpriteMorph.prototype.enableFirstClass,"uncheck to disable support\nfor first-class sprites","check to enable support\n for first-class sprite",!0),i("Keyboard Editing",function(){ScriptsMorph.prototype.enableKeyboard=!ScriptsMorph.prototype.enableKeyboard,ScriptsMorph.prototype.enableKeyboard?o.removeSetting("keyboard"):o.saveSetting("keyboard",!1)},ScriptsMorph.prototype.enableKeyboard,"uncheck to disable\nkeyboard editing support","check to enable\nkeyboard editing support",!1),i("Table support",function(){List.prototype.enableTables=!List.prototype.enableTables,List.prototype.enableTables?o.removeSetting("tables"):o.saveSetting("tables",!1)},List.prototype.enableTables,"uncheck to disable\nmulti-column list views","check for multi-column\nlist view support",!1),List.prototype.enableTables&&i("Table lines",function(){TableMorph.prototype.highContrast=!TableMorph.prototype.highContrast,TableMorph.prototype.highContrast?o.saveSetting("tableLines",!0):o.removeSetting("tableLines")},TableMorph.prototype.highContrast,"uncheck for less contrast\nmulti-column list views","check for higher contrast\ntable views",!1),i("Live coding support",function(){Process.prototype.enableLiveCoding=!Process.prototype.enableLiveCoding},Process.prototype.enableLiveCoding,"EXPERIMENTAL! uncheck to disable live\ncustom control structures","EXPERIMENTAL! check to enable\n live custom control structures",!0),i("Visible stepping","toggleSingleStepping",Process.prototype.enableSingleStepping,"uncheck to turn off\nvisible stepping","check to turn on\n visible stepping (slow)",!1),!1!==SnapActions.supportsCollaboration&&i("Collaborative editing","toggleCollaborativeEditing",SnapActions.isCollaborating(),"uncheck to disable Google Docs-style collaboration","check to enable Google Docs-style collaboration",!1),i("Replay Mode",function(){return o.isReplayMode?o.isPreviousVersion()?void o.confirm("Exiting replay mode now will revert the project to\nthe current point in history (losing any unapplied changes)\n\nAre you sure you want to exit replay mode?","Exit Replay Mode?",function(){o.exitReplayMode()}):o.exitReplayMode():SnapUndo.allEvents.length<2?o.showMessage("Nothing to replay!",2):void(SnapActions.isCollaborating()?this.confirm("Cannot enter replay mode while collaborating. \nWould you like to disable collaboration and enter replay mode?","Disable Collaboration?",function(){SnapActions.disableCollaboration(),o.replayEvents()}):o.replayEvents())},o.isReplayMode,"uncheck to disable replay mode","check to enable replay mode",!1),i("Save replay history",function(){SnapSerializer.prototype.isSavingHistory=!SnapSerializer.prototype.isSavingHistory},SnapSerializer.prototype.isSavingHistory,"uncheck to only save project","check to save replay with project",!1),s.addLine(),i("Thread safe scripts",function(){t.isThreadSafe=!t.isThreadSafe},this.stage.isThreadSafe,"uncheck to allow\nscript reentrance","check to disallow\nscript reentrance"),i("Prefer smooth animations","toggleVariableFrameRate",StageMorph.prototype.frameRate,"uncheck for greater speed\nat variable frame rates","check for smooth, predictable\nanimations across computers",!0),i("Flat line ends",function(){SpriteMorph.prototype.useFlatLineEnds=!SpriteMorph.prototype.useFlatLineEnds},SpriteMorph.prototype.useFlatLineEnds,"uncheck for round ends of lines","check for flat ends of lines"),i("Codification support",function(){StageMorph.prototype.enableCodeMapping=!StageMorph.prototype.enableCodeMapping,o.currentSprite.blocksCache.variables=null,o.currentSprite.paletteCache.variables=null,o.refreshPalette()},StageMorph.prototype.enableCodeMapping,"uncheck to disable\nblock to text mapping features","check for block\nto text mapping features",!1),i("Inheritance support",function(){StageMorph.prototype.enableInheritance=!StageMorph.prototype.enableInheritance,o.currentSprite.blocksCache.variables=null,o.currentSprite.paletteCache.variables=null,o.refreshPalette()},StageMorph.prototype.enableInheritance,"uncheck to disable\nsprite inheritance features","check for sprite\ninheritance features",!1),i("Persist linked sublist IDs",function(){StageMorph.prototype.enableSublistIDs=!StageMorph.prototype.enableSublistIDs},StageMorph.prototype.enableSublistIDs,"uncheck to disable\nsaving linked sublist identities","check to enable\nsaving linked sublist identities",!0),s},IDE_Morph.prototype.projectMenu=function(){var t,o=this,e=this.world(),i=this.currentSprite instanceof SpriteMorph?"Costumes":"Backgrounds",r=16===e.currentKey;return(t=new MenuMorph(this)).addItem("Project notes...","editProjectNotes"),t.addLine(),t.addPair("New","createNewProject","^N"),t.addPair("Open...","openProjectsBrowser","^O"),t.addPair("Save","save","^S"),t.addItem("Save As...",function(){if(o.isPreviousVersion())return o.showMessage("Please exit replay mode before saving");o.saveProjectsBrowser()}),r&&t.addItem(localize("Replay events from file"),function(){var e=document.createElement("input");1<SnapUndo.allEvents.length&&o.newProject(),o.filePicker&&(document.body.removeChild(o.filePicker),o.filePicker=null),e.type="file",e.style.color="transparent",e.style.backgroundColor="transparent",e.style.border="none",e.style.outline="none",e.style.position="absolute",e.style.top="0px",e.style.left="0px",e.style.width="0px",e.style.height="0px",e.addEventListener("change",function(){var t=new FileReader;document.body.removeChild(e),o.filePicker=null,t.onloadend=function(t){return o.loadReplayFromXml(t.target.result)},t.readAsText(e.files[0])},!1),document.body.appendChild(e),(o.filePicker=e).click()},"Load project replay from the beginning",new Color(100,0,0)),t.addLine(),t.addItem("Import...",function(){var t=document.createElement("input");o.filePicker&&(document.body.removeChild(o.filePicker),o.filePicker=null),t.type="file",t.style.color="transparent",t.style.backgroundColor="transparent",t.style.border="none",t.style.outline="none",t.style.position="absolute",t.style.top="0px",t.style.left="0px",t.style.width="0px",t.style.height="0px",t.style.display="none",t.addEventListener("change",function(){document.body.removeChild(t),o.filePicker=null,e.hand.processDrop(t.files)},!1),document.body.appendChild(t),(o.filePicker=t).click()},"file menu import hint"),r&&(t.addItem(localize("Export project...")+" "+localize("(in a new window)"),function(){o.projectName?o.exportProject(o.projectName,r):o.prompt("Export Project As...",function(t){o.exportProject(t,!1,!0)},null,"exportProject")},"show project data as XML\nin a new browser window",new Color(100,0,0)),t.addItem(localize("Export project without history..."),function(){var e=o.serializer.isSavingHistory;o.projectName?(o.serializer.isSavingHistory=!1,o.exportProject(o.projectName,r),o.serializer.isSavingHistory=e):o.prompt("Export Project As...",function(t){o.serializer.isSavingHistory=!1,o.exportProject(t,r),o.serializer.isSavingHistory=e},null,"exportProject")},null,new Color(100,0,0))),t.addItem(r?"Export project as plain text...":"Export project...",function(){o.projectName?o.exportProject(o.projectName,r):o.prompt("Export Project As...",function(t){o.exportProject(t,r)},null,"exportProject")},"save project data as XML\nto your downloads folder",r?new Color(100,0,0):null),this.stage.globalBlocks.length&&(t.addItem("Export blocks...","exportGlobalBlocks","show global custom block definitions as XML\nin a new browser window"),t.addItem("Unused blocks...",function(){o.removeUnusedBlocks()},"find unused global custom blocks\nand remove their definitions")),t.addItem("Export summary...",function(){o.exportProjectSummary()},"open a new browser browser window\n with a summary of this project"),r&&(t.addItem("Export summary with drop-shadows...",function(){o.exportProjectSummary(!0)},"open a new browser browser window\nwith a summary of this project\nwith drop-shadows on all pictures.\nnot supported by all browsers",new Color(100,0,0)),t.addItem("Export all scripts as pic...",function(){o.exportScriptsPicture()},"show a picture of all scripts\nand block definitions",new Color(100,0,0))),t.addLine(),t.addItem("Import tools",function(){o.getURL(o.resourceURL("tools.xml"),function(t){o.droppedText(t,"tools")})},"load the official library of\npowerful blocks"),t.addItem("Libraries...",function(){o.getURL(o.resourceURL("libraries","LIBRARIES"),function(t){var e=o.parseResourceFile(t);new LibraryImportDialogMorph(o,e).popUp()})},"Select categories of additional blocks to add to this project."),t.addItem(localize(i)+"...",function(){o.importMedia(i)},"Select a costume from the media library"),t.addItem(localize("Sounds")+"...",function(){o.importMedia("Sounds")},"Select a sound from the media library"),t},IDE_Morph.prototype.replayEvents=function(t,e){e=!!e,t||(e=!0,t=JSON.parse(JSON.stringify(SnapUndo.allEvents))),this.replayControls.enable(),this.replayControls.setActions(t,e),this.isReplayMode=!0,this.preReplayUndoState={};for(var o=SnapUndo.allQueueIds(),i=o.length;i--;)this.preReplayUndoState[o[i]]=SnapUndo.undoCount[o[i]]},IDE_Morph.prototype.exitReplayMode=function(){if(this.isReplayMode){this.isReplayMode=!1;var e=this;SnapUndo.allQueueIds().filter(function(t){return e.preReplayUndoState[t]!==SnapUndo.undoCount[t]}).forEach(function(t){SnapUndo.trim(t)}),SnapUndo.allEvents=this.replayControls.getCurrentHistory(),this.activeEditor.onSetActive(),this.replayControls.disable()}},IDE_Morph.prototype.resourceURL=function(){return Array.prototype.slice.call(arguments,0).join("/")},IDE_Morph.prototype.getMediaList=function(t,e){var o=this.resourceURL(t,t.toUpperCase());return this.getMediaListFromURL.call(this,o,e)},IDE_Morph.prototype.parseResourceFile=function(t){var e,o=[];return t.split("\n").map(function(t){return t.trim()}).filter(function(t){return 0<t.length}).forEach(function(t){(e=t.split("\t").map(function(t){return t.trim()})).length<2||o.push({fileName:e[0],name:e[1],description:2<e.length?e[2]:""})}),o},IDE_Morph.prototype.importMedia=function(e){var o=this,i=this.showMessage("Opening "+e+"...");this.getMediaList(e,function(t){i.destroy(),o.popupMediaImportDialog(e,t)})},IDE_Morph.prototype.popupMediaImportDialog=function(l,t){var p=(new DialogBoxMorph).withKey("import"+l),c=new ScrollFrameMorph,u=null,d=new SymbolMorph("turtle",60),g=this,e=this.world();c.acceptsDrops=!1,c.contents.acceptsDrops=!1,c.color=g.groupColor,c.fixLayout=nop,p.labelString=l,p.createLabel(),p.addBody(c),p.addButton("ok","Import"),p.addButton("cancel","Close"),p.ok=function(){u&&(u.object instanceof Sound?g.droppedAudio(u.object.copy().audio,u.labelString):u.object instanceof SVG_Costume?g.droppedSVG(u.object.contents,u.labelString):g.droppedImage(u.object.contents,u.labelString))},p.fixLayout=function(){var e,o,t=fontHeight(this.titleFontSize)+2*this.titlePadding,i=0,r=0;this.buttons.fixLayout(),this.body.setPosition(this.position().add(new Point(this.padding,t+this.padding))),this.body.setExtent(new Point(this.width()-2*this.padding,this.height()-3*this.padding-t-this.buttons.height())),e=this.body.position(),o=this.body.width(),c.contents.children.forEach(function(t){t.setPosition(e.add(new Point(i,r))),(i+=t.width())+t.width()>o&&(i=0,r+=t.height())}),c.contents.adjustBounds(),this.label.setCenter(this.center()),this.label.setTop(this.top()+(t-this.label.height())/2),this.buttons.setCenter(this.center()),this.buttons.setBottom(this.bottom()-this.padding)},t.forEach(function(e){var t,o,i,r=g.resourceURL(l,e.fileName),n=new Image,s=r.slice(r.lastIndexOf(".")+1).toLowerCase(),a="svg"===s&&!MorphicPreferences.rasterizeSVGs,h=contains(["wav","mp3"],s);h?o=i=new SoundIconMorph(new Sound(new Audio,e.name),o):t=i=new CostumeIconMorph(new Costume(d.image,e.name),t),i.isDraggable=!1,i.userMenu=nop,i.action=function(){if(u!==i){var t=u;u=i,t&&t.refresh()}},i.doubleClickAction=p.ok,i.query=function(){return i===u},c.addContents(i),h?(i.object.audio.onloadeddata=function(){i.createThumbnail(),i.fixLayout(),i.refresh()},i.object.audio.src=r,i.object.audio.load()):a?(n.onload=function(){i.object=new SVG_Costume(n,e.name),i.refresh()},g.getURL(r,function(t){n.src="data:image/svg+xml;utf8,"+encodeURIComponent(t)})):(n.onload=function(){var t=newCanvas(new Point(n.width,n.height),!0);t.getContext("2d").drawImage(n,0,0),i.object=new Costume(t,e.name),i.refresh()},n.src=r)}),p.popUp(e),p.setExtent(new Point(400,300)),p.setCenter(e.center()),p.drawNew(),new HandleMorph(p,300,280,p.corner,p.corner)},IDE_Morph.prototype.aboutSnap=function(){var t,e,o,i,r,n,s,a,h,l,p,c,u="",d=this.world();for(n in e="Snap! 4.0.10.2\nBuild Your Own Blocks\n\nCopyright Ⓒ 2017 Jens Mönig and Brian Harvey\njens@moenig.org, bh@cs.berkeley.edu\n\nSnap! is developed by the University of California, Berkeley\n          with support from the National Science Foundation (NSF), MioSoft,          \nthe Communications Design Group (CDG) at SAP Labs, and the\nHuman Advancement Research Community (HARC) at YC Research.\nThe design of Snap! is influenced and inspired by Scratch,\nfrom the Lifelong Kindergarten group at the MIT Media Lab\n\nfor more information see http://snap.berkeley.edu\nand http://scratch.mit.edu",o=localize("License")+"\n\nSnap! is free software: you can redistribute it and/or modify\nit under the terms of the GNU Affero General Public License as\npublished by the Free Software Foundation, either version 3 of\nthe License, or (at your option) any later version.\n\nThis program is distributed in the hope that it will be useful,\nbut WITHOUT ANY WARRANTY; without even the implied warranty of\nMERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\nGNU Affero General Public License for more details.\n\nYou should have received a copy of the\nGNU Affero General Public License along with this program.\nIf not, see http://www.gnu.org/licenses/\n\nWant to use Snap! but scared by the open-source license?\nGet in touch with us, we'll make it work.",i=localize("Contributors")+'\n\nNathan Dinsmore: Saving/Loading, Snap-Logo Design, \ncountless bugfixes and optimizations\nKartik Chandra: Paint Editor\nMichael Ball: Time/Date UI, Library Import Dialog,\ncountless bugfixes and optimizations\nBartosz Leper: Retina Display Support\nBernat Romagosa: Countless contributions\n"Ava" Yuan Yuan, Dylan Servilla: Graphic Effects\nKyle Hotchkiss: Block search design\nBrian Broll: Many bugfixes and optimizations\nIan Reynolds: UI Design, Event Bindings, Sound primitives\nIvan Motyashov: Initial Squeak Porting\nDavide Della Casa: Morphic Optimizations\nAchal Dave: Web Audio\nJoe Otto: Morphic Testing and Debugging',modules)Object.prototype.hasOwnProperty.call(modules,n)&&(u+="\n"+n+" ("+modules[n]+")");""!==u&&(u=localize("current module versions:")+" \n\nmorphic ("+morphicVersion+")"+u),r=localize("Translations")+"\n"+SnapTranslator.credits(),(t=new DialogBoxMorph).inform("About Snap",e,d),s=t.buttons.children[0],c=t.addButton(function(){t.body.text=r,t.body.drawNew(),s.show(),a.show(),h.hide(),l.hide(),p.hide(),c.hide(),t.fixLayout(),t.drawNew(),t.setCenter(d.center())},"Translators..."),(a=t.addButton(function(){t.body.text=e,t.body.drawNew(),s.show(),a.hide(),h.show(),l.show(),p.show(),c.hide(),t.fixLayout(),t.drawNew(),t.setCenter(d.center())},"Back...")).hide(),p=t.addButton(function(){t.body.text=o,t.body.drawNew(),s.show(),a.show(),h.hide(),l.hide(),p.hide(),c.hide(),t.fixLayout(),t.drawNew(),t.setCenter(d.center())},"License..."),h=t.addButton(function(){t.body.text=u,t.body.drawNew(),s.show(),a.show(),h.hide(),l.hide(),p.hide(),c.hide(),t.fixLayout(),t.drawNew(),t.setCenter(d.center())},"Modules..."),l=t.addButton(function(){t.body.text=i,t.body.drawNew(),s.show(),a.show(),c.show(),h.hide(),l.hide(),p.hide(),t.fixLayout(),t.drawNew(),t.setCenter(d.center())},"Credits..."),c.hide(),t.fixLayout(),t.drawNew()},IDE_Morph.prototype.editProjectNotes=function(){var t=(new DialogBoxMorph).withKey("projectNotes"),e=new ScrollFrameMorph,o=new TextMorph(this.projectNotes||""),i=t.ok,r=this,n=this.world();e.padding=6,e.setWidth(250),e.acceptsDrops=!1,e.contents.acceptsDrops=!1,o.setWidth(250-2*e.padding),o.setPosition(e.topLeft().add(e.padding)),o.enableSelecting(),o.isEditable=!0,e.setHeight(250),e.fixLayout=nop,e.edge=InputFieldMorph.prototype.edge,e.fontSize=InputFieldMorph.prototype.fontSize,e.typeInPadding=InputFieldMorph.prototype.typeInPadding,e.contrast=InputFieldMorph.prototype.contrast,e.drawNew=InputFieldMorph.prototype.drawNew,e.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,e.addContents(o),o.drawNew(),t.ok=function(){r.projectNotes=o.text,i.call(this)},t.justDropped=function(){o.edit()},t.labelString="Project Notes",t.createLabel(),t.addBody(e),e.drawNew(),t.addButton("ok","OK"),t.addButton("cancel","Cancel"),t.fixLayout(),t.drawNew(),t.popUp(n),t.setCenter(n.center()),o.edit()},IDE_Morph.prototype.newProject=function(){this.source=SnapCloud.username?"cloud":"local",this.stage&&this.stage.destroy(),"#lang:"!==location.hash.substr(0,6)&&(location.hash=""),this.globalVariables=new VariableFrame,this.currentSprite=new SpriteMorph(this.globalVariables),this.sprites=new List([this.currentSprite]),StageMorph.prototype.dimensions=new Point(480,360),StageMorph.prototype.hiddenPrimitives={},StageMorph.prototype.codeMappings={},StageMorph.prototype.codeHeaders={},StageMorph.prototype.enableCodeMapping=!1,StageMorph.prototype.enableInheritance=!1,StageMorph.prototype.enableSublistIDs=!1,SpriteMorph.prototype.useFlatLineEnds=!1,Process.prototype.enableLiveCoding=!1,this.setProjectName(""),this.projectNotes="",this.createStage(),this.add(this.stage),this.createCorral(),this.selectSprite(this.stage.children[0]),this.fixLayout()},IDE_Morph.prototype.isPreviousVersion=function(){if(!this.isReplayMode)return!1;var t=this.replayControls.actionIndex+1;return 0<SnapUndo.allEvents.filter(function(t){return!t.isReplay}).length-t},IDE_Morph.prototype.save=function(){if(this.isPreviousVersion())return this.showMessage("Please exit replay mode before saving");"examples"===this.source&&(this.source="local"),this.projectName?"local"===this.source?this.saveProject(this.projectName):this.saveProjectToCloud(this.projectName):this.saveProjectsBrowser()},IDE_Morph.prototype.saveProject=function(t){var e=this;this.nextSteps([function(){e.showMessage("Saving...")},function(){e.rawSaveProject(t)}])},IDE_Morph.prototype.rawSaveProject=function(t){var e;if(t)if(this.setProjectName(t),Process.prototype.isCatchingErrors)try{localStorage["-snap-project-"+t]=e=this.serializer.serialize(this.stage),this.setURL("#open:"+e),this.showMessage("Saved!",1)}catch(t){this.showMessage("Save failed: "+t)}else localStorage["-snap-project-"+t]=e=this.serializer.serialize(this.stage),this.setURL("#open:"+e),this.showMessage("Saved!",1)},IDE_Morph.prototype.exportProject=function(t,e,o){var i,r;if(t){var n=this.projectName;this.silentSetProjectName(t),"plain,";try{i=this.showMessage("Exporting"),r=this.serializer.serialize(this.stage),this.setURL("#open:plain,"+encodeURIComponent(r)),this.saveXMLAs(r,t,o),i.destroy(),this.showMessage("Exported!",1)}catch(t){if(!Process.prototype.isCatchingErrors)throw t;this.showMessage("Export failed: "+t)}this.silentSetProjectName(n)}},IDE_Morph.prototype.exportGlobalBlocks=function(){0<this.stage.globalBlocks.length||this.stage.deletableMessageNames().length?new BlockExportDialogMorph(this.serializer,this.stage.globalBlocks,this.stage).popUp(this.world()):this.inform("Export blocks/msg types","this project doesn't have any\ncustom global blocks or message types yet")},IDE_Morph.prototype.removeUnusedBlocks=function(){var t,e=this.sprites.asArray().concat([this.stage]),o=this.stage.globalBlocks,i=[],r=!1;for(;!r;)(t=o.filter(function(o){return!contains(i,o)&&e.every(function(t,e){return!t.usesBlockInstance(o,!0,e,i)})})).length?i=i.concat(t):r=!0;0<i.length?new BlockRemovalDialogMorph(i,this.stage).popUp(this.world()):this.inform("Remove unused blocks","there are currently no unused\nglobal custom blocks in this project")},IDE_Morph.prototype.exportSprite=function(t){var e,o=this.serializer.isSavingHistory;this.serializer.isSavingHistory=!1,e=this.serializer.serialize(t.allParts()),this.serializer.isSavingHistory=o,e='<sprites app="'+this.serializer.app+'" version="'+this.serializer.version+'">'+e+"</sprites>",this.saveXMLAs(e,t.name)},IDE_Morph.prototype.exportScriptsPicture=function(){var t,e,o=[],i=0,r=0,n=0;this.sprites.asArray().forEach(function(t){o.push(t.image),o.push(t.scripts.scriptsPicture()),t.customBlocks.forEach(function(t){o.push(t.scriptsPicture())})}),o.push(this.stage.image),o.push(this.stage.scripts.scriptsPicture()),this.stage.customBlocks.forEach(function(t){o.push(t.scriptsPicture())}),this.stage.globalBlocks.forEach(function(t){o.push(t.scriptsPicture())}),(o=o.filter(function(t){return!isNil(t)})).forEach(function(t){i=Math.max(i,t.width),r+=t.height,r+=20}),t=newCanvas(new Point(i,r-=20)),e=t.getContext("2d"),o.forEach(function(t){e.drawImage(t,0,n),n+=20,n+=t.height}),this.saveCanvasAs(t,this.projectName||localize("Untitled"))},IDE_Morph.prototype.exportProjectSummary=function(t){var e,o,r,i,n,s,a=this.stage;function h(t,e,o){return e||(e=r),new XML_Element(t,o,e)}function l(t,e,o){return e||(e="p"),o||(o=r),new XML_Element(e,t,o)}function p(t,e,o){e||(e=r);var i=h("img",(o?null:h("p",e))||e);return i.attributes.src=t.toDataURL(),i}function c(r){var n,t=r.names().sort(),s=!0;t.length&&(l(localize("Variables"),"h3"),t.forEach(function(t){var e,o,i;s&&(n=h("ul"),s=!1),i=h("li",n),(o=(e=new WatcherMorph(t,SpriteMorph.prototype.blockColor.variables,r,t)).cellMorph.contentsMorph)instanceof ListWatcherMorph&&o.expand(),p(e.fullImageClassic(),i).attributes.class="script"}))}function u(t){t.length&&(l(localize("Blocks"),"h3"),SpriteMorph.prototype.categories.forEach(function(o){var i,r=!0;t.forEach(function(t){var e;t.category===o&&(r&&(l(localize(o[0].toUpperCase().concat(o.slice(1))),"h4"),i=h("ul"),r=!1),e=h("li",i),p(t.templateInstance().scriptPic(),e).attributes.class="script",t.sortedElements().forEach(function(t){p(t instanceof BlockMorph?t.scriptPic():t.fullImageClassic(),e).attributes.class="script"}))})}))}i=this.projectName||localize("untitled"),(e=new XML_Element("html")).attributes.lang=SnapTranslator.language,h("meta",o=h("head",e)).attributes.charset="UTF-8",h("style",o,t?"img {vertical-align: top;filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.5));-webkit-filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.5));-ms-filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.5));}.toc {vertical-align: middle;padding: 2px 1em 2px 1em;}":"img {vertical-align: top;}.toc {vertical-align: middle;padding: 2px 1em 2px 1em;}.sprite {border: 1px solid lightgray;}"),l(i,"title",o),r=h("body",e),l(i,"h1"),0===location.hash.indexOf("#present:")?(l(location.toString(),"a",r).attributes.href=location.toString(),p(a.thumbnail(a.dimensions)).attributes.class="sprite",l(this.serializer.app,"h4")):(l(this.serializer.app,"h4"),p(a.thumbnail(a.dimensions)).attributes.class="sprite"),Process.prototype.reportTextSplit(this.projectNotes,"line").asArray().forEach(function(t){l(t)}),l(localize("Contents"),"h4"),n=h("ul"),this.sprites.asArray().concat([a]).forEach(function(t){var o,e=h("li",n),i=t.scripts.sortedElements(),r=t.costumes.length();h("hr"),p(t.thumbnail(new Point(40,40)),e,!0).attributes.class="toc",l(t.name,"a",e).attributes.href="#"+t.name,l(t.name,"h2").attributes.id=t.name,p(t.thumbnail(t.extent().divideBy(a.scale))).attributes.class="sprite",t instanceof SpriteMorph&&(t.exemplar&&(p(t.exemplar.thumbnail(new Point(40,40)),l(localize("Kind of")+" "+t.exemplar.name),!0).attributes.class="toc"),t.anchor&&(p(t.anchor.thumbnail(new Point(40,40)),l(localize("Part of")+" "+t.anchor.name),!0).attributes.class="toc"),t.parts.length&&(l(localize("Parts"),"h3"),o=h("ul"),t.parts.forEach(function(t){var e=h("li",o,t.name);p(t.thumbnail(new Point(40,40)),e,!0).attributes.class="toc"}))),(1<r||t.getCostumeIdx()!==r)&&(l(localize("Costumes"),"h3"),o=h("ol"),t.costumes.asArray().forEach(function(t){var e=h("li",o,t.name);p(t.thumbnail(new Point(40,40)),e,!0).attributes.class="toc"})),t.sounds.length()&&(l(localize("Sounds"),"h3"),o=h("ol"),t.sounds.asArray().forEach(function(t){l(t.name,"li",o)})),c(t.variables),i.length&&(l(localize("Scripts"),"h3"),i.forEach(function(t){p(t instanceof BlockMorph?t.scriptPic():t.fullImageClassic()).attributes.class="script"})),u(t.customBlocks)}),s=a.globalVariables(),(Object.keys(s.vars).length||a.globalBlocks.length)&&(h("hr"),l(localize("For all Sprites"),"a",h("li",n)).attributes.href="#global",l(localize("For all Sprites"),"h2").attributes.id="global",c(s),u(a.globalBlocks)),this.saveFileAs("<!DOCTYPE html>"+e.toString(),"text/html;charset=utf-8",i,!0)},IDE_Morph.prototype.openProjectString=function(t){var e,o=this;this.exitReplayMode(),this.nextSteps([function(){e=o.showMessage("Opening project...")},function(){nop()},function(){SnapActions.openProject(t).then(function(){e.destroy()})}])},IDE_Morph.prototype.rawOpenProjectString=function(t){var e;if(this.toggleAppMode(!1),this.spriteBar.tabBar.tabTo("scripts"),StageMorph.prototype.hiddenPrimitives={},StageMorph.prototype.codeMappings={},StageMorph.prototype.codeHeaders={},StageMorph.prototype.enableCodeMapping=!1,StageMorph.prototype.enableInheritance=!1,StageMorph.prototype.enableSublistIDs=!1,Process.prototype.enableLiveCoding=!1,Process.prototype.isCatchingErrors)try{e=this.serializer.openProject(this.serializer.load(t,this),this)}catch(t){this.showMessage("Load failed: "+t)}else e=this.serializer.openProject(this.serializer.load(t,this),this);return this.stopFastTracking(),e},IDE_Morph.prototype.openCloudDataString=function(t){var e,o=Math.round(t.length/1024);return this.exitReplayMode(),e=this.showMessage("Opening project\n"+o+" KB..."),SnapActions.openProject(t).then(function(){e.destroy()})},IDE_Morph.prototype.rawOpenCloudDataString=function(t){var e,o;if(StageMorph.prototype.hiddenPrimitives={},StageMorph.prototype.codeMappings={},StageMorph.prototype.codeHeaders={},StageMorph.prototype.enableCodeMapping=!1,StageMorph.prototype.enableInheritance=!1,StageMorph.prototype.enableSublistIDs=!1,Process.prototype.enableLiveCoding=!1,SnapActions.disableCollaboration(),SnapUndo.reset(),Process.prototype.isCatchingErrors)try{e=this.serializer.parse(t),this.serializer.loadMediaModel(e.childNamed("media")),o=this.serializer.openProject(this.serializer.loadProjectModel(e.childNamed("project"),this),this)}catch(t){this.showMessage("Load failed: "+t)}else e=this.serializer.parse(t),this.serializer.loadMediaModel(e.childNamed("media")),o=this.serializer.openProject(this.serializer.loadProjectModel(e.childNamed("project"),this),this);return this.stopFastTracking(),o},IDE_Morph.prototype.uniqueIdForImport=function(i,t,r){var n=this;this.nextSteps([function(){nop()},function(){for(var t=n.serializer.parse(i),e=t.allChildren(),o=e.length;o--;)e[o].attributes&&(e[o].attributes.collabId=SnapActions.newId());r(t.toString())}])},IDE_Morph.prototype.openBlocksString=function(t,e,o){var i,r=this;this.nextSteps([function(){i=r.showMessage("Opening blocks...")},function(){nop()},function(){r.rawOpenBlocksString(t,e,o)},function(){i.destroy()}])},IDE_Morph.prototype.rawOpenBlocksString=function(t,e,o){var i;if(Process.prototype.isCatchingErrors)try{i=this.serializer.loadBlocks(t,this.stage)}catch(t){this.showMessage("Load failed: "+t)}else i=this.serializer.loadBlocks(t,this.stage);return o?this.importCustomBlocks(i,e):new BlockImportDialogMorph(i,this.stage,e).popUp(),i},IDE_Morph.prototype.importCustomBlocks=function(t,e){var o=this;t.forEach(function(t){t.receiver=o.stage,o.stage.globalBlocks.push(t),o.stage.replaceDoubleDefinitionsFor(t)}),this.flushPaletteCache(),this.refreshPalette(),this.showMessage("Imported Blocks Module"+(e?": "+e:"")+".",2),SnapActions.loadCustomBlocks(t)},IDE_Morph.prototype.openSpritesString=function(t){var e,o=this;this.nextSteps([function(){e=o.showMessage("Opening sprite...")},function(){nop()},function(){o.rawOpenSpritesString(t)},function(){e.destroy()}])},IDE_Morph.prototype.rawOpenSpritesString=function(t){if(Process.prototype.isCatchingErrors)try{this.serializer.loadSprites(t,this)}catch(t){this.showMessage("Load failed: "+t)}else this.serializer.loadSprites(t,this)},IDE_Morph.prototype.openMediaString=function(t){if(Process.prototype.isCatchingErrors)try{this.serializer.loadMedia(t)}catch(t){this.showMessage("Load failed: "+t)}else this.serializer.loadMedia(t);this.showMessage("Imported Media Module.",2)},IDE_Morph.prototype.openScriptString=function(t){var e,o=this;this.nextSteps([function(){e=o.showMessage("Opening script...")},function(){nop()},function(){o.rawOpenScriptString(t)},function(){e.destroy()}])},IDE_Morph.prototype.rawOpenScriptString=function(t){var e,o,i=this.currentSprite.scripts;if(Process.prototype.isCatchingErrors)try{e=this.serializer.parse(t,this.currentSprite),o=this.serializer.loadScript(e,this.currentSprite)}catch(t){this.showMessage("Load failed: "+t)}else e=this.serializer.loadScript(t,this.currentSprite),o=this.serializer.loadScript(e,this.currentSprite);o.setPosition(this.world().hand.position()),i.add(o),i.adjustBounds(),i.lastDroppedBlock=o,i.recordDrop({origin:this.palette,position:this.palette.center()}),this.showMessage("Imported Script.",2)},IDE_Morph.prototype.openDataString=function(t,e,o){var i,r=this;this.nextSteps([function(){i=r.showMessage("Opening data...")},function(){nop()},function(){r.rawOpenDataString(t,e,o)},function(){i.destroy()}])},IDE_Morph.prototype.rawOpenDataString=function(t,e,o){var i,r,n,s=this,a=this.currentSprite.globalVariables();switch(o){case"csv":i=Process.prototype.parseCSV(t);break;case"json":i=Process.prototype.parseJSON(t);break;default:i=t}return r=function(t){for(var e=a.names(),o=t.indexOf("("),i=o<0?t:t.substring(0,o),r=1,n=i;contains(e,n);)n=i+"("+(r+=1)+")";return n}(e||"data"),SnapActions.addVariable(r,!0).then(function(){a.setVar(r,i),s.currentSprite.toggleVariableWatcher(r,!0),s.flushBlocksCache("variables"),s.currentCategory="variables",s.categories.children.forEach(function(t){t.refresh()}),s.refreshPalette(!0),i instanceof List&&((n=new TableDialogMorph(i)).labelString=localize(n.labelString)+": "+r,n.createLabel(),n.popUp(s.world()))})},IDE_Morph.prototype.openProject=function(t){var e;t&&(this.showMessage("opening project\n"+t),this.setProjectName(t),e=localStorage["-snap-project-"+t],SnapActions.disableCollaboration(),SnapUndo.reset(),this.openProjectString(e),this.setURL("#open:"+e))},IDE_Morph.prototype.setURL=function(t){this.projectsInURLs&&(location.hash=t)},IDE_Morph.prototype.saveFileAs=function(t,e,o,i){var r,n,s,a,h,l=!1,p=this.world();r="."+("plain"===(r=e.split("/")[1].split(";")[0])?"txt":r);try{l=!!new Blob}catch(t){}i?(n=t instanceof Blob?URL.createObjectURL(t):0===(h=t).indexOf("data:")?h:"data:"+e+","+encodeURIComponent(h),a=n,-1!==navigator.userAgent.indexOf("Chrome")&&2e6<a.length?(this.showMessage("download to disk text"),this.saveFileAs(t,e,o)):(window.open(n,o),t instanceof Blob&&URL.revokeObjectURL(n))):l?(t instanceof Blob||(t=function(t,e){var o,i=t,r=t.split(",");if(0===t.indexOf("data:")&&-1<r[0].indexOf("base64"))for(t=atob(r[1]),i=new Uint8Array(t.length),o=t.length;o--;)i[o]=t.charCodeAt(o);return new Blob([i],{type:e})}(t,e)),saveAs(t,o+r,!1)):((s=new DialogBoxMorph).inform(localize("Could not export")+" "+o,"unable to export text",p),s.fixLayout(),s.drawNew())},IDE_Morph.prototype.saveCanvasAs=function(t,e){this.saveFileAs(t.toDataURL(),"image/png",e)},IDE_Morph.prototype.saveXMLAs=function(t,e,o){this.saveFileAs(t,"text/xml;chartset=utf-8",e,o)},IDE_Morph.prototype.switchToUserMode=function(){var e=this.world();e.isDevMode=!1,Process.prototype.isCatchingErrors=!0,this.controlBar.updateLabel(),this.isAutoFill=!0,this.isDraggable=!1,this.reactToWorldResize(e.bounds.copy()),this.siblings().forEach(function(t){t instanceof DialogBoxMorph?e.add(t):t.destroy()}),this.flushBlocksCache(),this.refreshPalette(),e.reactToDropOf=function(t){t instanceof DialogBoxMorph||(e.hand.grabOrigin?t.slideBackTo(e.hand.grabOrigin):e.hand.grab(t))},this.showMessage("entering user mode",1)},IDE_Morph.prototype.switchToDevMode=function(){var t=this.world();t.isDevMode=!0,Process.prototype.isCatchingErrors=!1,this.controlBar.updateLabel(),this.isAutoFill=!1,this.isDraggable=!0,this.setExtent(t.extent().subtract(100)),this.setPosition(t.position().add(20)),this.flushBlocksCache(),this.refreshPalette(),delete t.reactToDropOf,this.showMessage("entering development mode.\n\nerror catching is turned off,\nuse the browser's web console\nto see error messages.")},IDE_Morph.prototype.flushBlocksCache=function(e){e?(this.stage.blocksCache[e]=null,this.stage.children.forEach(function(t){t instanceof SpriteMorph&&(t.blocksCache[e]=null)})):(this.stage.blocksCache={},this.stage.children.forEach(function(t){t instanceof SpriteMorph&&(t.blocksCache={})})),this.flushPaletteCache(e)},IDE_Morph.prototype.flushPaletteCache=function(e){e?(this.stage.paletteCache[e]=null,this.stage.children.forEach(function(t){t instanceof SpriteMorph&&(t.paletteCache[e]=null)})):(this.stage.paletteCache={},this.stage.children.forEach(function(t){t instanceof SpriteMorph&&(t.paletteCache={})}))},IDE_Morph.prototype.toggleZebraColoring=function(){var e=[];BlockMorph.prototype.zebraContrast?BlockMorph.prototype.zebraContrast=0:BlockMorph.prototype.zebraContrast=40,this.stage.children.concat(this.stage).forEach(function(t){isSnapObject(t)&&(e=e.concat(t.scripts.children.filter(function(t){return t instanceof BlockMorph})))}),e.forEach(function(t){t.fixBlockColor(null,!0)})},IDE_Morph.prototype.toggleDynamicInputLabels=function(){var t;if(SyntaxElementMorph.prototype.dynamicInputLabels=!SyntaxElementMorph.prototype.dynamicInputLabels,Process.prototype.isCatchingErrors)try{t=this.serializer.serialize(this.stage)}catch(t){this.showMessage("Serialization failed: "+t)}else t=this.serializer.serialize(this.stage);SpriteMorph.prototype.initBlocks(),this.spriteBar.tabBar.tabTo("scripts"),this.createCategories(),this.createCorralBar(),SnapUndo.reset(),this.openProjectString(t)},IDE_Morph.prototype.toggleBlurredShadows=function(){window.useBlurredShadows=!useBlurredShadows},IDE_Morph.prototype.toggleLongFormInputDialog=function(){InputSlotDialogMorph.prototype.isLaunchingExpanded=!InputSlotDialogMorph.prototype.isLaunchingExpanded,InputSlotDialogMorph.prototype.isLaunchingExpanded?this.saveSetting("longform",!0):this.removeSetting("longform")},IDE_Morph.prototype.togglePlainPrototypeLabels=function(){BlockLabelPlaceHolderMorph.prototype.plainLabel=!BlockLabelPlaceHolderMorph.prototype.plainLabel,BlockLabelPlaceHolderMorph.prototype.plainLabel?this.saveSetting("plainprototype",!0):this.removeSetting("plainprototype")},IDE_Morph.prototype.togglePreferEmptySlotDrops=function(){ScriptsMorph.prototype.isPreferringEmptySlots=!ScriptsMorph.prototype.isPreferringEmptySlots},IDE_Morph.prototype.toggleVirtualKeyboard=function(){MorphicPreferences.useVirtualKeyboard=!MorphicPreferences.useVirtualKeyboard},IDE_Morph.prototype.toggleInputSliders=function(){MorphicPreferences.useSliderForInput=!MorphicPreferences.useSliderForInput},IDE_Morph.prototype.toggleSliderExecute=function(){ArgMorph.prototype.executeOnSliderEdit=!ArgMorph.prototype.executeOnSliderEdit},IDE_Morph.prototype.toggleAppMode=function(t){var e=this.world(),o=[this.logo,this.controlBar.cloudButton,this.controlBar.projectButton,this.controlBar.settingsButton,this.controlBar.steppingButton,this.controlBar.stageSizeButton,this.paletteHandle,this.stageHandle,this.corral,this.corralBar,this.spriteEditor,this.spriteBar,this.palette,this.categories];this.isAppMode=isNil(t)?!this.isAppMode:t,Morph.prototype.trackChanges=!1,this.isAppMode?(this.wasSingleStepping=Process.prototype.enableSingleStepping,this.wasSingleStepping&&this.toggleSingleStepping(),this.setColor(this.appModeColor),this.controlBar.setColor(this.color),this.controlBar.appModeButton.refresh(),o.forEach(function(t){t.hide()}),e.children.forEach(function(t){t instanceof DialogBoxMorph&&t.hide()}),e.keyboardReceiver instanceof ScriptFocusMorph&&e.keyboardReceiver.stopEditing()):(this.wasSingleStepping&&!Process.prototype.enableSingleStepping&&this.toggleSingleStepping(),this.setColor(this.backgroundColor),this.controlBar.setColor(this.frameColor),o.forEach(function(t){t.show()}),this.stage.setScale(1),e.children.forEach(function(t){t instanceof DialogBoxMorph&&t.show()}),e.allChildren().filter(function(t){return t instanceof ScrollFrameMorph}).forEach(function(t){t.adjustScrollBars()}),this.currentSprite===this.stage&&this.spriteBar.children.forEach(function(t){t instanceof PushButtonMorph&&t.hide()})),this.setExtent(this.world().extent()),this.isMobileDevice()&&this.isAppMode&&this.mobileMode.init()},IDE_Morph.prototype.toggleStageSize=function(t,e){var o=this,i=e||.5,r=this.isAnimating?100:0,n=this.world(),s=16===n.currentKey,a=18===n.currentKey;function h(){o.isSmallStage=isNil(t)?!o.isSmallStage:t}function l(t){o.isSmallStage=!0,n.animations.push(new Animation(function(t){o.stageRatio=t,o.setExtent(n.extent())},function(){return o.stageRatio},t-o.stageRatio,r,null,function(){o.isSmallStage=1!==t,o.controlBar.stageSizeButton.refresh()}))}s?(i=3*SpriteIconMorph.prototype.thumbSize.x/this.stage.dimensions.x,this.isSmallStage&&i!==this.stageRatio||h()):a?(i=this.width()/2/this.stage.dimensions.x,this.isSmallStage&&i!==this.stageRatio||h()):h(),this.isSmallStage?l(i):l(1)},IDE_Morph.prototype.setPaletteWidth=function(t){var e=this.isAnimating?100:0,o=this.world(),i=this;o.animations.push(new Animation(function(t){i.paletteWidth=t,i.setExtent(o.extent())},function(){return i.paletteWidth},t-i.paletteWidth,e))},IDE_Morph.prototype.createNewProject=function(){var t=this;this.confirm("Replace the current project with a new one?","New Project",function(){t.exitReplayMode(),SnapActions.disableCollaboration(),SnapUndo.reset(),t.newProject()})},IDE_Morph.prototype.openProjectsBrowser=function(){new ProjectDialogMorph(this,"open").popUp()},IDE_Morph.prototype.saveProjectsBrowser=function(){"examples"===this.source&&(this.source="local"),new ProjectDialogMorph(this,"save").popUp()},IDE_Morph.prototype.languageMenu=function(){var e=new MenuMorph(this),t=this.world(),o=this.controlBar.settingsButton.bottomLeft(),i=this;SnapTranslator.languages().forEach(function(t){e.addItem((SnapTranslator.language===t?"✓ ":"    ")+SnapTranslator.languageName(t),function(){i.loadNewProject=!1,i.setLanguage(t)})}),e.popup(t,o)},IDE_Morph.prototype.setLanguage=function(t,e){var o=document.getElementById("language"),i=this.resourceURL("lang-"+t+".js"),r=this;if(SnapTranslator.unload(),o&&document.head.removeChild(o),"en"===t)return this.reflectLanguage("en",e);(o=document.createElement("script")).id="language",o.onload=function(){r.reflectLanguage(t,e)},document.head.appendChild(o),o.src=i},IDE_Morph.prototype.reflectLanguage=function(t,e){var o,i=location.hash;if(SnapTranslator.language=t,!this.loadNewProject)if(Process.prototype.isCatchingErrors)try{o=this.serializer.serialize(this.stage)}catch(t){this.showMessage("Serialization failed: "+t)}else o=this.serializer.serialize(this.stage);SpriteMorph.prototype.initBlocks(),this.spriteBar.tabBar.tabTo("scripts"),this.createCategories(),this.createCorralBar(),this.fixLayout(),this.loadNewProject?(this.newProject(),location.hash=i):(SnapUndo.reset(),this.openProjectString(o)),this.saveSetting("language",t),e&&e.call(this)},IDE_Morph.prototype.userSetBlocksScale=function(){var t,e,o,i,r,n=this;(t=new CommandBlockMorph).color=SpriteMorph.prototype.blockColor.motion,t.setSpec(localize("build")),(e=new CommandBlockMorph).color=SpriteMorph.prototype.blockColor.sound,e.setSpec(localize("your own")),t.nextBlock(e),(e=new CommandBlockMorph).color=SpriteMorph.prototype.blockColor.operators,e.setSpec(localize("blocks")),t.bottomBlock().nextBlock(e),(i=new FrameMorph).acceptsDrops=!1,i.color=IDE_Morph.prototype.groupColor,i.cachedTexture=this.scriptsPaneTexture,i.setExtent(new Point(250,180)),t.setPosition(i.position().add(10)),i.add(t),(o=new Morph).alpha=0,o.setExtent(i.extent()),o.setPosition(i.position()),i.add(o),r=function(e){t.blockSequence().forEach(function(t){t.setScale(e),t.drawNew(),t.setSpec(t.blockSpec)}),t.changed()},new DialogBoxMorph(null,function(t){n.setBlocksScale(Math.min(t,12))}).withKey("zoomBlocks").prompt("Zoom blocks",SyntaxElementMorph.prototype.scale.toString(),this.world(),i,{"normal (1x)":1,"demo (1.2x)":1.2,"presentation (1.4x)":1.4,"big (2x)":2,"huge (4x)":4,"giant (8x)":8,"monstrous (10x)":10},!1,!0,1,12,r)},IDE_Morph.prototype.setBlocksScale=function(t){var e;if(Process.prototype.isCatchingErrors)try{e=this.serializer.serialize(this.stage)}catch(t){this.showMessage("Serialization failed: "+t)}else e=this.serializer.serialize(this.stage);SyntaxElementMorph.prototype.setScale(t),CommentMorph.prototype.refreshScale(),SpriteMorph.prototype.initBlocks(),this.spriteBar.tabBar.tabTo("scripts"),this.createCategories(),this.createCorralBar(),this.fixLayout(),this.openProjectString(e),this.saveSetting("zoom",t)},IDE_Morph.prototype.userSetStageSize=function(){new DialogBoxMorph(this,function(t){SnapActions.setStageSize(t.x,t.y)},this).promptVector("Stage size",StageMorph.prototype.dimensions,new Point(480,360),"Stage width","Stage height",this.world(),null,null)},IDE_Morph.prototype.setStageExtent=function(t){var e=this,o=this.world(),i=t.max(new Point(480,180));this.stageRatio=1,this.isSmallStage=!1,this.controlBar.stageSizeButton.refresh(),this.setExtent(o.extent()),this.isAnimating?e.step=function(){var t=i.subtract(StageMorph.prototype.dimensions).divideBy(2);t.abs().lt(new Point(5,5))?(StageMorph.prototype.dimensions=i,delete e.step):StageMorph.prototype.dimensions=StageMorph.prototype.dimensions.add(t),e.stage.setExtent(StageMorph.prototype.dimensions),e.stage.clearPenTrails(),e.fixLayout(),this.setExtent(o.extent())}:(StageMorph.prototype.dimensions=i,this.stage.setExtent(StageMorph.prototype.dimensions),this.stage.clearPenTrails(),this.fixLayout(),this.setExtent(o.extent()))},IDE_Morph.prototype.userSetDragThreshold=function(){new DialogBoxMorph(this,function(t){MorphicPreferences.grabThreshold=Math.min(Math.max(+t,0),200)},this).prompt("Dragging threshold",MorphicPreferences.grabThreshold.toString(),this.world(),null,null,null,!0)},IDE_Morph.prototype.initializeCloud=function(){var i=this,t=this.world();new DialogBoxMorph(null,function(t){var e,o=hex_sha512(t.password);SnapCloud.login(t.username,o,function(){t.choice&&(e=SnapCloud.encodeDict({username:t.username,password:o}),localStorage["-snap-user"]=e),i.source="cloud",i.showMessage("now connected.",2)},i.cloudError())}).withKey("cloudlogin").promptCredentials("Sign in","login",null,null,null,null,"stay signed in on this computer\nuntil logging out",t,i.cloudIcon(),i.cloudMsg)},IDE_Morph.prototype.createCloudAccount=function(){var o=this,i=this.world();new DialogBoxMorph(null,function(t){SnapCloud.signup(t.username,t.email,function(t,e){(new DialogBoxMorph).inform(e,t+".\n\nAn e-mail with your password\nhas been sent to the address provided",i,o.cloudIcon(null,new Color(0,180,0)))},o.cloudError())}).withKey("cloudsignup").promptCredentials("Sign up","signup","http://snap.berkeley.edu/tos.html","Terms of Service...","http://snap.berkeley.edu/privacy.html","Privacy...","I have read and agree\nto the Terms of Service",i,o.cloudIcon(),o.cloudMsg)},IDE_Morph.prototype.promptCollaboration=function(){var t,e=(new DialogBoxMorph).withKey("promptCollab"),o=new AlignmentMorph("column",10),i=new TextMorph(localize("Share the following url with any collaborators:")),r=(e.ok,SnapActions.sessionId),n=this.world();t="collaborate="+r,shareCode=window.location.origin+"#"+t,location.hash=t,o.add(i),o.add(new TextMorph(shareCode)),e.labelString="Collaboration",e.createLabel(),e.addBody(o),o.drawNew(),e.addButton("ok","OK"),e.addButton("cancel","Cancel"),e.fixLayout(),e.drawNew(),e.popUp(n),e.setCenter(n.center())},IDE_Morph.prototype.promptExitReplay=function(t){var e=this;this.confirm("The given action cannot be applied while in replay mode. \nWould you like to exit replay mode?","Exit Replay?",function(){e.exitReplayMode(),t()})},IDE_Morph.prototype.resetCloudPassword=function(){var o=this,i=this.world();new DialogBoxMorph(null,function(t){SnapCloud.resetPassword(t.username,function(t,e){(new DialogBoxMorph).inform(e,t+".\n\nAn e-mail with a link to\nreset your password\nhas been sent to the address provided",i,o.cloudIcon(null,new Color(0,180,0)))},o.cloudError())}).withKey("cloudresetpassword").promptCredentials("Reset password","resetPassword",null,null,null,null,null,i,o.cloudIcon(),o.cloudMsg)},IDE_Morph.prototype.changeCloudPassword=function(){var e=this,t=this.world();new DialogBoxMorph(null,function(t){SnapCloud.changePassword(t.oldpassword,t.password,function(){e.logout(),e.showMessage("password has been changed.",2)},e.cloudError())}).withKey("cloudpassword").promptCredentials("Change Password","changePassword",null,null,null,null,null,t,e.cloudIcon(),e.cloudMsg)},IDE_Morph.prototype.logout=function(){var t=this;delete localStorage["-snap-user"],SnapCloud.logout(function(){SnapCloud.clear(),t.showMessage("disconnected.",2)},function(){SnapCloud.clear(),t.showMessage("disconnected.",2)})},IDE_Morph.prototype.saveProjectToCloud=function(t){var e=this,o=this.room.hasMultipleRoles()?this.room.getCurrentRoleName():this.room.name;t&&(this.showMessage("Saving "+o+"\nto the cloud..."),this.room.name=t,SnapCloud.saveProject(this,function(t){t.name&&e.room.silentSetRoomName(t.name),e.showMessage("Saved "+o+" to the cloud!",2)},this.cloudSaveError()))},IDE_Morph.prototype.exportProjectMedia=function(t){var e,o;if(this.serializer.isCollectingMedia=!0,t){this.setProjectName(t);try{e=this.showMessage("Exporting"),o=this.serializer.mediaXML(t),this.saveXMLAs(o,this.projectName+" media"),e.destroy(),this.showMessage("Exported!",1)}catch(t){if(!Process.prototype.isCatchingErrors)throw t;this.serializer.isCollectingMedia=!1,this.showMessage("Export failed: "+t)}}this.serializer.isCollectingMedia=!1,this.serializer.flushMedia()},IDE_Morph.prototype.exportProjectNoMedia=function(t){var e,o;if(this.serializer.isCollectingMedia=!0,t)if(this.setProjectName(t),Process.prototype.isCatchingErrors)try{e=this.showMessage("Exporting"),o=this.serializer.serialize(this.stage),this.saveXMLAs(o,this.projectName),e.destroy(),this.showMessage("Exported!",1)}catch(t){this.serializer.isCollectingMedia=!1,this.showMessage("Export failed: "+t)}else e=this.showMessage("Exporting"),o=this.serializer.serialize(this.stage),this.saveXMLAs(o,this.projectName),e.destroy(),this.showMessage("Exported!",1);this.serializer.isCollectingMedia=!1,this.serializer.flushMedia()},IDE_Morph.prototype.exportProjectAsCloudData=function(t){var e,o,i;if(this.serializer.isCollectingMedia=!0,t)if(this.setProjectName(t),Process.prototype.isCatchingErrors)try{e=this.showMessage("Exporting"),o=this.serializer.serialize(this.stage),i=this.serializer.mediaXML(t),"<snapdata>"+o+this.serializer.replayHistory()+i+"</snapdata>",this.saveXMLAs(o,this.projectName),e.destroy(),this.showMessage("Exported!",1)}catch(t){this.serializer.isCollectingMedia=!1,this.showMessage("Export failed: "+t)}else e=this.showMessage("Exporting"),o=this.serializer.serialize(this.stage),i=this.serializer.mediaXML(t),"<snapdata>"+o+this.serializer.replayHistory()+i+"</snapdata>",this.saveXMLAs(o,this.projectName),e.destroy(),this.showMessage("Exported!",1);this.serializer.isCollectingMedia=!1,this.serializer.flushMedia()},IDE_Morph.prototype.cloudAcknowledge=function(){var o=this;return function(t,e){nop(t),(new DialogBoxMorph).inform("Cloud Connection","Successfully connected to:\nhttp://"+e,o.world(),o.cloudIcon(null,new Color(0,180,0)))}},IDE_Morph.prototype.cloudResponse=function(){var i=this;return function(t,e){var o=t;50<o.length&&(o=o.substring(0,50)+"..."),(new DialogBoxMorph).inform("Snap!Cloud","http://"+e+":\n\nresponds:\n"+o,i.world(),i.cloudIcon(null,new Color(0,180,0)))}},IDE_Morph.prototype.cloudError=function(){var i=this;return function(t,e){var o=t;i.shield&&(i.shield.destroy(),i.shield=null),50<o.length&&(o=o.substring(0,50)+"..."),(new DialogBoxMorph).inform("Snap!Cloud",(e?e+"\n":"")+o,i.world(),i.cloudIcon(null,new Color(180,0,0)))}},IDE_Morph.prototype.cloudIcon=function(t,e){var o=e||DialogBoxMorph.prototype.titleBarColor,i=MorphicPreferences.isFlat,r=new SymbolMorph(i?"cloud":"cloudGradient",t||50,o,i?null:new Point(-1,-1),o.darker(50));return i||r.addShadow(new Point(1,1),1,o.lighter(95)),r},IDE_Morph.prototype.setCloudURL=function(){new DialogBoxMorph(null,function(t){SnapCloud.url=t}).withKey("cloudURL").prompt("Cloud URL",SnapCloud.url,this.world(),null,{"Snap!Cloud":"https://snap.apps.miosoft.com/SnapCloud"})},IDE_Morph.prototype.getURL=function(t,e){var o=new XMLHttpRequest,i=e instanceof Function,r=this;try{if(o.open("GET",t,i),i&&(o.onreadystatechange=function(){if(4===o.readyState){if(!o.responseText)throw new Error("unable to retrieve "+t);e.call(r,o.responseText)}}),o.send(),!i){if(200===o.status)return o.responseText;throw new Error("unable to retrieve "+t)}}catch(t){if(r.showMessage(t.toString()),!i)return o.responseText;e.call(this)}},IDE_Morph.prototype.showMessage=function(t,e){var o,i=new MenuMorph(null,t);return i.popUpCenteredInWorld(this.world()),e&&(o=setInterval(function(){i.destroy(),clearInterval(o)},1e3*e)),i},IDE_Morph.prototype.inform=function(t,e){(new DialogBoxMorph).inform(t,localize(e),this.world())},IDE_Morph.prototype.confirm=function(t,e,o){new DialogBoxMorph(null,o).askYesNo(e,localize(t),this.world())},IDE_Morph.prototype.prompt=function(t,e,o,i){new DialogBoxMorph(null,e).withKey(i).prompt(t,"",this.world(),null,o)},ProjectDialogMorph.prototype=new DialogBoxMorph,ProjectDialogMorph.prototype.constructor=ProjectDialogMorph,ProjectDialogMorph.uber=DialogBoxMorph.prototype,ProjectDialogMorph.prototype.init=function(t,e){var o=this;this.ide=t,this.task=e||"open",this.source=t.source||"local",this.projectList=[],this.handle=null,this.srcBar=null,this.nameField=null,this.filterField=null,this.magnifiyingGlass=null,this.listField=null,this.preview=null,this.notesText=null,this.notesField=null,this.deleteButton=null,this.shareButton=null,this.unshareButton=null,ProjectDialogMorph.uber.init.call(this,this,null,null),this.labelString="save"===this.task?"Save Project":"Open Project",this.createLabel(),this.key="project"+e,this.buildContents(),this.onNextStep=function(){o.setSource(o.source)}},ProjectDialogMorph.prototype.buildContents=function(){var t,e,o=new Point(455,335);this.addBody(new Morph),this.body.color=this.color,this.srcBar=new AlignmentMorph("column",this.padding/2),this.ide.cloudMsg&&((e=new TextMorph(this.ide.cloudMsg,10,null,!1,null,null,null,null,new Point(1,1),new Color(255,255,255))).refresh=nop,this.srcBar.add(e)),this.addSourceButton("cloud",localize("Cloud"),"cloud"),"open"===this.task&&(this.addSourceButton("cloud-shared",localize("Shared with me"),"cloud"),o.y+=50),this.addSourceButton("local",localize("Browser"),"storage"),"open"===this.task&&(this.buildFilterField(),this.addSourceButton("examples",localize("Examples"),"poster")),this.srcBar.fixLayout(),this.body.add(this.srcBar),"save"===this.task&&(this.nameField=new InputFieldMorph(this.ide.room.name),this.body.add(this.nameField)),this.listField=new ListMorph([]),this.fixListFieldItemColors(),this.listField.fixLayout=nop,this.listField.edge=InputFieldMorph.prototype.edge,this.listField.fontSize=InputFieldMorph.prototype.fontSize,this.listField.typeInPadding=InputFieldMorph.prototype.typeInPadding,this.listField.contrast=InputFieldMorph.prototype.contrast,this.listField.drawNew=InputFieldMorph.prototype.drawNew,this.listField.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,this.body.add(this.listField),this.preview=new Morph,this.preview.fixLayout=nop,this.preview.edge=InputFieldMorph.prototype.edge,this.preview.fontSize=InputFieldMorph.prototype.fontSize,this.preview.typeInPadding=InputFieldMorph.prototype.typeInPadding,this.preview.contrast=InputFieldMorph.prototype.contrast,this.preview.drawNew=function(){InputFieldMorph.prototype.drawNew.call(this),this.texture&&this.drawTexture(this.texture)},this.preview.drawCachedTexture=function(){var t=this.image.getContext("2d"),e=Math.min(this.width()/this.cachedTexture.width,this.height()/this.cachedTexture.height),o=e*this.cachedTexture.width,i=e*this.cachedTexture.height;t.drawImage(this.cachedTexture,this.edge,this.edge,o,i),this.changed()},this.preview.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,this.preview.setExtent(this.ide.serializer.thumbnailSize.divideBy(4).add(2*this.preview.edge)),this.body.add(this.preview),this.preview.drawNew(),"save"===this.task&&(t=this.ide.stage.thumbnail(SnapSerializer.prototype.thumbnailSize),this.preview.texture=null,this.preview.cachedTexture=t,this.preview.drawCachedTexture()),this.notesField=new ScrollFrameMorph,this.notesField.fixLayout=nop,this.notesField.edge=InputFieldMorph.prototype.edge,this.notesField.fontSize=InputFieldMorph.prototype.fontSize,this.notesField.typeInPadding=InputFieldMorph.prototype.typeInPadding,this.notesField.contrast=InputFieldMorph.prototype.contrast,this.notesField.drawNew=InputFieldMorph.prototype.drawNew,this.notesField.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,this.notesField.acceptsDrops=!1,this.notesField.contents.acceptsDrops=!1,"open"===this.task?this.notesText=new TextMorph(""):(this.notesText=new TextMorph(this.ide.projectNotes),this.notesText.isEditable=!0,this.notesText.enableSelecting()),this.notesField.isTextLineWrapping=!0,this.notesField.padding=3,this.notesField.setContents(this.notesText),this.notesField.setWidth(this.preview.width()),this.body.add(this.notesField),"open"===this.task?(this.addButton("openProject","Open"),this.action="openProject"):(this.addButton("saveProject","Save"),this.action="saveProject"),this.shareButton=this.addButton("shareProject","Share"),this.unshareButton=this.addButton("unshareProject","Unshare"),this.shareButton.hide(),this.unshareButton.hide(),this.deleteButton=this.addButton("deleteProject","Delete"),this.addButton("cancel","Cancel"),e?this.setExtent(o.add(e.extent())):this.setExtent(o),this.fixLayout()},ProjectDialogMorph.prototype.popUp=function(t){var e=t||this.ide.world();e&&(ProjectDialogMorph.uber.popUp.call(this,e),this.handle=new HandleMorph(this,350,300,this.corner,this.corner))},ProjectDialogMorph.prototype.addSourceButton=function(t,e,o){var i,r=this,n=new StringMorph(e,10,null,!0,null,null,new Point(1,1),new Color(255,255,255)),s=new StringMorph(e,10,null,!0,null,null,new Point(-1,-1),this.titleBarColor.darker(50),new Color(255,255,255)),a=new Morph,h=new Morph;n.add(new SymbolMorph(o,24,this.titleBarColor.darker(20),new Point(1,1),this.titleBarColor.darker(50))),n.children[0].setCenter(n.center()),n.children[0].setBottom(n.top()-this.padding/2),a.image=n.fullImage(),a.bounds=n.fullBounds(),s.add(new SymbolMorph(o,24,new Color(255,255,255),new Point(-1,-1),this.titleBarColor.darker(50))),s.children[0].setCenter(s.center()),s.children[0].setBottom(s.top()-this.padding/2),h.image=s.fullImage(),h.bounds=s.fullBounds(),(i=new ToggleButtonMorph(null,r,function(){r.setSource(t)},[a,h],function(){return r.source===t})).corner=this.buttonCorner,i.edge=this.buttonEdge,i.outline=this.buttonOutline,i.outlineColor=this.buttonOutlineColor,i.outlineGradient=this.buttonOutlineGradient,i.labelMinExtent=new Point(60,0),i.padding=this.buttonPadding,i.contrast=this.buttonContrast,i.pressColor=this.titleBarColor.darker(20),i.drawNew(),i.fixLayout(),i.refresh(),this.srcBar.add(i)},ProjectDialogMorph.prototype.fixListFieldItemColors=function(){var e=this;this.listField.contents.children[0].alpha=0,this.listField.contents.children[0].children.forEach(function(t){t.pressColor=e.titleBarColor.darker(20),t.color=new Color(0,0,0,0),t.noticesTransparentClick=!0})},ProjectDialogMorph.prototype.buildFilterField=function(){var e=this;this.filterField=new InputFieldMorph(""),this.magnifiyingGlass=new SymbolMorph("magnifiyingGlass",this.filterField.height(),this.titleBarColor.darker(50)),this.body.add(this.magnifiyingGlass),this.body.add(this.filterField),this.filterField.reactToKeystroke=function(t){var i=this.getValue();e.listField.elements=e.projectList.filter(function(t){var e,o;return o=t.ProjectName?(e=t.ProjectName,t.Notes):(e=t.name,t.notes||""),-1<e.toLowerCase().indexOf(i.toLowerCase())||-1<o.toLowerCase().indexOf(i.toLowerCase())}),0===e.listField.elements.length&&e.listField.elements.push("(no matches)"),e.clearDetails(),e.listField.buildListContents(),e.fixListFieldItemColors(),e.listField.adjustScrollBars(),e.listField.scrollY(e.listField.top()),e.fixLayout()}},ProjectDialogMorph.prototype.setSource=function(t){var o,i=this;switch(this.source=t,this.srcBar.children.forEach(function(t){t.refresh()}),this.source){case"cloud":return o=i.ide.showMessage("Updating\nproject list..."),this.projectList=[],void SnapCloud.getProjectList(function(t){"cloud"===i.source&&i.installCloudProjectList(t),o.destroy()},function(t,e){o.destroy(),i.ide.cloudError().call(null,t,e)});case"cloud-shared":return o=i.ide.showMessage("Updating\nproject list..."),this.projectList=[],void SnapCloud.getSharedProjectList(function(t){"cloud-shared"===i.source&&i.installSharedCloudProjectList(t),o.destroy()},function(t,e){o.destroy(),i.ide.cloudError().call(null,t,e)});case"examples":this.projectList=this.getExamplesProjectList();break;case"local":this.projectList=this.getLocalProjectList()}this.listField.destroy(),this.listField=new ListMorph(this.projectList,0<this.projectList.length?function(t){return t.name||t}:null,null,function(){i.ok()}),this.fixListFieldItemColors(),this.listField.fixLayout=nop,this.listField.edge=InputFieldMorph.prototype.edge,this.listField.fontSize=InputFieldMorph.prototype.fontSize,this.listField.typeInPadding=InputFieldMorph.prototype.typeInPadding,this.listField.contrast=InputFieldMorph.prototype.contrast,this.listField.drawNew=InputFieldMorph.prototype.drawNew,this.listField.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,"local"===this.source?this.listField.action=function(t){var e,o;void 0!==t&&(i.nameField&&i.nameField.setContents(t.name||""),"open"===i.task&&(e=localStorage["-snap-project-"+t.name])&&(o=(o=i.ide.serializer.parse(e)).children[0].children[0],i.notesText.text=o.childNamed("notes").contents||"",i.notesText.drawNew(),i.notesField.contents.adjustBounds(),i.preview.texture=o.childNamed("thumbnail").contents||null,i.preview.cachedTexture=null,i.preview.drawNew()),i.edit())}:this.listField.action=function(t){var e,o;void 0!==t&&(i.nameField&&i.nameField.setContents(t.name||""),e=i.ide.getURL(i.ide.resourceURL("Examples",t.fileName)),o=(o=i.ide.serializer.parse(e)).children[0].children[0],i.notesText.text=o.childNamed("notes").contents||"",i.notesText.drawNew(),i.notesField.contents.adjustBounds(),i.preview.texture=o.childNamed("thumbnail").contents||null,i.preview.cachedTexture=null,i.preview.drawNew(),i.edit())},this.body.add(this.listField),this.shareButton.hide(),this.unshareButton.hide(),"local"===this.source?this.deleteButton.show():this.deleteButton.hide(),this.buttons.fixLayout(),this.fixLayout(),"open"===this.task&&this.clearDetails()},ProjectDialogMorph.prototype.getLocalProjectList=function(){var t,e,o=[];for(t in localStorage)Object.prototype.hasOwnProperty.call(localStorage,t)&&"-snap-project-"===t.substr(0,14)&&(e={name:t.substr(14),thumb:null,notes:null},o.push(e));return o.sort(function(t,e){return t.name.toLowerCase()<e.name.toLowerCase()?-1:1}),o},ProjectDialogMorph.prototype.getExamplesProjectList=function(){return this.ide.getMediaList("Examples")},ProjectDialogMorph.prototype.installSharedCloudProjectList=function(t){var e=this;this.projectList=t||[],this.projectList.sort(function(t,e){return t.ProjectName.toLowerCase()<e.ProjectName.toLowerCase()?-1:1}),this.listField.destroy(),this.listField=new ListMorph(this.projectList,0<this.projectList.length?function(t){return t.ProjectName||t}:null,[["bold",function(t){return"true"===t.Public}]],function(){e.ok()}),this.fixListFieldItemColors(),this.listField.fixLayout=nop,this.listField.edge=InputFieldMorph.prototype.edge,this.listField.fontSize=InputFieldMorph.prototype.fontSize,this.listField.typeInPadding=InputFieldMorph.prototype.typeInPadding,this.listField.contrast=InputFieldMorph.prototype.contrast,this.listField.drawNew=InputFieldMorph.prototype.drawNew,this.listField.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,this.listField.action=function(t){void 0!==t&&(e.nameField&&e.nameField.setContents(t.ProjectName||""),"open"===e.task&&(e.notesText.text=t.Notes||"",e.notesText.drawNew(),e.notesField.contents.adjustBounds(),e.preview.texture=t.Thumbnail||null,e.preview.cachedTexture=null,e.preview.drawNew(),new SpeechBubbleMorph(new TextMorph(localize("owner")+": "+t.Owner+"\n"+localize("last changed")+"\n"+t.Updated,null,null,null,null,"center")).popUp(e.world(),e.preview.rightCenter().add(new Point(2,0)))),"true"===t.Public?(e.shareButton.hide(),e.unshareButton.show()):(e.unshareButton.hide(),e.shareButton.show()),e.buttons.fixLayout(),e.fixLayout(),e.edit())},this.body.add(this.listField),this.shareButton.show(),this.unshareButton.hide(),this.deleteButton.show(),this.buttons.fixLayout(),this.fixLayout(),"open"===this.task&&this.clearDetails()},ProjectDialogMorph.prototype.installCloudProjectList=function(t){var e=this;this.projectList=t||[],this.projectList.sort(function(t,e){return t.ProjectName.toLowerCase()<e.ProjectName.toLowerCase()?-1:1}),this.listField.destroy(),this.listField=new ListMorph(this.projectList,0<this.projectList.length?function(t){return t.ProjectName||t}:null,[["bold",function(t){return"true"===t.Public}]],function(){e.ok()}),this.fixListFieldItemColors(),this.listField.fixLayout=nop,this.listField.edge=InputFieldMorph.prototype.edge,this.listField.fontSize=InputFieldMorph.prototype.fontSize,this.listField.typeInPadding=InputFieldMorph.prototype.typeInPadding,this.listField.contrast=InputFieldMorph.prototype.contrast,this.listField.drawNew=InputFieldMorph.prototype.drawNew,this.listField.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,this.listField.action=function(t){void 0!==t&&(e.nameField&&e.nameField.setContents(t.ProjectName||""),"open"===e.task&&(e.notesText.text=t.Notes||"",e.notesText.drawNew(),e.notesField.contents.adjustBounds(),e.preview.texture=t.Thumbnail||null,e.preview.cachedTexture=null,e.preview.drawNew(),new SpeechBubbleMorph(new TextMorph(localize("last changed")+"\n"+t.Updated,null,null,null,null,"center")).popUp(e.world(),e.preview.rightCenter().add(new Point(2,0)))),"true"===t.Public?(e.shareButton.hide(),e.unshareButton.show()):(e.unshareButton.hide(),e.shareButton.show()),e.buttons.fixLayout(),e.fixLayout(),e.edit())},this.body.add(this.listField),this.shareButton.show(),this.unshareButton.hide(),this.deleteButton.show(),this.buttons.fixLayout(),this.fixLayout(),"open"===this.task&&this.clearDetails()},ProjectDialogMorph.prototype.clearDetails=function(){this.notesText.text="",this.notesText.drawNew(),this.notesField.contents.adjustBounds(),this.preview.texture=null,this.preview.cachedTexture=null,this.preview.drawNew()},ProjectDialogMorph.prototype.openProject=function(){var t,e=this.listField.selected;e&&(this.ide.source=this.source,"cloud"===this.source?this.openCloudProject(e):("examples"===this.source?(t=this.ide.getURL(this.ide.resourceURL("Examples",e.fileName)),SnapActions.disableCollaboration(),SnapUndo.reset(),this.ide.openProjectString(t)):this.ide.openProject(e.name),this.destroy()))},ProjectDialogMorph.prototype.openCloudProject=function(t){var e=this;e.ide.nextSteps([function(){e.ide.showMessage("Fetching project\nfrom the cloud...")},function(){e.rawOpenCloudProject(t)}])},ProjectDialogMorph.prototype.rawOpenCloudProject=function(e){var o=this;SnapCloud.reconnect(function(){SnapCloud.callService("getRawProject",function(t){SnapCloud.disconnect(),o.ide.source="cloud",o.ide.droppedText(t),"true"===e.Public&&(location.hash="#present:Username="+encodeURIComponent(SnapCloud.username)+"&ProjectName="+encodeURIComponent(e.ProjectName))},o.ide.cloudError(),[e.ProjectName])},o.ide.cloudError()),this.destroy()},ProjectDialogMorph.prototype.saveProject=function(){var e=this.nameField.contents().text.text,t=this.notesText.text,o=this;this.ide.projectNotes=t||this.ide.projectNotes,/[\.@]+/.test(e)?this.ide.inform("Invalid Project Name","Could not save project because\nthe provided name contains illegal characters.",this.world()):"cloud"===this.source?detect(this.projectList,function(t){return t.ProjectName===e})?this.ide.confirm(localize("Are you sure you want to replace")+'\n"'+e+'"?',"Replace Project",function(){o.saveCloudProject(e)}):o.saveCloudProject(e):detect(this.projectList,function(t){return t.name===e})?this.ide.confirm(localize("Are you sure you want to replace")+'\n"'+e+'"?',"Replace Project",function(){o.ide.room.name=e,o.ide.source="local",o.ide.saveProject(e),o.destroy()}):(this.ide.room.name=e,o.ide.source="local",this.ide.saveProject(e),this.destroy())},ProjectDialogMorph.prototype.saveCloudProject=function(t){var e=this;this.ide.showMessage("Saving project\nto the cloud..."),SnapCloud.saveProject(this.ide,function(t){t.name&&e.ide.room.silentSetRoomName(t.name),e.ide.source="cloud",e.ide.showMessage("Saved to cloud!",2)},this.ide.cloudError(),!0,t),this.destroy()},ProjectDialogMorph.prototype.deleteProject=function(){var t,e,o,i=this;"cloud"===this.source?(t=this.listField.selected)&&this.ide.confirm(localize("Are you sure you want to delete")+'\n"'+t.ProjectName+'"?',"Delete Project",function(){SnapCloud.reconnect(function(){SnapCloud.callService("deleteProject",function(){SnapCloud.disconnect(),i.ide.hasChangedMedia=!0,e=i.projectList.indexOf(t),i.projectList.splice(e,1),i.installCloudProjectList(i.projectList)},i.ide.cloudError(),[t.ProjectName])},i.ide.cloudError())}):this.listField.selected&&(o=this.listField.selected.name,this.ide.confirm(localize("Are you sure you want to delete")+'\n"'+o+'"?',"Delete Project",function(){delete localStorage["-snap-project-"+o],i.setSource(i.source)}))},ProjectDialogMorph.prototype.shareProject=function(){var o=this,i=this.ide,r=this.listField.selected,n=this.listField.active;r&&this.ide.confirm(localize("Are you sure you want to publish")+'\n"'+r.ProjectName+'"?',"Share Project",function(){o.ide.showMessage("sharing\nproject..."),SnapCloud.reconnect(function(){if(SnapCloud.callService("publishProject",function(){SnapCloud.disconnect(),r.Public="true",o.unshareButton.show(),o.shareButton.hide(),n.label.isBold=!0,n.label.drawNew(),n.label.changed(),o.buttons.fixLayout(),o.drawNew(),o.ide.showMessage("shared.",2)},o.ide.cloudError(),[r.ProjectName]),r.ProjectName===i.projectName){var t=SnapCloud.username,e="Username="+encodeURIComponent(t.toLowerCase())+"&ProjectName="+encodeURIComponent(r.ProjectName);location.hash="present:"+e}},o.ide.cloudError())})},ProjectDialogMorph.prototype.unshareProject=function(){var t=this,e=this.ide,o=this.listField.selected,i=this.listField.active;o&&this.ide.confirm(localize("Are you sure you want to unpublish")+'\n"'+o.ProjectName+'"?',"Unshare Project",function(){t.ide.showMessage("unsharing\nproject..."),SnapCloud.reconnect(function(){SnapCloud.callService("unpublishProject",function(){SnapCloud.disconnect(),o.Public="false",t.shareButton.show(),t.unshareButton.hide(),i.label.isBold=!1,i.label.drawNew(),i.label.changed(),t.buttons.fixLayout(),t.drawNew(),t.ide.showMessage("unshared.",2)},t.ide.cloudError(),[o.ProjectName]),o.ProjectName===e.projectName&&(location.hash="")},t.ide.cloudError())})},ProjectDialogMorph.prototype.edit=function(){this.nameField?this.nameField.edit():this.filterField&&this.filterField.edit()},ProjectDialogMorph.prototype.fixLayout=function(){var t=fontHeight(this.titleFontSize)+2*this.titlePadding,e=this.padding/2,o=this.nameField||this.filterField,i=Morph.prototype.trackChanges;Morph.prototype.trackChanges=!1,this.buttons&&0<this.buttons.children.length&&this.buttons.fixLayout(),this.body&&(this.body.setPosition(this.position().add(new Point(this.padding,t+this.padding))),this.body.setExtent(new Point(this.width()-2*this.padding,this.height()-3*this.padding-t-this.buttons.height())),this.srcBar.setPosition(this.body.position()),o.setWidth(this.body.width()-this.srcBar.width()-6*this.padding),o.setLeft(this.srcBar.right()+3*this.padding),o.setTop(this.srcBar.top()),o.drawNew(),this.listField.setLeft(this.srcBar.right()+this.padding),this.listField.setWidth(this.body.width()-this.srcBar.width()-this.preview.width()-this.padding-e),this.listField.contents.children[0].adjustWidths(),this.listField.setTop(o.bottom()+this.padding),this.listField.setHeight(this.body.height()-o.height()-this.padding),this.magnifiyingGlass&&(this.magnifiyingGlass.setTop(o.top()),this.magnifiyingGlass.setLeft(this.listField.left())),this.preview.setRight(this.body.right()),this.preview.setTop(o.bottom()+this.padding),this.notesField.setTop(this.preview.bottom()+e),this.notesField.setLeft(this.preview.left()),this.notesField.setHeight(this.body.bottom()-this.preview.bottom()-e)),this.label&&(this.label.setCenter(this.center()),this.label.setTop(this.top()+(t-this.label.height())/2)),this.buttons&&0<this.buttons.children.length&&(this.buttons.setCenter(this.center()),this.buttons.setBottom(this.bottom()-this.padding)),Morph.prototype.trackChanges=i,this.changed()},LibraryImportDialogMorph.prototype=new DialogBoxMorph,LibraryImportDialogMorph.prototype.constructor=LibraryImportDialogMorph,LibraryImportDialogMorph.uber=DialogBoxMorph.prototype,LibraryImportDialogMorph.prototype.init=function(t,e){LibraryImportDialogMorph.uber.init.call(this,this,null,null),this.ide=t,this.key="importLibrary",this.librariesData=e,this.libraryCache={},this.handle=null,this.listField=null,this.palette=null,this.notesText=null,this.notesField=null,this.labelString="Import library",this.createLabel(),this.buildContents()},LibraryImportDialogMorph.prototype.buildContents=function(){this.addBody(new Morph),this.body.color=this.color,this.initializePalette(),this.initializeLibraryDescription(),this.installLibrariesList(),this.addButton("importLibrary","Import"),this.addButton("cancel","Cancel"),this.setExtent(new Point(460,455)),this.fixLayout()},LibraryImportDialogMorph.prototype.initializePalette=function(){this.palette&&this.palette.destroy(),this.palette=new ScrollFrameMorph(null,null,SpriteMorph.prototype.sliderColor),this.palette.color=SpriteMorph.prototype.paletteColor,this.palette.padding=4,this.palette.isDraggable=!1,this.palette.acceptsDrops=!1,this.palette.contents.acceptsDrops=!1,this.body.add(this.palette)},LibraryImportDialogMorph.prototype.initializeLibraryDescription=function(){this.notesField&&this.notesField.destroy(),this.notesField=new ScrollFrameMorph,this.notesField.fixLayout=nop,this.notesField.edge=InputFieldMorph.prototype.edge,this.notesField.fontSize=InputFieldMorph.prototype.fontSize,this.notesField.typeInPadding=InputFieldMorph.prototype.typeInPadding,this.notesField.contrast=InputFieldMorph.prototype.contrast,this.notesField.drawNew=InputFieldMorph.prototype.drawNew,this.notesField.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,this.notesField.acceptsDrops=!1,this.notesField.contents.acceptsDrops=!1,this.notesText=new TextMorph(""),this.notesField.isTextLineWrapping=!0,this.notesField.padding=3,this.notesField.setContents(this.notesText),this.notesField.setHeight(100),this.body.add(this.notesField)},LibraryImportDialogMorph.prototype.installLibrariesList=function(){var o=this;this.listField&&this.listField.destroy(),this.listField=new ListMorph(this.librariesData,function(t){return t.name},null,function(){o.importLibrary()}),this.fixListFieldItemColors(),this.listField.fixLayout=nop,this.listField.edge=InputFieldMorph.prototype.edge,this.listField.fontSize=InputFieldMorph.prototype.fontSize,this.listField.typeInPadding=InputFieldMorph.prototype.typeInPadding,this.listField.contrast=InputFieldMorph.prototype.contrast,this.listField.drawNew=InputFieldMorph.prototype.drawNew,this.listField.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,this.listField.action=function(e){isNil(e)||(o.notesText.text=e.description||"",o.notesText.drawNew(),o.notesField.contents.adjustBounds(),o.hasCached(e.fileName)?o.displayBlocks(e.fileName):(o.showMessage(localize("Loading")+"\n"+localize(e.name)),o.ide.getURL(o.ide.resourceURL("libraries",e.fileName),function(t){o.cacheLibrary(e.fileName,o.ide.serializer.loadBlocks(t)),o.displayBlocks(e.fileName)})))},this.listField.setWidth(200),this.body.add(this.listField),this.fixLayout()},LibraryImportDialogMorph.prototype.popUp=function(){var t=this.ide.world();t&&(LibraryImportDialogMorph.uber.popUp.call(this,t),this.handle=new HandleMorph(this,300,300,this.corner,this.corner))},LibraryImportDialogMorph.prototype.fixListFieldItemColors=ProjectDialogMorph.prototype.fixListFieldItemColors,LibraryImportDialogMorph.prototype.clearDetails=ProjectDialogMorph.prototype.clearDetails,LibraryImportDialogMorph.prototype.fixLayout=function(){var t=fontHeight(this.titleFontSize)+2*this.titlePadding,e=this.padding/2,o=Morph.prototype.trackChanges;Morph.prototype.trackChanges=!1,this.body&&(this.body.setPosition(this.position().add(new Point(this.padding,t+this.padding))),this.body.setExtent(new Point(this.width()-2*this.padding,this.height()-3*this.padding-t-this.buttons.height())),this.listField.setExtent(new Point(200,this.body.height())),this.notesField.setExtent(new Point(this.body.width()-this.listField.width()-e,100)),this.palette.setExtent(new Point(this.notesField.width(),this.body.height()-this.notesField.height()-e)),this.listField.contents.children[0].adjustWidths(),this.listField.setPosition(this.body.position()),this.palette.setPosition(this.listField.topRight().add(new Point(e,0))),this.notesField.setPosition(this.palette.bottomLeft().add(new Point(0,e)))),this.label&&(this.label.setCenter(this.center()),this.label.setTop(this.top()+(t-this.label.height())/2)),this.buttons&&(this.buttons.fixLayout(),this.buttons.setCenter(this.center()),this.buttons.setBottom(this.bottom()-this.padding)),Morph.prototype.trackChanges=o,this.changed()},LibraryImportDialogMorph.prototype.hasCached=function(t){return this.libraryCache.hasOwnProperty(t)},LibraryImportDialogMorph.prototype.cacheLibrary=function(t,e){this.libraryCache[t]=e},LibraryImportDialogMorph.prototype.cachedLibrary=function(t){return this.libraryCache[t]},LibraryImportDialogMorph.prototype.importLibrary=function(){var e=this.ide,t=this.listField.selected.fileName,o=this.listField.selected.name;e.showMessage(localize("Loading")+" "+localize(o)),e.getURL(e.resourceURL("libraries",t),function(t){e.droppedText(t,o)}),this.destroy()},LibraryImportDialogMorph.prototype.displayBlocks=function(t){var o,i,r,n,s,a=this,h=this.cachedLibrary(t);h.length&&(this.initializePalette(),o=this.palette.left()+4,i=this.palette.top(),SpriteMorph.prototype.categories.forEach(function(e){h.forEach(function(t){t.category===e&&(e!==n&&(i+=4),n=e,r=t.templateInstance().fullImage(),(s=new Morph).setExtent(new Point(r.width,r.height)),s.image=r,s.setPosition(new Point(o,i)),a.palette.addContents(s),i+=s.fullBounds().height()+4)})}),this.palette.scrollX(4),this.palette.scrollY(4),this.fixLayout())},LibraryImportDialogMorph.prototype.showMessage=function(t){var e=new MenuMorph(null,t);this.initializePalette(),this.fixLayout(),e.popUpCenteredInWorld(this.palette.contents)},SpriteIconMorph.prototype=new ToggleButtonMorph,SpriteIconMorph.prototype.constructor=SpriteIconMorph,SpriteIconMorph.uber=ToggleButtonMorph.prototype,SpriteIconMorph.prototype.thumbSize=new Point(40,40),SpriteIconMorph.prototype.labelShadowOffset=null,SpriteIconMorph.prototype.labelShadowColor=null,SpriteIconMorph.prototype.labelColor=new Color(255,255,255),SpriteIconMorph.prototype.fontSize=9,SpriteIconMorph.prototype.init=function(t,e){var o,i,r,n,s=this;e||(o=[IDE_Morph.prototype.groupColor,IDE_Morph.prototype.frameColor,IDE_Morph.prototype.frameColor]),i=function(){var t=s.parentThatIsA(IDE_Morph);t&&(SnapActions.selectSprite(s.object),t.selectSprite(s.object))},r=function(){var t=s.parentThatIsA(IDE_Morph);return!!t&&t.currentSprite===s.object},n=function(){return t.exemplar?localize("parent:\n"+t.exemplar.name):null},this.object=t||new SpriteMorph,this.version=this.object.version,this.thumbnail=null,this.rotationButton=null,SpriteIconMorph.uber.init.call(this,o,null,i,this.object.name,r,null,n,e),this.isDraggable=!0,this.createThumbnail(),this.padding=2,this.corner=8,this.fixLayout(),this.fps=1},SpriteIconMorph.prototype.createThumbnail=function(){this.thumbnail&&this.thumbnail.destroy(),this.thumbnail=new Morph,this.thumbnail.setExtent(this.thumbSize),this.object instanceof SpriteMorph?(this.thumbnail.image=this.object.fullThumbnail(this.thumbSize),this.createRotationButton()):this.thumbnail.image=this.object.thumbnail(this.thumbSize),this.add(this.thumbnail)},SpriteIconMorph.prototype.createLabel=function(){var t;this.label&&this.label.destroy(),t=new StringMorph(this.object.name,this.fontSize,this.fontStyle,!0,!1,!1,this.labelShadowOffset,this.labelShadowColor,this.labelColor),this.label=new FrameMorph,this.label.acceptsDrops=!1,this.label.alpha=0,this.label.setExtent(t.extent()),t.setPosition(this.label.position()),this.label.add(t),this.add(this.label)},SpriteIconMorph.prototype.createRotationButton=function(){var t,e=this;this.rotationButton&&(this.rotationButton.destroy(),this.roationButton=null),this.object.anchor&&((t=new ToggleButtonMorph(null,null,function(){e.object.rotatesWithAnchor=!e.object.rotatesWithAnchor},["→","↻"],function(){return e.object.rotatesWithAnchor})).corner=8,t.labelMinExtent=new Point(11,11),t.padding=0,t.pressColor=t.color,t.drawNew(),t.fixLayout(),t.refresh(),t.changed(),this.rotationButton=t,this.add(this.rotationButton))},SpriteIconMorph.prototype.step=function(){this.version!==this.object.version&&(this.createThumbnail(),this.createLabel(),this.fixLayout(),this.version=this.object.version,this.refresh())},SpriteIconMorph.prototype.fixLayout=function(){if(!this.thumbnail||!this.label)return null;this.setWidth(this.thumbnail.width()+2*this.outline+2*this.edge+2*this.padding),this.setHeight(this.thumbnail.height()+2*this.outline+2*this.edge+3*this.padding+this.label.height()),this.thumbnail.setCenter(this.center()),this.thumbnail.setTop(this.top()+this.outline+this.edge+this.padding),this.rotationButton&&(this.rotationButton.setTop(this.top()),this.rotationButton.setRight(this.right())),this.label.setWidth(Math.min(this.label.children[0].width(),this.thumbnail.width())),this.label.setCenter(this.center()),this.label.setTop(this.thumbnail.bottom()+this.padding)},SpriteIconMorph.prototype.userMenu=function(){var t=new MenuMorph(this),e=this;return this.object instanceof StageMorph?(t.addItem("pic...",function(){e.parentThatIsA(IDE_Morph).saveCanvasAs(e.object.fullImageClassic(),this.object.name)},"download a picture of the stage"),t):this.object instanceof SpriteMorph?(t.addItem("show","showSpriteOnStage"),t.addLine(),t.addItem("duplicate",function(){var t=e.world().hand.position();SnapActions.duplicateSprite(e.object,t)}),t.addItem("delete",function(){SnapActions.removeSprite(this.object)}),t.addLine(),StageMorph.prototype.enableInheritance&&t.addItem("parent...","chooseExemplar"),this.object.anchor&&t.addItem(localize("detach from")+" "+this.object.anchor.name,function(){SnapActions.detachParts([this.object])}),this.object.parts.length&&t.addItem("detach all parts",function(){SnapActions.detachParts(this.object.parts)}),t.addItem("export...","exportSprite"),t):null},SpriteIconMorph.prototype.exportSprite=function(){this.object.exportSprite()},SpriteIconMorph.prototype.chooseExemplar=function(){this.object.chooseExemplar()},SpriteIconMorph.prototype.showSpriteOnStage=function(){this.object.showOnStage()},SpriteIconMorph.prototype.createBackgrounds=function(){var t,e=this.extent();if(this.template)return this.image=this.template.image,this.normalImage=this.template.normalImage,this.highlightImage=this.template.highlightImage,this.pressImage=this.template.pressImage,null;this.normalImage=newCanvas(e),t=this.normalImage.getContext("2d"),this.drawBackground(t,this.color),this.highlightImage=newCanvas(e),t=this.highlightImage.getContext("2d"),this.drawBackground(t,this.highlightColor),this.pressImage=newCanvas(e),t=this.pressImage.getContext("2d"),this.drawOutline(t),this.drawBackground(t,this.pressColor),this.drawEdges(t,this.pressColor,this.pressColor.lighter(this.contrast),this.pressColor.darker(this.contrast)),this.image=this.normalImage},SpriteIconMorph.prototype.prepareToBeGrabbed=function(){var t,e=this.parentThatIsA(IDE_Morph);this.mouseClickLeft(),this.alpha=.85,e&&(t=e.sprites.asArray().indexOf(this.object),e.sprites.remove(t+1),e.createCorral(),e.fixLayout())},SpriteIconMorph.prototype.justDropped=function(){this.alpha=1},SpriteIconMorph.prototype.wantsDropOf=function(t){return t instanceof BlockMorph||t instanceof CostumeIconMorph||t instanceof SoundIconMorph},SpriteIconMorph.prototype.reactToDropOf=function(t,e){t instanceof BlockMorph?this.copyStack(t):t instanceof CostumeIconMorph?this.copyCostume(t.object):t instanceof SoundIconMorph&&this.copySound(t.object),this.world().add(t),t.slideBackTo(e.grabOrigin)},SpriteIconMorph.prototype.copyStack=function(t){var e=t.fullCopy(),o=Math.max(this.object.scripts.children.map(function(t){return t.fullBounds().bottom()}).concat([this.object.scripts.top()])),i=new Point(this.object.scripts.left()+20,o+20);e.setPosition(i),e.allComments().forEach(function(t){t.align(e)}),e.allChildren().forEach(function(t){t.definition&&!t.definition.isGlobal&&t.deleteBlock()}),e.id=null,SnapActions.addBlock(e,this.object.scripts,i)},SpriteIconMorph.prototype.copyCostume=function(t){var e=t.copy();e.name=this.object.newCostumeName(e.name),SnapActions.addCostume(e,this.object)},SpriteIconMorph.prototype.copySound=function(t){SnapActions.addSound(t,this.object)},CostumeIconMorph.prototype=new ToggleButtonMorph,CostumeIconMorph.prototype.constructor=CostumeIconMorph,CostumeIconMorph.uber=ToggleButtonMorph.prototype,CostumeIconMorph.prototype.thumbSize=new Point(80,60),CostumeIconMorph.prototype.labelShadowOffset=null,CostumeIconMorph.prototype.labelShadowColor=null,CostumeIconMorph.prototype.labelColor=new Color(255,255,255),CostumeIconMorph.prototype.fontSize=9,CostumeIconMorph.prototype.init=function(t,e){var o,i,r,n=this;e||(o=[IDE_Morph.prototype.groupColor,IDE_Morph.prototype.frameColor,IDE_Morph.prototype.frameColor]),i=function(){var t=n.parentThatIsA(IDE_Morph),e=n.parentThatIsA(WardrobeMorph);t&&t.currentSprite.wearCostume(n.object),e&&e.updateSelection()},r=function(){var t=n.parentThatIsA(IDE_Morph);return!!t&&t.currentSprite.costume===n.object},this.object=t||new Costume,this.version=this.object.version,this.thumbnail=null,CostumeIconMorph.uber.init.call(this,o,null,i,this.object.name,r,null,null,e),this.isDraggable=!0,this.createThumbnail(),this.padding=2,this.corner=8,this.fixLayout(),this.fps=1},CostumeIconMorph.prototype.createThumbnail=SpriteIconMorph.prototype.createThumbnail,CostumeIconMorph.prototype.createLabel=SpriteIconMorph.prototype.createLabel,CostumeIconMorph.prototype.step=SpriteIconMorph.prototype.step,CostumeIconMorph.prototype.fixLayout=SpriteIconMorph.prototype.fixLayout,CostumeIconMorph.prototype.userMenu=function(){var t=new MenuMorph(this);return this.object instanceof Costume?(t.addItem("edit","editCostume"),16===this.world().currentKey&&t.addItem("edit rotation point only...","editRotationPointOnly",null,new Color(100,0,0)),t.addItem("rename","renameCostume"),t.addLine(),t.addItem("duplicate","duplicateCostume"),t.addItem("delete","removeCostume"),t.addLine(),t.addItem("export","exportCostume"),t):null},CostumeIconMorph.prototype.editCostume=function(){var t=this,e=this.object.copy(),o=function(){SnapActions.updateCostume(e,t.object)};this.object instanceof SVG_Costume?this.object.editRotationPointOnly(this.world(),o):this.object.edit(this.world(),this.parentThatIsA(IDE_Morph),!1,null,o)},CostumeIconMorph.prototype.editRotationPointOnly=function(){var t=this.parentThatIsA(IDE_Morph);this.object.editRotationPointOnly(this.world()),t.hasChangedMedia=!0},CostumeIconMorph.prototype.renameCostume=function(){var o=this.object,i=this.parentThatIsA(WardrobeMorph);this.parentThatIsA(IDE_Morph);new DialogBoxMorph(null,function(t){if(t&&t!==o.name){var e=i.sprite.newCostumeName(t,o);SnapActions.renameCostume(o,e)}}).prompt(this.currentSprite instanceof SpriteMorph?"rename costume":"rename background",o.name,this.world())},CostumeIconMorph.prototype.duplicateCostume=function(){var t=this.parentThatIsA(WardrobeMorph),e=(this.parentThatIsA(IDE_Morph),this.object.copy());e.name=t.sprite.newCostumeName(e.name),SnapActions.addCostume(e,t.sprite)},CostumeIconMorph.prototype.removeCostume=function(){SnapActions.removeCostume(this.object)},CostumeIconMorph.prototype.exportCostume=function(){var t=this.parentThatIsA(IDE_Morph);this.object instanceof SVG_Costume?t.saveFileAs(this.object.contents.src,"text/svg",this.object.name):t.saveCanvasAs(this.object.contents,this.object.name)},CostumeIconMorph.prototype.createBackgrounds=SpriteIconMorph.prototype.createBackgrounds,CostumeIconMorph.prototype.prepareToBeGrabbed=function(){this.mouseClickLeft(),this.localRemoveCostume()},CostumeIconMorph.prototype.localRemoveCostume=function(){var t=this.parentThatIsA(WardrobeMorph),e=this.parent.children.indexOf(this),o=this.parentThatIsA(IDE_Morph);t.removeCostumeAt(e-2),o.currentSprite.costume===this.object&&o.currentSprite.wearCostume(null)},TurtleIconMorph.prototype=new ToggleButtonMorph,TurtleIconMorph.prototype.constructor=TurtleIconMorph,TurtleIconMorph.uber=ToggleButtonMorph.prototype,TurtleIconMorph.prototype.thumbSize=new Point(80,60),TurtleIconMorph.prototype.labelShadowOffset=null,TurtleIconMorph.prototype.labelShadowColor=null,TurtleIconMorph.prototype.labelColor=new Color(255,255,255),TurtleIconMorph.prototype.fontSize=9,TurtleIconMorph.prototype.init=function(t,e){var o,i,r,n=this;e||(o=[IDE_Morph.prototype.groupColor,IDE_Morph.prototype.frameColor,IDE_Morph.prototype.frameColor]),i=function(){var t=n.parentThatIsA(IDE_Morph),e=n.parentThatIsA(WardrobeMorph);t&&t.currentSprite.wearCostume(null),e&&e.updateSelection()},r=function(){var t=n.parentThatIsA(IDE_Morph);return!!t&&null===t.currentSprite.costume},this.object=t,this.version=this.object.version,this.thumbnail=null,TurtleIconMorph.uber.init.call(this,o,null,i,"default",r,null,null,e),this.isDraggable=!1,this.createThumbnail(),this.padding=2,this.corner=8,this.fixLayout()},TurtleIconMorph.prototype.createThumbnail=function(){var t=MorphicPreferences.isFlat;this.thumbnail&&this.thumbnail.destroy(),this.object instanceof SpriteMorph?this.thumbnail=new SymbolMorph("turtle",this.thumbSize.y,this.labelColor,t?null:new Point(-1,-1),new Color(0,0,0)):this.thumbnail=new SymbolMorph("stage",this.thumbSize.y,this.labelColor,t?null:new Point(-1,-1),new Color(0,0,0)),this.add(this.thumbnail)},TurtleIconMorph.prototype.createLabel=function(){var t;this.label&&this.label.destroy(),t=new StringMorph(localize(this.object instanceof SpriteMorph?"Turtle":"Empty"),this.fontSize,this.fontStyle,!0,!1,!1,this.labelShadowOffset,this.labelShadowColor,this.labelColor),this.label=new FrameMorph,this.label.acceptsDrops=!1,this.label.alpha=0,this.label.setExtent(t.extent()),t.setPosition(this.label.position()),this.label.add(t),this.add(this.label)},TurtleIconMorph.prototype.fixLayout=SpriteIconMorph.prototype.fixLayout,TurtleIconMorph.prototype.createBackgrounds=SpriteIconMorph.prototype.createBackgrounds,TurtleIconMorph.prototype.userMenu=function(){var t=this,e=new MenuMorph(this,"pen");return this.object instanceof StageMorph?null:(e.addItem(("tip"===this.object.penPoint?"●":"○")+" "+localize("tip"),function(){t.object.penPoint="tip",t.object.changed(),t.object.drawNew(),t.object.changed()}),e.addItem(("middle"===this.object.penPoint?"●":"○")+" "+localize("middle"),function(){t.object.penPoint="middle",t.object.changed(),t.object.drawNew(),t.object.changed()}),e)},WardrobeMorph.prototype=new ScrollFrameMorph,WardrobeMorph.prototype.undoCategory="costumes",WardrobeMorph.prototype.constructor=WardrobeMorph,WardrobeMorph.uber=ScrollFrameMorph.prototype,WardrobeMorph.prototype.init=function(t,e){this.sprite=t||new SpriteMorph,this.costumesVersion=null,this.spriteVersion=null,WardrobeMorph.uber.init.call(this,null,null,e),this.fps=2,this.updateList()},WardrobeMorph.prototype.updateList=function(){var e,o,t,i,r=this,n=this.left()+5,s=this.top()+5,a=Morph.prototype.trackChanges,h=this.contents.position();this.changed(),a=Morph.prototype.trackChanges,Morph.prototype.trackChanges=!1,this.contents.destroy(),this.contents=new FrameMorph(this),this.contents.acceptsDrops=!1,this.contents.reactToDropOf=function(t){r.reactToDropOf(t)},this.addBack(this.contents),(e=new TurtleIconMorph(this.sprite)).setPosition(new Point(n,s)),r.addContents(e),s=e.bottom()+4,(i=new PushButtonMorph(this,"paintNew",new SymbolMorph("brush",15))).padding=0,i.corner=12,i.color=IDE_Morph.prototype.groupColor,i.highlightColor=IDE_Morph.prototype.frameColor.darker(50),i.pressColor=i.highlightColor,i.labelMinExtent=new Point(36,18),i.labelShadowOffset=new Point(-1,-1),i.labelShadowColor=i.highlightColor,i.labelColor=TurtleIconMorph.prototype.labelColor,i.contrast=this.buttonContrast,i.drawNew(),i.hint="Paint a new costume",i.setPosition(new Point(n,s)),i.fixLayout(),i.setCenter(e.center()),i.setLeft(e.right()+16),this.addContents(i),(t=new TextMorph(localize("costumes tab help"))).fontSize=9,t.setColor(SpriteMorph.prototype.paletteTextColor),t.setPosition(new Point(n,s)),this.addContents(t),s=t.bottom()+4,this.sprite.costumes.asArray().forEach(function(t){o=e=new CostumeIconMorph(t,o),e.setPosition(new Point(n,s)),r.addContents(e),s=e.bottom()+4}),this.costumesVersion=this.sprite.costumes.lastChanged,this.contents.setPosition(h),this.adjustScrollBars(),Morph.prototype.trackChanges=a,this.changed(),this.updateSelection(),this.onNextStep=this.updateUndoControls},WardrobeMorph.prototype.updateSelection=function(){this.contents.children.forEach(function(t){t.refresh&&t.refresh()}),this.spriteVersion=this.sprite.version},WardrobeMorph.prototype.step=function(){this.costumesVersion!==this.sprite.costumes.lastChanged&&this.updateList(),this.spriteVersion!==this.sprite.version&&this.updateSelection()},WardrobeMorph.prototype.removeCostumeAt=function(t){this.sprite.costumes.remove(t),this.updateList()},WardrobeMorph.prototype.paintNew=function(){var t=this.sprite.newCostumeName(localize("Untitled")),e=this.parentThatIsA(IDE_Morph),o=this,i=new Costume(newCanvas(null,!0),t);i.edit(this.world(),e,!0,null,function(){SnapActions.addCostume(i,o.sprite)})},WardrobeMorph.prototype.wantsDropOf=function(t){return t instanceof CostumeIconMorph},WardrobeMorph.prototype.reactToDropOf=function(t){var e=0,o=t.object,i=t.top();t.destroy(),this.contents.children.forEach(function(t){t instanceof CostumeIconMorph&&t.top()<i-4&&(e+=1)}),this.sprite.costumes.add(o,e+1),this.updateList(),t.mouseClickLeft()},WardrobeMorph.prototype.updateUndoControls=ScriptsMorph.prototype.updateUndoControls,WardrobeMorph.prototype.addUndoControls=ScriptsMorph.prototype.addUndoControls,WardrobeMorph.prototype.undoOwnerId=ScriptsMorph.prototype.undoOwnerId,WardrobeMorph.prototype.definitionOrSprite=function(){return this.sprite},SoundIconMorph.prototype=new ToggleButtonMorph,SoundIconMorph.prototype.constructor=SoundIconMorph,SoundIconMorph.uber=ToggleButtonMorph.prototype,SoundIconMorph.prototype.thumbSize=new Point(80,60),SoundIconMorph.prototype.labelShadowOffset=null,SoundIconMorph.prototype.labelShadowColor=null,SoundIconMorph.prototype.labelColor=new Color(255,255,255),SoundIconMorph.prototype.fontSize=9,SoundIconMorph.prototype.init=function(t,e){var o,i,r;e||(o=[IDE_Morph.prototype.groupColor,IDE_Morph.prototype.frameColor,IDE_Morph.prototype.frameColor]),i=function(){nop()},r=function(){return!1},this.object=t,this.version=this.object.version,this.thumbnail=null,SoundIconMorph.uber.init.call(this,o,null,i,this.object.name,r,null,null,e),this.isDraggable=!0,this.createThumbnail(),this.padding=2,this.corner=8,this.fixLayout(),this.fps=1},SoundIconMorph.prototype.createThumbnail=function(){var t;this.thumbnail&&this.thumbnail.destroy(),this.thumbnail=new Morph,this.thumbnail.setExtent(this.thumbSize),this.add(this.thumbnail),t=new StringMorph(this.createInfo(),"16","",!0,!1,!1,this.labelShadowOffset,this.labelShadowColor,new Color(200,200,200)),this.thumbnail.add(t),t.setCenter(new Point(40,15)),this.button=new PushButtonMorph(this,"toggleAudioPlaying",this.object.previewAudio?"Stop":"Play"),this.button.drawNew(),this.button.hint="Play sound",this.button.fixLayout(),this.thumbnail.add(this.button),this.button.setCenter(new Point(40,40))},SoundIconMorph.prototype.createInfo=function(){var t=Math.round(this.object.audio.duration||0),e=t%60;return Math.floor(t/60).toString()+":"+(e<10?"0":"")+e.toString()},SoundIconMorph.prototype.toggleAudioPlaying=function(){var t=this;this.object.previewAudio?(this.button.labelString="Play",this.button.hint="Play sound",this.object.previewAudio.pause(),this.object.previewAudio.terminated=!0,this.object.previewAudio=null):(this.button.labelString="Stop",this.button.hint="Stop sound",this.object.previewAudio=this.object.play(),this.object.previewAudio.addEventListener("ended",function(){t.audioHasEnded()},!1)),this.button.createLabel()},SoundIconMorph.prototype.audioHasEnded=function(){this.button.trigger(),this.button.mouseLeave()},SoundIconMorph.prototype.createLabel=SpriteIconMorph.prototype.createLabel,SoundIconMorph.prototype.fixLayout=SpriteIconMorph.prototype.fixLayout,SoundIconMorph.prototype.userMenu=function(){var t=new MenuMorph(this);return this.object instanceof Sound?(t.addItem("rename","renameSound"),t.addItem("delete","removeSound"),t):null},SoundIconMorph.prototype.renameSound=function(){var e=this.object;this.parentThatIsA(IDE_Morph);new DialogBoxMorph(null,function(t){t&&t!==e.name&&SnapActions.renameSound(e,t)}).prompt("rename sound",e.name,this.world())},SoundIconMorph.prototype.removeSound=function(){SnapActions.removeSound(this.object)},SoundIconMorph.prototype.localRemoveSound=function(){var t=this.parentThatIsA(JukeboxMorph),e=this.parent.children.indexOf(this);t.removeSound(e)},SoundIconMorph.prototype.createBackgrounds=SpriteIconMorph.prototype.createBackgrounds,SoundIconMorph.prototype.createLabel=SpriteIconMorph.prototype.createLabel,SoundIconMorph.prototype.prepareToBeGrabbed=function(){this.localRemoveSound()},JukeboxMorph.prototype=new ScrollFrameMorph,JukeboxMorph.prototype.undoCategory="sounds",JukeboxMorph.prototype.constructor=JukeboxMorph,JukeboxMorph.uber=ScrollFrameMorph.prototype,JukeboxMorph.prototype.init=function(t,e){this.sprite=t||new SpriteMorph,this.costumesVersion=null,this.spriteVersion=null,JukeboxMorph.uber.init.call(this,null,null,e),this.acceptsDrops=!1,this.fps=2,this.updateList()},JukeboxMorph.prototype.updateList=function(){var e,o,t,i=this,r=this.left()+5,n=this.top()+5,s=Morph.prototype.trackChanges;this.changed(),s=Morph.prototype.trackChanges,Morph.prototype.trackChanges=!1,this.contents.destroy(),this.contents=new FrameMorph(this),this.contents.acceptsDrops=!1,this.contents.reactToDropOf=function(t){i.reactToDropOf(t)},this.addBack(this.contents),(t=new TextMorph(localize("import a sound from your computer\nby dragging it into here"))).fontSize=9,t.setColor(SpriteMorph.prototype.paletteTextColor),t.setPosition(new Point(r,n)),this.addContents(t),n=t.bottom()+4,this.sprite.sounds.asArray().forEach(function(t){o=e=new SoundIconMorph(t,o),e.setPosition(new Point(r,n)),i.addContents(e),n=e.bottom()+4}),Morph.prototype.trackChanges=s,this.changed(),this.updateSelection(),this.onNextStep=this.updateUndoControls},JukeboxMorph.prototype.updateSelection=function(){this.contents.children.forEach(function(t){t.refresh&&t.refresh()}),this.spriteVersion=this.sprite.version},JukeboxMorph.prototype.removeSound=function(t){this.sprite.sounds.remove(t),this.updateList()},JukeboxMorph.prototype.wantsDropOf=function(t){return t instanceof SoundIconMorph},JukeboxMorph.prototype.reactToDropOf=function(t){var e=0,o=t.object,i=t.top();t.destroy(),this.contents.children.forEach(function(t){t.top()<i-4&&(e+=1)}),this.sprite.sounds.add(o,e),this.updateList()},JukeboxMorph.prototype.updateUndoControls=ScriptsMorph.prototype.updateUndoControls,JukeboxMorph.prototype.addUndoControls=ScriptsMorph.prototype.addUndoControls,JukeboxMorph.prototype.undoOwnerId=ScriptsMorph.prototype.undoOwnerId,JukeboxMorph.prototype.definitionOrSprite=function(){return this.sprite},StageHandleMorph.prototype=new Morph,StageHandleMorph.prototype.constructor=StageHandleMorph,StageHandleMorph.uber=Morph.prototype,StageHandleMorph.prototype.init=function(t){this.target=t||null,HandleMorph.uber.init.call(this),this.color=MorphicPreferences.isFlat?IDE_Morph.prototype.groupColor:new Color(190,190,190),this.isDraggable=!1,this.noticesTransparentClick=!0,this.setExtent(new Point(12,50))},StageHandleMorph.prototype.drawNew=function(){this.normalImage=newCanvas(this.extent()),this.highlightImage=newCanvas(this.extent()),this.drawOnCanvas(this.normalImage,this.color),this.drawOnCanvas(this.highlightImage,MorphicPreferences.isFlat?new Color(245,245,255):new Color(100,100,255),this.color),this.image=this.normalImage,this.fixLayout()},StageHandleMorph.prototype.drawOnCanvas=function(t,e,o){var i,r,n,s=t.getContext("2d"),a=t.height/8,h=t.width/6,l=h/2;for(s.lineWidth=h,s.lineCap="round",r=t.height/2,s.strokeStyle=e.toString(),i=t.width/12,n=0;n<3;n+=1)0<n&&(s.beginPath(),s.moveTo(i,r-(a-l)),s.lineTo(i,r+(a-l)),s.stroke()),i+=2*h,a*=2;if(o)for(s.strokeStyle=o.toString(),i=t.width/12+h,a=t.height/8,n=0;n<3;n+=1)0<n&&(s.beginPath(),s.moveTo(i,r-(a-l)),s.lineTo(i,r+(a-l)),s.stroke()),i+=2*h,a*=2},StageHandleMorph.prototype.fixLayout=function(){if(this.target){var t=this.target.parentThatIsA(IDE_Morph);this.setTop(this.target.top()+10),this.setRight(this.target.left()),t&&t.add(this)}},StageHandleMorph.prototype.step=null,StageHandleMorph.prototype.mouseDownLeft=function(t){var o=this.world(),i=this.right()-t.x,r=this,n=this.target.parentThatIsA(IDE_Morph);if(!this.target)return null;n.isSmallStage=!0,n.controlBar.stageSizeButton.refresh(),this.step=function(){var t,e;o.hand.mouseButton?(t=o.hand.bounds.origin.x+i,e=r.target.right()-t,n.stageRatio=e/r.target.dimensions.x,n.setExtent(o.extent())):(this.step=null,n.isSmallStage=1!==n.stageRatio,n.controlBar.stageSizeButton.refresh())}},StageHandleMorph.prototype.mouseEnter=function(){this.image=this.highlightImage,this.changed()},StageHandleMorph.prototype.mouseLeave=function(){this.image=this.normalImage,this.changed()},StageHandleMorph.prototype.mouseDoubleClick=function(){this.target.parentThatIsA(IDE_Morph).toggleStageSize(!0,1)},PaletteHandleMorph.prototype=new Morph,PaletteHandleMorph.prototype.constructor=PaletteHandleMorph,PaletteHandleMorph.uber=Morph.prototype,PaletteHandleMorph.prototype.init=function(t){this.target=t||null,HandleMorph.uber.init.call(this),this.color=MorphicPreferences.isFlat?new Color(255,255,255):new Color(190,190,190),this.isDraggable=!1,this.noticesTransparentClick=!0,this.setExtent(new Point(12,50))},PaletteHandleMorph.prototype.drawNew=StageHandleMorph.prototype.drawNew,PaletteHandleMorph.prototype.drawOnCanvas=StageHandleMorph.prototype.drawOnCanvas,PaletteHandleMorph.prototype.fixLayout=function(){if(this.target){var t=this.target.parentThatIsA(IDE_Morph);this.setTop(this.target.top()+10),this.setRight(this.target.right()),t&&t.add(this)}},PaletteHandleMorph.prototype.step=null,PaletteHandleMorph.prototype.mouseDownLeft=function(t){var e=this.world(),o=this.right()-t.x,i=this.target.parentThatIsA(IDE_Morph);if(!this.target)return null;this.step=function(){var t;e.hand.mouseButton?(t=e.hand.bounds.origin.x+o,i.paletteWidth=Math.min(Math.max(200,t),i.stageHandle.left()-i.spriteBar.tabBar.width()),i.setExtent(e.extent())):this.step=null}},PaletteHandleMorph.prototype.mouseEnter=StageHandleMorph.prototype.mouseEnter,PaletteHandleMorph.prototype.mouseLeave=StageHandleMorph.prototype.mouseLeave,PaletteHandleMorph.prototype.mouseDoubleClick=function(){this.target.parentThatIsA(IDE_Morph).setPaletteWidth(200)},modules.paint="2017-April-10",PaintEditorMorph.prototype=new DialogBoxMorph,PaintEditorMorph.prototype.constructor=PaintEditorMorph,PaintEditorMorph.uber=DialogBoxMorph.prototype,PaintEditorMorph.prototype.padding=10,PaintEditorMorph.prototype.init=function(){this.paper=null,this.oncancel=null,PaintEditorMorph.uber.init.call(this),this.labelString="Paint Editor",this.createLabel(),this.buildContents()},PaintEditorMorph.prototype.buildContents=function(){var t=this;this.paper=new PaintCanvasMorph(function(){return t.shift}),this.paper.setExtent(StageMorph.prototype.dimensions),this.addBody(new AlignmentMorph("row",this.padding)),this.controls=new AlignmentMorph("column",this.padding/2),this.controls.alignment="left",this.edits=new AlignmentMorph("row",this.padding/2),this.buildEdits(),this.controls.add(this.edits),this.body.color=this.color,this.body.add(this.controls),this.body.add(this.paper),this.toolbox=new BoxMorph,this.toolbox.color=SpriteMorph.prototype.paletteColor.lighter(8),this.toolbox.borderColor=this.toolbox.color.lighter(40),MorphicPreferences.isFlat&&(this.toolbox.edge=0),this.buildToolbox(),this.controls.add(this.toolbox),this.scaleBox=new AlignmentMorph("row",this.padding/2),this.buildScaleBox(),this.controls.add(this.scaleBox),this.propertiesControls={colorpicker:null,penSizeSlider:null,penSizeField:null,primaryColorButton:null,primaryColorViewer:null,constrain:null},this.populatePropertiesMenu(),this.addButton("ok","OK"),this.addButton("cancel","Cancel"),this.refreshToolButtons(),this.fixLayout(),this.drawNew()},PaintEditorMorph.prototype.buildToolbox=function(){var o={brush:"Paintbrush tool\n(free draw)",rectangle:"Stroked Rectangle\n(shift: square)",circle:"Stroked Ellipse\n(shift: circle)",eraser:"Eraser tool",crosshairs:"Set the rotation center",line:"Line tool\n(shift: vertical/horizontal)",rectangleSolid:"Filled Rectangle\n(shift: square)",circleSolid:"Filled Ellipse\n(shift: circle)",paintbucket:"Fill a region",pipette:"Pipette tool\n(pick a color anywhere)"},i=this,r=this.toolbox.left(),n=this.toolbox.top(),s=0,a=0;Object.keys(o).forEach(function(t){var e=i.toolButton(t,o[t]);e.setPosition(new Point(r+s,n+a)),s+=e.width()+2,"crosshairs"===t&&(s=0,a+=e.height()+2,i.paper.drawcrosshair()),i.toolbox[t]=e,i.toolbox.add(e)}),this.toolbox.bounds=this.toolbox.fullBounds().expandBy(10),this.toolbox.drawNew()},PaintEditorMorph.prototype.buildEdits=function(){var t=this.paper;this.edits.add(this.pushButton("undo",function(){t.undo()})),this.edits.add(this.pushButton("clear",function(){t.clearCanvas()})),this.edits.fixLayout()},PaintEditorMorph.prototype.buildScaleBox=function(){var t=this.paper;this.scaleBox.add(this.pushButton("grow",function(){t.scale(.05,.05)})),this.scaleBox.add(this.pushButton("shrink",function(){t.scale(-.05,-.05)})),this.scaleBox.add(this.pushButton("flip ↔",function(){t.scale(-2,0)})),this.scaleBox.add(this.pushButton("flip ↕",function(){t.scale(0,-2)})),this.scaleBox.fixLayout()},PaintEditorMorph.prototype.openIn=function(t,e,o,i){this.oldim=e,this.callback=i||nop,this.processKeyUp=function(){this.shift=!1,this.propertiesControls.constrain.refresh()},this.processKeyDown=function(){this.shift=16===this.world().currentKey,this.propertiesControls.constrain.refresh()},this.oldim&&(this.paper.automaticCrosshairs=isNil(o),this.paper.centermerge(this.oldim,this.paper.paper),this.paper.rotationCenter=(o||new Point(0,0)).add(new Point((this.paper.paper.width-this.oldim.width)/2,(this.paper.paper.height-this.oldim.height)/2)),this.paper.drawNew()),this.key="paint",this.popUp(t)},PaintEditorMorph.prototype.fixLayout=function(){var t=Morph.prototype.trackChanges;this.changed(),t=Morph.prototype.trackChanges,Morph.prototype.trackChanges=!1,this.paper&&(this.paper.buildContents(),this.paper.drawNew()),this.controls&&this.controls.fixLayout(),this.body&&this.body.fixLayout(),PaintEditorMorph.uber.fixLayout.call(this),Morph.prototype.trackChanges=t,this.changed()},PaintEditorMorph.prototype.refreshToolButtons=function(){this.toolbox.children.forEach(function(t){t.refresh()})},PaintEditorMorph.prototype.ok=function(){this.paper.updateAutomaticCenter(),this.callback(this.paper.paper,this.paper.rotationCenter),this.destroy()},PaintEditorMorph.prototype.cancel=function(){this.oncancel&&this.oncancel(),this.destroy()},PaintEditorMorph.prototype.populatePropertiesMenu=function(){var t=this.controls,n=this,s=this.propertiesControls,e=new AlignmentMorph("row",this.padding);s.primaryColorViewer=new Morph,s.primaryColorViewer.setExtent(new Point(180,50)),s.primaryColorViewer.color=new Color(0,0,0),s.colorpicker=new PaintColorPickerMorph(new Point(180,100),function(t){var e,o,i=newCanvas(s.primaryColorViewer.extent()),r=i.getContext("2d");if("transparent"===(n.paper.settings.primarycolor=t))for(e=0;e<180;e+=5)for(o=0;o<15;o+=5)r.fillStyle=(o+e)/5%2==0?"rgba(0, 0, 0, 0.2)":"rgba(0, 0, 0, 0.5)",r.fillRect(e,o,5,5);else r.fillStyle=t.toString(),r.fillRect(0,0,180,15);r.strokeStyle="black",r.lineWidth=Math.min(n.paper.settings.linewidth,20),r.beginPath(),r.lineCap="round",r.moveTo(20,30),r.lineTo(160,30),r.stroke(),s.primaryColorViewer.image=i,s.primaryColorViewer.changed()}),s.colorpicker.action(new Color(0,0,0)),s.penSizeSlider=new SliderMorph(0,20,5,5),s.penSizeSlider.orientation="horizontal",s.penSizeSlider.setHeight(15),s.penSizeSlider.setWidth(150),s.penSizeSlider.action=function(t){s.penSizeField&&s.penSizeField.setContents(t),n.paper.settings.linewidth=t,s.colorpicker.action(n.paper.settings.primarycolor)},s.penSizeField=new InputFieldMorph("5",!0,null,!1),s.penSizeField.contents().minWidth=20,s.penSizeField.setWidth(25),s.penSizeField.accept=function(){var t=parseFloat(s.penSizeField.getValue());s.penSizeSlider.value=t,s.penSizeSlider.drawNew(),s.penSizeSlider.updateValue(),this.setContents(t),n.paper.settings.linewidth=t,this.world().keyboardReceiver=n,s.colorpicker.action(n.paper.settings.primarycolor)},e.add(s.penSizeSlider),e.add(s.penSizeField),e.color=n.color,e.fixLayout(),s.penSizeField.drawNew(),s.constrain=new ToggleMorph("checkbox",this,function(){n.shift=!n.shift},"Constrain proportions of shapes?\n(you can also hold shift)",function(){return n.shift}),t.add(s.colorpicker),t.add(s.primaryColorViewer),t.add(new TextMorph(localize("Brush size"))),t.add(e),t.add(s.constrain)},PaintEditorMorph.prototype.toolButton=function(t,e){var o,i=this;return(o=new ToggleButtonMorph(null,this,function(){i.paper.currentTool=t,i.paper.toolChanged(t),i.refreshToolButtons(),"pipette"===t&&i.getUserColor()},new SymbolMorph(t,18),function(){return i.paper.currentTool===t})).hint=e,o.drawNew(),o.fixLayout(),o},PaintEditorMorph.prototype.pushButton=function(t,e,o){return new PushButtonMorph(this,e,t,null,o)},PaintEditorMorph.prototype.getUserColor=function(){var o=this,i=this.world(),r=i.hand,n=getDocumentPositionOf(i.worldCanvas),t=r.processMouseMove,e=r.processMouseDown,s=r.processMouseUp;r.processMouseMove=function(t){var e;r.setPosition(new Point(t.pageX-n.x,t.pageY-n.y)),(e=i.getGlobalPixelColor(r.position())).a&&(e.a=255,o.propertiesControls.colorpicker.action(e))},r.processMouseDown=nop,r.processMouseUp=function(){o.paper.currentTool="brush",o.paper.toolChanged("brush"),o.refreshToolButtons(),r.processMouseMove=t,r.processMouseDown=e,r.processMouseUp=s}},PaintColorPickerMorph.prototype=new Morph,PaintColorPickerMorph.prototype.constructor=PaintColorPickerMorph,PaintColorPickerMorph.uber=Morph.prototype,PaintColorPickerMorph.prototype.init=function(t,e){this.setExtent(t||new Point(200,100)),this.action=e||nop,this.drawNew()},PaintColorPickerMorph.prototype.drawNew=function(){var t,e,o=0,i=0,r=newCanvas(this.extent()),n=r.getContext("2d");for(o=0;o<this.width();o+=1)for(i=0;i<this.height()-20;i+=1)n.fillStyle="hsl("+360*o/this.width()+",100%,"+100*i/(this.height()-20)+"%)",n.fillRect(o,i,1,1);for(o=0;o<this.width();o+=1)e=Math.floor(255*o/this.width()),n.fillStyle="rgb("+e+", "+e+", "+e+")",n.fillRect(o,this.height()-20,1,10);for(t=["black","white","gray"],o=0;o<t.length;o+=1)n.fillStyle=t[o],n.fillRect(o*this.width()/t.length,this.height()-10,this.width()/t.length,10);for(o=2*this.width()/3;o<this.width();o+=2)for(i=this.height()-10;i<this.height();i+=2)(o+i)/2%2==0&&(n.fillStyle="#DDD",n.fillRect(o,i,2,2));this.image=r},PaintColorPickerMorph.prototype.mouseDownLeft=function(t){t.subtract(this.position()).x>2*this.width()/3&&t.subtract(this.position()).y>this.height()-10?this.action("transparent"):this.action(this.getPixelColor(t))},PaintColorPickerMorph.prototype.mouseMove=PaintColorPickerMorph.prototype.mouseDownLeft,PaintCanvasMorph.prototype=new Morph,PaintCanvasMorph.prototype.constructor=PaintCanvasMorph,PaintCanvasMorph.uber=Morph.prototype,PaintCanvasMorph.prototype.init=function(t){this.rotationCenter=new Point(240,180),this.dragRect=null,this.previousDragPoint=null,this.currentTool="brush",this.dragRect=new Rectangle,this.mask=newCanvas(this.extent(),!0),this.paper=newCanvas(this.extent(),!0),this.erasermask=newCanvas(this.extent(),!0),this.background=newCanvas(this.extent()),this.settings={primarycolor:new Color(0,0,0,255),secondarycolor:new Color(0,0,0,255),linewidth:3},this.brushBuffer=[],this.undoBuffer=[],this.isShiftPressed=t||function(){return 16===this.world().currentKey},this.automaticCrosshairs=!0,this.noticesTransparentClick=!0,this.buildContents()},PaintCanvasMorph.prototype.calculateCanvasCenter=function(t){var e=Costume.prototype.canvasBoundingBox(t);return null===e?null:new Point((e.origin.x+e.corner.x)/2,(e.origin.y+e.corner.y)/2)},PaintCanvasMorph.prototype.updateAutomaticCenter=function(){if(this.automaticCrosshairs){var t=this.calculateCanvasCenter(this.paper);null!==t&&(this.rotationCenter=t)}},PaintCanvasMorph.prototype.scale=function(t,e){this.updateAutomaticCenter(),this.mask=newCanvas(this.extent(),!0);var o=newCanvas(this.extent(),!0);o.getContext("2d").save(),o.getContext("2d").translate(this.rotationCenter.x,this.rotationCenter.y),o.getContext("2d").scale(1+t,1+e),o.getContext("2d").drawImage(this.paper,-this.rotationCenter.x,-this.rotationCenter.y),o.getContext("2d").restore(),this.paper=o,this.drawNew(),this.changed()},PaintCanvasMorph.prototype.cacheUndo=function(){var t=newCanvas(this.extent(),!0);this.merge(this.paper,t),this.undoBuffer.push(t)},PaintCanvasMorph.prototype.undo=function(){0<this.undoBuffer.length&&(this.paper=newCanvas(this.extent(),!0),this.mask.width=this.mask.width+1-1,this.merge(this.undoBuffer.pop(),this.paper),this.drawNew(),this.changed())},PaintCanvasMorph.prototype.merge=function(t,e){e.getContext("2d").drawImage(t,0,0)},PaintCanvasMorph.prototype.centermerge=function(t,e){e.getContext("2d").drawImage(t,(e.width-t.width)/2,(e.height-t.height)/2)},PaintCanvasMorph.prototype.clearCanvas=function(){this.buildContents(),this.drawNew(),this.changed()},PaintCanvasMorph.prototype.toolChanged=function(t){this.mask=newCanvas(this.extent(),!0),"crosshairs"===t&&(this.updateAutomaticCenter(),this.drawcrosshair()),this.drawNew(),this.changed()},PaintCanvasMorph.prototype.drawcrosshair=function(t){var e=t||this.mask.getContext("2d"),o=this.rotationCenter;e.lineWidth=1,e.strokeStyle="black",e.clearRect(0,0,this.mask.width,this.mask.height),e.globalAlpha=.5,e.fillStyle="white",e.beginPath(),e.arc(o.x,o.y,20,radians(0),radians(360),!1),e.closePath(),e.fill(),e.stroke(),e.beginPath(),e.arc(o.x,o.y,10,radians(0),radians(360),!1),e.stroke(),e.beginPath(),e.moveTo(0,o.y),e.lineTo(this.mask.width,o.y),e.stroke(),e.beginPath(),e.moveTo(o.x,0),e.lineTo(o.x,this.mask.height),e.stroke(),this.drawNew(),this.changed()},PaintCanvasMorph.prototype.floodfill=function(t){var e,o,i,r,n=this.paper.width,s=this.paper.height,a=this.paper.getContext("2d"),h=a.getImageData(0,0,n,s),l=h.data,p=[Math.round(t.y)*n+t.x];if(r=function(t){return t[0]===i[0]&&t[1]===i[1]&&t[2]===i[2]&&t[3]===i[3]},(0!==(i=(o=function(t){var e=4*t;return[l[e],l[e+1],l[e+2],l[e+3]]})(p[0]))[3]||"transparent"!==this.settings.primarycolor)&&!(i[0]===this.settings.primarycolor.r&&i[1]===this.settings.primarycolor.g&&i[2]===this.settings.primarycolor.b&&i[3]===this.settings.primarycolor.a||0===i[3]&&0===this.settings.primarycolor.a)){for(;0<p.length;)r(o(e=p.pop()))&&(1<e%n&&(p.push(e+1),p.push(e-1)),0<e&&e<s*n&&(p.push(e+n),p.push(e-n))),"transparent"===this.settings.primarycolor?l[4*e+3]=0:(l[4*e]=this.settings.primarycolor.r,l[4*e+1]=this.settings.primarycolor.g,l[4*e+2]=this.settings.primarycolor.b,l[4*e+3]=255*this.settings.primarycolor.a);a.putImageData(h,0,0),this.drawNew(),this.changed()}},PaintCanvasMorph.prototype.mouseDownLeft=function(t){return this.cacheUndo(),this.dragRect.origin=t.subtract(this.bounds.origin),this.dragRect.corner=t.subtract(this.bounds.origin),this.previousDragPoint=this.dragRect.corner.copy(),"crosshairs"===this.currentTool?(this.rotationCenter=t.subtract(this.bounds.origin),void this.drawcrosshair()):"paintbucket"===this.currentTool?this.floodfill(t.subtract(this.bounds.origin)):void("transparent"===this.settings.primarycolor&&"crosshairs"!==this.currentTool&&(this.erasermask=newCanvas(this.extent(),!0),this.merge(this.paper,this.erasermask)))},PaintCanvasMorph.prototype.mouseMove=function(t){if("paintbucket"!==this.currentTool){var e,o=t.subtract(this.bounds.origin),i=this.mask.getContext("2d"),r=this.paper.getContext("2d"),n=this.dragRect.origin.x,s=this.dragRect.origin.y,a=o.x,h=o.y,l=(a-n)/2,p=(h-s)/2,c=this.paper.width;switch(i.save(),this.brushBuffer.push([a,h]),i.lineWidth=this.settings.linewidth,i.clearRect(0,0,this.bounds.width(),this.bounds.height()),this.dragRect.corner=o.subtract(this.dragRect.origin),"transparent"===this.settings.primarycolor&&"crosshairs"!==this.currentTool?(this.merge(this.erasermask,this.mask),r.clearRect(0,0,this.bounds.width(),this.bounds.height()),i.globalCompositeOperation="destination-out"):(i.fillStyle=this.settings.primarycolor.toString(),i.strokeStyle=this.settings.primarycolor.toString()),this.currentTool){case"rectangle":this.isShiftPressed()?i.strokeRect(n,s,2*u(),2*d()):i.strokeRect(n,s,2*l,2*p);break;case"rectangleSolid":this.isShiftPressed()?i.fillRect(n,s,2*u(),2*d()):i.fillRect(n,s,2*l,2*p);break;case"brush":for(i.lineCap="round",i.lineJoin="round",i.beginPath(),i.moveTo(this.brushBuffer[0][0],this.brushBuffer[0][1]),e=0;e<this.brushBuffer.length;e+=1)i.lineTo(this.brushBuffer[e][0],this.brushBuffer[e][1]);i.stroke();break;case"line":i.beginPath(),i.moveTo(n,s),this.isShiftPressed()?Math.abs(p)>Math.abs(l)?i.lineTo(n,h):i.lineTo(a,s):i.lineTo(a,h),i.stroke();break;case"circle":case"circleSolid":if(i.beginPath(),this.isShiftPressed())i.arc(n,s,new Point(n,s).distanceTo(new Point(a,h)),0,2*Math.PI,!1);else{for(e=0;e<c;e+=1)i.lineTo(e,2*p*Math.sqrt(2-Math.pow((e-n)/(2*l),2))+s);for(e=c;0<e;e-=1)i.lineTo(e,2*p*-1*Math.sqrt(2-Math.pow((e-n)/(2*l),2))+s)}i.closePath(),"circleSolid"===this.currentTool?i.fill():"circle"===this.currentTool&&i.stroke();break;case"crosshairs":this.automaticCrosshairs=!1,this.rotationCenter=o.copy(),this.drawcrosshair(i);break;case"eraser":for(this.merge(this.paper,this.mask),i.save(),i.globalCompositeOperation="destination-out",i.beginPath(),i.moveTo(this.brushBuffer[0][0],this.brushBuffer[0][1]),e=0;e<this.brushBuffer.length;e+=1)i.lineTo(this.brushBuffer[e][0],this.brushBuffer[e][1]);i.stroke(),i.restore(),this.paper=newCanvas(this.extent(),!0),this.merge(this.mask,this.paper);break;default:nop()}this.previousDragPoint=o,this.drawNew(),this.changed(),i.restore()}function u(){return Math.max(Math.abs(l),Math.abs(p))*(l/Math.abs(l))}function d(){return Math.max(Math.abs(l),Math.abs(p))*(p/Math.abs(p))}},PaintCanvasMorph.prototype.mouseClickLeft=function(){"crosshairs"!==this.currentTool&&this.merge(this.mask,this.paper),this.brushBuffer=[]},PaintCanvasMorph.prototype.mouseLeaveDragging=PaintCanvasMorph.prototype.mouseClickLeft,PaintCanvasMorph.prototype.buildContents=function(){this.background=newCanvas(this.extent()),this.paper=newCanvas(this.extent(),!0),this.mask=newCanvas(this.extent(),!0),this.erasermask=newCanvas(this.extent(),!0);var t,e,o=this.background.getContext("2d");for(t=0;t<this.background.width;t+=5)for(e=0;e<this.background.height;e+=5)o.fillStyle=(t+e)/5%2==1?"rgba(255, 255, 255, 1)":"rgba(255, 255, 255, 0.3)",o.fillRect(t,e,5,5)},PaintCanvasMorph.prototype.drawNew=function(){var t=newCanvas(this.extent(),!0);this.merge(this.background,t),this.merge(this.paper,t),this.merge(this.mask,t),this.image=t,this.drawFrame()},PaintCanvasMorph.prototype.drawFrame=function(){var t,e;t=this.image.getContext("2d"),e=this.parent?(this.color=this.parent.color.lighter(.75*this.contrast),this.parent.color):new Color(120,120,120),t.fillStyle=this.color.toString(),this.cachedClr=e.toString(),this.cachedClrBright=e.lighter(this.contrast).toString(),this.cachedClrDark=e.darker(this.contrast).toString(),this.drawRectBorder(t)},PaintCanvasMorph.prototype.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,PaintCanvasMorph.prototype.edge=InputFieldMorph.prototype.edge,PaintCanvasMorph.prototype.fontSize=InputFieldMorph.prototype.fontSize,PaintCanvasMorph.prototype.typeInPadding=InputFieldMorph.prototype.typeInPadding,PaintCanvasMorph.prototype.contrast=InputFieldMorph.prototype.contrast,modules.lists="2016-July-14",List.prototype.enableTables=!1,List.prototype.toString=function(){return"a List ["+this.length+" elements]"},List.prototype.changed=function(){this.lastChanged=Date.now()},List.prototype.cons=function(t,e){var o=new List;if(!(e instanceof List||isNil(e)))throw new Error("cdr isn't a list: "+e);return o.first=isNil(t)?null:t,o.rest=e||null,o.isLinked=!0,o},List.prototype.cdr=function(){var t,e;if(this.isLinked)return this.rest||new List;if(this.contents.length<2)return new List;for(t=new List,e=this.contents.length;1<e;e-=1)t=this.cons(this.at(e),t);return t},List.prototype.add=function(t,e){var o=e||this.length()+1,i=isNil(t)?null:t;this.becomeArray(),this.contents.splice(o-1,0,i),this.changed()},List.prototype.put=function(t,e){var o=0===t?0:!1!==t&&(t||null);this.becomeArray(),this.contents[e-1]=o,this.changed()},List.prototype.remove=function(t){this.becomeArray(),this.contents.splice(t-1,1),this.changed()},List.prototype.clear=function(){this.contents=[],this.first=null,this.rest=null,this.isLinked=!1,this.changed()},List.prototype.length=function(){if(this.isLinked){for(var t=this,e=0;t&&t.isLinked;)e+=1,t=t.rest;return e+(t?t.contents.length:0)}return this.contents.length},List.prototype.at=function(t){for(var e,o=+t,i=this;i.isLinked;){if(!(1<o))return i.first;i=i.rest,o-=1}return isNil(e=i.contents[o-1])?"":e},List.prototype.contains=function(e){for(var t=this;t.isLinked;){if(snapEquals(t.first,e))return!0;t=t.rest}return t.contents.some(function(t){return snapEquals(t,e)})},List.prototype.isTable=function(){return this.enableTables&&(100<this.length()||1<this.cols())},List.prototype.get=function(t,e){var o,i,r;return t?e?(o=this.at(e))instanceof List?(i=o.length(),r=this.cols(),i<t?null:1===r&&1<i?[o]:r<=t&&r<i?new Variable(o.at(t)):o.at(t)):1===t&&e<=this.rows()?[o]:null:1===this.cols()?localize("items"):this.colName(t):e?e>this.rows()?null:this.rowName(e):[this.length()]},List.prototype.rows=function(){return this.length()},List.prototype.cols=function(){var t=this.at(1);return t instanceof List?t.length():1},List.prototype.colName=function(t){return t>this.cols()?null:String.fromCharCode(64+(t%26||26)).repeat(Math.floor((t-1)/26)+1)},List.prototype.rowName=function(t){return t},List.prototype.columnNames=function(){return[]},List.prototype.version=function(t,e){var o,i,r=Math.min(t+e,this.length()),n=this.lastChanged;for(i=t;i<=r;i+=1)o=this.at(i),n=Math.max(n,o.lastChanged?o.lastChanged:0);return n},List.prototype.asArray=function(){return this.becomeArray(),this.contents},List.prototype.itemsArray=function(){if(this.isLinked){for(var t,e=this,o=[];e&&e.isLinked;)o.push(e.first),e=e.rest;if(e)for(t=1;t<=e.contents.length;t+=1)o.push(e.at(t));return o}return this.contents},List.prototype.asText=function(){for(var t,e,o,i="",r=this;r.isLinked;)i=(e=r.first)instanceof List?i.concat(e.asText()):(e=isNil(e)?"":e.toString(),i.concat(e)),r=r.rest;for(t=r.length(),o=1;o<=t;o+=1)i=(e=r.at(o))instanceof List?i.concat(e.asText()):(e=isNil(e)?"":e.toString(),i.concat(e));return i},List.prototype.becomeArray=function(){this.isLinked&&(this.contents=this.itemsArray(),this.isLinked=!1,this.first=null,this.rest=null)},List.prototype.becomeLinked=function(){var t,e,o=this;if(!this.isLinked){for(e=this.length(),t=0;t<e;t+=1)o.first=this.contents[t],t<e-1&&(o.rest=new List,o.isLinked=!0,o=o.rest);this.contents=[],this.isLinked=!0}},List.prototype.asCSV=function(){var t=this.itemsArray(),e=[];function o(t){var e,o=t.toString();return-1===o.indexOf('"')&&-1===o.indexOf("\n")&&-1===o.indexOf(",")?o:(e=['"'],o.split("").forEach(function(t){e.push(t),'"'===t&&e.push(t)}),e.push('"'),e.join(""))}return t.some(function(t){return t instanceof List})?(t.forEach(function(t){t instanceof List?e.push(t.itemsArray().map(o).join(",")):e.push(o(t))}),e.join("\n")):t.map(o).join(",")},List.prototype.asJSON=function(t){return JSON.stringify(function o(t,i){var e=t.itemsArray(),r={};return function(t){var i;if(t.every(function(t){return t instanceof List&&t.length()<3}))return(i=t.map(function(t){return t.at(1)})).every(function(t){return isString(t)&&(e=t,(o=i).indexOf(e)===o.lastIndexOf(e));var e,o})}(e)?(e.forEach(function(t){var e=2===t.length()?t.at(2):void 0;r[t.at(1)]=e instanceof List?o(e,i):e}),r):e.map(function(t){return t instanceof List?o(t,i):t})}(this,t))},List.prototype.equalTo=function(t){var e,o,i,r=this,n=t;if(!(t instanceof List))return!1;for(;r.isLinked&&n.isLinked;){if(!snapEquals(r.first,n.first))return!1;r=r.rest,n=n.rest}for(n.isLinked&&(e=n,n=r,r=e),o=0;r.isLinked;){if(!snapEquals(r.first,n.contents[o]))return!1;r=r.rest,o+=1}if(e=0,r.contents.length!==n.contents.length-o)return!1;for(i=r.contents.length;0<i;){if(i-=1,!snapEquals(r.contents[e],n.contents[o]))return!1;e+=1,o+=1}return!0},List.prototype.canBeCSV=function(){return this.itemsArray().every(function(t){return!isNaN(+t)&&"boolean"!=typeof t||isString(t)||t instanceof List&&t.hasOnlyAtomicData()})},List.prototype.canBeJSON=function(){return this.itemsArray().every(function(t){return!isNaN(+t)||isString(t)||!0===t||!1===t||t instanceof List&&t.canBeJSON()})},List.prototype.hasOnlyAtomicData=function(){return this.itemsArray().every(function(t){return!isNaN(+t)&&"boolean"!=typeof t||isString(t)})},ListWatcherMorph.prototype=new BoxMorph,ListWatcherMorph.prototype.constructor=ListWatcherMorph,ListWatcherMorph.uber=BoxMorph.prototype,ListWatcherMorph.prototype.cellColor=SpriteMorph.prototype.blockColor.lists,ListWatcherMorph.prototype.init=function(t,e){var o=this;this.list=t||new List,this.start=1,this.range=100,this.lastUpdated=Date.now(),this.lastCell=null,this.parentCell=e||null,this.label=new StringMorph(localize("length: ")+this.list.length(),SyntaxElementMorph.prototype.fontSize,null,!1,!1,!1,MorphicPreferences.isFlat?new Point:new Point(1,1),new Color(255,255,255)),this.label.mouseClickLeft=function(){o.startIndexMenu()},this.frame=new ScrollFrameMorph(null,10),this.frame.alpha=0,this.frame.acceptsDrops=!1,this.frame.contents.acceptsDrops=!1,this.handle=new HandleMorph(this,80,70,3,3),this.handle.setExtent(new Point(13,13)),this.arrow=new ArrowMorph("down",SyntaxElementMorph.prototype.fontSize),this.arrow.mouseClickLeft=function(){o.startIndexMenu()},this.arrow.setRight(this.handle.right()),this.arrow.setBottom(this.handle.top()),this.handle.add(this.arrow),this.plusButton=new PushButtonMorph(this.list,"add","+"),this.plusButton.padding=0,this.plusButton.edge=0,this.plusButton.outlineColor=this.color,this.plusButton.drawNew(),this.plusButton.fixLayout(),ListWatcherMorph.uber.init.call(this,SyntaxElementMorph.prototype.rounding,1.000001,new Color(120,120,120)),this.color=new Color(220,220,220),this.isDraggable=!1,this.setExtent(new Point(80,70).multiplyBy(SyntaxElementMorph.prototype.scale)),this.add(this.label),this.add(this.frame),this.add(this.plusButton),this.add(this.handle),this.handle.drawNew(),this.update(),this.fixLayout()},ListWatcherMorph.prototype.update=function(t){var e,o,i,r,n,s,a,h,l,p;if(this.frame.contents.children.forEach(function(t){t instanceof CellMorph&&(t.contentsMorph instanceof ListWatcherMorph?t.contentsMorph.update():isSnapObject(t.contents)&&t.update())}),this.lastUpdated===this.list.lastChanged&&!t)return null;for(this.updateLength(!0),this.start=Math.max(Math.min(this.start,Math.floor((this.list.length()-1)/this.range)*this.range+1),1),l=Math.min(this.start+this.range-1,this.list.length()),i=Math.min(3*(l-this.start+1),this.frame.contents.children.length),e=0;e<i;e+=3)o=this.start+e/3,n=this.frame.contents.children[e],a=this.frame.contents.children[e+1],h=this.frame.contents.children[e+2],s=this.list.at(o),n.contents!==s&&(n.contents=s,n.drawNew(),this.lastCell&&n.setLeft(this.lastCell.left())),this.lastCell=n,a.text!==o.toString()&&(a.text=o.toString(),a.drawNew()),h.action=o;for(r=3*(l-this.start+1);this.frame.contents.children.length>r;)this.frame.contents.children[r].destroy();if(i=r,e=this.frame.contents.children.length,p=Date.now(),e+1<i)for(;e<i;e+=3){if(1e3<Date.now()-p)return this.fixLayout(),this.frame.contents.adjustBounds(),this.frame.contents.setLeft(this.frame.left()),null;o=this.start+e/3,a=new StringMorph(o.toString(),SyntaxElementMorph.prototype.fontSize,null,!1,!1,!1,MorphicPreferences.isFlat?new Point:new Point(1,1),new Color(255,255,255)),n=new CellMorph(this.list.at(o),this.cellColor,o,this.parentCell),(h=new PushButtonMorph(this.list.remove,o,"-",this.list)).padding=1,h.edge=0,h.corner=1,h.outlineColor=this.color.darker(),h.drawNew(),h.fixLayout(),this.frame.contents.add(n),this.lastCell?n.setPosition(this.lastCell.bottomLeft()):n.setTop(this.frame.contents.top()),this.lastCell=n,a.setCenter(n.center()),a.setRight(n.left()-2),this.frame.contents.add(a),this.frame.contents.add(h)}this.lastCell=null,this.fixLayout(),this.frame.contents.adjustBounds(),this.frame.contents.setLeft(this.frame.left()),this.updateLength(),this.lastUpdated=this.list.lastChanged},ListWatcherMorph.prototype.updateLength=function(t){this.label.text=localize("length: ")+this.list.length(),this.label.color=new Color(0,0,t?100:0),this.label.drawNew(),this.label.setCenter(this.center()),this.label.setBottom(this.bottom()-3)},ListWatcherMorph.prototype.startIndexMenu=function(){var t,e,o=this,i=Math.ceil(this.list.length()/this.range),r=new MenuMorph(function(t){o.setStartIndex(t)},null,o);for(r.addItem("1...",1),t=1;t<i;t+=1)e=100*t+1,r.addItem(e+"...",e);r.popUpAtHand(this.world())},ListWatcherMorph.prototype.setStartIndex=function(t){this.start=t,this.list.changed()},ListWatcherMorph.prototype.fixLayout=function(){this.label&&(Morph.prototype.trackChanges=!1,this.frame&&(this.arrangeCells(),this.frame.silentSetPosition(this.position().add(3)),this.frame.bounds.corner=this.bounds.corner.subtract(new Point(3,17)),this.frame.drawNew(),this.frame.contents.adjustBounds()),this.label.setCenter(this.center()),this.label.setBottom(this.bottom()-3),this.plusButton.setLeft(this.left()+3),this.plusButton.setBottom(this.bottom()-3),Morph.prototype.trackChanges=!0,this.changed(),this.parent&&this.parent.fixLayout&&this.parent.fixLayout())},ListWatcherMorph.prototype.arrangeCells=function(){var t,e,o,i,r,n=this.frame.contents.children.length;for(t=0;t<n;t+=3)e=this.frame.contents.children[t],o=this.frame.contents.children[t+1],i=this.frame.contents.children[t+2],r&&e.setTop(r.bottom()),o&&(o.setTop(e.center().y-o.height()/2),o.setRight(e.left()-2)),i&&(i.setCenter(e.center()),i.setLeft(e.right()+2)),r=e;this.frame.contents.adjustBounds()},ListWatcherMorph.prototype.expand=function(t){var e=this.frame.contents.extent(),o=new Point(e.x+6,e.y+this.label.height()+6);t&&(o=o.min(t)),this.setExtent(o),this.handle.setRight(this.right()-3),this.handle.setBottom(this.bottom()-3)},ListWatcherMorph.prototype.userMenu=function(){if(!List.prototype.enableTables)return this.escalateEvent("userMenu");var t=new MenuMorph(this),e=this;return t.addItem("table view...","showTableView"),t.addLine(),t.addItem("open in dialog...",function(){new TableDialogMorph(e.list).popUp(e.world())}),t},ListWatcherMorph.prototype.showTableView=function(){var t=this.parentThatIsAnyOf([SpriteBubbleMorph,SpeechBubbleMorph,CellMorph]);t&&(t instanceof SpriteBubbleMorph?(t.changed(),t.drawNew(!0)):t instanceof SpeechBubbleMorph?(t.contents=new TableFrameMorph(new TableMorph(this.list,10)),t.contents.expand(this.extent()),t.drawNew(!0)):(t.drawNew(!0,"table"),t.contentsMorph.expand(this.extent())),t.fixLayout())},ListWatcherMorph.prototype.mouseDoubleClick=function(t){List.prototype.enableTables?new TableDialogMorph(this.list).popUp(this.world()):this.escalateEvent("mouseDoubleClick",t)},ListWatcherMorph.prototype.show=function(){ListWatcherMorph.uber.show.call(this),this.frame.contents.adjustBounds()},ListWatcherMorph.prototype.drawNew=function(){WatcherMorph.prototype.drawNew.call(this),this.fixLayout()},modules.byob="2017-January-03",CustomBlockDefinition.prototype.blockInstance=function(){var t;return(t="command"===this.type?new CustomCommandBlockMorph(this):new CustomReporterBlockMorph(this,"predicate"===this.type)).isDraggable=!0,t},CustomBlockDefinition.prototype.templateInstance=function(){var t;return(t=this.blockInstance()).refreshDefaults(),t.isDraggable=!1,t.isTemplate=!0,t},CustomBlockDefinition.prototype.prototypeInstance=function(){var t,e,o=this;return(t="command"===this.type?new CustomCommandBlockMorph(this,!0):new CustomReporterBlockMorph(this,"predicate"===this.type,!0)).parts().forEach(function(t){t instanceof BlockInputFragmentMorph&&(e=o.declarations[t.fragment.labelString])&&(t.fragment.type=e[0],t.fragment.defaultValue=e[1],t.fragment.options=e[2],t.fragment.isReadOnly=e[3]||!1)}),t},CustomBlockDefinition.prototype.copyAndBindTo=function(t){var e=copy(this);return e.receiver=t,e.declarations=copy(this.declarations),e.body&&(e.body=Process.prototype.reify.call(null,this.body.expression,new List(this.inputNames())),e.body.outerContext=null),e},CustomBlockDefinition.prototype.blockSpec=function(){var e,o=this,i=[];return this.parseSpec(this.spec).forEach(function(t){e="%"===t[0]&&1<t.length?o.typeOf(t.slice(1)):t,i.push(e),i.push(" ")}),"".concat.apply("",i).trim()},CustomBlockDefinition.prototype.helpSpec=function(){var e=[];return this.parseSpec(this.spec).forEach(function(t){"%"!==t[0]&&e.push(t)}),"".concat.apply("",e).replace(/\?/g,"")},CustomBlockDefinition.prototype.typeOf=function(t){return this.declarations[t]?this.declarations[t][0]:"%s"},CustomBlockDefinition.prototype.defaultValueOf=function(t){return this.declarations[t]?this.declarations[t][1]:""},CustomBlockDefinition.prototype.defaultValueOfInputIdx=function(t){var e=this.inputNames()[t];return this.defaultValueOf(e)},CustomBlockDefinition.prototype.dropDownMenuOfInputIdx=function(t){var e=this.inputNames()[t];return this.dropDownMenuOf(e)},CustomBlockDefinition.prototype.isReadOnlyInputIdx=function(t){var e=this.inputNames()[t];return this.isReadOnlyInput(e)},CustomBlockDefinition.prototype.inputOptionsOfIdx=function(t){var e=this.inputNames()[t];return this.inputOptionsOf(e)},CustomBlockDefinition.prototype.dropDownMenuOf=function(t){return this.declarations[t]&&this.declarations[t][2]?this.parseChoices(this.declarations[t][2]):null},CustomBlockDefinition.prototype.parseChoices=function(t){var o={},i=[o];return t.split("\n").forEach(function(t){var e=t.split("=");"}"===e[0]?(i.pop(),o=i[i.length-1]):"{"===e[1]?(o={},i[i.length-1][e[0]]=o,i.push(o)):o[e[0]]=isNil(e[1])?e[0]:e[1]}),o},CustomBlockDefinition.prototype.isReadOnlyInput=function(t){return this.declarations[t]&&!0===this.declarations[t][3]},CustomBlockDefinition.prototype.inputOptionsOf=function(t){return[this.dropDownMenuOf(t),this.isReadOnlyInput(t)]},CustomBlockDefinition.prototype.inputNames=function(){var e=[];return this.parseSpec(this.spec).forEach(function(t){"%"===t[0]&&1<t.length&&e.push(t.slice(1))}),e},CustomBlockDefinition.prototype.parseSpec=function(t){var e,o,i=[],r="",n=!1;for(e=0;e<t.length;e+=1)"'"===(o=t[e])?n=!n:r=" "!==o||n?r.concat(o):(i.push(r),"");return i.push(r),i},CustomBlockDefinition.prototype.isDirectlyRecursive=function(){var e;return null!==this.cachedIsRecursive||(this.body?(e=this.spec,this.cachedIsRecursive=this.body.expression.anyChild(function(t){return t instanceof BlockMorph&&t.definition&&t.definition.spec===e})):this.cachedIsRecursive=!1),this.cachedIsRecursive},CustomBlockDefinition.prototype.scriptsPicture=function(){return this.scriptsModel().scriptsPicture()},CustomBlockDefinition.prototype.sortedElements=function(){return this.scriptsModel().sortedElements()},CustomBlockDefinition.prototype.scriptsModel=function(){var e,o,i,t,r;return(e=new ScriptsMorph).cleanUpMargin=10,(o=new PrototypeHatBlockMorph(this)).setPosition(e.position().add(10)),null!==this.comment&&(t=this.comment.fullCopy(),(o.comment=t).block=o),null!==this.body&&o.nextBlock(this.body.expression.fullCopy()),e.add(o),o.fixBlockColor(null,!0),this.scripts.forEach(function(t){(i=t.fullCopy()).setPosition(e.position().add(t.position())),e.add(i),i instanceof BlockMorph&&i.allComments().forEach(function(t){t.align(i)})}),o.allComments().forEach(function(t){t.align(o)}),(r=o.parts()[0]).fixLayout(),r.forceNormalColoring(),r.fixBlockColor(o,!0),e.fixMultiArgs(),e},CustomCommandBlockMorph.prototype=new CommandBlockMorph,CustomCommandBlockMorph.prototype.constructor=CustomCommandBlockMorph,CustomCommandBlockMorph.uber=CommandBlockMorph.prototype,CustomCommandBlockMorph.prototype.init=function(t,e){this.definition=t,this.isPrototype=e||!1,CustomCommandBlockMorph.uber.init.call(this,!0),this.category=t.category,this.selector="evaluateCustomBlock",this.variables=null,this.initializeVariables(),t&&this.refresh()},CustomCommandBlockMorph.prototype.initializeVariables=function(o){var i=this;this.variables=new VariableFrame,this.definition.variableNames.forEach(function(t){var e=o?o[t]:null;i.variables.addVar(t,e instanceof Variable?e.value:null)})},CustomCommandBlockMorph.prototype.refresh=function(t){var e,o=this.definition,i=this.isPrototype?o.spec:o.blockSpec();this.setCategory(o.category),this.blockSpec!==i?(e=this.inputs(),this.zebraContrast?this.fixBlockColor():this.forceNormalColoring(),this.setSpec(i,t),this.fixLabelColor(),this.restoreInputs(e)):this.inputs().forEach(function(t,e){t instanceof InputSlotMorph&&t.setChoices.apply(t,o.inputOptionsOfIdx(e))}),this.cachedInputs=null,this.inputs().forEach(function(t,e){t instanceof TemplateSlotMorph&&"↑"===t.contents()&&t.setContents(o.inputNames()[e])}),this.initializeVariables(this.variables.vars),this.forceNormalColoring(),this.drawNew(),this.fixBlockColor(null,!0)},CustomCommandBlockMorph.prototype.restoreInputs=function(e){var o,i=0,r=this;this.isPrototype||(this.cachedInputs=null,this.inputs().forEach(function(t){(o=e[i])instanceof ReporterBlockMorph&&!(t instanceof TemplateSlotMorph)?r.silentReplaceInput(t,o.fullCopy()):o instanceof InputSlotMorph&&t instanceof InputSlotMorph?t.setContents(o.evaluate()):o instanceof TemplateSlotMorph&&t instanceof TemplateSlotMorph?t.setContents(o.evaluate()):o instanceof CSlotMorph&&t instanceof CSlotMorph&&t.nestedBlock(o.evaluate()),i+=1}),this.cachedInputs=null)},CustomCommandBlockMorph.prototype.refreshDefaults=function(){var t=this.inputs(),e=0,o=this;t.forEach(function(t){t instanceof InputSlotMorph&&t.setContents(o.definition.defaultValueOfInputIdx(e)),e+=1}),this.cachedInputs=null},CustomCommandBlockMorph.prototype.refreshPrototype=function(){var t,e,o,i=[],r=this,n=0;if(!this.isPrototype)return null;t=this.parentThatIsA(PrototypeHatBlockMorph),this.parts().forEach(function(e){e.fragment.isDeleted||(e.fragment.type?i.push(e.fragment):r.definition.parseSpec(e.fragment.labelString).forEach(function(t){(o=e.fragment.copy()).labelString=t,i.push(o)}))}),e=this.specFromFragments(),this instanceof CustomCommandBlockMorph&&("reporter"===t.type||"predicate"===t.type)?(r=new CustomReporterBlockMorph(this.definition,"predicate"===t.type,!0),t.silentReplaceInput(this,r)):this instanceof CustomReporterBlockMorph&&("command"===t.type?(r=new CustomCommandBlockMorph(this.definition,!0),t.silentReplaceInput(this,r)):(this.isPredicate="predicate"===t.type,this.drawNew())),r.setCategory(t.blockCategory||"other"),t.fixBlockColor(),r.setSpec(e),r.parts().forEach(function(t){t instanceof BlockLabelPlaceHolderMorph||(i[n]&&(t.fragment=i[n]),n+=1)}),this.refreshPrototypeSlotTypes(),t.fixLayout()},CustomCommandBlockMorph.prototype.refreshPrototypeSlotTypes=function(){this.parts().forEach(function(t){t instanceof BlockInputFragmentMorph&&(t.template().instantiationSpec=t.contents(),t.setContents(t.fragment.defTemplateSpecFragment()))}),this.fixBlockColor(null,!0)},CustomCommandBlockMorph.prototype.inputFragmentNames=function(){var e=[];return this.parts().forEach(function(t){!t.fragment.isDeleted&&t.fragment.type&&e.push(t.fragment.labelString)}),e},CustomCommandBlockMorph.prototype.upvarFragmentNames=function(){var e=[];return this.parts().forEach(function(t){t.fragment.isDeleted||"%upvar"!==t.fragment.type||e.push(t.fragment.labelString)}),e},CustomCommandBlockMorph.prototype.upvarFragmentName=function(t){return this.upvarFragmentNames()[t]||"↑"},CustomCommandBlockMorph.prototype.specFromFragments=function(){var e="";return this.parts().forEach(function(t){t.fragment.isDeleted||(e=e+t.fragment.defSpecFragment()+" ")}),e.trim()},CustomCommandBlockMorph.prototype.blockSpecFromFragments=function(){var e="";return this.parts().forEach(function(t){t.fragment.isDeleted||(e=e+t.fragment.blockSpecFragment()+" ")}),e.trim()},CustomCommandBlockMorph.prototype.declarationsFromFragments=function(){var e={};return this.parts().forEach(function(t){t instanceof BlockInputFragmentMorph&&(e[t.fragment.labelString]=[t.fragment.type,t.fragment.defaultValue,t.fragment.options,t.fragment.isReadOnly])}),e},CustomCommandBlockMorph.prototype.parseSpec=function(t){return this.isPrototype?this.definition.parseSpec.call(this,t):CustomCommandBlockMorph.uber.parseSpec.call(this,t)},CustomCommandBlockMorph.prototype.mouseClickLeft=function(){if(!this.isPrototype)return CustomCommandBlockMorph.uber.mouseClickLeft.call(this);this.edit()},CustomCommandBlockMorph.prototype.edit=function(){var t,e,o,i=this;this.isPrototype?((e=this.definition.blockInstance()).addShadow(),o=this.parentThatIsA(PrototypeHatBlockMorph),new BlockDialogMorph(null,function(t){t&&SnapActions.setCustomBlockType(i.definition,t.category,t.type)},i).openForChange("Change block",o.blockCategory,o.type,i.world(),e.fullImage(),i.isInUse())):(Morph.prototype.trackChanges=!1,(t=new BlockEditorMorph(this.definition,this.receiver())).popUp(),Morph.prototype.trackChanges=!0,t.changed())},CustomCommandBlockMorph.prototype.labelPart=function(t){var e;return this.isPrototype?("%"===t[0]&&1<t.length?e=new BlockInputFragmentMorph(t.replace(/%/g,"")):((e=new BlockLabelFragmentMorph(t)).fontSize=this.fontSize,e.color=new Color(255,255,255),e.isBold=!0,e.shadowColor=this.color.darker(this.labelContrast),e.shadowOffset=this.embossing,e.drawNew()),e):CustomCommandBlockMorph.uber.labelPart.call(this,t)},CustomCommandBlockMorph.prototype.placeHolder=function(){var t;return(t=new BlockLabelPlaceHolderMorph).fontSize=1.4*this.fontSize,t.color=new Color(45,45,45),t.drawNew(),t},CustomCommandBlockMorph.prototype.attachTargets=function(){return this.isPrototype?[]:CustomCommandBlockMorph.uber.attachTargets.call(this)},CustomCommandBlockMorph.prototype.isInUse=function(){var o=this.definition,t=this.receiver().parentThatIsA(IDE_Morph);return o.isGlobal&&t?t.sprites.asArray().concat([t.stage]).some(function(t,e){return t.usesBlockInstance(o,!1,e)}):this.receiver().usesBlockInstance(o)},CustomCommandBlockMorph.prototype.userMenu=function(){var e,t=this.parentThatIsA(PrototypeHatBlockMorph),n=this.receiver(),s=this;return this.isPrototype?((e=new MenuMorph(this)).addItem("script pic...",function(){var t=this.world().children[0];t.saveCanvasAs(this.topBlock().scriptPic(),t.projectName||localize("Untitled")+" "+localize("script pic"))},"download a picture of this script"),t.inputs().length<2?e.addItem("block variables...",function(){t.enableBlockVars()},"experimental -\nunder construction"):e.addItem("remove block variables...",function(){t.enableBlockVars(!1)},"experimental -\nunder construction")):((e=this.constructor.uber.userMenu.call(this))?e.addLine():e=new MenuMorph(this),e.addItem("delete block definition...","deleteBlockDefinition"),this.variables.names().forEach(function(t){var o,i,r;o=t,i=n.parentThatIsA(StageMorph),r=s.variables,e.addItem(o+"...",function(){var t,e=detect(i.children,function(t){return t instanceof WatcherMorph&&t.target===r&&t.getter===o});if(null!==e)return e.show(),void e.fixLayout();(e=new WatcherMorph(o+" "+localize("(temporary)"),SpriteMorph.prototype.blockColor.variables,r,o)).setPosition(i.position().add(10)),0<(t=i.watchers(e.left())).length&&e.setTop(t[t.length-1].bottom()),i.add(e),e.fixLayout()})})),e.addItem("edit...","edit"),e},CustomCommandBlockMorph.prototype.exportBlockDefinition=function(){var t=(new SnapSerializer).serialize(this.definition);this.parentThatIsA(IDE_Morph).saveXMLAs(t,this.spec)},CustomCommandBlockMorph.prototype.deleteBlockDefinition=function(){var t,e=this;if(this.isPrototype)return null;(t=e.definition.blockInstance()).addShadow(),new DialogBoxMorph(this,function(){SnapActions.deleteCustomBlock(e.definition)},this).askYesNo("Delete Custom Block",localize("block deletion dialog text"),e.world(),t.fullImage())},CustomCommandBlockMorph.prototype.relabel=function(t){var o=new MenuMorph(this),i=this.inputs().map(function(t){return t.fullCopy()}),r=this;t.forEach(function(t){var e=t.blockInstance();e.restoreInputs(i),e.fixBlockColor(null,!0),e.addShadow(new Point(3,3)),o.addItem(e,function(){r.definition=t,r.refresh()})}),o.popup(this.world(),this.bottomLeft().subtract(new Point(8,this instanceof CommandBlockMorph?this.corner:0)))},CustomCommandBlockMorph.prototype.alternatives=function(){var t=this.receiver(),e=t.parentThatIsA(StageMorph),o=t.customBlocks.concat(e.globalBlocks),i=this;return o.filter(function(t){return t!==i.definition&&t.type===i.definition.type})},CustomReporterBlockMorph.prototype=new ReporterBlockMorph,CustomReporterBlockMorph.prototype.constructor=CustomReporterBlockMorph,CustomReporterBlockMorph.uber=ReporterBlockMorph.prototype,CustomReporterBlockMorph.prototype.init=function(t,e,o){this.definition=t,this.isPrototype=o||!1,CustomReporterBlockMorph.uber.init.call(this,e,!0),this.category=t.category,this.variables=new VariableFrame,this.initializeVariables(),this.selector="evaluateCustomBlock",t&&this.refresh()},CustomReporterBlockMorph.prototype.initializeVariables=CustomCommandBlockMorph.prototype.initializeVariables,CustomReporterBlockMorph.prototype.refresh=function(){CustomCommandBlockMorph.prototype.refresh.call(this,!0),this.isPrototype||(this.isPredicate="predicate"===this.definition.type),this.parent instanceof SyntaxElementMorph&&(this.parent.cachedInputs=null),this.drawNew()},CustomReporterBlockMorph.prototype.mouseClickLeft=function(){if(!this.isPrototype)return CustomReporterBlockMorph.uber.mouseClickLeft.call(this);this.edit()},CustomReporterBlockMorph.prototype.placeHolder=CustomCommandBlockMorph.prototype.placeHolder,CustomReporterBlockMorph.prototype.parseSpec=CustomCommandBlockMorph.prototype.parseSpec,CustomReporterBlockMorph.prototype.edit=CustomCommandBlockMorph.prototype.edit,CustomReporterBlockMorph.prototype.labelPart=CustomCommandBlockMorph.prototype.labelPart,CustomReporterBlockMorph.prototype.upvarFragmentNames=CustomCommandBlockMorph.prototype.upvarFragmentNames,CustomReporterBlockMorph.prototype.upvarFragmentName=CustomCommandBlockMorph.prototype.upvarFragmentName,CustomReporterBlockMorph.prototype.inputFragmentNames=CustomCommandBlockMorph.prototype.inputFragmentNames,CustomReporterBlockMorph.prototype.specFromFragments=CustomCommandBlockMorph.prototype.specFromFragments,CustomReporterBlockMorph.prototype.blockSpecFromFragments=CustomCommandBlockMorph.prototype.blockSpecFromFragments,CustomReporterBlockMorph.prototype.declarationsFromFragments=CustomCommandBlockMorph.prototype.declarationsFromFragments,CustomReporterBlockMorph.prototype.refreshPrototype=CustomCommandBlockMorph.prototype.refreshPrototype,CustomReporterBlockMorph.prototype.refreshPrototypeSlotTypes=CustomCommandBlockMorph.prototype.refreshPrototypeSlotTypes,CustomReporterBlockMorph.prototype.restoreInputs=CustomCommandBlockMorph.prototype.restoreInputs,CustomReporterBlockMorph.prototype.refreshDefaults=CustomCommandBlockMorph.prototype.refreshDefaults,CustomReporterBlockMorph.prototype.isInUse=CustomCommandBlockMorph.prototype.isInUse,CustomReporterBlockMorph.prototype.userMenu=CustomCommandBlockMorph.prototype.userMenu,CustomReporterBlockMorph.prototype.deleteBlockDefinition=CustomCommandBlockMorph.prototype.deleteBlockDefinition,CustomReporterBlockMorph.prototype.bubbleHelp=CustomCommandBlockMorph.prototype.bubbleHelp,CustomReporterBlockMorph.prototype.popUpbubbleHelp=CustomCommandBlockMorph.prototype.popUpbubbleHelp,CustomReporterBlockMorph.prototype.relabel=CustomCommandBlockMorph.prototype.relabel,CustomReporterBlockMorph.prototype.alternatives=CustomCommandBlockMorph.prototype.alternatives,JaggedBlockMorph.prototype=new ReporterBlockMorph,JaggedBlockMorph.prototype.constructor=JaggedBlockMorph,JaggedBlockMorph.uber=ReporterBlockMorph.prototype,JaggedBlockMorph.prototype.jag=5,JaggedBlockMorph.prototype.init=function(t){JaggedBlockMorph.uber.init.call(this),t&&this.setSpec(t),"%cs"===t&&(this.minWidth=25,this.fixLayout())},JaggedBlockMorph.prototype.drawNew=function(){var t;this.cachedClr=this.color.toString(),this.cachedClrBright=this.bright(),this.cachedClrDark=this.dark(),this.image=newCanvas(this.extent()),(t=this.image.getContext("2d")).fillStyle=this.cachedClr,this.drawBackground(t),MorphicPreferences.isFlat||this.drawEdges(t),this.eraseHoles(t)},JaggedBlockMorph.prototype.drawBackground=function(t){var e,o,i=this.width(),r=this.height(),n=Math.round(r/this.jag),s=r/n;for(t.fillStyle=this.cachedClr,t.beginPath(),t.moveTo(0,0),t.lineTo(i,0),e=o=0;e<n;e+=1)o+=s/2,t.lineTo(i-this.jag/2,o),o+=s/2,t.lineTo(i,o);for(t.lineTo(0,r),o=r,e=0;e<n;e+=1)o-=s/2,t.lineTo(this.jag/2,o),o-=s/2,t.lineTo(0,o);t.closePath(),t.fill()},JaggedBlockMorph.prototype.drawEdges=function(t){var e,o,i,r=this.width(),n=this.height(),s=Math.round(n/this.jag),a=n/s,h=this.edge/2;for(t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",(e=t.createLinearGradient(0,0,0,this.edge)).addColorStop(0,this.cachedClrBright),e.addColorStop(1,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(h,h),t.lineTo(r-h,h),t.stroke(),o=i=0;o<s;o+=1)t.strokeStyle=this.cachedClrDark,t.beginPath(),t.moveTo(r-h,i),i+=a/2,t.lineTo(r-this.jag/2-h,i),t.stroke(),i+=a/2;for((e=t.createLinearGradient(0,n-this.edge,0,n)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.moveTo(r-h,n-h),t.lineTo(h,n-h),t.stroke(),i=n,o=0;o<s;o+=1)t.strokeStyle=this.cachedClrBright,t.beginPath(),t.moveTo(h,i),i-=a/2,t.lineTo(this.jag/2+h,i),t.stroke(),i-=a/2},BlockDialogMorph.prototype=new DialogBoxMorph,BlockDialogMorph.prototype.constructor=BlockDialogMorph,BlockDialogMorph.uber=DialogBoxMorph.prototype,BlockDialogMorph.prototype.init=function(t,e,o){this.blockType="command",this.category="other",this.isGlobal=!0,this.types=null,this.categories=null,BlockDialogMorph.uber.init.call(this,t,e,o),this.key="makeABlock",this.types=new AlignmentMorph("row",this.padding),this.add(this.types),this.scopes=new AlignmentMorph("row",this.padding),this.add(this.scopes),this.categories=new BoxMorph,this.categories.color=SpriteMorph.prototype.paletteColor.lighter(8),this.categories.borderColor=this.categories.color.lighter(40),this.createCategoryButtons(),this.fixCategoriesLayout(),this.add(this.categories),this.createTypeButtons(),this.createScopeButtons(),this.fixLayout()},BlockDialogMorph.prototype.openForChange=function(t,e,o,i,r,n){var s=SpriteMorph.prototype.blockColor[e];this.key="changeABlock",this.category=e,this.blockType=o,this.categories.children.forEach(function(t){t.refresh()}),this.types.children.forEach(function(t){t.setColor(s),t.refresh()}),this.labelString=t,this.createLabel(),r&&this.setPicture(r),this.addButton("ok","OK"),this.addButton("cancel","Cancel"),n&&(this.types.destroy(),this.types=null),this.scopes.destroy(),this.scopes=null,this.fixLayout(),this.drawNew(),this.popUp(i)},BlockDialogMorph.prototype.createCategoryButtons=function(){var e=this,t=Morph.prototype.trackChanges;Morph.prototype.trackChanges=!1,SpriteMorph.prototype.categories.forEach(function(t){e.addCategoryButton(t)}),Morph.prototype.trackChanges=t},BlockDialogMorph.prototype.addCategoryButton=function(t){var e,o=this,i=[SpriteMorph.prototype.paletteColor,SpriteMorph.prototype.paletteColor.darker(50),SpriteMorph.prototype.blockColor[t]];return(e=new ToggleButtonMorph(i,this,function(){o.category=t,o.categories.children.forEach(function(t){t.refresh()}),o.types&&o.types.children.forEach(function(t){t.setColor(i[2])}),o.edit()},t[0].toUpperCase().concat(t.slice(1)),function(){return o.category===t},null,null,null,75,!0)).corner=8,e.padding=0,e.labelShadowOffset=new Point(-1,-1),e.labelShadowColor=i[1],e.labelColor=IDE_Morph.prototype.buttonLabelColor,e.contrast=this.buttonContrast,e.fixLayout(),e.refresh(),this.categories.add(e),e},BlockDialogMorph.prototype.fixCategoriesLayout=function(){var e,o,i=this.categories.children[0].width(),r=this.categories.children[0].height(),t=Math.ceil(this.categories.children.length/2),n=this.categories.left(),s=this.categories.top(),a=0,h=Morph.prototype.trackChanges;Morph.prototype.trackChanges=!1,this.categories.children.forEach(function(t){a+=1,e=Math.ceil(a/2),o=2-a%2,t.setPosition(new Point(n+(15*o+(o-1)*i),s+(2*e+(e-1)*r+10)))}),MorphicPreferences.isFlat&&(this.categories.corner=0,this.categories.border=0,this.categories.edge=0),this.categories.setExtent(new Point(45+2*i,2*(t+1)+t*r+20)),Morph.prototype.trackChanges=h,this.categories.changed()},BlockDialogMorph.prototype.createTypeButtons=function(){var t,e=this,o=SpriteMorph.prototype.blockColor[this.category];(t=new CommandBlockMorph).setColor(o),t.setSpec(localize("Command")),this.addBlockTypeButton(function(){e.setType("command")},t,function(){return"command"===e.blockType}),(t=new ReporterBlockMorph).setColor(o),t.setSpec(localize("Reporter")),this.addBlockTypeButton(function(){e.setType("reporter")},t,function(){return"reporter"===e.blockType}),(t=new ReporterBlockMorph(!0)).setColor(o),t.setSpec(localize("Predicate")),this.addBlockTypeButton(function(){e.setType("predicate")},t,function(){return"predicate"===e.blockType})},BlockDialogMorph.prototype.addBlockTypeButton=function(t,e,o){var i=new ToggleElementMorph(this,t,e,o,null,null,"rebuild");return i.refresh(),this.types.add(i),i},BlockDialogMorph.prototype.addTypeButton=function(t,e,o){var i=new ToggleMorph("radiobutton",this,t,e,o);return i.edge=this.buttonEdge/2,i.outline=this.buttonOutline/2,i.outlineColor=this.buttonOutlineColor,i.outlineGradient=this.buttonOutlineGradient,i.contrast=this.buttonContrast,i.drawNew(),i.fixLayout(),this.types.add(i),i},BlockDialogMorph.prototype.setType=function(t){this.blockType=t||this.blockType,this.types.children.forEach(function(t){t.refresh()}),this.edit()},BlockDialogMorph.prototype.createScopeButtons=function(){var t=this;this.addScopeButton(function(){t.setScope("global")},"for all sprites",function(){return t.isGlobal}),this.addScopeButton(function(){t.setScope("local")},"for this sprite only",function(){return!t.isGlobal})},BlockDialogMorph.prototype.addScopeButton=function(t,e,o){var i=new ToggleMorph("radiobutton",this,t,e,o);return i.edge=this.buttonEdge/2,i.outline=this.buttonOutline/2,i.outlineColor=this.buttonOutlineColor,i.outlineGradient=this.buttonOutlineGradient,i.contrast=this.buttonContrast,i.drawNew(),i.fixLayout(),this.scopes.add(i),i},BlockDialogMorph.prototype.setScope=function(t){this.isGlobal="global"===t,this.scopes.children.forEach(function(t){t.refresh()}),this.edit()},BlockDialogMorph.prototype.getInput=function(){var t,e,o;return this.body instanceof InputFieldMorph&&(t=this.normalizeSpaces(this.body.getValue())),(e=new CustomBlockDefinition(t)).type=this.blockType,e.category=this.category,e.isGlobal=this.isGlobal,"reporter"!==e.type&&"predicate"!==e.type||((o=Process.prototype.reify.call(null,SpriteMorph.prototype.blockForSelector("doReport"),new List,!0)).outerContext=null,e.body=o),e},BlockDialogMorph.prototype.fixLayout=function(){var t=fontHeight(this.titleFontSize)+2*this.titlePadding;this.body?(this.body.setPosition(this.position().add(new Point(this.padding,t+this.padding))),this.silentSetWidth(this.body.width()+2*this.padding),this.silentSetHeight(this.body.height()+2*this.padding+t),this.categories&&(this.categories.setCenter(this.body.center()),this.categories.setTop(this.body.top()),this.body.setTop(this.categories.bottom()+this.padding),this.silentSetHeight(this.height()+this.categories.height()+this.padding))):this.head&&(this.types?(this.types.fixLayout(),this.silentSetWidth(Math.max(this.types.width(),this.head.width())+2*this.padding)):this.silentSetWidth(Math.max(this.categories.width(),this.head.width())+2*this.padding),this.head.setCenter(this.center()),this.head.setTop(t+this.padding),this.silentSetHeight(this.head.height()+2*this.padding+t),this.categories&&(this.categories.setCenter(this.center()),this.categories.setTop(this.head.bottom()+this.padding),this.silentSetHeight(this.height()+this.categories.height()+this.padding))),this.label&&(this.label.setCenter(this.center()),this.label.setTop(this.top()+(t-this.label.height())/2)),this.types&&(this.types.fixLayout(),this.silentSetHeight(this.height()+this.types.height()+this.padding),this.silentSetWidth(Math.max(this.width(),this.types.width()+2*this.padding)),this.types.setCenter(this.center()),this.body?this.types.setTop(this.body.bottom()+this.padding):this.categories&&this.types.setTop(this.categories.bottom()+this.padding)),this.scopes&&(this.scopes.fixLayout(),this.silentSetHeight(this.height()+this.scopes.height()+this.padding/3),this.silentSetWidth(Math.max(this.width(),this.scopes.width()+2*this.padding)),this.scopes.setCenter(this.center()),this.types&&this.scopes.setTop(this.types.bottom()+this.padding/3)),this.buttons&&0<this.buttons.children.length&&(this.buttons.fixLayout(),this.silentSetHeight(this.height()+this.buttons.height()+this.padding),this.buttons.setCenter(this.center()),this.buttons.setBottom(this.bottom()-this.padding))},BlockDialogMorph.prototype.accept=function(){this.body instanceof InputFieldMorph&&""===this.normalizeSpaces(this.body.getValue())?this.edit():BlockDialogMorph.uber.accept.call(this)},BlockEditorMorph.prototype=new DialogBoxMorph,BlockEditorMorph.prototype.constructor=BlockEditorMorph,BlockEditorMorph.uber=DialogBoxMorph.prototype,BlockEditorMorph.prototype.init=function(t,e){var o,i,r,n,s,a=this,h=Process.prototype.enableLiveCoding||Process.prototype.enableSingleStepping;this.definition=t,this.handle=null,BlockEditorMorph.uber.init.call(this,e,function(){a.updateDefinition()},e),this.key="editBlock"+t.spec,this.labelString="Block Editor",this.createLabel(),(o=new ScriptsMorph(e)).rejectsHats=!0,o.isDraggable=!1,o.color=IDE_Morph.prototype.groupColor,o.cachedTexture=IDE_Morph.prototype.scriptsPaneTexture,o.cleanUpMargin=10,(i=new PrototypeHatBlockMorph(this.definition)).setPosition(o.position().add(10)),null!==t.comment&&(s=t.comment.fullCopy(),(i.comment=s).block=i),null!==t.body&&i.nextBlock(h?t.body.expression:t.body.expression.fullCopy()),o.add(i),i.fixBlockColor(null,!0),i.drawNew(),this.definition.scripts.forEach(function(t){(n=t.fullCopy()).setPosition(o.position().add(t.position())),o.add(n),n instanceof BlockMorph&&n.allComments().forEach(function(t){t.align(n)})}),i.allComments().forEach(function(t){t.align(i)}),(r=new ScrollFrameMorph(o)).padding=10,r.growth=50,r.isDraggable=!1,r.acceptsDrops=!1,r.contents.acceptsDrops=!0,o.scrollFrame=r,this.addBody(r),this.addButton("ok","Done"),this.setExtent(new Point(375,300)),this.fixLayout(),o.fixMultiArgs(),(n=i.parts()[0]).forceNormalColoring(),n.fixBlockColor(i,!0)},BlockEditorMorph.prototype.mouseClickLeft=function(){this.target.parentThatIsA(IDE_Morph).setActiveEditor(this)},BlockEditorMorph.prototype.onSetActive=function(){this.body.contents.updateUndoControls()},BlockEditorMorph.prototype.onUnsetActive=function(){this.body.contents.hideUndoControls()},BlockEditorMorph.prototype.popUp=function(t){var e,o=this.target.world();o&&(BlockEditorMorph.uber.popUp.call(this,o),this.setInitialDimensions(t),this.handle=new HandleMorph(this,280,220,this.corner,this.corner),o.keyboardReceiver=null,e=this.target.parentThatIsA(IDE_Morph),t||e.setActiveEditor(this))},BlockEditorMorph.prototype.justDropped=function(){nop()},BlockEditorMorph.prototype.accept=function(t){if(!(t instanceof CursorMorph)){this.action&&("function"==typeof this.target?"function"==typeof this.action?this.target.call(this.environment,this.action.call()):this.target.call(this.environment,this.action):"function"==typeof this.action?this.action.call(this.target,this.getInput()):this.target[this.action](this.getInput()));var e=this.target.parentThatIsA(IDE_Morph);e&&e.activeEditor===this&&e.setActiveEditor(),this.close()}},BlockEditorMorph.prototype.cancel=function(t){t instanceof CursorMorph||this.close()},BlockEditorMorph.prototype.close=function(){var t,e;return this.definition.isGlobal&&(e=detect(this.body.contents.allChildren(),function(t){return t.definition&&!t.definition.isGlobal}))?((e=e.definition.blockInstance()).addShadow(),void(new DialogBoxMorph).inform("Local Block(s) in Global Definition","This global block definition contains one or more\nlocal custom blocks which must be removed first.",this.world(),e.fullImage())):0<(t=this.target.doubleDefinitionsFor(this.definition)).length?((e=t[0].blockInstance()).addShadow(),void new DialogBoxMorph(this,"consolidateDoubles",this).askYesNo("Same Named Blocks","Another custom block with this name exists.\nWould you like to replace it?",this.world(),e.fullImage())):void this.destroy()},BlockEditorMorph.prototype.consolidateDoubles=function(){this.target.replaceDoubleDefinitionsFor(this.definition),this.destroy()},BlockEditorMorph.prototype.refreshAllBlockInstances=function(){var t=this.target.paletteBlockInstance(this.definition);this.target.allBlockInstances(this.definition).forEach(function(t){t.refresh()}),t&&t.refreshDefaults()},BlockEditorMorph.prototype.updateDefinition=function(t){var e,o,i,r=this.body.contents.position(),n=this;this.definition.receiver=this.target,this.definition.spec=this.prototypeSpec(),this.definition.declarations=this.prototypeSlots(),this.definition.variableNames=this.variableNames(),this.definition.scripts=[],this.definition.editorDimensions=this.bounds.copy(),this.definition.cachedIsRecursive=null,this.body.contents.children.forEach(function(t){t instanceof PrototypeHatBlockMorph?e=t:(t instanceof BlockMorph||t instanceof CommentMorph&&!t.block)&&((i=t.fullCopy()).parent=null,i.setPosition(t.position().subtract(r)),n.definition.scripts.push(i))}),e&&(this.definition.category=e.blockCategory,this.definition.type=e.type,e.comment?(this.definition.comment=e.comment.fullCopy(),this.definition.comment.block=!0):this.definition.comment=null),this.definition.body=this.context(e),t||(this.refreshAllBlockInstances(),(o=this.target.parentThatIsA(IDE_Morph)).flushPaletteCache(),o.refreshPalette())},BlockEditorMorph.prototype.context=function(t){var e,o;return null===(e=(t||detect(this.body.contents.children,function(t){return t instanceof PrototypeHatBlockMorph})).nextBlock())?null:(e.allChildren().forEach(function(t){t instanceof BlockMorph&&(t.cachedInputs=null)}),(o=Process.prototype.reify.call(null,e,new List(this.definition.inputNames()),!0)).outerContext=null,o)},BlockEditorMorph.prototype.prototypeSpec=function(){return detect(this.body.contents.children,function(t){return t instanceof PrototypeHatBlockMorph}).parts()[0].specFromFragments()},BlockEditorMorph.prototype.prototypeSlots=function(){return detect(this.body.contents.children,function(t){return t instanceof PrototypeHatBlockMorph}).parts()[0].declarationsFromFragments()},BlockEditorMorph.prototype.variableNames=function(){return detect(this.body.contents.children,function(t){return t instanceof PrototypeHatBlockMorph}).variableNames()},BlockEditorMorph.prototype.setInitialDimensions=function(t){var e=this.world(),o=e.extent().subtract(new Point(this.padding,this.padding)),i=fontHeight(this.titleFontSize)+2*this.titlePadding,r=this.buttons.height();if(t){if(this.definition.editorDimensions)return this.silentSetPosition(this.definition.editorDimensions.origin),this.silentSetExtent(this.definition.editorDimensions.extent().min(o)),void this.keepWithin(e);this.silentSetExtent(this.body.contents.extent().add(new Point(this.padding,this.padding+i+r)).min(o)),this.silentSetPosition(this.world().center().subtract(this.extent().floorDivideBy(2)))}else{if(this.definition.editorDimensions)return this.setPosition(this.definition.editorDimensions.origin),this.setExtent(this.definition.editorDimensions.extent().min(o)),void this.keepWithin(e);this.setExtent(this.body.contents.extent().add(new Point(this.padding,this.padding+i+r)).min(o)),this.setCenter(this.world().center())}},BlockEditorMorph.prototype.fixLayout=function(){var t=fontHeight(this.titleFontSize)+2*this.titlePadding;this.buttons&&0<this.buttons.children.length&&this.buttons.fixLayout(),this.body&&(this.body.setPosition(this.position().add(new Point(this.padding,t+this.padding))),this.body.setExtent(new Point(this.width()-2*this.padding,this.height()-3*this.padding-t-this.buttons.height()))),this.label&&(this.label.setCenter(this.center()),this.label.setTop(this.top()+(t-this.label.height())/2)),this.buttons&&0<this.buttons.children.length&&(this.buttons.setCenter(this.center()),this.buttons.setBottom(this.bottom()-this.padding))},PrototypeHatBlockMorph.prototype=new HatBlockMorph,PrototypeHatBlockMorph.prototype.constructor=PrototypeHatBlockMorph,PrototypeHatBlockMorph.uber=HatBlockMorph.prototype,PrototypeHatBlockMorph.prototype.init=function(t){var e,o=t.prototypeInstance();this.definition=t,this.blockCategory=t?t.category:null,this.type=t?t.type:null,HatBlockMorph.uber.init.call(this),this.color=SpriteMorph.prototype.blockColor.control,this.category="control",this.add(o),t.variableNames.length&&(e=this.labelPart("%blockVars"),this.add(this.labelPart("%br")),this.add(e),t.variableNames.forEach(function(t){e.addInput(t)})),o.refreshPrototypeSlotTypes(),this.fixLayout(),o.fixBlockColor(this,!0),this.id=this.definition.id},PrototypeHatBlockMorph.prototype.mouseClickLeft=function(){if(16===this.world().currentKey)return this.focus();this.parts()[0].mouseClickLeft()},PrototypeHatBlockMorph.prototype.userMenu=function(){return this.parts()[0].userMenu()},PrototypeHatBlockMorph.prototype.fixBlockColor=function(t,e){var o=this.parts()[0]||t;if(this.zebraContrast||e){if(!this.zebraContrast&&e)return this.forceNormalColoring();o.category===this.category?o.color.eq(this.color)&&this.alternateBlockColor():this.category&&!this.color.eq(SpriteMorph.prototype.blockColor[this.category])&&this.alternateBlockColor(),e&&this.fixChildrensBlockColor(!0)}},PrototypeHatBlockMorph.prototype.variableNames=function(t){var e=this.parts();return e.length<3?[]:e[2].evaluate()},PrototypeHatBlockMorph.prototype.enableBlockVars=function(t){var e=this.parts()[0];!1===t?this.setSpec("%s",!0):this.setSpec("%s %br %blockVars",!0),this.replaceInput(this.parts()[0],e),this.spec=null},BlockLabelFragment.prototype.defSpecFragment=function(){var t=this.type?"%'":"";return this.isDeleted?"":t+this.labelString+(this.type?"'":"")},BlockLabelFragment.prototype.defTemplateSpecFragment=function(){var t="";return this.type?(this.isUpvar()?t=" ↑":this.isMultipleInput()?t="...":"%cs"===this.type?t=" λ":"%b"===this.type?t=" ?":"%l"===this.type?t=" ︙":"%obj"===this.type?t=" %turtleOutline":contains(["%cmdRing","%repRing","%predRing","%anyUE","%boolUE"],this.type)?t=" λ":this.defaultValue?t="%n"===this.type?" # = "+this.defaultValue.toString():" = "+this.defaultValue.toString():"%n"===this.type&&(t=" #"),this.labelString+t):this.defSpecFragment()},BlockLabelFragment.prototype.blockSpecFragment=function(){return this.isDeleted?"":this.type||this.labelString},BlockLabelFragment.prototype.copy=function(){var t=new BlockLabelFragment(this.labelString);return t.type=this.type,t.defaultValue=this.defaultValue,t.options=this.options,t.isReadOnly=this.isReadOnly,t},BlockLabelFragment.prototype.isSingleInput=function(){return!this.isMultipleInput()&&"%upvar"!==this.type},BlockLabelFragment.prototype.isMultipleInput=function(){return!!this.type&&-1<this.type.indexOf("%mult")},BlockLabelFragment.prototype.isUpvar=function(){return!!this.type&&"%upvar"===this.type},BlockLabelFragment.prototype.setToSingleInput=function(){if(!this.type)return null;"%upvar"===this.type?this.type="%s":this.type=this.singleInputType()},BlockLabelFragment.prototype.setToMultipleInput=function(){if(!this.type)return null;"%upvar"===this.type&&(this.type="%s"),this.type="%mult".concat(this.singleInputType())},BlockLabelFragment.prototype.setToUpvar=function(){if(!this.type)return null;this.type="%upvar"},BlockLabelFragment.prototype.singleInputType=function(){return this.type?this.isMultipleInput()?this.type.substr(5):this.type:null},BlockLabelFragment.prototype.setSingleInputType=function(t){this.type&&this.isMultipleInput()?this.type="%mult".concat(t):this.type=t},BlockLabelFragmentMorph.prototype=new StringMorph,BlockLabelFragmentMorph.prototype.constructor=BlockLabelFragmentMorph,BlockLabelFragmentMorph.uber=StringMorph.prototype,BlockLabelFragmentMorph.prototype.init=function(t){this.fragment=new BlockLabelFragment(t),this.fragment.type=null,this.sO=null,BlockLabelFragmentMorph.uber.init.call(this,t,null,SyntaxElementMorph.prototype.labelFontStyle,null,null,null,null,null,null,SyntaxElementMorph.prototype.labelFontName)},BlockLabelFragmentMorph.prototype.mouseEnter=function(){this.sO=this.shadowOffset,this.shadowOffset=this.sO.neg(),this.drawNew(),this.changed()},BlockLabelFragmentMorph.prototype.mouseLeave=function(){this.shadowOffset=this.sO,this.drawNew(),this.changed()},BlockLabelFragmentMorph.prototype.mouseClickLeft=function(){var t=this.fragment.copy(),e=this,o=this instanceof BlockLabelPlaceHolderMorph,i=this.parent.parseSpec(this.parent.blockSpec).length<2;new InputSlotDialogMorph(t,null,function(){t.isDeleted?SnapActions.deleteBlockLabel(e.parent.definition,e):t.labelString&&SnapActions.updateBlockLabel(e.parent.definition,e,t)},this,this.parent.definition.category).open(this instanceof BlockLabelFragmentMorph?"Edit label fragment":o?"Create input name":"Edit input name",t.labelString,this.world(),null,o||i)},BlockLabelFragmentMorph.prototype.updateBlockLabel=function(t){var e=this.parentThatIsA(BlockMorph);this.fragment=t,e&&e.refreshPrototype()},BlockLabelFragmentMorph.prototype.userMenu=function(){var o=this,e=new Color(100,100,130),i=new MenuMorph(function(t){var e=o.text.split("-");o.changed(),e[0]="$"+t,o.text=e.join("-"),o.fragment.labelString=o.text,o.parent.parent.changed(),o.drawNew(),o.changed(),o.parent.parent.fixLayout(),o.parent.parent.changed()},null,this,this.fontSize);return SymbolMorph.prototype.names.forEach(function(t){i.addItem([new SymbolMorph(t,i.fontSize,e),t],t)}),i},BlockLabelPlaceHolderMorph.prototype=new StringMorph,BlockLabelPlaceHolderMorph.prototype.constructor=BlockLabelPlaceHolderMorph,BlockLabelPlaceHolderMorph.uber=StringMorph.prototype,BlockLabelPlaceHolderMorph.prototype.plainLabel=!1,BlockLabelPlaceHolderMorph.prototype.init=function(){this.fragment=new BlockLabelFragment(""),this.fragment.type="%s",this.fragment.isDeleted=!0,this.isHighlighted=!1,this.isProtectedLabel=!0,BlockLabelFragmentMorph.uber.init.call(this,"+")},BlockLabelPlaceHolderMorph.prototype.drawNew=function(){var t,e,o,i,r,n;this.plainLabel&&(this.text=this.isHighlighted?" + ":""),this.image=newCanvas(),(t=this.image.getContext("2d")).font=this.font(),e=Math.max(t.measureText(this.text).width+Math.abs(this.shadowOffset.x),1),this.bounds.corner=this.bounds.origin.add(new Point(e,fontHeight(this.fontSize)+Math.abs(this.shadowOffset.y))),this.image.width=e,this.image.height=this.height(),this.isHighlighted&&(r=Math.floor(e/2),n=Math.floor(this.height()/2),t.fillStyle=this.color.toString(),t.beginPath(),t.arc(r,1.2*n,Math.min(r,n),radians(0),radians(360),!1),t.closePath(),t.fill()),t.font=this.font(),t.textAlign="left",t.textBaseline="bottom",this.shadowColor&&(o=Math.max(this.shadowOffset.x,0),i=Math.max(this.shadowOffset.y,0),t.fillStyle=this.shadowColor.toString(),t.fillText(this.text,o,fontHeight(this.fontSize)+i)),o=Math.abs(Math.min(this.shadowOffset.x,0)),i=Math.abs(Math.min(this.shadowOffset.y,0)),t.fillStyle=this.isHighlighted?"white":this.color.toString(),t.fillText(this.text,o,fontHeight(this.fontSize)+i),this.parent&&(this.parent.fixLayout&&this.parent.fixLayout(),this.parent.parent instanceof PrototypeHatBlockMorph&&this.parent.parent.fixLayout())},BlockLabelPlaceHolderMorph.prototype.mouseEnter=function(){var t=this.parentThatIsA(PrototypeHatBlockMorph);this.isHighlighted=!0,this.plainLabel&&t?(t.changed(),this.drawNew(),t.changed()):(this.drawNew(),this.changed())},BlockLabelPlaceHolderMorph.prototype.mouseLeave=function(){var t=this.parentThatIsA(PrototypeHatBlockMorph);this.isHighlighted=!1,this.plainLabel&&t?(t.changed(),this.drawNew(),t.changed()):(this.drawNew(),this.changed())},BlockLabelPlaceHolderMorph.prototype.mouseClickLeft=BlockLabelFragmentMorph.prototype.mouseClickLeft,BlockLabelPlaceHolderMorph.prototype.updateBlockLabel=BlockLabelFragmentMorph.prototype.updateBlockLabel,BlockInputFragmentMorph.prototype=new TemplateSlotMorph,BlockInputFragmentMorph.prototype.constructor=BlockInputFragmentMorph,BlockInputFragmentMorph.uber=TemplateSlotMorph.prototype,BlockInputFragmentMorph.prototype.init=function(t){this.fragment=new BlockLabelFragment(t),this.fragment.type="%s",BlockInputFragmentMorph.uber.init.call(this,t)},BlockInputFragmentMorph.prototype.mouseClickLeft=BlockLabelFragmentMorph.prototype.mouseClickLeft,BlockInputFragmentMorph.prototype.updateBlockLabel=BlockLabelFragmentMorph.prototype.updateBlockLabel,InputSlotDialogMorph.prototype=new DialogBoxMorph,InputSlotDialogMorph.prototype.constructor=InputSlotDialogMorph,InputSlotDialogMorph.uber=DialogBoxMorph.prototype,InputSlotDialogMorph.prototype.isLaunchingExpanded=!1,InputSlotDialogMorph.prototype.init=function(t,e,o,i,r){var n=SyntaxElementMorph.prototype.scale,s=fontHeight(10)/1.2*n;this.fragment=t||new BlockLabelFragment,this.textfield=null,this.types=null,this.slots=null,this.isExpanded=!1,this.category=r||"other",this.cachedRadioButton=null,this.noDelete=!1,BlockDialogMorph.uber.init.call(this,e,o,i),this.types=new AlignmentMorph("row",this.padding),this.types.respectHiddens=!0,this.add(this.types),this.slots=new BoxMorph,this.slots.color=new Color(55,55,55),this.slots.borderColor=this.slots.color.lighter(50),this.slots.setExtent(new Point(24*(s+10),10.4*(s+10*n))),this.add(this.slots),this.createSlotTypeButtons(),this.fixSlotsLayout(),this.addSlotsMenu(),this.createTypeButtons(),this.fixLayout()},InputSlotDialogMorph.prototype.createTypeButtons=function(){var t,e,o=this,i=SpriteMorph.prototype.blockColor[this.category];(t=new JaggedBlockMorph(localize("Title text"))).setColor(i),this.addBlockTypeButton(function(){o.setType(null)},t,function(){return null===o.fragment.type}),(t=new JaggedBlockMorph("%inputName")).setColor(i),this.addBlockTypeButton(function(){o.setType("%s")},t,function(){return null!==o.fragment.type}),(e=new ArrowMorph("right",PushButtonMorph.prototype.fontSize+4,2)).noticesTransparentClick=!0,this.types.add(e),this.types.fixLayout(),e.refresh=function(){null===o.fragment.type?(o.isExpanded=!1,e.hide(),o.drawNew()):(e.show(),o.isExpanded?e.direction="down":e.direction="right",e.drawNew(),e.changed())},e.mouseClickLeft=function(){e.isVisible&&(o.isExpanded=!o.isExpanded,o.types.children.forEach(function(t){t.refresh()}),o.drawNew(),o.edit())},e.refresh()},InputSlotDialogMorph.prototype.addTypeButton=BlockDialogMorph.prototype.addTypeButton,InputSlotDialogMorph.prototype.addBlockTypeButton=BlockDialogMorph.prototype.addBlockTypeButton,InputSlotDialogMorph.prototype.setType=function(t){this.textfield.choices=t?null:this.symbolMenu,this.textfield.drawNew(),this.fragment.type=t||null,this.types.children.forEach(function(t){t.refresh()}),this.slots.children.forEach(function(t){t.refresh()}),this.edit()},InputSlotDialogMorph.prototype.getInput=function(){var t;return this.body instanceof InputFieldMorph&&(t=this.normalizeSpaces(this.body.getValue())),t?(this.fragment.labelString=t,this.fragment.defaultValue=this.slots.defaultInputField.getValue(),t):(this.noDelete||(this.fragment.isDeleted=!0),null)},InputSlotDialogMorph.prototype.fixLayout=function(){var t,e=this.left(),o=fontHeight(this.titleFontSize)+2*this.titlePadding;if(!this.isExpanded)return this.slots&&this.slots.hide(),BlockDialogMorph.prototype.fixLayout.call(this);this.slots.show(),t=this.slots.width(),this.body.setPosition(this.position().add(new Point(this.padding+(t-this.body.width())/2,o+this.padding))),this.label.setLeft(e+this.padding+(t-this.label.width())/2),this.label.setTop(this.top()+(o-this.label.height())/2),this.types.fixLayout(),this.types.setTop(this.body.bottom()+this.padding),this.types.setLeft(e+this.padding+(t-this.types.width())/2),this.slots.setPosition(new Point(this.left()+this.padding,this.types.bottom()+this.padding)),this.slots.children.forEach(function(t){t.refresh()}),this.buttons.fixLayout(),this.buttons.setTop(this.slots.bottom()+this.padding),this.buttons.setLeft(e+this.padding+(t-this.buttons.width())/2),this.silentSetHeight(this.buttons.bottom()-this.top()+this.padding),this.silentSetWidth(this.slots.right()-this.left()+this.padding)},InputSlotDialogMorph.prototype.open=function(t,e,o,i,r){var n=new InputFieldMorph(e),s=Morph.prototype.trackChanges;this.fragment.type||(n.choices=this.symbolMenu),Morph.prototype.trackChanges=!1,this.isExpanded=this.isLaunchingExpanded,n.setWidth(250),this.labelString=t,this.createLabel(),i&&this.setPicture(i),this.addBody(n),n.drawNew(),this.textfield=n,this.addButton("ok","OK"),r?this.noDelete=!0:this.addButton("deleteFragment","Delete"),this.addButton("cancel","Cancel"),this.fixLayout(),this.drawNew(),this.fixLayout(),this.popUp(o),this.add(this.types),Morph.prototype.trackChanges=s,this.changed()},InputSlotDialogMorph.prototype.symbolMenu=function(){var e=[],o=new Color(100,100,130),i=this;return SymbolMorph.prototype.names.forEach(function(t){e.push([[new SymbolMorph(t,i.fontSize,o),localize(t)],"$"+t])}),e},InputSlotDialogMorph.prototype.deleteFragment=function(){this.fragment.isDeleted=!0,this.accept()},InputSlotDialogMorph.prototype.createSlotTypeButtons=function(){var t,e,o=this,i=Morph.prototype.trackChanges;Morph.prototype.trackChanges=!1,this.addSlotTypeButton("Object","%obj"),this.addSlotTypeButton("Text","%txt"),this.addSlotTypeButton("List","%l"),this.addSlotTypeButton("Number","%n"),this.addSlotTypeButton("Any type","%s"),this.addSlotTypeButton("Boolean (T/F)","%b"),this.addSlotTypeButton("Command\n(inline)","%cmdRing"),this.addSlotTypeButton("Reporter","%repRing"),this.addSlotTypeButton("Predicate","%predRing"),this.addSlotTypeButton("Command\n(C-shape)","%cs"),this.addSlotTypeButton("Any\n(unevaluated)","%anyUE"),this.addSlotTypeButton("Boolean\n(unevaluated)","%boolUE"),this.slots.radioButtonSingle=this.addSlotArityButton(function(){o.setSlotArity("single")},"Single input.",function(){return o.fragment.isSingleInput()}),this.addSlotArityButton(function(){o.setSlotArity("multiple")},"Multiple inputs (value is list of inputs)",function(){return o.fragment.isMultipleInput()}),this.addSlotArityButton(function(){o.setSlotArity("upvar")},"Upvar - make internal variable visible to caller",function(){return o.fragment.isUpvar()}),(t=new StringMorph(localize("Default Value:"))).fontSize=this.slots.radioButtonSingle.fontSize,t.setColor(new Color(255,255,255)),t.refresh=function(){o.isExpanded&&contains(["%s","%n","%txt","%anyUE"],o.fragment.type)?t.show():t.hide()},this.slots.defaultInputLabel=t,this.slots.add(t),(e=new InputFieldMorph(this.fragment.defaultValue)).contents().fontSize=t.fontSize,e.contrast=90,e.contents().drawNew(),e.setWidth(50),e.refresh=function(){t.isVisible?(e.show(),"%n"===o.fragment.type?e.setIsNumeric(!0):e.setIsNumeric(!1)):e.hide()},this.slots.defaultInputField=e,this.slots.add(e),e.drawNew(),Morph.prototype.trackChanges=i},InputSlotDialogMorph.prototype.setSlotType=function(t){this.fragment.setSingleInputType(t),this.slots.children.forEach(function(t){t.refresh()}),this.edit()},InputSlotDialogMorph.prototype.setSlotArity=function(t){"single"===t?this.fragment.setToSingleInput():"multiple"===t?this.fragment.setToMultipleInput():"upvar"===t&&this.fragment.setToUpvar(),this.slots.children.forEach(function(t){t.refresh()}),this.edit()},InputSlotDialogMorph.prototype.addSlotTypeButton=function(t,e){var o,i,r=this,n=new JaggedBlockMorph(e);return o=function(){return r.fragment.singleInputType()===e},n.setCategory(this.category),n.rebuild(),(i=new ToggleMorph("radiobutton",this,function(){r.setSlotType(e)},t,o,null,null,this.cachedRadioButton,n.fullImage(),"rebuild")).edge=this.buttonEdge/2,i.outline=this.buttonOutline/2,i.outlineColor=this.buttonOutlineColor,i.outlineGradient=this.buttonOutlineGradient,i.drawNew(),i.fixLayout(),i.label.isBold=!1,i.label.setColor(new Color(255,255,255)),this.cachedRadioButton||(this.cachedRadioButton=i),this.slots.add(i),i},InputSlotDialogMorph.prototype.addSlotArityButton=function(t,e,o){var i=new ToggleMorph("radiobutton",this,t,e,o,null,null,this.cachedRadioButton);return i.edge=this.buttonEdge/2,i.outline=this.buttonOutline/2,i.outlineColor=this.buttonOutlineColor,i.outlineGradient=this.buttonOutlineGradient,i.drawNew(),i.fixLayout(),i.label.setColor(new Color(255,255,255)),this.slots.add(i),this.cachedRadioButton||(this.cachedRadioButton=i),i},InputSlotDialogMorph.prototype.fixSlotsLayout=function(){var t,e,o=this.slots,i=SyntaxElementMorph.prototype.scale,r=10*i,n=14*i,s=(fontHeight(10)/1.2+15)*i,a=(fontHeight(10)/1.2+10)*i,h=[o.left()+r,o.left()+o.width()/3,o.left()+2*o.width()/3],l=[o.top()+n,o.top()+n+s,o.top()+n+2*s,o.top()+n+3*s,o.top()+n+4*s,o.top()+n+5*s,o.top()+n+5*s+a,o.top()+n+5*s+2*a],p=-1,c=Morph.prototype.trackChanges;for(Morph.prototype.trackChanges=!1,t=0;t<12;t+=1)(e=t%3)==0&&(p+=1),o.children[t].setPosition(new Point(h[e],l[p]));for(e=0,p=5,t=12;t<15;t+=1)o.children[t].setPosition(new Point(h[e],l[p+t-12]));this.slots.defaultInputLabel.setPosition(this.slots.radioButtonSingle.label.topRight().add(new Point(5,0))),this.slots.defaultInputField.setCenter(this.slots.defaultInputLabel.center().add(new Point(this.slots.defaultInputField.width()/2+this.slots.defaultInputLabel.width()/2+5,0))),Morph.prototype.trackChanges=c,this.slots.changed()},InputSlotDialogMorph.prototype.addSlotsMenu=function(){var e=this;this.slots.userMenu=function(){if(contains(["%s","%n","%txt","%anyUE"],e.fragment.type)){var t=new MenuMorph(e);return t.addItem("options...","editSlotOptions"),t.addItem((e.fragment.isReadOnly?"☑ ":"☐ ")+localize("read-only"),function(){e.fragment.isReadOnly=!e.fragment.isReadOnly}),t}return Morph.prototype.userMenu.call(e)}},InputSlotDialogMorph.prototype.editSlotOptions=function(){var e=this;new DialogBoxMorph(e,function(t){e.fragment.options=t.trim()},e).promptCode("Input Slot Options",e.fragment.options,e.world(),null,localize('Enter one option per line.\nOptionally use "=" as key/value delimiter and {} for submenus. e.g.\n   the answer=42'))},InputSlotDialogMorph.prototype.hide=function(){this.isVisible=!1,this.changed()},InputSlotDialogMorph.prototype.show=function(){this.isVisible=!0,this.changed()},VariableDialogMorph.prototype=new DialogBoxMorph,VariableDialogMorph.prototype.constructor=VariableDialogMorph,VariableDialogMorph.uber=DialogBoxMorph.prototype,VariableDialogMorph.prototype.init=function(t,e,o){this.types=null,this.isGlobal=!0,BlockDialogMorph.uber.init.call(this,t,e,o),this.types=new AlignmentMorph("row",this.padding),this.add(this.types),this.createTypeButtons()},VariableDialogMorph.prototype.createTypeButtons=function(){var t=this;this.addTypeButton(function(){t.setType("global")},"for all sprites",function(){return t.isGlobal}),this.addTypeButton(function(){t.setType("local")},"for this sprite only",function(){return!t.isGlobal})},VariableDialogMorph.prototype.addTypeButton=BlockDialogMorph.prototype.addTypeButton,VariableDialogMorph.prototype.setType=function(t){this.isGlobal="global"===t,this.types.children.forEach(function(t){t.refresh()}),this.edit()},VariableDialogMorph.prototype.getInput=function(){var t=this.normalizeSpaces(this.body.getValue());return t?[t,this.isGlobal]:null},VariableDialogMorph.prototype.fixLayout=function(){var t=fontHeight(this.titleFontSize)+2*this.titlePadding;this.body&&(this.body.setPosition(this.position().add(new Point(this.padding,t+this.padding))),this.silentSetWidth(this.body.width()+2*this.padding),this.silentSetHeight(this.body.height()+2*this.padding+t)),this.label&&(this.label.setCenter(this.center()),this.label.setTop(this.top()+(t-this.label.height())/2)),this.types&&(this.types.fixLayout(),this.silentSetHeight(this.height()+this.types.height()+this.padding),this.silentSetWidth(Math.max(this.width(),this.types.width()+2*this.padding)),this.types.setCenter(this.center()),this.body?this.types.setTop(this.body.bottom()+this.padding):this.categories&&this.types.setTop(this.categories.bottom()+this.padding)),this.buttons&&0<this.buttons.children.length&&(this.buttons.fixLayout(),this.silentSetHeight(this.height()+this.buttons.height()+this.padding),this.buttons.setCenter(this.center()),this.buttons.setBottom(this.bottom()-this.padding))},BlockExportDialogMorph.prototype=new DialogBoxMorph,BlockExportDialogMorph.prototype.constructor=BlockExportDialogMorph,BlockExportDialogMorph.uber=DialogBoxMorph.prototype,BlockExportDialogMorph.prototype.key="blockExport",BlockExportDialogMorph.prototype.init=function(t,e,o){var i=this;this.serializer=t,this.blocks=e.slice(0),this.handle=null,BlockExportDialogMorph.uber.init.call(this,o,function(){i.exportBlocks()},null),this.labelString="Export blocks / message types",this.createLabel(),this.buildContents()},BlockExportDialogMorph.prototype.buildContents=function(){var o,i,r,n,s,a,h=this,t=this.target;(o=new ScrollFrameMorph(null,null,SpriteMorph.prototype.sliderColor)).color=SpriteMorph.prototype.paletteColor,o.padding=4,o.isDraggable=!1,o.acceptsDrops=!1,o.contents.acceptsDrops=!1,i=o.left()+4,r=o.top()+4,SpriteMorph.prototype.categories.forEach(function(t){h.blocks.forEach(function(e){e.category===t&&(a&&t!==a&&(r+=4),a=t,n=e.templateInstance(),(s=new ToggleMorph("checkbox",h,function(){var t=h.blocks.indexOf(e);-1<t?h.blocks.splice(t,1):h.blocks.push(e)},null,function(){return contains(h.blocks,e)},null,null,null,n.fullImage())).setPosition(new Point(i,r+(s.top()-s.toggleElement.top()))),o.addContents(s),r+=s.fullBounds().height()+4)})}),this.msgs=[];for(var e=0;e<t.deletableMessageNames().length;e++){var l=new ReporterBlockMorph;l.setSpec(t.deletableMessageNames()[e]),l.setColor(new Color(217,77,17)),this.msgs.push(l)}this.msgs.forEach(function(t){(s=new ToggleMorph("checkbox",h,function(){h.msgs.includes(t)?h.msgs.splice(h.msgs.indexOf(t),1):h.msgs.push(t)},null,function(){return h.msgs.includes(t)},null,null,null,t.fullImage())).setPosition(new Point(i,r+(s.top()-s.toggleElement.top()))),o.addContents(s),r+=s.fullBounds().height()+4}),o.scrollX(4),o.scrollY(4),this.addBody(o),this.addButton("ok","OK"),this.addButton("cancel","Cancel"),this.setExtent(new Point(220,300)),this.fixLayout()},BlockExportDialogMorph.prototype.popUp=function(t){var e=t||this.target.world();e&&(BlockExportDialogMorph.uber.popUp.call(this,e),this.handle=new HandleMorph(this,200,220,this.corner,this.corner))},BlockExportDialogMorph.prototype.userMenu=function(){var t=new MenuMorph(this,"select");return t.addItem("all","selectAll"),t.addItem("none","selectNone"),t},BlockExportDialogMorph.prototype.selectAll=function(){this.body.contents.children.forEach(function(t){t.state||t.trigger()})},BlockExportDialogMorph.prototype.selectNone=function(){this.blocks=[],this.body.contents.children.forEach(function(t){t.refresh()})},BlockExportDialogMorph.prototype.exportBlocks=function(){for(var t=this.serializer.serialize(this.blocks),e=this.world().children[0],o=e.stage,i="",r=e.room.name||localize("Untitled"),n=0;n<this.msgs.length;n++)i+="<messageType>"+o.messageTypes.getMsgType(this.msgs[n].blockSpec).toXML(this.serializer)+"</messageType>";0<this.blocks.length||0<this.msgs.length?(t='<blocks app="'+this.serializer.app+'" version="'+this.serializer.version+'">'+t+i+"</blocks>",e.saveXMLAs(t,r+" "+localize("blocks"))):(new DialogBoxMorph).inform("Export blocks / message types","no blocks or message types were selected",this.world())},BlockExportDialogMorph.prototype.fixLayout=BlockEditorMorph.prototype.fixLayout,BlockImportDialogMorph.prototype=new DialogBoxMorph,BlockImportDialogMorph.prototype.constructor=BlockImportDialogMorph,BlockImportDialogMorph.uber=DialogBoxMorph.prototype,BlockImportDialogMorph.prototype.key="blockImport",BlockImportDialogMorph.prototype.init=function(t,e,o){var i=this;this.blocks=t.slice(0),this.handle=null,BlockExportDialogMorph.uber.init.call(this,e,function(){i.importBlocks(o)},null),this.labelString=localize("Import blocks")+(o?": ":"")+o||"",this.createLabel(),this.buildContents()},BlockImportDialogMorph.prototype.buildContents=BlockExportDialogMorph.prototype.buildContents,BlockImportDialogMorph.prototype.popUp=BlockExportDialogMorph.prototype.popUp,BlockImportDialogMorph.prototype.userMenu=BlockExportDialogMorph.prototype.userMenu,BlockImportDialogMorph.prototype.selectAll=BlockExportDialogMorph.prototype.selectAll,BlockImportDialogMorph.prototype.selectNone=BlockExportDialogMorph.prototype.selectNone,BlockImportDialogMorph.prototype.importBlocks=function(t){var e=this.target.parentThatIsA(IDE_Morph);e&&(0<this.blocks.length?e.importCustomBlocks(this.blocks):(new DialogBoxMorph).inform("Import blocks","no blocks were selected",this.world()))},BlockImportDialogMorph.prototype.fixLayout=BlockEditorMorph.prototype.fixLayout,BlockRemovalDialogMorph.prototype=new DialogBoxMorph,BlockRemovalDialogMorph.prototype.constructor=BlockImportDialogMorph,BlockRemovalDialogMorph.uber=DialogBoxMorph.prototype,BlockRemovalDialogMorph.prototype.key="blockRemove",BlockRemovalDialogMorph.prototype.init=function(t,e){var o=this;this.blocks=t.slice(0),this.handle=null,BlockExportDialogMorph.uber.init.call(this,e,function(){o.removeBlocks()},null),this.labelString=localize("Remove unused blocks")+(name?": ":"")+name||"",this.createLabel(),this.buildContents()},BlockRemovalDialogMorph.prototype.buildContents=BlockExportDialogMorph.prototype.buildContents,BlockRemovalDialogMorph.prototype.popUp=BlockExportDialogMorph.prototype.popUp,BlockRemovalDialogMorph.prototype.userMenu=BlockExportDialogMorph.prototype.userMenu,BlockRemovalDialogMorph.prototype.selectAll=BlockExportDialogMorph.prototype.selectAll,BlockRemovalDialogMorph.prototype.selectNone=BlockExportDialogMorph.prototype.selectNone,BlockRemovalDialogMorph.prototype.removeBlocks=function(){var t=this.target.parentThatIsA(IDE_Morph);t&&(0<this.blocks.length?(SnapActions.deleteCustomBlocks(this.blocks),t.flushPaletteCache(),t.refreshPalette(),t.showMessage(this.blocks.length+" "+localize("unused block(s) removed"),2)):(new DialogBoxMorph).inform("Remove unused blocks","no blocks were selected",this.world()))},BlockRemovalDialogMorph.prototype.fixLayout=BlockEditorMorph.prototype.fixLayout,modules.tables="2016-May-02",Table.prototype.demo=function(t){this.fillWithTestData(),new TableDialogMorph(this).popUp(t)},Table.prototype.changed=function(){this.lastChanged=Date.now()},Table.prototype.get=function(t,e){return t?e?t>this.colCount||e>this.rowCount?null:(this.contents[e-1]||[])[t-1]:this.colName(t):e?this.rowName(e):[this.rowCount]},Table.prototype.row=function(t){return this.contents[t-1]},Table.prototype.col=function(t){var e,o=[],i=t-1;for(e=0;e<this.rowCount;e+=1)o.push(this.contents[e][i]);return o},Table.prototype.colName=function(t){if(t>this.colCount)return null;var e=this.colNames[t-1];return void 0!==e?e:String.fromCharCode(64+(t%26||26)).repeat(Math.floor((t-1)/26)+1)},Table.prototype.rowName=function(t){return t>this.rowCount?null:this.rowNames[t-1]||t},Table.prototype.rows=function(){return this.rowCount},Table.prototype.cols=function(){return this.colCount},Table.prototype.columnNames=function(){return this.colNames},Table.prototype.set=function(t,e,o){this.contents[o-1][e-1]=t,this.changed()},Table.prototype.setRows=function(t,e,o){this.contents=t,e&&(this.colNames=e),o&&(this.rowNames=o),this.changed()},Table.prototype.setCols=function(t,e,o){var i,r;for(r=0;r<this.colCount;r+=1)for(i=0;i<this.rowCount;i+=1)this.contents[i][r]=t[r][i];e&&(this.colNames=e),o&&(this.rowNames=o),this.changed()},Table.prototype.setColNames=function(t){this.colNames=t||[],this.changed()},Table.prototype.setRowNames=function(t){this.rowNames=t||[],this.changed()},Table.prototype.setColName=function(t,e){this.colNames[t+1]=e,this.changed()},Table.prototype.setRowName=function(t,e){this.rowNames[t+1]=e,this.changed()},Table.prototype.addRow=function(t,e){this.contents[this.rowCount]=t||new Array(this.rowCount),this.rowNames[this.rowCount]=e,this.rowCount+=1,this.changed()},Table.prototype.addCol=function(t,e){var o;if(t)for(o=0;o<this.col;o+=1)this.contents[o][this.colCount]=t[o];this.colNames[this.colCount]=e,this.colCount+=1,this.changed()},Table.prototype.toList=function(){return new List(this.contents.map(function(t){return new List(t)}))},Table.prototype.fillWithTestData=function(){var t,e;for(t=1;t<=this.colCount;t+=1)for(e=1;e<=this.rowCount;e+=1)this.set(this.colName(t)+this.rowName(e),t,e)},TableCellMorph.prototype=new Morph,TableCellMorph.prototype.constructor=TableCellMorph,TableCellMorph.uber=Morph.prototype,TableCellMorph.prototype.listSymbol=ArgMorph.prototype.listIcon(),TableCellMorph.prototype.init=function(t,e,o){this.data=t,this.isLabel=o||!1,TableCellMorph.uber.init.call(this,!0),this.noticesTransparentClick=!0,e&&this.silentSetExtent(e),this.drawNew()},TableCellMorph.prototype.setData=function(t,e){this.data=t,e&&!e.eq(this.extent())?(this.silentSetExtent(e),this.drawNew()):this.drawData()},TableCellMorph.prototype.getData=function(){return this.data instanceof Array?this.data[0]:this.data},TableCellMorph.prototype.drawNew=function(){this.image=newCanvas(this.extent()),this.drawData()},TableCellMorph.prototype.drawData=function(t,e){var o,i,r,n,s=t||this.dataRepresentation(this.data),a=this.image.getContext("2d"),h=SyntaxElementMorph.prototype.fontSize,l=TableMorph.prototype.highContrast?"rgb(220, 220, 220)":"transparent",p=(this.isLabel?this.data instanceof Array?"italic":"":this.shouldBeList()?"bold":"")+" "+h+"px Helvetica, Arial, sans-serif",c=e||(this.isLabel?l:this.shouldBeList()?"rgb(217, 77, 17)":this.isOvershooting()?"white":isNil(this.data)?l:"white"),u=!this.isLabel&&this.shouldBeList()?"white":"black",d=this.width(),g=this.height();a.clearRect(0,0,d,g),a.fillStyle=c,this.shouldBeList()?(BoxMorph.prototype.outlinePath.call(this,a,SyntaxElementMorph.prototype.corner+1,0),a.fill()):this.isOvershooting()?(this.raggedBoxPath(a),a.fill()):a.fillRect(0,0,d,g),s&&(s instanceof HTMLCanvasElement?(r=Math.max((d-s.width)/2,0),n=Math.max((g-s.height)/2,0),a.shadowOffsetX=4,a.shadowOffsetY=4,a.shadowBlur=4,a.shadowColor="lightgray",a.drawImage(s,r,n)):(a.font=p,a.textAlign="left",a.textBaseline="bottom",o=a.measureText(s).width,i=fontHeight(h),a.fillStyle=u,r=Math.max((d-o)/2,0),n=Math.max((g-i)/2,0),a.fillText(s,r,i+n)))},TableCellMorph.prototype.dataRepresentation=function(t){return t instanceof Morph?isSnapObject(t)?t.thumbnail(new Point(40,40)):t.fullImageClassic():isString(t)?100<t.length?t.slice(0,100)+"...":t:"number"==typeof t?t.toString():"boolean"==typeof t?SpriteMorph.prototype.booleanMorph.call(null,t).fullImage():t instanceof Array?this.dataRepresentation(t[0]):t instanceof Variable?this.dataRepresentation(t.value):t instanceof HTMLCanvasElement?t:t instanceof Context?t.image():t instanceof Costume?t.thumbnail(new Point(40,40)):t instanceof List?this.listSymbol:t?t.toString():0===t?"0":null},TableCellMorph.prototype.raggedBoxPath=function(t){var e=this.width(),o=this.height(),i=.75*e,r=o/6,n=0;for(t.beginPath(),t.moveTo(0,0),t.lineTo(e,0),n=0;n<o;n+=2*r)t.lineTo(i,n+r),t.lineTo(e,n+2*r);t.lineTo(e,o),t.lineTo(0,o),t.closePath()},TableCellMorph.prototype.shouldBeList=function(){return this.data instanceof Array},TableCellMorph.prototype.isOvershooting=function(){return this.data instanceof Variable},TableCellMorph.prototype.mouseDoubleClick=function(t){this.data instanceof Table||this.data instanceof List?new TableDialogMorph(this.data).popUp(this.world()):this.data instanceof Array&&this.data[0]instanceof List?new TableDialogMorph(this.data[0]).popUp(this.world()):this.escalateEvent("mouseDoubleClick",t)},TableCellMorph.prototype.mouseEnter=function(){var t,e,o;this.isLabel&&(e=(t=this.parentThatIsA(TableMorph)).world().hand.left()-t.left(),0<(o=t.columnAt(e))&&(this.drawData(o,"rgb(220, 220, 250)"),this.changed()))},TableCellMorph.prototype.mouseLeave=function(){this.isLabel&&(this.drawData(),this.changed())},TableMorph.prototype=new FrameMorph,TableMorph.prototype.constructor=TableMorph,TableMorph.uber=FrameMorph.prototype,TableMorph.prototype.highContrast=!1,TableMorph.prototype.init=function(t,e,o,i,r,n,s,a,h,l){this.table=t,this.scrollBarSize=e||MorphicPreferences.scrollBarSize,this.startRow=i||1,this.startCol=r||1,this.textHeight=Math.ceil(1.3*fontHeight(SyntaxElementMorph.prototype.fontSize)),this.rowHeight=a||this.textHeight,this.colWidths=s||[],this.globalColWidth=n||Math.ceil(3.5*this.textHeight),this.colLabelHeight=h||this.textHeight,this.padding=l||SyntaxElementMorph.prototype.scale,this.tableVersion=this.table.lastChanged,this.hBar=null,this.vBar=null,this.rowLabelWidth=0,this.columns=[],this.rows=0,this.maxStartRow=null,this.maxStartCol=null,this.dragAnchor=null,this.resizeAnchor=null,this.resizeCol=null,this.resizeRow=null,this.wantsUpdate=!1,Morph.prototype.init.call(this,!0),o&&this.silentSetExtent(o),this.initScrollBars(),this.drawNew()},TableMorph.prototype.initScrollBars=function(){var e=this;this.hBar=new SliderMorph(1,null,null,null,"horizontal"),this.hBar.setHeight(this.scrollBarSize),this.hBar.action=function(t){e.showData(t,null,!0)},this.hBar.isDraggable=!1,this.add(this.hBar),this.vBar=new SliderMorph(1,null,null,null,"vertical"),this.vBar.setWidth(this.scrollBarSize),this.vBar.action=function(t){e.showData(null,t,!0)},this.vBar.isDraggable=!1,this.add(this.vBar)},TableMorph.prototype.updateScrollBars=function(){1===this.maxStartCol?this.hBar.hide():(this.hBar.show(),this.hBar.stop=this.maxStartCol,this.hBar.value=this.startCol,this.hBar.size=Math.max(this.hBar.rangeSize()*this.columns.length/this.table.cols(),this.hBar.rangeSize()/10),this.hBar.drawNew()),this.vBar.stop=this.maxStartRow,this.vBar.value=this.startRow,1===this.maxStartRow?this.vBar.hide():(this.vBar.show(),this.vBar.size=Math.max(this.vBar.rangeSize()*this.rows/this.table.rows(),this.vBar.rangeSize()/10),this.vBar.drawNew())},TableMorph.prototype.drawNew=function(){var t,e,o;if(this.image=newCanvas(this.extent()),(t=this.image.getContext("2d")).fillStyle="rgb(220, 220, 220)",BoxMorph.prototype.outlinePath.call(this,t,SyntaxElementMorph.prototype.corner+1,0),t.fill(),this.rowLabelWidth=this.rowLabelsWidth(),this.columns=this.columnsLayout(),this.rows=this.visibleRows(),this.highContrast&&1<this.table.cols()){for(e=this.padding,o=this.startCol;o<=this.table.cols();o+=1)e+=this.colWidth(o)+this.padding;t.fillStyle="darkGray",t.fillRect(this.padding+this.rowLabelWidth,this.padding+this.colLabelHeight,e,(this.rowHeight+this.padding)*(this.table.rows()+1-this.startRow)+this.padding)}this.buildCells(),this.hBar.setWidth(this.width()-this.vBar.width()),this.hBar.setLeft(this.left()),this.hBar.setBottom(this.bottom()),this.vBar.setHeight(this.height()-this.hBar.height()),this.vBar.setRight(this.right()),this.vBar.setTop(this.top())},TableMorph.prototype.buildCells=function(){var t,e,o,i=this.position();for(this.children=[],o=0;o<=this.columns.length;o+=1)for(e=0;e<=this.rows;e+=1)(t=new TableCellMorph(this.table.get(o?o+this.startCol-1:o,e?e+this.startRow-1:e),new Point(o?this.colWidth(o+this.startCol-1):this.rowLabelWidth,e?this.rowHeight:this.colLabelHeight),!(e&&o),!1)).setPosition(new Point(o?this.columns[o-1]:this.padding,e?2*this.padding+this.colLabelHeight+(e-1)*(this.rowHeight+this.padding):this.padding).add(i)),this.add(t),isSnapObject(t.getData())&&(this.wantsUpdate=!0);this.add(this.hBar),this.add(this.vBar),this.updateScrollBars(),this.changed()},TableMorph.prototype.drawData=function(t){var e,o,i,r=0;for(i=0;i<=this.columns.length;i+=1)for(o=0;o<=this.rows;o+=1)e=this.children[r],r+=1,e.setData(this.table.get(i?i+this.startCol-1:i,o?o+this.startRow-1:o)),isSnapObject(e.getData())&&(this.wantsUpdate=!0);t||this.updateScrollBars(),this.changed()},TableMorph.prototype.scroll=function(t,e){this.showData(Math.min(this.maxStartCol,Math.max(1,this.startCol+Math.round(t))),Math.min(this.maxStartRow,Math.max(1,this.startRow+Math.round(e)))),this.updateScrollBars()},TableMorph.prototype.showData=function(t,e,o){var i=t||this.startCol,r=e||this.startRow;if(i===this.startCol){if(r===this.startRow)return;this.startRow=r,this.rows=this.visibleRows(),this.drawData(o)}else this.startCol=i,this.startRow=r,this.rows=this.visibleRows(),this.colWidths.length?(this.columns=this.columnsLayout(),this.buildCells()):this.drawData(o)},TableMorph.prototype.step=function(){this.dragAnchor?this.shiftCells(this.world().hand.position()):this.resizeAnchor&&this.resizeCells(this.world().hand.position()),this.update()},TableMorph.prototype.update=function(){var t,e,o=this.table instanceof List?this.table.version(this.startRow,this.rows):this.table.lastChanged;(this.tableVersion!==o||this.wantsUpdate)&&(this.wantsUpdate=!1,this.table instanceof List?(t=this.columns.length,e=this.rows,this.rowLabelWidth=this.rowLabelsWidth(),this.columns=this.columnsLayout(),this.rows=this.visibleRows(),this.columns.length!==t||this.rows!==e?this.buildCells():this.drawData()):this.drawData(),this.tableVersion=o)},TableMorph.prototype.rowLabelsWidth=function(){var e=newCanvas().getContext("2d");return e.font="italic "+SyntaxElementMorph.prototype.fontSize+"px Helvetica, Arial, sans-serif",Math.max(0,Math.max.apply(null,this.table.columnNames().map(function(t){return t?e.measureText(t).width:0})))||e.measureText(this.table.rows().toString()).width+6*SyntaxElementMorph.prototype.scale},TableMorph.prototype.columnsLayout=function(){var t,e,o=[],i=2*this.padding+this.rowLabelWidth;for(t=this.table.cols(),e=i;e<this.width()&&0<t;)e+=this.colWidth(t),t-=1;for(0===t&&e<this.width()?this.maxStartCol=1:this.maxStartCol=Math.min(t+2,this.table.cols()),this.startCol=Math.min(this.startCol,this.maxStartCol),t=this.startCol;i<this.width()&&t<this.table.cols()+this.startCol;)e=this.colWidth(t),o.push(i),i+=e,i+=this.padding,t+=1;return o},TableMorph.prototype.colWidth=function(t){return this.colWidths[t-1]||this.globalColWidth},TableMorph.prototype.visibleRows=function(){var t,e=this.height()-this.colLabelHeight-this.padding;return e<0?0:(t=Math.ceil(e/(this.rowHeight+this.padding)),this.maxStartRow=Math.max(1,this.table.rows()-t+2),this.startRow=Math.min(this.startRow,this.maxStartRow),Math.min(this.table.rows(),t))},TableMorph.prototype.globalExtent=function(){var t,e=this.rowLabelsWidth()+2,o=this.table.cols();for(t=0;t<o;t+=1)e+=this.colWidth(t+1),e+=this.padding;return 1===o&&(e+=this.scrollBarSize,e+=2*this.padding),new Point(e+this.padding,this.colLabelHeight+2*this.padding+(this.rowHeight+this.padding)*this.table.rows())},TableMorph.prototype.mouseScroll=function(t,e){this.scroll(-+e*MorphicPreferences.mouseScrollAmount/4,-+t*MorphicPreferences.mouseScrollAmount)},TableMorph.prototype.mouseDownLeft=function(t){var e=t.subtract(this.position());e.x<=this.rowLabelWidth||e.y<=this.colLabelHeight?(16===this.world().currentKey?this.resizeCol=0:this.resizeCol=this.columnAt(e.x),this.resizeRow=e.y>this.colLabelHeight,this.resizeAnchor=t):(this.resizeRow=null,this.dragAnchor=t)},TableMorph.prototype.mouseClickLeft=function(t){this.dragAnchor=null,this.resizeAnchor=null,this.resizeRow=null},TableMorph.prototype.mouseLeaveDragging=function(t){this.dragAnchor=null,this.resizeAnchor=null,this.resizeRow=null},TableMorph.prototype.mouseDoubleClick=function(t){this.parentThatIsA(TableDialogMorph)?this.escalateEvent("mouseDoubleClick",t):new TableDialogMorph(this.table,this.globalColWidth,this.colWidths,this.rowHeight).popUp(this.world())},TableMorph.prototype.shiftCells=function(t){var e=this.dragAnchor.subtract(t),o=Math.round(e.x/this.globalColWidth),i=Math.round(e.y/this.rowHeight);(o||i)&&(this.scroll(o,i),this.dragAnchor=t)},TableMorph.prototype.resizeCells=function(t){var e,o=t.subtract(this.resizeAnchor);if(this.resizeCol)this.colWidths[this.resizeCol-1]=Math.max(16,(this.colWidths[this.resizeCol-1]||this.globalColWidth)+o.x);else if(this.resizeRow)this.rowHeight=Math.max(16,this.rowHeight+o.y);else for(this.globalColWidth=Math.max(16,this.globalColWidth+o.x),e=0;e<this.colWidths.length;e+=1)this.colWidths[e]&&(this.colWidths[e]=Math.max(16,this.colWidths[e]+o.x));this.highContrast?this.drawNew():(this.rowLabelWidth=this.rowLabelsWidth(),this.columns=this.columnsLayout(),this.rows=this.visibleRows(),this.buildCells()),this.resizeAnchor=t},TableMorph.prototype.columnAt=function(t){var e=0;if(t<this.columns[0])return 0;for(;t>this.columns[e];)e+=1;return e+this.startCol-1},TableMorph.prototype.userMenu=function(){var t=new MenuMorph(this);return this.parentThatIsA(TableDialogMorph)?(this.colWidths.length&&(t.addItem("reset columns","resetColumns"),t.addLine()),t.addItem("open in another dialog...","openInDialog")):(this.colWidths.length&&t.addItem("reset columns","resetColumns"),t.addItem("list view...","showListView"),t.addLine(),t.addItem("open in dialog...","openInDialog")),t},TableMorph.prototype.resetColumns=function(){this.colWidths=[],this.highContrast?this.drawNew():(this.rowLabelWidth=this.rowLabelsWidth(),this.columns=this.columnsLayout(),this.rows=this.visibleRows(),this.buildCells())},TableMorph.prototype.openInDialog=function(){new TableDialogMorph(this.table,this.globalColWidth,this.colWidths,this.rowHeight).popUp(this.world())},TableMorph.prototype.showListView=function(){var t=this.parentThatIsAnyOf([SpriteBubbleMorph,SpeechBubbleMorph,CellMorph]);t&&(t instanceof SpriteBubbleMorph?(t.changed(),t.drawNew(!0)):t instanceof SpeechBubbleMorph?(t.contents=new ListWatcherMorph(this.table),t.contents.step=t.contents.update,t.contents.expand(this.extent()),t.drawNew(!0)):(t.drawNew(!0),t.contentsMorph.expand(this.extent())),t.fixLayout())},TableMorph.prototype.show=function(){TableMorph.uber.show.call(this),this.updateScrollBars()},TableFrameMorph.prototype=new Morph,TableFrameMorph.prototype.constructor=TableFrameMorph,TableFrameMorph.uber=Morph.prototype,TableFrameMorph.prototype.init=function(t,e){this.tableMorph=t,this.handle=null,TableFrameMorph.uber.init.call(this,!0),this.color="transparent",this.noticesTransparentClick=!1,this.bounds=this.tableMorph.bounds.copy(),this.add(this.tableMorph),e||(this.handle=new HandleMorph(this,80,25,null,null)),this.drawNew()},TableFrameMorph.prototype.fixLayout=function(){var t=this.extent();this.tableMorph.extent().eq(t)||(this.tableMorph.setExtent(this.extent()),this.parent&&this.parent.fixLayout&&this.parent.fixLayout())},TableFrameMorph.prototype.setExtent=function(t,e){TableFrameMorph.uber.setExtent.call(this,t,e),this.fixLayout()},TableFrameMorph.prototype.expand=function(t){var e=this.tableMorph.globalExtent();t&&(e=e.min(t)),this.setExtent(e),this.handle.setRight(this.right()),this.handle.setBottom(this.bottom())},TableDialogMorph.prototype=new DialogBoxMorph,TableDialogMorph.prototype.constructor=TableDialogMorph,TableDialogMorph.uber=DialogBoxMorph.prototype,TableDialogMorph.prototype.init=function(t,e,o,i){this.handle=null,this.data=t,this.tableView=null,TableDialogMorph.uber.init.call(this),this.labelString="Table view",this.createLabel(),this.buildContents(t,e,o,i)},TableDialogMorph.prototype.buildContents=function(t,e,o,i){this.tableView=new TableMorph(t,null,null,null,null,e,o,i,null,null),this.addBody(new TableFrameMorph(this.tableView,!0)),this.addButton("ok","OK")},TableDialogMorph.prototype.setInitialDimensions=function(){var t=this.world().extent().subtract(new Point(this.padding,this.padding)),e=fontHeight(this.titleFontSize)+3*this.titlePadding,o=this.buttons.height();this.setExtent(this.tableView.globalExtent().add(new Point(2*this.padding,2*this.padding+e+o)).min(t).max(new Point(100,100))),this.setCenter(this.world().center())},TableDialogMorph.prototype.popUp=function(t){t&&(TableDialogMorph.uber.popUp.call(this,t),this.setInitialDimensions(),this.handle=new HandleMorph(this,100,100,this.corner,this.corner))},TableDialogMorph.prototype.fixLayout=BlockEditorMorph.prototype.fixLayout,modules.xml="2015-June-25",ReadStream.prototype.nonSpace=/\S|$/g,ReadStream.prototype.nonWord=/[\s\>\/\=]|$/g,ReadStream.prototype.next=function(t){var e,o;return void 0===t?(e=this.contents[this.index],this.index+=1,e):(o=this.index,this.index+=t,this.contents.slice(o,this.index))},ReadStream.prototype.peek=function(){return this.contents[this.index]},ReadStream.prototype.skip=function(t){this.index+=t||1},ReadStream.prototype.atEnd=function(){return this.index>this.contents.length-1},ReadStream.prototype.upTo=function(t){var e=this.contents.indexOf(t,this.index);return-1===e?"":this.contents.slice(this.index,this.index=e)},ReadStream.prototype.peekUpTo=function(t){var e=this.contents.indexOf(t,this.index);return-1===e?"":this.contents.slice(this.index,e)},ReadStream.prototype.skipSpace=function(){this.nonSpace.lastIndex=this.index;var t=this.nonSpace.exec(this.contents);t&&(this.index=t.index)},ReadStream.prototype.word=function(){this.nonWord.lastIndex=this.index;var t=this.nonWord.exec(this.contents);return t?this.contents.slice(this.index,this.index=t.index):""},XML_Element.prototype=Object.create(Node.prototype),XML_Element.prototype.constructor=XML_Element,XML_Element.uber=Node.prototype,XML_Element.prototype.indentation="  ",XML_Element.prototype.init=function(t,e,o){this.tag=t||"unnamed",this.attributes={},this.contents=e||"",XML_Element.uber.init.call(this),o&&o.addChild(this)},XML_Element.prototype.require=function(t){var e=this.childNamed(t);if(!e)throw new Error("Missing required element <"+t+">!");return e},XML_Element.prototype.childNamed=function(e){return detect(this.children,function(t){return t.tag===e})},XML_Element.prototype.childrenNamed=function(e){return this.children.filter(function(t){return t.tag===e})},XML_Element.prototype.parentNamed=function(t){return this.tag===t?this:this.parent?this.parent.parentNamed(t):null},XML_Element.prototype.toString=function(e,t){var o,i,r="",n="",s=t||0;if(e){for(i=0;i<s;i+=1)n+=this.indentation;r+=n}if("CDATA"===this.tag)return r+="<![CDATA["+this.contents+"]]>";for(o in r+="<"+this.tag,this.attributes)Object.prototype.hasOwnProperty.call(this.attributes,o)&&this.attributes[o]&&(r+=" "+o+'="'+this.escape(this.attributes[o])+'"');return this.contents.length||this.children.length?(r+=">",r+=this.escape(this.contents),this.children.forEach(function(t){e&&(r+="\n"),r+=t.toString(e,s+1)}),e&&this.children.length&&(r+="\n"+n),r+="</"+this.tag+">"):r+="/>",r},XML_Element.prototype.escape=function(t,e){var o,i,r=isNil(t)?"":t.toString(),n="";for(o=0;o<r.length;o+=1)switch(i=r[o]){case"'":n+="&apos;";break;case'"':n+=e?i:"&quot;";break;case"<":n+="&lt;";break;case">":n+="&gt;";break;case"&":n+="&amp;";break;case"\n":n+="&#xD;";break;case"~":n+="&#126;";break;default:n+=i}return n},XML_Element.prototype.unescape=function(t){return t.replace(/&(amp|apos|quot|lt|gt|#xD|#126);/g,function(t,e){switch(e){case"amp":return"&";case"apos":return"'";case"quot":return'"';case"lt":return"<";case"gt":return">";case"#xD":return"\n";case"#126":return"~";default:console.warn("unreachable")}})},XML_Element.prototype.parseString=function(t){var e=new ReadStream(t);e.upTo("<"),e.skip(),this.parseStream(e)},XML_Element.prototype.parseStream=function(t){var e,o,i;if(this.tag=t.word(),0===this.tag.indexOf("![CDATA["))return this.contents=this.tag.slice(8)+t.upTo("]]>"),this.tag="CDATA",void t.skip(3);for(t.skipSpace(),i=t.peek();">"!==i&&"/"!==i;){if(e=t.word(),t.skipSpace(),"="!==t.next())throw new Error('Expected "=" after attribute name');if(t.skipSpace(),'"'!==(i=t.next())&&"'"!==i)throw new Error("Expected single- or double-quoted attribute value");o=t.upTo(i),t.skip(1),t.skipSpace(),this.attributes[e]=this.unescape(o),i=t.peek()}if("/"!==i){if(">"!==t.next())throw new Error('Expected ">" after tag name and attributes');for(;!t.atEnd();)if("<"===(i=t.next())){if("/"===t.peek()){if(t.skip(),t.word()!==this.tag)throw new Error("Expected to close "+this.tag);return t.upTo(">"),t.skip(),void(this.contents=this.unescape(this.contents))}new XML_Element(null,null,this).parseStream(t)}else this.contents+=i}else if(t.skip(),">"!==t.next())throw new Error('Expected ">" after "/" in empty tag')},modules.store="2016-December-27",XML_Serializer.prototype.idProperty="serializationID",XML_Serializer.prototype.mediaIdProperty="serializationMediaID",XML_Serializer.prototype.mediaDetectionProperty="isMedia",XML_Serializer.prototype.version=1,XML_Serializer.prototype.serialize=function(t){var e;return this.flush(),this.flushMedia(),e=this.store(t),this.flush(),e},XML_Serializer.prototype.store=function(t,e){return isNil(t)||!t.toXML?"":this.isCollectingMedia&&t[this.mediaDetectionProperty]?(this.addMedia(t,e),this.format('<ref mediaID="@"></ref>',t[this.mediaIdProperty])):t[this.idProperty]?this.format('<ref id="@"></ref>',t[this.idProperty]):(this.add(t),this.isSavingPortable&&t.toPortableXML?t.toPortableXML(this,e).replace("~",this.format('id="@"',t[this.idProperty])):t.toXML(this,e).replace("~",this.format('id="@"',t[this.idProperty])))};XML_Serializer.prototype.mediaXML=function(){var o="<media>",i=this;return this.media.forEach(function(t){var e=t.toXML(i).replace("~",i.format('mediaID="@"',t[i.mediaIdProperty]));o+=e}),o+"</media>"},XML_Serializer.prototype.undoQueueXML=function(t){var e=SnapUndo.eventHistory[t]||[];return this.format('<undo-queue id="@" undo-count="@">%</undo-queue>',t,SnapUndo.undoCount[t],this.undoEventsXML(e))},XML_Serializer.prototype.undoEventsXML=function(t,e){for(var o,i,r,n=[],s=t.length;s--;){i=[];for(var a=(o=t[s]).args.length;a--;)i.unshift(this.getArgumentXML("arg",o.args[a]));i=i.join(""),r=e?this.format('<event id="@" type="@" replayType="@" time="@" user="@" username="@" isUserAction="@">%</event>',o.id,o.type,o.replayType||0,o.time,o.user,o.username||"",o.isUserAction||!1,i):this.format('<event id="@"/>',o.id),n.unshift(r)}return n.join("")},XML_Serializer.prototype.getArgumentXML=function(t,o){var i=this,e=o;o instanceof Object?e=Object.keys(o).map(function(e){return o[e]instanceof Array?o[e].map(function(t){return i.getArgumentXML("_"+e,t)}).join(""):/^[^a-zA-Z].*/.test(e)?i.getArgumentXML("_"+e,o[e]):i.getArgumentXML(e,o[e])}).join(""):"string"==typeof o&&-1<o.indexOf("<")&&(e=o.replace(/</g,"&lt;"));return["<",t,">",e,"</",t,">"].join("")},XML_Serializer.prototype.loadEventArg=function(t){var e,o,i,r,n=-1;if(t.children.length){if("CDATA"===t.children[0].tag)return t.children[0].contents.replace(/&ncdata;]>/g,"]]>");e={},i=!0;for(var s=t.children.length;s--;)r="_"===(o=t.children[s]).tag[0]?o.tag.slice(1):o.tag,isNaN(+r)&&(i=!1),e[r]instanceof Array?e[r].unshift(this.loadEventArg(o)):e[r]?e[r]=[this.loadEventArg(o),e[r]]:e[r]=this.loadEventArg(o),i&&(n=Math.max(n,+r));return i&&(e.length=n+1,e=Array.prototype.slice.call(e)),e}return t.contents},XML_Serializer.prototype.historyXML=function(t){var e=this,o=t&&t+"/";return SnapUndo.allQueueIds().filter(function(t){return o?0===t.indexOf(o):-1===t.indexOf("/")}).map(function(t){return e.undoQueueXML(t)}).join("")},XML_Serializer.prototype.replayHistory=function(){return this.undoEventsXML(SnapUndo.allEvents,!0)},XML_Serializer.prototype.add=function(t){return t[this.idProperty]?-1:(this.contents.push(t),t[this.idProperty]=this.contents.length,this.contents.length)},XML_Serializer.prototype.addMedia=function(t,e){return t[this.mediaIdProperty]?-1:(this.media.push(t),t[this.mediaIdProperty]=e?e+"_"+t.name:this.media.length,this.media.length)},XML_Serializer.prototype.at=function(t){return this.contents[t-1]},XML_Serializer.prototype.flush=function(){var e=this;this.contents.forEach(function(t){delete t[e.idProperty]}),this.contents=[],this.dependencies=null},XML_Serializer.prototype.flushMedia=function(){var e=this;this.media instanceof Array&&this.media.forEach(function(t){delete t[e.mediaIdProperty]}),this.media=[]},XML_Serializer.prototype.escape=XML_Element.prototype.escape,XML_Serializer.prototype.unescape=XML_Element.prototype.unescape,XML_Serializer.prototype.format=function(t){var o,i=this,r=-1,n=arguments;return t.replace(/[@$%]([\d]+)?/g,function(t,e){return e=parseInt(e,10),o=isNaN(e)?n[(r+=1)+1]:n[e+1],"@"===t?i.escape(o):"$"===t?i.escape(o,!0):o})},XML_Serializer.prototype.load=function(t){throw nop(t),new Error("loading should be implemented in heir of XML_Serializer")},XML_Serializer.prototype.parse=function(t){var e=new XML_Element;return e.parseString(t),e},SnapSerializer.prototype=new XML_Serializer,SnapSerializer.prototype.constructor=SnapSerializer,SnapSerializer.uber=XML_Serializer.prototype,SnapSerializer.prototype.app="Snap! 4.0, http://snap.berkeley.edu",SnapSerializer.prototype.thumbnailSize=new Point(640,480),SnapSerializer.prototype.isSavingHistory=!1,SnapSerializer.prototype.watcherLabels={reportRPCError:"error",xPosition:"x position",yPosition:"y position",direction:"direction",getScale:"size",getTempo:"tempo",getLastAnswer:"answer",getLastMessage:"message",getTimer:"timer",getCostumeIdx:"costume #",reportMouseX:"mouse x",reportMouseY:"mouse y",reportThreadCount:"processes"},SnapSerializer.prototype.init=function(){this.project={},this.objects={},this.mediaDict={},this.isSavingCustomBlockOwners=!0},XML_Serializer.prototype.mediaXML=function(t){var o='<media name="'+(t||"untitled")+'" app="'+this.app+'" version="'+this.version+'">',i=this;return this.media.forEach(function(t){var e=t.toXML(i).replace("~",i.format('mediaID="@"',t[i.mediaIdProperty]));o+=e}),o+"</media>"},SnapSerializer.prototype.load=function(t,e){return this.loadProjectModel(this.parse(t),e)},SnapSerializer.prototype.getPortableXML=function(t){var e,o=this.isSavingPortable,i=this.isSavingHistory;return this.isSavingPortable=!0,this.isSavingHistory=!1,t.getPortableDependencies&&(this.dependencies=t.getPortableDependencies()),e=this.store(t),this.isSavingPortable=o,this.isSavingHistory=i,this.dependencies=null,e},SnapSerializer.prototype.loadProjectModel=function(t,e){var o,i=t.attributes.app,r=i?i.split(" ")[0]:null;return e&&r&&r!==this.app.split(" ")[0]&&"NetsBlox"!==r&&e.inform(r+" Project","This project has been created by a different app:\n\n"+r+"\n\nand may be incompatible or fail to load here."),o=this.rawLoadProjectModel(t),this.objects={},o},SnapSerializer.prototype.rawLoadProjectModel=function(t){var e,o,a=this,h={sprites:{},undo:{allEvents:[],eventHistory:{},undoCount:{}}};if(this.project=h,e={project:t},+t.attributes.version>this.version)throw"Project uses newer version of Serializer";if(this.objects={},h.name=e.project.attributes.name,!h.name){for(o=1;Object.prototype.hasOwnProperty.call(localStorage,"-snap-project-Untitled "+o);)o+=1;h.name="Untitled "+o}(e.notes=e.project.childNamed("notes"),e.notes&&(h.notes=e.notes.contents),e.globalVariables=e.project.childNamed("variables"),h.globalVariables=new VariableFrame,h.collabStartIndex=+(e.project.attributes.collabStartIndex||0),h.undo.allEvents=this.loadReplayHistory(t.childNamed("replay")),e.stage=e.project.require("stage"),StageMorph.prototype.frameRate=0,h.stage=new StageMorph(h.globalVariables),Object.prototype.hasOwnProperty.call(e.stage.attributes,"id")&&(this.objects[e.stage.attributes.id]=h.stage),e.stage.attributes.name&&(h.stage.name=e.stage.attributes.name),"true"===e.stage.attributes.scheduled&&(h.stage.fps=30,StageMorph.prototype.frameRate=30),e.pentrails=e.stage.childNamed("pentrails"),e.pentrails&&(h.pentrails=new Image,h.pentrails.onload=function(){h.stage.trailsCanvas&&(normalizeCanvas(h.stage.trailsCanvas),h.stage.trailsCanvas.getContext("2d").drawImage(h.pentrails,0,0),h.stage.changed())},h.pentrails.src=e.pentrails.contents),h.stage.setTempo(e.stage.attributes.tempo),StageMorph.prototype.dimensions=new Point(480,360),e.stage.attributes.width&&(StageMorph.prototype.dimensions.x=Math.max(+e.stage.attributes.width,480)),e.stage.attributes.height&&(StageMorph.prototype.dimensions.y=Math.max(+e.stage.attributes.height,180)),h.stage.id=e.stage.attributes.collabId||null,h.stage.setExtent(StageMorph.prototype.dimensions),SpriteMorph.prototype.useFlatLineEnds="flat"===e.stage.attributes.lines,h.stage.isThreadSafe="true"===e.stage.attributes.threadsafe,StageMorph.prototype.enableCodeMapping="true"===e.stage.attributes.codify,StageMorph.prototype.enableInheritance="true"===e.stage.attributes.inheritance,StageMorph.prototype.enableSublistIDs="true"===e.stage.attributes.sublistIDs,e.hiddenPrimitives=e.project.childNamed("hidden"),e.hiddenPrimitives&&e.hiddenPrimitives.contents.split(" ").forEach(function(t){t&&(StageMorph.prototype.hiddenPrimitives[t]=!0)}),e.codeHeaders=e.project.childNamed("headers"),e.codeHeaders&&e.codeHeaders.children.forEach(function(t){StageMorph.prototype.codeHeaders[t.tag]=t.contents}),e.codeMappings=e.project.childNamed("code"),e.codeMappings&&e.codeMappings.children.forEach(function(t){StageMorph.prototype.codeMappings[t.tag]=t.contents}),e.messageTypes=e.stage.childNamed("messageTypes"),e.messageTypes)&&e.messageTypes.children.forEach(this.loadMessageType.bind(this,h.stage));return e.globalBlocks=e.project.childNamed("blocks"),e.globalBlocks&&(this.loadCustomBlocks(h.stage,e.globalBlocks,!0),this.populateCustomBlocks(h.stage,e.globalBlocks,!0)),this.loadObject(h.stage,e.stage),this.loadHistory(t.childNamed("history")),e.sprites=e.stage.require("sprites"),h.sprites[h.stage.name]=h.stage,e.sprites.childrenNamed("sprite").forEach(function(t){a.loadValue(t)}),a.project.stage.children.forEach(function(t){var e,o;t.inheritanceInfo&&(e=a.project.sprites[t.inheritanceInfo.exemplar])&&t.setExemplar(e),t.nestingInfo&&((o=a.project.sprites[t.nestingInfo.anchor])&&o.attachPart(t),t.rotatesWithAnchor="true"===t.nestingInfo.synch)}),a.project.stage.children.forEach(function(t){delete t.inheritanceInfo,t.nestingInfo&&(t.nestingScale=+(t.nestingInfo.scale||t.scale),delete t.nestingInfo)}),e.globalVariables&&this.loadVariables(h.globalVariables,e.globalVariables),e.sprites.childrenNamed("watcher").forEach(function(t){var e,o,i,r,n,s;o=a.loadColor(t.attributes.color),i=Object.prototype.hasOwnProperty.call(t.attributes,"scope")?h.sprites[t.attributes.scope]:null,r=Object.prototype.hasOwnProperty.call(t.attributes,"hidden")&&"false"!==t.attributes.hidden,(e=Object.prototype.hasOwnProperty.call(t.attributes,"var")?new WatcherMorph(t.attributes.var,o,isNil(i)?h.globalVariables:i.variables,t.attributes.var,r):new WatcherMorph(localize(a.watcherLabels[t.attributes.s]),o,i,t.attributes.s,r)).setStyle(t.attributes.style||"normal"),"slider"===e.style&&(e.setSliderMin(t.attributes.min||"1",!0),e.setSliderMax(t.attributes.max||"100",!0)),e.setPosition(h.stage.topLeft().add(new Point(+t.attributes.x||0,+t.attributes.y||0))),h.stage.add(e),e.onNextStep=function(){this.currentValue=null},e.currentValue instanceof List&&((n=t.attributes.extX)&&e.cellMorph.contentsMorph.setWidth(+n),(s=t.attributes.extY)&&e.cellMorph.contentsMorph.setHeight(+s),e.cellMorph.contentsMorph.handle.drawNew())}),h},SnapSerializer.prototype.loadReplayHistory=function(t){for(var e,o=t?t.children:[],i=[],r=o.length;r--;)e=this.parseEvent(null,o[r],!0),i.unshift(e);return i},SnapSerializer.prototype.loadHistory=function(t){for(var e,o,i,r,n,s=t?t.children:[],a=this.project.undo,h=s.length;h--;){i=s[h].attributes.id,r=a.allEvents.length-1,a.undoCount[i]=+s[h].attributes["undo-count"]||0,a.eventHistory[i]=[];for(var l=(e=s[h].children).length;l--;){for(n=+e[l].attributes.id;0<=r&&a.allEvents[r].id!==n;)r--;0<=r?((o=a.allEvents[r]).owner=i,a.eventHistory[i].unshift(o)):console.error("Could not load historical event from replay:",e[l])}}},SnapSerializer.prototype.parseEvent=function(t,e){for(var o=[],i=e.children.length;i--;)o.unshift(this.loadEventArg(e.children[i]));return{id:+e.attributes.id,owner:t,type:e.attributes.type,replayType:+e.attributes.replayType,time:+e.attributes.time,user:e.attributes.user,username:e.attributes.username||void 0,isUserAction:"true"===e.attributes.isUserAction,args:o}},SnapSerializer.prototype.loadBlocks=function(t,e){var o,i=new StageMorph;if(this.project={stage:i,sprites:{},targetStage:e},+(o=this.parse(t)).attributes.version>this.version)throw"Module uses newer version of Serializer";return this.loadCustomBlocks(i,o,!0),this.populateCustomBlocks(i,o,!0),this.objects={},i.globalBlocks.forEach(function(t){t.receiver=null}),this.objects={},this.project={},this.mediaDict={},i.globalBlocks},SnapSerializer.prototype.loadSprites=function(t,o){var e,i,r=this;if((i=this.project={globalVariables:o.globalVariables,stage:o.stage,sprites:{}}).sprites[i.stage.name]=i.stage,+(e=this.parse(t)).attributes.version>this.version)throw"Module uses newer version of Serializer";return e.childrenNamed("sprite").forEach(function(t){var e=new SpriteMorph(i.globalVariables);t.attributes.id&&(r.objects[t.attributes.id]=e),t.attributes.name&&(e.name=o.newSpriteName(t.attributes.name),i.sprites[e.name]=e),t.attributes.color&&(e.color=r.loadColor(t.attributes.color)),t.attributes.pen&&(e.penPoint=t.attributes.pen),t.attributes.collabId&&(e.id=t.attributes.collabId),i.stage.add(e),o.sprites.add(e),e.scale=parseFloat(t.attributes.scale||"1"),e.rotationStyle=parseFloat(t.attributes.rotation||"1"),e.isDraggable="false"!==t.attributes.draggable,e.isVisible="true"!==t.attributes.hidden,e.heading=parseFloat(t.attributes.heading)||0,e.drawNew(),e.gotoXY(+t.attributes.x||0,+t.attributes.y||0),r.loadObject(e,t),SnapActions.loadOwner(e)}),i.stage.children.forEach(function(t){var e,o;t.inheritanceInfo&&(e=i.sprites[t.inheritanceInfo.exemplar])&&t.setExemplar(e),t.nestingInfo&&((o=i.sprites[t.nestingInfo.anchor])&&o.attachPart(t),t.rotatesWithAnchor="true"===t.nestingInfo.synch)}),i.stage.children.forEach(function(t){delete t.inheritanceInfo,t.nestingInfo&&(t.nestingScale=+(t.nestingInfo.scale||t.scale),delete t.nestingInfo)}),this.objects={},this.project={},this.mediaDict={},o.createCorral(),o.fixLayout(),i.stage.children},SnapSerializer.prototype.loadMedia=function(t){return this.loadMediaModel(this.parse(t))},SnapSerializer.prototype.loadMediaModel=function(t){var e=this,o=t;if(this.mediaDict={},+o.attributes.version>this.version)throw"Module uses newer version of Serializer";return o.children.forEach(function(t){e.loadValue(t)}),this.mediaDict},SnapSerializer.prototype.loadObject=function(t,e){var o=e.require("blocks");this.loadInheritanceInfo(t,e),this.loadNestingInfo(t,e),this.loadCostumes(t,e),this.loadSounds(t,e),this.loadCustomBlocks(t,o),this.populateCustomBlocks(t,o),this.loadVariables(t.variables,e.require("variables")),this.loadScripts(t.scripts,e.require("scripts"))},SnapSerializer.prototype.loadInheritanceInfo=function(t,e){var o=e.childNamed("inherit");o&&(t.inheritanceInfo=o.attributes)},SnapSerializer.prototype.loadNestingInfo=function(t,e){var o=e.childNamed("nest");o&&(t.nestingInfo=o.attributes)},SnapSerializer.prototype.loadCostumes=function(t,e){var o,i=e.childNamed("costumes");i&&(t.costumes=this.loadValue(i.require("list"))),Object.prototype.hasOwnProperty.call(e.attributes,"costume")&&(o=t.costumes.asArray()[e.attributes.costume-1])&&(o.loaded?t.wearCostume(o):o.loaded=function(){t.wearCostume(o),this.loaded=!0})},SnapSerializer.prototype.loadSounds=function(t,e){var o=e.childNamed("sounds");o&&(t.sounds=this.loadValue(o.require("list")))},SnapSerializer.prototype.loadVariables=function(i,t){var r=this;t.children.forEach(function(t){var e,o;"variable"===t.tag&&(o=t.children[0],(e=new Variable).isTransient="true"===t.attributes.transient,e.value=e.isTransient||!o?0:r.loadValue(o),i.vars[t.attributes.name]=e)})},SnapSerializer.prototype.loadCustomBlock=function(t,e){var o,i,r,n,s,a,h,l=new CustomBlockDefinition(t.attributes.s||"");return l.category=t.attributes.category||"other",l.type=t.attributes.type||"command",l.isGlobal=!0===e,l.id=t.attributes.collabId,h=l.parseSpec(l.spec).filter(function(t){return"%"===t.charAt(0)&&1<t.length}).map(function(t){return t.substr(1)}),l.names=h,(o=t.childNamed("inputs"))&&(a=-1,o.children.forEach(function(t){var e=t.childNamed("options");"input"===t.tag&&(a+=1,l.declarations[h[a]]=[t.attributes.type,t.contents,e?e.contents:void 0,"true"===t.attributes.readonly])})),(i=t.childNamed("variables"))&&(l.variableNames=this.loadValue(i.require("list")).asArray()),(r=t.childNamed("header"))&&(l.codeHeader=r.contents),(n=t.childNamed("code"))&&(l.codeMapping=n.contents),(s=t.childNamed("comment"))&&(l.comment=this.loadComment(s)),l},SnapSerializer.prototype.loadCustomBlocks=function(o,t,i){var r=this;t.children.forEach(function(t){var e;"block-definition"===t.tag&&((e=r.loadCustomBlock(t,i)).receiver=o,e.isGlobal?o.globalBlocks.push(e):o.customBlocks.push(e))})},SnapSerializer.prototype.populateCustomBlocks=function(n,t,s){var a=this;t.children.forEach(function(t,e){var o,i,r;"block-definition"===t.tag&&(o=s?n.globalBlocks[e]:n.customBlocks[e],(i=t.childNamed("script"))&&(o.body=new Context(null,i?a.loadScript(i):null,null,n),o.body.inputs=o.names.slice(0)),(r=t.childNamed("scripts"))&&(o.scripts=a.loadScriptsArray(r)),delete o.names)})},SnapSerializer.prototype.loadScripts=function(o,t){var i=this,r=SyntaxElementMorph.prototype.scale;o.cachedTexture=IDE_Morph.prototype.scriptsPaneTexture,t.children.forEach(function(t){var e;if("script"===t.tag){if(!(e=i.loadScript(t)))return;e.setPosition(new Point((+t.attributes.x||0)*r,(+t.attributes.y||0)*r).add(o.topLeft())),o.add(e),e.fixBlockColor(null,!0),e.allComments().forEach(function(t){t.align(e)})}else if("comment"===t.tag){if(!(e=i.loadComment(t)))return;e.setPosition(new Point((+t.attributes.x||0)*r,(+t.attributes.y||0)*r).add(o.topLeft())),o.add(e)}})},SnapSerializer.prototype.loadScriptsArray=function(t){var o=this,i=SyntaxElementMorph.prototype.scale,r=[];return t.children.forEach(function(t){var e;if("script"===t.tag){if(!(e=o.loadScript(t)))return;e.setPosition(new Point((+t.attributes.x||0)*i,(+t.attributes.y||0)*i)),r.push(e),e.fixBlockColor(null,!0)}else if("comment"===t.tag){if(!(e=o.loadComment(t)))return;e.setPosition(new Point((+t.attributes.x||0)*i,(+t.attributes.y||0)*i)),r.push(e)}}),r},SnapSerializer.prototype.loadScript=function(t){var e,o,i,r=this;return t.children.forEach(function(t){if(i=r.loadBlock(t)){if(o){if(!(o.nextBlock&&i instanceof CommandBlockMorph))return console.log("SNAP: expecting a command but getting a reporter:\n  "+o.blockSpec+"\n  "+i.blockSpec),e;o.nextBlock(i)}else e=i;o=i}}),e},SnapSerializer.prototype.loadComment=function(t){var e=new CommentMorph(t.contents),o=SyntaxElementMorph.prototype.scale;return e.isCollapsed="true"===t.attributes.collapsed,e.setTextWidth(+t.attributes.w*o),e.id=t.attributes.collabId,e},SnapSerializer.prototype.loadBlock=function(e,t){var o,i,r,n,s,a;if("block"===e.tag){if(Object.prototype.hasOwnProperty.call(e.attributes,"var"))return(o=SpriteMorph.prototype.variableBlock(e.attributes.var)).id=e.attributes.collabId,o;o=SpriteMorph.prototype.blockForSelector(e.attributes.s)}else if("custom-block"===e.tag){if(a=(n=!e.attributes.scope)?this.project.stage:this.project.sprites[e.attributes.scope],(s=e.childNamed("receiver"))&&s.children[0]&&"project"!==s.children[0].tag&&(a=this.loadValue(e.childNamed("receiver").children[0])),!a){if(n)return(o=this.obsoleteBlock(t)).id=e.attributes.collabId,o;a=this.project.stage}if(n?!(i=detect(a.globalBlocks,function(t){return t.blockSpec()===e.attributes.s}))&&this.project.targetStage&&(i=detect(this.project.targetStage.globalBlocks,function(t){return t.blockSpec()===e.attributes.s})):i=detect(a.customBlocks,function(t){return t.blockSpec()===e.attributes.s}),!i)return(o=this.obsoleteBlock(t)).id=e.attributes.collabId,o;o="command"===i.type?new CustomCommandBlockMorph(i,!1):new CustomReporterBlockMorph(i,"predicate"===i.type,!1)}if(null===o&&(o=this.obsoleteBlock(t)),o.isDraggable=!0,o.id=e.attributes.collabId,(r=o.inputs()).length<e.children.length){var h=detect(r,function(t){return t instanceof StructInputSlotMorph}),l=r.indexOf(h);if(-1!==l){var p,c=this,u=e.children.length-r.length;r.splice(l,1),p=e.children.splice(l,l+u+1).map(function(t){return"block"===t.tag||"custom-block"===t.tag?c.loadBlock(t):"script"===t.tag?c.loadScript(t):"color"===t.tag?c.loadColor(t):c.loadValue(t)||""})}}if(e.children.forEach(function(t,e){"variables"===t.tag?this.loadVariables(o.variables,t):"comment"===t.tag?(o.comment=this.loadComment(t),o.comment.block=o):"receiver"===t.tag?nop():this.loadInput(t,r[e],o)},this),o.cachedInputs=null,h&&p)if(h instanceof MessageInputSlotMorph){var d=this.project.stage.messageTypes.getMsgType(p[0]);h.setContents(p[0],p.slice(1),d)}else h.setContents(p[0],p.slice(1));return o},SnapSerializer.prototype.obsoleteBlock=function(t){var e=t?new ReporterBlockMorph:new CommandBlockMorph;return e.selector="errorObsolete",e.color=new Color(200,0,20),e.setSpec("Obsolete!"),e.isDraggable=!0,e},SnapSerializer.prototype.loadInput=function(t,e,o){var i,r=this;if("script"===t.tag)(i=this.loadScript(t))&&(e.add(i),e.fixLayout());else if("autolambda"===t.tag&&t.children[0])(i=this.loadBlock(t.children[0],!0))&&(e.silentReplaceInput(e.children[0],i),e.fixLayout());else if("list"===t.tag){for(;0<e.inputs().length;)e.removeInput();t.children.forEach(function(t){e.addInput(),r.loadInput(t,e.children[e.children.length-2],e)}),e.fixLayout()}else if("block"===t.tag||"custom-block"===t.tag)o.silentReplaceInput(e,this.loadBlock(t,!0));else if("color"===t.tag)e.setColor(this.loadColor(t.contents));else if(!isNil(this.loadValue(t))&&!isNil(e)&&e.setContents)if(e instanceof MessageInputSlotMorph){var n=this.loadValue(t),s=this.project.stage.messageTypes.getMsgType(n);e.setContents(n,null,s)}else e.setContents(this.loadValue(t))},SnapSerializer.prototype.loadValue=function(r){var n,e,t,s,o,i,a,h,l,p,c,u=this;function d(){Object.prototype.hasOwnProperty.call(r.attributes,"id")&&(u.objects[r.attributes.id]=n),Object.prototype.hasOwnProperty.call(r.attributes,"mediaID")&&(u.mediaDict[r.attributes.mediaID]=n)}switch(r.tag){case"ref":if(Object.prototype.hasOwnProperty.call(r.attributes,"id"))return this.objects[r.attributes.id];if(Object.prototype.hasOwnProperty.call(r.attributes,"mediaID"))return this.mediaDict[r.attributes.mediaID];if(Object.prototype.hasOwnProperty.call(r.attributes,"actionID"))return SnapActions.getOwnerFromId(r.attributes.actionID);throw new Error("expecting a reference id");case"l":return(p=r.childNamed("option"))?[p.contents]:(c=r.childNamed("bool"))?this.loadValue(c):r.contents;case"bool":return"true"===r.contents;case"list":return r.attributes.hasOwnProperty("linked")?((n=new List).isLinked=!0,d(),t=n,(s=r.childrenNamed("item")).forEach(function(t,e){var o=t.children[0];n.first=o?u.loadValue(o):0;var i=r.childNamed("list")||r.childNamed("ref");i?n.rest=u.loadValue(i):e<s.length-1&&(n.rest=new List,(n=n.rest).isLinked=!0)}),t):(n=new List,d(),n.contents=r.childrenNamed("item").map(function(t){var e=t.children[0];return e?u.loadValue(e):0}),n);case"sprite":return n=new SpriteMorph(u.project.globalVariables),r.attributes.id&&(u.objects[r.attributes.id]=n),r.attributes.name&&(n.name=r.attributes.name,u.project.sprites[r.attributes.name]=n),r.attributes.idx&&(n.idx=+r.attributes.idx),r.attributes.color&&(n.color=u.loadColor(r.attributes.color)),r.attributes.pen&&(n.penPoint=r.attributes.pen),r.attributes.collabId&&(n.id=r.attributes.collabId),u.project.stage.add(n),n.scale=parseFloat(r.attributes.scale||"1"),n.rotationStyle=parseFloat(r.attributes.rotation||"1"),n.isDraggable="false"!==r.attributes.draggable,n.isVisible="true"!==r.attributes.hidden,n.heading=parseFloat(r.attributes.heading)||0,n.drawNew(),n.gotoXY(+r.attributes.x||0,+r.attributes.y||0),u.loadObject(n,r),u.loadHistory(r.childNamed("history")),n;case"context":return n=new Context(null),d(),(o=r.childNamed("script"))?n.expression=this.loadScript(o):(o=r.childNamed("block")||r.childNamed("custom-block"))?n.expression=this.loadBlock(o):(o=r.childNamed("l"))&&(c=o.childNamed("bool"),n.expression=c?new BooleanSlotMorph(this.loadValue(c)):new InputSlotMorph(o.contents)),n.expression instanceof BlockMorph&&(e=0,n.expression.allEmptySlots().forEach(function(t){e+=1,t.bindingID=t instanceof MultiArgMorph?["arguments"]:e}),n.emptySlots=e),(o=r.childNamed("receiver"))&&(o=o.childNamed("ref")||o.childNamed("sprite"))&&(n.receiver=this.loadValue(o)),(o=r.childNamed("inputs"))&&o.children.forEach(function(t){"input"===t.tag&&n.inputs.push(t.contents)}),(o=r.childNamed("variables"))&&this.loadVariables(n.variables,o),(o=r.childNamed("context"))&&(n.outerContext=this.loadValue(o)),n.outerContext&&n.receiver&&!n.outerContext.variables.parentFrame&&(n.outerContext.variables.parentFrame=n.receiver.variables),n;case"costume":return i=new Point,Object.prototype.hasOwnProperty.call(r.attributes,"center-x")&&(i.x=parseFloat(r.attributes["center-x"])),Object.prototype.hasOwnProperty.call(r.attributes,"center-y")&&(i.y=parseFloat(r.attributes["center-y"])),Object.prototype.hasOwnProperty.call(r.attributes,"name")&&(h=r.attributes.name),Object.prototype.hasOwnProperty.call(r.attributes,"image")&&(a=new Image,0!==r.attributes.image.indexOf("data:image/svg+xml")||MorphicPreferences.rasterizeSVGs?(n=new Costume(null,h,i),a.onload=function(){var t=newCanvas(new Point(a.width,a.height),!0);t.getContext("2d").drawImage(a,0,0),n.contents=t,n.imageSrc=null,n.version=+new Date,"function"==typeof n.loaded?n.loaded():n.loaded=!0}):(n=new SVG_Costume(null,h,i),a.onload=function(){n.contents=a,n.imageSrc=null,n.version=+new Date,"function"==typeof n.loaded?n.loaded():n.loaded=!0}),a.src=r.attributes.image,n.imageSrc=r.attributes.image),n.id=r.attributes.collabId,d(),n;case"sound":return(l=new Audio).src=r.attributes.sound,n=new Sound(l,r.attributes.name),Object.prototype.hasOwnProperty.call(r.attributes,"mediaID")&&(u.mediaDict[r.attributes.mediaID]=n),n.id=r.attributes.collabId,n}},SnapSerializer.prototype.loadColor=function(t){var e=(t||"").split(",");return new Color(parseFloat(e[0]),parseFloat(e[1]),parseFloat(e[2]),parseFloat(e[3]))},SnapSerializer.prototype.openProject=function(t,e){var o,i=e.stage,r=[];if(t&&t.stage)return e.projectName=t.name,e.projectNotes=t.notes||"",e.globalVariables&&(e.globalVariables=t.globalVariables),i&&i.destroy(),e.add(t.stage),e.stage=t.stage,(r=e.stage.children.filter(function(t){return t instanceof SpriteMorph})).sort(function(t,e){return t.idx-e.idx}),e.sprites=new List(r),o=r[0]||t.stage,0<sizeOf(this.mediaDict)?(e.hasChangedMedia=!1,this.mediaDict={}):e.hasChangedMedia=!0,t.stage.drawNew(),e.createCorral(),e.selectSprite(o),e.fixLayout(),e.world().keyboardReceiver=t.stage,SnapUndo.allEvents=t.undo.allEvents,SnapUndo.eventHistory=t.undo.eventHistory,SnapUndo.undoCount=t.undo.undoCount,t},Array.prototype.toXML=function(o){return this.reduce(function(t,e){return t+o.store(e)},"")},StageMorph.prototype.toXML=function(t){var e,o=null,i=this.parentThatIsA(IDE_Morph);if(!t.isSavingPortable){e=normalizeCanvas(this.thumbnail(SnapSerializer.prototype.thumbnailSize),!0);try{o=e.toDataURL("image/png")}catch(t){o=null}}function r(e){var o="";return Object.keys(StageMorph.prototype[e]).forEach(function(t){o+="<"+t+">"+XML_Element.prototype.escape(StageMorph.prototype[e][t])+"</"+t+">"}),o}return this.removeAllClones(),t.format('<project collabStartIndex="@" name="@" app="@" version="@"><notes>$</notes><thumbnail>$</thumbnail><stage name="@" width="@" height="@" collabId="@" costume="@" tempo="@" threadsafe="@" lines="@" codify="@" inheritance="@" sublistIDs="@" scheduled="@" ~><pentrails>$</pentrails><costumes>%</costumes><sounds>%</sounds><variables>%</variables><blocks>%</blocks><messageTypes>%</messageTypes><scripts>%</scripts><sprites>%</sprites></stage><hidden>$</hidden><headers>%</headers><code>%</code><blocks>%</blocks><variables>%</variables><history>%</history><replay>%</replay></project>',SnapActions.lastSeen,i&&i.projectName?i.projectName:localize("Untitled"),t.app,t.version,i&&i.projectNotes?i.projectNotes:"",o,this.name,StageMorph.prototype.dimensions.x,StageMorph.prototype.dimensions.y,this.id,this.getCostumeIdx(),this.getTempo(),this.isThreadSafe,SpriteMorph.prototype.useFlatLineEnds?"flat":"round",this.enableCodeMapping,this.enableInheritance,this.enableSublistIDs,0!==StageMorph.prototype.frameRate,normalizeCanvas(this.trailsCanvas,!0).toDataURL("image/png"),t.store(this.costumes,this.name+"_cst"),t.store(this.sounds,this.name+"_snd"),t.store(this.variables),t.store(this.customBlocks),t.store(this.messageTypes),t.store(this.scripts),t.store(this.children),Object.keys(StageMorph.prototype.hiddenPrimitives).reduce(function(t,e){return t+" "+e},""),r("codeHeaders"),r("codeMappings"),t.store(this.globalBlocks),i&&i.globalVariables?t.store(i.globalVariables):"",t.isSavingHistory?t.historyXML(this.id):"",t.isSavingHistory?t.replayHistory():"")},StageMorph.prototype.toPortableXML=function(e,t){var o=this.parentThatIsA(IDE_Morph),i=this.customBlocks,r=this.globalBlocks;function n(e){var o="";return Object.keys(StageMorph.prototype[e]).forEach(function(t){o+="<"+t+">"+XML_Element.prototype.escape(StageMorph.prototype[e][t])+"</"+t+">"}),o}return e.dependencies&&(i=i.filter(function(t){return e.dependencies.customBlocks.includes(t)}),r=r.filter(function(t){return e.dependencies.customBlocks.includes(t)})),this.removeAllClones(),e.format('<project collabStartIndex="@" name="@" app="@" version="@"><notes>$</notes><thumbnail>$</thumbnail><stage name="@" width="@" height="@" collabId="@" costume="@" tempo="@" threadsafe="@" lines="@" codify="@" inheritance="@" sublistIDs="@" scheduled="@" ~><pentrails>$</pentrails><costumes>%</costumes><sounds>%</sounds><variables>%</variables><blocks>%</blocks><messageTypes>%</messageTypes><scripts>%</scripts><sprites>%</sprites></stage><hidden>$</hidden><headers>%</headers><code>%</code><blocks>%</blocks><variables>%</variables><history>%</history><replay>%</replay></project>',SnapActions.lastSeen,o&&o.projectName?o.projectName:localize("Untitled"),e.app,e.version,o&&o.projectNotes?o.projectNotes:"","",this.name,StageMorph.prototype.dimensions.x,StageMorph.prototype.dimensions.y,this.id,this.getCostumeIdx(),this.getTempo(),this.isThreadSafe,SpriteMorph.prototype.useFlatLineEnds?"flat":"round",this.enableCodeMapping,this.enableInheritance,this.enableSublistIDs,0!==StageMorph.prototype.frameRate,"",e.store(this.costumes,this.name+"_cst"),e.store(this.sounds,this.name+"_snd"),e.store(this.variables),e.store(i),e.store(this.messageTypes),e.dependencies?"":e.store(this.scripts),e.store(this.children),Object.keys(StageMorph.prototype.hiddenPrimitives).reduce(function(t,e){return t+" "+e},""),n("codeHeaders"),n("codeMappings"),e.store(r),o&&o.globalVariables?e.store(o.globalVariables):"","","")},SpriteMorph.prototype.toXML=function(t){var e=this.parentThatIsA(StageMorph),o=e?e.parentThatIsA(IDE_Morph):null,i=o?o.sprites.asArray().indexOf(this)+1:0;return t.format('<sprite name="@" collabId="@" idx="@" x="@" y="@" heading="@" scale="@" rotation="@" draggable="@"% costume="@" color="@,@,@" pen="@" ~>%%<costumes>%</costumes><sounds>%</sounds><variables>%</variables><blocks>%</blocks><scripts>%</scripts><history>%</history></sprite>',this.name,this.id,i,this.xPosition(),this.yPosition(),this.heading,this.scale,this.rotationStyle,this.isDraggable,this.isVisible?"":' hidden="true"',this.getCostumeIdx(),this.color.r,this.color.g,this.color.b,this.penPoint,this.exemplar?'<inherit exemplar="'+this.exemplar.name+'"/>':"",this.anchor?'<nest anchor="'+this.anchor.name+'" synch="'+this.rotatesWithAnchor+(this.scale===this.nestingScale?"":'" scale="'+this.nestingScale)+'"/>':"",t.store(this.costumes,this.name+"_cst"),t.store(this.sounds,this.name+"_snd"),t.store(this.variables),this.customBlocks?t.store(this.customBlocks):"",t.store(this.scripts),t.isSavingHistory?t.historyXML(this.id):"")},SpriteMorph.prototype.toPortableXML=function(e){var t=this.parentThatIsA(StageMorph),o=t?t.parentThatIsA(IDE_Morph):null,i=o?o.sprites.asArray().indexOf(this)+1:0,r=this.customBlocks||[];return e.dependencies&&(r=r.filter(function(t){return e.dependencies.customBlocks.includes(t)})),e.format('<sprite name="@" collabId="@" idx="@" x="@" y="@" heading="@" scale="@" rotation="@" draggable="@"% costume="@" color="@,@,@" pen="@" ~>%%<costumes>%</costumes><sounds>%</sounds><variables>%</variables><blocks>%</blocks><scripts>%</scripts></sprite>',this.name,this.id,i,this.xPosition(),this.yPosition(),this.heading,this.scale,this.rotationStyle,this.isDraggable,this.isVisible?"":' hidden="true"',this.getCostumeIdx(),this.color.r,this.color.g,this.color.b,this.penPoint,this.exemplar?'<inherit exemplar="'+this.exemplar.name+'"/>':"",this.anchor?'<nest anchor="'+this.anchor.name+'" synch="'+this.rotatesWithAnchor+(this.scale===this.nestingScale?"":'" scale="'+this.nestingScale)+'"/>':"",e.dependencies?e.store(new List):e.store(this.costumes,this.name+"_cst"),e.store(this.sounds,this.name+"_snd"),e.store(this.variables),this.customBlocks?e.store(r):"",e.dependencies?"":e.store(this.scripts))},Costume.prototype[XML_Serializer.prototype.mediaDetectionProperty]=!0,Costume.prototype.toXML=function(t){var e=this.imageSrc;return e||(e=this instanceof SVG_Costume?this.contents.src:normalizeCanvas(this.contents).toDataURL("image/png")),t.format('<costume name="@" collabId="@" center-x="@" center-y="@" image="@" ~/>',this.name,this.id,this.rotationCenter.x,this.rotationCenter.y,e)},Sound.prototype[XML_Serializer.prototype.mediaDetectionProperty]=!0,Sound.prototype.toXML=function(t){return t.format('<sound collabId="@" name="@" sound="@" ~/>',this.id,this.name,this.toDataURL())},VariableFrame.prototype.toXML=function(i){var r=this;return Object.keys(this.vars).reduce(function(t,e){var o=r.vars[e].value;return t+(r.vars[e].isTransient?i.format('<variable name="@" transient="true"/>',e):null==o?i.format('<variable name="@"/>',e):i.format('<variable name="@">%</variable>',e,"object"==typeof o?isSnapObject(o)?"":i.store(o):"boolean"==typeof o?i.format("<bool>$</bool>",o):i.format("<l>$</l>",o)))},"")},VariableFrame.prototype.toPortableXML=function(i){var r=this,t=Object.keys(this.vars);return i.dependencies&&(t=t.filter(function(t){i.dependencies.variables.includes(t)})),t.reduce(function(t,e){var o=r.vars[e].value;return t+(r.vars[e].isTransient?i.format('<variable name="@" transient="true"/>',e):null==o?i.format('<variable name="@"/>',e):i.format('<variable name="@">%</variable>',e,"object"==typeof o?isSnapObject(o)?"":i.store(o):"boolean"==typeof o?i.format("<bool>$</bool>",o):i.format("<l>$</l>",o)))},"")},WatcherMorph.prototype.toXML=function(t){var e=this.target instanceof VariableFrame,o=this.currentValue instanceof List,i=this.readoutColor,r=this.parent?this.topLeft().subtract(this.parent.topLeft()):this.topLeft();return this.isTemporary()?"":t.format('<watcher% % style="@"% x="@" y="@" color="@,@,@"%%/>',e&&this.target.owner||!e&&this.target?t.format(' scope="@"',e?this.target.owner.name:this.target.name):"",t.format(e?'var="@"':'s="@"',this.getter),this.style,e&&"slider"===this.style?t.format(' min="@" max="@"',this.sliderMorph.start,this.sliderMorph.stop):"",r.x,r.y,i.r,i.g,i.b,o?t.format(' extX="@" extY="@"',this.cellMorph.contentsMorph.width(),this.cellMorph.contentsMorph.height()):"",this.isVisible?"":' hidden="true"')},ScriptsMorph.prototype.toXML=function(o){return this.children.reduce(function(t,e){return e instanceof BlockMorph?t+e.toScriptXML(o,!0):e instanceof CommentMorph&&!e.block?t+e.toXML(o):t},"")},BlockMorph.prototype.toXML=BlockMorph.prototype.toScriptXML=function(t,e){var o,i,r=SyntaxElementMorph.prototype.scale,n=this;for(o=this.parent?this.topLeft().subtract(this.parent.topLeft()):this.topLeft(),i=e?t.format('<script x="@" y="@">',o.x/r,o.y/r):"<script>";i+=n.toBlockXML(t),n=n.nextBlock(););return i+="<\/script>"},BlockMorph.prototype.toBlockXML=function(t){return t.format('<block collabId="@" s="@">%%</block>',this.id,this.selector,t.store(this.inputs()),this.comment?this.comment.toXML(t):"")},ReporterBlockMorph.prototype.toXML=function(t){return"reportGetVar"===this.selector?t.format('<block collabId="@" var="@"/>',this.id,this.blockSpec):this.toBlockXML(t)},ReporterBlockMorph.prototype.toScriptXML=function(t,e){var o,i=SyntaxElementMorph.prototype.scale;return o=this.parent?this.topLeft().subtract(this.parent.topLeft()):this.topLeft(),e?t.format('<script x="@" y="@">%<\/script>',o.x/i,o.y/i,this.toXML(t)):t.format("<script>%<\/script>",this.toXML(t))},CustomCommandBlockMorph.prototype.toBlockXML=function(t){var e=this.definition.isGlobal?void 0:this.definition.receiver.name;return t.format('<custom-block collabId="@" s="@"%>%%%%</custom-block>',this.id,this.blockSpec,this.definition.isGlobal?"":t.format(' scope="@"',e),t.store(this.inputs()),this.definition.variableNames.length?"<variables>"+this.variables.toXML(t)+"</variables>":"",this.comment?this.comment.toXML(t):"",!t.isSavingPortable&&!e||this.definition.receiver[t.idProperty]?"":"<receiver>"+(t.isSavingCustomBlockOwners?t.store(this.definition.receiver):'<ref actionID="'+this.definition.receiver.id+'"/>')+"</receiver>")},CustomReporterBlockMorph.prototype.toBlockXML=CustomCommandBlockMorph.prototype.toBlockXML,CustomBlockDefinition.prototype.toXML=function(o){var i=this;return o.format('<block-definition collabId="@" s="@" type="@" category="@">%'+(this.variableNames.length?"<variables>%</variables>":"@")+"<header>@</header><code>@</code><inputs>%</inputs>%%</block-definition>",this.id,this.spec,this.type,this.category||"other",this.comment?this.comment.toXML(o):"",this.variableNames.length?o.store(new List(this.variableNames)):"",this.codeHeader||"",this.codeMapping||"",Object.keys(this.declarations).reduce(function(t,e){return t+o.format('<input type="@"$>$%</input>',i.declarations[e][0],i.declarations[e][3]?' readonly="true"':"",i.declarations[e][1],i.declarations[e][2]?"<options>"+i.declarations[e][2]+"</options>":"")},""),this.body?o.store(this.body.expression):"",0<this.scripts.length?"<scripts>"+this.scripts.reduce(function(t,e){return e instanceof BlockMorph?t+e.toScriptXML(o,!0):e instanceof CommentMorph&&!e.block?t+e.toXML(o):t},"")+"</scripts>":"")},ArgMorph.prototype.toXML=function(){return"<l/>"},BooleanSlotMorph.prototype.toXML=function(){return"boolean"==typeof this.value?"<l><bool>"+this.value+"</bool></l>":"<l/>"},InputSlotMorph.prototype.toXML=function(t){return this.constant?t.format("<l><option>$</option></l>",this.constant):t.format("<l>$</l>",this.contents().text)},TemplateSlotMorph.prototype.toXML=function(t){return t.format("<l>$</l>",this.contents())},CommandSlotMorph.prototype.toXML=function(t){var e=this.children[0];return e instanceof BlockMorph?e instanceof ReporterBlockMorph?t.format("<autolambda>%</autolambda>",t.store(e)):t.store(e):"<script><\/script>"},FunctionSlotMorph.prototype.toXML=CommandSlotMorph.prototype.toXML,MultiArgMorph.prototype.toXML=function(t){return t.format("<list>%</list>",t.store(this.inputs()))},ArgLabelMorph.prototype.toXML=function(t){return t.format("%",t.store(this.inputs()[0]))},ColorSlotMorph.prototype.toXML=function(t){return t.format("<color>$,$,$,$</color>",this.color.r,this.color.g,this.color.b,this.color.a)},List.prototype.toXML=function(o,i){var t,e,r;if(this.isLinked){if(t='<list collabId="'+this.id+'" linked="linked" ~>',StageMorph.prototype.enableSublistIDs)return isNil(e=this.first)||(t+=o.format("<item>%</item>","object"==typeof e?isSnapObject(e)?"":o.store(e,i):"boolean"==typeof e?o.format("<bool>$</bool>",e):o.format("<l>$</l>",e))),isNil(this.rest)||(t+=o.store(this.rest,i)),t+"</list>";for(r=this;isNil(e=r.first)||(t+=o.format("<item>%</item>","object"==typeof e?isSnapObject(e)?"":o.store(e,i):"boolean"==typeof e?o.format("<bool>$</bool>",e):o.format("<l>$</l>",e))),!isNil(r=r.rest););return t+"</list>"}return o.format('<list collabId="@" ~>%</list>',this.id,this.contents.reduce(function(t,e){return t+o.format("<item>%</item>","object"==typeof e?isSnapObject(e)?"":o.store(e,i):"boolean"==typeof e?o.format("<bool>$</bool>",e):o.format("<l>$</l>",e))},""))},Context.prototype.toXML=function(o){return this.isContinuation?"":o.format("<context ~><inputs>%</inputs><variables>%</variables>%<receiver>%</receiver>%</context>",this.inputs.reduce(function(t,e){return t+o.format("<input>$</input>",e)},""),this.variables?o.store(this.variables):"",this.expression?o.store(this.expression):"",this.receiver?o.store(this.receiver):"",this.outerContext?o.store(this.outerContext):"")},Context.prototype.toPortableXML=function(t){var e,o,i,r,n,s=this,a=new VariableFrame;return this.outerContext&&(i=this.outerContext.variables,this.expression&&(e=[],SnapActions.traverse(this.expression,function(t){o=t.blockSpec,"reportGetVar"!==t.selector||e.includes(o)||e.push(o)}),a.vars=copy(this.outerContext.variables.vars),e.forEach(function(t){(n=s.outerContext.variables.silentFind(t)||s.receiver.variables.silentFind(t))&&(a.vars[t]=n.vars[t])}),this.outerContext.variables=a)),r=this.toXML(t),this.outerContext.variables=i||this.outerContext.variables,r},Context.prototype.getPortableDependencies=function(t,e){var o,i;return o={variables:[],customBlocks:[]},t||(t=this.expression),e||(e={}),e[t.id]||((t instanceof CustomCommandBlockMorph||t instanceof CustomReporterBlockMorph)&&(o=this.getPortableDependencies(t.definition.body.expression,e)),SnapActions.traverse(t,function(t){i=t.blockSpec,"reportGetVar"!==t.selector||o.variables.includes(i)?"evaluateCustomBlock"!==t.selector||o.customBlocks.includes(t.definition)||o.customBlocks.push(t.definition):o.variables.push(i)}),e[t.id]=!0),o},CommentMorph.prototype.toXML=function(t){var e,o=SyntaxElementMorph.prototype.scale;return this.block?t.format('<comment collabId="@" w="@" collapsed="@">%</comment>',this.id,this.textWidth()/o,this.isCollapsed,t.escape(this.text())):(e=this.parent?this.topLeft().subtract(this.parent.topLeft()):this.topLeft(),t.format('<comment collabId="@" x="@" y="@" w="@" collapsed="@">%</comment>',this.id,e.x/o,e.y/o,this.textWidth()/o,this.isCollapsed,t.escape(this.text())))},modules.cloud="2015-December-15";var SnapCloud=new Cloud("https://snap.apps.miosoft.com/SnapCloud");function Cloud(t){this.username=null,this.password=null,this.url=t,this.session=null,this.limo=null,this.route=null,this.api={}}Cloud.prototype.clear=function(){this.username=null,this.password=null,this.session=null,this.limo=null,this.route=null,this.api={}},Cloud.prototype.hasProtocol=function(){return 0===this.url.toLowerCase().indexOf("http")},Cloud.prototype.setRoute=function(t){var e,o=0;for(e=0;e<t.length;e+=1)o+=t.charCodeAt(e);o=o%20+1,this.route=".sc1m"+(o<10?"0":"")+o},Cloud.prototype.signup=function(t,e,o,i){var r=new XMLHttpRequest,n=this;try{r.open("GET",(this.hasProtocol()?"":"http://")+this.url+"SignUp?Username="+encodeURIComponent(t)+"&Email="+encodeURIComponent(e),!0),r.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),r.withCredentials=!0,r.onreadystatechange=function(){4===r.readyState&&(r.responseText?0===r.responseText.indexOf("ERROR")?i.call(this,r.responseText,"Signup"):o.call(null,r.responseText,"Signup"):i.call(null,n.url+"SignUp",localize("could not connect to:")))},r.send(null)}catch(t){i.call(this,t.toString(),"Snap!Cloud")}},Cloud.prototype.getPublicProject=function(t,e,o){var i=new XMLHttpRequest,r=this;try{i.open("GET",(this.hasProtocol()?"":"http://")+this.url+"RawPublic?"+t,!0),i.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),i.withCredentials=!0,i.onreadystatechange=function(){4===i.readyState&&(i.responseText?0===i.responseText.indexOf("ERROR")?o.call(this,i.responseText):e.call(null,i.responseText):o.call(null,r.url+"Public",localize("could not connect to:")))},i.send(null)}catch(t){o.call(this,t.toString(),"Snap!Cloud")}},Cloud.prototype.resetPassword=function(t,e,o){var i=new XMLHttpRequest,r=this;try{i.open("GET",(this.hasProtocol()?"":"http://")+this.url+"ResetPW?Username="+encodeURIComponent(t),!0),i.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),i.withCredentials=!0,i.onreadystatechange=function(){4===i.readyState&&(i.responseText?0===i.responseText.indexOf("ERROR")?o.call(this,i.responseText,"Reset Password"):e.call(null,i.responseText,"Reset Password"):o.call(null,r.url+"ResetPW",localize("could not connect to:")))},i.send(null)}catch(t){o.call(this,t.toString(),"Snap!Cloud")}},Cloud.prototype.login=function(t,e,o,i){var r=new XMLHttpRequest,n=JSON.stringify({__h:e,__u:t}),s=this;this.setRoute(t);try{r.open("POST",(this.hasProtocol()?"":"http://")+this.url+"?SESSIONGLUE="+this.route,!0),r.setRequestHeader("Content-Type","application/json; charset=utf-8"),r.setRequestHeader("SESSIONGLUE",this.route),r.withCredentials=!0,r.onreadystatechange=function(){4===r.readyState&&(r.responseText?(s.api=s.parseAPI(r.responseText),s.session=r.getResponseHeader("MioCracker").split(";")[0],s.limo=this.getResponseHeader("miocracker").substring(9,this.getResponseHeader("miocracker").indexOf("=")),s.api.logout?(s.username=t,s.password=e,o.call(null,s.api,"Snap!Cloud")):i.call(null,r.responseText,"connection failed")):i.call(null,s.url,localize("could not connect to:")))},r.send(n)}catch(t){i.call(this,t.toString(),"Snap!Cloud")}},Cloud.prototype.reconnect=function(t,e){this.username&&this.password?this.login(this.username,this.password,t,e):this.message("You are not logged in")},Cloud.prototype.saveProject=function(o,i,t){var e,r,n,s,a=this;if(o.serializer.isCollectingMedia=!0,e=o.serializer.serialize(o.stage),r=o.hasChangedMedia?o.serializer.mediaXML(o.projectName):null,o.serializer.isCollectingMedia=!1,o.serializer.flushMedia(),s=r?r.length:0,n=e.length+s,10485760<s)throw(new DialogBoxMorph).inform("Snap!Cloud - Cannot Save Project","The media inside this project exceeds 10 MB.\nPlease reduce the size of costumes or sounds.\n",o.world(),o.cloudIcon(null,new Color(180,0,0))),new Error("Project media exceeds 10 MB size limit");try{o.serializer.parse(e)}catch(t){throw o.showMessage("Serialization of program data failed:\n"+t),new Error("Serialization of program data failed:\n"+t)}if(null!==r)try{o.serializer.parse(r)}catch(t){throw o.showMessage("Serialization of media failed:\n"+t),new Error("Serialization of media failed:\n"+t)}o.serializer.isCollectingMedia=!1,o.serializer.flushMedia(),o.showMessage("Uploading "+Math.round(n/1024)+" KB..."),a.reconnect(function(){a.callService("saveProject",function(t,e){i.call(null,t,e),a.disconnect(),o.hasChangedMedia=!1},t,[o.projectName,e,r,e.length,r?r.length:0])},t)},Cloud.prototype.getProjectList=function(o,t){var i=this;this.reconnect(function(){i.callService("getProjectList",function(t,e){o.call(null,t,e),i.disconnect()},t)},t)},Cloud.prototype.getSharedProjectList=function(o,t){var i=this;this.reconnect(function(){i.callService("getSharedProjectList",function(t,e){o.call(null,t,e),i.disconnect()},t)},t)},Cloud.prototype.changePassword=function(t,e,o,i){var r=this;this.reconnect(function(){r.callService("changePassword",function(t,e){o.call(null,t,e),r.disconnect()},i,[hex_sha512(t),hex_sha512(e)])},i)},Cloud.prototype.logout=function(t,e){this.clear(),this.callService("logout",t,e)},Cloud.prototype.disconnect=function(){this.callService("logout",nop,nop)},Cloud.prototype.callURL=function(e,o,i){var t,r=new XMLHttpRequest,n=this;try{t=e+"&SESSIONGLUE="+this.route+"&_Limo="+this.limo,r.open("GET",t,!0),r.withCredentials=!0,r.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),r.setRequestHeader("MioCracker",this.session),r.setRequestHeader("SESSIONGLUE",this.route),r.onreadystatechange=function(){if(4===r.readyState)if(r.responseText){var t=n.parseResponse(r);o.call(null,t,e)}else i.call(null,e,"no response from:")},r.send(null)}catch(t){i.call(this,t.toString(),e)}},Cloud.prototype.supportsService=function(t){return!!this.api[t]},Cloud.prototype.callService=function(e,o,i,r){var t,n,s=new XMLHttpRequest,a=this.api[e],h=this;if(this.session)if(a){r&&0<r.length&&(n={},a.parameters.forEach(function(t,e){n[t]=r[e]}));try{t=this.url+"/"+a.url+"&SESSIONGLUE="+this.route+"&_Limo="+this.limo,s.open(a.method,t,!0),s.withCredentials=!0,s.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),s.setRequestHeader("MioCracker",this.session),s.setRequestHeader("SESSIONGLUE",this.route),s.onreadystatechange=function(){if(4===s.readyState){var t=[];if(s.responseText&&0===s.responseText.indexOf("ERROR"))return void i.call(this,s.responseText,localize("Service:")+" "+localize(e));"login"===e&&(h.api=h.parseAPI(s.responseText)),t="getRawProject"===e?s.responseText:h.parseResponse(s),o.call(null,t,a.url)}},s.send(this.encodeDict(n))}catch(t){i.call(this,t.toString(),a.url)}}else i.call(null,"service "+e+" is not available","API");else i.call(null,"You are not connected","Cloud")},Cloud.prototype.parseAPI=function(t){var s={};return t.split(" ").forEach(function(t){var r,e=t.split("&"),n={};e.forEach(function(t){var e=t.split("="),o=decodeURIComponent(e[0]).toLowerCase(),i=decodeURIComponent(e[1]);"service"===o?s[i]=n:"parameters"===o?(1!==(r=i.split(",")).length||r[0])&&(n.parameters=r):n[o]=i})}),s},Cloud.prototype.parseResponse=function(t){var e=t.responseText;return-1<t.getResponseHeader("content-type").indexOf("application/json")?JSON.parse(e):-1<t.getResponseHeader("content-type").indexOf("xml")?e:this.parseSnapResponse(e)},Cloud.prototype.parseSnapResponse=function(t){var o=[];return t&&t.split(" ").forEach(function(t){var e=t.split("&"),r={};e.forEach(function(t){var e=t.split("="),o=decodeURIComponent(e[0]),i=decodeURIComponent(e[1]);r[o]=i}),o.push(r)}),o},Cloud.prototype.parseDict=function(t){var r={};return t&&t.split("&").forEach(function(t){var e=t.split("="),o=decodeURIComponent(e[0]),i=decodeURIComponent(e[1]);r[o]=i}),r},Cloud.prototype.encodeDict=function(t){var e,o,i="";if(!t)return null;for(o in t)t.hasOwnProperty(o)&&(e=encodeURIComponent(o)+"="+encodeURIComponent(t[o]),0<i.length&&(i+="&"),i+=e);return i},Cloud.prototype.message=function(t){alert(t)};var hex_sha512=function(t){function t(t){return s.SHA512(function(t){var e,o,i="",r=-1;for(;++r<t.length;)e=t.charCodeAt(r),o=r+1<t.length?t.charCodeAt(r+1):0,55296<=e&&e<=56319&&56320<=o&&o<=57343&&(e=65536+((1023&e)<<10)+(1023&o),r++),e<=127?i+=String.fromCharCode(e):e<=2047?i+=String.fromCharCode(192|e>>>6&31,128|63&e):e<=65535?i+=String.fromCharCode(224|e>>>12&15,128|e>>>6&63,128|63&e):e<=2097151&&(i+=String.fromCharCode(240|e>>>18&7,128|e>>>12&63,128|e>>>6&63,128|63&e));return i}(t)).toString(s.enc.Hex)}var e,o,r,n,s=s||function(a,t){var e={},o=e.lib={},i=o.Base=function(){function o(){}return{extend:function(t){o.prototype=this;var e=new o;return t&&e.mixIn(t),e.$super=this,e},create:function(){var t=this.extend();return t.init.apply(t,arguments),t},init:function(){},mixIn:function(t){for(var e in t)t.hasOwnProperty(e)&&(this[e]=t[e]);t.hasOwnProperty("toString")&&(this.toString=t.toString)},clone:function(){return this.$super.extend(this)}}}(),h=o.WordArray=i.extend({init:function(t,e){t=this.words=t||[],this.sigBytes=null!=e?e:4*t.length},toString:function(t){return(t||n).stringify(this)},concat:function(t){var e=this.words,o=t.words,i=this.sigBytes;t=t.sigBytes;if(this.clamp(),i%4)for(var r=0;r<t;r++)e[i+r>>>2]|=(o[r>>>2]>>>24-r%4*8&255)<<24-(i+r)%4*8;else if(65535<o.length)for(r=0;r<t;r+=4)e[i+r>>>2]=o[r>>>2];else e.push.apply(e,o);return this.sigBytes+=t,this},clamp:function(){var t=this.words,e=this.sigBytes;t[e>>>2]&=4294967295<<32-e%4*8,t.length=a.ceil(e/4)},clone:function(){var t=i.clone.call(this);return t.words=this.words.slice(0),t},random:function(t){for(var e=[],o=0;o<t;o+=4)e.push(4294967296*a.random()|0);return h.create(e,t)}}),r=e.enc={},n=r.Hex={stringify:function(t){for(var e=t.words,o=(t=t.sigBytes,[]),i=0;i<t;i++){var r=e[i>>>2]>>>24-i%4*8&255;o.push((r>>>4).toString(16)),o.push((15&r).toString(16))}return o.join("")},parse:function(t){for(var e=t.length,o=[],i=0;i<e;i+=2)o[i>>>3]|=parseInt(t.substr(i,2),16)<<24-i%8*4;return h.create(o,e/2)}},s=r.Latin1={stringify:function(t){for(var e=t.words,o=(t=t.sigBytes,[]),i=0;i<t;i++)o.push(String.fromCharCode(e[i>>>2]>>>24-i%4*8&255));return o.join("")},parse:function(t){for(var e=t.length,o=[],i=0;i<e;i++)o[i>>>2]|=(255&t.charCodeAt(i))<<24-i%4*8;return h.create(o,e)}},l=r.Utf8={stringify:function(t){try{return decodeURIComponent(escape(s.stringify(t)))}catch(t){throw Error("Malformed UTF-8 data")}},parse:function(t){return s.parse(unescape(encodeURIComponent(t)))}},p=o.BufferedBlockAlgorithm=i.extend({reset:function(){this._data=h.create(),this._nDataBytes=0},_append:function(t){"string"==typeof t&&(t=l.parse(t)),this._data.concat(t),this._nDataBytes+=t.sigBytes},_process:function(t){var e=this._data,o=e.words,i=e.sigBytes,r=this.blockSize,n=i/(4*r);t=(n=t?a.ceil(n):a.max((0|n)-this._minBufferSize,0))*r,i=a.min(4*t,i);if(t){for(var s=0;s<t;s+=r)this._doProcessBlock(o,s);s=o.splice(0,t),e.sigBytes-=i}return h.create(s,i)},clone:function(){var t=i.clone.call(this);return t._data=this._data.clone(),t},_minBufferSize:0});o.Hasher=p.extend({init:function(){this.reset()},reset:function(){p.reset.call(this),this._doReset()},update:function(t){return this._append(t),this._process(),this},finalize:function(t){return t&&this._append(t),this._doFinalize(),this._hash},clone:function(){var t=p.clone.call(this);return t._hash=this._hash.clone(),t},blockSize:16,_createHelper:function(o){return function(t,e){return o.create(e).finalize(t)}},_createHmacHelper:function(o){return function(t,e){return c.HMAC.create(o,e).finalize(t)}}});var c=e.algo={};return e}(Math);return o=(e=s).lib,r=o.Base,n=o.WordArray,(e=e.x64={}).Word=r.extend({init:function(t,e){this.high=t,this.low=e}}),e.WordArray=r.extend({init:function(t,e){t=this.words=t||[],this.sigBytes=null!=e?e:8*t.length},toX32:function(){for(var t=this.words,e=t.length,o=[],i=0;i<e;i++){var r=t[i];o.push(r.high),o.push(r.low)}return n.create(o,this.sigBytes)},clone:function(){for(var t=r.clone.call(this),e=t.words=this.words.slice(0),o=e.length,i=0;i<o;i++)e[i]=e[i].clone();return t}}),function(){function e(){return i.create.apply(i,arguments)}var t=s,o=t.lib.Hasher,i=(n=t.x64).Word,r=n.WordArray,n=t.algo,et=[e(1116352408,3609767458),e(1899447441,602891725),e(3049323471,3964484399),e(3921009573,2173295548),e(961987163,4081628472),e(1508970993,3053834265),e(2453635748,2937671579),e(2870763221,3664609560),e(3624381080,2734883394),e(310598401,1164996542),e(607225278,1323610764),e(1426881987,3590304994),e(1925078388,4068182383),e(2162078206,991336113),e(2614888103,633803317),e(3248222580,3479774868),e(3835390401,2666613458),e(4022224774,944711139),e(264347078,2341262773),e(604807628,2007800933),e(770255983,1495990901),e(1249150122,1856431235),e(1555081692,3175218132),e(1996064986,2198950837),e(2554220882,3999719339),e(2821834349,766784016),e(2952996808,2566594879),e(3210313671,3203337956),e(3336571891,1034457026),e(3584528711,2466948901),e(113926993,3758326383),e(338241895,168717936),e(666307205,1188179964),e(773529912,1546045734),e(1294757372,1522805485),e(1396182291,2643833823),e(1695183700,2343527390),e(1986661051,1014477480),e(2177026350,1206759142),e(2456956037,344077627),e(2730485921,1290863460),e(2820302411,3158454273),e(3259730800,3505952657),e(3345764771,106217008),e(3516065817,3606008344),e(3600352804,1432725776),e(4094571909,1467031594),e(275423344,851169720),e(430227734,3100823752),e(506948616,1363258195),e(659060556,3750685593),e(883997877,3785050280),e(958139571,3318307427),e(1322822218,3812723403),e(1537002063,2003034995),e(1747873779,3602036899),e(1955562222,1575990012),e(2024104815,1125592928),e(2227730452,2716904306),e(2361852424,442776044),e(2428436474,593698344),e(2756734187,3733110249),e(3204031479,2999351573),e(3329325298,3815920427),e(3391569614,3928383900),e(3515267271,566280711),e(3940187606,3454069534),e(4118630271,4000239992),e(116418474,1914138554),e(174292421,2731055270),e(289380356,3203993006),e(460393269,320620315),e(685471733,587496836),e(852142971,1086792851),e(1017036298,365543100),e(1126000580,2618297676),e(1288033470,3409855158),e(1501505948,4234509866),e(1607167915,987167468),e(1816402316,1246189591)],ot=[];!function(){for(var t=0;t<80;t++)ot[t]=e()}(),n=n.SHA512=o.extend({_doReset:function(){this._hash=r.create([e(1779033703,4089235720),e(3144134277,2227873595),e(1013904242,4271175723),e(2773480762,1595750129),e(1359893119,2917565137),e(2600822924,725511199),e(528734635,4215389547),e(1541459225,327033209)])},_doProcessBlock:function(t,e){for(var o=(l=this._hash.words)[0],i=l[1],r=l[2],n=l[3],s=l[4],a=l[5],h=l[6],l=l[7],p=o.high,c=o.low,u=i.high,d=i.low,g=r.high,f=r.low,m=n.high,y=n.low,M=s.high,b=s.low,S=a.high,w=a.low,C=h.high,v=h.low,x=l.high,k=l.low,B=p,P=c,T=u,I=d,E=g,L=f,A=m,R=y,D=M,N=b,F=S,O=w,_=C,z=v,j=x,H=k,W=0;W<80;W++){var U=ot[W];if(W<16)var V=U.high=0|t[e+2*W],G=U.low=0|t[e+2*W+1];else{G=(V=ot[W-15]).high,V=((q=V.low)<<31|G>>>1)^(q<<24|G>>>8)^G>>>7;var q=(G<<31|q>>>1)^(G<<24|q>>>8)^(G<<25|q>>>7),X=(G=(X=ot[W-2]).high,((K=X.low)<<13|G>>>19)^(G<<3|K>>>29)^G>>>6),K=(G<<13|K>>>19)^(K<<3|G>>>29)^(G<<26|K>>>6),J=(G=ot[W-7]).high,Y=(Q=ot[W-16]).high,Q=Q.low;V=(V=(V=V+J+((G=q+G.low)>>>0<q>>>0?1:0))+X+((G=G+K)>>>0<K>>>0?1:0))+Y+((G=G+Q)>>>0<Q>>>0?1:0);U.high=V,U.low=G}J=D&F^~D&_,Q=N&O^~N&z,U=B&T^B&E^T&E;var $=P&I^P&L^I&L,Z=(q=(P<<4|B>>>28)^(B<<30|P>>>2)^(B<<25|P>>>7),X=(B<<4|P>>>28)^(P<<30|B>>>2)^(P<<25|B>>>7),(K=et[W]).high),tt=K.low;Y=j+((N<<18|D>>>14)^(N<<14|D>>>18)^(D<<23|N>>>9))+((K=H+((D<<18|N>>>14)^(D<<14|N>>>18)^(N<<23|D>>>9)))>>>0<H>>>0?1:0),j=_,H=z,_=F,z=O,F=D,O=N,D=A+(Y=(Y=(Y=Y+J+((K=K+Q)>>>0<Q>>>0?1:0))+Z+((K=K+tt)>>>0<tt>>>0?1:0))+V+((K=K+G)>>>0<G>>>0?1:0))+((N=R+K|0)>>>0<R>>>0?1:0)|0,A=E,R=L,E=T,L=I,T=B,I=P,B=Y+(U=q+U+((G=X+$)>>>0<X>>>0?1:0))+((P=K+G|0)>>>0<K>>>0?1:0)|0}c=o.low=c+P|0,o.high=p+B+(c>>>0<P>>>0?1:0)|0,d=i.low=d+I|0,i.high=u+T+(d>>>0<I>>>0?1:0)|0,f=r.low=f+L|0,r.high=g+E+(f>>>0<L>>>0?1:0)|0,y=n.low=y+R|0,n.high=m+A+(y>>>0<R>>>0?1:0)|0,b=s.low=b+N|0,s.high=M+D+(b>>>0<N>>>0?1:0)|0,w=a.low=w+O|0,a.high=S+F+(w>>>0<O>>>0?1:0)|0,v=h.low=v+z|0,h.high=C+_+(v>>>0<z>>>0?1:0)|0,k=l.low=k+H|0,l.high=x+j+(k>>>0<H>>>0?1:0)|0},_doFinalize:function(){var t=this._data,e=t.words,o=8*this._nDataBytes,i=8*t.sigBytes;e[i>>>5]|=128<<24-i%32,e[31+(i+128>>>10<<5)]=o,t.sigBytes=4*e.length,this._process(),this._hash=this._hash.toX32()},blockSize:32}),t.SHA512=o._createHelper(n),t.HmacSHA512=o._createHmacHelper(n)}(),t}({}),logger={log:console.log.bind(console),debug:console.info.bind(console),info:console.info.bind(console),warn:console.warn.bind(console),error:console.error.bind(console)};function ActionManager(){this.id=CLIENT_ID,this.rank=null,this.isLeader=!1,this._pendingLocalActions=[],this._attemptedLocalActions=[],this.initialize()}function Action(t){this.id=t.id,this.data=t,this.resolve=null,this.reject=null;var o=this;this.promise=new Promise(function(t,e){o.resolve=t,o.reject=e})}ActionManager.prototype.configure=function(t){this.__ide=t},ActionManager.prototype.addActions=function(){var t=Array.prototype.slice.call(arguments),e=this;t.forEach(function(r){e[r]=function(){var t,e=Array.prototype.slice.apply(arguments),o="_"+r,i=this.ide().stage.id;return this[o]&&(e=this[o].apply(this,e)||e),t={type:r,args:e},i=ActionManager.OwnerFor[r]?ActionManager.OwnerFor[r].apply(this,t.args):ActionManager.OwnerFor.apply(this,t.args),t.owner=i,this.applyEvent(t)}})},ActionManager.prototype.addUserActions=function(){var t=Array.prototype.slice.call(arguments),e=this;t.forEach(function(i){e[i]=function(){var t,e=Array.prototype.slice.apply(arguments),o="_"+i;return this[o]&&(e=this[o].apply(this,e)||e),t={isUserAction:!0,type:i,args:e},this.applyEvent(t)}})},ActionManager.prototype._selectTab=function(t){return[t,this.ide().currentTab]},ActionManager.prototype._selectSprite=function(t){return[t.id,this.ide().currentSprite.id]},ActionManager.prototype.isUserAction=function(t){return t.isUserAction},ActionManager.prototype.initializeEventMethods=function(){this.addActions("setStageSize","addSprite","removeSprite","renameSprite","toggleDraggable","duplicateSprite","importSprites","setRotationStyle","attachParts","detachParts","addSound","renameSound","removeSound","addCostume","renameCostume","removeCostume","updateCostume","addVariable","deleteVariable","addCustomBlock","deleteCustomBlock","deleteCustomBlocks","setCustomBlockType","updateBlockLabel","deleteBlockLabel","addBlock","replaceBlock","removeBlock","setBlockPosition","setBlocksPositions","moveBlock","importBlocks","setCommentText","setSelector","setBlockSpec","addListInput","removeListInput","ringify","unringify","toggleBoolean","setColorField","setField","openProject"),this.addUserActions("selectTab","selectSprite","toggleWatcher","toggleVariableWatcher","pressStart","stopAllScripts","startScript","setSpritePosition","togglePause")},ActionManager.prototype.initializeRecords=function(){this.currentBatch=null,this.lastSeen=-1,this.lastSent=null,this.idCount=0,this.queuedActions=[],this.blockChildren={},this.blockToParent={},this.fieldValues={},this._owners={},this._blocks={},this._customBlocks={},this._customBlockOwner={},this._costumes={},this._costumeToOwner={},this._sounds={},this._soundToOwner={},this._positionOf={},this._targetOf={},this._targetFor={},this._blockToOwnerId={}},ActionManager.URL="ws://"+window.location.host,ActionManager.prototype.enableCollaboration=function(){!1===this.supportsCollaboration&&this.ide().showMessage("Collaboration not supported"),this._ws=new WebSocket(ActionManager.URL),this._enableCollaboration()},ActionManager.RECONNECT_INTERVAL=1500,ActionManager.prototype._enableCollaboration=function(){var o=this;this._ws.readyState>WebSocket.OPEN&&(this._ws=new WebSocket(ActionManager.URL)),this._ws.onopen=function(){logger.debug("websocket connected!"),o.isLeader=!1,o.supportsCollaboration=!0},this._ws.onclose=function(){(o.isLeader=!0)!==o.supportsCollaboration&&(o.supportsCollaboration=!1),o._ws&&(o.reconnectId=setTimeout(o._enableCollaboration.bind(o),ActionManager.RECONNECT_INTERVAL))},this._ws.onmessage=function(t){var e=JSON.parse(t.data);o.onMessage(e)}},ActionManager.prototype.disableCollaboration=function(){var t=this._ws;this.isCollaborating()&&(this._ws=null,t.close(),this.reconnectId&&clearTimeout(this.reconnectId),-1!==location.hash.indexOf("collaborate")&&(location.hash=""))},ActionManager.prototype.isCollaborating=function(){return null!==this._ws},ActionManager.prototype.initialize=function(){this.serializer=new SnapSerializer,this.serializer.idProperty="actionSerializationID",this._ws=null,this.supportsCollaboration=null,this.isLeader=!0,this.isApplyingAction=!1,this.initializeRecords(),this.initializeEventMethods()},ActionManager.prototype.completeAction=function(t,e){var o=this.currentEvent;if(this.currentBatch){var i=this.currentBatch.args.indexOf(o),r=this.currentBatch.args[i+1];if(r)return this._rawApplyEvent(r);o=this.currentBatch,this.currentBatch=null}if(this.isApplyingAction=!1,this.idCount=0,t||SnapUndo.record(o),this.isOwnAction(o)){var n=this.rejectPredecessorsInQueue(this._pendingLocalActions,o);n&&(t?n.reject(t):n.resolve(e))}this.afterActionApplied(o),this.currentEvent=null,this.queuedActions.length&&this.isNextAction(this.queuedActions[0])&&setTimeout(this._applyEvent.bind(this),0,this.queuedActions.shift())},ActionManager.prototype.isOwnAction=function(t){return!t.user||t.user===this.id},ActionManager.prototype.isNextAction=function(t){return t.id===this.lastSeen+1},ActionManager.prototype.isPreviousAction=function(t){return t.id<this.lastSeen+1},ActionManager.prototype.isAlwaysAllowed=function(t){return"openProject"===t.type},ActionManager.prototype.joinSession=function(t,e){SnapActions.id?this._joinSession(t,e):this.onconnect=this._joinSession.bind(this,t,e)},ActionManager.prototype._joinSession=function(t,e){var o=new XMLHttpRequest;o.open("POST",window.location.origin+"/collaboration/join?id="+encodeURIComponent(SnapActions.id)+"&sessionId="+encodeURIComponent(t),!0),o.withCredentials=!0,o.onreadystatechange=function(){if(4===o.readyState&&0===o.responseText.indexOf("ERROR"))return e(o.responseText,"Collaborate")},o.send(),this.onconnect=null},Action.prototype.equals=function(o){var i=this;return o instanceof Action&&(o=o.data),["id","user","time"].reduce(function(t,e){return t&&o[e]===i.data[e]},!0)},ActionManager.prototype.applyEvent=function(t){if(t.user=this.id,t.username=SnapCloud.username,t.id=this.lastSeen+1,t.time=t.time||Date.now(),!t.replayType||this.lastSent!==t.id){var e=new Action(t);return this.isUserAction(t)?this.submitAction(t):(this._attemptedLocalActions.push(e),this.submitIfAllowed(t)),e.promise}},ActionManager.prototype.submitIfAllowed=function(t){var e=this,o=this.ide();if(this.isAlwaysAllowed(t))return this.submitAction(t);o.isReplayMode&&!t.isReplay?o.promptExitReplay(function(){e.submitIfAllowed(t)}):this.submitAction(t)},ActionManager.prototype._getMethodFor=function(t){return"on"+t.substring(0,1).toUpperCase()+t.substring(1)},ActionManager.prototype.acceptEvent=function(t){t.id=t.id||this.lastSeen+1,this.send(t),setTimeout(this.onReceiveAction.bind(this),0,t)},ActionManager.prototype._isBatchEvent=function(t){return"batch"===t.type},ActionManager.prototype.onReceiveAction=function(t){if(!this.isPreviousAction(t)||this.isAlwaysAllowed(t))if(this.isUserAction(t))SnapUndo.contains(t)||SnapUndo.record(t);else{if(this.isOwnAction(t)){var e=this.rejectPredecessorsInQueue(this._attemptedLocalActions,t);e?this._pendingLocalActions.push(e):console.error("missing local action for",t)}!this.isNextAction(t)&&!this.isAlwaysAllowed(t)||this.isApplyingAction?this.addActionToQueue(t):this._applyEvent(t)}},ActionManager.prototype.rejectPredecessorsInQueue=function(t,e){var o=t.find(function(t){return t.equals(e)});if(o){for(var i=new Error("Action Rejected (concurrent action accepted)."),r=t.shift();r!==o;)r.reject(i),r=t.shift();return o}console.error("could not find local action in queue",e)},ActionManager.prototype.addActionToQueue=function(t){for(var e=0,o=this.queuedActions.length;e<o&&this.queuedActions[e].id<t.id;)e++;this.queuedActions[e]&&t.id===this.queuedActions[e].id||this.queuedActions.splice(e,0,t)},ActionManager.prototype._applyEvent=function(t){logger.debug('received "'+t.type+'" event '+t.id+":",t),this.currentEvent=t,this.isApplyingAction=!0,this.lastSeen=this.currentEvent.id,this._isBatchEvent(t)?(this.currentBatch=t,this._rawApplyEvent(t.args[0])):(this.currentBatch=null,this._rawApplyEvent(t))},ActionManager.prototype._rawApplyEvent=function(t){var e=this._getMethodFor(t.type);this.currentEvent=t;try{this[e].apply(this,t.args)}catch(t){this.completeAction(t)}},ActionManager.prototype.submitAction=function(t){this.isLeader||!this.isCollaborating()||this.isAlwaysAllowed(t)?this.acceptEvent(t):this.send(t)},ActionManager.prototype.send=function(t){var e=this._ws&&this._ws.readyState===WebSocket.OPEN;t.id=t.id||this.lastSeen+1,this.isUserAction(t)||(this.lastSent=t.id),this.isCollaborating()&&"openProject"!==t.type&&e&&this._ws.send(JSON.stringify(t))},ActionManager.prototype.newId=function(){var t="item_"+this.lastSeen;return 0!==this.idCount&&(t+="_"+this.idCount),this.idCount++,t},ActionManager.prototype.getId=function(t,e){for(var o="";!t.id;){if(!(t.parent instanceof SyntaxElementMorph))return null;if(o=t.parent.inputs().indexOf(t)+"/"+o,!(t=t.parent))throw Error("Cannot get id from element")}return o=t.id+"/"+o,void 0!==e&&(o+=e+"/"),o},ActionManager.prototype.serialize=function(t){var e=this.serializer.serialize(t);return this.serializer.flush(),e},ActionManager.prototype.serializeBlock=function(t,e,o){if(t.id&&!e)return t.id;if(t instanceof CommentMorph)return t.toXML(this.serializer);this.serializer.isSavingCustomBlockOwners=!1;var i=o?"<script>"+t.toBlockXML(this.serializer)+"<\/script>":t.toScriptXML(this.serializer);return this.serializer.flush(),this.serializer.isSavingCustomBlockOwners=!0,i},ActionManager.prototype.deserializeBlock=function(t){return this.serializer.project=this.ide(),"<"!==t[0]?this.getBlockFromId(t):0===t.indexOf("<script>")?this.serializer.loadScript(this.serializer.parse(t)):this.serializer.loadComment(this.serializer.parse(t))},ActionManager.prototype.registerOwner=function(t,e){t.id=e||this.newId(),this._owners[t.id]=t},ActionManager.prototype.getOwnerFromId=function(t){return this._owners[t]},ActionManager.prototype.getBlockOwnerId=function(t){for(var e=t.id;!e&&t;)e=t.id,t=t.parent;return this._blockToOwnerId[e]},ActionManager.prototype.getStandardPosition=function(t,e){var o=SyntaxElementMorph.prototype.scale;return e=e.subtract(t.topLeft()).divideBy(o)},ActionManager.prototype._getStatementIds=function(t){for(var e=[];t;)e.push(t.id),t=t.nextBlock?t.nextBlock():null;return e},ActionManager.prototype._addBlock=function(t,e,o,i){var r,n=this.getStandardPosition(e,o);return this._idBlocks(t),r=this._getStatementIds(t),[this.serializeBlock(t,!0),i||e.owner.id,n.x,n.y,r]},ActionManager.prototype._replaceBlock=function(t,e){return e.id=this.newId(),[this.serializeBlock(t,!0),this.serializeBlock(e,!0)]},ActionManager.prototype._removeBlock=function(t,e){var o=this.serializeBlock(t,!0,e),i=this._positionOf[t.id],r=this._targetOf[t.id],n=this._blockToOwnerId[t.id],s=[t.id,e];!r||ActionManager.isWeakTarget(r)&&i?i&&s.push(i.y,i.x,n,o):s.push(this._targetOf[t.id],o);var a,h=[];if(this._targetFor[t.id])for(var l=(a=Object.keys(this._targetFor[t.id])).length;l--;)h.push([a[l],this._targetFor[t.id][a[l]]]);return s.push(h),s},ActionManager.isWeakTarget=function(t){return"top"===t.loc||"wrap"===t.loc},ActionManager.prototype._getBlockState=function(t){var e,o=this._targetOf[t],i=this._positionOf[t];return(e=!o||ActionManager.isWeakTarget(o)&&i?i?[i.x,i.y]:[]:[o]).unshift(t),e},ActionManager.prototype._setBlockPosition=function(t,e){var o=t.id,i=t.parentThatIsA(ScriptsMorph),r=this.getStandardPosition(i,e),n=this._getBlockState(o);return[o,r.x,r.y,n]},ActionManager.prototype._setBlocksPositions=function(t,e){for(var o,i=this,r=this.getBlockFromId(t[0]).parentThatIsA(ScriptsMorph),n=t.length;n--;)e[n]||(t.splice(n,1),e.splice(n,1));return o=t.map(function(t){return i._positionOf[t]}),[t,e.map(function(t){return i.getStandardPosition(r,t)}),o]},ActionManager.prototype._addCustomBlock=function(t,e){var o;return t.id=this.newId(),o=this.serialize(t),t.isGlobal&&(e=this.ide().stage),[e.id,o,t.isGlobal]},ActionManager.prototype._deleteCustomBlock=function(t){var e=this._customBlockOwner[t.id],o=this.serialize(t);return[t.id,e.id,o,t.isGlobal]},ActionManager.prototype._deleteCustomBlocks=function(t){for(var e=[],o=[],i=t.length;i--;)e.push(this.serialize(t[i])),o.push(t[i].id);return[o,e="<blocks>"+e.join("")+"</blocks>"]},ActionManager.prototype._importBlocks=function(t,e){var o,i=this.uniqueIdForImport(t);return o=i.children.map(function(t){return t.attributes.collabId}),[t=i.toString(),e,o]},ActionManager.prototype._setCustomBlockType=function(t,e,o){return[t.id,e,o,t.category,t.type]},ActionManager.prototype._deleteBlockLabel=function(t,e){var o=e.parent.children.indexOf(e);return[t.id,o,e.fragment.type,e.fragment.labelString]},ActionManager.prototype._updateBlockLabel=function(t,e,o){var i=e.parent.children.indexOf(e);return console.assert(-1<i,"Cannot find the fragment!"),[t.id,i,o.type,o.labelString,o.defaultValue,o.options,o.isReadOnly,e.fragment.type,e.fragment.labelString,e.fragment.defaultValue,e.fragment.options,e.fragment.isReadOnly]},ActionManager.prototype._startScript=function(t,e){var o=!e;return[t.id,o]},ActionManager.prototype._setSpritePosition=function(t){return[t.id,t.xPosition(),t.yPosition()]},ActionManager.prototype._setStageSize=function(t,e){return[t,e,StageMorph.prototype.dimensions.y,StageMorph.prototype.dimensions.x]},ActionManager.prototype._serializeMoveTarget=function(t,e){return t instanceof CommandBlockMorph?e.element.id?e.element=e.element.id:e.element instanceof PrototypeHatBlockMorph?e.element=e.element.definition.id:e.element=this.getId(e.element):e=t instanceof ReporterBlockMorph?this.getId(e):e.id,e},ActionManager.prototype._getSpliceEvent=function(t){var e,o;return"top"===t.loc?(e=t.element.parent instanceof BlockMorph?t.element.parent:null,o=t.element):"bottom"===t.loc&&(e=t.element,o="slot"===t.type?t.element.nestedBlock():t.element.nextBlock()),e&&o?{type:"moveBlock",args:[o.id,t]}:null},ActionManager.prototype._moveBlock=function(t,e){var o,i,r,n,s,a,h=!t.id;return e instanceof ReporterBlockMorph?n=[this.serializeBlock(e,e instanceof RingMorph),this._getCurrentTarget(e)]:"top"!==e.loc&&"wrap"!==e.loc||(s=this._getBlockState(e.element.id)),o=this._getSpliceEvent(e),e=this._serializeMoveTarget(t,e),h&&this._idBlocks(t),(a=[this.serializeBlock(t,h),e]).push(o),i="top"===e.loc?t.topBlock().id:t.id,r=this._getBlockState(i),h&&(r=[this._getStatementIds(t)],t.destroy()),a.push(r),n?a.push(n):s&&a.push(s),a},ActionManager.prototype._setField=function(t,e){return[this.getId(t),e,t.contents().text]},ActionManager.prototype._setColorField=function(t,e){var o=this.getId(t);return[o,e,this.fieldValues[o]]},ActionManager.prototype._toggleBoolean=function(t,e){var o=!1,i=this.getId(t);return t.isStatic?o=!e:!0===e?o=null:!1===e&&(o=!0),[i,e,o]},ActionManager.prototype._setCommentText=function(t,e){var o=t.lastValue;return[t.id,e,o]},ActionManager.prototype._unringify=function(t){for(var e=this.getParentWithId(t),o=e.parentThatIsA(RingMorph);e!==o;)t=e,e=this.getParentWithId(t);return[t.id,o.id]},ActionManager.prototype.getParentWithId=function(t){for(;t.parent&&!t.parent.id;)t=t.parent;return t.parent},ActionManager.prototype._ringify=function(t){for(var e=this.newId(),o=this.getParentWithId(t);o instanceof RingMorph;)t=o,o=this.getParentWithId(t);return[t.id,e]},ActionManager.prototype._setSelector=function(t,e){return[this.getId(t),e,t.selector]},ActionManager.prototype._setBlockSpec=function(t,e){return[this.getId(t),e,t.blockSpec]},ActionManager.prototype._toggleDraggable=function(t,e){return[t.id,e]},ActionManager.prototype._setRotationStyle=function(t,e){return[t.id,e,t.rotationStyle]},ActionManager.prototype._addListInput=ActionManager.prototype._removeListInput=function(t,e){return[this.getId(t),e]},ActionManager.prototype._addSound=function(t,e,o){var i;t.id=this.newId();return 10<2*t.audio.src.length/1e6&&(logger.error("audio file is too big",t),this.ide().simpleNotification("Audio file is too big."),t.audio.src=SERVER_URL+"/Sounds/Meow.wav",t.name="BigFileError"),i=[t.toXML(this.serializer).replace("~",""),e.id],o&&i.push(this.id),i},ActionManager.prototype._removeSound=function(t){return[t.id,t.toXML(this.serializer).replace("~",""),this._soundToOwner[t.id].id]},ActionManager.prototype._renameSound=function(t,e){return[t.id,e,t.name]},ActionManager.prototype._addCostume=function(t,e,o){var i;return t.id=this.newId(),i=[t.toXML(this.serializer).replace("~",""),e.id],o&&i.push(this.id),i},ActionManager.prototype._removeCostume=function(t){return[t.id,t.toXML(this.serializer).replace("~",""),this._costumeToOwner[t.id].id]},ActionManager.prototype._renameCostume=function(t,e){return[t.id,e,t.name]},ActionManager.prototype._updateCostume=function(t,e){return[e.id,e.toXML(this.serializer).replace("~",""),t.toXML(this.serializer).replace("~","")]},ActionManager.prototype._addSprite=function(t){var e=this.ide().stage;return t.parent=e,t.id=this.newId(),["<sprites>"+this.serialize(t)+"</sprites>",this.id,t.id]},ActionManager.prototype._attachParts=function(t,e){var o=e.map(function(t){return t.id});return[t.id,o]},ActionManager.prototype._detachParts=function(t){return[t.map(function(t){return t.id}),t.map(function(t){return t.anchor?t.anchor.id:null})]},ActionManager.prototype._openProject=function(t){return this.initializeRecords(),[t]},ActionManager.prototype.uniqueIdForImport=function(t){for(var e=this.serializer.parse(t),o=e.allChildren(),i=o.length;i--;)o[i].attributes&&(o[i].attributes.collabId=this.newId());return e},ActionManager.prototype._removeSprite=function(t){var e="<sprites>"+this.serialize(t)+"</sprites>";return[t.id,e]},ActionManager.prototype._renameSprite=function(t,e){return[t.id,e,t.name]},ActionManager.prototype._duplicateSprite=function(t){var e,o,i=this.newId(),r=t.copy(),n=this.ide();return r.id=i,r.setName(n.newSpriteName(t.name)),r.parent=n.stage,o=this.serialize(r),e="<sprites>"+this._getOpeningSpriteTag(o),"</sprites>",[this.uniqueIdForImport(o).toString().replace(/<sprite.*?[^\\]>/,e)+"</sprites>",null,i]},ActionManager.prototype._getOpeningSpriteTag=function(t){return t.match(/<sprite\b[^>]+[^\\]>/)[0]},ActionManager.prototype._importSprites=function(t){var e,o=this.uniqueIdForImport(t);return e=o.children.map(function(t){return t.attributes.collabId}),[t=o.toString(),e]},ActionManager.prototype._onSetBlockPosition=function(t,e,o,i){var r,n,s,a,h=this,l=new Point(e,o),p=this.getBlockFromId(t),c=function(){h.disconnectBlock(p,s),p.justDropped&&p.justDropped(),p.changed(),p.removeShadow(),h.updateCommentsPositions(p),h.__updateBlockDefinitions(p),h.__updateActiveEditor(p.id),i()};if(this.ensureNotDragging(p),this._targetFor[t])for(var u=(r=Object.keys(this._targetFor[t])).length;u--;)"top"===(n=this._targetFor[t][r[u]]).loc&&this.__clearTarget(this.__targetId(n));this.__clearTarget(t),console.assert(p,'Block "'+t+'" does not exist! Cannot set position'),l=new Point(e,o),a=p.parentThatIsA(BlockEditorMorph),this._positionOf[t]=l,a&&(s=a.body.contents),s=p.parentThatIsA(ScriptsMorph),l=this.getAdjustedPosition(l,s),this.canAnimate(this.getBlockOwnerId(p))?p.glideTo(l,null,null,function(){try{c()}catch(t){i(t)}}):(p.setPosition(l),c())},ActionManager.prototype.onSetBlocksPositions=function(t,e){for(var o=this,i=0,r=function(){++i===t.length&&o.completeAction()},n=t.length;n--;)this._onSetBlockPosition(t[n],e[n].x,e[n].y,r)},ActionManager.prototype.getAdjustedPosition=function(t,e){var o=SyntaxElementMorph.prototype.scale;return t=t.multiplyBy(o).add(e.topLeft())},ActionManager.prototype._idBlocks=function(t,e){var o=this,i=[];return this.traverse(t,function(t){t.isDraggable=!0,t.isTemplate=!1,t.id=o.newId(),i.push(t.id)}),e?i:t},ActionManager.prototype.registerBlocks=function(t,e,o){var i=this,r=t;return this.traverse(r,function(t){i._registerBlockState(t,o),i._blockToOwnerId[t.id]=e}),t},ActionManager.prototype.onReplaceBlock=function(t,e){var o,i,r=this;t=this.deserializeBlock(t),o=this._blockToOwnerId[t.id],i=this._positionOf[t.id],this._onRemoveBlock(t.id,!0,function(t){if(t)return r.completeAction(t);r._onAddBlock(e,o,i.x,i.y,function(t,e){r.completeAction(t,e)})})},ActionManager.prototype._onAddBlock=function(t,e,o,i,r){var n,s=this,a=this.ide(),h=this._owners[e],l=new Point(o,i),p=function(){n.fixChildrensBlockColor&&n.fixChildrensBlockColor(!0),n.allComments&&n.allComments().forEach(function(t){t.align(n)}),s.registerBlocks(n,h.id),s.__updateScriptsMorph(n),s.__updateActiveEditor(n.id),r(null,n)};if((n=this.deserializeBlock(t)).snapSound&&n.snapSound.play(),this._customBlocks[e]){var c=this._getCustomBlockEditor(e),u=c.body.contents;l=this.getAdjustedPosition(l,u),n.setPosition(l),u.add(n),c.updateDefinition(),h=this._customBlocks[e],p()}else if(l=this.getAdjustedPosition(l,h.scripts),this.canAnimate(h.id)){var d=a.palette;n.setPosition(d.position().add(new Point(d.left()-n.width(),d.height()/4))),d.add(n),n.glideTo(l,null,null,function(){try{h.scripts.add(n),p()}catch(t){r(t)}})}else n.setPosition(l),h.scripts.add(n),n.changed(),p();if("receiveCondition"===n.selector){var g=a.stage;g&&(g.enableCustomHatBlocks=!0,g.threads.pauseCustomHatBlocks=!1,a.controlBar.stopButton.refresh())}},ActionManager.prototype.onAddBlock=function(t,e,o,i){var r=this;this._onAddBlock(t,e,o,i,function(t,e){r.completeAction(t,e)})},ActionManager.prototype.world=function(){var t=Object.keys(this._owners)[0],e=this._owners[t];return e?e.parentThatIsA(WorldMorph):null},ActionManager.prototype.isEditorOpen=function(e){return!!detect(this.world()?this.world().children:[],function(t){return t instanceof BlockEditorMorph&&t.definition.id===e})},ActionManager.prototype._getCustomBlockEditor=function(e,t){var o=this.world()?this.world().children:[],i=this._customBlockOwner[e],r=this._customBlocks[e],n=detect(o,function(t){return t instanceof BlockEditorMorph&&t.definition.id===e});return!n&&r&&(t&&(n=t.parentThatIsA(BlockEditorMorph)),n||((n=new BlockEditorMorph(r,i)).popUp(!0),n.setInitialDimensions(!0),n.cancel())),n},ActionManager.prototype.getBlockFromId=function(t){var e,o,i=t.split("/"),r=i.shift(),n=this._blocks[r];if(this._customBlocks[r]&&(n=this._getCustomBlockEditor(r).body.contents.children.find(function(t){return t instanceof PrototypeHatBlockMorph})),o=n.parentThatIsA(BlockEditorMorph)){var s,a,h,l=!1;if(e=o.definition.id,o!==(s=this._getCustomBlockEditor(e)))for(a=(o=s).body.contents.children.slice();!l&&a.length;){h=[];for(var p=a.length;p--;)if(a[p]){if(a[p].id===r){this._blocks[r]=a[p],n=this._blocks[r],l=!0;break}a[p].inputs&&(h=h.concat(a[p].inputs())),a[p].nextBlock&&h.push(a[p].nextBlock())}a=h}}for(p=0;p<i.length;p++)i[p]&&(n=n.inputs()[i[p]]);return n},ActionManager.prototype.onMoveBlock=function(t,e){var o,i,r,n,s=this,a=this.deserializeBlock(t),h=!this._blocks[a.id],l=null,p=copy(e);this.ensureNotDragging(a),this.__recordTarget(a.id,e),a instanceof CommandBlockMorph?(p.element=this.getBlockFromId(p.element),n=p.element,l="bottom"===p.loc?n.nextBlock&&n.nextBlock():n,a.parent&&("bottom"===p.loc?this.disconnectBlock(a,r):"top"!==p.loc||a.parent instanceof ScriptsMorph||this.disconnectBlock(a,r)),p.point=new Point(p.point.x,p.point.y)):a instanceof ReporterBlockMorph||a instanceof CommentMorph?(this.disconnectBlock(a,r),(n=p=this.getBlockFromId(p))instanceof RingMorph&&this.__clearBlockRecords(p.id)):logger.error('Unsupported "onMoveBlock":',a),this.ensureNotDragging(n);var c=this.getBlockOwnerId(n);if(r=n.parentThatIsA(ScriptsMorph),a instanceof ReporterBlockMorph&&p instanceof ReporterBlockMorph&&this.__recordTarget(a.id,this._getCurrentTarget(p)),o=!r,r=r||this.getOwnerFromId(c).scripts,i=function(){if(h&&!o?r.add(a):a.parent&&a.parent.reactToGrabOf&&a.parent.reactToGrabOf(a),a.snap(p),o||r.drawNew(),h&&(s._positionOf[a.id]=s.getStandardPosition(r,a.position()),s.registerBlocks(a,c)),p instanceof ReporterBlockMorph&&(s.__clearTarget(p.id),s._positionOf[p.id]=s.getStandardPosition(r,p.position())),ActionManager.isWeakTarget(p)){var t=a.topBlock();s._positionOf[t.id]=s.getStandardPosition(r,t.position())}l&&s.__recordTarget(l.id,s._getCurrentTarget(l)),a.fixChildrensBlockColor&&a.fixChildrensBlockColor(!0),s.updateCommentsPositions(a),s.__updateBlockDefinitions(a),s.__updateActiveEditor(a.id),s.__updateScriptsMorph(a),s.completeAction(null,a)},h&&(this.ide().palette.add(a),a.setPosition(this.blockInitPosition())),this.canAnimate(c)){var u=this.computeMovePosition(a,p);a.glideTo(u,null,null,function(){try{i()}catch(t){s.completeAction(t)}})}else i()},ActionManager.prototype.computeMovePosition=function(t,e){var o,i,r;if(t instanceof CommandBlockMorph)return o=e.element,"bottom"===e.loc?"slot"===e.type?o instanceof CSlotMorph?new Point(o.left()+o.inset,o.top()+o.corner):new Point(o.left()+o.edge+o.rfBorder,o.top()+o.edge+o.rfBorder):new Point(e.element.left(),e.element.bottom()-e.element.corner):"top"===e.loc?(i=t.bottomBlock().bottom()-t.bottom(),new Point(o.left(),o.top()+t.corner-i-t.height())):"wrap"===e.loc?(r=detect(t.inputs(),function(t){return t instanceof CSlotMorph}),t.position().add(e.point.subtract(r.slotAttachPoint()))):void 0;if(t instanceof ReporterBlockMorph){if(e instanceof CommandSlotMorph){var n=e.nestedBlock();if(n)return n.position().add(n.extent())}return e.position()}var s,a,h,l=e.topBlock();return a=e.top()+e.corner,h=a+t.height(),s=l.allChildren().filter(function(t){return t instanceof BlockMorph&&t.bottom()>a&&t.top()<h}),new Point(Math.max.apply(null,s.map(function(t){return t.right()}))+5,a)},ActionManager.prototype.blockInitPosition=function(){var t=this.ide().palette;return new Point(t.width()/2,t.height()/4)},ActionManager.prototype.ensureNotDragging=function(t){var e=t.parentThatIsA(HandMorph);if(e){var o=e.grabOrigin;(t=e.children[0]).cachedFullImage=null,t.cachedFullBounds=null,t.changed(),t.removeShadow(),e.children=[],e.destroyTemporaries(),e.contextMenuEnabled=!0,e.morphToGrab=null,e.grabPosition=null,t.justDropped(e),t.setPosition(o.origin.position().add(o.position)),o.origin.add(t),t.justDropped&&t.justDropped(),o.origin.reactToDropOf&&o.origin.reactToDropOf(t)}},ActionManager.prototype._onRemoveBlock=function(t,e,o){var i,r,n=this,s=this.getBlockFromId(t),a=e&&s.userDestroy?"userDestroy":"destroy",h=function(){s[a](),n.__updateBlockDefinitions(s),o()};if(this.ensureNotDragging(s),i=s.parentThatIsA(ScriptsMorph),r=s.parent,s){s.prepareToBeGrabbed&&s.prepareToBeGrabbed(this.world().hand);var l=s;"userDestroy"===a&&(l=s.inputs().map(function(t){return!t.id&&t.children?t.children:[t]}).reduce(function(t,e){return t.concat(e)},[]),this.__clearBlockRecords(t)),this.traverse(l,function(t){n.__clearBlockRecords(t.id)});var p=s.nextBlock&&s.nextBlock();if(this.canAnimate(this.getBlockOwnerId(s))&&("destroy"===a||!p)){var c=this.ide().palette;delete s.id,c.add(s),s.glideTo(this.blockInitPosition(),null,null,function(){try{h()}catch(t){o(t)}})}else h();r&&(r.reactToGrabOf&&r.reactToGrabOf(s),r.fixLayout&&r.fixLayout(),r.changed()),i&&(i.drawNew(),i.changed())}},ActionManager.prototype.onRemoveBlock=function(t,e){var o=this;this._onRemoveBlock(t,e,function(){o.completeAction()})},ActionManager.prototype.canAnimate=function(t){return(this.getOwnerFromId(t)===this.ide().currentSprite||this.isEditorOpen(t))&&(this.ide().isReplayMode||this.currentEvent.replayType||this.currentEvent.user!==this.id)},ActionManager.prototype.__updateScriptsMorph=function(t){var e=t.parentThatIsA(ScriptsMorph);!e||(e.adjustBounds(),e.drawNew(),e.changed())},ActionManager.prototype.__updateBlockDefinitions=function(t){var e=t.parentThatIsA(BlockEditorMorph);e&&e.updateDefinition()},ActionManager.prototype.onSetBlockPosition=function(t,e,o){var i=this;this._onSetBlockPosition(t,e,o,function(){i.completeAction()})},ActionManager.prototype.updateCommentsPositions=function(t){if(t.topBlock){var e=t.topBlock();e.allComments().forEach(function(t){t.align(e)})}},ActionManager.prototype.getFieldValue=function(t,e){var o=this.getId(t,e);return this.fieldValues[o]instanceof StringMorph?this.fieldValues[o].text:this.fieldValues[o]},ActionManager.prototype.disconnectBlock=function(t,e){var o=t.parent;e=e||t.parentThatIsA(ScriptsMorph),t.prepareToBeGrabbed(this.world().hand),!o||o instanceof ScriptsMorph||(e.add(t),o.reactToGrabOf&&o.reactToGrabOf(t),o.fixLayout&&o.fixLayout(),o.changed(),e&&(e.drawNew(),e.changed())),t.fixBlockColor&&t.fixBlockColor()},ActionManager.prototype.onAddListInput=function(t,e){var o=this.getBlockFromId(t);this.ensureNotDragging(o),e=e||1;for(var i=0;i<e;i++)o.addInput();this.__updateScriptsMorph(o),this.__updateBlockDefinitions(o),this.completeAction()},ActionManager.prototype.onRemoveListInput=function(t,e){var o=this.getBlockFromId(t);this.ensureNotDragging(o),e=e||1;for(var i=0;i<e;i++)o.removeInput();o.changed(),this.__updateScriptsMorph(o),this.__updateBlockDefinitions(o),this.completeAction()},ActionManager.prototype.onSetBlockSpec=function(t,e){var o=this.getBlockFromId(t);this.ensureNotDragging(o),o.userSetSpec(e),this.__updateBlockDefinitions(o),this.completeAction()},ActionManager.prototype.onSetField=function(t,e){var o=this.getBlockFromId(t);console.assert(o instanceof InputSlotMorph,"Unexpected block type: "+o.constructor),this.ensureNotDragging(o),this.fieldValues[t]=e,o.setContents(e),this.__updateBlockDefinitions(o),this.completeAction()},ActionManager.prototype.onSetColorField=function(t,e){var o,i=this.getBlockFromId(t);this.ensureNotDragging(i),o=new Color((e=e||{}).r,e.g,e.b,e.a),i.setColor(o),this.fieldValues[t]=o,this.__updateBlockDefinitions(i),this.completeAction()},ActionManager.prototype.onSetCommentText=function(t,e){var o=this.getBlockFromId(t);this.ensureNotDragging(o),o.contents.text=e,o.contents.drawNew(),o.contents.changed(),o.layoutChanged(),o.lastValue=e,this.__updateBlockDefinitions(o),this.completeAction()},ActionManager.prototype.onSetSelector=function(t,e){var o=this.getBlockFromId(t),i=this;this.ensureNotDragging(o),o.setSelector(e),o.changed(),this.traverse(o,function(t){i._blocks[t.id]=t}),this.__updateBlockDefinitions(o),this.completeAction()},ActionManager.prototype.onAddVariable=function(t,e){var o,i="true"===e.toString();(o=i?this._owners[Object.keys(this._owners)[0]]:this._owners[e]).addVariable(t,i),o.showingVariableWatcher(t,i)||o.toggleVariableWatcher(t,i);var r=o.parentThatIsA(IDE_Morph);r.flushBlocksCache("variables"),r.refreshPalette(),this.completeAction()},ActionManager.prototype.onDeleteVariable=function(t,e){("true"===e.toString()?this._owners[Object.keys(this._owners)[0]]:this._owners[e]).deleteVariable(t),this.completeAction()},ActionManager.prototype.onRingify=function(t,e){var o,i,r=this.getBlockFromId(t),n=this._blockToOwnerId[r.id];if(r&&(this.ensureNotDragging(r),o=(i=r.ringify()).parentThatIsA(ScriptsMorph),i.id=e,this._blocks[i.id]=i,this._blockToOwnerId[i.id]=n,this._positionOf[i.id]=this.getStandardPosition(o,i.position()),r instanceof ReporterBlockMorph&&this._targetOf[r.id])){this.__recordTarget(i.id,this._targetOf[r.id]);var s=this.getId(r.parent,r.parent.inputs().indexOf(r));this.__recordTarget(r.id,s)}this.__updateBlockDefinitions(r),this.completeAction()},ActionManager.prototype.onUnringify=function(t){var e=this.getBlockFromId(t);if(e){this.ensureNotDragging(e);var o=e.unringify();delete this._blocks[o.id]}this.__updateBlockDefinitions(e),this.completeAction()},ActionManager.prototype.onToggleBoolean=function(t,e){var o,i=this.getBlockFromId(t);for("boolean"!=typeof e&&(e=null);o!==e;)o=i.value,i.toggleValue();isNil(i.value)||i.reactToSliderEdit(),this.__updateBlockDefinitions(i),this.completeAction()},ActionManager.prototype.onAddCustomBlock=function(t,e,o){var i,r=this._owners[t],n=this.ide();(i=this.serializer.loadCustomBlock(this.serializer.parse(e))).receiver=r,(i.isGlobal=o)?(r.globalBlocks.push(i),n.currentSprite.paletteCache={}):r.customBlocks.push(i),this.loadCustomBlocks([i],r),r.paletteCache={},n.refreshPalette(),this.completeAction(null,i)},ActionManager.prototype.onDeleteCustomBlocks=function(t){var e=this,o=this.ide().stage.id;t.forEach(function(t){e._onDeleteCustomBlock(t,o)}),this.completeAction()},ActionManager.prototype._onDeleteCustomBlock=function(t,e){var o,i,r,n=this._customBlocks[t],s=this._owners[e];s.deleteAllBlockInstances(n),n.isGlobal?-1!==(r=(o=this.ide().stage).globalBlocks.indexOf(n))&&o.globalBlocks.splice(r,1):-1!==(r=s.customBlocks.indexOf(n))&&s.customBlocks.splice(r,1),(i=s.parentThatIsA(IDE_Morph))&&(i.flushPaletteCache(),i.refreshPalette())},ActionManager.prototype.onDeleteCustomBlock=function(t,e){this._onDeleteCustomBlock(t,e),this.completeAction()},ActionManager.prototype._getCustomCmdBlock=function(t){var e=detect(this._getCustomBlockEditor(t).body.contents.children,function(t){return t instanceof PrototypeHatBlockMorph}),o=e.inputs()[0];return console.assert(1===e.inputs().length),o},ActionManager.prototype._getFragment=function(t,e){return this._getCustomCmdBlock(t).children[e]},ActionManager.prototype.onUpdateBlockLabel=function(t,e,o,i,r,n,s){var a=new BlockLabelFragment(i),h=this._getFragment(t,e),l=h.parentThatIsA(BlockEditorMorph);a.type=o,a.options=n||"",a.defaultValue=r||"",a.isReadOnly=!!s,h.updateBlockLabel(a),l.updateDefinition(),this.completeAction()},ActionManager.prototype.onDeleteBlockLabel=function(t,e){var o=this._getFragment(t,e),i=o.parentThatIsA(BlockEditorMorph);o.fragment.isDeleted=!0,o.updateBlockLabel(o.fragment),i.updateDefinition(),this.completeAction()},ActionManager.prototype.onSetCustomBlockType=function(t,e,o){var i=this._getCustomCmdBlock(t),r=i.parentThatIsA(PrototypeHatBlockMorph),n=i.parentThatIsA(BlockEditorMorph),s=this._customBlocks[t];r.blockCategory=s.category=e,r.type=s.type=o,n.updateDefinition(),i.refreshPrototype(),this.completeAction()},ActionManager.prototype.ide=function(){return this.__ide},ActionManager.prototype._loadCostume=function(t,e){var o,i=this.serializer.parse(t),r=this.serializer.loadValue(i),n=function(){r.loaded=!0,o&&o(),e(r)};!0===r.loaded?n():(o=r.loaded,r.loaded=n)},ActionManager.prototype.onDuplicateSprite=ActionManager.prototype.onAddSprite=function(t,e){var o,i,r=this.ide();i=(o=this.serializer.loadSprites(t,r))[o.length-1],e===this.id&&r.selectSprite(i),this.completeAction(null,i)},ActionManager.prototype.onAttachParts=function(t,e){var o,i=this,r=this.getOwnerFromId(t);e.forEach(function(t){o=i.getOwnerFromId(t),r.attachPart(o)}),this.completeAction()},ActionManager.prototype.onDetachParts=function(t){var e=this;t.forEach(function(t){e.getOwnerFromId(t).detachFromAnchor()}),this.completeAction()},ActionManager.prototype.onRemoveSprite=function(t){var e=this._owners[t];this.ide().removeSprite(e),this.__clearOwnerRecords(t),this.completeAction()},ActionManager.prototype.onRenameSprite=function(t,e){var o=this._owners[t],i=this.ide();o.setName(e),i.currentSprite===o&&i.spriteBar.nameField.setContents(e),this.completeAction(null,e)},ActionManager.prototype.onToggleDraggable=function(t,e){var o=this._owners[t],i=this.ide();o.isDraggable=e,i.currentSprite===o&&i.spriteBar.padlock.refresh(),this.completeAction()},ActionManager.prototype._registerCostume=function(t,e){this._costumes[t.id]=t,this._costumeToOwner[t.id]=e},ActionManager.prototype.onAddCostume=function(t,e,o){var i=this.ide(),r=this._owners[e],n=this;this._loadCostume(t,function(t){r.addCostume(t),i.spriteEditor instanceof WardrobeMorph&&i.spriteEditor.updateList(),i&&i.currentSprite===r&&i.currentSprite.wearCostume(t),n._registerCostume(t,r),o===n.id&&i.spriteBar.tabBar.tabTo("costumes")}),n.__updateActiveEditor(),this.completeAction()},ActionManager.prototype.onUpdateCostume=function(o,t){var i=this.ide(),r=this._costumeToOwner[o],n=this,s=i.parentThatIsA(WorldMorph);this._loadCostume(t,function(t){var e=n._costumes[o];e.rotationCenter=t.rotationCenter,e.contents=t.contents,e.version=Date.now(),s.changed(),i.currentSprite===r&&i.currentSprite.wearCostume(e),i.hasChangedMedia=!0}),this.__updateActiveEditor(o),this.completeAction()},ActionManager.prototype.onRemoveCostume=function(t){var e=this._costumes[t],o=this._costumeToOwner[t],i=o.costumes.asArray().indexOf(e),r=this.ide();o.costumes.remove(i+1),r.spriteEditor instanceof WardrobeMorph&&r.spriteEditor.updateList(),o.costume===e&&o.wearCostume(null),this.__updateActiveEditor(t),this.__clearCostumeRecords(t),this.completeAction()},ActionManager.prototype.onRenameCostume=function(t,e){var o=this._costumes[t],i=this.ide();o.name=e,o.version=Date.now(),i.hasChangedMedia=!0,this.__updateActiveEditor(t),this.completeAction(null,o)},ActionManager.prototype.onAddSound=function(t,e,o){var i=this._owners[e],r=this.serializer.loadValue(this.serializer.parse(t)),n=this.ide();i.addSound(r),n.hasChangedMedia=!0,this._sounds[r.id]=r,this._soundToOwner[r.id]=i,o===this.id&&n.spriteBar.tabBar.tabTo("sounds"),n.currentSprite===i&&n.spriteEditor instanceof JukeboxMorph&&n.spriteEditor.updateList(),this.__updateActiveEditor(r.id),this.completeAction()},ActionManager.prototype.onRenameSound=function(t,e){var o=this._sounds[t],i=this.ide();o.name=e,o.version=Date.now(),i.spriteEditor instanceof JukeboxMorph&&i.spriteEditor.updateList(),i.hasChangedMedia=!0,this.__updateActiveEditor(t),this.completeAction()},ActionManager.prototype.onRemoveSound=function(t){var e=this._soundToOwner[t],o=this.ide(),i=e.sounds.asArray().indexOf(this._sounds[t])+1;e.sounds.remove(i),o.spriteEditor instanceof JukeboxMorph&&o.spriteEditor.updateList(),this.__updateActiveEditor(t),this.__clearSoundRecords(t),this.completeAction()},ActionManager.prototype.onSetStageSize=function(t,e){this.ide().setStageExtent(new Point(t,e)),this.completeAction()},ActionManager.prototype.onSetRotationStyle=function(t,e){var o=this._owners[t];o.rotationStyle=e,o.changed(),o.drawNew(),o.changed(),this.ide().rotationStyleButtons.forEach(function(t){t.refresh()}),this.completeAction()},ActionManager.prototype.onImportSprites=function(t){this.ide().rawOpenSpritesString(t),this.completeAction()},ActionManager.prototype.onImportBlocks=function(t,e){var o=this.ide().rawOpenBlocksString(t,e,!0);this.completeAction(null,o)},ActionManager.prototype.onOpenProject=function(t){var e=this,o=null,i=this.currentEvent,r=this.ide();if(SnapUndo.reset(),this.initializeRecords(),t?0===t.indexOf("<project")?o=this.ide().rawOpenProjectString(t):0===t.indexOf("<snapdata")&&(o=this.ide().rawOpenCloudDataString(t)):this.ide().newRole(),r.sprites.asArray().concat(r.stage).forEach(function(t){return e.loadOwner(t)}),this.lastSeen=i.id,this.completeAction(null,o),!this.ide().isReplayMode){var n=SnapUndo.allEvents.length;i===SnapUndo.allEvents[n-1]&&SnapUndo.allEvents.pop(),o&&void 0!==o.collabStartIndex&&(this.lastSeen=o.collabStartIndex);var s=this.ide().room.name,a=this.ide().projectName;SnapCloud.setClientState(s,a,this.lastSeen)}},ActionManager.prototype._getCurrentTarget=function(t){var e,o,i=t.parent;if(i instanceof BlockMorph||i instanceof CommandSlotMorph){if(t instanceof CommandBlockMorph){if(i.nextBlock&&i.nextBlock()===t)return this._serializeMoveTarget(t,{point:i.bottomAttachPoint(),element:i,loc:"bottom",type:"block"});if(i instanceof CommandSlotMorph)return this._serializeMoveTarget(t,{point:i.slotAttachPoint(),element:i,loc:"bottom",type:"slot"})}else if(t instanceof ReporterBlockMorph)return o=t.id,t.id=null,e=this.getId(t),t.id=o,e}else if(t instanceof CommentMorph&&t.block)return t.block.id;return null},ActionManager.prototype._registerBlockState=function(t,e){var o,i,r,n,s,a,h=this;t instanceof PrototypeHatBlockMorph||t.isPrototype||(this.__assignUniqueBlockId(t,e),this._blocks[t.id]=t,a=this._getCurrentTarget(t),o=t.parentThatIsA(ScriptsMorph),a?this.__recordTarget(t.id,a):o&&(i=this.getStandardPosition(o,t.position()),this._positionOf[t.id]=i),t.inputs&&t.inputs().forEach(function(t){(n=t.contents&&t.contents())&&(s=n.value||n,t instanceof BlockMorph||void 0===s||(r=h.getId(t),h.fieldValues[r]=s),t instanceof ColorSlotMorph&&(r=h.getId(t),h.fieldValues[r]=t.color))}))},ActionManager.prototype.__assignUniqueBlockId=function(t,e){var o;if(t.id=t.id||this.newId(),this._blocks[t.id]&&this._blocks[t.id]!==t){for(o=t.id;this._blocks[t.id]&&this._blocks[t.id]!==t;)t.id=this.newId();e||console.warn("Block id "+o+" already used. Reissuing id "+t.id)}},ActionManager.prototype.loadOwner=function(e){var o=this;this.registerOwner(e,e.id),e.scripts.children.forEach(function(t){o.traverse(t,function(t){o.__assignUniqueBlockId(t,!0),o._blocks[t.id]=t})}),e.scripts.children.forEach(function(t){o.registerBlocks(t,e.id)});var t=e.customBlocks;e.globalBlocks&&(t=t.concat(e.globalBlocks)),this.loadCustomBlocks(t,e),e.costumes.asArray().forEach(function(t){t.id=t.id||o.newId(),o._costumes[t.id]=t,o._costumeToOwner[t.id]=e}),e.sounds.asArray().forEach(function(t){t.id=t.id||o.newId(),o._sounds[t.id]=t,o._soundToOwner[t.id]=e})},ActionManager.prototype.loadCustomBlocks=function(t,e){var o,i,r,n;e=e||this.ide().stage;for(var s=t.length;s--;){(n=t[s]).id=n.id||this.newId(),this._customBlocks[n.id]=n,this._customBlockOwner[n.id]=e;for(var a=(i=(o=this._getCustomBlockEditor(n.id)).body.contents).children.length;a--;)r=i.children[a],this.registerBlocks(r,n.id,!0);o.updateDefinition(!0)}},ActionManager.prototype.traverse=function(t,e){for(var o,i,r,n=t instanceof Array?t:[t];n.length;){for(o=[],r=n.length;r--;)e(t=n[r]),i=this.getBlockInputs(t),o=o.concat(i),t.nextBlock&&t.nextBlock()&&o.push(t.nextBlock()),t.comment&&o.push(t.comment);n=o}},ActionManager.prototype.getBlockInputs=function(t){var e,o,i=[];if(t.inputs)for(var r=(e=t.inputs()).length;r--;)(o=e[r])instanceof ReporterBlockMorph?i.push(o):o instanceof ArgMorph&&!(o instanceof TemplateSlotMorph)&&(i=i.concat(this.getBlockInputs(o))),o.nestedBlock&&o.nestedBlock()&&i.push(o.nestedBlock());return i},ActionManager.prototype.__updateActiveEditor=function(t){var e,o,i,r=this.ide();if(!(this.currentEvent.replayType||this.isCollaborating()&&this.currentEvent.user!==this.id)){if(e=this._blockToOwnerId[t]){if(o=this._getCustomBlockEditor(e))return r.setActiveEditor(o)}else e=this._costumeToOwner[t]?this._costumeToOwner[t].id:this._soundToOwner[t]?this._soundToOwner[t].id:null;(i=this._owners[e])&&i!==r.currentSprite||r.setActiveEditor()}},ActionManager.prototype.__clearOwnerRecords=function(t){var e,o=Object.keys(this._blockToOwnerId),i=Object.keys(this._costumeToOwner),r=Object.keys(this._soundToOwner);for(e=o.length;e--;)this._blockToOwnerId[o[e]]===t&&this.__clearBlockRecords(o[e]);for(e=i.length;e--;)this._costumeToOwner[i[e]].id===t&&this.__clearCostumeRecords(i[e]);for(e=r.length;e--;)this._soundToOwner[r[e]].id===t&&this.__clearSoundRecords(r[e]);delete this._owners[t]},ActionManager.prototype.__clearSoundRecords=function(t){delete this._soundToOwner[t],delete this._sounds[t]},ActionManager.prototype.__clearCostumeRecords=function(t){delete this._costumeToOwner[t],delete this._costumes[t]},ActionManager.prototype.__clearBlockRecords=function(t){if(delete this._blocks[t],delete this._positionOf[t],delete this._blockToOwnerId[t],this._targetFor[t])for(var e=Object.keys(this._targetFor[t]),o=e.length;o--;)delete this._targetOf[e[o]];delete this._targetFor[t],this.__clearTarget(t)},ActionManager.prototype.__recordTarget=function(t,e){var o=this.__targetId(e);this.__clearTarget(t),this._targetOf[t]=e,this._targetFor[o]||(this._targetFor[o]={}),this._targetFor[o][t]=e},ActionManager.prototype.__targetId=function(t){return"object"==typeof t?t.element:t},ActionManager.prototype.__clearTarget=function(t){var e;this._targetOf[t]&&(e=this.__targetId(this._targetOf[t]),this._targetFor[e]&&delete this._targetFor[e][t]),delete this._targetOf[t]},ActionManager.prototype.afterActionApplied=function(){this.ide().activeEditor.onSetActive()},ActionManager.prototype.onMessage=function(t){var e=this.ide().sockets;if("rank"===t.type)this.rank=t.value,logger.info("assigned rank of",this.rank);else if("leader-appoint"===t.type)this.isLeader=t.value,t.value&&logger.info("Appointed leader!");else if("uuid"===t.type)this.id=t.value,logger.info("assigned id of",this.id),this.onconnect&&this.onconnect();else if("session-project-request"===t.type){var o=this.serialize(this.ide().stage);t.args=[o],t.id=this.lastSeen,this.send(t)}else"session-id"===t.type?(this.sessionId=t.value,location.hash="collaborate="+this.sessionId):this.isLeader&&!e.inActionRequest?this.isNextAction(t)&&this.acceptEvent(t):this.onReceiveAction(t)},ActionManager.prototype.onActionReject=function(e,t){var o=this._attemptedLocalActions,i=o.find(function(t){return t.equals(e)}),r=o.indexOf(i);-1<r&&(o.splice(r,1),i.reject(new Error(t)))},ActionManager.OwnerFor=function(){return this.ide().currentSprite.id},ActionManager.OwnerFor.toggleBoolean=ActionManager.OwnerFor.setColorField=ActionManager.OwnerFor.setField=ActionManager.OwnerFor.addListInput=ActionManager.OwnerFor.unringify=ActionManager.OwnerFor.ringify=ActionManager.OwnerFor.unringify=ActionManager.OwnerFor.setCommentText=ActionManager.OwnerFor.setSelector=ActionManager.OwnerFor.setBlockSpec=ActionManager.OwnerFor.removeBlock=ActionManager.OwnerFor.setBlockPosition=function(t){var e=t.split("/").shift();return this._blockToOwnerId[e]+"/scripts"},ActionManager.OwnerFor.replaceBlock=function(t){return t=this.deserializeBlock(t),this._blockToOwnerId[t.id]+"/scripts"},ActionManager.OwnerFor.addBlock=function(t,e){return e+"/scripts"},ActionManager.OwnerFor.setBlocksPositions=function(t){if(t.length)return this._blockToOwnerId[t[0]]+"/scripts"},ActionManager.OwnerFor.moveBlock=function(t,e){var o;return o=(o="string"==typeof e?e:e.element).split("/")[0],this._customBlocks[o]?o+"/scripts":this._blockToOwnerId[o]+"/scripts"},ActionManager.OwnerFor.addCostume=function(t,e){return e+"/costumes"},ActionManager.OwnerFor.removeCostume=function(){return arguments[2]+"/costumes"},ActionManager.OwnerFor.updateCostume=ActionManager.OwnerFor.renameCostume=function(t){return this._costumeToOwner[t].id+"/costumes"},ActionManager.OwnerFor.addSound=function(t,e){return e+"/sounds"},ActionManager.OwnerFor.removeSound=function(){return arguments[2]+"/sounds"},ActionManager.OwnerFor.renameSound=function(t){return this._soundToOwner[t].id+"/sounds"},ActionManager.OwnerFor.updateBlockLabel=ActionManager.OwnerFor.deleteBlockLabel=ActionManager.OwnerFor.setCustomBlockType=function(t){return this._customBlockOwner[t].id},ActionManager.OwnerFor.addCustomBlock=ActionManager.OwnerFor.renameSprite=ActionManager.OwnerFor.toggleDraggable=ActionManager.OwnerFor.setRotationStyle=ActionManager.OwnerFor.addVariable=ActionManager.OwnerFor.deleteVariable=ActionManager.OwnerFor.setStageSize=ActionManager.OwnerFor.importBlocks=ActionManager.OwnerFor.importSprites=ActionManager.OwnerFor.openProject=ActionManager.OwnerFor.duplicateSprite=ActionManager.OwnerFor.addSprite=function(){return null},ActionManager.OwnerFor.removeSprite=function(){return"corral"},ActionManager.OwnerFor.deleteCustomBlock=function(){return"palette"};var SnapActions=new ActionManager;function UndoManager(){this.reset()}UndoManager.prototype.reset=function(){this.allEvents=[],this.eventHistory={},this.undoCount={}},UndoManager.UNDO=1,UndoManager.REDO=2,UndoManager.prototype.contains=function(t){for(var e=this.allEvents.length;e--;)if(t.id===this.allEvents[e].id&&t.user===this.allEvents[e].user&&t.type===this.allEvents[e].type&&t.time===this.allEvents[e].time)return!0;return!1},UndoManager.prototype.record=function(t){var e,o,i=t.owner;if(this.allEvents.push(t),i)if(this.eventHistory[i]||(this.undoCount[i]=0,this.eventHistory[i]=[]),e=this.undoCount[i],o=this.eventHistory[i],t.replayType)t.replayType===UndoManager.UNDO?this.undoCount[i]++:t.replayType===UndoManager.REDO&&(this.undoCount[i]--,console.assert(0<=this.undoCount[i],"undo count is negative!"));else{if(0!==e){var r=o.length-e-1;this.eventHistory[i].splice(r+1,e);this.undoCount[i]=0}o.push(t)}},UndoManager.prototype.allQueueIds=function(t){return Object.keys(this.eventHistory)},UndoManager.prototype.canUndo=function(t){var e=t.id||t;return this.eventHistory[e]&&this.eventHistory[e].length>this.undoCount[e]},UndoManager.prototype.canRedo=function(t){var e=t.id||t;return this.eventHistory[e]&&0<this.undoCount[e]},UndoManager.prototype.undo=function(t){var e,o=t.id||t,i=this.eventHistory[o]||[],r=i.length-this.undoCount[o]-1,n=i[r];return r<0||isNaN(r)?null:(console.log("undoing",n),(e=this.getInverseEvent(n)).replayType=UndoManager.UNDO,e.owner=n.owner,SnapActions.applyEvent(e))},UndoManager.prototype.redo=function(t){var e,o=t.id||t,i=this.eventHistory[o]||[],r=i.length-this.undoCount[o],n=i[r];return r>=i.length?null:((e={owner:n.owner,type:n.type,args:n.args.slice()}).replayType=UndoManager.REDO,SnapActions.applyEvent(e))},UndoManager.prototype.trim=function(t){var e=this.undoCount[t],o=this.eventHistory[t].length;this.eventHistory[t].splice(o-e),this.undoCount[t]=0},UndoManager.prototype.getInverseEvent=function(t){var e,o=t.type;if((t=JSON.parse(JSON.stringify(t))).isUserAction)return t;if(!UndoManager.Invert[o])throw Error('Cannot undo "'+o+'" event!');return(e=UndoManager.Invert[o].call(this,t.args))instanceof Array?e={type:o,args:e}:"string"==typeof e&&(e={type:e,args:t.args}),e},UndoManager.Invert={},UndoManager.Invert.setStageSize=function(t){return{type:"setStageSize",args:t.reverse()}},UndoManager.Invert.addSprite=function(t){return{type:"removeSprite",args:[t[2]]}},UndoManager.Invert.removeSprite=function(t){return 2===t.length?(t.shift(),{type:"addSprite",args:t}):{type:"duplicateSprite",args:t}},UndoManager.Invert.duplicateSprite=function(t){return{type:"removeSprite",args:[t[2]]}},UndoManager.Invert.attachParts=function(t){return{type:"detachParts",args:[t[1]]}},UndoManager.Invert.detachParts=function(t){var o=t[0];return{type:"batch",args:t[1].map(function(t,e){return{type:"attachParts",args:[t,[o[e]]]}}).filter(function(t){return!!t.args[0]})}},UndoManager.Invert.replaceBlock=function(t){return t.reverse()},UndoManager.Invert.toggleDraggable=function(t){return[t[0],!t[1]]},UndoManager.Invert.importSprites=function(t){return{type:"batch",args:t.pop().map(function(t){return{type:"removeSprite",args:[t]}})}},UndoManager.Invert.addVariable=function(){return"deleteVariable"},UndoManager.Invert.deleteVariable=function(){return"addVariable"},UndoManager.Invert.addCustomBlock=function(t){return{type:"deleteCustomBlock",args:[SnapActions.serializer.loadCustomBlock(SnapActions.serializer.parse(t[1])).id,t[0]]}},UndoManager.Invert.deleteCustomBlock=function(t){var e=t[2];return{type:"addCustomBlock",args:[t[1],e,t[3]]}},UndoManager.Invert.deleteCustomBlocks=function(t){return{type:"importBlocks",args:[t[1]]}},UndoManager.Invert.importBlocks=function(t){return{type:"deleteCustomBlocks",args:[t[2]]}},UndoManager.Invert.setCustomBlockType=function(t){return UndoManager.swap(t,1,3),UndoManager.swap(t,2,4),t},UndoManager.Invert.updateBlockLabel=function(t){if(!t[8])return t[1]+=1,{type:"deleteBlockLabel",args:t};var e=(t.length-2)/2;return t.splice(2,e),t},UndoManager.Invert.deleteBlockLabel=function(t){return t[1]=t[1]-1,{type:"updateBlockLabel",args:t}},UndoManager.Invert.addBlock=function(t){return{type:"batch",args:t.pop().map(function(t){return{type:"removeBlock",args:[t,!0]}})}},UndoManager.Invert.removeBlock=function(t){var e=t.pop(),o={type:"batch",args:[]};4===t.length?(t.splice(1,1),o.args.push({type:"moveBlock",args:t.reverse()})):o.args.push({type:"addBlock",args:t.reverse()});for(var i=e.length;i--;)o.args.push({type:"moveBlock",args:e[i]});return o},UndoManager.Invert._actionForState=function(t){return 3===t.length?{type:"setBlockPosition",args:t}:1===t.length?t[0]instanceof Array?{type:"batch",args:t[0].map(function(t){return{type:"removeBlock",args:[t,!0]}})}:{type:"removeBlock",args:[t[0],!0]}:{type:"moveBlock",args:t}},UndoManager.Invert.setBlockPosition=function(t){return UndoManager.Invert._actionForState.call(null,t[3])},UndoManager.Invert.setBlocksPositions=function(t){return{type:"setBlocksPositions",args:[t[0],t[2],t[1]]}},UndoManager.swap=function(t,e,o){var i=t.splice(o,1)[0];return t.splice(e,0,i),t},UndoManager.Invert.moveBlock=function(t){var e=UndoManager.Invert._actionForState.call(null,t[3]),o=t[1],i=t[2],r={type:"batch",args:[]};return"batch"===e.type?r.args=e.args:r.args.push(e),i&&r.args.unshift(i),"top"===o.loc||"wrap"===o.loc?"moveBlock"===(e=UndoManager.Invert._actionForState.call(null,t[4])).type&&"wrap"===e.args[1].loc||r.args.unshift(e):4<t.length&&(e=UndoManager.Invert._actionForState.call(null,t[4]),r.args.push(e)),r},UndoManager.Invert.addListInput=function(){return"removeListInput"},UndoManager.Invert.removeListInput=function(){return"addListInput"},UndoManager.Invert.ringify=function(){return"unringify"},UndoManager.Invert.unringify=function(){return"ringify"},UndoManager.Invert.addCostume=function(t){var e=t[0];return{type:"removeCostume",args:[SnapActions.serializer.loadValue(SnapActions.serializer.parse(e)).id]}},UndoManager.Invert.removeCostume=function(t){return t.shift(),{type:"addCostume",args:t}},UndoManager.Invert.addSound=function(t){var e=t[0];return{type:"removeSound",args:[SnapActions.serializer.loadValue(SnapActions.serializer.parse(e)).id]}},UndoManager.Invert.removeSound=function(t){return t.shift(),{type:"addSound",args:t}},UndoManager.Invert.openProject=function(t){return[t[1]]},UndoManager.Invert.renameSprite=UndoManager.Invert.updateCostume=UndoManager.Invert.renameCostume=UndoManager.Invert.renameSound=UndoManager.Invert.setRotationStyle=UndoManager.Invert.setSelector=UndoManager.Invert.setBlockSpec=UndoManager.Invert.setCommentText=UndoManager.Invert.toggleBoolean=UndoManager.Invert.setColorField=UndoManager.Invert.setField=function(t){return[t[0],t[2]]};var SnapUndo=new UndoManager,saveAs=saveAs||function(d){if("undefined"==typeof navigator||!/MSIE [1-9]\./.test(navigator.userAgent)){var t=d.document,g=function(){return d.URL||d.webkitURL||d},f=t.createElementNS("http://www.w3.org/1999/xhtml","a"),m="download"in f,y=/Version\/[\d\.]+.*Safari/.test(navigator.userAgent),M=d.webkitRequestFileSystem,b=d.requestFileSystem||M||d.mozRequestFileSystem,n=function(t){(d.setImmediate||d.setTimeout)(function(){throw t},0)},S="application/octet-stream",w=0,C=function(t){var e=function(){"string"==typeof t?g().revokeObjectURL(t):t.remove()};d.chrome?e():setTimeout(e,500)},v=function(t,e,o){for(var i=(e=[].concat(e)).length;i--;){var r=t["on"+e[i]];if("function"==typeof r)try{r.call(t,o||t)}catch(t){n(t)}}},x=function(t){return/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(t.type)?new Blob(["\ufeff",t],{type:t.type}):t},i=function(i,o,t){t||(i=x(i));var r,n,e,s=this,a=i.type,h=!1,l=function(){v(s,"writestart progress write writeend".split(" "))},p=function(){if(n&&y&&"undefined"!=typeof FileReader){var e=new FileReader;return e.onloadend=function(){var t=e.result;n.location.href="data:attachment/file"+t.slice(t.search(/[,;]/)),s.readyState=s.DONE,l()},e.readAsDataURL(i),void(s.readyState=s.INIT)}(!h&&r||(r=g().createObjectURL(i)),n)?n.location.href=r:null==d.open(r,"_blank")&&y&&(d.location.href=r);s.readyState=s.DONE,l(),C(r)},c=function(t){return function(){if(s.readyState!==s.DONE)return t.apply(this,arguments)}},u={create:!0,exclusive:!1};if(s.readyState=s.INIT,o||(o="download"),m)return r=g().createObjectURL(i),f.href=r,f.download=o,void setTimeout(function(){var t,e;t=f,e=new MouseEvent("click"),t.dispatchEvent(e),l(),C(r),s.readyState=s.DONE});d.chrome&&a&&a!==S&&(e=i.slice||i.webkitSlice,i=e.call(i,0,i.size,S),h=!0),M&&"download"!==o&&(o+=".download"),(a===S||M)&&(n=d),b?(w+=i.size,b(d.TEMPORARY,w,c(function(t){t.root.getDirectory("saved",u,c(function(t){var e=function(){t.getFile(o,u,c(function(o){o.createWriter(c(function(e){e.onwriteend=function(t){n.location.href=o.toURL(),s.readyState=s.DONE,v(s,"writeend",t),C(o)},e.onerror=function(){var t=e.error;t.code!==t.ABORT_ERR&&p()},"writestart progress write abort".split(" ").forEach(function(t){e["on"+t]=s["on"+t]}),e.write(i),s.abort=function(){e.abort(),s.readyState=s.DONE},s.readyState=s.WRITING}),p)}),p)};t.getFile(o,{create:!1},c(function(t){t.remove(),e()}),c(function(t){t.code===t.NOT_FOUND_ERR?e():p()}))}),p)}),p)):p()},e=i.prototype;return"undefined"!=typeof navigator&&navigator.msSaveOrOpenBlob?function(t,e,o){return o||(t=x(t)),navigator.msSaveOrOpenBlob(t,e||"download")}:(e.abort=function(){this.readyState=this.DONE,v(this,"abort")},e.readyState=e.INIT=0,e.WRITING=1,e.DONE=2,e.error=e.onwritestart=e.onprogress=e.onwrite=e.onabort=e.onerror=e.onwriteend=null,function(t,e,o){return new i(t,e,o)})}}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||this.content);function MessageInputSlotMorph(){StructInputSlotMorph.call(this,null,!1,"messageTypesMenu","getMsgFields",!0)}function MessageOutputSlotMorph(){MessageInputSlotMorph.call(this)}function ReadOnlyTemplateSlotMorph(t){TemplateSlotMorph.call(this,t),detect(this.children,function(t){return t instanceof ReporterBlockMorph}).mouseClickLeft=readOnlyReporterClick}"undefined"!=typeof module&&module.exports?module.exports.saveAs=saveAs:"undefined"!=typeof define&&null!==define&&null!=define.amd&&define([],function(){return saveAs}),MessageInputSlotMorph.prototype=new StructInputSlotMorph,MessageInputSlotMorph.prototype.constructor=MessageInputSlotMorph,MessageInputSlotMorph.uber=StructInputSlotMorph.prototype,MessageInputSlotMorph.prototype.setContents=function(t,e,o){this.cachedMsgType=o||null,MessageInputSlotMorph.uber.setContents.call(this,t,e)},MessageInputSlotMorph.prototype.getMsgFields=function(t){var e=this.parentThatIsA(BlockMorph),o=null;return(e&&e.receiver()?(o=e.receiver().parentThatIsA(StageMorph).messageTypes.getMsgType(t))&&o.fields:this.cachedMsgType&&this.cachedMsgType.fields)||[]},MessageOutputSlotMorph.prototype=Object.create(MessageInputSlotMorph.prototype),MessageOutputSlotMorph.prototype.constructor=MessageOutputSlotMorph,MessageOutputSlotMorph.uber=MessageInputSlotMorph.prototype,MessageOutputSlotMorph.prototype.executeOnSliderEdit=!1,MessageOutputSlotMorph.prototype.evaluate=function(){return this.fields},MessageOutputSlotMorph.prototype.getFieldValue=function(t){return new ReadOnlyTemplateSlotMorph(t)},ReadOnlyTemplateSlotMorph.prototype=new TemplateSlotMorph,ReadOnlyTemplateSlotMorph.prototype.constructor=ReadOnlyTemplateSlotMorph,ReadOnlyTemplateSlotMorph.uber=TemplateSlotMorph.prototype;var readOnlyReporterClick=function(t){return this.parent instanceof BlockInputFragmentMorph?this.parent.mouseClickLeft():ReporterBlockMorph.uber.mouseClickLeft.call(this,t)};function NetCloud(t,e){this.clientId=t,this.roleId=null,Cloud.call(this,e),this.api=null}SpriteMorph.prototype.allHatBlocksForSocket=function(e){return"number"==typeof e&&(e=e.toString()),this.scripts.children.filter(function(t){return"receiveSocketMessage"===t.selector&&e===t.inputs()[0].contents().text})},StageMorph.prototype.allHatBlocksForSocket=SpriteMorph.prototype.allHatBlocksForSocket,DialogBoxMorph.prototype.ask=function(t,e,o,i){var r,n=this;r=new TextMorph(e,this.fontSize,this.fontStyle,!0,!1,"center",null,null,MorphicPreferences.isFlat?null:new Point(1,1),new Color(255,255,255)),this.key||(this.key="decide"+t+e),this.labelString=t,this.createLabel(),this.addBody(r),Object.keys(i).forEach(function(t){var e=i[t];n.addButton(e,t)}),this.fixLayout(),this.drawNew(),this.fixLayout(),this.popUp(o)},SpriteMorph.prototype.categories.splice(8,0,"network"),SpriteMorph.prototype.categories.splice(9,0,"custom"),SpriteMorph.prototype.blockColor.network=new Color(217,77,17),SpriteMorph.prototype.blockColor.custom=new Color(120,120,120),SpriteMorph.prototype._initBlocks=SpriteMorph.prototype.initBlocks,SpriteMorph.prototype.initBlocks=function(){SpriteMorph.prototype._initBlocks(),SpriteMorph.prototype.blocks.getJSFromRPC={type:"reporter",category:"network",spec:"call %s with %s",defaults:["PublicRoles"],deprecated:!0},SpriteMorph.prototype.blocks.getJSFromRPCDropdown={type:"reporter",category:"network",spec:"call %rpcNames / %rpcActions with %s",defaults:["PublicRoles"],deprecated:!0},SpriteMorph.prototype.blocks.getJSFromRPCStruct={type:"reporter",category:"network",spec:"call %rpcNames / %rpcMethod",defaults:["PublicRoles"]},SpriteMorph.prototype.blocks.doRunRPC={type:"command",category:"network",spec:"run %rpcNames / %rpcMethod",defaults:["PublicRoles"]},SpriteMorph.prototype.blocks.getCostumeFromRPC={type:"reporter",category:"network",spec:"costume from %rpcNames / %rpcActions with %s",defaults:["PublicRoles",""],deprecated:!0},SpriteMorph.prototype.blocks.reportRPCError={type:"reporter",category:"network",spec:"error"},SpriteMorph.prototype.blocks.doSocketRequest={type:"reporter",category:"network",spec:"send msg %msgInput to %roles and wait"},SpriteMorph.prototype.blocks.doSocketResponse={type:"command",category:"network",spec:"send response %s"},SpriteMorph.prototype.blocks.doSocketMessage={type:"command",category:"network",spec:"send msg %msgInput to %roles"},SpriteMorph.prototype.blocks.receiveSocketMessage={type:"hat",category:"network",spec:"when I receive %msgOutput"},SpriteMorph.prototype.blocks.getProjectId={type:"reporter",category:"network",spec:"role name"},SpriteMorph.prototype.blocks.getProjectIds={type:"reporter",category:"network",spec:"all role names"},SpriteMorph.prototype.blocks.reportLatitude={type:"reporter",category:"sensing",spec:"my latitude"},SpriteMorph.prototype.blocks.reportLongitude={type:"reporter",category:"sensing",spec:"my longitude"},SpriteMorph.prototype.blocks.reportStageWidth={type:"reporter",category:"sensing",spec:"stage width"},SpriteMorph.prototype.blocks.reportStageHeight={type:"reporter",category:"sensing",spec:"stage height"},SpriteMorph.prototype.blocks.reportUsername={type:"reporter",category:"sensing",spec:"username"}},SpriteMorph.prototype.initBlocks(),SpriteMorph.prototype.getProjectId=function(){return this.parentThatIsA(IDE_Morph).projectName},SpriteMorph.prototype.getProjectIds=function(){var t=this.parentThatIsA(IDE_Morph).room.getRoleNames();return new List(t)},StageMorph.prototype.getProjectId=SpriteMorph.prototype.getProjectId,StageMorph.prototype.getProjectIds=SpriteMorph.prototype.getProjectIds,SpriteMorph.prototype.reportUsername=function(){return SnapCloud.username||""},StageMorph.prototype.reportUsername=SpriteMorph.prototype.reportUsername,SpriteMorph.prototype._blockForSelector=SpriteMorph.prototype.blockForSelector,SpriteMorph.prototype.blockForSelector=function(t,e){var o=this._blockForSelector(t,e);return"receiveSocketMessage"===t&&(o.blockSequence=CommandBlockMorph.prototype.blockSequence),o},SpriteMorph.prototype.deletableMessageNames=function(){return this.parentThatIsA(StageMorph).deletableMessageNames()},StageMorph.prototype.deletableMessageNames=function(){return this.messageTypes.names().filter(function(t){return"message"!==t})},SpriteMorph.prototype.deleteMessageType=function(t){var e=this.parentThatIsA(IDE_Morph);e.stage.messageTypes.deleteMsgType(t);try{e.room.parentThatIsA(RoomEditorMorph).updateRoom(),e&&"room"===e.currentTab&&e.spriteBar.tabBar.tabTo("room")}catch(t){}e.flushBlocksCache("network"),e.refreshPalette()},StageMorph.prototype.deleteMessageType=SpriteMorph.prototype.deleteMessageType,StageMorph.prototype._init=StageMorph.prototype.init,StageMorph.prototype.init=function(t){this.messageTypes=new MessageFrame,this.addMessageType({name:"message",fields:["msg"]}),this._init(t)},StageMorph.prototype.addMessageType=function(t){var e;e=new MessageType(t.name,t.fields),this.messageTypes.addMsgType(e);try{var o=this.parentThatIsA(NetsBloxMorph);o.room.parentThatIsA(RoomEditorMorph).updateRoom(),o&&"room"===o.currentTab&&o.spriteBar.tabBar.tabTo("room")}catch(t){}},ReplayControls.prototype._applyEvent=ReplayControls.prototype.applyEvent,ReplayControls.prototype.applyEvent=function(t,e){return"openProject"!==t.type?ReplayControls.prototype._applyEvent.apply(this,arguments):e()},SpriteMorph.prototype.reportRPCError=function(){return this.parentThatIsA(StageMorph).rpcError},StageMorph.prototype.reportRPCError=function(){return this.rpcError},WatcherMorph.prototype._isGlobal=WatcherMorph.prototype.isGlobal,WatcherMorph.prototype.isGlobal=function(t){return"reportRPCError"===t||WatcherMorph.prototype._isGlobal.call(this,t)},ProjectDialogMorph.prototype._deleteProject=ProjectDialogMorph.prototype.deleteProject,ProjectDialogMorph.prototype.deleteProject=function(){if("cloud-shared"===this.source){var t=this.listField.selected.ProjectName;this.ide.confirm(localize("Are you sure you want to delete")+'\n"'+t+'"?',"Delete Project",function(){SnapCloud.evictCollaborator(SnapCloud.username)})}else this._deleteProject()},ProjectDialogMorph.prototype._openProject=ProjectDialogMorph.prototype.openProject,ProjectDialogMorph.prototype.openProject=function(){var t,e=this,o=this.listField.selected;if("examples"===this.source)this.destroy(),t=this.ide.getURL(this.ide.resourceURL("Examples",o.name)),this.ide.droppedText(t),this.ide.updateUrlQueryString(o.name,!1,!0);else{if("cloud-shared"!==this.source)return this._openProject();this.destroy(),this.ide.showMessage("Opening project.. ",2),SnapCloud.joinActiveProject(o.ID,function(t){e.ide.rawLoadCloudProject(t,o.Public)},e.ide.cloudError())}},ProjectDialogMorph.prototype.openCloudProject=function(i){var t,r=this;this.destroy(),r.ide.nextSteps([function(){t=r.ide.showMessage("Fetching project\nfrom the cloud...")},function(){SnapCloud.reconnect(function(){var t=i.ProjectName===r.ide.room.name,e=1===r.ide.room.getCurrentOccupants();t&&e?r.rawOpenCloudProject(i):SnapCloud.isProjectActive(i.ID,function(t){var e,o;t?(e={"Join Existing":function(){SnapCloud.joinActiveProject(i.ID,function(t){r.ide.rawLoadCloudProject(t,i.Public)},r.ide.cloudError()),o.destroy(),r.destroy()},"Create Copy":function(){return o.destroy(),SnapCloud.getEntireProject(i.ID,function(t){return r.ide.droppedText(t)},r.ide.cloudError())}},(o=new DialogBoxMorph(null,nop)).ask(localize("Join Existing Project"),localize("This project is already open. Would you like to join\nthe active one or create a new copy?"),r.world(),e)):r.rawOpenCloudProject(i)},r.ide.cloudError())},r.ide.cloudError())},function(){t.destroy()}])},ProjectDialogMorph.prototype.rawOpenCloudProject=function(e){var o=this,i=o.ide.showMessage("Fetching project\nfrom the cloud...");SnapCloud.getProject(e.ID,function(t){i.destroy(),o.ide.rawLoadCloudProject(t,e.Public)},o.ide.cloudError()),this.destroy()},IDE_Morph.prototype._getURL=IDE_Morph.prototype.getURL,IDE_Morph.prototype.getURL=function(t,e){return t=ensureFullUrl(t),this._getURL(t,e)},IDE_Morph.prototype._rawOpenBlocksString=IDE_Morph.prototype.rawOpenBlocksString,IDE_Morph.prototype.rawOpenBlocksString=function(t,e,o){var i,r=this;if(Process.prototype.isCatchingErrors)try{i=this.serializer.parse(t).childrenNamed("messageType")}catch(t){this.showMessage("Load failed: "+t)}else i=this.serializer.parse(t).childrenNamed("messageType");return o&&(i.forEach(function(t){var e=t.childNamed("name").contents,o=t.childNamed("fields").children.map(function(t){return t.contents});r.stage.addMessageType({name:e,fields:o})}),this.flushBlocksCache(),this.flushPaletteCache(),this.refreshPalette(),this.showMessage("Imported Blocks / Message Types Module"+(e?": "+e:"")+".",2)),this._rawOpenBlocksString(t,e,o)},IDE_Morph.prototype.loadReplayFromXml=function(t){var e=this.serializer.parse(t);if("room"===e.tag&&(e=e.children[0].childNamed("project")),"project"===e.tag){var o=this.serializer.getInitialStageSpriteIds(e),i=o[0],r=o[1],n=this.sprites.at(1);SnapActions.registerOwner(this.stage,i),SnapActions.registerOwner(n,r),e=e.childNamed("replay")}return this.droppedText(e.toString())},IDE_Morph.prototype.openReplayString=function(t){var e=this,o=this.serializer.parse(t);return e.exitReplayMode(),SnapActions.openProject().then(function(){e.serializer.loadReplayHistory(o),e.replayEvents(JSON.parse(JSON.stringify(SnapUndo.allEvents)),!1)})},IDE_Morph.prototype.isSupportedBrowser=function(){var t,e,o,i,r;return t=window.chrome,e=window.navigator,o=e.vendor,i=void 0!==window.opr,r=-1<e.userAgent.indexOf("Edge"),!!e.userAgent.match("CriOS")||null!=t&&"Google Inc."===o&&!1===i&&!1===r},IDE_Morph.prototype.isMobileDevice=function(){var t=screen.width<=420&&screen.height<=800,e=screen.width<=800&&screen.height<=420;return(t||e)&&-1!==navigator.userAgent.toLowerCase().indexOf("mobile")&&void 0!==window.orientation},IDE_Morph.prototype.mobileMode={_stackMode:"",buttons:[],btnConfig:{idealSize:30,SBRatio:.5,GBRatio:.3,symbolSize:void 0,padding:void 0,size:void 0,gap:void 0},ideMorph:void 0},IDE_Morph.prototype.mobileMode.init=function(){this.ideMorph=world.children[0],this.hideExtra();var t=window.innerHeight/window.outerHeight;this.btnConfig.idealSize=this.btnConfig.idealSize*t,this.setBtnSize(this.btnConfig.idealSize),this.fixLayout()},IDE_Morph.prototype.mobileMode.updateBtnConfig=function(){this.btnConfig.gap=this.btnConfig.size*this.btnConfig.GBRatio,this.btnConfig.symbolSize=this.btnConfig.size*this.btnConfig.SBRatio,this.btnConfig.padding=this.btnConfig.size*(1-this.btnConfig.SBRatio)},IDE_Morph.prototype.mobileMode.setBtnSize=function(t,e){void 0===e&&(e=!0),e||(this.btnConfig.idealSize=t),this.btnConfig.size=t,this.updateBtnConfig()},IDE_Morph.prototype.mobileMode.resetBtnSize=function(){this.btnConfig.size=this.btnConfig.idealSize,this.updateBtnConfig()},IDE_Morph.prototype.mobileMode.fixLayout=function(){this.ideMorph.controlBar.setHeight(0);var t=this._stackMode,e=this.emptySpaces(),o=this.optimalRectangle(e);if("h"===t&&"v"===this._stackMode){var i=.6*this.btnConfig.size;this.setBtnSize(i)}this.buttons=this.createButtons();var r=this.computeControlPos(o);this.positionButtons(this.buttons,r)},IDE_Morph.prototype.mobileMode.hideExtra=function(){this.ideMorph.controlBar.hide()},IDE_Morph.prototype.mobileMode.emptySpaces=function(){var t=window.innerHeight,e=window.innerWidth,o=world.children[0].stage.bounds;return{top:o.origin.y,left:o.origin.x,right:e-o.corner.x,bottom:t-o.corner.y}},IDE_Morph.prototype.mobileMode.optimalRectangle=function(t){var e,o=world.children[0].stage,i={topRight:{x:window.innerWidth,y:0},bottomLeft:{}};if(t[e=t.top>t.right?"top":"right"]<2*this.btnConfig.size){var r=t[e]/2-10;if(r<10)throw new Error("no space on the sides.");this.setBtnSize(r)}else this.resetBtnSize();switch(e){case"right":i.bottomLeft.x=o.bounds.corner.x,i.bottomLeft.y=window.innerHeight;break;case"top":i.bottomLeft.x=0,i.bottomLeft.y=o.bounds.origin.y}return i.height=Math.abs(i.topRight.y-i.bottomLeft.y),i.width=Math.abs(i.topRight.x-i.bottomLeft.x),this._stackMode=i.height>i.width?"v":"h",i},IDE_Morph.prototype.mobileMode.computeControlPos=function(t){var e,o=window.innerHeight,i=window.innerWidth,r=this.buttons.length,n=this.buttons[0].height(),s=this.buttons[0].width();return"v"===this._stackMode?((e={origin:{},height:r*n+(r-1)*this.btnConfig.gap,width:s}).origin.y=(o-e.height)/2,e.origin.x=t.bottomLeft.x+(t.width-e.width)/2):"h"===this._stackMode&&((e={origin:{},width:r*s+(r-1)*this.btnConfig.gap,height:n}).origin.x=(i-e.width)/2,e.origin.y=(t.bottomLeft.y-e.height)/2),e},IDE_Morph.prototype.mobileMode.createButtons=function(){var e=this,o=[new Color(50,50,50),new Color(70,70,70),new Color(90,90,90)];this.buttons&&0!==this.buttons.length&&this.buttons.forEach(function(t){t.destroy()});var t=[],i=new ToggleButtonMorph(null,this.ideMorph,"stopAllScripts",[new SymbolMorph("octagon",e.btnConfig.symbolSize),new SymbolMorph("square",e.btnConfig.symbolSize)],function(){return!e.ideMorph.stage||e.ideMorph.stage.enableCustomHatBlocks&&e.ideMorph.stage.threads.pauseCustomHatBlocks});i.labelColor=new Color(200,0,0);var r=new PushButtonMorph(this.ideMorph,"pressStart",new SymbolMorph("flag",e.btnConfig.symbolSize));return r.labelColor=new Color(0,200,0),t.push(r),t.push(i),t.forEach(function(t){t.hide(),t.fixLayout(),t.drawNew(),e.ideMorph.add(t),t.corner=12,t.color=o[0],t.highlightColor=o[1],t.pressColor=o[2],t.labelMinExtent=new Point(36,18),t.labelShadowOffset=new Point(-1,-1),t.labelShadowColor=o[1],t.contrast=this.buttonContrast,t.padding=e.btnConfig.padding,t.fixLayout(),t.refresh&&t.refresh()}),t},IDE_Morph.prototype.mobileMode.positionButtons=function(t,r){var n=t[0].height(),s=this,a=t[0].width();t.forEach(function(t,e){var o,i;"v"===s._stackMode?(o=r.origin.x,i=r.origin.y+e*n+e*s.btnConfig.gap):"h"===s._stackMode&&(i=r.origin.y,o=r.origin.x+e*a+e*s.btnConfig.gap),t.setPosition(new Point(o,i)),t.show()})},IDE_Morph.prototype.initializeEmbeddedAPI=function(){var t,e=this,o={};t=function(t){switch(t.data.type){case"import":e.droppedText(t.data.content,t.data.name);break;case"set-variable":o[t.data.key]=t.data.value;break;case"delete-variable":delete o[t.data.key]}},window.externalVariables=o,window.addEventListener("message",t,!1)},IDE_Morph.prototype.getMediaListFromURL=function(t,o){var e,i=o instanceof Function,r=this;function n(t,e){return t.name.toLowerCase()<e.name.toLowerCase()?-1:1}if(!i)return(e=this.parseResourceFile(this.getURL(t))).sort(n),e;this.getURL(t,function(t){var e=r.parseResourceFile(t);e.sort(n),o.call(this,e)})},NetCloud.prototype=new Cloud,NetCloud.prototype.login=function(t,e,o,i,r){var n=new XMLHttpRequest,s=JSON.stringify({projectId:this.projectId,__h:e,__u:t,remember:o,clientId:SnapCloud.clientId}),a=this;this.setRoute(t);try{n.open("POST",(this.hasProtocol()?"":"http://")+this.url+"?SESSIONGLUE="+this.route,!0),n.setRequestHeader("Content-Type","application/json; charset=utf-8"),n.setRequestHeader("SESSIONGLUE",this.route),n.withCredentials=!0,n.onreadystatechange=function(){4===n.readyState&&(200===n.status?(a.api=JSON.parse(n.responseText),a.api.logout?(a.username=t,a.password=e,i.call(null,a.api,"NetsBlox Cloud")):r.call(null,n.responseText,"connection failed")):403===n.status?r.call(null,"",localize(n.responseText||"wrong username or password")):r.call(null,a.url,localize("could not connect to:")))},n.send(s)}catch(t){r.call(this,t.toString(),"NetsBlox Cloud")}},NetCloud.prototype.addRole=function(t,e,o){var i=this;this.reconnect(function(){i.callService("addRole",e,o,[t,i.clientId,i.projectId])},o)},NetCloud.prototype.renameRole=function(t,e,o,i){var r=this;this.reconnect(function(){r.callService("renameRole",o,i,[t,e,r.projectId])},i)},NetCloud.prototype.cloneRole=function(t,e,o){var i=this;this.reconnect(function(){i.callService("cloneRole",e,o,[t,i.projectId])},o)},NetCloud.prototype.invitationResponse=function(t,o,i,e){var r=this,n=[t,o,SnapCloud.clientId];this.reconnect(function(){r.callService("invitationResponse",function(t){var e=t[0];o&&r.setLocalState(e.ProjectID,e.RoleID),i(e)},e,n)},function(t){r.ide.showMessage(t,2)})},NetCloud.prototype.inviteGuest=function(t,e){var o=this;this.reconnect(function(){o.callService("inviteGuest",nop,nop,[SnapCloud.clientId,t,e,o.projectId])},nop)},NetCloud.prototype.inviteToCollaborate=function(){var t=this,e=Array.prototype.slice.call(arguments);this.reconnect(function(){t.callService("inviteToCollaborate",nop,nop,e.concat(t.projectId))},nop)},NetCloud.prototype.joinActiveProject=function(t,o,e){var i=this;this.callService("joinActiveProject",function(t){var e=t[0];i.setLocalState(e.ProjectID,e.RoleID),o(e)},e,[t])},NetCloud.prototype.evictCollaborator=function(t){var e=this;this.reconnect(function(){e.callService("evictCollaborator",nop,nop,[t,e.projectId])},nop)},NetCloud.prototype.collabResponse=function(t,e,o,i){var r=this,n=[t,e,SnapCloud.clientId];this.reconnect(function(){r.callService("inviteCollaboratorResponse",o,i,n)},function(t){r.ide.showMessage(t,2)})},NetCloud.prototype.getFriendList=function(e,t){var o=this;this.reconnect(function(){o.callService("getFriendList",function(t){e(t)},t)},t)},NetCloud.prototype.getProject=function(t,o,e,i){var r=this,n=[t];i&&n.push(i),this.reconnect(function(){r.callService("getProject",function(t){var e=t[0];r.setLocalState(e.ProjectID,e.RoleID),o(e)},e,n)},e)},NetCloud.prototype.getProjectByName=function(t,e,o,i){var r=this;this.reconnect(function(){r.callService("getProjectByName",function(t){var e=t[0];r.setLocalState(e.ProjectID,e.RoleID),o(e)},i,[t,e])},i)},NetCloud.prototype.getCollaboratorList=function(t,e){var o=this;this.reconnect(function(){o.callService("getCollaborators",t,e,[o.projectId])},e)},NetCloud.prototype.deleteRole=function(t,e,o){var i=this;this.reconnect(function(){i.callService("deleteRole",e,o,[t,i.projectId])},o)},NetCloud.prototype.evictUser=function(t,e,o){var i=this;this.reconnect(function(){i.callService("evictUser",e,o,[t,i.projectId])},o)},NetCloud.prototype.saveProject=function(t,o,e,i,r){var n=this,s=t.sockets.getSerializedProject();n.reconnect(function(){n.callService("saveProject",function(t,e){n.setLocalState(t.projectId,t.roleId),o.call(null,t,e)},e,[n.roleId,t.projectName,r||t.room.name,SnapCloud.projectId,t.room.ownerId,!0===i,s.SourceCode,s.Media])},e)},NetCloud.prototype.callService=function(o,i,r,n){var t,s,a=new XMLHttpRequest,h=this.api[o],l=this;if(this.api)if(h){n&&0<n.length&&(s={},h.parameters.forEach(function(t,e){void 0!==n[e]&&(s[t]=n[e])}));try{t=this.url+"/"+h.url,a.open(h.method,t,!0),a.withCredentials=!0,a.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),a.onreadystatechange=function(){if(4===a.readyState){var t,e=a.responseText&&0===a.responseText.indexOf("ERROR");if(a.status<200||399<a.status||e)return void r.call(this,a.responseText,localize("Service:")+" "+localize(o));t=l.parseResponse(a),i.call(null,t,h.url)}},a.send(this.encodeDict(s))}catch(t){r.call(this,t.toString(),h.url)}}else r.call(null,"service "+o+" is not available","API");else r.call(null,"You are not connected","Cloud")},NetCloud.prototype.reconnect=function(t,e){if(this.username&&this.password)return this.setClientState().then(t).catch(e);this.message("You are not logged in")},NetCloud.prototype.disconnect=nop,NetCloud.prototype.logout=function(t,e){var o=this;this.reconnect(function(){o.callService("logout",t,e,[o.clientId]),o.clear()},e)},NetCloud.prototype.signup=function(t,e,o,i){var r=new XMLHttpRequest,n=this,s="Username="+encodeURIComponent(t)+"&Email="+encodeURIComponent(e);try{r.open("POST",(this.hasProtocol()?"":"http://")+this.url+"SignUp",!0),r.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),r.withCredentials=!0,r.onreadystatechange=function(){4===r.readyState&&(r.responseText?0===r.responseText.indexOf("ERROR")?i.call(this,r.responseText,"Signup"):o.call(null,r.responseText,"Signup"):i.call(null,n.url+"SignUp",localize("could not connect to:")))},r.send(s)}catch(t){i.call(this,t.toString(),"NetsBlox Cloud")}},NetCloud.prototype.isProjectActive=function(t,e,o){var i=this;this.reconnect(function(){i.callService("isProjectActive",function(t){return e(t.active)},o,[i.clientId,t])},o)},NetCloud.prototype.hasConflictingStoredProject=function(t,o,e){var i=this;this.reconnect(function(){i.callService("hasConflictingStoredProject",function(t){var e="true"===t[0].hasConflicting;return o(e)},e,[i.projectId,t])},e)},NetCloud.prototype.saveProjectCopy=function(o,t){var i=this;this.reconnect(function(){i.callService("saveProjectCopy",function(t,e){i.setLocalState(t.projectId,i.roleId),o.call(null,t,e),i.disconnect()},t,[i.clientId,i.projectId])},t)},NetCloud.prototype.request=function(t,e){var o,i,r=new Promise(function(t,e){o=t,i=e}),n=JSON.stringify(e);t=SERVER_URL+t;var s=new XMLHttpRequest;return s.open("POST",t,!0),s.setRequestHeader("Content-Type","application/json"),s.withCredentials=!0,s.onreadystatechange=function(){if(4===s.readyState){if(299<s.status||s.status<200||s.responseText&&0===s.responseText.indexOf("ERROR"))return i(s);o(JSON.parse(s.responseText))}},s.send(n),r},NetCloud.prototype.setLocalState=function(t,e){this.projectId=t,this.roleId=e},NetCloud.prototype.resetLocalState=function(){var t=this.clientId+"-"+Date.now(),e="tmp-project-id-"+t,o="tmp-role-id-"+t;this.setLocalState(e,o)},NetCloud.prototype.newProject=function(t){var e=this,o={clientId:SnapCloud.clientId,name:t||""};return this.newProjectRequest||(this.newProjectRequest=this.request("/api/newProject",o).then(function(t){return e.setLocalState(t.projectId,t.roleId),e.newProjectRequest=null,t}).catch(function(t){throw e.resetLocalState(),e.newProjectRequest=null,new Error(t.responseText)})),this.newProjectRequest},NetCloud.prototype.getClientState=function(){return{username:this.username,clientId:this.clientId,projectId:this.projectId,roleId:this.roleId}},NetCloud.prototype.setClientState=function(e,o,i){var r=this;return(this.newProjectRequest||Promise.resolve()).then(function(){var t={__u:r.username,__h:r.password,clientId:r.clientId,socketId:r.clientId,projectId:r.projectId,roleId:r.roleId,roomName:e,roleName:o,actionId:i};return r.request("/api/setClientState",t)}).then(function(t){return r.setLocalState(t.projectId,t.roleId),r.api||(r.api=t.api),t}).catch(function(t){var e="Could not connect to "+r.url;throw new Error(t.responseText||e)})},NetCloud.prototype.setProjectName=function(e){var o=this;return(this.newProjectRequest||Promise.resolve()).then(function(){var t={projectId:o.projectId,name:e};return o.request("/api/setProjectName",t)}).then(function(t){return t}).catch(function(t){var e="Could not connect to "+o.url;throw new Error(t.responseText||e)})},NetCloud.prototype.importProject=function(t,e,o){var i=this,r={projectId:this.projectId,clientId:this.clientId,name:t,role:e,roles:o};return this.request("/api/importProject",r).then(function(t){return i.setLocalState(t.projectId,t.roleId),t.state}).catch(function(t){throw i.resetLocalState(),new Error(t.responseText)})},NetCloud.prototype.getEntireProject=function(t,e,o){var i=this;this.reconnect(function(){i.callService("getEntireProject",function(t){e(t),i.disconnect()},o,[t])},o)};var SnapCloud=new NetCloud(CLIENT_ID,SERVER_URL+"/api/");function NetsProcess(t,e,o,i){this.topBlock=t||null,this.readyToYield=!1,this.readyToTerminate=!1,this.isDead=!1,this.isClicked=!1,this.isShowingResult=!1,this.errorFlag=!1,this.context=null,this.homeContext=i||new Context,this.lastYield=Date.now(),this.isFirstStep=!0,this.isAtomic=!1,this.prompter=null,this.httpRequest=null,this.rpcRequest=null,this.isPaused=!1,this.pauseOffset=null,this.frameCount=0,this.exportResult=!1,this.onComplete=e||null,this.procedureCount=0,t&&(this.homeContext.receiver=t.receiver(),this.homeContext.variables.parentFrame=this.homeContext.receiver.variables,this.context=new Context(null,t.blockSequence(),this.homeContext),o||this.pushContext("doYield"))}function listToArray(t){if(!(t instanceof List))return t;for(var e,o=[],i=t.asArray(),r=0;r<i.length;r++)(e=i[r])instanceof List?e=listToArray(e):isObject(e)&&(SnapActions.serializer.flush(),e=SnapActions.serializer.store(e)),o.push(e);return o}NetsProcess.prototype=new Process,NetsProcess.prototype.constructor=NetsProcess,NetsProcess.prototype.doSocketMessage=function(t){var e,o=this.homeContext.receiver.parentThatIsA(IDE_Morph),i=arguments[arguments.length-1],r=[o.projectName,o.room.name,o.room.ownerId].join("@"),n=t[0],s=t[1],a=Array.prototype.slice.call(arguments,1,s.length+1);if(!SnapActions.isCollaborating()||SnapActions.isLeader){if(n){e={};for(var h=s.length;h--;)e[s[h]]=a[h]||"";var l=i instanceof List?i.asArray():i,p=function(){o.sockets.sendMessage({type:"message",dstId:l,srcId:r,msgType:n,content:e})};if(!this.reportIsFastTracking())return p();var c="asyncFn-sendMsg";if(this[c]){if((new Date).getTime()>this[c].endTime)return void(this[c]=null)}else this[c]={},this[c].endTime=(new Date).getTime()+1e3/90,p(),this[c].onerror=function(t){this[c].error=t};this.pushContext("doYield"),this.pushContext()}}else this.topBlock.showBubble("Cannot send message when collaborating")},NetsProcess.prototype.doSocketRequest=function(t){var e,o,i=this.homeContext.receiver.parentThatIsA(IDE_Morph),r=arguments[arguments.length-1],n=i.projectName,s=i.room.name,a=i.room.ownerId,h=t[0],l=t[1],p=Array.prototype.slice.call(arguments,1,l.length+1);if(!SnapActions.isCollaborating()||SnapActions.isLeader){if(h){if(this.requestId){if(this.reply){o=this.requestId;var c=this.reply;return this.requestId===o&&(this.requestId=null,this.reply=null),c.content.body}}else{o="__REQ"+Date.now(),this.requestId=o,e={};for(var u=l.length;u--;)e[l[u]]=p[u]||"";i.sockets.sendMessage({type:"message",dstId:r,srcId:n+"@"+s+"@"+a,msgType:h,requestId:o,content:e})}this.pushContext("doYield"),this.pushContext()}}else this.topBlock.showBubble("Cannot send message when collaborating")},NetsProcess.prototype.doSocketResponse=function(t){var e,o,i,r=this.homeContext.receiver.parentThatIsA(IDE_Morph);try{e=this.context.variables.getVar("__requestId__"),o=this.context.variables.getVar("__srcId__")}catch(t){throw new Error(localize("Cannot find message to which to respond!"))}i={body:t},r.sockets.sendMessage({type:"message",dstId:o,msgType:"__reply__",requestId:e,content:i})},NetsProcess.prototype.receiveSocketMessage=function(t){var e,o=this.context.outerContext.variables;if(-1!==o.names().indexOf("__message__")){e=this.context.variables.getVar("__message__"),t.length||(t=Object.keys(e));for(var i=t.length;i--;)o.addVar(t[i],e[t[i]]);o.deleteVar("__message__")}},NetsProcess.prototype.createRPCUrl=function(t){var e=this.homeContext.receiver.parentThatIsA(IDE_Morph).sockets.uuid,o=encodeURIComponent(SnapCloud.projectId),i=encodeURIComponent(SnapCloud.roleId);return SERVICES_URL+"/"+t+"?uuid="+e+"&projectId="+o+"&roleId="+i},NetsProcess.prototype.callRPC=function(t,e,o){var i,r,n,s,a=this.createRPCUrl(t);if(o&&(a+="&t="+Date.now()),"string"==typeof e){var h=e.split("&").map(function(t){return t.split("=")});e={},h.forEach(function(t){e[t[0]]=t[1]})}if(this.rpcRequest){if(4===this.rpcRequest.readyState){if(0===this.rpcRequest.status)return void((n=this.homeContext.receiver.parentThatIsA(StageMorph)).rpcError="Request too large");if(404===this.rpcRequest.status)return this.errorRPCNotAvailable.apply(this,t.split("/"));if((r=this.rpcRequest.getResponseHeader("content-type"))&&0===r.indexOf("image"))return(s=this.getCostumeFromRPC(t,e))&&(this.rpcRequest=null),s;var l=new TextDecoder("utf-8").decode(new Uint8Array(this.rpcRequest.response));return i=decodeURIComponent(encodeURIComponent(l)),n=this.homeContext.receiver.parentThatIsA(StageMorph),this.rpcRequest.status<200||299<this.rpcRequest.status?n.rpcError=i:n.rpcError=null,this.rpcRequest=null,i}this.readyToTerminate&&(this.rpcRequest.abort(),this.rpcRequest=null)}else this.rpcRequest=new XMLHttpRequest,this.rpcRequest.responseType="arraybuffer",this.rpcRequest.open("POST",a,!0),this.rpcRequest.setRequestHeader("Content-Type","application/json"),this.rpcRequest.send(JSON.stringify(e));this.pushContext("doYield"),this.pushContext()},NetsProcess.prototype.getCostumeFromRPC=function(t,e,o){var i,r=this.homeContext.receiver.parentThatIsA(StageMorph);if(2===arguments.length?o=e:(t=[encodeURIComponent(t),encodeURIComponent(e)].join("/"),o.width||(o.width=r.width()),o.height||(o.height=r.height())),!this.rpcRequest||4!==this.rpcRequest.readyState)return this.callRPC(t,o,!0);if(this.requestedImage){if(this.requestedImage.complete&&this.requestedImage.naturalWidth){i=this.requestedImage,this.requestedImage=null;var n=newCanvas(new Point(i.width,i.height),!0);return n.getContext("2d").drawImage(i,0,0),new Costume(n,t)}}else{var s=this.rpcRequest.response,a=this.rpcRequest.getResponseHeader("content-type"),h=new Blob([s],{type:a}),l=(window.URL||window.webkitURL).createObjectURL(h);this.requestedImage=new Image,this.requestedImage.crossOrigin="Anonymous",this.requestedImage.src=l}this.pushContext("doYield"),this.pushContext()},NetsProcess.prototype.getJSFromRPC=function(t,r){if("string"==typeof r){var e=r;r={},e.split("&").forEach(function(t){var e=t.split("="),o=e[0],i=e[1];o&&(r[o]=i)})}var o=this.callRPC(t,r,!0);if(o)try{o=JSON.parse(o)}catch(t){}return o=this.parseRPCResult(o)},NetsProcess.prototype.parseRPCResult=function(t){return t instanceof Array?new List(t.map(this.parseRPCResult.bind(this))):"string"==typeof t&&"<"===t[0]?this.homeContext.receiver.parentThatIsA(IDE_Morph).sockets.deserializeData([t])[0]:t},NetsProcess.prototype.errorRPCNotAvailable=function(t,e){throw new Error('Cannot invoke "'+e+'" from "'+t+'". Service or RPC is not available.')},NetsProcess.prototype.doRunRPC=NetsProcess.prototype.getJSFromRPCStruct=function(t,e){var o=e[0],i=e[1],r=Array.prototype.slice.call(arguments,2,i.length+2),n={};return SnapActions.serializer.flush(),i.forEach(function(t,e){r[e]instanceof List?n[t]=listToArray(r[e]):isObject(r[e])?n[t]=SnapActions.serializer.getPortableXML(r[e]):n[t]=r[e]}),SnapActions.serializer.flush(),this.getJSFromRPCDropdown(t,o,n)},NetsProcess.prototype.getJSFromRPCDropdown=function(t,e,o){if(t&&e)return this.getJSFromRPC([encodeURIComponent(t),encodeURIComponent(e)].join("/"),o)},NetsProcess.prototype.getLocation=function(){var t,e=this;if(void 0!==this.location){var o=this.location;if(this.location=void 0,this.locationError||!o)throw this.locationError=this.locationError||new Error("Could not determine location"),t=this.locationError.name||this.locationError.constructor&&this.locationError.constructor.name,this.locationError.name=t||"Error",this.locationError;return o.coords}this.locationError=null,navigator.geolocation.getCurrentPosition(function(t){e.location=t},function(t){e.locationError=t,e.location=null}),this.pushContext("doYield"),this.pushContext()},NetsProcess.prototype.reportLatitude=function(){var t=this.getLocation();if(t)return t.latitude},NetsProcess.prototype.reportLongitude=function(){var t=this.getLocation();if(t)return t.longitude},NetsProcess.prototype.reportStageWidth=function(){return this.homeContext.receiver.parentThatIsA(StageMorph).dimensions.x},NetsProcess.prototype.reportStageHeight=function(){return this.homeContext.receiver.parentThatIsA(StageMorph).dimensions.y},NetsProcess.prototype.runAsyncFn=function(t,o){o={timeout:(o=o||{}).timeout||2e3,args:o.args||[]};var e,i="_asyncFunc"+t.name,r=this;if(!(i&&t instanceof Function))throw new Error("id or asyncFn input missing");if(this[i]){if(r[i].complete)return e=r[i],r[i]=null,e.response;if(r[i].error)throw e=r[i],r[i]=null,console.error(e.response),new Error(e.response)}else{this[i]={},this[i].startTime=(new Date).getTime();var n=new Promise(function(t,e){setTimeout(e,o.timeout,"timeout")}),s=t.apply(this,o.args),a=Promise.race([s,n]).then(function(t){r[i].complete=!0,r[i].response=t}).catch(function(t){r[i].error=!0,r[i].response=t});r[i].onerror=function(t){r[i].error=t},r[i].promise=a}this.pushContext("doYield"),this.pushContext()};var WebSocketManager=function(t){this.ide=t,this.uuid=SnapCloud.clientId,this.websocket=null,this.messages=[],this.processes=[],this._protocol="https"===SERVER_URL.substring(0,5)?"wss:":"ws:",this.url=this._protocol+"//"+SERVER_ADDRESS,this.lastSocketActivity=Date.now(),this._connectWebSocket(),this.version=Date.now(),this.serverVersion=null,this.errored=!1,this.hasConnected=!1,this.connected=!1,this.inActionRequest=!1,this.serializer=new NetsBloxSerializer};function MessageType(t,e){this.name=t,this.fields=e}function Message(t){this.type=t,this.contents={},this.init()}function MessageFrame(){this.msgTypes={},this.version=Date.now()}function MessageCreatorMorph(t,e){this.init(t,e)}function MessageDefinitionBlock(){this.init()}WebSocketManager.HEARTBEAT_INTERVAL=25e3,WebSocketManager.MessageHandlers={"request-actions-complete":function(){this.inActionRequest=!1},"reload-project":function(t){console.error(t.err);var e=t.message+"\n\nPlease reopen the project to continue editing.";this.ide.inform(localize("Project Reload Required"),e)},"report-version":function(t){var e=t.body;this.serverVersion||(this.serverVersion=e),this.serverVersion!==e&&this.ide.showUpdateNotification()},connected:function(){this.onConnect()},message:function(t){var e=t.dstId,o=t.msgType,i=t.content;this.ide.room.isReplayingTrace()?this.ide.room.trace.notified||(this.ide.showMessage(localize("Ignoring messages received while\nviewing network trace")),this.ide.room.trace.notified=!0):e!==this.ide.projectName&&"others in room"!==e&&"everyone in room"!==e||(i=this.deserializeMessage(t),this.onMessageReceived(o,i,t))},"export-room":function(t){"export"===t.action?this.ide.exportRoom(t.content):"save"===t.action&&this.ide.saveRoomLocal(t.content)},"room-roles":function(t){this.ide.room.onRoomStateUpdate(t)},"close-invite":function(t){this.ide.room.invitations[t.id]&&(this.ide.room.invitations[t.id].destroy(),delete this.ide.room.invitations[t.id])},"room-invitation":function(t){this.ide.room.promptInvite(t.id,t.role,t.roomName,t.inviter)},"collab-invitation":function(t){this.ide.promptCollabInvite(t)},"project-closed":function(){var t=this.ide.room.ownerId;this.ide.showMessage(t+" closed the room. You can ask to join again once "+t+" opens the project again"),this.ide.newProject()},evicted:function(){this.ide.showMessage("You have been evicted from the project."),this.ide.newProject()},"permission-elevation-request":function(t){var e=this,o=t.guest;this.ide.confirm(o+localize(" would like to be made a collaborator on ")+e.ide.room.name+"\n\n"+localize("Would you like to make ")+o+localize(" a collaborator?"),"Collaboration Request",function(){e.sendMessage({type:"elevate-permissions",projectId:t.projectId,username:o})})},"project-request":function(t){var e=this.getSerializedProject();t.type="project-response",t.project=e,this.sendMessage(t)},"rename-role":function(t){t.roleId===this.ide.projectName&&this.ide.silentSetProjectName(t.name)},notification:function(t){this.ide.showMessage(t.message)},"share-msg-type":function(r){if(this.ide.projectName===r.roleId){var n=this,t=new DialogBoxMorph;if(this.ide.stage.messageTypes.msgTypes[r.name])this.ide.showMessage(r.from+" tried sending you message type '"+r.name+"' when you already have it!",2);else{var e=r.from+" requested to send you a message type:\n'"+r.name+"' with "+r.fields.length+(1!==r.fields.length?" fields.":" field.")+"\nWould you like to accept?";t.askYesNo("Message Share Request",e,n.ide.root()),t.ok=function(){var i=n.ide.root().children[0].parentThatIsA(IDE_Morph);SnapActions.addMessageType(r.name,r.fields).then(function(){for(var t=[],e=0;e<r.fields.length;e++)t.push(" '"+r.fields[e]+"'");var o="Received message type '"+r.name+"' with "+r.fields.length+(0===r.fields.length?" fields.":1===r.fields.length?" field: "+r.fields:" fields: "+r.fields);n.ide.showMessage(o,2),i&&"room"===i.currentTab&&i.spriteBar.tabBar.tabTo("room")}),t.destroy()}}}},ping:function(){this.sendMessage({type:"pong"})},"user-action":function(t){SnapActions.onMessage(t.action)},"action-rejected":function(t){SnapActions.onActionReject(t.action,t.error.message)}},WebSocketManager.prototype.isConnected=function(){return this.websocket.readyState===this.websocket.OPEN},WebSocketManager.prototype.isStale=function(){return Date.now()-this.lastSocketActivity>2*WebSocketManager.HEARTBEAT_INTERVAL},WebSocketManager.prototype.checkAlive=function(){return!this.isStale()||(this.websocket.readyState!==this.websocket.CONNECTING&&(this.lastSocketActivity=Date.now(),this.disconnect()),!1)},WebSocketManager.prototype.disconnect=function(){this.websocket.close(),this.onClose()},WebSocketManager.prototype._connectWebSocket=function(){var i=this;if(null!==this.websocket){if(this.isConnected())return;if(this.websocket.readyState===this.websocket.CONNECTING)return void setTimeout(i._connectWebSocket.bind(i),500)}this.websocket=new WebSocket(this.url),this.websocket.onopen=function(){!0===i.errored&&(i.ide.showMessage((i.hasConnected?"re":"")+"connected!",2),i.errored=!1),i.hasConnected||setInterval(i.checkAlive.bind(i),WebSocketManager.HEARTBEAT_INTERVAL),i.lastSocketActivity=Date.now(),i.connected=!0,i.sendMessage({type:"set-uuid",clientId:SnapCloud.clientId}),i.hasConnected=!0},this.websocket.onmessage=function(t){var e=JSON.parse(t.data),o=e.type;i.lastSocketActivity=Date.now(),WebSocketManager.MessageHandlers[o]?WebSocketManager.MessageHandlers[o].call(i,e):console.error("Unknown message:",e)},this.websocket.onclose=function(){i.onClose()}},WebSocketManager.prototype.onClose=function(){var t;this.connected&&(this.version=Date.now(),this.connected=!1),!this.errored&&5e3<Date.now()-this.version&&(t=this.hasConnected?"Temporarily disconnected.\nSome network functionality may be nonfunctional.\nTrying to reconnect...":"Could not fully connect to NetsBlox.\nPlease try refreshing your browser or try a different browser",this.ide.showMessage(t),this.errored=!0),setTimeout(this._connectWebSocket.bind(this),500)},WebSocketManager.prototype.sendJSON=function(t){return this.send(JSON.stringify(t))},WebSocketManager.prototype.send=function(t){this.checkAlive(),this.isConnected()?this.websocket.send(t):this.messages.push(t)},WebSocketManager.prototype.sendMessage=function(t){t.projectId=SnapCloud.projectId,t=this.serializeMessage(t),this.send(t)},WebSocketManager.prototype.serializeMessage=function(t){if(t.content){var e,o=Object.keys(t.content);this.serializer.flush();for(var i=o.length;i--;)isObject(e=t.content[o[i]])&&(t.content[o[i]]=this.serializer.getPortableXML(e));this.serializer.flush()}return JSON.stringify(t)},WebSocketManager.prototype.deserializeMessage=function(o){var e=o.content,i=Object.keys(e),t=i.map(function(t){return e[t]});return this.deserializeData(t).forEach(function(t,e){o.content[i[e]]=t}),o.content},WebSocketManager.prototype.deserializeData=function(t){var o,i;return SnapActions.serializer.project={stage:new StageMorph,sprites:{}},t.map(function(e){if("<"===e[0])try{return console.log("Received serialized format:",e.length),i=SnapActions.serializer.parse(e),(o=i.allChildren().find(function(t){return"project"===t.tag}))&&SnapActions.serializer.rawLoadProjectModel(o),SnapActions.serializer.loadValue(i)}catch(t){return console.error("Could not deserialize!",t),e}return e})},WebSocketManager.prototype.onConnect=function(){var t=this;return SnapActions.requestMissingActions(!0),this.updateRoomInfo().then(function(){for(;t.messages.length;)t.websocket.send(t.messages.shift())})},WebSocketManager.prototype.getClientState=function(){var t=this.ide.room.ownerId,e=this.ide.projectName||"myRole",o={room:this.ide.room.name||"__new_project__",role:e};return t&&(o.owner=t,o.actionId=SnapActions.lastSeen),o},WebSocketManager.prototype.updateRoomInfo=function(){var t=this,e=this.getClientState();return SnapCloud.setClientState(e.room,e.role,e.actionId).catch(function(){t.ide.cloudError().apply(null,arguments)})},WebSocketManager.prototype.onMessageReceived=function(e,t,o){var i,r,n=[],s=!this.processes.length,a=this.ide.stage;if(t=t||[],""!==e){a.threads.processes.forEach(function(t){"__reply__"===e&&t.requestId===o.requestId&&(t.reply=o)}),a.children.concat(a).forEach(function(t){(t instanceof SpriteMorph||t instanceof StageMorph)&&(n=n.concat(t.allHatBlocksForSocket(e)))});for(var h=n.length;h--;)i=null,"receiveSocketMessage"===(r=n[h]).selector&&((i=new Context).variables.addVar("__message__",t),i.variables.addVar("__requestId__",o.requestId),i.variables.addVar("__srcId__",o.srcId)),this.addProcess({block:r,isThreadSafe:a.isThreadSafe,context:i});s&&setTimeout(this.startProcesses.bind(this),50)}},WebSocketManager.prototype.addProcess=function(t){for(var e=0;e<this.processes.length;e++)if(t.block===this.processes[e][0].block)return void this.processes[e].push(t);this.processes.push([t])},WebSocketManager.prototype.startProcesses=function(){for(var t,e,o=this.ide.stage,i=0;i<this.processes.length;i++)e=this.processes[i][0].block,!!o.threads.findProcess(e)||((t=this.processes[i].shift()).block.updateReadout(),o.threads.startProcess(t.block,t.isThreadSafe,null,null,null,!0,t.context),this.processes[i].length||(this.processes.splice(i,1),i--));this.processes.length&&setTimeout(this.startProcesses.bind(this),5)},WebSocketManager.prototype.getSerializedProject=function(){var t,e,o=this.ide;o.serializer.flush(),o.serializer.isCollectingMedia=!0,t=o.serializer.serialize(o.stage),e=o.serializer.mediaXML(o.projectName),o.serializer.isCollectingMedia=!1,o.serializer.flushMedia();try{o.serializer.parse(t)}catch(t){throw o.showMessage("Serialization of program data failed:\n"+t),new Error("Serialization of program data failed:\n"+t)}if(null!==e)try{o.serializer.parse(e)}catch(t){throw o.showMessage("Serialization of media failed:\n"+t),new Error("Serialization of media failed:\n"+t)}return o.serializer.isCollectingMedia=!1,o.serializer.flushMedia(),o.serializer.flush(),{ProjectName:o.projectName,SourceCode:t,Media:e,SourceSize:t.length,MediaSize:e?e.length:0,RoomName:this.ide.room.name}},WebSocketManager.prototype.destroy=function(){this.websocket.readyState===this.websocket.OPEN?this._destroy():this.websocket.onopen=this._destroy.bind(this)},WebSocketManager.prototype._destroy=function(){this.websocket.onclose=nop,this.websocket.close()},modules.messages="2015-October-02",Message.prototype.init=function(){for(var t=this.type.fields.length;t--;)this.set(this.type.fields[t],0)},Message.prototype.set=function(t,e){this.contents[t]=e},Message.prototype.get=function(t){return this.contents[t]},Message.prototype.getFieldNames=function(){return this.type.fields.slice()},Message.prototype.toString=function(){return this.type.name+" Message"},MessageFrame.prototype.addMsgType=function(t){this.msgTypes[t.name]=t,this.version=Date.now()},MessageFrame.prototype.getMsgType=function(t){return this.msgTypes[t]},MessageFrame.prototype.deleteMsgType=function(t){delete this.msgTypes[t],this.version=Date.now()},MessageFrame.prototype.names=function(){return Object.keys(this.msgTypes)},MessageCreatorMorph.prototype=new DialogBoxMorph,MessageCreatorMorph.prototype.constructor=MessageCreatorMorph,MessageCreatorMorph.uber=DialogBoxMorph.prototype,MessageCreatorMorph.prototype.fixLayout=function(){var t=fontHeight(this.titleFontSize)+2*this.titlePadding;if(this.body){this.body.setPosition(this.position().add(new Point(this.padding,t+this.padding))),this.minWidth=this.minWidth||0;var e=this.body.width()+2*this.padding;this.silentSetWidth(Math.max(e,this.minWidth)),this.silentSetHeight(this.body.height()+2*this.padding+t),this.body.setLeft(this.left()+Math.round((this.width()-this.body.width())/2))}this.label&&(this.label.setCenter(this.center()),this.label.setTop(this.top()+(t-this.label.height())/2)),this.buttons&&0<this.buttons.children.length&&(this.buttons.fixLayout(),this.silentSetHeight(this.height()+this.buttons.height()+this.padding),this.silentSetWidth(Math.max(this.width(),this.buttons.width()+2*this.padding)),this.buttons.setCenter(this.center()),this.buttons.setBottom(this.bottom()-this.padding))},MessageCreatorMorph.prototype.init=function(t,e){var o=this;this.minWidth=0,MessageCreatorMorph.uber.init.call(this,t),this.key="createNewMsgType",this.labelString="Create Message Type",this.createLabel();var i=new MessageDefinitionBlock;this.addBody(i);var r=i.fixLayout;i.fixLayout=function(){this.parent.drawNew(),r.call(this),o.fixLayout(),o.handle.drawNew(),o.drawNew()},this.accept=function(){var t={name:i.messageName(),fields:i.fields()};t.name&&e(t),this.destroy()},this.addButton("ok","OK"),this.addButton("cancel","Cancel"),this.fixLayout(),this.drawNew(),this.minWidth=this.width()},MessageCreatorMorph.prototype.popUp=function(){var t=this.target.world();t&&(BlockEditorMorph.uber.popUp.call(this,t),this.handle=new HandleMorph(this,280,220,this.corner,this.corner))},MessageDefinitionBlock.prototype=new ReporterBlockMorph,MessageDefinitionBlock.prototype.constructor=MessageDefinitionBlock,MessageDefinitionBlock.uber=ReporterBlockMorph.prototype,MessageDefinitionBlock.prototype.init=function(){MessageDefinitionBlock.uber.init.call(this),this.color=SpriteMorph.prototype.blockColor.network,this.category="network",this.setSpec("name: %hintname fields: %mhintfield"),this.drawNew()},MessageDefinitionBlock.prototype.messageName=function(){return this.inputs()[0].evaluate()},MessageDefinitionBlock.prototype.fields=function(){return this.inputs()[1].evaluate()},RoomMorph.prototype=new Morph,RoomMorph.prototype.constructor=RoomMorph,RoomMorph.uber=Morph.prototype,RoomMorph.SIZE=300,RoomMorph.DEFAULT_ROLE="myRole",RoomMorph.DEFAULT_ROOM="untitled",RoomMorph.isSocketUuid=function(t){return t&&"_"===t[0]},RoomMorph.isValidName=function(t){return!/[@\.]+/.test(t)},RoomMorph.isEmptyName=function(t){return/^\s*$/.test(t)};var white=new Color(224,224,224);function RoomMorph(t){this.init(t)}function SentMessageMorph(t,e,o,i,r){this.init(t,e,o,i,r)}function MessageMorph(t,e){this.init(t,e)}function MessageInspectorMorph(t){this.init(t)}function NetworkReplayControls(){this.init()}function RoleMorph(t,e,o){this.init(t,e,o)}function EditRoleMorph(t,e){this.init(t,e)}function RoomEditorMorph(t,e){this.init(t,e)}function UserDialogMorph(t,e,o){this.init(t,e,o)}function CollaboratorDialogMorph(t,e,o){this.init(t,e,o)}function NetsBloxMorph(t){this.init(t)}function NetsBloxSerializer(){this.init()}RoomMorph.prototype.init=function(t){var e=this;this.version=-1,this.isReadOnly=!1,this.ide=t,this.displayedMsgMorphs=[],this.invitations={},this.trace={},this.ownerId=null,this.collaborators=[],RoomMorph.uber.init.call(this,!0),this.name=localize(RoomMorph.DEFAULT_ROOM),this.roomName=new StringMorph(this.name,18,null,!0,!1,!1,null,null,white),this.roomName.mouseClickLeft=function(){e.editRoomName()},this.ownerLabel=new StringMorph(localize("Owner: myself"),!1,!1,!0,!0,!1,null,null,white),this.collabList=new StringMorph(localize("No collaborators"),!1,!1,!0,!0,!1,null,null,white),this.nextRoom=null,this.ide.projectName||(this.ide.projectName=RoomMorph.DEFAULT_ROLE),RoomMorph.uber.init.call(this),this.updateRoles(this.getDefaultRoles()),this.add(this.roomName),this.add(this.ownerLabel),this.add(this.collabList),this.isDraggable=!1,this.sharedMsgs=[],this.blockHighlights=[]},RoomMorph.prototype.setReadOnly=function(t){t!==this.isReadOnly&&(this.isReadOnly=t,this.drawNew())},RoomMorph.prototype.silentSetRoomName=function(t){return this.name=t,this.roomName.text=t,this.roomName.changed(),this.roomName.drawNew(),this.roomName.changed(),this.ide.controlBar.updateLabel(),t},RoomMorph.prototype.setRoomName=function(t){var e=this;return this.name!==t?SnapCloud.setProjectName(t).then(function(t){return e.onRoomStateUpdate(t)}).catch(this.ide.cloudError()):Promise.resolve(t)},RoomMorph.prototype.getDefaultRoles=function(){var t={},e=this.getCurrentRoleName(),o={uuid:this.myUuid(),username:SnapCloud.username||"me"};return t[e]={name:e,occupants:[o]},t},RoomMorph.prototype.getCurrentRoleName=function(){var e=this,t=this.getRoleNames(),o=e.ide.sockets.uuid;return t.find(function(t){return e.getCurrentOccupants(t).find(function(t){return t.uuid===o})})||this.ide.projectName},RoomMorph.prototype.getRoleCount=function(){return this.getRoles().length},RoomMorph.prototype.hasMultipleRoles=function(){return 1<this.getRoleCount()},RoomMorph.prototype.getCurrentOccupants=function(t){t=t||this.getCurrentRoleName();var e=this.getRole(t);return e?e.users.slice():[]},RoomMorph.prototype.isLeader=function(){return 1===this.getCurrentOccupants().length},RoomMorph.prototype.myUuid=function(){return this.ide.sockets.uuid},RoomMorph.prototype.myUserId=function(){return SnapCloud.username||localize("guest")},RoomMorph.prototype.isOwner=function(t){return RoomMorph.isSocketUuid(this.ownerId)&&!t?this.ide.sockets.uuid===this.ownerId:!t&&null===this.ownerId||(t=t||SnapCloud.username,this.ownerId&&this.ownerId===t)},RoomMorph.prototype.isCollaborator=function(t){return t=t||SnapCloud.username,-1<this.collaborators.indexOf(t)},RoomMorph.prototype.isGuest=function(t){return!(this.isOwner(t)||this.isCollaborator(t))},RoomMorph.prototype.isEditable=function(){return!this.isReadOnly&&(this.isOwner()||this.isCollaborator())},RoomMorph.sameOccupants=function(t,e){var o,i,r,n,s=function(t){return t.uuid},a=function(t){return t.username};return o=t.map(s),r=e.map(s),!!RoomMorph.equalLists(o,r)&&(i=t.map(a),n=e.map(a),!!RoomMorph.equalLists(i,n))},RoomMorph.equalLists=function(t,e){if(t.length!==e.length)return!1;for(var o=t.length;o--;)if(t[o]!==e[o])return!1;return!0},RoomMorph.prototype.onRoomStateUpdate=function(t){this.version<t.version&&(this.update(t.owner,t.name,t.roles,t.collaborators),this.version=t.version)},RoomMorph.prototype.update=function(t,e,o,i){var r,n=this.isEditable();(r=e&&this.name!==e)&&this.silentSetRoomName(e),r=r||n!==this.isEditable(),o&&(r=this.updateRoles(o)||r),i&&(r=r||!RoomMorph.equalLists(i,this.collaborators),this.setCollaborators(i||this.collaborators)),t&&(r=r||t!==this.ownerId,this.ownerId=t),this.ide.silentSetProjectName(this.getCurrentRoleName()),r&&(this.drawNew(),this.fixLayout(),this.changed()),SnapActions.isLeader=this.isLeader()},RoomMorph.prototype.getRoleNames=function(){return this.getRoles().map(function(t){return t.name})},RoomMorph.prototype.getRoles=function(){return this.children.filter(function(t){return t instanceof RoleMorph})},RoomMorph.prototype.getRole=function(e){return this.getRoles().find(function(t){return t.name===e})},RoomMorph.prototype.updateRoles=function(o){var e,i=this,t=this.getRoles(),r=!1;return t.forEach(function(t){o[t.id]?(e=o[t.id].occupants,RoomMorph.sameOccupants(t.users,e)||t.setOccupants(e),t.setName(o[t.id].name),delete o[t.id]):(t.destroy(),r=!0)}),Object.keys(o).forEach(function(t){var e=new RoleMorph(t,o[t].name,o[t].occupants);i.add(e),r=!0}),r},RoomMorph.prototype.getInnerHeight=function(){return this.ownerLabel.top()-10-this.top()},RoomMorph.prototype.getRadius=function(){var t=this.getInnerHeight();return Math.min(this.width(),t)/2},RoomMorph.prototype.getRoleSize=function(){var t,e,o,i,r=this.getRoles().length,n=2*Math.PI/r,s=this.getRadius();return t=new Point(s/2,0),e=new Point(Math.cos(n),Math.sin(n)).multiplyBy(s/2),o=t.distanceTo(e)-10,i=t.distanceTo(new Point(0,s/2)),n<Math.PI/2&&(i=o),Math.min(i,150)},RoomMorph.prototype.fixLayout=function(){var t,e,o,i,r,n,s,a,h=this,l=this.getRoles(),p=2*Math.PI/l.length,c=-Math.PI/2+this.index*p,u=RoleMorph.COLORS.length;this.collabList.setCenter(this.center()),this.collabList.setBottom(this.bottom()-25),this.ownerLabel.setCenter(this.center()),this.ownerLabel.setBottom(this.collabList.top()-10),i=new Point(this.center().x,this.top()+this.getInnerHeight()/2),this.roomName.setCenter(i),t=this.getRadius(),o=this.getRoleSize();for(var d=0;d<l.length;d++)a=l[d],c=-Math.PI/2+d*p,n=.65*t*Math.cos(c),s=.65*t*Math.sin(c),e=i.add(new Point(n,s)),r=RoleMorph.COLORS[d%u],a.setExtent(new Point(o,o)),a.setCenter(e),a.setColor(r);this.displayedMsgMorphs.forEach(function(t){h.updateDisplayedMsg(t)})},RoomMorph.prototype.drawNew=function(){this.image=newCanvas(this.extent()),this.isReadOnly?this.roomName.hide():this.roomName.show(),this.getRoles().forEach(function(t){t.drawNew()}),this.displayedMsgMorphs.forEach(function(t){t.drawNew()})},RoomMorph.prototype.setOwner=function(t){this.ownerId=t,this.ownerLabel.text=RoomMorph.isSocketUuid(this.ownerId)?localize("myself"):this.ownerId,this.ownerLabel.changed(),this.ownerLabel.drawNew(),this.ownerLabel.changed()},RoomMorph.prototype.setCollaborators=function(t){this.collaborators=t,this.collaborators.length?this.collabList.text=localize("Collaborators")+":\n"+this.collaborators.join(",\n"):this.collabList.text="No collaborators",this.collabList.changed(),this.collabList.drawNew(),this.collabList.changed()},RoomMorph.prototype.mouseClickLeft=function(){this.isEditable()||this.isReadOnly||(SnapCloud.username?this.ide.confirm(localize('would you like to leave "'+this.name+'"?'),localize("Leave Room"),this.ide.newProject.bind(this.ide)):this.ide.showMessage(localize("Please login before editing the room")))},RoomMorph.prototype.editRoomName=function(){var e=this;this.isEditable()&&this.ide.prompt("New Room Name",function(t){RoomMorph.isEmptyName(t)||(RoomMorph.isValidName(t)?e.setRoomName(t):(new DialogBoxMorph).inform("Invalid Project Name","Could not set the project name because\nthe provided name is invalid",e.world()))},null,"editRoomName")},RoomMorph.prototype.validateRoleName=function(t,e){RoomMorph.isEmptyName(t)||(this.getRole(t)?(new DialogBoxMorph).inform("Existing Role Name","Could not rename role because\nthe provided name already exists.",this.world()):RoomMorph.isValidName(t)?e():(new DialogBoxMorph).inform("Invalid Role Name","Could not change the role name because\nthe provided name is invalid",this.world()))},RoomMorph.prototype.createNewRole=function(){var e=this;this.ide.prompt("New Role Name",function(t){e.validateRoleName(t,function(){SnapCloud.addRole(t,function(t){e.onRoomStateUpdate(t)},e.ide.cloudError())})},null,"createNewRole")},RoomMorph.prototype.editRole=function(t){var e=new EditRoleMorph(this,t),o=this.world();e.fixLayout(),e.drawNew(),e.popUp(o),e.setCenter(o.center())},RoomMorph.prototype.editRoleName=function(e){var o=this;this.ide.prompt("New Role Name",function(t){o.setRoleName(e,t)},null,"editRoleName")},RoomMorph.prototype.moveToRole=function(e){var o=this;o.ide.showMessage("moving to "+e.name),SnapCloud.getProject(SnapCloud.projectId,function(t){o.ide.showMessage("moved to "+e.name+"!"),o.ide.silentSetProjectName(e.name),o.ide.source="cloud",t?("true"===t.Public&&(location.hash="#present:Username="+encodeURIComponent(SnapCloud.username)+"&ProjectName="+encodeURIComponent(t.ProjectName)),t.SourceCode?o.ide.droppedText(t.SourceCode):SnapActions.openProject()):SnapActions.openProject()},function(t,e){o.ide.cloudError().call(null,t,e)},e.id)},RoomMorph.prototype.deleteRole=function(e){var o=this;SnapCloud.deleteRole(e.id,function(t){o.onRoomStateUpdate(t),o.ide.showMessage("deleted "+e.name+"!")},function(t,e){o.ide.cloudError().call(null,t,e)})},RoomMorph.prototype.createRoleClone=function(e){var o=this,i=this.getRoles().find(function(t){return t.id===e}).name;SnapCloud.cloneRole(e,function(t){o.onRoomStateUpdate(t),o.ide.showMessage("created copy of "+i)},o.ide.cloudError())},RoomMorph.prototype.role=function(){return this.ide.projectName},RoomMorph.prototype.setRoleName=function(t,e){var o=this;e&&(-1===o.getRoleNames().indexOf(e)?o.validateRoleName(e,function(){SnapCloud.renameRole(t,e,function(t){o.onRoomStateUpdate(t)},o.ide.cloudError())}):o.ide.showMessage(localize("Role name already exists.")))},RoomMorph.prototype.evictUser=function(e){var o=this;SnapCloud.evictUser(e.uuid,function(t){o.onRoomStateUpdate(t),o.ide.showMessage("evicted "+e.username+"!")},function(t,e){o.ide.cloudError().call(null,t,e)})},RoomMorph.prototype.inviteUser=function(e){var t,o=this;t=function(t){t.unshift("myself"),o._inviteGuestDialog(e,t)},this.isOwner()||this.isCollaborator()?SnapCloud.getFriendList(t,function(t,e){o.ide.cloudError().call(null,t,e)}):t([])},RoomMorph.prototype.promptShare=function(e){var o=this.getRoleNames(),t={},i=this.world(),r=this;o.splice(o.indexOf(this.ide.projectName),1);for(var n=0;n<o.length;n++)t[o[n]]=o[n];if(Object.keys(o).length){var s=new DialogBoxMorph;s.prompt("Send to...","",i,!1,t),s.accept=function(){var t=s.getInput();-1!==o.indexOf(t)?r.getRole(t)?(r.ide.sockets.sendMessage({type:"share-msg-type",roleId:t,from:r.ide.projectName,name:e,fields:r.ide.stage.messageTypes.getMsgType(e).fields}),r.ide.showMessage("Successfully sent!",2)):(r.sharedMsgs.push({roleId:t,msg:{name:e,fields:r.ide.stage.messageTypes.getMsgType(e).fields},from:r.ide.projectName}),r.ide.showMessage("The role will receive this message type on next occupation.",2)):r.ide.showMessage("There is no role by the name of '"+t+"'!",2),this.destroy()}}else r.ide.showMessage("There are no other roles in the room!",2)},RoomMorph.prototype._inviteGuestDialog=function(e,t){new UserDialogMorph(this,function(t){t&&this.inviteGuest(t,e.id)},t).popUp()},RoomMorph.prototype.inviteGuest=function(t,e){"myself"===t&&(t=SnapCloud.username),SnapCloud.inviteGuest(t,e)},RoomMorph.prototype.promptInvite=function(t,e,o,i){var r,n=this,s=this._invitationResponse.bind(this,t,!0,e),a=new DialogBoxMorph(null,s);r=i===SnapCloud.username?localize('Would you like to move to "')+o+'"?':i+localize(' has invited you to join\nhim/her at "')+o+localize('"\nAccept?'),a.cancel=function(){n._invitationResponse(t,!1,e),delete n.invitations[t],this.destroy()},a.askYesNo("Room Invitation",localize(r),this.ide.world()),this.invitations[t]=a},RoomMorph.prototype._invitationResponse=function(t,e,o){var i=this;SnapCloud.invitationResponse(t,e,function(t){t?(i.ide.source="cloud",i.ide.droppedText(t.SourceCode),"true"===t.Public&&(location.hash="#present:Username="+encodeURIComponent(SnapCloud.username)+"&ProjectName="+encodeURIComponent(t.ProjectName))):i.ide.newRole(o),i.ide.showMessage("you have joined the room!",2),i.ide.silentSetProjectName(o),SnapCloud.disconnect()},function(t){i.ide.showMessage(t,2)})},RoomMorph.prototype.checkForSharedMsgs=function(t){for(var e=0;e<this.sharedMsgs.length;e++)this.sharedMsgs[e].roleId===t&&(this.ide.sockets.sendMessage({type:"share-msg-type",name:this.sharedMsgs[e].msg.name,fields:this.sharedMsgs[e].msg.fields,from:this.sharedMsgs[e].from,roleId:t}),this.sharedMsgs.splice(e,1),e--)},RoomMorph.prototype.showMessage=function(e,o){var n=this,t=e.srcId.split("@"),i=t.shift(),s=t.join("@"),r=e.recipients.filter(function(t){var e=t.split("@"),o=e.shift(),i=e.join("@")===s,r=!!n.getRole(o);return i&&r}).map(function(t){return t.split("@").shift()});this.getRole(i)&&r.forEach(function(t){n.showSentMsg(e,i,t,o)})},RoomMorph.prototype.showSentMsg=function(o,t,e,i){var r=this.getRole(t),n=this.getRole(e).center().subtract(r.center()),s=new SentMessageMorph(o,t,e,n,i);if(this.addBack(s),this.displayedMsgMorphs.push(s),this.updateDisplayedMsg(s),this.clearBlockHighlights(),e===this.getCurrentRoleName()){var a=this.ide.stage,h=a.children.concat(a).map(function(t){var e=[];return(t instanceof SpriteMorph||t instanceof StageMorph)&&(e=t.allHatBlocksForSocket(o.msgType)),e}).reduce(function(t,e){return t.concat(e)},[]);this.blockHighlights=h.map(function(t){return t.addHighlight()})}this.messageInspector&&(i?(this.messageInspector.destroy(),this.messageInspector=null):this.messageInspector.setMessage(s.message))},RoomMorph.prototype.updateDisplayedMsg=function(t){var e,o=this.getRole(t.srcRoleName),i=this.getRole(t.dstRoleName),r=o.center(),n=i.center(),s=n.subtract(r),a=this.getRoleSize()/2,h=n.distanceTo(r),l=h-2*a;e=(s=s.scaleBy(l/h)).abs().add(2*t.padding),t.setExtent(e),t.setCenter(n.add(r).divideBy(2)),t.endpoint=s,t.setMessageColor(o.color.darker()),t.drawNew()},RoomMorph.prototype.clearBlockHighlights=function(){this.blockHighlights.forEach(function(t){var e=t.parent;e&&e.getHighlight()===t&&e.removeHighlight()}),this.blockHighlights=[]},RoomMorph.prototype.hideSentMsgs=function(){this.displayedMsgMorphs.forEach(function(t){t.destroy()}),this.displayedMsgMorphs=[]},RoomMorph.prototype.isCapturingTrace=function(){return this.trace.startTime&&!this.trace.endTime},RoomMorph.prototype.isReplayingTrace=function(){return!!this.trace.replayer},RoomMorph.prototype.startTraceReplay=function(t){this.setReadOnly(!0),t.setMessages(this.trace.messages),this.trace.replayer=t},RoomMorph.prototype.stopTraceReplay=function(){this.hideSentMsgs(),this.clearBlockHighlights(),this.setReadOnly(!1),this.trace.replayer=null,this.messageInspector&&(this.messageInspector.destroy(),this.messageInspector=null)},RoomMorph.prototype.resetTrace=function(){this.trace={}},RoomMorph.prototype.startTrace=function(){var t=this.ide,e=t.resourceURL("api","trace","start",SnapCloud.projectId,SnapCloud.clientId),o=+t.getURL(e);this.trace={startTime:o}},RoomMorph.prototype.endTrace=function(){this.trace.endTime=Date.now(),this.trace.messages=this.getMessagesForTrace(),0===this.trace.messages.length&&(this.ide.showMessage("No messages captured",2),this.resetTrace())},RoomMorph.prototype.getMessagesForTrace=function(){var e=this.ide,t=e.resourceURL("api","trace","end",SnapCloud.projectId,SnapCloud.clientId),o=[];try{o=JSON.parse(e.getURL(t))}catch(t){throw e.showMessage("Failed to retrieve messages",2),this.resetTrace(),t}return o},RoomMorph.prototype.inspectMessage=function(t){this.messageInspector=new MessageInspectorMorph(t),this.messageInspector.popUp(this.world())},SentMessageMorph.prototype=new Morph,SentMessageMorph.prototype.constructor=SentMessageMorph,SentMessageMorph.uber=Morph.prototype,SentMessageMorph.prototype.init=function(t,e,o,i,r){this.srcRoleName=e,this.dstRoleName=o,this.padding=10,this.endpoint=i,this.message=new MessageMorph(t.msgType,t.content),SentMessageMorph.uber.init.call(this),this.label=null,r&&(this.label=new StringMorph(r.toString(),18,null,null,!0),this.label.color=white,this.label.drawNew(),this.add(this.label)),this.color=white,this.add(this.message)},SentMessageMorph.prototype.drawNew=function(){this.image=newCanvas(this.extent());var t,e=this.image.getContext("2d"),o=0<this.endpoint.x,i=0<this.endpoint.y,r=new Point(o?0:-this.endpoint.x,i?0:-this.endpoint.y);t=(r=r.add(this.padding)).add(this.endpoint),e.strokeStyle=this.color.toString(),e.fillStyle=this.color.toString(),e.lineWidth=2.5,e.beginPath(),e.setLineDash([5,5]),e.moveTo(r.x,r.y),e.lineTo(t.x,t.y),e.stroke(),e.beginPath(),e.setLineDash([]);var n=Math.PI/6,s=Math.atan2(this.endpoint.y,this.endpoint.x)+Math.PI,a=new Point(Math.cos(s-n),Math.sin(s-n)).multiplyBy(7.5),h=new Point(Math.cos(s+n),Math.sin(s+n)).multiplyBy(7.5),l=t.add(a),p=t.add(h);e.moveTo(t.x,t.y),e.lineTo(l.x,l.y),e.lineTo(p.x,p.y),e.lineTo(t.x,t.y),e.stroke(),e.fill(),this.fixLayout()},SentMessageMorph.prototype.fixLayout=function(){if(this.message.setCenter(this.center()),this.label){this.label.setCenter(this.message.center()),this.label.setRight(this.message.left()-5)}},SentMessageMorph.prototype.setMessageColor=function(t){this.message.icon.setColor(t)},MessageMorph.prototype=new Morph,MessageMorph.prototype.constructor=MessageMorph,MessageMorph.uber=Morph.prototype,MessageMorph.prototype.init=function(t,e){this.msgType=t,this.contents=e,MessageMorph.uber.init.call(this),this.setColor(IDE_Morph.prototype.groupColor),this.icon=new SymbolMorph("mail",25),this.icon.setHeight(15),this.icon.drawNew(),this.label=new StringMorph(t,12,null,null,!0),this.label.color=white,this.label.drawNew(),this.add(this.label),this.add(this.icon),this.fixLayout()},MessageMorph.prototype.fixLayout=function(){this.icon.setCenter(this.center()),this.icon.setTop(this.top()),this.label.setCenter(this.center()),this.label.setBottom(this.bottom())},MessageMorph.prototype.getTableContents=function(){var o=this,t=Object.keys(this.contents),i=new Table(2,t.length);return t.forEach(function(t,e){i.contents[e][0]=t,i.contents[e][1]=o.deserializeData([o.contents[t]])[0]}),i.colNames.push("field"),i.colNames.push("value"),i},MessageMorph.prototype.deserializeData=WebSocketManager.prototype.deserializeData,MessageMorph.prototype.mouseClickLeft=function(){this.parentThatIsA(RoomMorph).inspectMessage(this)},MessageInspectorMorph.prototype=Object.create(TableDialogMorph.prototype),MessageInspectorMorph.prototype.constructor=MessageInspectorMorph,MessageInspectorMorph.uber=TableDialogMorph.prototype,MessageInspectorMorph.prototype.init=function(t){MessageInspectorMorph.uber.init.call(this,t.getTableContents()),this.key="inspectNetworkMessage",this.labelString=localize("Contents of")+' "'+t.msgType+'"',this.createLabel()},MessageInspectorMorph.prototype.setInitialDimensions=function(){var t=this.world().extent().subtract(new Point(this.padding,this.padding)),e=fontHeight(this.titleFontSize)+3*this.titlePadding,o=Math.max(100,this.label.width()+2*r),i=this.buttons.height(),r=10;this.setExtent(this.tableView.globalExtent().add(new Point(2*this.padding,2*this.padding+e+i)).min(t).max(new Point(o,100))),this.setCenter(this.world().center())},MessageInspectorMorph.prototype.setMessage=function(t){this.tableView=new TableMorph(t.getTableContents()),this.labelString=localize("Contents of")+' "'+t.msgType+'"',this.createLabel(),this.addBody(new TableFrameMorph(this.tableView,!0)),this.drawNew()},NetworkReplayControls.prototype=Object.create(ReplayControls.prototype),NetworkReplayControls.prototype.constructor=NetworkReplayControls,NetworkReplayControls.uber=ReplayControls.prototype,NetworkReplayControls.prototype.init=function(){NetworkReplayControls.uber.init.call(this),this.displayedMsgCount=1},NetworkReplayControls.prototype.displayCaption=function(){},NetworkReplayControls.prototype.setMessages=function(t){return this.setActions(t)},NetworkReplayControls.prototype.applyEvent=function(t,e){this.updateDisplayedMessages(),e()},NetworkReplayControls.prototype.updateDisplayedMessages=function(){var t=this.parentThatIsA(IDE_Morph).room,e=this.actions[this.actionIndex];if(t.hideSentMsgs(),e){var o=this.getSliderPosition(e);if(this.slider.button.setLeft(this.getSliderLeftFromValue(o)),this.slider.updateValue(),1<this.displayedMsgCount)for(var i=Math.min(this.displayedMsgCount,this.actionIndex+1),r=this.actionIndex-i+1,n=0;n<i;n++)e=this.actions[r+n],t.showMessage(e,n+1);else t.showMessage(e)}},NetworkReplayControls.prototype.settingsMenu=function(){var o=this,t=NetworkReplayControls.uber.settingsMenu.call(this),i=new MenuMorph(o);return[1,2,3,4,5].forEach(function(t){var e=1===t?"message":"messages";i.addItem(t+" "+localize(e),function(){o.displayedMsgCount=t,o.updateDisplayedMessages()},null,null,o.displayedMsgCount===t)}),t.addMenu("Displayed Message Count...",i),t.drawNew(),t},NetworkReplayControls.prototype.getColorForTick=function(t){var e=this.parentThatIsA(IDE_Morph).room,o=t.srcId.split("@").shift(),i=e.getRole(o);if(i)return i.color},NetworkReplayControls.prototype.getInverseEvent=function(t){var e=copy(t);return e.isInverse=!0,e},RoleMorph.prototype=new Morph,RoleMorph.prototype.constructor=RoleMorph,RoleMorph.uber=Morph.prototype,RoleMorph.COLORS=[new Color(74,108,212),new Color(217,77,17).lighter(),new Color(207,74,217),new Color(0,161,120),new Color(143,86,227),new Color(230,168,34),new Color(4,148,220),new Color(98,194,19),new Color(243,118,29),new Color(150,150,150)].map(function(t){return t.darker()}),RoleMorph.prototype.init=function(e,t,o){RoleMorph.uber.init.call(this,!0),this.id=e,this.name=t,this.users=[],this.label=new StringMorph(this.name,15,null,!0,!1,!1,null,null,white),this.label.mouseClickLeft=function(){var t=this.parentThatIsA(RoomMorph);t.isEditable()&&t.editRoleName(e)},this.label.mouseEnter=function(){this.parentThatIsA(RoomMorph).isEditable()&&this.setFontSize(17)},this.label.mouseLeave=function(){this.setFontSize(15)},this.caption=new StringMorph("",14,null,!1,!0,!1,null,null,white),this.add(this.label),this.add(this.caption),this.acceptsDrops=!0,this.setOccupants(o),this.drawNew()},RoleMorph.prototype.setName=function(t){this.name=t,this.label.text=t,this.label.drawNew()},RoleMorph.prototype.wantsDropOf=function(t){return t instanceof ReporterBlockMorph&&t.forMsg},RoleMorph.prototype.setOccupants=function(t){this.users=t;var e=localize("<empty>");this.users.length&&(e=this.users.map(function(t){return t.username||localize("guest")}).join(", ")),this.caption.text=e,this.caption.changed(),this.caption.drawNew(),this.caption.changed()},RoleMorph.prototype.setName=function(t){this.name=t,this.label.text=t,this.label.changed(),this.label.drawNew(),this.label.changed()},RoleMorph.prototype.drawNew=function(){var t,e,o,i,r=this.parentThatIsA(RoomMorph);r&&r.isReadOnly?this.caption.hide():this.caption.show(),this.fixLayout(),e=Math.max(this.height()-this.caption.height(),0),o=Math.min(this.width(),e)/2,t=new Point(this.width()/2-o,e/2-o).add(o),this.image=newCanvas(this.extent()),(i=this.image.getContext("2d")).beginPath(),i.fillStyle=this.color.toString(),i.arc(t.x,t.y,o,0,2*Math.PI,!1),i.closePath(),i.fill(),i.strokeStyle=this.color.darker(50).toString(),i.stroke(),this.changed()},RoleMorph.prototype.fixLayout=function(){var t=this.center();this.label.setCenter(new Point(t.x,t.y-this.caption.height()/2)),this.caption.setCenter(t),this.caption.setBottom(this.bottom())},RoleMorph.prototype.mouseClickLeft=function(){var t=this.parentThatIsA(RoomMorph);t.isEditable()?t.editRole(this):this.escalateEvent("mouseClickLeft")},RoleMorph.prototype.reactToDropOf=function(t){if(t instanceof ReporterBlockMorph&&t.forMsg&&i(this,t.blockSpec,this.parent.ide.stage.messageTypes.getMsgType(t.blockSpec).fields),"receiveSocketMessage"===t.selector||"doSocketMessage"===t.selector){for(var e,o=0;o<t.children.length;o++)if(t.children[o]instanceof MessageOutputSlotMorph||t.children[o]instanceof MessageInputSlotMorph){e=t.children[o];break}""!==e.children[0].text&&i(this,e.children[0].text,e.msgFields)}function i(t,e,o){t.users.length&&t.parent.ide.projectName===t.name?t.parent.ide.showMessage("Can't send a message type to yourself!",2):t.users&&t.parent.ide.projectName!==t.name?(t.parent.ide.sockets.sendMessage({type:"share-msg-type",roleId:t.name,from:t.parent.ide.projectName,name:e,fields:o}),t.parent.ide.showMessage("Successfully sent!",2)):(t.parent.sharedMsgs.push({roleId:t.name,msg:{name:e,fields:o},from:t.parent.ide.projectName}),t.parent.ide.showMessage("The role will receive this message type on next occupation.",2))}t.destroy()},EditRoleMorph.prototype=new DialogBoxMorph,EditRoleMorph.prototype.constructor=EditRoleMorph,EditRoleMorph.uber=DialogBoxMorph.prototype,EditRoleMorph.prototype.init=function(t,e){EditRoleMorph.uber.init.call(this),this.room=t,this.role=e,this.users=e.users;var o=new TextMorph(localize("What would you like to do?"),null,null,!0,!1,"center",null,null,MorphicPreferences.isFlat?null:new Point(1,1),white);this.labelString=localize("Edit")+" "+name,this.createLabel(),this.addBody(o),this.addButton("createRoleClone","Duplicate"),e.users.length?(name!==this.room.role()&&this.addButton("moveToRole","Move to"),this.addButton("inviteUser","Invite User"),name!==this.room.role()&&(this.room.isOwner()||this.room.isGuest(e.users))&&this.addButton("evictUser","Evict User")):(this.addButton("moveToRole","Move to"),this.addButton("inviteUser","Invite User"),this.addButton("deleteRole","Delete role")),this.addButton("cancel","Cancel")},EditRoleMorph.prototype.inviteUser=function(){this.room.inviteUser(this.role),this.destroy()},EditRoleMorph.prototype.fixLayout=function(){var t=this.center();EditRoleMorph.uber.fixLayout.call(this),this.label&&this.label.setLeft(t.x-this.label.width()/2),this.body&&this.body.setLeft(t.x-this.body.width()/2)},EditRoleMorph.prototype.editRoleName=function(){this.room.editRoleName(this.role.name),this.destroy()},EditRoleMorph.prototype.createRoleClone=function(){this.room.createRoleClone(this.role.id),this.destroy()},EditRoleMorph.prototype.deleteRole=function(){this.room.deleteRole(this.role),this.destroy()},EditRoleMorph.prototype.moveToRole=function(){var t,e=this,o=this.room.ide,i=this.room.getCurrentRoleName(),r=function(){e.room.moveToRole(e.role)};e.destroy(),0<SnapActions.lastSeen?((t=new DialogBoxMorph(null)).accept=function(){SnapCloud.saveProject(o,function(){o.showMessage("Saved "+i+" to cloud!",2),r()},o.cloudError()),t.destroy()},t.cancel=function(){r(),t.destroy()},t.askYesNo(localize("Save Current Role"),localize("Would you like to save changes to")+" "+i+" "+localize("before moving to")+" "+e.role.name+"?",e.world())):r()},EditRoleMorph.prototype.evictUser=function(){this.room.evictUser(this.role.users[0]),this.destroy()},RoomEditorMorph.prototype=new ScrollFrameMorph,RoomEditorMorph.prototype.constructor=RoomEditorMorph,RoomEditorMorph.uber=ScrollFrameMorph.prototype,RoomEditorMorph.prototype.init=function(t,e){RoomEditorMorph.uber.init.call(this,null,null,e),this.palette=this.createMsgPalette(),this.add(this.palette),this.room=t,this.add(t),this.room.checkForSharedMsgs(this.room.getCurrentRoleName()),this.room.isReplayingTrace()?this.replayControls=this.room.trace.replayer:(this.replayControls=new NetworkReplayControls(this),this.replayControls.hide()),this.add(this.replayControls),this.replayControls.drawNew();var o=new PushButtonMorph(this.room,"createNewRole",new SymbolMorph("plus",12));o.padding=0,o.corner=12,o.color=IDE_Morph.prototype.groupColor,o.highlightColor=IDE_Morph.prototype.frameColor.darker(50),o.pressColor=o.highlightColor,o.labelMinExtent=new Point(36,18),o.labelShadowOffset=new Point(-1,-1),o.labelShadowColor=o.highlightColor,o.labelColor=TurtleIconMorph.prototype.labelColor,o.contrast=this.buttonContrast,o.drawNew(),o.hint=localize("Add a role to the room"),o.fixLayout(),this.add(o),this.addRoleBtn=o,this.room.drawNew(),this.updateControlButtons(),this.acceptsDrops=!1,this.contents.acceptsDrops=!1},RoomEditorMorph.prototype.step=function(){this.version!==this.room.version&&(this.updateControlButtons(),this.version=this.room.version);var t=this.room.ide.stage;this.palette.version!==t.messageTypes.version&&this.updateMsgPalette()},RoomEditorMorph.prototype.show=function(){RoomEditorMorph.uber.show.call(this),this.isReplayMode()||this.replayControls.hide()},RoomEditorMorph.prototype.updateControlButtons=function(){var t=this.parentThatIsA(ScrollFrameMorph);t&&(t.toolBar&&(t.removeChild(t.toolBar),this.changed()),t.toolBar=this.addToggleReplay(),t.add(t.toolBar),t.toolBar.drawNew(),t.toolBar.changed(),t.adjustToolBar(),this.updateRoomControls())},RoomEditorMorph.prototype.addToggleReplay=function(){var t=this,e=new AlignmentMorph,o=new Color(140,140,140),i=new SymbolMorph("circleSolid",14),r=new SymbolMorph("square",14),n=new SymbolMorph("pointRight",14),s=new SymbolMorph("square",14);if(this.hasNetworkRecording()){var a=new PushButtonMorph(this,function(){this.isReplayMode()?t.exitReplayMode():t.enterReplayMode(),t.updateControlButtons()},this.isReplayMode()?s:n,null,this.isReplayMode()?localize("Exit network trace replayer"):localize("View last network trace"));a.alpha=.2,a.labelShadowColor=o,a.drawNew(),a.fixLayout(),e.replayButton=a,e.add(a)}var h=new PushButtonMorph(this,function(){t.toggleRecordMode(),t.updateControlButtons()},this.isRecording()?r:i,null,this.isRecording()?localize("Stop capturing network trace"):localize("Start capturing network trace"));return h.labelColor=new Color(125,0,0),h.alpha=.2,h.labelShadowColor=o,h.drawNew(),h.fixLayout(),e.recordButton=h,e.add(h),e},RoomEditorMorph.prototype.fixLayout=function(){var t=this.extent();t.y=t.y-115,this.room.setExtent(t),this.room.setCenter(this.center().subtract(40)),this.room.fixLayout(),this.updateMsgPalette(),this.palette.setWidth(this.width()/2),this.palette.setHeight(this.center().y),this.addRoleBtn.setCenter(this.room.center()),this.addRoleBtn.setTop(this.room.roomName.bottom()+5),this.replayControls.setWidth(this.width()-40),this.replayControls.setHeight(80),this.replayControls.setCenter(new Point(this.center().x,0)),this.replayControls.setBottom(this.bottom()),this.replayControls.fixLayout()},RoomEditorMorph.prototype.setExtent=function(t){RoomEditorMorph.uber.setExtent.call(this,t),this.fixLayout()},RoomEditorMorph.prototype.isRecording=function(){return this.room.isCapturingTrace()},RoomEditorMorph.prototype.hasNetworkRecording=function(){var t=this.room.trace;return!(!t.startTime||!t.endTime)},RoomEditorMorph.prototype.toggleRecordMode=function(){this.isRecording()?this.exitRecordMode():this.enterRecordMode()},RoomEditorMorph.prototype.enterRecordMode=function(){SnapActions.isCollaborating()?this.room.ide.showMessage(localize("Cannot trace network actions while collaborating")):this.room.startTrace()},RoomEditorMorph.prototype.exitRecordMode=function(){this.room.endTrace()},RoomEditorMorph.prototype.isReplayMode=function(){return this.replayControls.enabled},RoomEditorMorph.prototype.exitReplayMode=function(){this.replayControls.disable(),this.room.stopTraceReplay()},RoomEditorMorph.prototype.enterReplayMode=function(){SnapActions.isCollaborating()?this.room.ide.showMessage(localize("Cannot replay network actions while collaborating")):(this.replayControls.enable(),this.room.startTraceReplay(this.replayControls),this.updateRoomControls())},RoomEditorMorph.prototype.updateRoomControls=function(){this.room.drawNew(),this.room.isEditable()&&!this.isReplayMode()?this.addRoleBtn.show():this.addRoleBtn.hide()},RoomEditorMorph.prototype.createMsgPalette=function(){var t=new ScrollFrameMorph;return t.setColor(new Color(0,0,0,0)),t.padding=12,t.acceptsDrops=!1,t.contents.acceptsDrops=!1,t},RoomEditorMorph.prototype.updateMsgPalette=function(){var t,e=this.room.ide.stage,o=this.palette,i=e.deletableMessageNames();o.contents.children.forEach(function(t){o.contents.removeChild(t)});for(var r=0;r<i.length;r++){(t=new ReporterBlockMorph).category="network",t.blockSpec=i[r],t.setSpec(i[r]),t.forMsg=!0,t.isTemplate=!0,t.setColor(new Color(217,77,17)),t.setPosition(new Point(o.bounds.origin.x+10,o.bounds.origin.y+24*r+6)),t.justDropped=function(){this.destroy()},t.mouseClickLeft=function(){var t=0===e.messageTypes.msgTypes[this.blockSpec].fields.length?"This message type has no fields.":e.messageTypes.msgTypes[this.blockSpec].fields;new SpeechBubbleMorph(t,null,null,2).popUp(this.world(),new Point(0,0).add(this.bounds.corner))};var n=new MenuMorph(this,null);n.addItem("Send to...",function(){this.room.promptShare(t.blockSpec)}),t.children[0].customContextMenu=n,t.customContextMenu=n,o.addContents(t)}},UserDialogMorph.prototype=new DialogBoxMorph,UserDialogMorph.prototype.constructor=UserDialogMorph,UserDialogMorph.uber=DialogBoxMorph.prototype,UserDialogMorph.prototype.init=function(t,e,o){this.key="inviteGuest",this.userList=o,UserDialogMorph.uber.init.call(this,t,e,null),this.buildContents()},UserDialogMorph.prototype.buildContents=function(){this.addBody(new Morph),this.body.color=this.color,this.buildFilterField(),this.listField=new ListMorph(this.userList),this.fixListFieldItemColors(),this.listField.fixLayout=nop,this.listField.edge=InputFieldMorph.prototype.edge,this.listField.fontSize=InputFieldMorph.prototype.fontSize,this.listField.typeInPadding=InputFieldMorph.prototype.typeInPadding,this.listField.contrast=InputFieldMorph.prototype.contrast,this.listField.drawNew=InputFieldMorph.prototype.drawNew,this.listField.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,this.body.add(this.listField),this.labelString=localize("Invite a Friend to the Room"),this.createLabel(),this.addButton("ok","OK"),this.addButton("cancel","Cancel"),this.setHeight(300),this.fixLayout()},UserDialogMorph.prototype.fixLayout=function(){var t=fontHeight(this.titleFontSize)+2*this.titlePadding,e=this.filterField,o=Morph.prototype.trackChanges;Morph.prototype.trackChanges=!1,this.buttons&&0<this.buttons.children.length&&this.buttons.fixLayout(),this.body&&(this.body.setPosition(this.position().add(new Point(this.padding,t+this.padding))),this.body.setExtent(new Point(this.width()-2*this.padding,this.height()-3*this.padding-t-this.buttons.height())),e.setWidth(this.body.width()-6*this.padding),e.setLeft(this.body.left()+3*this.padding),e.drawNew(),this.listField.setLeft(this.body.left()+this.padding),this.listField.setWidth(this.body.width()-this.padding),this.listField.contents.children[0].adjustWidths(),this.listField.setTop(e.bottom()+this.padding),this.listField.setHeight(this.body.height()-e.height()-this.padding),this.magnifiyingGlass&&(this.magnifiyingGlass.setTop(e.top()),this.magnifiyingGlass.setLeft(this.listField.left()))),this.label&&(this.label.setCenter(this.center()),this.label.setTop(this.top()+(t-this.label.height())/2)),this.buttons&&0<this.buttons.children.length&&(this.buttons.setCenter(this.center()),this.buttons.setBottom(this.bottom()-this.padding)),Morph.prototype.trackChanges=o,this.changed()},UserDialogMorph.prototype.fixListFieldItemColors=ProjectDialogMorph.prototype.fixListFieldItemColors,UserDialogMorph.prototype.buildFilterField=ProjectDialogMorph.prototype.buildFilterField,UserDialogMorph.prototype.getInput=function(){return this.listField.selected},UserDialogMorph.prototype.buildFilterField=function(){var t=this;this.filterField=new InputFieldMorph(""),this.magnifiyingGlass=new SymbolMorph("magnifiyingGlass",this.filterField.height(),this.titleBarColor.darker(50)),this.body.add(this.magnifiyingGlass),this.body.add(this.filterField),this.filterField.reactToKeystroke=function(){var e=this.getValue();t.listField.elements=t.userList.filter(function(t){return-1<t.toLowerCase().indexOf(e.toLowerCase())}),0===t.listField.elements.length&&t.listField.elements.push("(no matches)"),t.listField.buildListContents(),t.fixListFieldItemColors(),t.listField.adjustScrollBars(),t.listField.scrollY(t.listField.top()),t.fixLayout()}},UserDialogMorph.prototype.popUp=function(t){var e=t||this.target.world();this.setCenter(e.center()),e&&(ProjectDialogMorph.uber.popUp.call(this,e),this.handle=new HandleMorph(this,200,100,this.corner,this.corner),this.filterField.edit())},CollaboratorDialogMorph.prototype=new UserDialogMorph,CollaboratorDialogMorph.prototype.constructor=CollaboratorDialogMorph,CollaboratorDialogMorph.uber=UserDialogMorph.prototype,CollaboratorDialogMorph.prototype.buildContents=function(){var o=this;this.addBody(new Morph),this.body.color=this.color,this.buildFilterField(),this.listField=new ListMorph(this.userList,0<this.userList.length?function(t){return t.username||t}:null,[["bold",function(t){return t.collaborating}]]),this.listField.action=function(t){void 0!==t&&(t.collaborating?(o.collaborateButton.hide(),o.uncollaborateButton.show()):(o.uncollaborateButton.hide(),o.collaborateButton.show()),o.buttons.fixLayout(),o.fixLayout(),o.edit())},this.filterField.reactToKeystroke=function(){var e=this.getValue();o.listField.elements=o.userList.filter(function(t){return-1<t.username.toLowerCase().indexOf(e.toLowerCase())}),0===o.listField.elements.length&&o.listField.elements.push("(no matches)"),o.listField.buildListContents(),o.fixListFieldItemColors(),o.listField.adjustScrollBars(),o.listField.scrollY(o.listField.top()),o.fixLayout()},this.fixListFieldItemColors(),this.listField.fixLayout=nop,this.listField.edge=InputFieldMorph.prototype.edge,this.listField.fontSize=InputFieldMorph.prototype.fontSize,this.listField.typeInPadding=InputFieldMorph.prototype.typeInPadding,this.listField.contrast=InputFieldMorph.prototype.contrast,this.listField.drawNew=InputFieldMorph.prototype.drawNew,this.listField.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,this.body.add(this.listField),this.labelString=localize("Invite a Friend to Collaborate"),this.createLabel(),this.uncollaborateButton=this.addButton(function(){SnapCloud.evictCollaborator(o.listField.selected.username),o.destroy()},"Remove"),this.collaborateButton=this.addButton("ok","Invite"),this.uncollaborateButton.hide(),this.collaborateButton.hide(),this.addButton("cancel","Cancel"),this.setHeight(300),this.fixLayout()},NetsBloxMorph.prototype=new IDE_Morph,NetsBloxMorph.prototype.constructor=NetsBloxMorph,NetsBloxMorph.uber=IDE_Morph.prototype,NetsBloxMorph.prototype.init=function(t){this.sockets=new WebSocketManager(this),this.room=null,NetsBloxMorph.uber.init.call(this,t),this.serializer=new NetsBloxSerializer;var e=this;window.addEventListener("ideLoaded",function(){e.isSupportedBrowser()||e.showBrowserNotification()})},NetsBloxMorph.prototype.buildPanes=function(){this.createRoom(),NetsBloxMorph.uber.buildPanes.call(this)},NetsBloxMorph.prototype.clearProject=function(){this.source=SnapCloud.username?"cloud":"local",this.stage&&this.stage.destroy(),"#lang:"!==location.hash.substr(0,6)&&(location.hash=""),this.globalVariables=new VariableFrame,this.currentSprite=new SpriteMorph(this.globalVariables),this.sprites=new List([this.currentSprite]),StageMorph.prototype.dimensions=new Point(480,360),StageMorph.prototype.hiddenPrimitives={},StageMorph.prototype.codeMappings={},StageMorph.prototype.codeHeaders={},StageMorph.prototype.enableCodeMapping=!1,StageMorph.prototype.enableInheritance=!1,StageMorph.prototype.enableSublistIDs=!1,SpriteMorph.prototype.useFlatLineEnds=!1,Process.prototype.enableLiveCoding=!1,this.silentSetProjectName(""),this.projectNotes="",this.createStage(),this.add(this.stage),this.createCorral(),this.selectSprite(this.stage.children[0]),this.fixLayout()},NetsBloxMorph.prototype.cloudMenu=function(){var e=NetsBloxMorph.uber.cloudMenu.call(this);return e.children.forEach(function(t){"promptCollaboration"===t.action&&e.removeChild(t)}),SnapCloud.username&&this.room.isOwner()&&(e.addLine(),e.addItem(localize("Collaborators")+"...","manageCollaborators")),e},NetsBloxMorph.prototype.settingsMenu=function(){var t=NetsBloxMorph.uber.settingsMenu.call(this);return t.items=t.items.filter(function(t){return"toggleCollaborativeEditing"!==t[1].toString()}),t},NetsBloxMorph.prototype.newProject=function(e){var o=this,t=function(t){return o.createRoom(),o.room.silentSetRoomName(t.name),e||o.updateUrlQueryString(),SnapActions.openProject().then(function(){o.silentSetProjectName(t.roleName)})};return SnapCloud.newProject(e).then(t).catch(function(){t({name:e||"untitled",roleName:"myRole"})})},NetsBloxMorph.prototype.newRole=function(t){this.clearProject(),t&&this.silentSetProjectName(t)},NetsBloxMorph.prototype.createRoom=function(){this.room=new RoomMorph(this)},NetsBloxMorph.prototype.createSpriteEditor=function(){"room"===this.currentTab?(this.spriteEditor&&this.spriteEditor.destroy(),this.spriteEditor=new RoomEditorMorph(this.room,this.sliderColor),this.spriteEditor.color=this.groupColor,this.add(this.spriteEditor)):NetsBloxMorph.uber.createSpriteEditor.call(this)},NetsBloxMorph.prototype.promptExitTraceReplay=function(t){var e=this;this.confirm("The given action cannot be applied while replaying network trace. \nWould you like to stop replaying the network trace?","Stop replaying network trace?",function(){"room"===this.currentTab?this.spriteEditor.exitReplayMode():e.room.stopTraceReplay(),t()})},NetsBloxMorph.prototype.promptExitTraceCapture=function(t){var e=this;this.confirm("The given action cannot be applied while capturing network trace. \nWould you like to stop capturing the network trace?","Stop capturing network trace?",function(){e.room.endTrace(),t()})},NetsBloxMorph.prototype.setProjectName=function(t){this.room.setRoleName(t)},NetsBloxMorph.prototype.silentSetProjectName=function(t){return NetsBloxMorph.uber.setProjectName.call(this,t)},NetsBloxMorph.prototype.createControlBar=function(){var o=this;NetsBloxMorph.uber.createControlBar.call(this),this.controlBar.updateLabel=function(){var t=o.room.name,e="";1<o.room.getRoleNames().length&&(t=o.projectName||localize("untitled"),e=" @ "+o.room.name),e+=o.world().isDevMode?" - "+localize("development mode"):"",this.label&&this.label.destroy(),o.isAppMode||(document.title=t+e+" - "+o.serializer.appName,this.label=new StringMorph(t+e,14,"sans-serif",!0,!1,!1,MorphicPreferences.isFlat?null:new Point(2,1),o.frameColor.darker(o.buttonContrast)),this.label.color=o.buttonLabelColor,this.label.drawNew(),this.add(this.label),this.label.setCenter(this.center()),this.label.setLeft(this.settingsButton.right()+5))}},NetsBloxMorph.prototype.rawOpenCloudDataString=function(t,e){var o;if(StageMorph.prototype.hiddenPrimitives={},StageMorph.prototype.codeMappings={},StageMorph.prototype.codeHeaders={},StageMorph.prototype.enableCodeMapping=!1,StageMorph.prototype.enableInheritance=!1,StageMorph.prototype.enableSublistIDs=!1,Process.prototype.enableLiveCoding=!1,SnapActions.disableCollaboration(),SnapUndo.reset(),Process.prototype.isCatchingErrors)try{t=e?t:this.serializer.parse(t),this.serializer.loadMediaModel(t.childNamed("media")),o=this.serializer.openProject(this.serializer.loadProjectModel(t.childNamed("project"),this),this)}catch(t){this.showMessage("Load failed: "+t)}else t=e?t:this.serializer.parse(t),this.serializer.loadMediaModel(t.childNamed("media")),o=this.serializer.openProject(this.serializer.loadProjectModel(t.childNamed("project"),this),this);return this.stopFastTracking(),o},NetsBloxMorph.prototype.createSpriteBar=function(){NetsBloxMorph.uber.createSpriteBar.call(this);var t,e=this,o=this.spriteBar.tabBar,i=this.tabColors,r=["Scripts","Costumes","Backgrounds","Sounds"];o.children.sort(function(t,e){var o=r.indexOf(t.labelString),i=r.indexOf(e.labelString);return(o=-1===o?1/0:o)<(i=-1===i?1/0:i)?-1:1}),(t=new TabMorph(i,null,function(){SnapActions.selectTab("room"),o.tabTo("room")},localize("Room"),function(){return"room"===e.currentTab})).padding=3,t.corner=15,t.edge=1,t.labelShadowOffset=new Point(-1,-1),t.labelShadowColor=i[1],t.labelColor=this.buttonLabelColor,t.drawNew(),t.fixLayout(),o.add(t),o.fixLayout(),o.children.forEach(function(t){t.refresh()})},NetsBloxMorph.prototype.projectMenu=function(){var t,r=this,e=NetsBloxMorph.uber.projectMenu.call(this),o=16===this.world().currentKey;o&&(e.items.splice(10,0,[localize("Export role..."),function(){r.projectName?r.exportRole(r.projectName,o):r.prompt("Export Project As...",function(t){r.exportRole(t,!1,!0)},null,"exportRole")},'save "'+r.projectName+'" as XML\nto your downloads folder',new Color(100,0,0)]),e.items.splice(10,0,[localize("Export to Snap! project..."),function(){var t=r.getSnapXml(),e=1===this.room.getRoleCount()?this.room.name:this.projectName;r.saveXMLAs(t,e),r.showMessage("Exported!",1)},'export "'+r.projectName+'" as Snap!-compatible XML',new Color(100,0,0)])),this.stage.deletableMessageNames().length&&!this.stage.globalBlocks.length&&e.items.splice(10,0,["Export blocks/msgs...","exportGlobalBlocks","show global custom block definitions/message types as XML\nin a new browser window"]);var i=-1<this.source.indexOf("cloud");if(SnapCloud.username&&!this.room.isOwner()){t=["Save a Copy","saveACopy"];var n=e.items.map(function(t){return t[1]}).indexOf("save");e.items.splice(n+2,0,t)}else if(i&&this.room.hasMultipleRoles()){e.items.find(function(t){return"save"===t[1]})[0]=localize("Save Role")}if(r.room.isGuest()){var s=e.items.map(function(t){return t[1]}).indexOf("save");e.items.splice(s,2)}return t=[localize("Services..."),function(){var t=r.serviceURL("servicelibs","SERVICELIBS"),e=this.getMediaListFromURL(t),o=localize("Import")+" "+localize("Service"),i=new MenuMorph(r,o);e.forEach(function(e){i.addItem(e.name,function(){var t=r.serviceURL("servicelibs",e.fileName);r.droppedText(r.getURL(t),name)},e.help)}),i.popup(r.world(),r.controlBar.projectButton.bottomLeft())},localize("Select services to include in this project.")],e.items.splice(e.items.length-2,0,t),e},NetsBloxMorph.prototype.serviceURL=function(){var t=Array.prototype.slice.call(arguments,0);return SERVICES_URL+"/"+t.join("/")},NetsBloxMorph.prototype.requestAndroidApp=function(t){var e,o,i,r=this,n=ensureFullUrl("/");t!==this.projectName&&this.setProjectName(t),e=encodeURIComponent(this.serializer.serialize(this.stage)),o=new XMLHttpRequest,i="projectName="+t+"&username="+SnapCloud.username+"&xml="+e+"&baseURL="+encodeURIComponent(n),o.open("post",n+"api/mobile/compile",!0),o.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),o.onload=function(){r.showMessage(o.responseText)},o.send(i)},NetsBloxMorph.prototype.exportRole=NetsBloxMorph.prototype.exportProject,NetsBloxMorph.prototype.exportProject=function(){this.showMessage("Exporting...",3),1===this.room.getRoleCount()?this.exportSingleRoleXml():this.exportMultiRoleXml()},NetsBloxMorph.prototype.exportMultiRoleXml=function(){this.sockets.sendMessage({type:"export-room",action:"export"})},NetsBloxMorph.prototype.getSnapXml=function(){var t=SnapSerializer.prototype.isSavingHistory;1<this.room.getRoleCount()&&this.inform("Multiple Roles Detected","As a Snap! project is equivalent to a role in NetsBlox,\nwe can only export a single role to a Snap! project at\na time.\n\nTo migrate the remaining roles, please export\nthem all individually.",this.world());var e=detect(this.stage.children,function(t){return t instanceof WatcherMorph&&"reportRPCError"===t.getter});if(e){var o=this.stage.children.indexOf(e);this.stage.children.splice(o,1)}SnapSerializer.prototype.isSavingHistory=!1;var i=this.serializer.serialize(this.stage);return SnapSerializer.prototype.isSavingHistory=t,e&&this.stage.children.splice(o,0,e),i},NetsBloxMorph.prototype.getSerializedRole=function(){var t=this.sockets.getSerializedProject();return this.serializer.format('<role name="@">%</role>',this.room.getCurrentRoleName(),t.SourceCode+t.Media)},NetsBloxMorph.prototype.exportSingleRoleXml=function(){try{var t=this.serializer.format('<room name="@" app="@">%</room>',this.room.name,this.serializer.app,this.getSerializedRole());this.exportRoom(t)}catch(t){if(!Process.prototype.isCatchingErrors)throw t;this.showMessage("Export failed: "+t)}},NetsBloxMorph.prototype.exportRoom=function(t){var e=this.room.name;try{this.saveXMLAs(t,e),this.showMessage("Exported!",1)}catch(t){if(!Process.prototype.isCatchingErrors)throw t;this.showMessage("Export failed: "+t)}},NetsBloxMorph.prototype.openRoomString=function(t){var e,o,i=this.serializer.parse(t);if(0!==i.children.length){e=i.children.map(function(t){var e=t.children[0]||"",o=t.children[1]||"";return{ProjectName:t.attributes.name,SourceCode:e.toString(),Media:o.toString()}}),o=i.children[0].attributes.name;var r=this.showMessage("Opening project..."),n=this,s=i.attributes.name;return SnapCloud.importProject(s,o,e).then(function(t){n.room.onRoomStateUpdate(t);var e=["<snapdata>",(o=i.children[0]).childNamed("project").toString(),o.childNamed("media").toString(),"</snapdata>"].join("");return SnapActions.openProject(e).then(function(){r.destroy(),n.sockets.updateRoomInfo()})})}this.showMessage("Malformed project - No roles found.")},NetsBloxMorph.prototype.openCloudDataString=function(t,e){var o=this,i=e?t.toString():t;return IDE_Morph.prototype.openCloudDataString.call(this,i).then(function(){o.sockets.updateRoomInfo()})},NetsBloxMorph.prototype.rawSaveProject=function(t){this.showMessage("Saving",3),t&&(this.room.name=t),this.sockets.sendMessage({type:"export-room",action:"save"})},NetsBloxMorph.prototype.saveRoomLocal=function(t){var e=this.room.name;if(Process.prototype.isCatchingErrors)try{localStorage["-snap-project-"+e]=t,this.setURL("#open:"+t),this.showMessage("Saved to the browser.",1)}catch(t){this.showMessage("Save failed: "+t)}else localStorage["-snap-project-"+e]=t,this.setURL("#open:"+t),this.showMessage("Saved to the browser.",1)},NetsBloxMorph.prototype.openProject=function(t){var e;t&&(this.showMessage("opening project\n"+t),e=localStorage["-snap-project-"+t],this.openRoomString(e),this.setURL("#open:"+e))},NetsBloxMorph.prototype.save=function(){if(this.isPreviousVersion())return this.showMessage("Please exit replay mode before saving");"examples"===this.source&&(this.source="local"),this.room.name?"local"===this.source?this.saveProject(this.room.name):this.saveProjectToCloud(this.room.name):this.saveProjectsBrowser()},NetsBloxMorph.prototype.saveACopy=function(){var e=this;if(this.isPreviousVersion())return this.showMessage("Please exit replay mode before saving");SnapCloud.saveProjectCopy(function(t){t.name&&e.room.silentSetRoomName(t.name),e.showMessage("Made your own copy and saved it to the cloud!",2)},this.cloudError())},NetsBloxMorph.prototype.cloudSaveError=function(){var o=this;return function(t,e){o.shield&&(o.shield.destroy(),o.shield=null),50<t.length&&(t=t.substring(0,50)+"..."),(new DialogBoxMorph).inform("NetsBlox Cloud",(e?e+"\n":"")+t,o.world(),o.cloudIcon(null,new Color(180,0,0)));o.showMessage("Unable to save. Please export project if the problem persists.")}},NetsBloxMorph.prototype.saveProjectToCloud=function(i){var o,r=this;if(SnapCloud.username!==this.room.ownerId)return IDE_Morph.prototype.saveProjectToCloud.call(r,i);o=function(e){var o=r.room.hasMultipleRoles()?r.room.getCurrentRoleName():r.room.name;i&&(r.showMessage("Saving "+o+"\nto the cloud..."),SnapCloud.saveProject(r,function(t){t.name&&r.room.silentSetRoomName(t.name),e?r.showMessage("Saved "+o+" to cloud!",2):r.showMessage("Saved as "+r.room.name,2)},r.cloudSaveError(),e,i))},SnapCloud.hasConflictingStoredProject(i,function(t){if(!t)return r.updateUrlQueryString(),IDE_Morph.prototype.saveProjectToCloud.call(r,i);var e=new DialogBoxMorph(null,function(){o(!0)});e.cancel=function(){o(),e.destroy()},e.askYesNo(localize("Overwrite Existing Project"),localize("A project with the given name already exists.\nWould you like to overwrite it?"),r.world())},this.cloudSaveError())},NetsBloxMorph.prototype.droppedText=function(t,e){if(0===t.indexOf("<rpc"))return this.openBlocksMsgTypeString(t);if(0===t.indexOf("<room"))return location.hash="",this.openRoomString(t);if(0!==t.indexOf("<project"))return IDE_Morph.prototype.droppedText.apply(this,arguments);this.exitReplayMode();var o=this,i=this.showMessage("Opening role..."),r=t.split('app="')[1].split(" ")[0];return SnapActions.openProject(t).then(function(t){var e=t.name;r===o.serializer.appName&&1<o.room.getRoleCount()?o.room.setRoleName(e):o.room.setRoomName(e),i.destroy(),o.sockets.updateRoomInfo()})},NetsBloxMorph.prototype.openBlocksMsgTypeString=function(t){var e,o=this;this.nextSteps([function(){e=o.showMessage("Opening...")},function(){nop()},function(){if(Process.prototype.isCatchingErrors)try{o.rawOpenBlocksMsgTypeString(t)}catch(t){o.showMessage("Load failed: "+t)}else o.rawOpenBlocksMsgTypeString(t)},function(){e.destroy()}])},NetsBloxMorph.prototype.rawOpenBlocksMsgTypeString=function(t){var e=this.serializer.parse(t),o=e.childNamed("messageTypes"),i=e.childNamed("blocks").toString();o&&o.children.forEach(this.serializer.loadMessageType.bind(this,this.stage)),this.rawOpenBlocksString(i,"",!0)},NetsBloxMorph.prototype.initializeCloud=function(){var i=this,t=this.world();new DialogBoxMorph(null,function(t){var e,o=hex_sha512(t.password);SnapCloud.login(t.username,o,t.choice,function(){t.choice&&(e=SnapCloud.encodeDict({username:t.username,password:o}),localStorage["-snap-user"]=e),i.source="cloud",i.showMessage("now connected.",2)},i.cloudError())}).withKey("cloudlogin").promptCredentials("Sign in","login",null,null,null,null,"stay signed in on this computer\nuntil logging out",t,i.cloudIcon(),i.cloudMsg)},NetsBloxMorph.prototype.rawLoadCloudProject=function(t,e){var o=this,i=t.RoomName,r=(t.NewRole,t.ProjectName),n=t.ProjectID;this.source="cloud",t.Owner=t.Owner||SnapCloud.username,this.updateUrlQueryString(i,"true"===e);var s=this.showMessage("Opening project...");return SnapActions.openProject(t.SourceCode).then(function(){SnapCloud.projectId=n,o.room.silentSetRoomName(i),o.room.ownerId=t.Owner,o.silentSetProjectName(r),o.sockets.updateRoomInfo(),s.destroy()})},NetsBloxMorph.prototype.updateUrlQueryString=function(t,e,o){var i=location.pathname;t=t||this.room.name,o?i+="?action=example&ProjectName="+encodeURIComponent(t):e&&(i+="?action=present&Username="+encodeURIComponent(SnapCloud.username)+"&ProjectName="+encodeURIComponent(t)),window.history.pushState(t,t,i)},NetsBloxMorph.prototype.snapMenu=function(){var t,e=this,o=this.world();(t=new MenuMorph(this)).addItem("About...","aboutNetsBlox"),t.addLine(),t.addItem("NetsBlox website",function(){window.open("https://netsblox.org","NetsBloxWebsite")}),t.addItem("Snap! manual",function(){var t=e.resourceURL("help","SnapManual.pdf");window.open(t,"SnapReferenceManual")}),t.addItem("Source code",function(){window.open("https://github.com/netsblox/netsblox")}),t.addLine(),t.addItem("Report a bug","reportBug"),16===o.currentKey&&t.addItem("Load reported bug","loadBugReport",void 0,new Color(100,0,0)),o.isDevMode?(t.addLine(),t.addItem("Switch back to user mode","switchToUserMode","disable deep-Morphic\ncontext menus\nand show user-friendly ones",new Color(0,100,0))):16===o.currentKey&&(t.addLine(),t.addItem("Switch to dev mode","switchToDevMode","enable Morphic\ncontext menus\nand inspectors,\nnot user-friendly!",new Color(100,0,0))),t.popup(o,this.logo.bottomLeft())},NetsBloxMorph.prototype.aboutNetsBlox=function(){NetsBloxSerializer.prototype.app.split(",")[0];var t,e,o=this.world();e="NetsBlox v"+NetsBloxSerializer.prototype.app.split(",")[0].replace(/NetsBlox /,"")+"\n\nNetsBlox is developed by Vanderbilt University with support\n          from the National Science Foundation (NSF)\n\nNetsBlox extends Snap!, from the University of California, Berkeley and \nis influenced and inspired by Scratch, from the Lifelong Kindergarten\ngroup at the MIT Media Lab\n\nfor more information see https://netsblox.org,\nhttp://snap.berkeley.edu and http://scratch.mit.edu",(t=new DialogBoxMorph).inform("About NetsBlox",e,o),t.fixLayout(),t.drawNew()},NetsBloxMorph.prototype.reportBug=function(){var t=(new DialogBoxMorph).withKey("bugReport"),e=new ScrollFrameMorph,o=new TextMorph(""),i=t.ok,r=this,n=this.world();e.padding=6,e.setWidth(250),e.acceptsDrops=!1,e.contents.acceptsDrops=!1,o.setWidth(250-2*e.padding),o.setPosition(e.topLeft().add(e.padding)),o.enableSelecting(),o.isEditable=!0,e.setHeight(250),e.fixLayout=nop,e.edge=InputFieldMorph.prototype.edge,e.fontSize=InputFieldMorph.prototype.fontSize,e.typeInPadding=InputFieldMorph.prototype.typeInPadding,e.contrast=InputFieldMorph.prototype.contrast,e.drawNew=InputFieldMorph.prototype.drawNew,e.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,e.addContents(o),o.drawNew(),t.ok=function(){r.submitBugReport(o.text),i.call(this)},t.justDropped=function(){o.edit()},t.labelString=localize("What went wrong?"),t.createLabel(),t.addBody(e),e.drawNew(),t.addButton("ok","OK"),t.addButton("cancel","Cancel"),t.fixLayout(),t.drawNew(),t.popUp(n),t.setCenter(n.center()),o.edit()},NetsBloxMorph.prototype.submitBugReport=function(t,e){var o,i=this,r=this.world().worldCanvas,n=!!e,s={};if(o=NetsBloxSerializer.prototype.app.replace("NetsBlox ","").replace(/,.*$/,""),s.description=t,s.timestamp=new Date,s.userAgent=navigator.userAgent,s.version=o,s.clientUuid=this.sockets.uuid,s.screenshot=r.toDataURL("image/png"),s.project=this.serializer.serialize(this.stage),s.undoState=SnapUndo,s.user=SnapCloud.username,s.isAutoReport=!!e,s.isAutoReport){var a=SnapActions.currentEvent;s.description=["## Auto-report","Error:",e.stack,"---","Failing Event:",JSON.stringify(a,null,2)].join("\n"),s.error=e,s.event=a}var h=new XMLHttpRequest,l=SnapCloud.url+"/BugReport";h.open("post",l),h.setRequestHeader("Content-Type","application/json; charset=UTF-8"),h.onreadystatechange=function(){4!==h.readyState||n||(199<h.status&&h.status<400?i.showMessage(localize("Bug has been reported!"),2):i.cloudError()(l,localize("bug could not be reported:")+h.responseText))},h.send(JSON.stringify(s))},NetsBloxMorph.prototype.showBugReportScreenshot=function(t){var r=this,n=new Image;n.onload=function(){var t=r.extent().divideBy(1.5),e=Math.min(t.x/n.width,t.y/n.height),o=new Point(n.width,n.height).multiplyBy(e),i=newCanvas(o);i.getContext("2d").drawImage(n,0,0,n.width,n.height,0,0,o.x,o.y),(new DialogBoxMorph).inform("Screenshot",null,r.world(),i)},n.src=t.screenshot},NetsBloxMorph.prototype.loadBugReport=function(){var a=this,e=document.createElement("input");a.filePicker&&(document.body.removeChild(a.filePicker),a.filePicker=null),e.type="file",e.style.color="transparent",e.style.backgroundColor="transparent",e.style.border="none",e.style.outline="none",e.style.position="absolute",e.style.top="0px",e.style.left="0px",e.style.width="0px",e.style.height="0px",e.addEventListener("change",function(){var t=new FileReader;document.body.removeChild(e),a.filePicker=null,t.onloadend=function(t){var e,o,i=JSON.parse(t.target.result),r=i.undoState.allEvents,n=new DialogBoxMorph(null,nop),s={"Show Screenshot":function(){a.showBugReportScreenshot(i)},"Replay All Events":function(){r.push(i.event),a.replayEvents(r),n.destroy()},"Replay Some Events":function(){var t=new Point(0,r.length);new DialogBoxMorph(a,function(t){a.replayEvents(r.slice(t.x,t.y))},a).promptVector("Which events?",t,t,"Start (inclusive)","End (exclusive)",this.world(),null,null),n.destroy()},"Load Project":function(){a.droppedText(i.project),setTimeout(function(){for(var t=Object.keys(i.undoState),e=t.length;e--;)SnapUndo[t[e]]=i.undoState[t[e]];a.confirm("Would you like to apply the failing event?","Apply Failing Event?",function(){SnapActions.applyEvent(i.event)}),a.showMessage("Loaded bug report!")},100),n.destroy()}};e=new Date(i.timestamp),o=["User: "+i.user,"Date: "+e.toDateString()+" "+e.toLocaleTimeString(),"Version: "+i.version,"Browser: "+i.userAgent,"Event Count: "+r.length,"Description:\n\n"+i.description].join("\n"),s.Cancel="cancel",n.ask(localize("Bug Report"),o,a.world(),s)},t.readAsText(e.files[0])},!1),document.body.appendChild(e),(a.filePicker=e).click()},NetsBloxMorph.prototype.manageCollaborators=function(){var o=this,e=this.room.ownerId,i=this.room.name;SnapCloud.getCollaboratorList(function(t){t.sort(function(t,e){return t.username.toLowerCase()<e.username.toLowerCase()?-1:1}),new CollaboratorDialogMorph(o,function(t){t&&SnapCloud.inviteToCollaborate(SnapCloud.clientId,t.username,e,i)},t,"Invite a Collaborator to the Project").popUp()},function(t,e){o.cloudError().call(null,t,e)})},NetsBloxMorph.prototype.promptCollabInvite=function(t){var e,o,i=this,r=t.roomName,n=!1;SnapActions.isCollaborating()||(SnapActions.enableCollaboration(),n=!0),o=t.inviter===SnapCloud.username?'Would you like to collaborate at "'+r+'"?':t.inviter+' has invited you to collaborate with\nhim/her at "'+r+'"\nAccept?',(e=new DialogBoxMorph(null,function(){i.collabResponse(t,!0),e.destroy()})).cancel=function(){i.collabResponse(t,!1),n&&SnapActions.disableCollaboration(),e.destroy()},e.askYesNo("Collaboration Invitation",localize(o),this.world())},NetsBloxMorph.prototype.collabResponse=function(e,o){var i=this;SnapCloud.collabResponse(e.id,o,function(){var t;o&&("Would you like to open the shared project now?",(t=new DialogBoxMorph(null,function(){SnapCloud.reconnect(function(){SnapCloud.joinActiveProject(e.projectId,function(t){i.rawLoadCloudProject(t)},i.cloudError())},i.cloudError()),t.destroy()})).askYesNo(localize("Open Shared Project?"),localize("Would you like to open the shared project now?"),i.world()))},function(t){i.showMessage(t,2)})},NetsBloxMorph.prototype.logout=function(){var t=this;delete localStorage["-snap-user"],SnapCloud.logout(function(){SnapCloud.clear(),t.showMessage("disconnected.",2),t.newProject()},function(){SnapCloud.clear(),t.showMessage("disconnected.",2),t.newProject()})},NetsBloxMorph.prototype.createCloudAccount=function(){var o=this,i=this.world();new DialogBoxMorph(null,function(t){SnapCloud.signup(t.username,t.email,function(t,e){(new DialogBoxMorph).inform(e,t+".\n\nAn e-mail with your password\nhas been sent to the address provided",i,o.cloudIcon(null,new Color(0,180,0)))},o.cloudError())}).withKey("cloudsignup").promptCredentials("Sign up","signup","/tos.html","Terms of Service...","/privacy.html","Privacy...","I have read and agree\nto the Terms of Service",i,o.cloudIcon(),o.cloudMsg)},NetsBloxMorph.prototype.simpleNotification=function(t,e){var o=localize(t),i=new MenuMorph(null,o),r=this.world();i.drawNew();var n=this.spriteBar.center().subtract(new Point(i.width()/2,i.height()/2));i.setPosition(n),i.addShadow(new Point(2,2),80),r.add(i),i.mouseClickLeft=e?nop:i.destroy,i.drawNew()},NetsBloxMorph.prototype.findBlocks=function(r){r=r||{};var o=this.stage.children.filter(function(t){return t instanceof SpriteMorph});o.push(this.stage);for(var n=function(t,e){return t.upperLevel=e,t},s=o.map(function(t){return t.scripts}).map(function(t,e){return t.children.map(function(t){return n(t,o[e])})}).reduce(function(t,e){return t.concat(e)}),a=[];0!==s.length;){var h=s.shift();SnapActions.traverse(h,function(e){if(e.definition){e!==h&&n(e,h);var t=e.definition.scriptsModel();if(1<(t=t.children[0]).children.length){var o=t.children[1];n(o,e),s.push(o)}}var i=!1;r.selectors&&r.selectors.includes(e.selector)?i=!0:r.specs&&r.specs.forEach(function(t){try{e.blockSpec&&-1!==e.blockSpec.toLowerCase().indexOf(t)&&(i=!0)}catch(t){console.error("error when searching for blocks",t)}}),i&&(e!==h&&n(e,h),a.push(e))})}return a},NetsBloxMorph.prototype.blockAddress=function(t){for(var e,o=[],i=function(t){return"["+t.blockSpec.replace(/%/g,"")+"]"};t.upperLevel;){var r=t.upperLevel;o.unshift(void 0!==(e=r).name&&e instanceof SpriteMorph?""===e.name?"S: Sprite":"S: "+e.name:void 0!==e.name?e.name:"evaluateCustomBlock"===e.selector?"CB: "+i(e):i(e)),t=r}return o},NetsBloxMorph.prototype.showUpdateNotification=function(){this.simpleNotification("Newer Version of NetsBlox Available: Please Save and Refresh",!0)},NetsBloxMorph.prototype.showBrowserNotification=function(){this.simpleNotification("It seems you're using an unsupported browser. \n Use an up-to-date Chrome browser for the best experience.")},NetsBloxSerializer.prototype=new SnapSerializer,NetsBloxSerializer.prototype.constructor=NetsBloxSerializer,NetsBloxSerializer.uber=SnapSerializer.prototype,SnapSerializer.prototype.isSavingHistory=!0,NetsBloxSerializer.prototype.appName="NetsBlox",NetsBloxSerializer.prototype.version="1.17.0",NetsBloxSerializer.prototype.app=NetsBloxSerializer.prototype.appName+" "+NetsBloxSerializer.prototype.version+", http://netsblox.org",NetsBloxSerializer.prototype.loadMessageType=function(t,e){var o=e.childNamed("name").contents,i=e.childNamed("fields").children.map(function(t){return t.contents});t.addMessageType({name:o,fields:i})},NetsBloxSerializer.prototype.loadCustomBlock=function(t,e){return"services"===t.attributes.category&&(t.attributes.category="network"),NetsBloxSerializer.uber.loadCustomBlock.call(this,t,e)},SnapSerializer.prototype.getInitialStageSpriteIds=function(t){var e=t.childNamed("stage").attributes.collabId,o=e.split("_").slice(0,2).join("_");return[e,o]},MessageFrame.prototype.toXML=function(e){var o=this;return this.names().map(function(t){return o.getMsgType(t)}).map(function(t){return e.format("<messageType>%</messageType>",e.store(t))}).join("")},MessageType.prototype.toXML=function(e){var t=this.fields.map(function(t){return e.format("<field>%</field>",e.escape(t))}).join("");return e.format("<name>%</name><fields>%</fields>",e.escape(this.name),t)},HintInputSlotMorph.prototype.toXML=function(t){return this.empty?t.format("<l>$</l>",""):InputSlotMorph.prototype.toXML.call(this,t)},SnapActions.addActions("addMessageType","deleteMessageType"),ActionManager.URL="ws://"+SERVER_ADDRESS+"/collaboration",ActionManager.prototype._deleteMessageType=function(t){return[t,this.ide().stage.messageTypes.getMsgType(t).fields]},ActionManager.prototype.onAddMessageType=function(t,e){var o=this.ide();o.stage.addMessageType({name:t,fields:e}),o.flushBlocksCache("network"),o.refreshPalette(),this.completeAction()},ActionManager.prototype.onDeleteMessageType=function(t){var e=this.ide();e.stage.deleteMessageType(t),e.flushBlocksCache("network"),e.refreshPalette(),this.completeAction()},ActionManager.prototype._setField=function(t,e){var o=this.getId(t),i=t.contents().text;return t instanceof HintInputSlotMorph&&t.empty&&(i=""),[o,e,i]},UndoManager.Invert.addMessageType=function(){return"deleteMessageType"},UndoManager.Invert.deleteMessageType=function(){return"addMessageType"},SnapActions.serializer=new NetsBloxSerializer,SnapActions.enableCollaboration=SnapActions.disableCollaboration=function(){},SnapActions.isCollaborating=function(){return 1<this.ide().room.getCurrentOccupants().length},SnapActions.send=function(t){var e=this.ide().sockets;this._ws=e.websocket,t.id=t.id||this.lastSeen+1,this.isUserAction(t)||(this.lastSent=t.id),e.send(JSON.stringify({type:"user-action",action:t}))},SnapActions.onMessage=function(t){ActionManager.prototype.onMessage.apply(this,arguments),-1!==location.hash.indexOf("collaborate")&&(location.hash=""),"session-user-count"===t.type&&(this.sessionUsersCount=t.value)},SnapActions.requestMissingActions=function(t){var e=this.ide().sockets;if(!e.inActionRequest)return e.inActionRequest=!0,e.sendJSON({type:"request-actions",actionId:this.lastSeen,silent:t})},SnapActions.onReceiveAction=function(t){var e=this.lastSeen;if(this.queuedActions.length&&(e=this.queuedActions[this.queuedActions.length-1].id),e<t.id-1)return this.requestMissingActions(!1);ActionManager.prototype.onReceiveAction.apply(this,arguments)},SnapActions.completeAction=function(t){return t&&this.ide().submitBugReport(null,t),ActionManager.prototype.completeAction.apply(this,arguments)},SnapActions.submitIfAllowed=function(t){var e=this,o=this.ide(),i=o.room;"openProject"===t.type?this.submitAction(t):i.isCapturingTrace()?o.promptExitTraceCapture(function(){e.submitIfAllowed(t)}):i.isReplayingTrace()?o.promptExitTraceReplay(function(){e.submitIfAllowed(t)}):i.isEditable()?ActionManager.prototype.submitIfAllowed.call(this,t):o.confirm("Edits cannot be made on projects by guests.\n\nWould you like to request to be made a collaborator?","Request Collaborator Priviledges?",function(){o.sockets.sendMessage({type:"permission-elevation-request",projectId:SnapCloud.projectId,guest:SnapCloud.username})})},SnapActions.isReadOnly=function(){var t=this.ide().room;return!(t.isEditable()&&!t.isCapturingTrace()&&!t.isReplayingTrace()&&!this.ide().isReplayMode)};var clientMBOT=null,PORTA_MBOT="8081",urlConexaoRecenteMBOT="",clienteConectadoMBOT=!1,salaMBOT="1",estacaoMBOT="",macMBOT="",comandoMBOT="",valorMBOT="",LINESENSOR="linesensor",ULTRASOUNDSENSOR="ultrasoundsensor",LIGHTSENSOR="lightsensor",BUTTON="button",BUTTON_PRESSED="pressed",BUTTON_RELEASED="released",IRSENSOR="irsensor",BUZZER="buzzer",DCMOTORM1="dcmotorm1",DCMOTORM2="dcmotorm2",DCMOTOR_FORWARD="forward",DCMOTOR_BACK="back",DCMOTORS="dcmotors",DCMOTORS_BACK="dcmotorsBack",DCMOTORS_RIGHT="dcmotorsRight",DCMOTORS_LEFT="dcmotorsLeft",SERVOMOTOR="servomotor",LEDLEFT="ledleft",LEDRIGHT="ledright",LEDBOTH="ledboth",PLAYNOTE="playnote",SUBSCRICAO="subscricao",line=0,light=0,ultrasound=0,lastmsg=+new Date,min=0;function mBotRecebeValor(t,e){clienteConectadoMBOT=!0,t==LINESENSOR?line=parseInt(e):t==ULTRASOUNDSENSOR?ultrasound=Math.trunc(parseFloat(e)):t==LIGHTSENSOR?light=Math.trunc(parseFloat(e)):t==BUTTON?(button=e,lastbutton!=button&&(lastbutton=button,console.log("button:",+button),console.log("e tem tipo:",typeof button))):t==IRSENSOR&&(ir=e,lastir!=ir&&(lastir=ir,console.log("ir:",+ir),console.log("e tem tipo:",typeof ir)))}function registraConexaoMBOT(t){var e=t.split(","),o=e[0].substring(10).toUpperCase();-1==o.indexOf(":")&&(macMBOT=o.substring(0,2)+":"+o.substring(2,4)+":"+o.substring(4,6)+":"+o.substring(6,8)+":"+o.substring(8,10)+":"+o.substring(10,12)),e[1]&&(salaMBOT=e[1].substring(5),estacaoMBOT=parseInt(e[2].substring(8))<10&&0!=e[2].substring(8).indexOf("0")?"0"+e[2].substring(8):e[2].substring(8)),clienteConectadoMBOT=!0}function registraDesconexaoMBOT(t){sendMessagemBot(SUBSCRICAO,"false,false,false",function(){void 0!==t&&console.log("Entrou para deregistrar MBOT: "+JSON.stringify(t)),clienteConectadoMBOT=!1,clientMBOT.close()})}function statusConnectionmBot(t){t&&""!=t&&"localhost"!=t?-1==t.indexOf(".local")&&(urlConexaoRecenteMBOT=t+".local"):urlConexaoRecenteMBOT="localhost",clienteConectadoMBOT?alert("WS client already connected "+JSON.stringify(clientMBOT)):(clientMBOT=new WebSocket("ws://"+urlConexaoRecenteMBOT+":"+PORTA_MBOT,"echo-protocol"),console.log("WebSocket Client Trying to Connect on Port: "+PORTA_MBOT),clientMBOT.onopen=function(){alert("mBot Connected");var t=JSON.stringify({command:"ready"});clienteConectadoMBOT=!0,clientMBOT.send(t),console.log("WebSocket Client Connected on Port: "+PORTA_MBOT),sendMessagemBot(SUBSCRICAO,"true,true,true",function(t,e){console.log("Comando: "+t+" Valor: "+e)})},clientMBOT.onmessage=function(t){if(clienteConectadoMBOT=!0,-1<t.data.toLowerCase().indexOf("desconectado"))registraDesconexaoMBOT(t.data);else if(-1<t.data.indexOf("conectado"))setTimeout(function(){registraConexaoMBOT(t.data)},1e3);else if(-1<t.data.indexOf("COMANDO_FINAL"))endReturn();else{var e=t.data.split(",");mBotRecebeValor(e[0],e[1])}},clientMBOT.onerror=function(t){alert("Erro de conexão na porta: "+PORTA_MBOT),clienteConectadoMBOT=!1,registraDesconexaoMBOT(t)},clientMBOT.onclose=function(t){console.log("Conexão mBot fechada."),clienteConectadoMBOT=!1,registraDesconexaoMBOT(t)},"false"==clienteConectadoMBOT&&setTimeout(statusConnectionmBot(t),3e3))}function sendMessagemBot(t,e,o){waitForSocketConnectionMBOT(clientMBOT,function(){clientMBOT.send(JSON.stringify({comando:t,valor:e})),waitForSocketConnectionMBOT(clientMBOT,function(){void 0!==o&&o(t,e)})})}function waitForSocketConnectionMBOT(t,e){setTimeout(function(){t.readyState!==t.OPEN?waitForSocketConnectionMBOT(t,e):void 0!==e&&e()},5)}var clientSphero=null,PORTA_SPHERO="8083",urlConexaoRecenteSphero="",clienteConectadoSphero=!1,salaSphero="1",estacaoSphero="",macSphero="",comandoSphero="",valorSphero="",COLOR="color",ROLL="roll",COLISAO="colisao",QUEDA="quedaLivre",ATERRISOU="aterrisou",totalColisoes=0,colisao=!1,quedaLivre=!1,intensidadeQueda=0,fimQuedaLivre=!1,intensidadeAterrisou=0;function isColisao(){return!!colisao&&!(colisao=!1)}function isQuedaLivre(){return!!quedaLivre&&!(quedaLivre=!1)}function isFimQuedaLivre(){return!!fimQuedaLivre&&!(fimQuedaLivre=!1)}function spheroRecebeValor(t,e){t==COLISAO?(colisao=!0,totalColisoes++):t==QUEDA?(quedaLivre=!0,intensidadeQueda=e.valor):t==ATERRISOU&&(fimQuedaLivre=!0,e.valor)}function registraConexaoSphero(t){var e=t.split(","),o=e[0].substring(10).toUpperCase();-1==o.indexOf(":")&&(macSphero=o.substring(0,2)+":"+o.substring(2,4)+":"+o.substring(4,6)+":"+o.substring(6,8)+":"+o.substring(8,10)+":"+o.substring(10,12)),e[1]&&(salaSphero=e[1].substring(5),estacaoSphero=parseInt(e[2].substring(8))<10&&0!=e[2].substring(8).indexOf("0")?"0"+e[2].substring(8):e[2].substring(8)),clienteConectadoSphero=!0}function registraDesconexaoSphero(t){void 0!==t&&console.log("Entrou para deregistrar SPHERO: "+JSON.stringify(t)),clienteConectadoSphero=!1,clientSphero.close()}function statusConnectionSphero(t){t&&""!=t&&"localhost"!=t?-1==t.indexOf(".local")&&(urlConexaoRecenteSphero=t+".local"):urlConexaoRecenteSphero="localhost",clienteConectadoSphero?alert("WS client already connected "+JSON.stringify(clientSphero)):(clientSphero=new WebSocket("ws://"+urlConexaoRecenteSphero+":"+PORTA_SPHERO,"echo-protocol"),console.log("WebSocket Client Trying to Connect on Port: "+PORTA_SPHERO),clientSphero.onopen=function(){var t=JSON.stringify({command:"ready"});clienteConectadoSphero=!0,clientSphero.send(t),console.log("WebSocket Client Connected on Port: "+PORTA_SPHERO)},clientSphero.onmessage=function(t){if(clienteConectadoSphero=!0,-1<t.data.toLowerCase().indexOf("desconectado"))registraDesconexaoSphero(t.data);else if(-1<t.data.indexOf("conectado"))setTimeout(function(){registraConexaoSphero(t.data)},1e3);else if(-1<t.data.indexOf("COMANDO_FINAL"))endReturn();else{var e=t.data.split("=");spheroRecebeValor(e[0],JSON.parse(e[1]))}},clientSphero.onerror=function(t){alert("Erro de conexão na porta: "+PORTA_SPHERO),clienteConectadoMBOT=!1,registraDesconexaoSphero(t)},clientSphero.onclose=function(t){console.log("Conexão SPHERO fechada."),clienteConectadoSphero=!1,registraDesconexaoSphero(t)},"false"==clienteConectadoSphero&&setTimeout(statusConnectionSphero(t),3e3))}function sendMessageSphero(t,e,o){waitForSocketConnectionSPHERO(clientSphero,function(){clientSphero.send(JSON.stringify({comando:t,valor:e})),waitForSocketConnectionSPHERO(clientSphero,function(){void 0!==o&&o(t,e)})})}function waitForSocketConnectionSPHERO(t,e){setTimeout(function(){t.readyState!==t.OPEN?waitForSocketConnectionSPHERO(t,e):void 0!==e&&e()},5)}var clientBLEBIT=null,PORTA_BLEBIT="8080",urlConexaoRecenteBLEBIT="",clienteConectadoBLEBIT=!1,salaBLEBIT="1",estacaoBLEBIT="",macBLEBIT="",valorBLEBIT="",inputBLEBIT=0;function blebitRecebeValor(t){inputBLEBIT=parseInt(t)}function registraConexaoBLEBIT(t){var e=t.split(","),o=e[0].substring(10).toUpperCase();-1==o.indexOf(":")&&(macBLEBIT=o.substring(0,2)+":"+o.substring(2,4)+":"+o.substring(4,6)+":"+o.substring(6,8)+":"+o.substring(8,10)+":"+o.substring(10,12)),e[1]&&(salaBLEBIT=e[1].substring(5),estacaoBLEBIT=parseInt(e[2].substring(8))<10&&0!=e[2].substring(8).indexOf("0")?"0"+e[2].substring(8):e[2].substring(8)),clienteConectadoBLEBIT=!0}function registraDesconexaoBLEBIT(t){void 0!==t&&console.log("Entrou para deregistrarBLEBIT: "+JSON.stringify(t)),clienteConectadoBLEBIT=!1,clientBLEBIT.close()}function statusConnectionBLEBIT(t){t&&""!=t&&"localhost"!=t?-1==t.indexOf(".local")&&(urlConexaoRecenteBLEBIT=t+".local"):urlConexaoRecenteBLEBIT="localhost",clienteConectadoBLEBIT?alert("WS client already connected "+JSON.stringify(clientBLEBIT)):(clientBLEBIT=new WebSocket("ws://"+urlConexaoRecenteBLEBIT+":"+PORTA_BLEBIT,"echo-protocol"),console.log("WebSocket Client Trying to Connect on Port: "+PORTA_BLEBIT),clientBLEBIT.onopen=function(){alert("BLE:Bit Connected"),clienteConectadoBLEBIT=!0,console.log("WebSocket Client Connected on Port: "+PORTA_BLEBIT)},clientBLEBIT.onmessage=function(t){clienteConectadoBLEBIT=!0,-1<t.data.toLowerCase().indexOf("desconectado")?registraDesconexaoBLEBIT(t.data):-1<t.data.indexOf("conectado")?setTimeout(function(){registraConexaoBLEBIT(t.data)},1e3):-1<t.data.indexOf("COMANDO_FINAL")?endReturn():blebitRecebeValor(t.data)},clientBLEBIT.onerror=function(t){alert("Erro de conexão na porta: "+PORTA_BLEBIT),clienteConectadoMBOT=!1,registraDesconexaoBLEBIT(t)},clientBLEBIT.onclose=function(t){console.log("Conexão BLEBIT fechada."),clienteConectadoBLEBIT=!1,registraDesconexaoBLEBIT(t)},"false"==clienteConectadoBLEBIT&&setTimeout(statusConnectionBLEBIT(t),3e3))}function sendMessageBLEBIT(t,e){waitForSocketConnectionBLEBIT(clientBLEBIT,function(){clientBLEBIT.send(t),waitForSocketConnectionBLEBIT(clientBLEBIT,function(){void 0!==e&&e(t)})})}function waitForSocketConnectionBLEBIT(t,e){setTimeout(function(){t.readyState!==t.OPEN?waitForSocketConnectionBLEBIT(t,e):void 0!==e&&e()},5)}var clientArduino=null,PORTA_Arduino=9e3,urlConexaoRecenteArduino="",clienteConectadoArduino=!1,pin_modes_arduino=new Array(30).fill(-1),msg_arduino=null,sonar_report_pin_arduino=-1,digital_inputs_arduino=new Array(32),analog_inputs_arduino=new Array(8),connect_attempt_arduino=!1,wait_open_arduino=[];function isBoardReady(){return clienteConectadoArduino}function registraDesconexaoArduino(t){void 0!==t&&console.log("Entrou para deregistrarArduino: "+JSON.stringify(t)),clienteConectadoArduino=!1,clientArduino.close()}function statusConnectionArduino(t){if(t&&""!=t&&"localhost"!=t?-1==t.indexOf(".local")&&(urlConexaoRecenteArduino=t+".local"):urlConexaoRecenteArduino="localhost",!clienteConectadoArduino){connect_attempt_arduino=!0,clientArduino=new WebSocket("ws://"+urlConexaoRecenteArduino+":"+PORTA_Arduino),console.log("WebSocket Client Trying to Connect on Port: "+PORTA_Arduino);var r=JSON.stringify({id:"to_arduino_gateway"});clientArduino.onopen=function(){alert("Arduino Connected"),digital_inputs_arduino.fill(0),analog_inputs_arduino.fill(0),connect_attempt_arduino=clienteConectadoArduino=!0,clientArduino.send(r),console.log("WebSocket Client Connected on Port: "+PORTA_Arduino);for(var t=0;t<wait_open_arduino.length;t++){var e=wait_open_arduino[t];e[0](e[1])}},clientArduino.onclose=function(t){console.log("Conexão Arduino fechada."),clienteConectadoArduino=!1,registraDesconexaoArduino(t)},clientArduino.onmessage=function(t){clienteConectadoArduino=!0;var e=(r=JSON.parse(t.data)).report,o=null,i=null;"digital_input"===e?(o=r.pin,o=parseInt(o,10),i=r.value,digital_inputs_arduino[o]=i):"analog_input"===e?(o=r.pin,o=parseInt(o,10),i=r.value,analog_inputs_arduino[o]=i):"sonar_data"===e&&(i=r.value,digital_inputs_arduino[sonar_report_pin_arduino]=i)},clientArduino.onerror=function(t){alert("Erro de conexão na porta: "+PORTA_Arduino),clienteConectadoArduino=!1,registraDesconexaoArduino(t)}}}function sendMessageArduino(t,e,o,i){waitForSocketConnectionArduino(clientArduino,function(){clientArduino.send(JSON.stringify({comando:t,pin:e,valor:o})),waitForSocketConnectionArduino(clientArduino,function(){void 0!==i&&i()})})}function waitForSocketConnectionArduino(t,e){setTimeout(function(){t.readyState!==t.OPEN?waitForSocketConnectionArduino(t,e):void 0!==e&&e()},5)}var clientRaspberryPi=null,PORTA_RaspberryPi=9001,urlConexaoRecenteRaspberryPi="",clienteConectadoRaspberryPi=!1,DIGITAL_INPUT=1,DIGITAL_OUTPUT=2,PWM=3,SERVO=4,TONE=5,SONAR=6,ANALOG_INPUT=7,pin_modes=new Array(30).fill(-1),connection_pending=!1,msg=null,sonar_report_pin=-1,digital_inputs=new Array(32),analog_inputs=new Array(8),connect_attempt=!1,wait_open=[];function isRpiReady(){return clienteConectadoRaspberryPi}function registraDesconexaoRaspberryPi(t){void 0!==t&&console.log("Entrou para deregistrarRaspberryPi: "+JSON.stringify(t)),clienteConectadoRaspberryPi=!1,clientRaspberryPi.close()}function statusConnectionRaspberryPi(t){if(t&&""!=t&&"localhost"!=t?-1==t.indexOf(".local")&&(urlConexaoRecenteRaspberryPi=t+".local"):urlConexaoRecenteRaspberryPi="localhost",!clienteConectadoRaspberryPi){connect_attempt=!0,clientRaspberryPi=new WebSocket("ws://"+urlConexaoRecenteRaspberryPi+":"+PORTA_RaspberryPi),console.log("WebSocket Client Trying to Connect on Port: "+PORTA_RaspberryPi);var r=JSON.stringify({id:"to_rpi_gateway"});clientRaspberryPi.onopen=function(){alert("GPIO Connected"),digital_inputs.fill(0),analog_inputs.fill(0),connect_attempt=clienteConectadoRaspberryPi=!0,clientRaspberryPi.send(r),console.log("WebSocket Client Connected on Port: "+PORTA_RaspberryPi);for(var t=0;t<wait_open.length;t++){var e=wait_open[t];e[0](e[1])}},clientRaspberryPi.onclose=function(t){console.log("Conexão RaspberryPi fechada."),clienteConectadoRaspberryPi=!1,registraDesconexaoRaspberryPi(t)},clientRaspberryPi.onmessage=function(t){clienteConectadoRaspberryPi=!0;var e=(r=JSON.parse(t.data)).report,o=null,i=null;"digital_input"===e?(o=r.pin,o=parseInt(o,10),i=r.value,digital_inputs[o]=i):"analog_input"===e?(o=r.pin,o=parseInt(o,10),i=r.value,analog_inputs[o]=i):"sonar_data"===e&&(i=r.value,digital_inputs[sonar_report_pin]=i)},clientRaspberryPi.onerror=function(t){alert("Erro de conexão na porta: "+PORTA_RaspberryPi),clienteConectadoRaspberryPi=!1,registraDesconexaoRaspberryPi(t)}}}function sendMessageRaspberryPi(t,e,o,i){waitForSocketConnectionRaspberryPi(clientRaspberryPi,function(){clientRaspberryPi.send(JSON.stringify({comando:t,pin:e,valor:o})),waitForSocketConnectionRaspberryPi(clientRaspberryPi,function(){void 0!==i&&i()})})}function waitForSocketConnectionRaspberryPi(t,e){setTimeout(function(){t.readyState!==t.OPEN?waitForSocketConnectionRaspberryPi(t,e):void 0!==e&&e()},5)}var clientLampBLE=null,PORTA_LampBLE=8090,urlConexaoRecenteLampBLE="",clienteConectadoLampBLE=!1,salaLampBLE="1",estacaoLampBLE="",macLampBLE="",valorLampBLE="",inputLampBLE=0,LAMPADA_RGB="lampadargb",LAMPADA_BRANCA="lampadabranca";function lampBLERecebeValor(t){console.log("lampBLERecebeValor = valorLampBLE: "+t),inputLampBLE=parseInt(t)}function registraConexaoLampBLE(t){var e=t.split(","),o=e[0].substring(10).toUpperCase();-1==o.indexOf(":")&&(macLampBLE=o.substring(0,2)+":"+o.substring(2,4)+":"+o.substring(4,6)+":"+o.substring(6,8)+":"+o.substring(8,10)+":"+o.substring(10,12)),e[1]&&(salaLampBLE=e[1].substring(5),estacaoLampBLE=parseInt(e[2].substring(8))<10&&0!=e[2].substring(8).indexOf("0")?"0"+e[2].substring(8):e[2].substring(8)),clienteConectadoLampBLE=!0}function registraDesconexaoLampBLE(t){void 0!==t&&console.log("Entrou para deregistrarLampBLE: "+JSON.stringify(t)),clienteConectadoLampBLE=!1,clientLampBLE.close()}function statusConnectionLampBLE(t){t&&""!=t&&"localhost"!=t?-1==t.indexOf(".local")&&(urlConexaoRecenteLampBLE=t+".local"):urlConexaoRecenteLampBLE="localhost",clienteConectadoLampBLE?alert("WS client already connected "+JSON.stringify(clientLampBLE)):(clientLampBLE=new WebSocket("ws://"+urlConexaoRecenteLampBLE+":"+PORTA_LampBLE,"echo-protocol"),console.log("WebSocket Client Trying to Connect on Port: "+PORTA_LampBLE),clientLampBLE.onopen=function(){alert("BLE Lamp Connected"),clienteConectadoLampBLE=!0,console.log("WebSocket Client Connected on Port: "+PORTA_LampBLE)},clientLampBLE.onmessage=function(t){clienteConectadoLampBLE=!0,-1<t.data.toLowerCase().indexOf("desconectado")?registraDesconexaoLampBLE(t.data):-1<t.data.indexOf("conectado")?setTimeout(function(){registraConexaoLampBLE(t.data)},1e3):-1<t.data.indexOf("COMANDO_FINAL")?endReturn():lampBLERecebeValor(t.data)},clientLampBLE.onerror=function(t){alert("Erro de conexão na porta: "+PORTA_LampBLE),clienteConectadoMBOT=!1,registraDesconexaoLampBLE(t)},clientLampBLE.onclose=function(t){console.log("Conexão LampBLE fechada."),clienteConectadoLampBLE=!1,registraDesconexaoLampBLE(t)},"false"==clienteConectadoLampBLE&&setTimeout(statusConnectionLampBLE(t),3e3))}function sendMessageLampBLE(t,e,o){waitForSocketConnectionLampBLE(clientLampBLE,function(){clientLampBLE.send(JSON.stringify({comando:t,valor:e})),waitForSocketConnectionLampBLE(clientLampBLE,function(){void 0!==o&&o(t,e)})})}function waitForSocketConnectionLampBLE(t,e){setTimeout(function(){t.readyState!==t.OPEN?waitForSocketConnectionLampBLE(t,e):void 0!==e&&e()},5)}SyntaxElementMorph.prototype.originalLabelPart=SyntaxElementMorph.prototype.labelPart,SyntaxElementMorph.prototype.labelPart=function(t){var e,o=this;switch(t){case"%onoff":e=new InputSlotMorph(null,!0,{0:"0",1:"1"});break;case"%mbot1":(e=new InputSlotMorph(null,!0,{"(0) stop":"0","(70) slow":70,"(125) fast":125,"(255) max":255,"(-70) reverse slow":-70,"(-125) reverse fast":-125,"(-255) reverse max":-255})).setContents(["(125) fast"]);break;case"%mbot2":(e=new InputSlotMorph(null,!1,{Both:"Both",M1:"M1",M2:"M2"})).setContents(["Both"]);break;case"%mbot3":(e=new InputSlotMorph(null,!1,{Port1:"1",Port2:"2",Port3:"3",Port4:"4"})).setContents("1");break;case"%mbot4":(e=new InputSlotMorph(null,!0,{1:"1",2:"2"})).setContents("1");break;case"%mbot5":(e=new InputSlotMorph(null,!0,{0:"0",45:45,90:90,135:135})).setContents("45");break;case"%mbot6":(e=new InputSlotMorph(null,!1,{Both:["Both"],1:"1",2:"2"})).setContents(["Both"]);break;case"%mbot7":(e=new InputSlotMorph(null,!1,{C2:"C2",D2:"D2",E2:"E2",F2:"F2",G2:"G2",A2:"A2",B2:"B2",C3:"C3",D3:"D3",E3:"E3",F3:"F3",G3:"G3",A3:"A3",B3:"B3",C4:"C4",D4:"D4",E4:"E4",F4:"F4",G4:"G4",A4:"A4",B4:"B4",C5:"C5",D5:"D5",E5:"E5",F5:"F5",G5:"G5",A5:"A5",B5:"B5",C6:"C6",D6:"D6",E6:"E6",F6:"F6",G6:"G6",A6:"A6",B6:"B6",C7:"C7",D7:"D7",E7:"E7",F7:"F7",G7:"G7",A7:"A7",B7:"B7",C8:"C8",D8:"D8"})).setContents("B4");break;case"%mbot8":(e=new InputSlotMorph(null,!1,{Half:"1/2",Quater:"1/4",Eighth:"1/8",Whole:"1",Double:"2"})).setContents(["Quater"]);break;case"%mbot9":(e=new InputSlotMorph(null,!1,{Clockwise:["Clockwise"],"Counter-Clockwise":["Counter-Clockwise"]})).setContents(["Clockwise"]);break;case"%arduino1":e=new InputSlotMorph(null,!1,{"digital input":["digital input"],"digital output":["digital output"],PWM:["PWM"],servo:["servo"]},!0);break;case"%arduino2":e=new InputSlotMorph(null,!1,{1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,10:10,11:11,12:12,13:13,A0:"A0",A1:"A1",A2:"A2",A3:"A3",A4:"A4",A5:"A5"});break;case"%arduino3":(e=new InputSlotMorph(null,!1,{min:"min",max:"max",angulo:90})).setContents("angulo");break;case"%arduinoHIGHLOW":e=new InputSlotMorph(null,!1,{HIGH:"HIGH",LOW:"LOW"});break;case"%arduinoPWM":e=new InputSlotMorph(null,!1,{"3~":3,"5~":5,"6~":6,"9~":9,"10~":10,"11~":11});break;case"%arduinoANALOG":e=new InputSlotMorph(null,!1,{A0:"A0",A1:"A1",A2:"A2",A3:"A3",A4:"A4",A5:"A5"});break;case"%arduinoDIGITAL":e=new InputSlotMorph(null,!0,{1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,10:10,11:11,12:12,13:13,14:14,15:15,16:16,17:17,18:18,19:19});break;case"%usedDigitalPins":(e=new InputSlotMorph(null,!0,function(){for(var t=[],e=0;e<pins.length;e++)pins&&(t.push=pins);return t||[]})).originalChanged=e.changed,e.changed=function(){e.originalChanged(),o.toggle&&o.toggle.refresh()};break;case"%sphero1":(e=new InputSlotMorph(!0,!1,{white:["white"],black:["black"],red:["red"],green:["green"],blue:["blue"]})).setContents(["white"]);break;case"%blebit1":(e=new InputSlotMorph(null,!1,{on:["on"],off:["off"]})).setContents(["on"]);break;case"%RGBW":(e=new InputSlotMorph(null,!1,{white:["white"],red:["red"],green:["green"],blue:["blue"]})).setContents(["white"]);break;case"%rpipins":e=new InputSlotMorph(null,!0,{2:"2",3:"3",4:"4",5:"5",6:"6",7:"7",8:"8",9:"9",10:"10",11:"11",12:"12",13:"13",14:"14",15:"15",16:"16",17:"17",18:"18",19:"19",20:"20",21:"21",22:"22",23:"23",24:"24",25:"25",26:"26",27:"27"});break;case"%ClassNumber":e=new InputSlotMorph(null,!0,{1:1,2:2,3:3,4:4});break;case"%ClassStations":e=new InputSlotMorph(null,!1,{1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,10:10,11:11,12:12,13:13,14:14,15:15,16:16,17:17,18:18,19:19,20:20,21:21});break;case"%RemoteStations":e=new InputSlotMorph(null,!1,{A:"A",B:"B",C:"C",D:"D",E:"E",F:"F",G:"G",H:"H"});break;default:e=this.originalLabelPart(t)}return e},IDE_Morph.prototype.originalSetLanguage=IDE_Morph.prototype.setLanguage,IDE_Morph.prototype.setLanguage=function(t,e){var o=this;o.originalSetLanguage(t,function(){o.setLanguageMM(t,e)})},IDE_Morph.prototype.setLanguageMM=function(t,e){var o=document.getElementById("mm-language"),i="mm/lang-"+t+".js",r=this;if(o&&document.head.removeChild(o),"en"===t)return this.reflectLanguage("en",e);(o=document.createElement("script")).id="mm-language",o.onload=function(){r.reflectLanguage(t,e)},document.head.appendChild(o),o.src=i},SpriteMorph.prototype.originalInit=SpriteMorph.prototype.init,SpriteMorph.prototype.init=function(t){this.originalInit(t)},SpriteMorph.prototype.categories.push("mBot"),SpriteMorph.prototype.categories.push("Sphero"),SpriteMorph.prototype.categories.push("LittleBits"),SpriteMorph.prototype.categories.push("SalaIoT"),SpriteMorph.prototype.categories.push("Arduino"),SpriteMorph.prototype.categories.push("RaspberryPi"),SpriteMorph.prototype.blockColor.mBot=new Color(20,193,253),SpriteMorph.prototype.blockColor.Sphero=new Color(0,100,200),SpriteMorph.prototype.blockColor.LittleBits=new Color(74,0,139),SpriteMorph.prototype.blockColor.SalaIoT=new Color(180,180,180),SpriteMorph.prototype.blockColor.Arduino=new Color(29,32,135),SpriteMorph.prototype.blockColor.RaspberryPi=new Color(42,75,29),SpriteMorph.prototype.originalInitBlocks=SpriteMorph.prototype.initBlocks,SpriteMorph.prototype.initMindMakersBlocks=function(){this.blocks.mBotUltraSonic={type:"reporter",category:"mBot",spec:"ultrasonic sensor"},this.blocks.mBotLightSensor={type:"reporter",category:"mBot",spec:"light sensor"},this.blocks.mBotLineFollower={type:"reporter",category:"mBot",spec:"line follower"},this.blocks.mBotRun={type:"command",category:"mBot",spec:"move motor left: %mbot1 right: %mbot1",defaults:[125,125]},this.blocks.mBotStop={type:"command",category:"mBot",spec:"stop"},this.blocks.mBotMotor={type:"command",category:"mBot",spec:"set motor %mbot2 to %mbot1",defaults:[["Both"],125]},this.blocks.mBotTurn={type:"command",category:"mBot",spec:"motors turn %mbot9 speed %mbot1",defaults:[["Clockwise"],125]},this.blocks.mBotServo={type:"command",category:"mBot",spec:"set servo port: %mbot3 slot: %mbot4 angle: %mbot5",defaults:["1","1",100]},this.blocks.mBotLed={type:"command",category:"mBot",spec:"set LED %mbot6 R: %n G: %n B: %n",defaults:[["Both"],255,255,255]},this.blocks.mBotBuzzer={type:"command",category:"mBot",spec:"play tone on note: %mbot7 beat: %mbot8",defaults:["B4","1/4"]},this.blocks.ArduinoReportConnected={type:"predicate",category:"Arduino",spec:"arduino connected?"},this.blocks.ArduinoDigital_write={type:"command",category:"Arduino",spec:"write digital pin %arduinoDIGITAL %onoff",defaults:["2",1]},this.blocks.ArduinoPMW_write={type:"command",category:"Arduino",spec:"write PWM pin %arduinoPWM %n %",defaults:["3","51"]},this.blocks.ArduinoTone_on={type:"command",category:"Arduino",spec:"tone pin %arduinoDIGITAL %n Hz %n ms",defaults:["2","100","50"]},this.blocks.ArduinoServo={type:"command",category:"Arduino",spec:"write servo pin %arduinoDIGITAL %n Deg.",defaults:["2",90]},this.blocks.ArduinoAnalog_Read={type:"reporter",category:"Arduino",spec:"read analog pin %arduinoANALOG",defaults:["A0"]},this.blocks.ArduinoDigital_Read={type:"reporter",category:"Arduino",spec:"read digital pin %arduinoDIGITAL",defaults:["2"]},this.blocks.ArduinoSonar_read={type:"reporter",category:"Arduino",spec:"read sonar  T %arduinoDIGITAL  E %arduinoDIGITAL",defaults:["2","3"]},this.blocks.RaspberryPiReportConnected={type:"predicate",category:"RaspberryPi",spec:"raspberryPi connected?"},this.blocks.RpiRemoteIP={type:"command",category:"RaspberryPi",spec:"connect to remote station: %RemoteStations",defaults:["A"]},this.blocks.RpiDigital_write={type:"command",category:"RaspberryPi",spec:"write digital pin %rpipins %onoff",defaults:["2","1"]},this.blocks.RpiPMW_write={type:"command",category:"RaspberryPi",spec:"write PWM pin %rpipins %n %",defaults:["2","50"]},this.blocks.RpiTone_on={type:"command",category:"RaspberryPi",spec:"tone pin %rpipins %n Hz %n ms",defaults:["2","100","50"]},this.blocks.RpiServo={type:"command",category:"RaspberryPi",spec:"write servo pin %rpipins %n Deg.",defaults:["2",90]},this.blocks.RpiDigital_Read={type:"reporter",category:"RaspberryPi",spec:"read digital pin %rpipins",defaults:["2"]},this.blocks.RpiSonar_read={type:"reporter",category:"RaspberryPi",spec:"read sonar  T %rpipins  E %rpipins",defaults:["2","3"]},this.blocks.SpheroTotalColisoes={type:"reporter",category:"Sphero",spec:"total collisions"},this.blocks.SpheroResetColisoes={type:"command",category:"Sphero",spec:"set total collisions to 0"},this.blocks.SpheroLED={type:"command",category:"Sphero",spec:"set LED to %sphero1",defaults:["white"]},this.blocks.BLEout={type:"command",category:"LittleBits",spec:"set value to %n",defaults:[125]},this.blocks.BLEoutTxt={type:"command",category:"LittleBits",spec:"set value to %blebit1",defaults:[["on"]]},this.blocks.BLEin={type:"reporter",category:"LittleBits",spec:"Bit input value"},this.blocks.LampBLEonoff={type:"command",category:"SalaIoT",spec:"set white mode to %blebit1",defaults:[["on"]]},this.blocks.LampBLERGB={type:"command",category:"SalaIoT",spec:"set color mode to R: %n , G: %n , B: %n",defaults:[255,255,255]},this.blocks.LampBLEAnyClr={type:"command",category:"SalaIoT",spec:"set color mode to %clr"},this.blocks.LampBLEIntensity={type:"command",category:"SalaIoT",spec:"set color mode to %RGBW with intensity %n",defaults:[["white"],100]}},SpriteMorph.prototype.initBlocks=function(){this.originalInitBlocks(),this.initMindMakersBlocks()},SpriteMorph.prototype.initBlocks(),SpriteMorph.prototype.originalBlockTemplates=SpriteMorph.prototype.blockTemplates,SpriteMorph.prototype.blockTemplates=function(t){var e=this.originalBlockTemplates(t);function o(t){if(StageMorph.prototype.hiddenPrimitives[t])return null;var e=SpriteMorph.prototype.blockForSelector(t,!0);return e.isTemplate=!0,e}return this.mBotConnectButton=new PushButtonMorph(null,function(){this.statusConnectionmBot()},"Connect mBot"),this.mBotDisconnectButton=new PushButtonMorph(null,function(){this.registraDesconexaoMBOT()},"Disconnect mBot"),this.SpheroConnectButton=new PushButtonMorph(null,function(){this.statusConnectionSphero()},"Connect Sphero"),this.SpheroDisconnectButton=new PushButtonMorph(null,function(){this.registraDesconexaoSphero()},"Disconnect Sphero"),this.BLEBitConnectButton=new PushButtonMorph(null,function(){this.statusConnectionBLEBIT()},"Connect BLEBit"),this.BLEBitDisconnectButton=new PushButtonMorph(null,function(){this.registraDesconexaoBLEBIT()},"Disconnect BLEBit"),this.ArduinoConnectButton=new PushButtonMorph(null,function(){this.statusConnectionArduino()},"Connect Arduino"),this.ArduinoDisconnectButton=new PushButtonMorph(null,function(){this.registraDesconexaoArduino()},"Disconnect Arduino"),this.RaspberryPiConnectButton=new PushButtonMorph(null,function(){this.statusConnectionRaspberryPi()},"Connect RaspberryPi"),this.RaspberryPiDisconnectButton=new PushButtonMorph(null,function(){this.registraDesconexaoRaspberryPi()},"Disconnect RaspberryPi"),this.LampBLEConnectButton=new PushButtonMorph(null,function(){this.statusConnectionLampBLE()},"Connect LampBLE"),this.LampBLEDisconnectButton=new PushButtonMorph(null,function(){this.registraDesconexaoLampBLE()},"Disconnect LampBLE"),"mBot"===t?(e.push(this.mBotConnectButton),e.push(this.mBotDisconnectButton),e.push("-"),e.push(o("mBotUltraSonic")),e.push(o("mBotLightSensor")),e.push(o("mBotLineFollower")),e.push("-"),e.push(o("mBotStop")),e.push(o("mBotRun")),e.push(o("mBotMotor")),e.push(o("mBotTurn")),e.push("-"),e.push(o("mBotServo")),e.push(o("mBotLed")),e.push(o("mBotBuzzer"))):"Sphero"===t?(e.push(this.SpheroConnectButton),e.push(this.SpheroDisconnectButton),e.push("-"),e.push(o("SpheroTotalColisoes")),e.push("-"),e.push(o("SpheroResetColisoes")),e.push("-"),e.push(o("SpheroLED"))):"LittleBits"===t?(e.push(this.BLEBitConnectButton),e.push(this.BLEBitDisconnectButton),e.push("-"),e.push(o("BLEin")),e.push("-"),e.push(o("BLEout")),e.push(o("BLEoutTxt"))):"Arduino"===t?(e.push(this.ArduinoConnectButton),e.push(this.ArduinoDisconnectButton),e.push("-"),e.push(o("ArduinoReportConnected")),e.push("="),e.push(o("ArduinoAnalog_Read")),e.push("-"),e.push(o("ArduinoDigital_Read")),e.push("-"),e.push(o("ArduinoSonar_read")),e.push("="),e.push(o("ArduinoDigital_write")),e.push("-"),e.push(o("ArduinoPMW_write")),e.push("-"),e.push(o("ArduinoTone_on")),e.push("-"),e.push(o("ArduinoServo")),e.push("-")):"SalaIoT"===t?(e.push(this.LampBLEConnectButton),e.push(this.LampBLEDisconnectButton),e.push("="),e.push(o("LampBLEonoff")),e.push("-"),e.push(o("LampBLEIntensity")),e.push("-"),e.push(o("LampBLEAnyClr")),e.push("-"),e.push(o("LampBLERGB")),e.push("-")):"RaspberryPi"===t&&(e.push(this.RaspberryPiConnectButton),e.push(this.RaspberryPiDisconnectButton),e.push("-"),e.push(o("RpiRemoteIP")),e.push("-"),e.push(o("RaspberryPiReportConnected")),e.push("="),e.push(o("RpiDigital_Read")),e.push("-"),e.push(o("RpiSonar_read")),e.push("="),e.push(o("RpiDigital_write")),e.push("-"),e.push(o("RpiPMW_write")),e.push("-"),e.push(o("RpiTone_on")),e.push("-"),e.push(o("RpiServo")),e.push("-")),e},SpriteMorph.prototype.mBotUltraSonic=function(){if(0!=clienteConectadoMBOT)return ultrasound;alert("mBot not connected")},SpriteMorph.prototype.mBotLightSensor=function(){if(0!=clienteConectadoMBOT)return light;alert("mBot not connected")},SpriteMorph.prototype.mBotLineFollower=function(){if(0!=clienteConectadoMBOT)return line;alert("mBot not connected")},SpriteMorph.prototype.mBotRun=function(t,e){if(!o)var o=-1;if(!i)var i=-1;t!=o&&(255<(o=t)?t=255:t<-255&&(t=-255),sendMessagemBot(DCMOTORM1,0<=t?DCMOTOR_FORWARD+","+t:DCMOTOR_BACK+","+(t=-t)));e!=i&&(255<(i=e)?e=255:e<-255&&(e=-255),sendMessagemBot(DCMOTORM2,0<=e?DCMOTOR_FORWARD+","+e:DCMOTOR_BACK+","+(e=-e)))},SpriteMorph.prototype.mBotTurn=function(t,e){(255<e&&(e=255),e<-255&&(e=-255),"Clockwise"==t)?0<=e?sendMessagemBot(DCMOTORS_RIGHT,e+",0,0"):sendMessagemBot(DCMOTORS_LEFT,(e=-e)+",0,0"):0<=e?sendMessagemBot(DCMOTORS_LEFT,e+",0,0"):sendMessagemBot(DCMOTORS_RIGHT,(e=-e)+",0,0")},SpriteMorph.prototype.mBotStop=function(){sendMessagemBot(DCMOTORS,"0,0,0")},SpriteMorph.prototype.mBotMotor=function(t,e){if(255<e&&(e=255),e<-255&&(e=-255),"M1"==t)sendMessagemBot(DCMOTORM1,0<=e?DCMOTOR_FORWARD+","+e:DCMOTOR_BACK+","+(e=-e));else if("M2"==t){if(0<=e)sendMessagemBot(DCMOTORM2,DCMOTOR_FORWARD+","+e);else sendMessagemBot(DCMOTORM2,DCMOTOR_BACK+","+(e=-e))}else{if(0<=e)sendMessagemBot(DCMOTORS,e+",0,0");else sendMessagemBot(DCMOTORS_BACK,(e=-e)+",0,0")}},SpriteMorph.prototype.mBotServo=function(t,e,o){var i=+new Date;1e3<i-lastmsg&&(lastmsg=i,150<o&&(o=150),sendMessagemBot(SERVOMOTOR,t+","+e+","+o))},SpriteMorph.prototype.mBotLed=function(t,e,o,i){var r=+new Date;if(1e3<r-lastmsg)if(lastmsg=r,255<e&&(e=255),255<o&&(o=255),255<i&&(i=255),"1"==t)sendMessagemBot(LEDLEFT,e+","+o+","+i);else if("2"==t){sendMessagemBot(LEDRIGHT,e+","+o+","+i)}else{sendMessagemBot(LEDBOTH,e+","+o+","+i)}},SpriteMorph.prototype.mBotBuzzer=function(tone,beat){min=min<125?125:1e3*eval(beat);var now=+new Date;if(min<now-lastmsg){lastmsg=now;var comando=PLAYNOTE,valor=tone+","+beat;sendMessagemBot(comando,valor)}else console.log("too fast")},SpriteMorph.prototype.ArduinoReportConnected=function(){return isBoardReady()},SpriteMorph.prototype.ArduinoDigital_write=function(t,e){t=parseInt(t,10),1<(e=parseInt(e,10))?e=1:e<0&&(e=0),pin_modes_arduino[t]!==DIGITAL_OUTPUT&&(pin_modes_arduino[t]=DIGITAL_OUTPUT,msg={command:"set_mode_digital_output",pin:t},msg=JSON.stringify(msg),console.log(msg),clientArduino.send(msg)),msg={command:"digital_write",pin:t,value:e},msg=JSON.stringify(msg),console.log(msg),clientArduino.send(msg)},SpriteMorph.prototype.ArduinoPMW_write=function(t,e){t=parseInt(t,10),100<(e=parseInt(e,10))?e=100:e<0&&(e=0),e=e/100*1023,e=Math.round(e),pin_modes_arduino[t]!==PWM&&(pin_modes_arduino[t]=PWM,msg={command:"set_mode_pwm",pin:t},msg=JSON.stringify(msg),console.log(msg),clientArduino.send(msg)),msg={command:"pwm_write",pin:t,value:e},msg=JSON.stringify(msg),console.log(msg),clientArduino.send(msg)},SpriteMorph.prototype.ArduinoTone_on=function(t,e,o){t=parseInt(t,10),e=parseInt(e,10),5e3<(o=parseInt(o,10))&&(o=5e3),pin_modes_arduino[t]!==TONE&&(pin_modes_arduino[t]=TONE,msg={command:"set_mode_tone",pin:t},msg=JSON.stringify(msg),console.log(msg),clientArduino.send(msg)),msg={command:"play_tone",pin:t,freq:e,duration:o},msg=JSON.stringify(msg),clientArduino.send(msg)},SpriteMorph.prototype.ArduinoServo=function(t,e){t=parseInt(t,10),200<(e=parseInt(e,10))?e=200:e<0&&(e=0),pin_modes_arduino[t]!==SERVO&&(pin_modes_arduino[t]=SERVO,msg={command:"set_mode_servo",pin:t},msg=JSON.stringify(msg),console.log(msg),clientArduino.send(msg)),msg={command:"servo_position",pin:t,position:e},msg=JSON.stringify(msg),console.log(msg),clientArduino.send(msg)},SpriteMorph.prototype.ArduinoAnalog_Read=function(t){return t=parseInt(t.split("")[1]),pin_modes_arduino[t]!==ANALOG_INPUT&&(pin_modes_arduino[t]=ANALOG_INPUT,msg={command:"set_mode_analog_input",pin:t},msg=JSON.stringify(msg),console.log(msg),clientArduino.send(msg)),analog_inputs_arduino[t]},SpriteMorph.prototype.ArduinoDigital_Read=function(t){return t=parseInt(t,10),pin_modes_arduino[t]!==DIGITAL_INPUT&&(pin_modes_arduino[t]=DIGITAL_INPUT,msg={command:"set_mode_digital_input",pin:t},msg=JSON.stringify(msg),console.log(msg),clientArduino.send(msg)),digital_inputs_arduino[t]},SpriteMorph.prototype.ArduinoSonar_read=function(t,e){return t=parseInt(t,10),sonar_report_pin=t,e=parseInt(e,10),pin_modes_arduino[t]!==SONAR&&(pin_modes_arduino[t]=SONAR,msg={command:"set_mode_sonar",trigger_pin:t,echo_pin:e},msg=JSON.stringify(msg),console.log(msg),clientArduino.send(msg)),digital_inputs_arduino[sonar_report_pin]},SpriteMorph.prototype.RaspberryPiReportConnected=function(){return isRpiReady()},SpriteMorph.prototype.RpiRemoteIP=function(i){var r=new XMLHttpRequest;r.open("GET","http://localhost:800/id"),r.send(),r.onreadystatechange=function(t){if(4==r.readyState&&200==r.status){try{var e=JSON.parse(r.responseText);if(console.log("retorno; "+JSON.stringify(e)),e&&null!=e)var o=e.sala}catch(t){console.log("Erro ao tentar recuperar sala = "+t)}i<1?i=1:1<=i&&i<=9?i="0"+i:i+=i,console.log("trying to connect address: s"+o+"e"+i),statusConnectionRaspberryPi("s"+o+"e"+i)}}},SpriteMorph.prototype.RpiDigital_write=function(t,e){t=parseInt(t,10),1<(e=parseInt(e,10))?e=1:e<0&&(e=0),pin_modes[t]!==DIGITAL_OUTPUT&&(pin_modes[t]=DIGITAL_OUTPUT,msg={command:"set_mode_digital_output",pin:t},msg=JSON.stringify(msg),clientRaspberryPi.send(msg)),msg={command:"digital_write",pin:t,value:e},msg=JSON.stringify(msg),console.log(msg),clientRaspberryPi.send(msg)},SpriteMorph.prototype.RpiPMW_write=function(t,e){t=parseInt(t,10),100<(e=parseInt(e,10))?e=100:e<0&&(e=0),e=e/100*254,e=Math.round(e),pin_modes[t]!==PWM&&(pin_modes[t]=PWM,msg={command:"set_mode_pwm",pin:t},msg=JSON.stringify(msg),clientRaspberryPi.send(msg)),msg={command:"pwm_write",pin:t,value:e},msg=JSON.stringify(msg),console.log(msg),clientRaspberryPi.send(msg)},SpriteMorph.prototype.RpiTone_on=function(t,e,o){t=parseInt(t,10),e=parseInt(e,10),5e3<(o=parseInt(o,10))&&(o=5e3),pin_modes[t]!==TONE&&(pin_modes[t]=TONE,msg={command:"set_mode_tone",pin:t},msg=JSON.stringify(msg),console.log(msg),clientRaspberryPi.send(msg)),msg={command:"play_tone",pin:t,freq:e,duration:o},msg=JSON.stringify(msg),clientRaspberryPi.send(msg)},SpriteMorph.prototype.RpiServo=function(t,e){t=parseInt(t,10),200<(e=parseInt(e,10))?e=200:e<0&&(e=0),pin_modes[t]!==SERVO&&(pin_modes[t]=SERVO,msg={command:"set_mode_servo",pin:t},msg=JSON.stringify(msg),clientRaspberryPi.send(msg)),msg={command:"servo_position",pin:t,position:e},msg=JSON.stringify(msg),console.log(msg),clientRaspberryPi.send(msg)},SpriteMorph.prototype.RpiDigital_Read=function(t){return t=parseInt(t,10),pin_modes[t]!==DIGITAL_INPUT&&(pin_modes[t]=DIGITAL_INPUT,msg={command:"set_mode_digital_input",pin:t},msg=JSON.stringify(msg),clientRaspberryPi.send(msg)),digital_inputs[t]},SpriteMorph.prototype.RpiSonar_read=function(t,e){return t=parseInt(t,10),sonar_report_pin=t,e=parseInt(e,10),pin_modes[t]!==SONAR&&(pin_modes[t]=SONAR,msg={command:"set_mode_sonar",trigger_pin:t,echo_pin:e},msg=JSON.stringify(msg),clientRaspberryPi.send(msg)),digital_inputs[sonar_report_pin]},SpriteMorph.prototype.SpheroLED=function(t){sendMessageSphero(COLOR,t+"")},SpriteMorph.prototype.SpheroTotalColisoes=function(){if(0!=clienteConectadoSphero)return totalColisoes;alert("BLEBit not connected")},SpriteMorph.prototype.SpheroResetColisoes=function(){0==clienteConectadoSphero?alert("BLEBit not connected"):totalColisoes=0},SpriteMorph.prototype.BLEout=function(t){0==clienteConectadoBLEBIT?alert("BLEBit not connected"):(255<t?t=255:t<0&&(t=0),sendMessageBLEBIT(parseInt(t)))},SpriteMorph.prototype.BLEoutTxt=function(t){0==clienteConectadoBLEBIT?alert("BLEBit not connected"):"on"==t?sendMessageBLEBIT(255):"off"==t?sendMessageBLEBIT(0):console.log("Texto BLEoutTxt: "+t)},SpriteMorph.prototype.BLEin=function(){if(0!=clienteConectadoBLEBIT)return inputBLEBIT;alert("BLEBit not connected")},SpriteMorph.prototype.LampBLEonoff=function(t){0==clienteConectadoLampBLE?alert("LampBLE not connected"):"on"==t?sendMessageLampBLE(LAMPADA_BRANCA,255):"off"==t?sendMessageLampBLE(LAMPADA_BRANCA,0):console.log("Texto LampBLEonoff: "+t)},SpriteMorph.prototype.LampBLEIntensity=function(t,e){if(0==clienteConectadoLampBLE)alert("LampBLE not connected");else if("white"==t)sendMessageLampBLE(LAMPADA_BRANCA,e);else if("off"==t)sendMessageLampBLE(LAMPADA_BRANCA,e);else if("red"==t){sendMessageLampBLE(LAMPADA_RGB,e+",0,0")}else if("green"==t){sendMessageLampBLE(LAMPADA_RGB,"0,"+e+",0")}else if("blue"==t){sendMessageLampBLE(LAMPADA_RGB,"0,0,"+e)}else console.log("Texto LampBLEonoff: "+t)},SpriteMorph.prototype.LampBLERGB=function(t,e,o){0==clienteConectadoLampBLE?alert("LampBLE not connected"):sendMessageLampBLE(LAMPADA_RGB,t+","+e+","+o)},SpriteMorph.prototype.LampBLEAnyClr=function(t){if(0==clienteConectadoLampBLE)alert("LampBLE not connected");else{var e=(t+="").split("(");e=(e=e[1].split(","))[0]+","+e[1]+","+e[2],console.log("r,g,b: "+e),sendMessageLampBLE(LAMPADA_RGB,e)}};